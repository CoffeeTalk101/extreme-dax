<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>Extreme DAX (for pre sume)</title></head><body><div class="calibre1" id="calibre_link-258">
<div id="calibre_link-1531" class="calibre2">
<div id="calibre_link-1532" class="calibre3"><div id="calibre_link-1533" class="calibre4">
    <p class="book-title--packt">Extreme DAX</p>
    <p class="book-title--packt">Take your Power BI and Microsoft data analytics skills to the next level</p>
    <p class="book-title--packt">Michiel Rozema</p>
    <p class="book-title--packt">Henk Vlootman</p>
    <p class="book-title--packt"><img src="images/000059.jpg" alt="" width="272" height="86" class="calibre5" /></p>
    <p class="book-title--packt">BIRMINGHAM&mdash;MUMBAI</p>
    <p class="book-title--packt">Extreme DAX</p>
    <p class="book-title--packt">Copyright Â© 2022 Packt Publishing</p>
    <p class="book-title--packt"><em class="italic">All rights reserved</em>. No part of this book may be reproduced, stored in a retrieval system, or transmitted in any form or by any means, without the prior written permission of the publisher, except in the case of brief quotations embedded in critical articles or reviews.</p>
    <p class="book-title--packt">Every effort has been made in the preparation of this book to ensure the accuracy of the information presented. However, the information contained in this book is sold without warranty, either express or implied. Neither the authors, nor Packt Publishing or its dealers and distributors, will be held liable for any damages caused or alleged to have been caused directly or indirectly by this book.</p>
    <p class="book-title--packt">Packt Publishing has endeavored to provide trademark information about all of the companies and products mentioned in this book by the appropriate use of capitals. However, Packt Publishing cannot guarantee the accuracy of this information.</p>
    <p class="book-title--packt"><strong class="screentext">Producer:</strong> Suman Sen</p>
    <p class="book-title--packt"><strong class="screentext">Acquisition Editor &ndash; Peer Reviews:</strong> Saby Dsilva</p>
    <p class="book-title--packt"><strong class="screentext">Project Editor:</strong> Rianna Rodrigues</p>
    <p class="book-title--packt"><strong class="screentext">Content Development Editor:</strong> Lucy Wan</p>
    <p class="book-title--packt"><strong class="screentext">Copy Editor:</strong> Safis Editing</p>
    <p class="book-title--packt"><strong class="screentext">Technical Editor:</strong> Aditya Sawant</p>
    <p class="book-title--packt"><strong class="screentext">Proofreader:</strong> Safis Editing</p>
    <p class="book-title--packt"><strong class="screentext">Indexer:</strong> Manju Arasan</p>
    <p class="book-title--packt"><strong class="screentext">Presentation Designer:</strong> Pranit Padwal</p>
    <p class="book-title--packt">First published: January 2022</p>
    <p class="book-title--packt">Production reference: 1070122</p>
    <p class="book-title--packt">Published by Packt Publishing Ltd.</p>
    <p class="book-title--packt">Livery Place</p>
    <p class="book-title--packt">35 Livery Street</p>
    <p class="book-title--packt">Birmingham</p>
    <p class="book-title--packt">B3 2PB, UK.</p>
    <p class="book-title--packt">ISBN 978-1-80107-851-1</p>
    <p class="book-title--packt"><a href="http://www.packt.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">www.packt.com</span></a></p>
<p class="eop"></p>
    <h1 id="calibre_link-1534" class="introduction-title--packt">Contributors</h1>
    <h1 id="calibre_link-1535" class="title">About the authors</h1>
    <p class="book-title--packt"><strong class="screentext">Michiel Rozema</strong> is one of the world's top Power BI experts and lives in the Netherlands. He holds a master's degree in mathematics and has worked in the IT industry for over 25 years as a consultant and manager. Michiel was the data insight lead at Microsoft Netherlands for 8 years, during which time he launched Power BI in the country. He is the author of two Dutch books on Power Pivot and Power BI. Michiel is one of the founders of the Dutch Power BI user group, organizer of the Power BI Summer School, and has been a speaker at many conferences on Power BI. He has been awarded the Microsoft MVP award since 2019 and, together with fellow MVP Henk Vlootman, he runs the consultancy company Quanto, which specializes in Power BI.</p>
    <p class="book-title--packt"><strong class="screentext">Henk Vlootman</strong> is a senior global Power Platform, Power BI, and Excel business consultant. Every year since 2013, Henk has received the Microsoft MVP award for his outstanding expertise and community leadership. Henk is one of the founders of the Dutch Power BI user group, organizer of the Power BI Summer School, and has been a speaker at many conferences on Power BI all over the world. He is also the author of two Excel and two Power Pivot/Power BI books. He started his career in 1992 with his own company, then as an Excel consultant. Nowadays he runs the consultancy company Quanto, which specializes in Power BI, together with fellow MVP Michiel Rozema.</p>
<p class="eop"></p>
    <h1 id="calibre_link-1536" class="title">About the reviewer</h1>
    <p class="book-title--packt"><strong class="screentext">Greg Deckler</strong> is a Microsoft MVP for Data Platform and an active member of the Columbus Ohio IT community, having founded the Columbus Azure ML and Power BI User Group (CAMLPUG) and presented at many conferences and events throughout the country. An active blogger and community member interested in helping new users of Power BI, Greg actively participates in the Power BI community, having authored over 180 Power BI Quick Measures Gallery submissions and over 5,000 solutions to community questions. Greg is Vice President of Cloud Services at Fusion Alliance, a regional consulting firm, and assists customers in gaining competitive advantage from the cloud and cloud-first technologies like Power BI. Greg has authored three books on Power BI: <em class="italic">Learn Power BI</em>, <em class="italic">DAX Cookbook</em>, and <em class="italic">Power BI Cookbook, Second Edition</em>. Finally, Greg has also built an external tool for Power BI Desktop called Microsoft Hates Greg's Quick Measures, and he posts Power BI videos on YouTube.</p>
    <p class="acknowledgement--packt">I would like to thank my son, family, and the entire Power BI community for all of their support.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1">
<div id="calibre_link-1537" class="calibre2">
<div id="calibre_link-1538" class="calibre3"><nav id="calibre_link-1539" type="toc" class="calibre7">
    <h2 class="calibre8">Contents</h2>
    <ol class="calibre9">
      <li class="calibre10"><a href="#calibre_link-2" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Preface</a>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-3" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Who this book is for</a></li>
          <li class="calibre10"><a href="#calibre_link-4" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">What this book covers</a></li>
          <li class="calibre10"><a href="#calibre_link-5" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">To get the most out of this book</a>
          </li>
          <li class="calibre10"><a href="#calibre_link-6" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Get in touch</a></li>
        </ol>
      </li>
      <li class="calibre10"><a href="#calibre_link-7" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Part I: Introduction</a></li>
      <li class="calibre10"><span>1.1 <a href="#calibre_link-8" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">DAX in Business Intelligence</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-9" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The Five-Layer model for business intelligence</a></li>
          <li class="calibre10"><a href="#calibre_link-10" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Enterprise BI and end-user BI</a></li>
          <li class="calibre10"><a href="#calibre_link-11" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Where DAX fits in, and where to find it</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-12" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Excel</a></li>
              <li class="calibre10"><a href="#calibre_link-13" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Power BI</a></li>
              <li class="calibre10"><a href="#calibre_link-14" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">SQL Server Analysis Services</a></li>
              <li class="calibre10"><a href="#calibre_link-15" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Azure Analysis Services</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-16" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Tools to develop models and DAX</a></li>
          <li class="calibre10"><a href="#calibre_link-17" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Powered by DAX: visual, interactive reports</a></li>
          <li class="calibre10"><a href="#calibre_link-18" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">How to approach solution development</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-19" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using Power BI models to accelerate BI solution development</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-20" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">We do not know exactly what we need</a></li>
                  <li class="calibre10"><a href="#calibre_link-21" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Our data is not correct</a></li>
                </ol>
              </li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-22" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The digital transformation cycle</a></li>
          <li class="calibre10"><a href="#calibre_link-23" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>1.2 <a href="#calibre_link-24" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Model Design</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-25" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Columnar data storage</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-26" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Relational databases</a></li>
              <li class="calibre10"><a href="#calibre_link-27" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Columnar databases</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-28" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Data types and encoding</a></li>
          <li class="calibre10"><a href="#calibre_link-29" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Relationships</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-30" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Data in Excel</a></li>
              <li class="calibre10"><a href="#calibre_link-31" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Data in relational databases</a></li>
              <li class="calibre10"><a href="#calibre_link-32" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Power BI's relational model</a></li>
              <li class="calibre10"><a href="#calibre_link-33" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Relationship properties</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-34" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Active and inactive relationships </a></li>
                  <li class="calibre10"><a href="#calibre_link-35" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Cross filter direction</a></li>
                </ol>
              </li>
              <li class="calibre10"><a href="#calibre_link-36" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Cardinality</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-37" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Effective model design</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-38" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Star schemas and snowflakes</a></li>
              <li class="calibre10"><a href="#calibre_link-39" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The issue with star schemas</a></li>
              <li class="calibre10"><a href="#calibre_link-40" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">RDBMS principles to avoid in Power BI models</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-41" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Interdependent dimensions</a></li>
                  <li class="calibre10"><a href="#calibre_link-42" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">One fact table only</a></li>
                  <li class="calibre10"><a href="#calibre_link-43" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Data warehouse as the single source of truth</a></li>
                  <li class="calibre10"><a href="#calibre_link-44" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using many-to-many relationships</a></li>
                </ol>
              </li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-45" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Memory and performance considerations</a></li>
          <li class="calibre10"><a href="#calibre_link-46" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>1.3 <a href="#calibre_link-47" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using DAX</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-48" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculated columns</a></li>
          <li class="calibre10"><a href="#calibre_link-49" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculated tables</a></li>
          <li class="calibre10"><a href="#calibre_link-50" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Measures</a></li>
          <li class="calibre10"><a href="#calibre_link-51" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">DAX security filters</a></li>
          <li class="calibre10"><a href="#calibre_link-52" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">DAX queries</a></li>
          <li class="calibre10"><a href="#calibre_link-53" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Date tables</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-54" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating a date table</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-55" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Best practices in DAX</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-56" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Think in terms of DAX measures primarily</a></li>
              <li class="calibre10"><a href="#calibre_link-57" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Build explicit measures</a></li>
              <li class="calibre10"><a href="#calibre_link-58" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Use base measures as building blocks</a></li>
              <li class="calibre10"><a href="#calibre_link-59" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Hide model elements </a></li>
              <li class="calibre10"><a href="#calibre_link-60" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Do not mix data and measures &ndash; use measure tables instead</a></li>
              <li class="calibre10"><a href="#calibre_link-61" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Table types</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-62" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>1.4 <a href="#calibre_link-63" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Context and Filtering</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-64" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The Power BI model</a></li>
          <li class="calibre10"><a href="#calibre_link-65" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Introduction to DAX context</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-66" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Row context</a></li>
              <li class="calibre10"><a href="#calibre_link-67" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Query context</a></li>
              <li class="calibre10"><a href="#calibre_link-68" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Filter context</a></li>
              <li class="calibre10"><a href="#calibre_link-69" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Detecting filters</a></li>
              <li class="calibre10"><a href="#calibre_link-70" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Comparing query and filter context to row context</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-71" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">DAX filtering: Using CALCULATE</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-72" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Step 1: Setting up a filter context</a></li>
              <li class="calibre10"><a href="#calibre_link-73" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Step 2: Removing existing filters</a></li>
              <li class="calibre10"><a href="#calibre_link-74" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Step 3: Applying new filters</a></li>
              <li class="calibre10"><a href="#calibre_link-75" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Step 4: Evaluating the expression to calculate</a></li>
              <li class="calibre10"><a href="#calibre_link-76" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Removing filters with ALL functions</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-77" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Time intelligence</a></li>
          <li class="calibre10"><a href="#calibre_link-78" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Changing relationship behavior</a></li>
          <li class="calibre10"><a href="#calibre_link-79" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Table functions in DAX</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-80" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Table aggregations</a></li>
              <li class="calibre10"><a href="#calibre_link-81" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using virtual tables</a></li>
              <li class="calibre10"><a href="#calibre_link-82" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Context in table functions</a></li>
              <li class="calibre10"><a href="#calibre_link-83" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Performance considerations using table functions</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-84" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Filtering with table functions</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-85" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using CALCULATETABLE</a></li>
              <li class="calibre10"><a href="#calibre_link-86" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Filters and tables</a></li>
              <li class="calibre10"><a href="#calibre_link-87" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using TREATAS</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-88" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">DAX variables</a></li>
          <li class="calibre10"><a href="#calibre_link-89" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><a href="#calibre_link-90" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Part II: Business cases</a></li>
      <li class="calibre10"><span>2.1 <a href="#calibre_link-91" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Security with DAX</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-92" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Introduction to row-level security (RLS)</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-93" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Security roles</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-94" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">DAX security filters</a></li>
                </ol>
              </li>
              <li class="calibre10"><a href="#calibre_link-95" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Dynamic row-level security</a></li>
              <li class="calibre10"><a href="#calibre_link-96" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Modeling considerations for RLS</a></li>
              <li class="calibre10"><a href="#calibre_link-97" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Testing security roles</a></li>
              <li class="calibre10"><a href="#calibre_link-98" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Testing live connection reports</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-99" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Impersonation model</a></li>
                  <li class="calibre10"><a href="#calibre_link-100" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Adding the pImpersonation table to the model</a></li>
                  <li class="calibre10"><a href="#calibre_link-101" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Adding a test security role</a></li>
                  <li class="calibre10"><a href="#calibre_link-102" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Making it all work</a></li>
                </ol>
              </li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-103" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Securing hierarchies using PATH functions</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-104" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Hierarchical tables</a></li>
              <li class="calibre10"><a href="#calibre_link-105" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Introducing PATH functions</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-106" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">PATH</a></li>
                  <li class="calibre10"><a href="#calibre_link-107" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">PATHCONTAINS</a></li>
                  <li class="calibre10"><a href="#calibre_link-108" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">PATHLENGTH</a></li>
                  <li class="calibre10"><a href="#calibre_link-109" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">PATHITEM</a></li>
                  <li class="calibre10"><a href="#calibre_link-110" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">PATHITEMREVERSE</a></li>
                </ol>
              </li>
              <li class="calibre10"><a href="#calibre_link-111" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using PATH functions in RLS</a></li>
              <li class="calibre10"><a href="#calibre_link-112" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Advanced hierarchy navigation in RLS</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-113" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Securing attributes</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-114" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The case for secured attributes</a></li>
              <li class="calibre10"><a href="#calibre_link-115" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Object-level security and its restrictions</a></li>
              <li class="calibre10"><a href="#calibre_link-116" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Dynamically securing attributes: introducing value-level security</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-117" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Value-level security: modeling</a></li>
                  <li class="calibre10"><a href="#calibre_link-118" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Value-level security: security filters</a></li>
                  <li class="calibre10"><a href="#calibre_link-119" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Value-level security: advanced scenarios</a></li>
                  <li class="calibre10"><a href="#calibre_link-120" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">How to develop in models with value-level security</a></li>
                </ol>
              </li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-121" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Securing aggregation levels</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-122" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Measures cannot be secured, fact tables can </a></li>
              <li class="calibre10"><a href="#calibre_link-123" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Restricting fact table granularity</a></li>
              <li class="calibre10"><a href="#calibre_link-124" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Securing aggregation levels with composite models</a></li>
              <li class="calibre10"><a href="#calibre_link-125" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Combining aggregation security with value-level security</a></li>
              <li class="calibre10"><a href="#calibre_link-126" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Securing an aggregation level as an attribute</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-127" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>2.2 <a href="#calibre_link-128" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Dynamically Changing Visualizations</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-129" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The business case</a></li>
          <li class="calibre10"><a href="#calibre_link-130" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Dynamic measures </a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-131" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The basic KPI measures</a></li>
              <li class="calibre10"><a href="#calibre_link-132" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating a helper table</a></li>
              <li class="calibre10"><a href="#calibre_link-133" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating a dynamic DAX measure</a></li>
              <li class="calibre10"><a href="#calibre_link-134" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Selecting both the calculation and date columns dynamically </a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-135" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Dynamic labels</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-136" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Solution overview</a></li>
              <li class="calibre10"><a href="#calibre_link-137" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating a helper table</a></li>
              <li class="calibre10"><a href="#calibre_link-138" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating a DAX measure using dynamic labels</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-139" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Combining dynamic labels and dynamic calculations</a></li>
          <li class="calibre10"><a href="#calibre_link-140" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>2.3 <a href="#calibre_link-141" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Alternative Calendars</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-142" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Week-based and Gregorian calendars</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-143" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">What is a week-based calendar?</a></li>
              <li class="calibre10"><a href="#calibre_link-144" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Week numbers</a></li>
              <li class="calibre10"><a href="#calibre_link-145" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Periods</a></li>
              <li class="calibre10"><a href="#calibre_link-146" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Quarters</a></li>
              <li class="calibre10"><a href="#calibre_link-147" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Years</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-148" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating a week-based calendar table</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-149" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Setting up dates</a></li>
              <li class="calibre10"><a href="#calibre_link-150" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Finding the correct start date</a></li>
              <li class="calibre10"><a href="#calibre_link-151" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Finding the correct end date</a></li>
              <li class="calibre10"><a href="#calibre_link-152" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating additional columns</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-153" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Time Intelligence calculations for week-based calendars</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-154" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The Power BI model</a></li>
              <li class="calibre10"><a href="#calibre_link-155" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating year-to-date results</a></li>
              <li class="calibre10"><a href="#calibre_link-156" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating sales growth</a></li>
              <li class="calibre10"><a href="#calibre_link-157" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Moving average by week within an accounting year</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-158" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Keeping your report current</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-159" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The Date Selection table</a></li>
              <li class="calibre10"><a href="#calibre_link-160" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating selection options</a></li>
              <li class="calibre10"><a href="#calibre_link-161" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using Date selection in measures</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-162" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>2.4 <a href="#calibre_link-163" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Working with AutoExist</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-164" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The Power BI model</a></li>
          <li class="calibre10"><a href="#calibre_link-165" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">How Power BI visualizes the output of a model</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-166" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Visual filters and context</a></li>
              <li class="calibre10"><a href="#calibre_link-167" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">How using measures changes the behavior of visuals</a></li>
              <li class="calibre10"><a href="#calibre_link-168" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Understanding a visual's DAX query</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-169" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">What AutoExist is, and what it does</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-170" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using multiple filters in a visual</a></li>
              <li class="calibre10"><a href="#calibre_link-171" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">How AutoExist optimizes DAX evaluation</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-172" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Example: The case of the missing workdays</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-173" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The business case</a></li>
              <li class="calibre10"><a href="#calibre_link-174" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Model structure</a></li>
              <li class="calibre10"><a href="#calibre_link-175" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Order intake analysis</a></li>
              <li class="calibre10"><a href="#calibre_link-176" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Extending the Calendar table</a></li>
              <li class="calibre10"><a href="#calibre_link-177" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Workday analysis</a></li>
              <li class="calibre10"><a href="#calibre_link-178" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Where's my workday gone?</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-179" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">How to solve the missing workdays problem</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-180" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The root of the problem</a></li>
              <li class="calibre10"><a href="#calibre_link-181" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Changing model structure to get around AutoExist</a></li>
              <li class="calibre10"><a href="#calibre_link-182" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Always consider the context!</a></li>
              <li class="calibre10"><a href="#calibre_link-183" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Fixing the workday calculation</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-184" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing report performance with AutoExist</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-185" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Granularity in fact tables</a></li>
              <li class="calibre10"><a href="#calibre_link-186" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Filtering on multiple fact tables</a></li>
              <li class="calibre10"><a href="#calibre_link-187" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing model structure</a></li>
              <li class="calibre10"><a href="#calibre_link-188" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing the visual</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-189" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>2.5 <a href="#calibre_link-190" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Intercompany Business</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-191" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Modeling the QuantoBikes sales process</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-192" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The sales process</a></li>
              <li class="calibre10"><a href="#calibre_link-193" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Model structure</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-194" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Business between subsidiaries</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-195" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Subsidiary view versus consolidated view</a></li>
              <li class="calibre10"><a href="#calibre_link-196" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Matching internal sales and purchases</a></li>
              <li class="calibre10"><a href="#calibre_link-197" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Visualizing intercompany business</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-198" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Future sales</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-199" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Sales on one-off sales orders</a></li>
              <li class="calibre10"><a href="#calibre_link-200" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Sales on long-term sales orders</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-201" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Dealing with old sales orders</a></li>
                  <li class="calibre10"><a href="#calibre_link-202" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Dealing with current sales orders</a></li>
                  <li class="calibre10"><a href="#calibre_link-203" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing the current sales order calculation</a></li>
                  <li class="calibre10"><a href="#calibre_link-204" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Further optimization</a></li>
                </ol>
              </li>
              <li class="calibre10"><a href="#calibre_link-205" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Testing complex calculations</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-206" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>2.6 <a href="#calibre_link-207" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Exploring the Future: Forecasting and Future Values</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-208" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Financial calculations</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-209" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Present Value and Net Present Value</a></li>
              <li class="calibre10"><a href="#calibre_link-210" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Internal Rate of Return</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-211" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Financial DAX functions</a></li>
          <li class="calibre10"><a href="#calibre_link-212" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The business case and model</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-213" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Creating adjustable rates and indexes</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-214" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating Future Value (FV)</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-215" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Initial investment and residual value</a></li>
              <li class="calibre10"><a href="#calibre_link-216" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Irregular cash flows</a></li>
              <li class="calibre10"><a href="#calibre_link-217" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Recurring cash flows</a></li>
              <li class="calibre10"><a href="#calibre_link-218" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Positive and negative cash flows</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-219" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating Net Present Value (NPV)</a></li>
          <li class="calibre10"><a href="#calibre_link-220" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating the Internal Rate of Return (IRR)</a></li>
          <li class="calibre10"><a href="#calibre_link-221" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating cost-covering rent</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-222" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Determining cost-covering rent by approximation</a></li>
              <li class="calibre10"><a href="#calibre_link-223" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing the approximation</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-224" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>2.7 <a href="#calibre_link-225" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Inventory Analysis</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-226" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Data modeling for status-oriented data</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-227" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Inventory granularity</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-228" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Basic inventory calculations</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-229" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Inventory targets</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-230" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Inventory forecasting</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-231" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Two types of forecast</a>
                <ol class="calibre11">
                  <li class="calibre10"><a href="#calibre_link-232" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using a sales forecast to predict inventory changes</a></li>
                  <li class="calibre10"><a href="#calibre_link-233" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using extrapolation to predict inventory changes</a></li>
                </ol>
              </li>
              <li class="calibre10"><a href="#calibre_link-234" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating long-lasting inventory</a></li>
              <li class="calibre10"><a href="#calibre_link-235" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Working with forecast-based inventory targets</a></li>
              <li class="calibre10"><a href="#calibre_link-236" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Using linear regression for extrapolating inventory</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-237" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><span>2.8 <a href="#calibre_link-238" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Personnel Planning</a></span>
        <ol class="calibre11">
          <li class="calibre10"><a href="#calibre_link-239" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">The Power BI model</a></li>
          <li class="calibre10"><a href="#calibre_link-240" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating sales</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-241" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing the sales calculation</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-242" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Calculating FTEs needed</a>
            <ol class="calibre11">
              <li class="calibre10"><a href="#calibre_link-243" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Considering totals</a></li>
              <li class="calibre10"><a href="#calibre_link-244" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing the FTE calculation</a></li>
            </ol>
          </li>
          <li class="calibre10"><a href="#calibre_link-245" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Optimizing the Power BI model</a></li>
          <li class="calibre10"><a href="#calibre_link-246" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Considering aggregation levels</a></li>
          <li class="calibre10"><a href="#calibre_link-247" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Summary</a></li>
        </ol>
      </li>
      <li class="calibre10"><a href="#calibre_link-248" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Other Books You May Enjoy</a>
      </li>
      <li class="calibre10"><a href="#calibre_link-249" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Index</a></li>
    </ol>
  </nav>
  <nav type="landmarks" id="calibre_link-1540" hidden="" class="calibre7">
    <h1 class="title">Landmarks</h1>
    <ol class="calibre9">
      <li class="calibre12">
        <a type="cover" href="cover.xhtml" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Cover</a>
      </li>
      <li class="calibre12">
        <a type="index" href="#calibre_link-250" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">Index</a>
      </li>
    </ol>
  </nav>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-252">
<div id="calibre_link-1541" class="calibre2">
<div id="calibre_link-1542" class="calibre3"><div id="calibre_link-1543" class="calibre4">
    <h1 id="calibre_link-2" class="introduction-title--packt">Preface</h1>
    <p class="book-title--packt">In this book, you'll take your Power BI and Microsoft data analytics skills to the next level. You'll discover the true power of DAX and learn how to build advanced DAX solutions for practical business scenarios.</p>
    <div class="calibre13"></div><h1 id="calibre_link-3" class="title">Who this book is for</h1>
    <p class="book-title--packt">If you are an analyst with a working knowledge of DAX in Power BI or other Microsoft analytics tools, this book will help you upgrade your DAX knowledge and work with analytical models more effectively.</p>
    <p class="book-title--packt">This book is not for beginners and practical experience with DAX is necessary.</p>
    <div class="calibre13"></div><h1 id="calibre_link-4" class="title">What this book covers</h1>
    <p class="book-title--packt"><em class="italic">Chapter 1.1</em>, <em class="italic">DAX in Business Intelligence</em>, discusses the field of business intelligence and the central role of analytical models in modern BI solutions. Power BI models are ideally suited for use as such models, not least because of the power of DAX.</p>
    <p class="book-title--packt"><em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>, discusses the foundational concepts of the Power BI model. You learn what makes a Power BI model fundamentally different from other data management products and what an optimal design looks like.</p>
    <p class="book-title--packt"><em class="italic">Chapter 1.3</em>, <em class="italic">Using DAX</em>, summarizes the different uses of DAX in Power BI models: calculated columns, calculated tables, measures, security rules, and queries. We also give you some best practices for working with DAX.</p>
    <p class="book-title--packt"><em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>, covers row context, query context, and filter context, and the role contexts play in the evaluation of DAX formulas. We discuss how contexts can be transformed using the <code class="code-in-text--packt">CALCULATE</code> function, by removing filters and adding filters to an existing context. In addition, we look at time intelligence functions, DAX table functions, the deep connection between tables and filters, and DAX variables.</p>
    <p class="book-title--packt">All of these are foundational concepts in exploring more advanced analyses with DAX. After this important chapter, <em class="italic">Part 2</em> of this book is focused on applying all the concepts discussed so far to real-life business cases, many of them based on the projects we've worked on across the years.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.1</em>, <em class="italic">Security with DAX</em>, demonstrates many aspects of securing Power BI models and the power of DAX for doing so. We discuss the versatility of row-level security, security roles, and securing hierarchies, attributes, and aggregation levels through combinations of modeling, DAX, and row-level security. </p>
    <p class="book-title--packt"><em class="italic">Chapter 2.2</em>, <em class="italic">Dynamically Changing Visualizations</em>, covers how to use helper tables and the <code class="code-in-text--packt">SWITCH</code> function to capture user input. We demonstrate how to dynamically change data binding with DAX to create highly dynamic visuals. Depending on your intended use, a helper table can be as simple as a few rows with options, or a larger list based on other data in the Power BI model.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.3</em>, <em class="italic">Alternative Calendars</em>, shows you how to implement time intelligence when your calendar looks different than the standard Gregorian calendar that a Power BI model assumes. We close the chapter off with an alternative to relative date filters in Power BI reports, which is more flexible and can handle selections in non-standard calendars as well.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.4</em>, <em class="italic">Working with AutoExist</em>, focuses on <em class="italic">which</em> calculations are done to populate a visual from a Power BI model. Understanding how AutoExist works will help you to find out why you sometimes do not see results you are expecting in a visual. It also helps to avoid performance problems in reports that are the result of using too many columns from too many tables in one visual.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.5</em>, <em class="italic">Intercompany Business</em>, discusses two main business challenges: intercompany business and consolidated views, and invoices to be sent on open sales orders. We discuss how to keep thorough track of context, how to tailor DAX measures to visualizations, and strategies for approaching advanced analyses.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.6</em>, <em class="italic">Exploring the Future: Forecasting and Future Values</em>, teaches you about financial metrics for analyzing the future of investments. We discuss the common metrics of Future Value, Present Value, Net Present Value, and Internal Rate of Return, and their equivalents in DAX, including <code class="code-in-text--packt">XNPV</code> and <code class="code-in-text--packt">XIRR</code>. We also introduce what-if parameters and see how to use them in complex calculations.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.7</em>, <em class="italic">Inventory Analysis</em>, deals with analyzing inventory data, although the kind of analysis in this chapter can be applied to all sorts of status-oriented data. We discuss different ways to model this kind of data, how to calculate inventory status at some point in time, and how to compare actuals with targets. You will also see different ways to look into the future, including a linear regression in DAX.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.8</em>, <em class="italic">Personnel Planning</em>, discusses ways to analyze the need for personnel (in terms of full-time equivalents, or FTEs) when undertaking projects. From a technical perspective, you will learn ways to work with multiple fact tables that must be considered in combination to provide useful results. The challenge is not only to come up with correct results, but to find the optimal way to compute those results as&nbsp;well.</p>
    <h1 id="calibre_link-5" class="title">To get the most out of this book</h1>
    <p class="book-title--packt">As mentioned, in this book we assume that you already have practical experience with DAX and are looking to extend your knowledge, applying DAX to a range of more complex scenarios. For this reason, we do not generally explain the way a DAX function and its arguments are used, unless we need to for a specific case; this information can easily be found on the internet.</p>
    <p class="book-title--packt">All models can be found on the book's GitHub site at <a href="https://github.com/PacktPublishing/Extreme-DAX" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX</span></a>. Each chapter contains a link to the PBIX file(s) used in the chapter. We recommend that you use the PBIX files to help you follow along with the chapters.</p>
    <p class="book-title--packt">You can use the latest version of Power BI Desktop to open the PBIX files. When relevant, each figure in a chapter, representing a visualization and the code used, can&nbsp;be found in the PBIX file. </p>
    <h2 id="calibre_link-1544" class="calibre8">Download the example code files</h2>
    <p class="book-title--packt">The code bundle for the book is hosted on GitHub at <a href="https://github.com/PacktPublishing/Extreme-DAX" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX</span></a>. We also have other code bundles from our rich catalog of books and videos available at <a href="https://github.com/PacktPublishing/" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/</span></a>. Check them out!</p>
    <h2 id="calibre_link-1545" class="calibre8">Download the color images</h2>
    <p class="book-title--packt">We also provide a PDF file that has color images of the screenshots/diagrams used in this book. You can download it here: <a href="https://static.packt-cdn.com/downloads/9781801078511_ColorImages.pdf" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://static.packt-cdn.com/downloads/9781801078511_ColorImages.pdf</span></a>.</p>
    <h2 id="calibre_link-1546" class="calibre8">Conventions used</h2>
    <p class="book-title--packt">There are a number of text conventions used throughout this book.</p>
    <p class="book-title--packt"><code class="code-in-text--packt">CodeInText</code>: Indicates DAX expressions in the text. For example: "The inactive relationship will save us a lot of <code class="code-in-text--packt">ALL('Calendar')</code> clauses in our DAX code."</p>
    <p class="book-title--packt">A block of code is set as follows:</p>
    <pre class="programlisting"><code class="hljs-code">Total Sales = 
CALCULATE(
    SUM(fProjectSales[Budget]),
    USERELATIONSHIP(fProjectSales[StartDate], 'Calendar'[Date])
)
</code></pre>
    <p class="book-title--packt">When we wish to draw your attention to a particular part of the text, the relevant lines or items are set in italics. For instance: "Note that we made the relationship between <code class="code-in-text--packt">fProjectSales</code> and <code class="code-in-text--packt">Calendar</code> <em class="italic">inactive</em>. This is done because most calculations will probably not group projects by their start date, but spread results over a period of time <em class="italic">beginning</em> with the start date of a project."</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Warnings or important notes appear like this.</p>
    </div>
    <div class="pcalibre4 pcalibre5 packt_tip">
      <p class="book-title--packt">Tips and tricks appear like this.</p>
    </div>
    <h1 id="calibre_link-6" class="title">Get in touch</h1>
    <p class="book-title--packt">Feedback from our readers is always welcome.</p>
    <p class="book-title--packt"><strong class="screentext">General feedback</strong>: Email <code class="code-in-text--packt">feedback@packtpub.com</code>, and mention the book's title in the subject of your message. If you have questions about any aspect of this book, please email us at <code class="code-in-text--packt">questions@packtpub.com</code>.</p>
    <p class="book-title--packt"><strong class="screentext">Errata</strong>: Although we have taken every care to ensure the accuracy of our content, mistakes do happen. If you have found a mistake in this book, we would be grateful if you would report this to us. Please visit <a href="http://www.packtpub.com/submit-errata" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">http://www.packtpub.com/submit-errata</span></a>, selecting your book, clicking on the Errata Submission Form link, and entering the details.</p>
    <p class="book-title--packt"><strong class="screentext">Piracy</strong>: If you come across any illegal copies of our works in any form on the Internet, we would be grateful if you would provide us with the location address or website name. Please contact us at <code class="code-in-text--packt">copyright@packtpub.com</code> with a link to the material.</p>
    <p class="book-title--packt"><strong class="screentext">If you are interested in becoming an author</strong>: If there is a topic that you have expertise in and you are interested in either writing or contributing to a book, please visit <a href="http://authors.packtpub.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">http://authors.packtpub.com</span></a>.</p>
  </div>
  <div id="calibre_link-1547" class="calibre4">
    <h1 id="calibre_link-1548" class="title">Share Your Thoughts</h1>
    <p class="book-title--packt">Once you've read <em class="italic">Extreme DAX</em>, we'd love to hear your thoughts! Please <a href="https://packt.link/r/1801078513" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">click here to go straight to the Amazon review page</span></a> for this book and share your feedback.</p>
    <p class="book-title--packt">Your review is important to us and the tech community and will help us make sure we're delivering excellent quality content.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-254">
<div id="calibre_link-1549" class="calibre2">
<div id="calibre_link-1550" class="calibre3"><div id="calibre_link-1551" class="calibre4">
    <div class="calibre4">
    </div>
    <div class="calibre4">
      <h1 id="calibre_link-7" class="title"><span class="outer"><span class="inner">Part I</span></span></h1>
    </div>
    <div class="calibre4">
      <h1 id="calibre_link-1552" class="title">Introduction</h1>
    </div>
    <div class="calibre4">
    </div>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-255">
<div id="calibre_link-1553" class="calibre2">
<div id="calibre_link-1554" class="calibre3"><div id="calibre_link-1555" class="calibre4">
    <h1 class="chapternumber">1.1</h1>
    <h1 id="calibre_link-8" class="title">DAX in Business Intelligence</h1>
    <p class="book-title--packt">Without a doubt, information is nowadays one of the most valuable assets of any organization. We all know this as consumers: companies are lining up to get our personal data. Not because any of us are so interesting individually (though we're sure you are a very interesting person!), but the combination of data from many consumers enables companies to get valuable insights to drive their business forward.</p>
    <p class="book-title--packt">This is not only true for commercial companies. Public institutions, hospitals, and universities also benefit from information to better run their core processes. In any case, information is the foundation of progress and innovation.</p>
    <p class="book-title--packt">But getting from data to information to insights can be a tedious process. It involves combining data from different sources, discovering hidden structures and correlations, and considering the context of data. This is why the field of business intelligence, or data analytics, has traditionally been exclusive to IT professionals. Which is not optimal, as it is really about <em class="italic">business</em> insights.</p>
    <p class="book-title--packt">This book is all about one of the hottest tools for data analytics in existence today: <strong class="screentext">DAX</strong> (<strong class="screentext">Dynamic Analysis eXpressions</strong>). As a reader, we assume that you have some experience with DAX and that you are looking to improve your skills. As the foundation for this, it is important to understand what DAX is for and what it is <em class="italic">not</em> for. Additionally, you must learn to avoid doing things elsewhere that can be done better with DAX.</p>
    <p class="book-title--packt">This chapter covers some general concepts that will help you lay this foundation. We cover the following topics:</p>
    <ul class="calibre9">
      <li class="bullet">The Five-Layer model for business intelligence</li>
      <li class="bullet">Enterprise BI and end-user BI</li>
      <li class="bullet">Where DAX fits in, and where to find it</li>
      <li class="bullet">Tools to develop models and DAX</li>
      <li class="bullet">Powered by DAX: visual, interactive reports</li>
      <li class="bullet">How to approach solution development</li>
      <li class="bullet">The digital transformation cycle</li>
    </ul>
    <h1 id="calibre_link-9" class="title">The Five-Layer model for business intelligence</h1>
    <p class="book-title--packt">To be<a id="calibre_link-406" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> able to discuss analytics in a structured<a id="calibre_link-807" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> and comprehensive way, we have developed a simple framework that describes the main components and responsibilities in an analytics solution. We have given it an equally simple name: the <strong class="screentext">Five-Layer model</strong>.</p>
    <figure class="mediaobject"><img src="images/000123.png" alt="Graphical user interface, text, application, email  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.1: The Five-Layer model</p>
    <p class="book-title--packt">The first and<a id="calibre_link-810" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> lowest layer, <strong class="screentext">Connect</strong>, is the starting point of analytics: if you want to analyze data, those data must come from somewhere. They could reside in Excel sheets, text files, large business databases, or somewhere on the Internet.</p>
    <p class="book-title--packt">These raw data aren't typically in the right format to be able to analyze, especially when they come from different <a id="calibre_link-812" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sources. Therefore, you need to <strong class="screentext">Prepare</strong> your data. Preparation can take many forms, like imposing certain data types, transforming data, building data history, or matching data based on key attributes.</p>
    <p class="book-title--packt">Creating nice and clean datasets in the Connect and Prepare layers can take a lot of effort. A lot. Building a data warehouse, a typical IT component in the Prepare layer, often leads to development projects spanning multiple years. The sad thing about this is that by the <a id="calibre_link-811" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>time the data warehouse is complete, the world has changed and the data warehouse does not comply anymore.</p>
    <p class="book-title--packt">When data<a id="calibre_link-809" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> has been put in a workable format, you can start with proper analysis of the data in the <strong class="screentext">Analyze</strong> layer. This is really the heart of the analytics solution. Building analytical models allows you to slice and filter data, compute aggregations of all sorts, and add calculations to provide specific insights.</p>
    <p class="book-title--packt">The <strong class="screentext">Visualize</strong> layer is all<a id="calibre_link-814" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> about creating reports and dashboards visualizing the results of analytical models. We have called this layer Visualize and not simply Output as, to really provide insights, helping a <a id="calibre_link-407" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>user focus on the important results is <a id="calibre_link-808" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>as important as providing results at all. Classic reports consisting of pages and pages of details are not very insightful, and force the user to export the whole report to Excel where they can aggregate the data. Really providing insight usually involves effective visualization of the most important outcomes of the analysis, while giving the user the option to answer the questions arising from the insight by viewing additional visuals on a lower detail level.</p>
    <p class="book-title--packt">The top layer, <strong class="screentext">Share</strong>, consists<a id="calibre_link-813" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of platforms and processes aimed at providing access to reports and dashboards to the right people, while shielding them from those who shouldn't have access.</p>
    <p class="book-title--packt">Whether you build your analytics solution in Excel, use Power BI, develop a corporate business intelligence system, or use no automated system at all, you will have to cover the five layers in some way. In a good analytics solution, the layers are clearly separated, and the processing of data is done in the right layer. Doing this has a lot of advantages, like avoiding implementing the same logic multiple times. Proper implementation of the Five-Layer model makes it relatively easy to cope with&nbsp;changes in, for example, source systems.</p>
    <p class="book-title--packt">As you will see later in this chapter, DAX lives in the Analyze layer, with strong ties to both the Prepare and Visualize layers. We will talk about visualizations in a separate section, but first, let us discuss the question <em class="italic">who does what in BI?</em></p>
    <h1 id="calibre_link-10" class="title">Enterprise BI and end-user BI</h1>
    <p class="book-title--packt">Organizations<a id="calibre_link-725" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> are becoming<a id="calibre_link-723" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> ever more data-driven. An organization that assesses performance <a id="calibre_link-960" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on <strong class="screentext">key performance indicators</strong>, or <strong class="screentext">KPIs</strong>, uses dashboards reflecting the status for each KPI. These dashboards are typically highly standardized: the organization has reflected on the business strategy, business processes, how to measure the KPIs, and how to report on them. An automated dashboard with KPIs is&nbsp;relatively stable and will not change much, and is typically built and maintained by a central IT department or BI competence center.</p>
    <p class="book-title--packt">The next level of being a data-driven organization is that <em class="italic">every</em> decision taken can be based on insights from relevant data. This means that the need for a more dynamic form of analytics arises, one that can answer ad hoc questions. This form of analytics is marketed as <strong class="screentext">self-service BI</strong> and <a id="calibre_link-1275" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>promises that everyone can build a BI solution without the help of a central IT department. From the Five-Layer model, it is clear why this is not realistic: few end users are able or have the time to solve the complexities of all the layers. The ideal situation is when the central IT department and end users complement each other, each focusing on their specific strengths.</p>
    <p class="book-title--packt">We use the terms <strong class="screentext">enterprise BI</strong> and <strong class="screentext">end-user BI</strong> to distinguish between the two forms of analytics. <strong class="screentext">Enterprise BI</strong> is the form of analytics built and maintained by IT. It uses large-scale server or cloud platforms and serves many users at the same time. Solutions are built in professionally managed projects that focus on data quality, availability of the platform, and well-defined processes.</p>
    <p class="book-title--packt"><strong class="screentext">End-user BI</strong> is done by business users. They have a direct need for insights in their daily job and look for fast and accessible ways to get these insights. Many of them start building their analytics solutions in Excel, but the complexity of the Excel documents leads to an ever-increasing time investment for keeping the data up to date and maintaining and extending the solution. Excel is not capable of coping with growing data volumes. To solve this, Microsoft has extended the features of Excel to turn it into a real end-user BI platform, with Power Query and Power Pivot as powerful new tools to prepare and analyze data. These tools have evolved into <a id="calibre_link-1073" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>what&nbsp;is now <strong class="screentext">Power BI</strong>.</p>
    <p class="book-title--packt">The beauty of the Microsoft platform for analytics is that the tools for enterprise BI and end-user BI work seamlessly together. The technology underlying Power BI is a driving force behind this. In fact, it is now possible to mix the two formerly opposed sides of BI into one architecture with different levels of self-service capabilities:</p>
    <figure class="mediaobject"><img src="images/000143.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2: The integration of enterprise and end-user BI</p>
    <p class="book-title--packt">The Five-Layer model is a useful framework for positioning these self-service capabilities. Users who express a need for self-service BI can have that on different layers in<a id="calibre_link-724" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the<a id="calibre_link-726" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> model. They may create their own visualizations on top of existing (corporate) analytical models; they may build their own analytical models using centrally prepared datasets; or they may gather their own data, combine that with corporate data, and create most of the solution by themselves. They may even use artifacts created by other end users to build upon.</p>
    <p class="book-title--packt">It should be clear that when moving down in the five layers, the complexity of the work done tends to increase. Therefore, this not only requires more advanced expertise, but it also adds to the responsibility of complying with corporate guidelines and standards. Central IT or BI needs to facilitate selected end users to create their own solutions. When implemented correctly, this leads to a situation where all people in the organization benefit from insights optimally. We call <a id="calibre_link-478" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this vision <strong class="screentext">collective analytics</strong>.</p>
    <p class="book-title--packt">Power BI offers several features that enable the implementation of collective analytics. One of these features is DAX, which is instrumental in empowering business users not only to create their own analytic solutions, but also be strongly involved in developing enterprise solutions. We will talk about the latter in the <em class="italic">How to approach solution development</em> section later in this chapter, but let us first take a look at what DAX is and where it is found in a BI solution.</p>
    <h1 id="calibre_link-11" class="title">Where DAX fits in, and where to find it</h1>
    <p class="book-title--packt">In an analytics<a id="calibre_link-611" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> solution<a id="calibre_link-613" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> based on the Microsoft platform, DAX is used in the Analyze layer. DAX lives inside analytical models as the formula language to define calculations and other logic. In fact, models and DAX are really two sides of the same coin: the design of the model impacts the complexity of the DAX code, and your skills in DAX determine your model designs (we will elaborate on the core concepts of data models in <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>).</p>
    <p class="book-title--packt">The power of DAX is in its strong data aggregation capabilities. The DAX language contains many functions and constructs for defining a variety of aggregations to generate results that lead to the insights needed. In the past, many types of aggregations could not be created directly but had to be implemented through specifically preparing data. For instance, computing a year-to-date sales total can be done in DAX with a single function, while in Excel or traditional reporting tools, separate indicators are needed to denote which sales transactions belong to the year-to-date period. The end result, while more complex to implement, is still less&nbsp;dynamic than the DAX solution, which provides historical year-to-date figures&nbsp;as well.</p>
    <p class="book-title--packt">This means that, with DAX, the effort that goes toward data preparation is much lower than in traditional BI solutions. As the DAX syntax and many core concepts are similar to those in Excel, the DAX language is relatively easy to learn for Excel users. This doesn't mean, though, that DAX is easy to <em class="italic">master</em>: when working with DAX, you will find that the complexity of the questions to be answered with DAX calculations steadily increases. And with that, you will need to create ever more sophisticated DAX code. This book will give you many examples of advanced applications of DAX, which will hopefully help you solve your DAX problems.</p>
    <p class="book-title--packt">All core Microsoft data products now offer the capability to build an analytical model including DAX. It is confusing, however, that in each product the naming of&nbsp;the model is different. Below, we give an overview of models and DAX in different Microsoft products.</p>
    <h2 id="calibre_link-12" class="calibre8">Excel</h2>
    <p class="book-title--packt">Since<a id="calibre_link-610" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> version 2010, Microsoft Excel offers analytical data modeling capabilities in the&nbsp;form of <strong class="screentext">Power Pivot</strong>. Power<a id="calibre_link-556" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> Pivot, also called a <strong class="screentext">Data Model</strong> in Excel, is the analytical model based on DAX.</p>
    <h2 id="calibre_link-13" class="calibre8">Power BI</h2>
    <p class="book-title--packt">The shining <a id="calibre_link-612" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>star in the <a id="calibre_link-1074" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Microsoft data platform is Power BI. It was introduced first as an add-on to Office 365 but was turned into a separate service in 2015. The analytical model in Power BI is called a <strong class="screentext">Power BI dataset</strong>, or a <strong class="screentext">dataset</strong> for<a id="calibre_link-1086" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> short, and is the home for DAX.</p>
    <p class="book-title--packt">Power BI datasets and other Power BI artifacts are run within the Power BI cloud service accessible through the Power BI website, <a href="https://powerbi.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">powerbi.com</span></a>. Some other access points to the Power BI service are available, like the Power BI mobile app, Microsoft Teams, and even custom applications through a special version of the Power BI service called Power BI Embedded. Alternatively, Power BI Report Server is server software designed for customers<a id="calibre_link-1556" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> that cannot or do not want to use the cloud service.</p>
    <h2 id="calibre_link-14" class="calibre8">SQL Server Analysis Services</h2>
    <p class="book-title--packt">Microsoft's <a id="calibre_link-1277" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>data<a id="calibre_link-614" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> server platform, SQL Server, contains an analytics component <a id="calibre_link-308" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>called <strong class="screentext">Analysis Services</strong> (<strong class="screentext">SSAS</strong>). Starting as OLAP Services around the millennium, SSAS has been a classical OLAP (for <em class="italic">Online Analytical Processing</em>) server for years and is now <a id="calibre_link-1023" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>called <strong class="screentext">Multidimensional</strong>. With SQL Server 2012, a second flavor of analytical capabilities was introduced, called <strong class="screentext">Tabular</strong>, which<a id="calibre_link-1355" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is the analytical model based on&nbsp;DAX.</p>
    <p class="book-title--packt">You may wonder about the differences between the two technologies in SSAS. This is not the book for going deep into all the details here, but the most fundamental thing is that SSAS Multidimensional is based on "classical" relational database technology. This technology is not designed to aggregate and perform calculations on large amounts of data, and a Multidimensional model, or cube, simply performs all these calculations beforehand during model processing. The effect of this is that a Multidimensional model is far less flexible and dynamic than a Tabular model, simply because all aggregation levels and calculation results are computed during model processing. On the contrary, the power of DAX is being able to perform calculations on the fly, meaning a much more dynamic analytics experience, as a report designer is not restricted by aggregation levels implemented by the model designer.</p>
    <h2 id="calibre_link-15" class="calibre8">Azure Analysis Services</h2>
    <p class="book-title--packt"><strong class="screentext">Azure Analysis Services </strong>(<strong class="screentext">AAS</strong>) is a <a id="calibre_link-604" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>fully managed <a id="calibre_link-368" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>analytics cloud service based on the same Tabular engine as SSAS. The difference, obviously, is that AAS runs in the cloud. The result is that your organization doesn't have to worry about the maintenance of the hardware and databases. It is also a flexible solution, since the resources can be scaled to meet the needs of the moment.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The analytical model with DAX clearly exists under many different names: Power Pivot, Data Model, dataset, or Tabular model. This poses a challenge for this book when we need to refer to the analytical model. As our primary focus is on Power BI, we will use the term <strong class="screentext">Power BI model</strong> throughout this book, or simply <strong class="screentext">model</strong> when there is no risk of confusion. The term "analytical model" is used only<a id="calibre_link-605" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> for the <a id="calibre_link-369" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>conceptual model in the Five-Layer model.</p>
    </div>
    <h1 id="calibre_link-16" class="title">Tools to develop models and DAX</h1>
    <p class="book-title--packt">You <a id="calibre_link-1021" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have multiple<a id="calibre_link-607" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> options to choose from as your tool to work with DAX, depending on the target platform for the model:</p>
    <ul class="calibre9">
      <li class="bullet">For a Power Pivot model, you use Excel with the Power Pivot add-on.</li>
      <li class="bullet">For a Power BI dataset, you use Power BI Desktop.
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">It is interesting to note that there are in fact three versions of Power BI Desktop. One can be downloaded from the Power BI website, <a href="https://powerbi.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">powerbi.com</span></a>. The second is installed from the Windows Store and is automatically updated just like any other app from the store. When you realize that Power BI Desktop gets a new release nearly every month, these automatic updates are a real plus, although it can sometimes be annoying when a new release changes things you do not expect. If you want to, you can install both versions on the same computer. The third version of Power BI Desktop, which can be downloaded from the Power BI website as well, is a special edition for use with Power BI Report Server.</p>
    </div>
  </li>
    </ul>
    <ul class="calibre9">
      <li class="bullet">For a Tabular model in SSAS or AAS, you use Visual Studio, which offers many features for professional development, like integration with version control systems, scripting, and compatibility.</li>
      <li class="bullet">For a Power BI dataset in Power BI Premium, you can choose between Power BI Desktop and Visual Studio. This is possible through the XMLA endpoint, a technique implemented in Power BI Premium that gives a Power BI dataset the exact same outside appearance as a Tabular model.</li>
      <li class="bullet">In addition, there are several community-based tools available like Tabular Editor and DAX Studio. These can even be integrated into Power BI Desktop.</li>
    </ul>
    <p class="book-title--packt">For this book, we choose to use "plain" Power BI Desktop, as this is a free app that you probably already have. Every reader of this book can easily download Power BI Desktop and use the example files provided in the book's GitHub repository at <a href="https://github.com/PacktPublishing/Extreme-DAX" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX</span></a>.</p>
    <h1 id="calibre_link-17" class="title">Powered by DAX: visual, interactive reports</h1>
    <p class="book-title--packt">In discussing <a id="calibre_link-619" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <a id="calibre_link-616" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Five-Layer model, we already briefly touched upon the importance of visual reporting. But effective visual reporting is only possible through the power of DAX-based models.</p>
    <p class="book-title--packt">Creating visual output is paramount to generating real insights versus a lot of information only. Just take the example below:</p>
    <figure class="mediaobject"><img src="images/000163.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3: Some sales data in a table visual</p>
    <p class="book-title--packt">Can you spot the problem or opportunity this company has? If so, you are very good at numbers! Most people, though, are much more visually inclined. The picture below provides the same insight in a visual way:</p>
    <figure class="mediaobject"><img src="images/000185.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4: The same sales data presented more visually</p>
    <p class="book-title--packt">It is <a id="calibre_link-617" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>obvious<a id="calibre_link-620" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> now that one of the SKUs is doing significantly better than the others. That is an interesting and valuable insight: if we can make the other SKUs reach the same performance, the overall results of the company will dramatically improve. This insight also leads to something else: you want to know what it is about this SKU that makes it so great. Is there a single large customer that ordered this SKU? Are there specific geographies where the SKU is sold? And what about the margin on this SKU; perhaps it sells well because we priced it too low?</p>
    <p class="book-title--packt">This is a fundamental cause-and-effect that happens all the time when you create deep insights through visual reports. Insights lead to new questions. The answers to these questions are new insights, which, in turn, lead to other questions.</p>
    <p class="book-title--packt">How can this effect be addressed? The traditional way has been to provide as much information as possible in a single report. The reason for this was that it takes time to render a report. Power BI approaches this in a fundamentally different way, made possible by the power of DAX, by adding <em class="italic">interaction</em> to reports:</p>
    <figure class="mediaobject"><img src="images/000207.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.5: The Visualize-Interact cycle</p>
    <p class="book-title--packt">Interaction allows the consumer of a report to dig into the initial insights and find the answers to their follow-up questions, making the move from straightforward reporting to analyzing in an organic way. For this to work, the report needs to be able to provide new visualizations in the blink of an eye. For a Power BI visual report, which retrieves all content from <a id="calibre_link-618" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a <a id="calibre_link-621" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Power BI model, this means that the model must be equally fast in providing results to the report. The performance of the model is a result of its structure and the DAX code that you implement. So, there is a direct link between your DAX code and the user experience of your reports!</p>
    <h1 id="calibre_link-18" class="title">How to approach solution development</h1>
    <p class="book-title--packt">Power BI models <a id="calibre_link-375" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and DAX enable a different way to develop BI solutions with much deeper involvement from businesspeople. This leads to solutions that deliver insights that optimally add value to the business.</p>
    <p class="book-title--packt">The traditional, IT-centric way to create BI solutions is to start with connecting to data sources and preparing data. At first glance, this sounds like the right thing to do; after all, we need good data to have good and valuable insights.</p>
    <p class="book-title--packt"><img src="images/000005.png" alt="" class="calibre15" /></p>
    <p class="book-title--packt">Figure 1.6: The traditional BI solution development approach</p>
    <p class="book-title--packt">This approach is typically materialized in the development of an enterprise data warehouse. The<a id="calibre_link-1557" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> idea behind having a data warehouse is to store all of the organization's data in a single place, and to use that as the foundation for all reporting. </p>
    <p class="book-title--packt">It should be clear that this can be a major undertaking, as organizations have many different systems, with lots of different data in them. The data warehouse is traditionally implemented as a relational database system, which means that all of the enterprise data must fit in the database structure, or schema, of the data warehouse.</p>
    <p class="book-title--packt">The variety of data causes the schema of a data warehouse to be highly complex. Moreover, whenever a source system changes, or a new system is introduced, the data in the new system must match the schema of the data warehouse, or the data warehouse must be changed to accommodate the new data. As a consequence, data warehouse projects are notorious for their duration and high costs. Many careers are built on data warehouses and, unfortunately, many careers have been broken on&nbsp;them as well.</p>
    <p class="book-title--packt">There is a more fundamental flaw in the traditional approach. By starting with source systems and working upward through the Five-Layer model, you miss the invaluable business context about the insights that are actually needed. Even while most data warehouse projects aim to include business needs and contexts in the process, in reality, the business fades into the background in many, and perhaps most, projects that are approached this way. The technical complexity is just too much to let the business be involved deeply. Often, the result is that when the data warehouse is finally finished (or rather, taken into production for the first time), it is&nbsp;already behind the real business needs of that moment.</p>
    <p class="book-title--packt">While waiting for the corporate reports to be available, the organization has already deployed a "shadow IT" tactic to retrieve the insights needed. People take any tool at hand (usually Excel) and any data that they can put their hands on, and build analytics solutions themselves. While this is a solution to a problem &ndash; the urgent need for insights &ndash; it doesn't <a id="calibre_link-376" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>help the organization in the long run. The quality of the&nbsp;data, and therefore the validity of the insights generated, remains questionable. The risk of making incorrect decisions based on these insights is high.</p>
    <h2 id="calibre_link-19" class="calibre8">Using Power BI models to accelerate BI solution development</h2>
    <p class="book-title--packt">Instead of <a id="calibre_link-373" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the approach <a id="calibre_link-1118" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>described above, Power BI enables working both upward and downward through the Five-Layer model.</p>
    <figure class="mediaobject"><img src="images/000023.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.6: The solution development approach Power BI enables</p>
    <p class="book-title--packt">With this approach, we use Power BI not only as the target platform for the solution, but also as a tool to streamline the project itself. By doing this, you leverage the specific capabilities of Power BI: fast creation of reports providing tangible insights, based on wherever the data is. The nature of Power BI models and DAX is foundational for these capabilities.</p>
    <p class="book-title--packt">The approach is based on two basic principles:</p>
    <ol class="calibre9">
      <li class="calibre12">We do not know exactly what we need</li>
      <li class="calibre12">Our data is not correct</li>
    </ol>
    <p class="book-title--packt">The consequence<a id="calibre_link-374" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of these<a id="calibre_link-1119" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> principles is that it is impossible to get it right the first time. Rather, you should deploy an iterative way of working to fail fast and improve&nbsp;fast.</p>
    <h3 id="calibre_link-20" class="calibre8">We do not know exactly what we need</h3>
    <p class="book-title--packt">This principle<a id="calibre_link-377" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> means that you do not expect the business owner, or yourself for that matter, to be able to provide correct specifications for the reports. If you have ever undertaken a BI project, you will recognize this. Even those who claim they know exactly how things should be will overlook some details. </p>
    <p class="book-title--packt">Even if they do not, there will be a misunderstanding in how to implement the specifications in the solution, if only because the person developing the solution does not have the same business context.</p>
    <p class="book-title--packt">As a consequence, it is not effective to spend a lot of time gathering requirements or writing down specifications and getting them approved. You just know that the first report will be wrong, so the better way is to do it wrong as fast as possible. As it turns out, it is much easier to point out the errors and flaws in something that actually exists than to write down all the details in an abstract way.</p>
    <p class="book-title--packt">You can formalize this approach by working in multiple iterations with a joint session at the end to show prototypes and gather feedback. (We like to call these <em class="italic">business design sessions</em> to highlight the nature of them: they are not feedback sessions or demos, but joint efforts to achieve the right results.) Depending on your skills in Power BI and DAX, you can take two or more days to work on a prototype. The results of a business design session are taken as input for the next iteration.</p>
    <figure class="mediaobject"><img src="images/000044.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.7: Iterative requirements capturing</p>
    <p class="book-title--packt">The result of this is a report that is truly jointly developed and optimally aligned with business needs. Moreover, the report and underlying analysis model is an exact specification <a id="calibre_link-378" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of the data that the lower layers in the Five-Layer model should provide.</p>
    <h3 id="calibre_link-21" class="calibre8">Our data is not correct</h3>
    <p class="book-title--packt">This second principle is most probably not new to you. Of course our data is not correct! The reason for this is that real-world business processes are much messier and more complex than anyone could model. </p>
    <p class="book-title--packt">And, when you consider that IT systems are designed with an image in mind of what a business process <em class="italic">should</em> look like, it is clear that a system to automate a business process faces a fundamental dilemma. Either the system implements a strict data quality policy, in the sense that one can only enter data that conforms to the designed processes (and therefore fails to capture each and every case in that process), or the system provides flexibility to capture all instances of the business process, and necessarily allows for data that does not fit the designed ideal flow.</p>
    <p class="book-title--packt">The latter option is what is chosen most of the time. This means that a typical business system allows for exceptions, custom fields that users leverage to enter custom information, and different kinds of bypasses. As a consequence, data from business systems does not always conform to your expectations. And things become worse when your business data is in spreadsheets or other files!</p>
    <p class="book-title--packt">In traditional BI solutions, messy data is hard to detect and solve. The reason is that, typically, the BI system only contains aggregated data or the technology does not support the exploration of data on a detailed level by business users. This is where Power BI comes in: the technology of Power BI models is so powerful that in many situations, data can be loaded into the model without being aggregated. The visual and interactive reports provide insights through sophisticated (DAX) aggregations, while allowing you to zoom in to the deepest levels of detail.</p>
    <p class="book-title--packt">In an iterative approach to BI solution development, results after the first few iterations are typically full of errors. Knowledgeable businesspeople are generally capable of discovering these errors quite easily. At first, flaws in the aggregations implemented are discovered <a id="calibre_link-379" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this way; but in later iterations, the quality of the data comes to light. Being able to see detailed data in a Power BI report is a huge help in driving the adoption of, and trust in, new BI solutions.</p>
    <h1 id="calibre_link-22" class="title">The digital transformation cycle</h1>
    <p class="book-title--packt">So far, we have<a id="calibre_link-692" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> focused on what is needed to go from "raw" data to insights, and the role of DAX-powered Power BI models in this process. We have seen that business value does not come from merely connecting and preparing data, but that it is the insights from visual, interactive reports that provide value.</p>
    <p class="book-title--packt">However, no organization will get better from just staring at nice-looking reports. What really matters, of course, is what you do with the insights. In other words: you need to take action to reap the benefits of a BI solution. You will also want to measure the effects of these actions, either in an automated way or by letting users enter feedback into some kind of system. The result of that is, again, data.</p>
    <p class="book-title--packt">This leads to a cycle of <em class="italic">digital transformation</em>, or data-driven business improvement:</p>
    <figure class="mediaobject"><img src="images/000065.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.8: The digital transformation cycle</p>
    <p class="book-title--packt">While Power BI shines in the process of going from data to insights, it is not designed to cover the other half of the transformation cycle. That part requires different capabilities, like facilities to enter or update data, and technology to connect systems and people.</p>
    <p class="book-title--packt">It is for this<a id="calibre_link-693" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> reason that Microsoft made Power BI a part of a broader platform called the <strong class="screentext">Power Platform</strong>. The Power Platform addresses the full digital transformation cycle with the same basic design principles: a central role for the business user, easy entry, and sheer power to cover demanding business requirements.</p>
    <p class="book-title--packt">The Power Platform consists of three main components next to Power BI:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Power Apps</strong> provides<a id="calibre_link-1150" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> an environment to develop <a id="calibre_link-1071" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>business applications in a low-code manner, for use on smartphones or through a web browser. These can be used to edit or add data.</li>
      <li class="bullet"><strong class="screentext">Power Automate</strong> allows <a id="calibre_link-1072" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for automating process flow between a variety of systems, services, and user-oriented applications. A flow could, for instance, be triggered by an incoming email, ask for confirmation by a business owner, and automatically update data and trigger the refresh of a Power BI model and connected reports.</li>
      <li class="bullet"><strong class="screentext">Power Virtual Agents</strong> offers<a id="calibre_link-1151" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> a platform to create user-friendly interaction with the Power Platform through AI-powered chatbots. With these, a user can enter data or kick off actions through a conversation-style interaction instead of having to learn a specific app interface.</li>
    </ul>
    <p class="book-title--packt">Although these are all separate components of the Power Platform, tight integration exists between them. For example, you can create a Power BI report with an embedded Power Apps app to allow users to change data in a context-aware manner, right from where the<a id="calibre_link-694" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> insights are. In the same way, Power Automate flows can be embedded in Power BI reports to allow for taking action based on insights.</p>
    <h1 id="calibre_link-23" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, we discussed the field of business intelligence and the central role of analytical models in modern BI solutions. Power BI models are ideally suited for use as such models, not least because of the power of DAX.</p>
    <p class="book-title--packt">You have learned about two capabilities of DAX that have a profound impact on the way BI solutions can be designed and developed:</p>
    <ul class="calibre9">
      <li class="bullet">DAX enables sophisticated calculations for a variety of aggregations of data; aggregations that, in the past, needed a lot of preparation of customized data. Therefore, DAX allows for shifting the focus from data (with all the tedious work involved) to the logic to generate business insights.</li>
      <li class="bullet">DAX as a language is set up in a way that allows businesspeople who are mostly familiar with Excel to work on the BI solution themselves, to varying degrees. This means that much more alignment with business priorities can be achieved.</li>
    </ul>
    <p class="book-title--packt">As Power BI models and DAX are two sides of the same coin, it is important to know how to balance the two to achieve optimal results. Simply put, you should do with DAX whatever DAX is particularly good at, and not solve these things in data, and vice versa, that is, not using DAX to prepare or generate data.</p>
    <p class="book-title--packt">The next few chapters elaborate on these topics. In <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>, we discuss the dos and don'ts of designing Power BI models. <em class="italic">Chapter 1.3</em>, <em class="italic">Using DAX</em>, focuses on how to use DAX for best results. <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>, continues on this theme, exploring the most important concepts to understand when writing DAX calculations. <em class="italic">Part 2</em> of this book contains many examples, mostly from real-life customer projects, that demonstrate the power of DAX and the balance between DAX and Power BI models.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-256">
<div id="calibre_link-1558" class="calibre2">
<div id="calibre_link-1559" class="calibre3"><div id="calibre_link-1560" class="calibre4">
    <h1 class="chapternumber">1.2</h1>
    <h1 id="calibre_link-24" class="title">Model Design</h1>
    <p class="book-title--packt">Being effective with DAX starts with designing a good analysis model. In this chapter, we address a number of modeling-related topics that are important to understand for strong model designs. </p>
    <p class="book-title--packt">The topics in this chapter include:</p>
    <ul class="calibre9">
      <li class="bullet">The way the Power BI engine stores data</li>
      <li class="bullet">Choosing the right data types</li>
      <li class="bullet">Relationships</li>
      <li class="bullet">What structure to strive for in your models</li>
    </ul>
    <p class="book-title--packt">To achieve good models, you will need to adapt to the appropriate way of thinking. This is a change needed both when you start working with Power BI coming from a background in Excel, and when you have a background in relational databases. When you are used to working in Excel, the concept of relationships in an analysis model specifically takes time to comprehend; but even when you have a database background, there are many things that are different as well. One of the difficulties in designing for Power BI is that the concepts seem familiar to database professionals, when in reality, they are fundamentally different. We therefore discuss many of these differences in this chapter.</p>
    <h1 id="calibre_link-25" class="title">Columnar data storage</h1>
    <p class="book-title--packt">The power<a id="calibre_link-1095" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of the Power BI model comes primarily from a smart data storage mechanism. Power BI models are, in fact, databases in the sense that they organize and store data. But the internals are very different from other database technologies you may be familiar with.</p>
    <h2 id="calibre_link-26" class="calibre8">Relational databases</h2>
    <p class="book-title--packt">The<a id="calibre_link-1109" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> traditional, corporate <a id="calibre_link-1202" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>way of <a id="calibre_link-1203" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>working with data is with a <strong class="screentext">relational database management system</strong> (<strong class="screentext">RDBMS</strong>) like Microsoft SQL Server. In an RDBMS, tables of data are defined with a fixed number of data columns per table. Each column must have a data type, like integer, text, or decimal number, and from this information, the RDBMS can derive how much space is needed to store a single row of data, or record, and how many rows can be stored in a disk-based data file. This concept makes an RDBMS an effective choice for applications that <em class="italic">process transactions</em>, like sales transactions from a web shop or transactions in a company's financial ledger.</p>
    <p class="book-title--packt">The concept of an <strong class="screentext">index</strong> in an RDBMS makes finding a specific record fast and efficient, which means that processing transactions on existing records can also be implemented effectively with an RDBMS. Tables can be linked through relationships (hence the name RDBMS), which makes sure that data in these tables are consistent; for example, an RDBMS will block the insertion of a sales transaction involving an unknown customer.</p>
    <p class="book-title--packt">The RDBMS is a mature concept and many optimizations for it have been invented and implemented. As a result, most traditional analytics platforms rely on RDBMS technology as well. However, the needs of an analytical solution are completely different from those of a transactional system. In analytics, you are typically not interested in retrieving all data from a single row, but in retrieving data from many rows at the same time, and only from one or a few columns. To retrieve information from a single column, the RDBMS still needs to read complete rows from storage. Also, aggregating data from many rows is something an RDBMS is not designed to do and so will be relatively slow. </p>
    <p class="book-title--packt"><em class="italic">Figure 1.2.1</em> visualizes this; storing data by row (identified by the numbers) leaves no possibility of efficiently retrieving all the required column's values:</p>
    <figure class="mediaobject"><img src="images/000087.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.1: Retrieving column values from row-based storage is inefficient</p>
    <h2 id="calibre_link-27" class="calibre8">Columnar databases</h2>
    <p class="book-title--packt">The Power<a id="calibre_link-1107" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> BI model transposes <a id="calibre_link-479" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the concept of an RDBMS by storing data not on a per-row basis, but per column. The rationale behind this is that in an analytical solution, often only a couple of columns have to be read from storage, but for all available rows. This is most efficient when all data in the same column are stored near each other. </p>
    <p class="book-title--packt">Another reason is that in real-life situations, many values in a single column are the same; for example, millions of sales transactions are for only thousands or tens of thousands of products. A columnar database can therefore highly compress data by only storing a specific value once and keeping track of which rows it belongs to.</p>
    <p class="book-title--packt">The high compression rate that columnar databases achieve opens up the possibility of keeping the whole database in memory, meaning that all data resides in the internal memory of the computer or server the database runs on, instead of being stored in files on disk. Keeping data in memory accelerates data retrieval even more.</p>
    <p class="book-title--packt">The columnar model means data aggregation is done very efficiently. Instead of, for instance, summing all separate values in a column, the columnar database engine can simply take each distinct value and multiply that by the number of rows the value appears in. In short, the Power BI model's database engine is designed from scratch to support the typical workloads that come with data analytics: handling large amounts of data with specific characteristics and performing aggregations and&nbsp;calculations across these.</p>
    <p class="book-title--packt">There is, however, one caveat here: in the end, you still need to know which values in different columns go together in one row. It is not enough that product 103 has been sold; you need to know how much it was sold for, to which customer, and on what day. To enable this, the model must keep lists of pointers that keep track of which value goes in which row, for any column. The overhead from this obviously grows when more columns are added to a table. "Narrow" tables are therefore more efficient than "broad" tables<a id="calibre_link-1108" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in a Power BI<a id="calibre_link-480" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> model.</p>
    <h1 id="calibre_link-28" class="title">Data types and encoding</h1>
    <p class="book-title--packt">The Power<a id="calibre_link-1096" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> BI model <a id="calibre_link-1099" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>works with a limited number of data types. Choosing the right data type for your data is important, as it determines the way your data is stored, or <em class="italic">encoded</em>, and how efficiently the model can process your data. Below is a list of all the data types recognized by Power BI:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Text</strong>: The most generic <a id="calibre_link-1358" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>data type is Text. Virtually all data can be stored as Text. When loading data through Power Query, the generic Power Query data type Any is converted to Text in the Power BI model. This causes numerical columns to be stored as Text when you forget to explicitly make the type conversion in Power Query. (You can, of course, change the data type in the model, which will automatically add a type change step in Power Query.)</li>
      <li class="bullet"><strong class="screentext">Whole Number</strong>: The data <a id="calibre_link-1519" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>type Whole Number is used, as you would guess, to store whole numbers. Because of the way the Power BI model stores and compresses data, this is one of the most efficient data types available. </li>
      <li class="bullet"><strong class="screentext">Decimal Number</strong>: This <a id="calibre_link-691" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>data type is the most versatile of the number data types. It can store almost anything, from very small to very large numbers, and with fractional values. You can store numbers with up to 15 digits.</li>
      <li class="bullet"><strong class="screentext">Fixed Decimal Number</strong>: The <a id="calibre_link-815" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Fixed Decimal Number type, sometimes called Currency, is a data type for storing fractional number values with four decimals. You can store numbers with up to 19 digits, including the four decimals. This means that this data type has a smaller reach than the Decimal Number type. The Fixed Decimal Number type is typically used to store currency amounts, but can be used for any value that doesn't need many decimals.</li>
      <li class="bullet"><strong class="screentext">Date/Time, Date, Time</strong>: The <a id="calibre_link-602" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Power BI model stores date and time values with a similar structure as Excel. This means that values are decimal numbers, with the whole number part representing the date, and the decimals representing the time. <p class="bullet1">The difference compared to Excel is in the base reference date: in a Power BI model, the number 1 corresponds to December 31, 1899, while in Excel, the number 1 corresponds to January 1, 1900 (both at midnight). The decimal adds the time as a fraction of a 24-hour day; for example, the value 2.5 represents January 1, 1900, at noon.</p>
        <p class="bullet1">You have three choices for storing your date/time data. The Date/Time data type stores both dates and times. The Date data type stores only dates, meaning that this data <a id="calibre_link-603" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>type is equivalent to whole numbers. The Time data type only stores the time part, or decimals.</p>
      </li>
      <li class="bullet"><strong class="screentext">True/False</strong>: The True/False or<a id="calibre_link-1413" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> Boolean data type can only store two values: True and False. Though of limited use, data is stored very efficiently using this type.</li>
      <li class="bullet"><strong class="screentext">Binary</strong>: The Binary data <a id="calibre_link-372" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>type is used to store data that cannot be represented as text, like image data or documents. It is not possible to perform aggregations or calculations with this data type, but it may be used for storing images for use in reports.</li>
    </ul>
    <p class="book-title--packt">Selecting the best data types for your data is paramount for an efficient model. The Power BI model aims to store the unique values in a column as efficiently as possible. We have long passed the time when we needed to care about bits and bytes when working with<a id="calibre_link-1097" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> computers, but when designing a model, it still<a id="calibre_link-1100" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> helps to consider the individual 0s and 1s that computers work with. The model will determine how many bits are needed to store your values; as all data is kept in memory, every bit saved helps.</p>
    <p class="book-title--packt">As an example, suppose you have a column with whole number values between 0 and 10. In digital notation, the number 10 is represented as 1010, or 4 bits. The set of values can thus be encoded in words of 4 bits, directly representing the values. This approach is called <strong class="screentext">value encoding</strong>. In <a id="calibre_link-1436" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>our modern computers with 64-bit processors, using 4 bits is already much more efficient than storing the values as 64-bit numbers.</p>
    <p class="book-title--packt">Value encoding is possible for data types that are whole numbers "under the hood": Whole Number, Date, True/False, and also Fixed Decimal. Fixed Decimal benefits from the <em class="italic">fixed</em> number of four decimals: it is basically a whole number divided by 10,000. The DAX engine is, in fact, capable of doing basic transformations before doing value encoding, like subtracting the same number from all values encountered.</p>
    <p class="book-title--packt">Other data types cannot be directly represented as whole numbers, and the database still needs to find a way to store values in a minimum number of bits. This is done by keeping a <a id="calibre_link-873" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>numbered list of values and storing the numbers instead of the values. This is called <strong class="screentext">hash encoding</strong>. Hash-encoded columns work less efficiently than value-encoded columns, as the database needs to do the translation between numbers and values each time the column is used.</p>
    <p class="book-title--packt">It is important to keep in mind that the Power BI model chooses the best encoding given the data type and values in a column. This means that even when you use a whole number-based data type, you could still end up with hash encoding. To give an extreme example, when you have a column containing not only numbers between 0 and 10, but also the number 1,000,000, the number of bits needed to store these values directly is so much larger that the engine will decide to use hash encoding instead.</p>
    <p class="book-title--packt">We see this happen in real projects quite regularly, in particular when it comes to storing dates. Suppose you have a table with employees, containing the date they entered the company but also the date they quit. For all current employees, the end date is of course empty; though, often, a specific future date is set instead of keeping the field empty. This is a valid approach, but if you choose a date like December 31, 9999, you <a id="calibre_link-1101" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will <a id="calibre_link-1098" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>certainly lose the benefits of value encoding for your date columns. Instead, use a value that is not too far into the future, like December 31, 2029 (depending on your scenario, of course). </p>
    <h1 id="calibre_link-29" class="title">Relationships</h1>
    <p class="book-title--packt">One of the <a id="calibre_link-1116" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>most misunderstood elements in Power BI models is the concept of relationships. Whether you are working with Power BI coming from an Excel background, or you have been educated in relational databases, relationships in Power BI models require an approach that is different from what you are familiar&nbsp;with.</p>
    <h2 id="calibre_link-30" class="calibre8">Data in Excel</h2>
    <p class="book-title--packt">Let us zoom<a id="calibre_link-1122" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in on data in Excel first. The concept closest to a database in Excel is that&nbsp;of Excel tables. You could consider an Excel table as a "flat" database. This way of storing data has many disadvantages. </p>
    <p class="book-title--packt">As an example, the figure below shows data&nbsp;as it may be stored in an Excel worksheet:</p>
    <figure class="mediaobject"><img src="images/000108.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.2: A table in Excel</p>
    <p class="book-title--packt">This table contains order amounts and dates for sales orders, which are sold by employees. There<a id="calibre_link-1123" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> are multiple issues with flat databases:</p>
    <ul class="calibre9">
      <li class="bullet">Clearly, all information about an employee (like job role and date of birth) is duplicated with each order sold by that employee. So, a lot of information is stored redundantly, which takes up a lot of storage space. </li>
      <li class="bullet">Storing information multiple times increases the risk of errors in the data.</li>
      <li class="bullet">When some attributes of an employee change, like her job role, the changes have to be put through in all rows associated with that employee.</li>
      <li class="bullet">Things get worse when there are multiple attributes of the same kind for an entity. In our example, Giuliana seems to have two job roles. Each of Giuliana's sales orders is associated with only one job role, which may or may not make sense from a business point of view: when we aggregate sales by job role, the result for "Consultant" will only contain one of Giuliana's orders.</li>
      <li class="bullet">One of the biggest issues arises when data is coming from multiple sources. Let's imagine that we do not only have sales data, but also targets. It takes a lot of effort to combine data from these sources into one flat table of data. In fact, Excel users spend most of their time setting up the single flat data table they need to work with pivot tables.</li>
    </ul>
    <p class="book-title--packt">In Excel, there is really no workaround for these issues. That is, except when you start using Power Pivot, the Power BI model equivalent in Excel. Before discussing the Power BI approach, let's look at how data is handled in a relational database.</p>
    <h2 id="calibre_link-31" class="calibre8">Data in relational databases</h2>
    <p class="book-title--packt">In a relational<a id="calibre_link-1124" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> database, or RDBMS, the data is separated into multiple tables. Typically, these tables are associated with entities that are relevant to the organization, like <code class="code-in-text--packt">Customer</code>, <code class="code-in-text--packt">Employee</code>, <code class="code-in-text--packt">Product</code>, and others. Each row in a table has an identifier, or <strong class="screentext">key</strong>, that allows for consistently referring to the row from other tables; for instance, in a table with sales orders, the keys for customer and product can be included instead of all the attributes for the customers and products involved:</p>
    <figure class="mediaobject"><img src="images/000129.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.3: Relationships in an RDBMS </p>
    <p class="book-title--packt">Obviously, it doesn't make sense to register a sales order without a customer key or with an unknown key. That is why, in an RDBMS, you can define relationships between tables to denote which columns in a table refer to the key in other tables. The RDBMS then enforces that a column on which a relationship is defined only contains known keys of the related table. It blocks the insertion or mutation of a record with a value that doesn't appear in the related table. In other words, an RDBMS relationship acts as a <em class="italic">constraint</em> on the data stored and is used to enforce <em class="italic">referential integrity</em>.</p>
    <h2 id="calibre_link-32" class="calibre8">Power BI's relational model</h2>
    <p class="book-title--packt">In a Power BI<a id="calibre_link-1125" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> model, relationships are links between tables. At first sight, they are comparable to relationships in an RDBMS but, in reality, they are fundamentally different. </p>
    <p class="book-title--packt">The basis of a relationship in a Power BI model is a data table with a unique key. Another table with the same key values can be related to it, but in this table, the key values need not be unique. This type of relationship <a id="calibre_link-1049" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is called <strong class="screentext">one-to-many</strong>, meaning that there is one table where a key appears exactly once, and another table where the same key can appear many times. You may call the column with unique<a id="calibre_link-1154" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> keys a <strong class="screentext">primary key column</strong>, and the column with non-unique<a id="calibre_link-819" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> keys a <strong class="screentext">foreign key column</strong>, just like with relational databases. </p>
    <p class="book-title--packt">The structure of a Power BI model, with its tables and relationships, can be viewed in&nbsp;a diagram view, like <a id="calibre_link-1126" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the one from Power BI Desktop in the figure below: </p>
    <figure class="mediaobject"><img src="images/000149.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.4: A relationship between two tables in a Power BI model</p>
    <p class="book-title--packt">There are two fundamental differences between relationships in a Power BI model and relationships in an RDBMS. The first is referential integrity. While a relationship in an RDBMS acts as a constraint on the data, a relationship in Power BI does not do this. Frankly, Power BI couldn't care less whether or not your data is consistent. When the foreign key column contains values that do not appear in the primary key column, the relationship can still be defined. </p>
    <p class="book-title--packt">The model will link each unknown foreign key value to a blank row (as in the figure below). This row will not be visible in the model but can become visible in a report.</p>
    <figure class="mediaobject"><img src="images/000170.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.5: Unknown values are related to a blank row</p>
    <p class="book-title--packt">One advantage of this is that you don't have to worry about the order in which data tables are loaded or refreshed, whereas in an RDBMS this is something to consider carefully. The drawback, of course, is that you have to be careful when creating relationships, specifically if you do that through dragging and dropping fields in the diagram view. Power BI will not complain when you drop a field on the wrong target, creating a<a id="calibre_link-1127" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> relationship that doesn't make sense whatsoever.</p>
    <p class="book-title--packt">The other fundamental difference between relationships in Power BI and in relational databases is <em class="italic">filter propagation</em>. A relationship in a Power BI model actively filters data. More specifically, when some rows in one table are selected, the related rows in the other table are automatically selected as well (in the direction of the arrow). This is a core design principle of the Power BI model, with many implications for designing DAX calculations.</p>
    <p class="book-title--packt">In an RDBMS, a relationship does not have this behavior. When querying an RDBMS, the user must specify which tables to combine on which (primary key and foreign key) columns. This makes querying an RDBMS very flexible, but it also forces the RDBMS to do a lot of work for each query. As a result, retrieving data from many tables and therefore processing a lot of relationships can become slow.</p>
    <h2 id="calibre_link-33" class="calibre8">Relationship properties</h2>
    <p class="book-title--packt">When you<a id="calibre_link-1117" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> create a relationship between tables in a Power BI model, you can set several properties on the relationship that drives its behavior. These properties are directly related to a relationship's main purpose, filter <a id="calibre_link-1561" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>propagation.</p>
    <h3 id="calibre_link-34" class="calibre8">Active and inactive relationships </h3>
    <p class="book-title--packt">To enable<a id="calibre_link-1128" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> relationships to <a id="calibre_link-1135" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>do filter propagation, there must be an unambiguous connection between tables. Suppose that for a sales transaction, both the order date and the payment date are registered. When relationships exist from both columns to a <code class="code-in-text--packt">Calendar</code> table, and a row is selected in the <code class="code-in-text--packt">Calendar</code> table, it would not be clear which sales transactions should be selected: the transactions that were ordered on that date, or those that were paid, or both?</p>
    <p class="book-title--packt">To deal with this, the Power BI model allows only one <em class="italic">active</em> relationship between two tables. This also applies when tables are connected via other tables: only a single active relationship path is allowed. In <em class="italic">Figure 1.2.6</em>, it is the relationship between the columns <code class="code-in-text--packt">fSales[Order Date]</code> and <code class="code-in-text--packt">Calendar[Date]</code>. When you define a relationship that creates a second path, that relationship is made inactive. Inactive relationships are shown in the diagram view with a dashed line. </p>
    <p class="book-title--packt">In <em class="italic">Figure 1.2.6</em>, this will be the relationship between the columns <code class="code-in-text--packt">fSales[Delivery date]</code> and <code class="code-in-text--packt">Calendar[Date]</code> and the columns <code class="code-in-text--packt">fSales[Payment date]</code> and <code class="code-in-text--packt">Calendar[Date]</code>:</p>
    <figure class="mediaobject"><img src="images/000192.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.6: One active and two inactive relationships</p>
    <p class="book-title--packt">An <a id="calibre_link-1136" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>inactive <a id="calibre_link-1129" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationship can be activated for a specific calculation using the <code class="code-in-text--packt">USERELATIONSHIP</code> DAX function.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt"><strong class="screentext">Warning</strong>: Activating relationships with the <code class="code-in-text--packt">USERELATIONSHIP</code> function will lead to errors in DAX calculations when row-level security (RLS) is defined on the table containing the primary key. The reason for this is that security filters are propagated through relationships, just like any other filter. Inactivating the relationship that propagates the security filter and activating another relationship causes ambiguity about what should be selected.</p>
      <p class="book-title--packt">Because of this, it is <a id="calibre_link-1562" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>important to <a id="calibre_link-1563" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>design your model with care, keeping in mind possible (future) security requirements. Do not overuse inactive relationships. For an in-depth exploration of securing your models, refer to <em class="italic">Chapter 2.1</em>, <em class="italic">Security with DAX</em>.</p>
    </div>
    <h3 id="calibre_link-35" class="calibre8">Cross filter direction</h3>
    <p class="book-title--packt">Filter propagation <a id="calibre_link-1131" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>through<a id="calibre_link-522" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> relationships is normally <a id="calibre_link-1414" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>done only from the primary table to the foreign table. In the diagram view, the direction of filter propagation, or cross filtering, is shown through a small arrow in the middle of the relationship line:</p>
    <figure class="mediaobject"><img src="images/000215.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.7: The cross filter direction of a relationship</p>
    <p class="book-title--packt">It is possible to change the cross filter direction so that filter propagation happens in both directions. This is done in the <strong class="screentext">Edit relationship </strong>dialog by setting the cross filter direction to <strong class="screentext">Both</strong>. This may seem like a convenient setting to apply by default, but do not do this! In fact, double cross filtering relationships should be used only in specific scenarios. Try to avoid them, otherwise, or you will end up with strange behavior in reports, many inactive relationships, and highly complex DAX calculations.</p>
    <p class="book-title--packt">One specific scenario in which to use relationships with double cross filter direction is when implementing many-to-many relationships. For instance, assume a model with customers and branch offices. Customers are serviced from one or more branch offices and, conversely, branch <a id="calibre_link-1132" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>offices <a id="calibre_link-523" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>service multiple customers:</p>
    <figure class="mediaobject"><img src="images/000013.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.8: Customers and Branch offices</p>
    <p class="book-title--packt">Both the <code class="code-in-text--packt">Customer</code> and <code class="code-in-text--packt">Branch office</code> tables have unique key columns, but neither of them can have a column with a foreign key: each row must be linked to multiple rows in the other table. The solution to this is to have an intermediate table with all relevant combinations of customer keys and branch office keys. Now, two relationships can be created from the combination table to the <code class="code-in-text--packt">Customer</code> and <code class="code-in-text--packt">Branch office</code> table, respectively: </p>
    <figure class="mediaobject"><img src="images/000031.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.9: An intermediate table</p>
    <p class="book-title--packt">However, the <a id="calibre_link-1133" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationships <a id="calibre_link-524" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>do not yet correctly cross filter from <code class="code-in-text--packt">Customer</code> to <code class="code-in-text--packt">Branch office</code> and vice versa: you can select a row in the <code class="code-in-text--packt">Customer</code> table and the relationship will propagate the selection to the combination table. But this selection is not propagated to the <code class="code-in-text--packt">Branch office</code> table. </p>
    <p class="book-title--packt">The solution is to set both relationships to the both-ways cross filter direction. Now, when selecting a row in the <code class="code-in-text--packt">Customer</code> table, the relationship propagates this selection in the default direction to the combination table and the other relationship propagates this to the Branch office table. Conversely, when selecting a row in the <code class="code-in-text--packt">Branch office</code> table, the relationship propagates the selection to the combination table and the selection is then propagated to the <code class="code-in-text--packt">Customer</code> table.</p>
    <figure class="mediaobject"><img src="images/000052.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.10: Implementing a many-to-many relationship through an intermediate table</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The caveat <a id="calibre_link-1134" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>here <a id="calibre_link-525" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>appears when you relate one of the tables, say the <code class="code-in-text--packt">Customer</code> table, to a table with sales transactions. Necessarily, with each sales transaction, the <code class="code-in-text--packt">Customer</code> key is recorded. The setup allows for selecting a customer &ndash; for instance, MegaBike &ndash; and viewing the total sales for MegaBike. However, it is not possible to view sales for MegaBike from a specific branch office: when you select a branch office, the total sales for MegaBike are returned whenever they are linked to the branch office. When you report on total sales by branch office, the MegaBike sales will be part of each branch office that MegaBike is related to.</p>
      <p class="book-title--packt">In this scenario, the better modeling option is almost always to relate both the <code class="code-in-text--packt">Customer</code> and the <code class="code-in-text--packt">Branch office</code> tables to the sales table directly, without using the combination table to relate both tables together.</p>
      <figure class="mediaobject"><img src="images/000072.png" alt="Graphical user interface, diagram  Description automatically generated" class="pcalibre6 calibre16" /></figure>
      <p class="book-title--packt">Figure 1.2.11: Using cross filtering between the Branch office Customer and Customer and Branch office tables</p>
    </div>
    <h2 id="calibre_link-36" class="calibre8">Cardinality</h2>
    <p class="book-title--packt">The <a id="calibre_link-475" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>default<a id="calibre_link-1130" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> relationship in a model is one-to-many, with a table containing a (unique) primary key, and another table containing the same values as foreign keys, which are not unique. The official name for this relationship property is the relationship <strong class="screentext">cardinality</strong>.</p>
    <p class="book-title--packt">Relationships can have other cardinalities as well. A <a id="calibre_link-987" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>trivial one is <strong class="screentext">many-to-one</strong>, which is really the same as one-to-many with the position of the two tables reversed.</p>
    <p class="book-title--packt">A relationship can <a id="calibre_link-1050" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have <strong class="screentext">one-to-one</strong> cardinality, meaning that the keys are unique on both sides of the relationship. One-to-one relationships have both-ways cross filter direction by default. As a consequence, the two tables act as a single table in almost all circumstances. You should avoid one-to-one relationships in your model: instead, combine the two related tables into a single table unless you have specific reasons to keep them separated (see <em class="italic">Chapter 2.4</em>, <em class="italic">Working with AutoExist</em>, to learn what these reasons could be).</p>
    <p class="book-title--packt">The last option for relationship <a id="calibre_link-984" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>cardinality is <strong class="screentext">many-to-many</strong>. In this case, neither of the two related tables contain unique keys. Again, you may have specific reasons to use this kind of relationship. We strongly advise against using many-to-many relationships, as these will easily lead to bad modeling. The section <em class="italic">RDBMS principles to avoid in Power BI models</em> later in <a id="calibre_link-1564" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this chapter elaborates on<a id="calibre_link-1565" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> many-to-many relationships.</p>
    <h1 id="calibre_link-37" class="title">Effective model design</h1>
    <p class="book-title--packt">The concepts<a id="calibre_link-1115" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of relationships and filter propagation enable powerful analytics in Power BI models. It is important to think about the design of a model: which tables should the model contain, and which columns need to be in those tables? Which relationships are needed? In short, what is the overall structure of the model? The choices you make in model design will determine what results the model will be able to deliver. </p>
    <h2 id="calibre_link-38" class="calibre8">Star schemas and snowflakes</h2>
    <p class="book-title--packt">A best <a id="calibre_link-1121" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>practice <a id="calibre_link-1120" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for analytics <a id="calibre_link-1278" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>using <a id="calibre_link-1276" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relational databases is to work with a specific database structure, known as a <strong class="screentext">star schema</strong>. The basic ideas of star schemas apply to Power BI models as well.</p>
    <figure class="mediaobject"><img src="images/000094.png" alt="Shape, square  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.12: Generic star schema structure</p>
    <p class="book-title--packt">The <a id="calibre_link-1566" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>central <a id="calibre_link-1567" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>tables<a id="calibre_link-1568" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in a<a id="calibre_link-1569" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> star schema model are the <strong class="screentext">fact tables</strong>. These tables contain things that have happened, will happen, or should happen; like sales transactions, financial ledger transactions, customer inquiries, student enrollments, sales opportunities, and others.</p>
    <p class="book-title--packt">Through foreign key columns, the fact tables are related to tables describing different entities relating to the facts, like customers, products, cost centers, students, dates, and others. In the star schema concept, these tables are<a id="calibre_link-695" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> called <strong class="screentext">dimensions</strong>; in a Power BI model, however, we prefer to call them <strong class="screentext">filter tables</strong>, for reasons explained below.</p>
    <p class="book-title--packt">The columns in filter tables are used to filter the results in a report, by using them as row labels in a matrix or table visual, on a chart axis, or as a slicer field. A fact table contains the data that is aggregated in the report. Each key value can appear multiple times in a fact table, corresponding to multiple facts that happened on the same day, or for the same customer, and so on.</p>
    <p class="book-title--packt">In a pure star schema model, there are no relationships between filter tables. When filter tables are related to other filter tables, the resulting model structure is called a <strong class="screentext">snowflake</strong>:</p>
    <figure class="mediaobject"><img src="images/000116.png" alt="Shape, rectangle  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.13: A snowflake schema</p>
    <h2 id="calibre_link-39" class="calibre8">The issue with star schemas</h2>
    <p class="book-title--packt">Among RDBMS <a id="calibre_link-1279" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>professionals, snowflake schemas are generally considered to be an inferior design. A lot of design effort is put into creating a pure star schema. Many Power BI consultants come from an RDBMS background and apply what they learned in relational databases to Power BI. As a consequence, you will hear "<em class="italic">Build a star schema!</em>" all the time when gathering information on Power BI modeling.</p>
    <p class="book-title--packt">The somewhat provocative title of this section is to have a discussion about what is really important in Power BI modeling. The fact is, a Power BI model is <em class="italic">not</em> a relational database; what is confusing, however, is that many concepts and terms used look similar to the RDBMS world. This invites the Power BI model designer to apply learnings from relational databases to Power BI models. The problem is that this generally leads to suboptimal models.</p>
    <p class="book-title--packt">It is important to realize that the concept of star schemas was developed when there was no such thing as a columnar database. An RDBMS star schema minimizes the number of joins to be solved when querying the database, which is important as relational databases tend to get into trouble when needing to join many tables at once, on a lot of rows of data. This is the typical workload of a data warehouse, which was traditionally used as the source for reporting. By "traditionally," we mean before the time of Power BI models &ndash; nowadays, the data warehouse, when available, is just the source of data for Power BI models and, in importing data to a model, hardly any join will be needed.</p>
    <p class="book-title--packt">The question "<em class="italic">why a star schema?</em>" is typically answered in the context of "<em class="italic">as opposed to a normalized, transactional schema.</em>" Indeed, business intelligence, with its need for aggregations on many, many rows of data, is a totally different workload to transaction processing, with its need for inserting or updating individual rows of data while guarding the consistency of the data. For analytics, a star schema-based model is an absolute necessity.</p>
    <p class="book-title--packt">Many people, however, translate this, in a rather purist way, to "<em class="italic">do not use a snowflake model.</em>" Or, put differently, each dimension table should be directly related to a fact table. While there may be reasons for this in a data warehouse that is queried directly for reporting, it cannot be stated generically for Power BI models. The technology of the Power BI model works far better with relationships and, on top of that, the compression of data is so strong that using a snowflake model does not need to be a problem. As a rule of thumb, a star schema is a good starting point when designing your model, but don't bother <a id="calibre_link-1280" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>spending a lot of effort to avoid having a snowflake model.</p>
    <p class="book-title--packt">Why this long exposition on star schemas versus snowflake schemas? This is because it is the primary indication of cluelessly applying traditional data warehouse ideas to Power BI. In our consultancy work, we regularly have to deal with IT departments doing this, and it takes a lot of time and effort to explain that, indeed, Power BI is fundamentally different. We deliberately use different terminology for some elements of a Power BI solution to underline the differences and to make things easier to understand for business users.</p>
    <p class="book-title--packt">In the next section, we discuss several ways in which suboptimal Power BI solutions appear from applying traditional RDBMS and data warehouse principles.</p>
    <h2 id="calibre_link-40" class="calibre8">RDBMS principles to avoid in Power BI models</h2>
    <p class="book-title--packt">In the<a id="calibre_link-1194" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> previous section, we warned against applying learnings from the RDBMS world to Power BI models mindlessly. Below, we discuss several specific examples.</p>
    <h3 id="calibre_link-41" class="calibre8">Interdependent dimensions</h3>
    <p class="book-title--packt">What is a <a id="calibre_link-1196" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>dimension? In data warehousing, a dimension is a table containing descriptive attributes about facts stored in a fact table. The name <em class="italic">dimension</em> is derived from the concept in mathematics and physics; here, a dimension is an independent parameter that describes an object, like height or width.</p>
    <p class="book-title--packt">This, as well as the term <em class="italic">multidimensional modeling</em> to describe the old way of doing analytics (before column store solutions existed), suggests that dimensions in a data warehouse are meant to be independent entities. We encounter a lot of data warehouse schemas, however, with dimensions that are closely related. For example, you may encounter a <code class="code-in-text--packt">Customer</code> dimension table as well as a Market <code class="code-in-text--packt">Segment</code> dimension table. If a customer can belong to multiple market segments, the dimensions are indeed independent; but in many organizations, a customer belongs to a single segment.</p>
    <p class="book-title--packt">This is not an issue in a data warehouse, but in a Power BI model it is. Imagine you have a Power BI report with slicers for market segment and customer. Your users will rightfully expect that when they select a segment, the customer slicer will only show the customers for the segment chosen. In other words, your model needs to propagate a filter on <code class="code-in-text--packt">Market Segment</code> to the <code class="code-in-text--packt">Customer</code> table, and vice versa. With a default one-to-many relationship with a single cross filter direction, this is not going to happen; the solution is to<a id="calibre_link-1197" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> enable both-ways cross filtering on the relationships, resulting in a model like the following:</p>
    <figure class="mediaobject"><img src="images/000136.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.14: Interdependent dimensions require both-ways cross filtering</p>
    <p class="book-title--packt">However, this is a severe case of bad modeling in Power BI, and you will find out why when you try to add a second fact table: it is impossible to do that while keeping all relationships active. A better design would be to cluster filter tables that belong together and let only one of them have a relationship with the fact table (with a single cross filter direction). If needed, the relationships between the filter tables in a cluster can be implemented with a double cross filter direction, as in <em class="italic">Figure 1.2.15</em>. </p>
    <p class="book-title--packt">A big advantage of <a id="calibre_link-1198" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this is that multiple key columns in the fact table can be eliminated.</p>
    <figure class="mediaobject"><img src="images/000156.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.15: Clustered filter tables</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">In this book, we use the name <em class="italic">filter table</em>, and not <em class="italic">dimension table</em>, for three reasons: first, to avoid the suggestion that we are doing traditional RDBMS-based modeling; second, because multiple filter tables may belong to a single cluster and thus are not independent; and third, to use a name that makes sense for the business user and better aligns with the core concept of filters in Power BI.</p>
    </div>
    <p class="book-title--packt">You could, of course, argue that the filter tables in a cluster could be combined into one large table, which would turn the model into a proper star schema. Indeed, you could, but you do not necessarily need to do this. Moreover, there are reasons to not do it: you can spend your time better by addressing business questions, you may have other fact tables with a different granularity needing to relate to one of the filter tables specifically (like a target per segment), and the entities may be more easily recognizable to business users than <a id="calibre_link-1570" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>when combined in a single large table.</p>
    <h3 id="calibre_link-42" class="calibre8">One fact table only</h3>
    <p class="book-title--packt">This one is<a id="calibre_link-1201" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> quite basic: sometimes, we meet people who heard about the star schema requirement and interpret that as "<em class="italic">you should have a single fact table.</em>" While this would solve the problem with many double cross filter relationships, it requires a lot of work creating that single fact table, and leads to a fact table with a lot of columns. There is no problem with having multiple fact tables in your model!</p>
    <h3 id="calibre_link-43" class="calibre8">Data warehouse as the single source of truth</h3>
    <p class="book-title--packt">From the <a id="calibre_link-1195" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>discussion above, it should be clear that there is no technical necessity for Power BI to have a (relational) data warehouse in place with a thoroughly designed database schema. As the data warehouse would only serve tables of data to Power BI models, you do not really need the <em class="italic">schema-first</em> architecture of a relational data warehouse. Indeed, you could work with a simpler <em class="italic">data-first</em> architecture like a data lake.</p>
    <p class="book-title--packt">In many situations, however, you will find that a data warehouse is available. This usually comes with the requirement that "<em class="italic">all business logic must be implemented in the data warehouse.</em>" From the point of view of Power BI, this is not the best approach.</p>
    <p class="book-title--packt">The main flaw in this policy is that a data warehouse has only one way of communicating with the outside world: in the form of data. A report typically contains data that is aggregated in either a basic or highly sophisticated way (the second part of this book is only about advanced ways of aggregating data). The fact is, many results needed in a report cannot be established by standard aggregations like a sum or average of values in a column. It is therefore impossible to implement all business logic in the data warehouse.</p>
    <p class="book-title--packt">Many data warehouse implementations at least aspire to implement as much business logic as possible. The problem here is, again, that the data warehouse can only communicate in the form of data. This leads to fact tables with many columns, each a specific business rule or aggregation. But what you do not want to have in a Power BI model is fact tables with many columns!</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Interestingly, there is a database-like technology that is capable of communicating both through data and through aggregation logic: the Power BI model!</p>
      <p class="book-title--packt">Since it is possible to connect to Power BI datasets in DirectQuery mode, it is now possible to use a Power BI model as the central hub for data <em class="italic">and</em> aggregations, and derive other models from it. In other words: if there can be a single <a id="calibre_link-1571" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>source of truth, it is probably a Power BI model.</p>
    </div>
    <h3 id="calibre_link-44" class="calibre8">Using many-to-many relationships</h3>
    <p class="book-title--packt">One thing you<a id="calibre_link-1199" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> should <a id="calibre_link-985" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>definitely avoid at all costs is creating a direct relationship between two fact tables. As fact tables seldom contain columns with unique values, this relationship will be of many-to-many cardinality. (If your fact table does contain a column with unique, or nearly unique values, you should ask yourself if your model needs this column.)</p>
    <p class="book-title--packt">Not only will such a relationship lead to unexpected results, as filter propagation is hard to track this way, but the model will struggle with performance as well. This is because there are probably far too many rows being related. The performance impact of a relationship is highly correlated with the number of unique values in the&nbsp;primary key, or <em class="italic">one</em> side of the relationship. Do not let this number become too big; we use a maximum of about 100,000 rows as a rule of thumb.</p>
    <p class="book-title--packt">Another, only slightly better use case for many-to-many relationships is to relate fact tables with filter tables that have a different granularity. For instance, if your model contains a <code class="code-in-text--packt">Product</code> table with a <code class="code-in-text--packt">Category</code> column that groups multiple products, sales facts are probably stored at the product level. Targets, or sales forecasts, may be&nbsp;given on the level of product category. Power BI allows for creating a many-to-many relationship between the target fact table and the <code class="code-in-text--packt">Category</code> column in the&nbsp;<code class="code-in-text--packt">Product</code> table:</p>
    <figure class="mediaobject"><img src="images/000177.png" alt="Diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.16: Using a many-to-many relationship</p>
    <p class="book-title--packt">While this <a id="calibre_link-1200" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>works<a id="calibre_link-986" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> without problems, we do prefer implementing this using an intermediate filter table containing categories as unique rows:</p>
    <figure class="mediaobject"><img src="images/000199.png" alt="Diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.2.17: Using an intermediate table</p>
    <p class="book-title--packt">By using an intermediate table, all structure is implemented through regular, one-to-many relationships that have consistent behavior and for which the DAX engine is optimized. One difference, for instance, is that many-to-many relationships do not cause a blank row to be added to the filter table when an unknown value is encountered; this can lead to unexpected results. After all, inconsistency in data is generally visible in the output of a Power BI model through blank labels, which are caused by <a id="calibre_link-1572" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>blank<a id="calibre_link-1573" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> rows. Without these blanks, inconsistencies remain hidden.</p>
    <p class="book-title--packt">The use of clusters of filter tables discussed before is a natural way to deal with granularity differences in fact tables using regular relationships.</p>
    <h1 id="calibre_link-45" class="title">Memory and performance considerations</h1>
    <p class="book-title--packt">The design<a id="calibre_link-1110" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of a Power BI model highly impacts<a id="calibre_link-1112" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> its size, and size is highly correlated with performance. In this section, we share some best practices to optimize the performance of your model, as a recapitulation of the topics discussed in this chapter. As a rule of thumb, smaller models with respect to size are faster. You can use the file size of the Power BI model as an indication; you can also get a more detailed view of size and performance by using specific community-driven tools like DAX Studio. </p>
    <p class="book-title--packt">Keep in mind the following guidelines while designing your Power BI model:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Having fewer columns is better</strong>. The Power BI model achieves a high compression rate of data due to the columnar database concept. However, it still needs to keep track of which values belong together in a row. The more columns a table has, the more overhead the model needs to know what goes where. So, keep the number of columns per table as small as possible. <p class="bullet1">What we see a lot of people do is just load all columns of a source table into the Power BI model, out of convenience (or laziness, you could say). Take into account that it's easier to add a column when you need it than to find out which columns aren't being used and remove them later on. A model never shrinks organically!</p>
      </li>
      <li class="bullet"><strong class="screentext">Use the right data types</strong>. Internally, the Power BI model optimizes data storage at the level of bits. All optimizations of the columnar database are based on this. It means that any data type that is not a whole number has to be treated differently using a dictionary of values. This doesn't mean that only the Whole Number data type is efficient to use; multiple data types are treated as whole numbers internally, like Date, Fixed Decimal Number, and True/False.<p class="bullet1">The data type consideration also applies to relationships, so use one of the whole number types for relationships when possible.</p>
      </li>
      <li class="bullet"><strong class="screentext">Having many rows is no issue, but watch out for many values</strong>. Again, due to the columnar database concept, the Power BI model can store a lot of rows efficiently. It will determine the most optimal way to store the values in a column, but more distinct values need more space. The number of unique values in a column is by far the most important thing to keep an eye on! <p class="bullet1">Often, an obvious way to save memory is to remove unique keys in fact tables. Many transactional systems provide a unique identifier for each transaction and, when loaded, these are among the most "expensive" columns in a Power BI model. We have had cases where simply removing one unique column from the largest fact table reduced the size of the model by over 90%!</p>
        <p class="bullet1">As with data types, the number of distinct values has an impact on relationships as well. The number of primary key values of a relationship should be relatively small. If you have a relationship with hundreds of thousands or even millions of unique key values, you should be looking for a different structure in your model.</p>
      </li>
      <li class="bullet"><strong class="screentext">Avoid outliers</strong>. In many source systems, developers use special values for denoting<a id="calibre_link-1113" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the<a id="calibre_link-1111" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> planned absence of real data, or other reasons. The special values are often outliers to ensure they are not confused with real data; like "December 31, 9999". These outliers can cause the Power BI model to store a column using a dictionary as with the less efficient data types, even if the values themselves are whole number values. This is because when storing values as whole numbers, the model has to account for all possible values between the smallest and the largest value in the column, and it may be more efficient to go for a dictionary instead.<p class="bullet1">To avoid this, leave these values blank or choose a special value that is close to the actual values.</p>
      </li>
      <li class="bullet"><strong class="screentext">Do you really need all that history?</strong> An obvious way to have a smaller model is to load less data. We have encountered many cases in which a source system keeps a long history of data. This is especially true when using a data warehouse as a data source for the Power BI model. You may load sales transactions from the year 2000 onward, but ask yourself: who is going to analyze the sales data from before 2010 or 2015? It may be better to have a separate model for the few archeologists who want to carve out wisdom from the past, and have a richer, more elaborate model for daily use containing only a few years of history.</li>
      <li class="bullet"><strong class="screentext">In some cases: split columns</strong>. In extreme situations, it may be useful to split columns to end up with two columns, each having fewer distinct values. This could happen with composite keys, for example, a product code consisting of a category code and a sequence number: "A82.019". Separate category code and sequence number columns would have far fewer distinct values each and may be stored more efficiently. This approach has obvious drawbacks in more complex handling and, also, the composite column may be needed for a relationship; so only do this when you really, really need it.</li>
    </ul>
    <p class="book-title--packt">Many of these considerations have more impact when the data volume of your model gets bigger. But <a id="calibre_link-1574" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>it is good to keep them in<a id="calibre_link-1575" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> mind even with a small model; after all, it is harder to change things when problems arise. </p>
    <h1 id="calibre_link-46" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, we have discussed the foundational concepts of the Power BI model. You have learned what makes a Power BI model fundamentally different from other data management products (the in-memory column store) and what the consequences are for what an optimal design looks like.</p>
    <p class="book-title--packt">A good Power BI model has an effective structure with fact tables, filter tables, and relationships between them. Making good design choices when it comes to structure and data types, as well as carefully considering what your data looks like from the perspective of granularity, unique values, and value distribution, leads to a model that performs well. And perhaps more importantly, such a model forms a good basis for rich calculations in DAX.</p>
    <p class="book-title--packt">In the next chapter, we will look at the ways DAX can be used in Power BI models. </p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-259">
<div id="calibre_link-1576" class="calibre2">
<div id="calibre_link-1577" class="calibre3"><div id="calibre_link-1578" class="calibre4">
    <h1 class="chapternumber">1.3</h1>
    <h1 id="calibre_link-47" class="title">Using DAX</h1>
    <p class="book-title--packt">The real power of Power BI models is in calculations using the DAX language. While many Power BI users focus on the model and try to avoid DAX entirely, anything that goes beyond simple, basic aggregations of data requires DAX calculations. And you will surely encounter the need for more sophisticated calculations in Power BI sooner rather than later. The typical way things go is that the first well-designed Power BI report leads to more and ever more complicated questions to ask about your data.</p>
    <p class="book-title--packt"><em class="italic">Part 2</em> of this book aims to give you inspiration on what can be achieved using DAX and how to approach a business problem with DAX. Before we dive into <em class="italic">Part 2</em>'s scenarios, we still have some fundamentals to cover. In this chapter, we briefly touch upon the different uses of DAX in Power BI. These uses are:</p>
    <ul class="calibre9">
      <li class="bullet">Calculated columns</li>
      <li class="bullet">Calculated tables</li>
      <li class="bullet">Measures</li>
      <li class="bullet">Security filters</li>
      <li class="bullet">DAX queries</li>
    </ul>
    <p class="book-title--packt">We also discuss how to create date tables with DAX. The chapter concludes with some general best practices for the use of DAX. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">A PBIX file with examples accompanies this chapter. The file, <code class="code-in-text--packt">1.3 Using DAX.pbix</code>, can be downloaded from this link: <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter1.3" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter1.3</span></a>.</p>
    </div>
    <h1 id="calibre_link-48" class="title">Calculated columns</h1>
    <p class="book-title--packt">A <strong class="screentext">calculated column</strong> is a column of data that is added to a table in the Power BI model by performing <a id="calibre_link-411" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a DAX calculation. A basic example is to calculate the value of a sales transaction by multiplying the number of products sold by the price per product (note that column names are written between square brackets in DAX):</p>
    <pre class="programlisting"><code class="hljs-code">    Amount = [Quantity] * [Price]
</code></pre>
    <p class="book-title--packt">Below is the resulting calculated column:</p>
    <figure class="mediaobject"><img src="images/000000.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.1: A calculated column</p>
    <p class="book-title--packt">Calculated columns are a straightforward way to add some intelligence to the Power BI model. If you come from an Excel background, this probably has the most natural feel to it, as putting formulas in columns is the way most Excel users have learned to work in Excel. But our strong recommendation is: <em class="italic">DO NOT</em> use calculated columns, unless you have very good reasons to do so. There are a couple of reasons why:</p>
    <ul class="calibre9">
      <li class="bullet">A calculated column creates new data, which takes up space in the model. As was discussed in the previous chapter, more columns make the model larger and slower.</li>
      <li class="bullet">If, for whatever reason, you need to delete a table from your model and add it again in some changed way (and you will definitely find yourself in this situation at some point), you will lose all calculated columns and will have to rebuild them. </li>
      <li class="bullet">The columns used for a calculation, like the <code class="code-in-text--packt">[Quantity]</code> and <code class="code-in-text--packt">[Price]</code> columns in the preceding example, need to stay in the model but would possibly have no other use. In the example, ask yourself what you would do with the <code class="code-in-text--packt">[Price]</code> column. Compute the average price per product, perhaps? The answer is no: the average price should be weighted by the number of products sold, so a straightforward average of the <code class="code-in-text--packt">[Price]</code> column would be incorrect. Instead, you would divide the total sales amount by the total number of products sold, and you don't need the <code class="code-in-text--packt">[Price]</code> column for that.</li>
      <li class="bullet">The results of the calculations in a calculated column are static: they are computed only when defining the column and when the Power BI model is refreshed. This is in opposition to the dynamic nature of DAX and Power BI reports in general.</li>
    </ul>
    <p class="book-title--packt">The issue with calculated columns is that, most often, the things you do with them fall into the category <a id="calibre_link-412" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of data preparation, or the <em class="italic">Prepare</em> layer in the Five-Layer model discussed in <em class="italic">Chapter 1.1</em>, <em class="italic">DAX in Business Intelligence</em>. There are better tools for doing data preparation than the Power BI model, like Power Query. An optimal model would contain the columns <code class="code-in-text--packt">[Quantity]</code> and <code class="code-in-text--packt">[Amount]</code> in a sales transaction table, not <code class="code-in-text--packt">[Price]</code>.</p>
    <p class="book-title--packt">There are some exceptions to the rule of not using calculated columns, which you may encounter when you work on more advanced scenarios with DAX:</p>
    <ul class="calibre9">
      <li class="bullet">Sometimes, when creating a complex DAX calculation, you will find that part of it is in fact static, in that it could indeed be implemented as a calculated column. If this is a complex calculation that needs to be done over and over again, you may gain significant performance by implementing it as a calculated column. However, you should first consider creating the column in the <em class="italic">Prepare</em> layer!</li>
      <li class="bullet">Some calculations that should result in a model column are very hard to do in <em class="italic">Prepare</em> with, for instance, Power Query, while being straightforward using an appropriate DAX function. In this case, you would save on both development time and data refresh performance by implementing these calculations as a calculated column. This situation typically occurs when the column values needed are the result of some sophisticated aggregation. However, if you run into this situation, first ask yourself if the problem can be solved without a calculated column!</li>
    </ul>
    <p class="book-title--packt">In short, you should not use a calculated column unless you have very good reasons to, as an exception.</p>
    <h1 id="calibre_link-49" class="title">Calculated tables</h1>
    <p class="book-title--packt"><strong class="screentext">Calculated tables</strong> are comparable to calculated columns: they add data to a Power BI model, but now in the <a id="calibre_link-414" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>form of a complete table. To create a calculated table, you most often need special DAX table functions. You will encounter many DAX table functions in <em class="italic">Part 2</em>; for a general introduction to table functions, see <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>.</p>
    <p class="book-title--packt">To create a simple calculated table in a Power BI model, you can use the table constructor. The expression below, consisting only of a list of values between braces, creates a table with one column:</p>
    <pre class="programlisting"><code class="hljs-code">Example = {1, 2, 3}
</code></pre>
    <p class="book-title--packt">The result of this formula is a table named <code class="code-in-text--packt">Example</code>, with a single column of <code class="code-in-text--packt">[Value]</code>: </p>
    <figure class="mediaobject"><img src="images/000018.png" alt="Graphical user interface, application, Word  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.2: A calculated table made with the table constructor</p>
    <p class="book-title--packt">Note that the table constructor does not give much control over the table that is created. The column is named <code class="code-in-text--packt">Value</code> and the data type of the <code class="code-in-text--packt">Value</code> column is derived from the values provided (which is, of course, fairly accurate most of the time). When the values provided are different types of data, a data type is chosen that can store all the values. For example:</p>
    <pre class="programlisting"><code class="hljs-code">Example2 = {1, 2, "3"}
</code></pre>
    <p class="book-title--packt">This formula produces a table in which the <code class="code-in-text--packt">Value</code> column has the Text data type.</p>
    <p class="book-title--packt">The table constructor does allow the creation of tables with multiple columns by providing lists of values by row, between parentheses:</p>
    <pre class="programlisting"><code class="hljs-code">Example3 = { (1, "Red"), (2, "Green"), (3, "Blue") }
</code></pre>
    <p class="book-title--packt">This is the resulting table:</p>
    <figure class="mediaobject"><img src="images/000038.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.3: The table constructor with two columns</p>
    <p class="book-title--packt">A table with properly named <a id="calibre_link-1579" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>columns and tightly controlled data types can be obtained using the <code class="code-in-text--packt">DATATABLE</code> function. The arguments to this function are a series of pairs of column names <a id="calibre_link-415" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and data types, and a list of values for the rows of the table. <code class="code-in-text--packt">DATATABLE</code> has two quirks: first, the data types have different names than the ones used in the Power BI model (<code class="code-in-text--packt">INTEGER</code> for whole number, <code class="code-in-text--packt">STRING</code> for text, and so on), and the values in one row must be contained in braces instead of parentheses like in the table constructor. The table in <em class="italic">Figure 1.3.3</em>, but with nicer names, can be constructed using <code class="code-in-text--packt">DATATABLE</code> with the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">Example4 =
DATATABLE(
    "Number", INTEGER,
    "Color", STRING,
    {
        {1, "Red"},
        {2, "Green"},
        {3, "Blue"}
    }
)
</code></pre>
    <p class="book-title--packt">Calculated tables are often used to create <code class="code-in-text--packt">Date</code> or <code class="code-in-text--packt">Calendar</code> tables in a Power BI model. These are discussed later in this chapter.</p>
    <p class="book-title--packt">Some of the issues with calculated columns also apply to calculated tables: a calculated table increases the Power BI model's size, and you are probably doing something that is really data <a id="calibre_link-1580" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>preparation. However, contrary to a calculated column, a calculated table is not tightly coupled to other elements of the model. When you remove columns or tables that the calculated table uses to compute, you will get an error; but adding the tables or columns again will solve this.</p>
    <p class="book-title--packt">In general, our recommendation is to not use calculated tables when they can be taken care of in the <em class="italic">Prepare</em> layer of the Five-Layer model. When you don't have access to <em class="italic">Prepare</em> capabilities, for example, when you are working with a centrally-managed data warehouse, you can use calculated tables for tables that are not offered by the data warehouse, or that would not be practical to store in the data warehouse. </p>
    <h1 id="calibre_link-50" class="title">Measures</h1>
    <p class="book-title--packt"><strong class="screentext">Measures</strong>, or in some earlier model versions, <strong class="screentext">calculated fields</strong>, are without a doubt the most powerful <a id="calibre_link-988" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>element of Power BI <a id="calibre_link-413" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>models. In fact, most of the work we do on Power BI models comes down to designing and implementing DAX measures.</p>
    <p class="book-title--packt">When using a numeric column from a fact table in a Power BI report, the column values will be aggregated. The basic aggregations available are <em class="italic">sum</em>, <em class="italic">average</em>, <em class="italic">minimum</em>, <em class="italic">maximum</em>, <em class="italic">count</em>, <em class="italic">distinct count</em>, and some statistical aggregations like <em class="italic">standard deviation</em>, <em class="italic">variance</em>, and <em class="italic">median</em>. The basic aggregations differ depending on the data type; for a <code class="code-in-text--packt">Date</code> column, for instance, you can choose <em class="italic">earliest</em> and <em class="italic">latest</em>, <em class="italic">count</em>, and <em class="italic">distinct count</em> only. When you use columns this way, the Power BI model creates an <strong class="screentext">implicit measure</strong> in the background: an aggregation function that returns the selected aggregation of the values in the column.</p>
    <p class="book-title--packt">In real life, many of the required insights come down to aggregations that cannot be expressed in terms of basic aggregations. Many people, both Excel users and data warehouse developers, build (calculated) columns to try to create data that will provide the results they need, while still only needing one of the basic aggregations. For example, in both Excel models and data warehouses, you may encounter an indicator that denotes whether or not a row of data falls in the "current year-to-date" category. Again, this is a static solution that will not let you, say, retrieve the year-to-date results of two months ago.</p>
    <p class="book-title--packt">DAX allows you to define your own <em class="italic">custom aggregations</em> by writing DAX formulas to create <strong class="screentext">explicit measures</strong>. As an example, the weighted average price discussed in the previous calculated <a id="calibre_link-731" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>columns section can be implemented as a DAX measure with the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">Average Price = SUM(fSales[Amount]) / SUM(fSales[Quantity])
</code></pre>
    <p class="book-title--packt">In this formula, the assumption is made that the table with sales transactions is called <code class="code-in-text--packt">fSales</code>. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The division operator <code class="code-in-text--packt">/</code> is normally replaced by another DAX function, <code class="code-in-text--packt">DIVIDE</code>:</p>
      <pre class="programlisting"><code class="hljs-code">Average Price = 
DIVIDE(
    SUM(fSales[Amount]),
    SUM(fSales[Quantity])
)
</code></pre>
      <p class="book-title--packt">The advantage of <code class="code-in-text--packt">DIVIDE</code> is that division by zero is handled elegantly. This is a simple example of the added value of DAX measures using appropriate DAX functions over basic aggregation of columns.</p>
    </div>
    <p class="book-title--packt">DAX measures should be your default option for adding intelligence to your Power BI model. A measure <a id="calibre_link-676" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>does not add data to the model and therefore keeps the model lean and fast. However, as the calculation is done on demand when a user views a report, it is important to put effort into <a id="calibre_link-677" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>creating the most efficient calculations. In <em class="italic">Part 2</em>, we focus not only on how to solve business scenarios with DAX measures, but also on how to create efficient DAX measures.</p>
    <p class="book-title--packt">For working with DAX in general, but with DAX measures in particular, there are some fundamental concepts that are critical to understand. Among these are the concepts of DAX context, DAX filtering through context transformation, and DAX table functions. These concepts are discussed in <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>.</p>
    <h1 id="calibre_link-51" class="title">DAX security filters</h1>
    <p class="book-title--packt">DAX can also be used for implementing security within a Power BI model. When a user retrieves a report, they <a id="calibre_link-685" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will be able to see all results provided by the model through that report. In many cases, there is a need to restrict what the user sees, based on their role or identity. For instance, consider the DAX <em class="italic">security expression</em> below:</p>
    <pre class="programlisting"><code class="hljs-code">Customer[Region] = "Europe"
</code></pre>
    <p class="book-title--packt">When set for a specific security role, this DAX security filter will cause users in that role to only see customers in the Europe region, together with data related to those customers.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.1</em> further introduces security with DAX.</p>
    <h1 id="calibre_link-52" class="title">DAX queries</h1>
    <p class="book-title--packt">The last way to use DAX is as a query language. You will not need this when working with Power BI visual reports, but classic, RDBMS-oriented reporting tools mostly rely on retrieving custom <a id="calibre_link-678" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>datasets from databases to render reports. A common data source for these is a data warehouse or other database; but a Power BI model in the form of a published Power BI dataset can be used in this way as well. Note that at the time of writing, you need to have a Power BI Premium license, either per capacity or per user, to do this.</p>
    <p class="book-title--packt">A specific use case for DAX queries is in Power BI paginated reports. These are developed using the Power BI Report Builder (as opposed to Power BI Desktop, which is the tool for all other use cases) and can connect to a published Power BI model. </p>
    <p class="book-title--packt">When making the connection, you need to provide a DAX query to retrieve a set of data from the Power BI model:</p>
    <figure class="mediaobject"><img src="images/000060.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.4: Writing a DAX query in the Power BI Report Builder</p>
    <p class="book-title--packt">If you use Power <a id="calibre_link-679" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Pivot in Excel, you can use DAX queries as a way to retrieve data from the Power Pivot model, as an alternative to the default pivot table output.</p>
    <p class="book-title--packt">Like calculated tables, DAX queries need a table expression. In this case, the function <code class="code-in-text--packt">EVALUATE</code> is used to, well, evaluate the table expression and return the table. The expression below <a id="calibre_link-1581" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>returns the complete <code class="code-in-text--packt">Customer</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">EVALUATE( Customer )
</code></pre>
    <p class="book-title--packt">In the table expression, all DAX functions can be used, including DAX measures that can be used to retrieve <a id="calibre_link-1582" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>specific aggregated results from the model. The only restriction is that the end result of the formula must be a table.</p>
    <h1 id="calibre_link-53" class="title">Date tables</h1>
    <p class="book-title--packt">Most, if not all, Power BI models contain data that is related to dates. A <strong class="screentext">date table</strong> (or calendar table, or whatever <a id="calibre_link-597" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>you like to call it) is therefore a common ingredient of a Power BI model. A date table has a special place in the model, because of DAX time intelligence functions (more on these in <em class="italic">Chapter 1.4</em>,<em class="italic"> </em><em class="italic">Context and Filtering</em>). </p>
    <p class="book-title--packt">A date table must have one row per day for an uninterrupted period of time. Typically, this period should be large enough to cover all the rows in your fact tables. It is advisable to start and end the date table on year start and end, respectively. The date table must have a date column, being the unique key of the table (you may choose the name of this column yourself). Other columns in the table are attributes for each day, like year, month, quarter, weekday, and so on.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Power BI models have an <strong class="screentext">Auto date/time</strong> feature which, when turned on, creates a hidden date <a id="calibre_link-1114" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table for each column in the model that has the date or date/time data type, supplemented with a year/month hierarchy.</p>
      <p class="book-title--packt">If you have not yet done so, turn off this feature now! It is the cause of bloated models and performance problems. The value of these hidden tables, although convenient for users who do not want to bother about modeling, is non-existent for any experienced user. A Power BI report that delivers consistent results with a single selection of, say, year, needs a proper date table anyway.</p>
      <p class="book-title--packt">Better still, in the Power BI Desktop options, turn off the <strong class="screentext">Auto date/time for new files</strong> option to get rid of these tables forever. </p>
    </div>
    <p class="book-title--packt">Your table containing dates can be formally marked as such using the <strong class="screentext">Mark as date table </strong>option. With this, the column containing dates is marked as the official date column: </p>
    <figure class="mediaobject"><img src="images/000081.png" alt="Graphical user interface, text, application, email  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.5: Marking a table as the date table</p>
    <p class="book-title--packt">In <em class="italic">Chapter 1.4</em>, you will learn <a id="calibre_link-598" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>about the effects of marking a table as a date table when we discuss time intelligence functions.</p>
    <h2 id="calibre_link-54" class="calibre8">Creating a date table</h2>
    <p class="book-title--packt">Technically, a date table is not different from other tables. You may have calendar data available somewhere; in this case, you can just import the date into the Power BI model. There are also ways <a id="calibre_link-599" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to create a date table just from some input parameters (for instance, which years the table should span) in <a id="calibre_link-1583" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Power Query, which we will not cover in this book.</p>
    <p class="book-title--packt">Here, we focus on how to create a date <a id="calibre_link-470" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table as a calculated table based on a DAX formula. There are two DAX functions available that are specifically aimed at doing this: <code class="code-in-text--packt">CALENDAR</code> and <code class="code-in-text--packt">CALENDARAUTO</code>. Both functions return a one-column table containing dates.</p>
    <p class="book-title--packt"><code class="code-in-text--packt">CALENDARAUTO</code> explores the whole model and finds the first and the last dates from any column with the Date <a id="calibre_link-469" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>or Datetime data type (calculated columns and columns in calculated tables excluded). The range of dates starts with the beginning of the year of the first date found and continues until the end of the year of the last date found. While this sounds convenient, you have to realize that when a model contains, for instance, birth dates or strange outliers like December 31, 2199, a huge table spanning decades or even centuries will be created.</p>
    <p class="book-title--packt">The better option <a id="calibre_link-600" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is therefore <code class="code-in-text--packt">CALENDAR</code>. This function takes two arguments, the first <a id="calibre_link-471" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and last dates of the table to be created:</p>
    <pre class="programlisting"><code class="hljs-code">CALENDAR(
    DATE(2021, 1, 1),
    DATE(2023, 12, 31)
)
</code></pre>
    <p class="book-title--packt">As the result of these functions is a single <code class="code-in-text--packt">Date</code> column, you will need to add more columns to create a proper date table. This can be done with calculated columns, but you can do it in one <a id="calibre_link-1584" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>formula using the <code class="code-in-text--packt">ADDCOLUMNS</code> function that does just that, adding columns:</p>
    <pre class="programlisting"><code class="hljs-code">Date =
ADDCOLUMNS(
    CALENDAR(
        DATE(2021, 1, 1),
        DATE(2023, 12, 31)
    ),
    "Year", YEAR([Date]),
    "Month", FORMAT([Date], "mmmm", "En-US"),
    "MonthNr", MONTH([Date]),
    "Year/Month", FORMAT([Date], "yyyy-mm")
)
</code></pre>
    <p class="book-title--packt">In the formula above, <code class="code-in-text--packt">ADDCOLUMNS</code> takes the result of the <code class="code-in-text--packt">CALENDAR</code> function and adds columns to it. You have <a id="calibre_link-1585" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to provide both a name for each column and an expression that provides the corresponding value. The formula provides a nice example of the <a id="calibre_link-1586" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use of the <code class="code-in-text--packt">FORMAT</code> function, which can be used to apply a variety of formats based on, in this case, a date value, while optionally providing the locale to be used as well. </p>
    <p class="book-title--packt">The result of the formula is below:</p>
    <figure class="mediaobject"><img src="images/000102.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.6: A date table created with a DAX formula</p>
    <p class="book-title--packt">In a real-world model, the start and end dates of the date table need to be dynamic to reflect the loading <a id="calibre_link-601" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of new data. You could, for instance, find the latest date in the <code class="code-in-text--packt">fSales</code> table using <code class="code-in-text--packt">MAX(fSales[OrderDate])</code> and use that value as the end date of the date table. You could also find the last day of the year of the last order date in the fact table using DAX. We do not elaborate on this any further here.</p>
    <h1 id="calibre_link-55" class="title">Best practices in DAX</h1>
    <p class="book-title--packt">When working with DAX, you will benefit from <a id="calibre_link-472" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>following some best practices. Applying these will help you <a id="calibre_link-606" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>create fast models, make it easier to maintain your models in the long term, and allow you to better support others who create Power BI reports or other output from your models.</p>
    <h2 id="calibre_link-56" class="calibre8">Think in terms of DAX measures primarily</h2>
    <p class="book-title--packt">If we did not make ourselves clear enough above: your main DAX tool should be DAX measures. These are highly dynamic, do not make the model larger, and there is no calculation you cannot do through a measure. </p>
    <p class="book-title--packt">As a rule of thumb, calculated columns and calculated tables are a no-go, until you have very good arguments for using them!</p>
    <h2 id="calibre_link-57" class="calibre8">Build explicit measures</h2>
    <p class="book-title--packt">We recommend <a id="calibre_link-623" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>creating explicit DAX measures instead of using numeric columns from (fact) tables directly in visual reports. There are several reasons for this:</p>
    <ul class="calibre9">
      <li class="bullet">A measure is created by the Power BI model anyway when you use a column in a report, and it is easy to do this yourself.</li>
      <li class="bullet">An explicit measure can be given its own clear name, like <code class="code-in-text--packt">Total sales</code> instead of <code class="code-in-text--packt">Amount</code> or, in Power Pivot in Excel, <code class="code-in-text--packt">Sum of Amount</code>.</li>
      <li class="bullet">The measure can also be given its own output format that is applied everywhere the measure is used. For instance, you may choose to show <code class="code-in-text--packt">Total sales</code> without a <a id="calibre_link-1587" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>currency sign, without decimals, but with thousands separators. This can be a different format than the one derived from the data type.</li>
      <li class="bullet">Explicit measures can be used as building blocks for more complex calculations (see below). Implicit measures are either not available, or are not convenient to use because they cannot be changed.</li>
    </ul>
    <p class="book-title--packt">Not using numeric columns from fact tables directly has the added benefit that you do not risk using incorrect aggregations. As the <code class="code-in-text--packt">Average Price</code> measure discussed earlier shows, it is easy to make mistakes just by adding a column to a visual.</p>
    <h2 id="calibre_link-58" class="calibre8">Use base measures as building blocks</h2>
    <p class="book-title--packt">In a DAX formula, measures can be called in order for the results of those measures to be used in <a id="calibre_link-622" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the calculation. Building your set of DAX measures using basic measures (the simplest aggregations of numeric columns in fact tables) as building blocks helps to gradually create more complex calculations. </p>
    <p class="book-title--packt">Using base measures saves you from having to think about how to calculate basic results over and over again. We see many people doing this. Moreover, base measures allow for easily adapting business logic. More often than not, some additional business logic shows up during a later stage of developing a Power BI solution. For instance, at first you may be told that "<em class="italic">sales is the sum of all invoice amounts</em>." But when the first results of the Power BI model become visible, you will hear "<em class="italic">oh wait, invoices of type X do not count in sales and should be excluded</em>." With a base measure, all you would have to do is exclude type X invoices in the base measure's formula. Without this, you would need to go over all your sales-related measures to&nbsp;redo the logic.</p>
    <h2 id="calibre_link-59" class="calibre8">Hide model elements </h2>
    <p class="book-title--packt">You may design a Power BI model thinking that you are the only one creating the reports as well. But in <a id="calibre_link-627" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>practice, other people may start to use your model for building their own reports. For both them and you, it is good to hide elements of the model that would obscure the useful tables, columns, and measures:</p>
    <ul class="calibre9">
      <li class="bullet">Foreign key columns of a relationship should be hidden: the same values are available as a primary key, which will correctly filter the other side.</li>
      <li class="bullet">Technical (key) columns with no use for reporting should be hidden.</li>
      <li class="bullet">We recommend hiding the fact tables: all foreign key columns should be hidden, and numeric columns should not be used directly but through explicit measures. You may <a id="calibre_link-1588" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have other columns in your fact tables; consider moving them to an appropriate filter table or removing them completely. (Some columns in a fact table may only be used to filter without being exposed to a user; they can stay in the fact table.)</li>
      <li class="bullet">DAX measures that are only used as intermediate calculations for more complex DAX measures should be hidden.</li>
    </ul>
    <p class="book-title--packt">Strategically hiding elements of the Power BI model will avoid confusion and reduce the number of questions that you, as the model designer, will get because "<em class="italic">the model doesn't work</em>."</p>
    <h2 id="calibre_link-60" class="calibre8">Do not mix data and measures &ndash; use measure tables instead</h2>
    <p class="book-title--packt">A DAX measure always has a <strong class="screentext">home table</strong>, which is the table under which the measure is shown to the <a id="calibre_link-624" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>model designer. More importantly, it is where the report designer sees the measure in the model's <strong class="screentext">Fields</strong> pane when creating a Power BI report. We see many people placing measures under the fact table that contains the column being aggregated. While this is doable for simple, straightforward measures, like basic aggregations, we advise against this practice for the following reasons:</p>
    <ul class="calibre9">
      <li class="bullet">More sophisticated measures will aggregate columns from different tables, creating ambiguity around which table is the correct home table.</li>
      <li class="bullet">More importantly, as with calculated columns, if you ever need to delete a table and recreate it, you will lose all the measures under that table.</li>
    </ul>
    <p class="book-title--packt">What we do recommend is to store all measures in one or more dedicated <strong class="screentext">measure tables</strong>. These are tables that do not contain data, but only host measures. A measure table is one of <a id="calibre_link-989" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the exceptions to the "no calculated tables" rule. The simplest way to create a measure table is as a calculated table with the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">Results = ROW("ZZ", "OK")
</code></pre>
    <p class="book-title--packt">This creates a table, called <code class="code-in-text--packt">Results</code>, containing one column, <code class="code-in-text--packt">ZZ</code>, with one row of data. The value in the <code class="code-in-text--packt">ZZ</code> column in that single row is the text <code class="code-in-text--packt">"OK"</code>. The single column is needed, as a <a id="calibre_link-625" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table without at least one column is not a table; but when you hide that column, Power BI will recognize this as a measure table and place it at the top of the <strong class="screentext">Fields</strong> pane. This makes measures easy to find. The column is called <code class="code-in-text--packt">ZZ</code> to have it appear at the bottom of the list of measures in the table. This column, and the value in it, are never used, so you can replace <code class="code-in-text--packt">"OK"</code> with anything you like. Below is the result:</p>
    <figure class="mediaobject"> <img src="images/000124.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.7: A measure table in Power BI Desktop's Data view (left) and Report view (right)</p>
    <p class="book-title--packt">You can create a measure table in Power Query as well, for instance, through the <strong class="screentext">Enter Data</strong> option. This works the same way: hide the data column and add a measure to have the table move to the top of the <strong class="screentext">Fields</strong> pane. </p>
    <p class="book-title--packt">At the time of writing, though, there is a minor difference in the icon used for the measure table: when the table is imported through Power Query, a specific measure table icon is used, but when you create it as a calculated table, the generic icon for calculated tables is used:</p>
    <figure class="mediaobject"><img src="images/000144.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.3.8: Calculated (top) and imported (bottom) measure tables</p>
    <p class="book-title--packt">For complex models, you can use display folders to group measures. You can even decide to have <a id="calibre_link-626" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>multiple measure tables. For example, we have sometimes used a separate measure table for all basic measures that only serve as building blocks for higher-level calculations. By doing this, all building block measures can be hidden or made visible at once (you only need to hide the <code class="code-in-text--packt">ZZ</code> column by hand).</p>
    <h2 id="calibre_link-61" class="calibre8">Table types</h2>
    <p class="book-title--packt">It is advisable to make a<a id="calibre_link-628" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> clear distinction between the types of tables we have<a id="calibre_link-1349" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> discussed in this and the previous chapter. In addition to the three types already discussed, there is yet another table type, the <em class="italic">helper table</em>:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Fact tables</strong> contain main <a id="calibre_link-1351" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>data to aggregate, but no columns used <a id="calibre_link-738" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in reports, and are hidden.</li>
      <li class="bullet"><strong class="screentext">Filter tables</strong> (or dimension tables, if you will) contain <a id="calibre_link-1352" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>all attributes <a id="calibre_link-799" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on which to filter results from the model.</li>
      <li class="bullet"><strong class="screentext">Measure tables</strong> contain <a id="calibre_link-1354" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>no data, but only DAX measures, and <a id="calibre_link-990" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are found at the top of the field list.</li>
      <li class="bullet"><strong class="screentext">Helper tables</strong> are small tables used <a id="calibre_link-878" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to drive specific report behavior, like the selection of the <a id="calibre_link-1353" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>time period reported. You will learn more about helper tables in <em class="italic">Chapter 2.2</em>, <em class="italic">Dynamically Changing Visualizations</em>.</li>
    </ul>
    <p class="book-title--packt">You don't need to distinguish between these table types by giving them specific names. We are not a fan, for instance, of adding a <code class="code-in-text--packt">dim</code> prefix to a filter table name: <code class="code-in-text--packt">dimCustomer</code>, <code class="code-in-text--packt">dimCalendar</code>, and so on. This is not very friendly to users of your model, who are left to wonder what <code class="code-in-text--packt">dim</code> could mean. You should present elements of the Power BI model in a <a id="calibre_link-1350" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>way that speaks for itself as much as possible. Hiding fact tables, using measure tables, and giving filter tables descriptive names creates a situation <a id="calibre_link-629" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>where the <strong class="screentext">Fields</strong> pane contains available (calculated) results at the top, and all attributes to filter those results below, nicely grouped into logical sets (that you as the model designer know to be tables).</p>
    <h1 id="calibre_link-62" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, you have seen the different uses of DAX in Power BI models: calculated columns, calculated tables, measures, security rules, and queries. The main takeaway is that DAX measures are (or should be) the primary way of generating valuable results from a model, and indeed, for the majority of the remainder of this book we will focus on DAX measures. We have given you some best practices for working with DAX: avoid calculated columns, use explicit DAX measures, create simple DAX measures and use these as building blocks for more advanced calculations, use measure tables, and hide elements of a model that could confuse the report designer (even if that is yourself).</p>
    <p class="book-title--packt">The next chapter deals with probably the most important concepts to understand when working with DAX: context and filtering. After that, we will be ready to explore advanced DAX business cases in <em class="italic">Part 2</em>.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-261">
<div id="calibre_link-1589" class="calibre2">
<div id="calibre_link-1590" class="calibre3"><div id="calibre_link-1591" class="calibre4">
    <h1 class="chapternumber">1.4</h1>
    <h1 id="calibre_link-63" class="title">Context and Filtering</h1>
    <p class="book-title--packt">The single most important concept to understand when writing DAX calculations is <strong class="screentext">context</strong>. Context is what separates DAX, as a dynamic analysis language, from Excel functions or SQL queries &ndash; or Power Query scripts, for that matter. While all of these only return different results when the data changes (with some exceptions like when using parameters), a single DAX formula can provide many different results depending on where and how you use it: the context.</p>
    <p class="book-title--packt">DAX context is also the key to achieving advanced results with DAX. After you have overcome typical beginner's mistakes, like not knowing what DAX functions to use, incorrect syntax, or forgetting parentheses, issues with context are the most common problem when working with DAX. We will even go as far as to state:</p>
    <blockquote class="packt_quote pcalibre7">Every problem in DAX comes from context, and every solution is found by closely examining context.</blockquote>
    <p class="book-title--packt">This statement is seldom negated!</p>
    <p class="book-title--packt">In this chapter, we discuss foundational topics surrounding context that are a necessity for understanding all the content in <em class="italic">Part 2</em> of this book. This is what this chapter covers:</p>
    <ul class="calibre9">
      <li class="bullet">Introduction to DAX context</li>
      <li class="bullet">DAX filtering: using <code class="code-in-text--packt">CALCULATE</code></li>
      <li class="bullet">Time intelligence</li>
      <li class="bullet">Changing relationship behavior</li>
      <li class="bullet">Table functions in DAX</li>
      <li class="bullet">Filtering with table functions</li>
      <li class="bullet">DAX variables</li>
    </ul>
    <p class="book-title--packt">This chapter will be relatively light on examples, as the chapters of <em class="italic">Part 2</em> demonstrate all aspects of DAX context in depth.</p>
    <h1 id="calibre_link-64" class="title">The Power BI model</h1>
    <p class="book-title--packt">The examples <a id="calibre_link-1592" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in this chapter are taken from a simple Power BI model. The model consists of one fact table, <code class="code-in-text--packt">fSales</code>, with some filter tables:</p>
    <figure class="mediaobject"><img src="images/000164.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.1: The sample Power BI model</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The model file for this chapter, <code class="code-in-text--packt">1.4 Context and filtering.pbix</code>, can be downloaded from <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter1.4" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter1.4</span></a>.</p>
    </div>
    <h1 id="calibre_link-65" class="title">Introduction to DAX context</h1>
    <p class="book-title--packt">The generic term <a id="calibre_link-630" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for DAX context is <strong class="screentext">evaluation context</strong>: it is the context in which a DAX formula is evaluated, leading to a specific result. We like to distinguish between three types of context:</p>
    <ul class="calibre9">
      <li class="bullet">Row context</li>
      <li class="bullet">Query context</li>
      <li class="bullet">Filter context</li>
    </ul>
    <p class="book-title--packt">In most Power BI documentation and publications, only two types of context are identified: <em class="italic">row</em> and <em class="italic">filter context</em>. The term <em class="italic">query context</em> has been used in relation to Power Pivot in Excel since way before Power BI came into being (yes, we're that old), and we have kept using it. In our experience from DAX courses, distinguishing between query context and filter context helps people to understand more complex scenarios.</p>
    <p class="book-title--packt">Let's look at each context type in more detail.</p>
    <h2 id="calibre_link-66" class="calibre8">Row context</h2>
    <p class="book-title--packt">Row context is the<a id="calibre_link-635" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> type of <a id="calibre_link-1215" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>context you work with when creating calculated columns. A DAX formula defining a calculated column is evaluated for each row in the table. The result of the calculation is, typically, specific to each row. The reason for this is that values in other columns from the same table can be used in the calculation; these values can be different in each row. For instance, a calculated column in the <code class="code-in-text--packt">fSales</code> table to compute margin as the difference between sales amount and costs would look like this:</p>
    <pre class="programlisting"><code class="hljs-code">Margin = fSales[SalesAmount] &ndash; fSales[Costs]
</code></pre>
    <p class="book-title--packt">You can immediately spot that this formula is used for a calculated column by the direct reference to the columns. This can only be done within a row context, and this is what makes this context type different from other types. (In simple calculated column formulas, the <code class="code-in-text--packt">fSales</code> prefix is often omitted.)</p>
    <p class="book-title--packt">Note that this direct reference only works for column values in the current row (the row for which the formula is currently evaluated): to retrieve values from other rows, you will need to take a completely different approach. This is a fundamental difference with calculations in Excel, where is it quite common to take a value from "<em class="italic">the row above this one</em>." It is easy to understand why, when you realize that there is no strict order between the rows in a table in a Power BI model.</p>
    <p class="book-title--packt">There are only a few DAX functions specifically designed to work in a row context. If the table containing the calculated column is related to another table, in each row you can retrieve the corresponding value from a column in the other table using the <code class="code-in-text--packt">RELATED</code> function. The formula below leverages a <a id="calibre_link-505" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationship between the <code class="code-in-text--packt">fSales[OrderDate]</code> and <code class="code-in-text--packt">Date[Date]</code> columns to retrieve the year for each row:</p>
    <pre class="programlisting"><code class="hljs-code">Year = RELATED('Date'[Year])
</code></pre>
    <p class="book-title--packt">The<a id="calibre_link-636" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> result<a id="calibre_link-1216" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is a <code class="code-in-text--packt">Year</code> column in the <code class="code-in-text--packt">fSales</code> table:</p>
    <figure class="mediaobject"><img src="images/000186.png" alt="Table  Description automatically generated" class="calibre14" /> </figure>
    <p class="book-title--packt">Figure 1.4.2: Adding a Year calculated column (some columns removed for readability)</p>
    <p class="book-title--packt">There is one restriction required for <code class="code-in-text--packt">RELATED</code> to work: the relationship must have unique values in the "other" table &ndash; in this example, the <code class="code-in-text--packt">Date</code> table. After all, the formula must result in a single value.</p>
    <p class="book-title--packt">When the cardinality of the relationship is reversed, you can use the <code class="code-in-text--packt">RELATEDTABLE</code> function. For example, if you wanted to add a calculated column to the <code class="code-in-text--packt">Date</code> table with the number of sales transactions on each day, the formula below would do the trick:</p>
    <pre class="programlisting"><code class="hljs-code">Number of Transactions = COUNTROWS(RELATEDTABLE(fSales))
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">RELATEDTABLE</code> above results, for each row in <code class="code-in-text--packt">Date</code>, in the set of rows in <code class="code-in-text--packt">fSales</code> that are related to that row. As this is a table, it cannot be used directly as values in the calculated column; in this case, we use <code class="code-in-text--packt">COUNTROWS</code> to simply count the number of rows in that table.</p>
    <p class="book-title--packt">Although <code class="code-in-text--packt">RELATEDTABLE</code> is meant for use in a row context, it is fundamentally different from <code class="code-in-text--packt">RELATED</code> in that it uses a different context type under the hood. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">As discussed in <em class="italic">Chapter 1.3</em>, <em class="italic">Using DAX</em>, we discourage the use of calculated columns. This does not mean that you will not have to deal with row context. Row context plays an important role in DAX table functions as well. More on that later in this chapter.</p>
    </div>
    <p class="book-title--packt">We'll move<a id="calibre_link-637" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> on <a id="calibre_link-1217" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to the other context types now. There are some peculiarities about row context that can be made clear after we have discussed query and filter context.</p>
    <h2 id="calibre_link-67" class="calibre8">Query context</h2>
    <p class="book-title--packt">You work with <a id="calibre_link-633" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>query <a id="calibre_link-1188" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>context when you use DAX measures. Like row context before, query context is what makes a DAX measure return a specific result. The difference, of course, is that we are not working within a single table. In short, query context refers to the set of rows in a Power BI model that are selected and over which the DAX formula is evaluated. It helps to distinguish between two separate, although closely related, elements in query context:</p>
    <ul class="calibre9">
      <li class="bullet">A <strong class="screentext">selection</strong> refers <a id="calibre_link-1190" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to the set of rows in each table in the model that are selected in a specific context.</li>
      <li class="bullet"><strong class="screentext">Filters</strong> are what cause rows to be selected.</li>
    </ul>
    <p class="book-title--packt">In a query context, the filters come from elements in a (Power BI) report. These come in various sorts: slicers, filters in the filter pane, labels in a visual, or selected items in another visual. Each of these forms a specific rule on a column; for instance, in the figure below, the slicer induces a filter on the <code class="code-in-text--packt">Year</code> column: <em class="italic">Year equals 2019</em>. There can be many filters on different columns, and there may even be multiple filters on the same column. Together, the filters determine which rows are selected in each table: all rows that<a id="calibre_link-1593" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> satisfy<a id="calibre_link-1594" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> every filter rule.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">There is a thorough discussion of visual filters in <em class="italic">Chapter 2.4</em>, <em class="italic">Working with AutoExist</em>.</p>
    </div>
    <figure class="mediaobject"><img src="images/000208.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.3: A simple Power BI report</p>
    <p class="book-title--packt">In a query context, relationships between tables play an important role: that of <em class="italic">filter propagation</em>. This means that a filter on a column in one table is propagated by the relationship to the other table, in the relationship's crossfilter direction:</p>
    <figure class="mediaobject"><img src="images/000006.png" alt="Diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.4: Filter propagation by a relationship happens in the direction of the arrow</p>
    <p class="book-title--packt">Strictly speaking, it is not the filter itself that is propagated, but rather the effects of the filter: in the related table, only rows that correspond to rows that satisfy the filter rule are selected. This is, of course, exactly the behavior that is needed: when a slicer is set on the year 2019 like in <em class="italic">Figure 1.4.3</em>, we want to see results for 2019, which means that all calculations should only be done on rows in the fact table that correspond to dates in 2019.</p>
    <p class="book-title--packt">Because of the nature of query context, you cannot directly use columns in a formula like you can in a row context. The formula below, as a measure, is not accepted by the editor:</p>
    <pre class="programlisting"><code class="hljs-code">Report Year = 'Date'[Year]
</code></pre>
    <p class="book-title--packt">It results in <a id="calibre_link-634" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>an error<a id="calibre_link-1189" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> message: <strong class="screentext">A single value for column 'Year' in table 'Date' cannot be determined</strong><em class="italic">.</em> The reason is that, conceptually, the selection could contain multiple values. This is true even when the column contains only one unique value, or when the table contains only one row.</p>
    <h2 id="calibre_link-68" class="calibre8">Filter context</h2>
    <p class="book-title--packt">Filter <a id="calibre_link-739" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>context<a id="calibre_link-631" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> looks similar to query context, with one important exception: filter context is a context changed by DAX code, for example, by adding or changing filters in a query context. The central DAX function that is used for this is <code class="code-in-text--packt">CALCULATE</code> (or its sibling <code class="code-in-text--packt">CALCULATETABLE</code>). The way changing context with <code class="code-in-text--packt">CALCULATE</code> works is discussed in depth in the <em class="italic">DAX filtering: Using CALCULATE</em> section later in this chapter.</p>
    <p class="book-title--packt">What makes filter context difficult is that you cannot determine the filters in the context from the visual, like you can with query context. Working with filter context requires a level of abstract thinking and meticulously keeping track of which filters are active in a specific situation. For the same reason, measures that create and use filter context can be confusing to the report users and should therefore be applied with care, by using self-explanatory measure names, for example.</p>
    <p class="book-title--packt">Being able to change context opens up a plethora of possibilities not available with merely row context and query context. It allows us to obtain results that do not correspond with the query context, and that can be used to provide advanced insights, like comparing sales for a product with sales of all products, comparing this year's sales to last year's, extrapolating trends into the future, and so on. In fact, none of the scenarios discussed in <em class="italic">Part 2</em> of this book are possible without filter context.</p>
    <p class="book-title--packt">The general approach to creating sophisticated insights with DAX can be described as follows:</p>
    <ol class="calibre9">
      <li class="calibre12">Study the (possible) query contexts your calculation will be evaluated in.</li>
      <li class="calibre12">Determine what filter context is needed to return the required result.</li>
      <li class="calibre12">Determine how to go from query context to filter context.</li>
    </ol>
    <p class="book-title--packt">To <a id="calibre_link-1595" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>master DAX, you should acquaint yourself with this way of thinking, which is fundamentally different from retrieving data with SQL, programming, or doing calculations in Excel.</p>
    <h2 id="calibre_link-69" class="calibre8">Detecting filters</h2>
    <p class="book-title--packt">Filters in an <a id="calibre_link-632" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>evaluation context cause the selection of rows in the tables of a model. When you consider the effect of this on a single column, several things can happen. It could be that no selection is made, such that all values in the column are in the context. It could also be that a subset of values is selected. This can be caused by a filter on that column, in which case we say that the column is filtered <em class="italic">directly</em>, or it can be caused by a filter on another column in the same table or a filter in another table, which is propagated by a relationship. No matter where that filter comes from, we say that the column is <em class="italic">indirectly</em> filtered or crossfiltered.</p>
    <p class="book-title--packt">DAX contains a number of functions to detect the filters in the context and their effect. Each function takes a column reference, say column A, as an argument:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">ISFILTERED</code>: Whether <a id="calibre_link-1596" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>there is <a id="calibre_link-664" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a filter directly on column A.</li>
      <li class="bullet"><code class="code-in-text--packt">ISCROSSFILTERED</code>: Whether <a id="calibre_link-1597" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a filter<a id="calibre_link-663" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> on any column in the model causes a selection in column A.</li>
      <li class="bullet"><code class="code-in-text--packt">HASONEFILTER</code>: Whether <a id="calibre_link-1598" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a (direct) filter <a id="calibre_link-661" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on column A selects <em class="italic">exactly one</em> value.</li>
      <li class="bullet"><code class="code-in-text--packt">HASONEVALUE</code>: Whether a<a id="calibre_link-1599" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filter <a id="calibre_link-662" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on any column in the model causes a selection of <em class="italic">exactly one</em> value in column A.</li>
      <li class="bullet"><code class="code-in-text--packt">ISINSCOPE</code>: Whether <em class="italic">exactly one</em> value is <a id="calibre_link-938" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selected in<a id="calibre_link-665" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> column A, caused by a filter on column A that comes from inside the visual. This function is designed to detect the current drill-down level in a visual that allows for drill-down.</li>
    </ul>
    <p class="book-title--packt">These functions can be of help if you want to investigate what the context looks like. They can<a id="calibre_link-1600" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> also be used to implement specific DAX measure behavior, although there are pitfalls along the way. You can find some examples in <em class="italic">Chapter 2.1, Security with DAX</em>.</p>
    <h2 id="calibre_link-70" class="calibre8">Comparing query and filter context to row context</h2>
    <p class="book-title--packt">Now that <a id="calibre_link-1191" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>we <a id="calibre_link-740" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have<a id="calibre_link-1219" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> covered <a id="calibre_link-1218" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>query and filter context, we can look at row context from a different perspective. As an example, suppose you create a calculated column in the <code class="code-in-text--packt">fSales</code> table with the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">TotalTax = SUM(fSales[Tax])
</code></pre>
    <p class="book-title--packt">You will find that in the resulting <code class="code-in-text--packt">TotalTax</code> column, each row contains the same value. The <code class="code-in-text--packt">SUM</code> function calculated the total of <em class="italic">all</em> rows in the table, even though we are in row context for a single row. To DAX beginners, this is often a surprising find. Let's look at another example, this time a calculated column in the <code class="code-in-text--packt">Date</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">TotalShipping = SUM(fSales[ShippingCosts])
</code></pre>
    <p class="book-title--packt">Again, you will find that same result in every row, even though there is a relationship between the <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">Date</code> tables. Shouldn't the relationship cause the calculation to return the total shipping costs for each day separately?</p>
    <p class="book-title--packt">These examples teach us something about the nature of row context. The <code class="code-in-text--packt">TotalShipping</code> example suggests that in a row context, relationships do not propagate selections. This is a useful rule of thumb to work with, but the reality is a bit more subtle. In a row context, DAX specifically allows for using column values from the same table; outside of that, nothing is selected or filtered. In a calculated column, there are no filters on any column in the table. As a consequence, relationships have nothing to propagate. This means that when you refer to another table, like the <code class="code-in-text--packt">TotalShipping</code> calculation does, you work with the complete table. Even when you refer to the table which the calculated column is in, like in the <code class="code-in-text--packt">TotalTax</code> calculation, you are looking at all rows.</p>
    <p class="book-title--packt">As a consequence, if you are in a row context but need a relationship to propagate, you must find a way to <em class="italic">change the row context to a filter context</em>. And for that, you must use the <code class="code-in-text--packt">CALCULATE</code> function. </p>
    <h1 id="calibre_link-71" class="title">DAX filtering: Using CALCULATE</h1>
    <p class="book-title--packt">Changing <a id="calibre_link-608" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>context<a id="calibre_link-423" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> using DAX code is one of the most powerful features of DAX. The DAX <code class="code-in-text--packt">CALCULATE</code> function, which is <a id="calibre_link-490" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>used for <strong class="screentext">context transformation</strong>, is arguably the most important DAX function. By specifying filter expressions in <code class="code-in-text--packt">CALCULATE</code>, you can control the subsets of rows your formula works on. This can be done by adding or replacing filters, but also by removing filters from the context. As relationships play an important role in context by propagating filters, activating or inactivating relationships or changing their filter propagation behavior is a form of context transformation as well.</p>
    <p class="book-title--packt">Let's start with a sample DAX measure:</p>
    <pre class="programlisting"><code class="hljs-code">SalesLargeUnitAmount =
CALCULATE(
    SUM(fSales[SalesAmount]),
    fSales[UnitAmount] &gt; 25
)
</code></pre>
    <p class="book-title--packt">This measure returns the sales on transactions in which more than 25 units were sold. The first argument of <code class="code-in-text--packt">CALCULATE</code> is the calculation to be performed, in this case, the sum of the <code class="code-in-text--packt">SalesAmount</code> column in <code class="code-in-text--packt">fSales</code>. All other arguments &ndash; and there can be many &ndash; are filter arguments.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">DAX allows you to write a formula without explicitly using the <code class="code-in-text--packt">CALCULATE</code> function when the calculation is in a separate measure. For instance, with a basic sales measure:</p>
      <pre class="programlisting"><code class="hljs-code">Sales = SUM(fSales[SalesAmount])
</code></pre>
      <p class="book-title--packt">The sample measure we saw previously can also be rewritten as:</p>
      <pre class="programlisting"><code class="hljs-code">SalesLargeUnitAmount =     [Sales] (fSales[UnitAmount] &gt; 25)
</code></pre>
      <p class="book-title--packt">We advise against this syntax, as formulas using an explicit <code class="code-in-text--packt">CALCULATE</code> are more readable, especially in more complex formulas.</p>
    </div>
    <p class="book-title--packt">To understand how <code class="code-in-text--packt">CALCULATE</code> works, you <a id="calibre_link-416" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>should keep in mind that the function performs four basic steps in order:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">The existing context (either row or query context, or another filter context) is changed into a filter context.</li>
      <li class="calibre12">Existing filters, if any, on columns (or entire tables) referred to in the filter arguments are removed.</li>
      <li class="calibre12">New filters are added.</li>
      <li class="calibre12">The expression in the first argument is evaluated in the new filter context.</li>
    </ol>
    <p class="book-title--packt">Several specific DAX functions can be used in filter arguments to change this behavior, but let<a id="calibre_link-424" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> us <a id="calibre_link-609" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>first focus on these steps, working with the <code class="code-in-text--packt">SalesLargeUnitAmount</code> measure as an example.</p>
    <h2 id="calibre_link-72" class="calibre8">Step 1: Setting up a filter context</h2>
    <p class="book-title--packt">The first<a id="calibre_link-645" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> thing to do for <code class="code-in-text--packt">CALCULATE</code> is to create an environment in which filters can be changed. When we start in a query or filter context, we already have that environment, so there is nothing to do. So, for our <code class="code-in-text--packt">SalesLargeUnitAmount</code> measure, this step is trivial. When we start in a row context, however, the differences are huge. </p>
    <p class="book-title--packt">The transition from row context to filter context is achieved by creating a filter on each column in the table that prescribes the value in that column to be the column's value in the current row (remember that a row context is always about a single row). The result is a filter context where the current row is <a id="calibre_link-417" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selected. In addition to this, if there are relationships from this table to other tables, these relationships now have filters to propagate, and therefore we can expect subsets of rows to be selected in those other tables as well.</p>
    <p class="book-title--packt">For example, we can change the formula for the <code class="code-in-text--packt">TotalTax</code> calculated column used earlier by wrapping it in <code class="code-in-text--packt">CALCULATE</code> (note that we use <code class="code-in-text--packt">CALCULATE</code> without any filter argument here):</p>
    <pre class="programlisting"><code class="hljs-code">TotalTax2 = CALCULATE(SUM(fSales[Tax]))
</code></pre>
    <p class="book-title--packt">For each row, the formula changes row context into filter context. The <code class="code-in-text--packt">SUM</code> function now works on the selected rows, which is only the current row. In other words, the result is just the value of the <code class="code-in-text--packt">Tax</code> column in the row itself:</p>
    <figure class="mediaobject"><img src="images/000024.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.5: The effect of CALCULATE in a calculated column</p>
    <p class="book-title--packt">In the case<a id="calibre_link-1601" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of the <code class="code-in-text--packt">TotalShipping</code> calculated column, in the <code class="code-in-text--packt">Date</code> table, the same thing happens:</p>
    <pre class="programlisting"><code class="hljs-code">TotalShipping = CALCULATE(SUM(fSales[ShippingCosts]))
</code></pre>
    <p class="book-title--packt">The row context in the <code class="code-in-text--packt">Date</code> table is transformed into a filter context that has filters on each column of the table. This time, the relationship between the <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">Date</code> tables can propagate the selection, causing <a id="calibre_link-418" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the set of rows in <code class="code-in-text--packt">fSales</code> to be selected that correspond to the current row in <code class="code-in-text--packt">Date</code>: </p>
    <figure class="mediaobject"><img src="images/000045.png" alt="Table  Description automatically generated" class="calibre14" /> </figure>
    <p class="book-title--packt">Figure 1.4.6: CALCULATE causes relationships to propagate filters</p>
    <p class="book-title--packt">The result of <a id="calibre_link-646" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>adding <code class="code-in-text--packt">CALCULATE</code> is that we now have a correct <code class="code-in-text--packt">TotalShipping</code> amount per day.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You may wonder how realistic it is to use <code class="code-in-text--packt">CALCULATE</code> without filter arguments, but you do this more often than you may think. Each time you call a measure within a formula, <code class="code-in-text--packt">CALCULATE</code> is implicitly put around it, for example: </p>
      <pre class="programlisting"><code class="hljs-code">SalesByCustomer =     DIVIDE([Sales], [Number of Customers])
</code></pre>
      <p class="book-title--packt">In this formula, both the calculation for <code class="code-in-text--packt">Sales</code> and for <code class="code-in-text--packt">Number of Customers</code> are done in a filter context. Calling a measure is a common way to go from row context to filter context, which is something you often need to do.</p>
    </div>
    <p class="book-title--packt">Now that the initial filter context is in place, <code class="code-in-text--packt">CALCULATE</code> can take the next step.</p>
    <h2 id="calibre_link-73" class="calibre8">Step 2: Removing existing filters</h2>
    <p class="book-title--packt">The second <a id="calibre_link-641" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>step in the working order of <code class="code-in-text--packt">CALCULATE</code> is to remove filters from the new filter context. The process is straightforward: each column that is referenced in one of the filter arguments is checked for filters. If a filter exists on that column, it is removed.</p>
    <p class="book-title--packt">In our example <code class="code-in-text--packt">SalesLargeUnitAmount</code> measure, the single filter argument is:</p>
    <pre class="programlisting"><code class="hljs-code">fSales[UnitAmount] &gt; 25
</code></pre>
    <p class="book-title--packt">This filter argument leads <code class="code-in-text--packt">CALCULATE</code> to remove any existing filter on the <code class="code-in-text--packt">fSales[UnitAmount]</code> column.</p>
    <p class="book-title--packt">What is sometimes forgotten is that <a id="calibre_link-941" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>columns that are <em class="italic">not</em> mentioned in filter arguments keep their filters (when they exist). And as you do not have full control over what the original context looks like, you should take care in going over the different scenarios your measure may be used in. You may need to remove more filters than you initially expect. You <a id="calibre_link-419" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will find an example of the impact that other filters can have after we have covered all four steps.</p>
    <p class="book-title--packt">The behavior <a id="calibre_link-642" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of <code class="code-in-text--packt">CALCULATE</code> in <em class="italic">step 2</em> can be changed by using the <code class="code-in-text--packt">KEEPFILTERS</code> function. This function causes <code class="code-in-text--packt">CALCULATE</code> to skip <em class="italic">step 2</em> for the filter argument you apply <code class="code-in-text--packt">KEEPFILTERS</code> to, for example:</p>
    <pre class="programlisting"><code class="hljs-code">SalesLargeUnitAmount KeepFilters =
CALCULATE(
    [Sales],
    KEEPFILTERS(fSales[UnitAmount] &gt; 25)
)
</code></pre>
    <p class="book-title--packt">In this formula, whenever there is an existing filter on the <code class="code-in-text--packt">UnitAmount</code> column, it is kept, <em class="italic">and</em> a new filter is added in <em class="italic">step 3</em>.</p>
    <h2 id="calibre_link-74" class="calibre8">Step 3: Applying new filters</h2>
    <p class="book-title--packt">The third <a id="calibre_link-651" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>step that is performed by <code class="code-in-text--packt">CALCULATE</code> is applying new filters. As in <em class="italic">step 2</em>, the function goes over its filter arguments and takes these as instructions for creating new filters. In the example, the filter argument</p>
    <pre class="programlisting"><code class="hljs-code">fSales[UnitAmount] &gt; 25
</code></pre>
    <p class="book-title--packt">causes a new filter to be created on the <code class="code-in-text--packt">UnitAmount</code> column, selecting all values larger than 25.</p>
    <p class="book-title--packt">In understanding <code class="code-in-text--packt">CALCULATE</code>, it is very helpful to remember that <em class="italic">step 2</em> and <em class="italic">step 3</em> are applied in that order. The order of the filter arguments themselves is irrelevant. As a simple example:</p>
    <pre class="programlisting"><code class="hljs-code">Sales373_374 = 
CALCULATE(
    [Sales], 
    Products[ProductID] = 373, 
    Products[ProductID] = 374
)
</code></pre>
    <p class="book-title--packt">Many beginners in DAX expect this formula to return sales for product 374, reasoning that the<a id="calibre_link-652" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filter is first set on <code class="code-in-text--packt">ProductID</code> 373, and then on 374. In reality, this measure will always return blank, because two filters on <code class="code-in-text--packt">ProductID</code> are added, which require the column to equal both <code class="code-in-text--packt">373</code> and <code class="code-in-text--packt">374</code>. There <a id="calibre_link-420" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are no rows in the <code class="code-in-text--packt">Products</code> table that satisfy these rules and the <code class="code-in-text--packt">TotalSales</code> measure will therefore return a blank value (assuming there is a relationship propagating filters from the <code class="code-in-text--packt">Products</code> table to the <code class="code-in-text--packt">fSales</code> table).</p>
    <p class="book-title--packt">You may consider this a trivial example; however, in a slightly different form, it fools many:</p>
    <pre class="programlisting"><code class="hljs-code">Sales373OrWhat =
CALCULATE(
    [Sales],
    Products[ProductID] = 373,
    ALL(Products)
)
</code></pre>
    <p class="book-title--packt">Like for the previous example, the correct way to understand what happens is to realize that filters are removed for each filter argument before new filters are added. The result is sales for <code class="code-in-text--packt">ProductID</code> 373.</p>
    <h2 id="calibre_link-75" class="calibre8">Step 4: Evaluating the expression to calculate</h2>
    <p class="book-title--packt">The last step<a id="calibre_link-643" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in the working order for <code class="code-in-text--packt">CALCULATE</code> is easy: after setting up a filter context, removing filters, and adding new filters, the expression in the first argument can be evaluated in the new context. This is the proof of the pudding, of course, as this is where we can really see what the effect of all the context transformations is.</p>
    <p class="book-title--packt">As an example of how filter manipulation can be tricky, take the matrix visual below.</p>
    <figure class="mediaobject"><img src="images/000066.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.7: Output for example measures</p>
    <p class="book-title--packt">In this matrix, we show information about products using the <code class="code-in-text--packt">Group</code> and <code class="code-in-text--packt">ProductID</code> columns as labels. We focus specifically on product 373 in product group <code class="code-in-text--packt">Rear wheel</code>. The name of this product, which is in the <code class="code-in-text--packt">Product</code> column, is <code class="code-in-text--packt">REAR WHEEL STEEL #525</code>. We want to be able to compare each <a id="calibre_link-421" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>product's sales with product 373's sales. You could think of this as product 373 being the most strategic product for our company, and we want to express each product's sales as a percentage of the sales of product 373.</p>
    <p class="book-title--packt">To accomplish a comparison, we need a calculation that returns sales for product 373 in each row of the visual. We try this using two measures:</p>
    <pre class="programlisting"><code class="hljs-code">Sales373 =
CALCULATE(
    [Sales],
    Products[ProductID] = 373
)
</code></pre>
    <p class="book-title--packt">As well as:</p>
    <pre class="programlisting"><code class="hljs-code">SalesRearWheel525 =
CALCULATE(
    [Sales],
    Products[Product] = "REAR WHEEL STEEL #525"
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">Sales</code> measure is in the visual so you can better see what is happening. In most of the rows in the visual, two filters exist in the query context: one on the <code class="code-in-text--packt">Group</code> column, and one on the <code class="code-in-text--packt">ProductID</code> column. The exceptions are the subtotal rows (with a filter on <code class="code-in-text--packt">Group</code> only) and the <a id="calibre_link-644" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>grand total row (with no filters).</p>
    <p class="book-title--packt">Clearly, the two measures using <code class="code-in-text--packt">CALCULATE</code> return different results. Why this difference? As <code class="code-in-text--packt">Sales373</code> references the <code class="code-in-text--packt">ProductID</code> column in the filter argument, any existing filter on that column is removed (<em class="italic">step 2</em>) before the new filter is added (<em class="italic">step 3</em>). On the visual's row for product 239, for instance, the filter "<em class="italic">ProductID equals 239</em>" is removed and the filter "<em class="italic">ProductID equals 373</em>" is added. As a result, the calculation returns sales for product 373.</p>
    <p class="book-title--packt">Something else happens in the <code class="code-in-text--packt">SalesRearWheel525</code> measure. Here, the filter argument references the <code class="code-in-text--packt">Product</code> column, so any existing filter on the <code class="code-in-text--packt">Product</code> column is removed (<em class="italic">step 2</em>). After that, the <a id="calibre_link-422" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>new filter is added (<em class="italic">step 3</em>). Looking at product 239 again, the query context contains filters on <code class="code-in-text--packt">Group</code> and <code class="code-in-text--packt">ProductID</code>. The measure does not remove these, but adds the new filter on the <code class="code-in-text--packt">Product</code> column. The selection in the resulting filter context is all the rows in the <code class="code-in-text--packt">Product</code> table that satisfy all three filters; in other words, no rows are selected and the result is blank, unless the three filters happen to point to the same product. This is true only for product 373 itself, which is why that is the only row in the visual that shows a result.</p>
    <p class="book-title--packt">The same reasoning explains why the <code class="code-in-text--packt">Sales373</code> measure does not return results in groups other than <code class="code-in-text--packt">Rear wheel</code>: when a filter on <code class="code-in-text--packt">Group</code> selects another group, the combination <a id="calibre_link-1602" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with <code class="code-in-text--packt">ProductID</code> 373 (the newly added filter) leads to an empty selection on the <code class="code-in-text--packt">Product</code> table.</p>
    <h2 id="calibre_link-76" class="calibre8">Removing filters with ALL functions</h2>
    <p class="book-title--packt">Both measures<a id="calibre_link-647" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> from the <a id="calibre_link-302" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>previous section have the same problem, of course, depending on the context. To create a measure that always returns the sales for product 373, regardless of what selection of products is made in the query context, we must get rid of any filter that may get in the way.</p>
    <p class="book-title--packt">It is important to have precise control over which filters are removed. To enable this, a category of DAX functions is available that we call the <code class="code-in-text--packt">ALL</code> functions. The differences between these functions are in which filters are removed:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">ALL</strong>: This function <a id="calibre_link-655" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can take one or more column references or<a id="calibre_link-301" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> a table reference as arguments. It removes filters from the columns specified, or from&nbsp;all columns from the table referenced. If you really want to, you can use&nbsp;<code class="code-in-text--packt">ALL</code> without arguments to remove all filters from the entire Power BI model. Examples:
        <pre class="programlisting"><code class="hljs-code">ALL(Cities[Country])
ALL(Cities[Country], Cities[State])
ALL(Cities)
ALL()
</code></pre>
      
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">When using <code class="code-in-text--packt">ALL</code> on a table, the columns that filters are removed from include columns in related tables. For instance, <code class="code-in-text--packt">ALL(fSales)</code> would remove filters from the <code class="code-in-text--packt">Cities</code> table as well when there is a many-to-one relationship between <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">Cities</code>. See also <code class="code-in-text--packt">ALLCROSSFILTERED</code>.</p>
    </div>
</li>
    </ul>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">ALLEXCEPT</strong>: This<a id="calibre_link-296" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function<a id="calibre_link-654" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> can be used as an alternative to <code class="code-in-text--packt">ALL</code> with many column arguments. Instead of mentioning all columns you want to remove filters from, you specify a table and the columns in that table that should keep their filters. Filters from all other <a id="calibre_link-1603" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>columns in the table are<a id="calibre_link-1604" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> removed. Example:
        <pre class="programlisting"><code class="hljs-code">ALLEXCEPT(Cities, Cities[Country])
</code></pre>
      </li>
      <li class="bullet"><strong class="screentext">ALLNOBLANKROW</strong>: When<a id="calibre_link-656" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> you use <code class="code-in-text--packt">ALL</code>, the <a id="calibre_link-1605" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>resulting context includes all values from the specified columns. This includes values from a possible blank row that is added to the table because of an incomplete relationship (see <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>; these values are <a id="calibre_link-294" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>necessarily blank). If you do not want these blank values to be included in the context, you should use <code class="code-in-text--packt">ALLNOBLANKROW</code> instead of <code class="code-in-text--packt">ALL</code>. This function takes one argument, either a column or a table. Example:
        <pre class="programlisting"><code class="hljs-code">ALLNOBLANKROW(Cities[Country])
</code></pre>
      </li>
      <li class="bullet"><strong class="screentext">ALLSELECTED</strong>: This <a id="calibre_link-657" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is a special <code class="code-in-text--packt">ALL</code> function, as it is<a id="calibre_link-307" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the only function that is aware of the origin of filters. <code class="code-in-text--packt">ALLSELECTED</code> removes filters, but only when these filters originate from labels within the visual where the measure is used. External filters, like <a id="calibre_link-648" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>those <a id="calibre_link-303" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>coming from slicers, page filters, or other visuals, are left untouched. This function is used to create measures that aggregate selected items within a visual, for instance, to compute a percentage that always adds up to 100% in the total for the visual. The function takes a table, one or more columns, or nothing, as arguments. Example:
        <pre class="programlisting"><code class="hljs-code">ALLSELECTED(Cities[Country])
</code></pre>
      </li>
      <li class="bullet"><strong class="screentext">ALLCROSSFILTERED</strong>: This<a id="calibre_link-653" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function was<a id="calibre_link-295" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> introduced for use in composite Power BI models, or models that include a mix of direct query and import tables, or different direct query connections. Relationships between tables of different origin in such a model are "weak" and do not provide the standard behavior: <code class="code-in-text--packt">ALL(fSales)</code> would not remove filters from the <code class="code-in-text--packt">Cities</code> table when <code class="code-in-text--packt">fSales</code> is a direct query table and <code class="code-in-text--packt">Cities</code> is imported. The <code class="code-in-text--packt">ALLCROSSFILTERED</code> function takes a table reference as an argument and will remove filters from both that table and related tables, even when relationships are weak. In a standard import <a id="calibre_link-1606" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>model, you do not need to <a id="calibre_link-1607" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use <code class="code-in-text--packt">ALLCROSSFILTERED</code>. Example:
        <pre class="programlisting"><code class="hljs-code">ALLCROSSFILTERED(fSales)
</code></pre>
      </li>
    </ul>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">There is an alternative DAX function you can use to remove filters within a <code class="code-in-text--packt">CALCULATE</code> statement: <code class="code-in-text--packt">REMOVEFILTERS</code>. This function takes one or more columns or an entire table as an argument, for instance:</p>
      <pre class="programlisting"><code class="hljs-code">CALCULATE(
    [Sales],
    REMOVEFILTERS(Cities)
)
</code></pre>
      <p class="book-title--packt">This function was introduced as an easier-to-understand alternative to <code class="code-in-text--packt">ALL</code>. We prefer the shorter <code class="code-in-text--packt">ALL</code>, and never use <code class="code-in-text--packt">REMOVEFILTERS</code>.</p>
    </div>
    <p class="book-title--packt">By carefully choosing one or more <code class="code-in-text--packt">ALL</code> functions, you can make <code class="code-in-text--packt">CALCULATE</code> do exactly what <a id="calibre_link-304" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>you<a id="calibre_link-649" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> want. Remember that we wanted to create a measure that always returns sales for product 373; in other words, we know exactly what we want the filter context to look like. We do not have control over what filters exist in the query context we start with, but we do have control over what filters are removed. Consider this updated measure:</p>
    <pre class="programlisting"><code class="hljs-code">SalesRearWheel525_ALL =
CALCULATE(
    [Sales],
    Products[Product] = "REAR WHEEL STEEL #525",
    ALL(Products)
)
</code></pre>
    <p class="book-title--packt">With this formula, <em class="italic">any</em> existing filter from the <code class="code-in-text--packt">Products</code> table is removed before adding the filter on the <code class="code-in-text--packt">Product</code> column. The difference is clear:</p>
    <figure class="mediaobject"><img src="images/000088.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.8: Using ALL</p>
    <p class="book-title--packt">Not only is the result for product 373, the <code class="code-in-text--packt">REAR WHEEL STEEL #525</code>, returned for the other products, the result is even returned when the query context filters other product groups. With this, we have the essential building block for expressing any product's sales relative to product 373's sales, with a simple division:</p>
    <pre class="programlisting"><code class="hljs-code">Sales% = DIVIDE([Sales], [SalesRearWheel525_ALL]
</code></pre>
    <p class="book-title--packt">With a combination of filter arguments and <code class="code-in-text--packt">ALL</code> functions, many powerful DAX measures<a id="calibre_link-305" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> can <a id="calibre_link-650" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>be created. Some filters are more difficult to create and specify than others, however, and among these are filters that deal with the calendar. This is why DAX contains a special category of functions for this purpose, which we discuss in the next section.</p>
    <h1 id="calibre_link-77" class="title">Time intelligence</h1>
    <p class="book-title--packt">There are probably <a id="calibre_link-1378" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>hardly any Power BI models that do not include some analysis over time. We want to compare current results with those of last year, for instance. Many other calendar-related insights may also be needed, like year-to-date results, rolling totals, or growth rates from any other past period of time. The difficulty is that the Gregorian calendar is quite messy: most years have 365 days, but some have 366, and months can have anywhere between 28 and 31 days.</p>
    <p class="book-title--packt">These calendar complexities notwithstanding, calendar-based analysis is simply about filtering to change context. Consider the year-to-date sales chart below:</p>
    <figure class="mediaobject"><img src="images/000109.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.9: A year-to-date chart</p>
    <p class="book-title--packt">By definition of year-to-date, what you see in, say, the <code class="code-in-text--packt">August</code> column, is the total sales in the period of January 1, 2021 up until August 31, 2021. However, the query context for this column contains a filter on year (2021) and month (August), causing a selection of August 1 to August 31, 2021. Clearly, the context must be transformed along the way to be able to return the year-to-date total sales.</p>
    <p class="book-title--packt">In the calculation for year-to-date sales, you would therefore expect the use of <code class="code-in-text--packt">CALCULATE</code> with some filter arguments:</p>
    <pre class="programlisting"><code class="hljs-code">SalesYTD =
CALCULATE(
    [Sales],
    ... (some filter argument)
)
</code></pre>
    <p class="book-title--packt">Indeed, DAX <a id="calibre_link-1359" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>time<a id="calibre_link-592" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> intelligence functions implement filter arguments in <code class="code-in-text--packt">CALCULATE</code> to deal with the complexities of the calendar. The year-to-date filter is provided by the <code class="code-in-text--packt">DATESYTD</code> function:</p>
    <pre class="programlisting"><code class="hljs-code">SalesYTD =
CALCULATE(
    [Sales],
    DATESYTD('Date'[Date])
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">DATESYTD</code> function <a id="calibre_link-1379" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>works on the basis of the query context on the date table. Its recipe looks like this:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">Retrieve the last date in the context.</li>
      <li class="calibre12">Determine the year this date falls in, and the first day of that year.</li>
      <li class="calibre12">Create a filter on the <code class="code-in-text--packt">Date[Date]</code> column, selecting everything from the first day of the year to the last date in the context.<p class="bullet1">With the new context, <code class="code-in-text--packt">CALCULATE</code> can do its job evaluating, in our example, the <code class="code-in-text--packt">Sales</code> measure. But wait: the <code class="code-in-text--packt">DATESYTD</code> filter argument references the <code class="code-in-text--packt">Date</code> column, but in the chart in <em class="italic">Figure 1.4.9</em>, there are filters on the <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code> columns! This is a very common situation, and therefore, <code class="code-in-text--packt">DATESYTD</code> takes one more step:</p>
      </li>
      <li class="calibre12">Add an implicit <code class="code-in-text--packt">ALL('Date')</code> filter argument.</li>
    </ol>
    <p class="book-title--packt">This last step is common to all time intelligence functions, and saves us from having to add explicit <code class="code-in-text--packt">ALL</code> functions all the time.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The implicit <code class="code-in-text--packt">ALL('Date'[Date])</code> clause is only added when you have formally marked your table with dates as the Power BI model's date table, or when the relationships from fact tables to your date table are created on columns with the Date data type. Although the time intelligence functions can therefore work correctly without a formal date table declaration, we strongly recommend using this declaration anyway.</p>
    </div>
    <p class="book-title--packt">As mentioned, time intelligence is a very common need. For this reason, several time intelligence functions offer shorter, easier-to-use versions as well. The <code class="code-in-text--packt">DATESYTD</code> function, used<a id="calibre_link-1360" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in<a id="calibre_link-593" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> combination with <code class="code-in-text--packt">CALCULATE</code>, can be replaced by the <code class="code-in-text--packt">TOTALYTD</code> function:</p>
    <pre class="programlisting"><code class="hljs-code">SalesYTD_short =
TOTALYTD(
    [Sales],
    'Date'[Date]
)
</code></pre>
    <p class="book-title--packt">This formula is exactly the <a id="calibre_link-1608" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>same, although syntactically different. While that may be an advantage, the downside is that, to many beginners in DAX, this function looks like it calculates a year-to-date <em class="italic">total</em>. In reality, the only thing <code class="code-in-text--packt">TOTALYTD</code> does is change the context. It may return a year-to-date average or year-to-date anything; it all depends on the measure or expression used as the first argument.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">For the sake of completeness, it is possible to use <code class="code-in-text--packt">DATESYTD</code> and <code class="code-in-text--packt">TOTALYTD</code> for fiscal years that start at another date than January 1. <code class="code-in-text--packt">DATESYTD</code> allows for a second argument, which it should be able to derive a day in the year from, like "8/31" or "2020/9/30"; this is taken as the <em class="italic">last</em> day of the year. For reasons we have never really understood, in <code class="code-in-text--packt">TOTALYTD</code> this argument is the fourth argument, which means that you must include a third argument. This is an additional filter. You can safely use <code class="code-in-text--packt">ALL('Date'[Date])</code> here, as that is implicitly added anyway.</p>
    </div>
    <p class="book-title--packt">Next to <code class="code-in-text--packt">DATESYTD</code>, the time intelligence functions used the most are:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">SAMEPERIODLASTYEAR</code>: As<a id="calibre_link-1259" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the name says, the function takes the current context and moves it back exactly one year. This is, of <a id="calibre_link-594" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>course, what you need to compute year-on-year <a id="calibre_link-1609" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>growth numbers. Surprisingly, there is no shortcut version of the function. The sales for last year could be calculated with:
        <pre class="programlisting"><code class="hljs-code">SalesLY =
CALCULATE(
    [Sales],
    SAMEPERIODLASTYEAR('Date'[Date])
)
</code></pre>
      </li>
      <li class="bullet"><code class="code-in-text--packt">DATESINPERIOD</code>: This<a id="calibre_link-576" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function can be used to return a period starting at (or ending on) a certain reference date, and with a specified length expressed in units of days, months, quarters, or years. This is the function you need to compute rolling totals. For example, the 12-month rolling total of sales (thus looking back 12 months) is calculated using the formula below. Here, <code class="code-in-text--packt">MAX('Date'[Date])</code> is used to retrieve the last day in the context as the reference date:
        <pre class="programlisting"><code class="hljs-code">SalesRollingTotal =
CALCULATE(
    [Sales],
    DATESINPERIOD(
          'Date'[Date], 
          MAX('Date'[Date]), 
          -12, MONTH
   )
)
</code></pre>
      </li>
    </ul>
    <p class="book-title--packt">When working with time<a id="calibre_link-1380" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> intelligence functions, it is important to keep in mind that each time intelligence function transforms the context on the date table; nothing else. This means that any table in the model that is not related to the date table will not be impacted by this context transformation. It also means that you will get unexpected results when your date table is "short." For example, if your date table starts with the year 2020 and you use the <code class="code-in-text--packt">SAMEPERIODLASTYEAR</code> function in a context that selects dates in February 2020, the result will be an empty context on the calendar. That will lead to a blank result for the measure, even if the fact<a id="calibre_link-1610" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> table you aggregate over does have dates in 2019 or earlier.</p>
    <h1 id="calibre_link-78" class="title">Changing relationship behavior</h1>
    <p class="book-title--packt">In <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>, you <a id="calibre_link-1433" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>learned that there can be multiple relationships between tables, but only one of those relationships can be active. The same is true for relationship paths between tables: a Power BI model allows for only one active path between any two tables in the model. This is of course only useful if the inactive&nbsp;relationships can be made active if you need to. You can do this by using the&nbsp;function <code class="code-in-text--packt">USERELATIONSHIP</code>.</p>
    <p class="book-title--packt">The function <code class="code-in-text--packt">USERELATIONSHIP</code> is used by <a id="calibre_link-1260" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>including it as a filter argument in <code class="code-in-text--packt">CALCULATE</code>. This may seem surprising, but it really makes sense. A relationship between a fact table and a filter table ensures that a selection in the filter table propagates to the fact table. Activating another relationship means that that relationship now propagates the selection to the fact table, with the effect that different rows in the fact table are selected. In other words: activating another relationship means changing the context for the calculation. And changing context is&nbsp;what <code class="code-in-text--packt">CALCULATE</code> is for.</p>
    <p class="book-title--packt"><code class="code-in-text--packt">USERELATIONSHIP</code> takes two arguments, which are references to the columns between which the relationship is defined that must be activated. For example, if the active relationship between the <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">Date</code> tables is on <code class="code-in-text--packt">fSales[OrderDate]</code>, but you want to use the relationship on <code class="code-in-text--packt">fSales[InvoiceDate]</code> instead, this is the formula to do that:</p>
    <pre class="programlisting"><code class="hljs-code">TotalInvoiced = 
CALCULATE(
    [Sales], 
    USERELATIONSHIP(fSales[InvoiceDate], 'Date'[Date])
)
</code></pre>
    <p class="book-title--packt">It should be clear that the meaning of the calculated results changes when you use another relationship. While the <code class="code-in-text--packt">Sales</code> measure returns the amount ordered, the <code class="code-in-text--packt">TotalInvoiced</code> measure returns the amount invoiced. The former would be used for revenue analysis, while the latter may help in cashflow analysis (in which calculations on actual payments would be a crucial addition). This depends, of course, on the business definitions in the organization of what sales actually are.</p>
    <p class="book-title--packt">Another way of changing relationship behavior is to change the filter propagation behavior of the active relationship. The DAX function for this is <code class="code-in-text--packt">CROSSFILTER</code>, which is, again, used in a filter argument in <code class="code-in-text--packt">CALCULATE</code>. </p>
    <p class="book-title--packt">Like <code class="code-in-text--packt">USERELATIONSHIP</code>, <code class="code-in-text--packt">CROSSFILTER</code> takes the two columns involved in a relationship as arguments. In a third argument, you can set the filter propagation direction, or cross filter type, of the <a id="calibre_link-1434" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationship. There are five cross filter types that can be used:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">OneWay</strong>: Propagate filters in the default direction: from the table with the primary (unique) key to the table holding the foreign (non-unique) key.</li>
      <li class="bullet"><strong class="screentext">Both</strong>: Propagate filters in both directions.</li>
      <li class="bullet"><strong class="screentext">None</strong>: Do not propagate filters at all.</li>
      <li class="bullet"><strong class="screentext">OneWay_LeftFiltersRight</strong>: Propagate filters in one direction, from the column in the first argument to the column in the second argument.</li>
      <li class="bullet"><strong class="screentext">OneWay_RightFiltersLeft</strong>: Propagate filters in one direction, from the column in the second argument to the column in the first argument. </li>
    </ul>
    <p class="book-title--packt">To give an example of the use of <code class="code-in-text--packt">CROSSFILTER</code>, suppose you want to know to how many states products were sold. The model contains relationships between the <code class="code-in-text--packt">fSales</code>, <code class="code-in-text--packt">Cities</code>, and <code class="code-in-text--packt">Date</code> tables:</p>
    <figure class="mediaobject"><img src="images/000130.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 1.4.10: Model diagram for sales by city</p>
    <p class="book-title--packt">From the model <a id="calibre_link-1435" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>diagram, notice that we could select a month, and all sales transactions in that month would be selected through the active relationship. We cannot directly count the number of states, however: the relationship between <code class="code-in-text--packt">Cities</code> and <code class="code-in-text--packt">fSales</code> only propagates filters from <code class="code-in-text--packt">Cities</code> to <code class="code-in-text--packt">fSales</code>, while we need filter propagation in the other direction. In that case, the selected rows in the <code class="code-in-text--packt">fSales</code> table would lead to the corresponding rows in the <code class="code-in-text--packt">Cities</code> table being selected, and we could then count the number of states.</p>
    <p class="book-title--packt">Clearly, the filter propagation direction of the relationship must be changed. The DAX formula is this:</p>
    <pre class="programlisting"><code class="hljs-code">StatesSoldTo =
CALCULATE(
    DISTINCTCOUNT(Cities[State]),
    CROSSFILTER(fSales[CityID], Cities[CityID], Both)
)
</code></pre>
    <p class="book-title--packt">With the <code class="code-in-text--packt">DISTINCTCOUNT</code> function, we <a id="calibre_link-1611" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>count the unique values in the <code class="code-in-text--packt">State</code> column. But before that is done, <code class="code-in-text--packt">CROSSFILTER</code> causes a selection of rows in the <code class="code-in-text--packt">Cities</code> table based on which rows <a id="calibre_link-1612" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are selected in the <code class="code-in-text--packt">fSales</code> table. </p>
    <h1 id="calibre_link-79" class="title">Table functions in DAX</h1>
    <p class="book-title--packt">There is a lot you can do <a id="calibre_link-615" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with basic<a id="calibre_link-1291" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> aggregation functions <a id="calibre_link-1335" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>like <code class="code-in-text--packt">SUM</code> and <code class="code-in-text--packt">AVERAGE</code>, in combination with DAX filtering using <code class="code-in-text--packt">CALCULATE</code>. But the DAX language goes beyond that. This section is about table functions, which open up an ocean of more advanced calculations in DAX. In <em class="italic">Part 2</em> of this book, you will find that many of the business scenarios discussed involve DAX table functions. </p>
    <h2 id="calibre_link-80" class="calibre8">Table aggregations</h2>
    <p class="book-title--packt">To start, let's look <a id="calibre_link-1343" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>closely at a simple aggregation in DAX:</p>
    <pre class="programlisting"><code class="hljs-code">Sales1 = SUM(fSales[SalesAmount])
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">SUM</code> function in this formula traverses the <code class="code-in-text--packt">fSales</code> table and retrieves the value in the <code class="code-in-text--packt">SalesAmount</code> column from each row. All these values are summed up to provide the end result. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Because of the special way a Power BI model encodes and stores data (see <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>), this may not be what happens technically. Logically, however, this is what <code class="code-in-text--packt">SUM</code> does, and that is what we are interested in here.</p>
    </div>
    <p class="book-title--packt">Now, suppose the <code class="code-in-text--packt">SalesAmount</code> column is a calculated column, created with the following formula:</p>
    <pre class="programlisting"><code class="hljs-code">SalesAmount = fSales[UnitAmount] * fSales[SalesPrice]
</code></pre>
    <p class="book-title--packt">As both the <code class="code-in-text--packt">UnitAmount</code> and <code class="code-in-text--packt">SalesPrice</code> columns are in the <code class="code-in-text--packt">fSales</code> table as well, a valuable question to ask is: can we calculate sales without using the <code class="code-in-text--packt">SalesAmount</code> column? After all, we strongly prefer not to have calculated columns in the model. The calculation we are looking for should again traverse the <code class="code-in-text--packt">fSales</code> table, but instead of retrieving the value in the <code class="code-in-text--packt">SalesAmount</code> column, it <a id="calibre_link-1317" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>should take the values from the <code class="code-in-text--packt">UnitAmount</code> and <code class="code-in-text--packt">SalesPrice</code> columns and multiply one by the other. The DAX function to use here is <code class="code-in-text--packt">SUMX</code>:</p>
    <pre class="programlisting"><code class="hljs-code">Sales2 =
SUMX(
    fSales,
    fSales[UnitAmount] * fSales[SalesPrice]
)
</code></pre>
    <p class="book-title--packt">While the <code class="code-in-text--packt">SUM</code> function <a id="calibre_link-1344" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>only accepts a column reference as its argument, <code class="code-in-text--packt">SUMX</code> needs to be provided with a table, <code class="code-in-text--packt">fSales</code> in the example above, and in the second argument, an expression to be calculated for each row in the table. We <a id="calibre_link-1333" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>call <code class="code-in-text--packt">SUMX</code> a <strong class="screentext">table aggregation function</strong>; you may <a id="calibre_link-364" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>also encounter the name <strong class="screentext">iterator</strong>, as <code class="code-in-text--packt">SUMX</code> iterates over the table in its first argument.</p>
    <p class="book-title--packt">Most basic aggregation functions have a table aggregation equivalent, like <code class="code-in-text--packt">SUMX</code>, <code class="code-in-text--packt">AVERAGEX</code>, <code class="code-in-text--packt">MINX</code>, <code class="code-in-text--packt">MAXX</code>, <code class="code-in-text--packt">COUNTX</code>, <code class="code-in-text--packt">COUNTAX</code>, <code class="code-in-text--packt">PRODUCTX</code>, and <code class="code-in-text--packt">CONCATENATEX</code>. As is obvious from this list, table aggregation functions are recognized by the <code class="code-in-text--packt">X</code> at the end of the function name. Lesser-known table aggregation functions include statistical functions like <code class="code-in-text--packt">MEDIANX</code>, <code class="code-in-text--packt">PERCENTILEX</code>, and <code class="code-in-text--packt">STDEVX</code> (the last two functions come in two flavors, which we will not elaborate on here).</p>
    <p class="book-title--packt">A simple table aggregation <a id="calibre_link-506" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>function is <code class="code-in-text--packt">COUNTROWS</code>, which returns the number of rows in a table and has no non-table equivalent. The function <code class="code-in-text--packt">RANKX</code> is <a id="calibre_link-1193" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the table<a id="calibre_link-1192" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> equivalent of the <code class="code-in-text--packt">RANK.EQ</code> function.</p>
    <p class="book-title--packt">The example above is helpful if you want to eliminate calculated columns. But the real power of table aggregation functions lies in the fact that you can use any table you want as the first argument. For example, suppose you want to create a measure that returns the average sales per city. For this, the calculation should not iterate over&nbsp;the <code class="code-in-text--packt">fSales</code> table, which contains individual sales transactions, but over the <code class="code-in-text--packt">Cities</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">SalesPerCity =
AVERAGEX(
    Cities,
    [Sales]
)
</code></pre>
    <p class="book-title--packt">We will discuss what happens exactly in this calculation, but let us first further elaborate on the tables that can be used. Not only can any table in the model be used in a table aggregation function, but <a id="calibre_link-1345" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>you can even create your own specific tables to work with. We call these <strong class="screentext">virtual tables</strong> (as <em class="italic">calculated tables</em> is already taken by the Power BI model).</p>
    <h2 id="calibre_link-81" class="calibre8">Using virtual tables</h2>
    <p class="book-title--packt">In the <a id="calibre_link-1346" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>previous <a id="calibre_link-1497" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>section, you saw a formula to calculate the average sales per city. Now, suppose we want to compute the average sales per state. With the same approach as the <code class="code-in-text--packt">SalesPerCity</code> measure, we would need a table with one row for each state to iterate over. This table is not readily available in the model, as <code class="code-in-text--packt">State</code> is just a column in the <code class="code-in-text--packt">Cities</code> table. We must therefore construct this table ourselves, and although in this simple case we could add a <code class="code-in-text--packt">State</code> table to the model (as a calculated table, for instance), the preferred way to do it is by creating a <strong class="screentext">virtual table</strong>. This table will only exist during the evaluation of the measure.</p>
    <p class="book-title--packt">There is a broad set of DAX functions available to create virtual tables. The general complexity of working with these functions is that their result is a table. This means that there is no standard output mechanism available to view the results, like how you can create a Power BI visual to view the results of a DAX <a id="calibre_link-1454" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>measure. Creating a calculated table in the Power BI model with the same function could be helpful, but in any case, working with DAX table functions requires a certain level of abstract thinking.</p>
    <p class="book-title--packt">To start with our state challenge, the function <code class="code-in-text--packt">VALUES</code> takes a column reference as its argument and returns a table with unique values from that column. For example:</p>
    <pre class="programlisting"><code class="hljs-code">VALUES(Cities[State])
</code></pre>
    <p class="book-title--packt">This table expression returns a table with the unique <code class="code-in-text--packt">State</code> values. An equivalent function is <code class="code-in-text--packt">DISTINCT</code>, which also returns unique values from a column; the difference is that <code class="code-in-text--packt">DISTINCT</code> does not include a blank value in the blank row coming from an incomplete relationship (see <em class="italic">Figure 1.2.5</em> in <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>). It is up to you to decide whether or not that blank value should be in the result.</p>
    <p class="book-title--packt">The formula for sales per state is:</p>
    <pre class="programlisting"><code class="hljs-code">SalesPerState =
AVERAGEX(
    VALUES(Cities[State]),
    [Sales]
)
</code></pre>
    <p class="book-title--packt">There is a <a id="calibre_link-1347" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>whole <a id="calibre_link-1294" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>group of DAX functions<a id="calibre_link-1498" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> returning tables, which we will not list here comprehensively. The most commonly used functions are below:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">SUMMARIZE</code>: Although<a id="calibre_link-671" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> this is a very versatile and <a id="calibre_link-1316" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>complex function that is able to generate complete pivot table-like results, this is not the way <code class="code-in-text--packt">SUMMARIZE</code> is used within DAX measures. This function is very useful as an extension to <code class="code-in-text--packt">VALUES</code>: while <code class="code-in-text--packt">VALUES</code> returns <a id="calibre_link-1381" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the unique values in one column, <code class="code-in-text--packt">SUMMARIZE</code> can return the unique combinations of values in more than one column. For example, the unique combinations of <code class="code-in-text--packt">CityID</code> and <code class="code-in-text--packt">ProductID</code> values from the <code class="code-in-text--packt">fSales</code> table can be retrieved with the following (note that you have to provide the table itself in the first argument):
        <pre class="programlisting"><code class="hljs-code">SUMMARIZE(fSales, fSales[CityID], fSales[ProductID])
</code></pre>
      </li>
      <li class="bullet"><code class="code-in-text--packt">FILTER</code>: This function<a id="calibre_link-659" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> has <a id="calibre_link-741" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>two arguments: the first is a table (either an existing table in the model or the result of <a id="calibre_link-1455" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>another table function), and the second is an expression that is evaluated for each row in the table. The expression should result in either true or false, and <code class="code-in-text--packt">FILTER</code> includes only the "true" rows in the result. For instance, the expression below returns cities in Germany:
        <pre class="programlisting"><code class="hljs-code">FILTER(Cities, Cities[Country] = "Germany")
</code></pre>
      </li>
      <li class="bullet"><code class="code-in-text--packt">TOPN</code>: Like <code class="code-in-text--packt">FILTER</code>, <code class="code-in-text--packt">TOPN</code> returns a<a id="calibre_link-672" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> subset of the rows of a<a id="calibre_link-1388" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> table. The highest, or lowest, rows of a table are returned, based on some criteria. You provide the number of rows, the table from which to take the rows, the value on which to rank each row, and whether you want them to be sorted from high to low or low to high. For instance, to create a table with the 15 customers that have the highest sales:
        <pre class="programlisting"><code class="hljs-code">TOPN(15, Customers, [Sales], DESC)
</code></pre>
      </li>
      <li class="bullet"><code class="code-in-text--packt">CROSSJOIN</code>: These<a id="calibre_link-658" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> functions create a single table<a id="calibre_link-532" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> from two input tables. <code class="code-in-text--packt">CROSSJOIN</code> returns a table that simply contains a row for each combination of rows from the input tables. The example below returns a table with all combinations of products and cities, containing all the columns from the <code class="code-in-text--packt">Cities</code> and <code class="code-in-text--packt">Products</code> tables:
        <pre class="programlisting"><code class="hljs-code">CROSSJOIN(Cities, Products)
</code></pre>
      </li>
      <li class="bullet"><code class="code-in-text--packt">GENERATE</code>: Like <code class="code-in-text--packt">CROSSJOIN</code>, this<a id="calibre_link-660" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function returns a <a id="calibre_link-1613" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table that is a combination of input tables. In this case, the second argument is a table expression that is evaluated for each row in the table in the first argument. If this expression happens to return an empty <a id="calibre_link-848" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table for a specific row, that row is not included in the result. Alternatively, you can use <code class="code-in-text--packt">GENERATEALL</code>, which does include such a row, but with blank values in the <a id="calibre_link-357" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>columns of the table expression. For example, the expression below returns a table with cities and products that have been sold to customers in those cities, again including all the columns from the <code class="code-in-text--packt">Cities</code> and <code class="code-in-text--packt">Products</code> tables:
        <pre class="programlisting"><code class="hljs-code">GENERATE(Cities, FILTER(Products, [Sales] &gt; 0))
</code></pre>
      </li>
    </ul>
    <p class="book-title--packt">You will <a id="calibre_link-1348" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>encounter a few other table functions in <em class="italic">Part 2</em>, which we will introduce when we need them. </p>
    <h2 id="calibre_link-82" class="calibre8">Context in table functions</h2>
    <p class="book-title--packt">The <code class="code-in-text--packt">GENERATE</code> example <a id="calibre_link-1336" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>above may be intuitively clear, but if you look closer, it is really a quite complicated example. To understand <a id="calibre_link-849" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>what an expression like this one does, it is important to know how DAX context works in table functions. Let's use the <code class="code-in-text--packt">GENERATE</code> example in a complete measure formula:</p>
    <pre class="programlisting"><code class="hljs-code">AvgUnitAmount1 =
AVERAGEX(
    GENERATE(
        Cities,
        FILTER(
            Products,
            [Sales] &gt; 10000
        )
    ),
    AVERAGE(fSales[UnitAmount])
)
</code></pre>
    <p class="book-title--packt">The purpose of this measure is to calculate the average number of products sold per sales transaction (the <code class="code-in-text--packt">UnitAmount</code>) for all sales <a id="calibre_link-742" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>transactions on products in cities where those products sold more than 10,000. Can you spot the errors in this formula?</p>
    <p class="book-title--packt">When we use this measure<a id="calibre_link-1614" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in a Power BI visual, it is evaluated in a query context. This context can be anything; it may contain one or more filters on columns in the Power BI model. </p>
    <p class="book-title--packt">The <code class="code-in-text--packt">AVERAGEX</code> function has two arguments, and these arguments are themselves evaluated in different contexts:</p>
    <ul class="calibre9">
      <li class="bullet">The first argument, a table expression, is evaluated in the same context as the <code class="code-in-text--packt">AVERAGEX</code> function itself.</li>
      <li class="bullet">The second argument, a scalar expression, is evaluated <em class="italic">in row context</em> for every row in the table in the first argument.</li>
    </ul>
    <p class="book-title--packt">You may have already noticed this from the <code class="code-in-text--packt">Sales2</code> measure discussed earlier, which uses direct column <a id="calibre_link-850" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>references in the second <a id="calibre_link-1456" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>argument of <code class="code-in-text--packt">SUMX</code>. The row context here provides the possibility of directly using <a id="calibre_link-743" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>columns in the table to calculate with. In fact, the row context is stacked on top of the query context, while in the row context in a calculated column, there are <a id="calibre_link-1382" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>no filters at all; in this case, the filters from the query context are still there.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Common errors made when using virtual tables are related to row context in table aggregation functions. A simple example is below:</p>
      <pre class="programlisting"><code class="hljs-code">ThisDoesntWork =
SUMX(
    VALUES(fSales[UnitAmount]),
    fSales[Tax]
)
</code></pre>
      <p class="book-title--packt">While this formula uses two columns from the <code class="code-in-text--packt">fSales</code> table, the <code class="code-in-text--packt">Tax</code> column cannot be directly referenced as the row context is not in the <code class="code-in-text--packt">fSales</code> table, but in the result of the <code class="code-in-text--packt">VALUES</code> function. This result is a table with only one column, <code class="code-in-text--packt">fSales[UnitAmount]</code>; only this column can be used directly.</p>
    </div>
    <p class="book-title--packt">The table functions <code class="code-in-text--packt">FILTER</code>, <code class="code-in-text--packt">TOPN</code>, and <code class="code-in-text--packt">GENERATE</code> discussed above work in the same way: the table argument is evaluated in the context in which the function is called; the other argument is evaluated in a row context. In the case of <code class="code-in-text--packt">GENERATE</code>, this means that we have a table expression evaluated in a row context. </p>
    <p class="book-title--packt">For the <a id="calibre_link-1337" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>formula for <code class="code-in-text--packt">AvgUnitAmount1</code> above, we have a whole stack of contexts that come into play. Let's break them down step by step:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1"><code class="code-in-text--packt">AVERAGEX</code>: Evaluated in query context.</li>
      <li class="calibre12"><code class="code-in-text--packt">GENERATE</code>: Evaluated in the same context as <code class="code-in-text--packt">AVERAGEX</code>.</li>
      <li class="calibre12"><code class="code-in-text--packt">Cities</code>: Still evaluated in the same context.</li>
      <li class="calibre12"><code class="code-in-text--packt">FILTER</code>: Evaluated in row context in the <code class="code-in-text--packt">Cities</code> table.</li>
      <li class="calibre12"><code class="code-in-text--packt">Products</code>: Evaluated in the same context as <code class="code-in-text--packt">FILTER</code>.</li>
      <li class="calibre12"><code class="code-in-text--packt">[Sales]</code>: As this is a call to another measure, an implicit <code class="code-in-text--packt">CALCULATE</code> causes a filter context to be created. For each call, we are at one row in <code class="code-in-text--packt">Cities</code> and one row in <code class="code-in-text--packt">Products</code>. In the filter context, filters on each column in the <code class="code-in-text--packt">Cities</code> and <code class="code-in-text--packt">Products</code> tables are added. The result is thus the sales for that product, in that city.</li>
      <li class="calibre12"><code class="code-in-text--packt">AVERAGE</code>: This is evaluated in row context in the table returned by <code class="code-in-text--packt">GENERATE</code>, which is a subset of combinations of cities and products.</li>
    </ol>
    <p class="book-title--packt">So where is the error in this formula? </p>
    <p class="book-title--packt">It is in the last step: although this step is <a id="calibre_link-851" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>evaluated for the correct combinations of cities and products, it is evaluated in row context. <a id="calibre_link-358" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>This means that only the filters already present in the query context have an impact on the <code class="code-in-text--packt">AVERAGE</code> calculation. The current city and product do not impact <a id="calibre_link-744" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the calculation, as there are no (additional) filters on the <code class="code-in-text--packt">Cities</code> and <code class="code-in-text--packt">Products</code> tables to select the current city and product. The way to solve this problem is to turn the row context into a filter context, just like what was done in <em class="italic">step 6</em>. We can do this by adding <code class="code-in-text--packt">CALCULATE</code>:</p>
    <pre class="programlisting"><code class="hljs-code">AvgUnitAmount2 =
AVERAGEX(
    GENERATE(
        Cities,
        FILTER(
            Products,
            [Sales] &gt; 10000
        )
    ),
    <span><strong class="hljs-slc">CALCULATE</strong></span><code class="codehighlighted">(</code>AVERAGE(fSales[UnitAmount])<code class="codehighlighted">)</code>
)
</code></pre>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">In most cases, it would be better to put the average unit amount calculation in a separate measure, as this will probably be needed elsewhere. You then have to write the logic of the calculation only once, and the call to this measure would take care of the row context transition automatically.</p>
    </div>
    <p class="book-title--packt">In designing <a id="calibre_link-1338" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>more complex measures in DAX, it is crucial to meticulously keep track of context and context transformations.</p>
    <p class="book-title--packt">There is another, mathematical error in this formula: we calculate the average over the city/product combinations of the average unit amount. This is not necessarily equal to the average unit amount of all sales transactions for these city/product combinations. To solve this, we need<a id="calibre_link-1339" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to use a <a id="calibre_link-1457" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>different approach; but let us focus on performance first.</p>
    <h2 id="calibre_link-83" class="calibre8">Performance considerations using table functions</h2>
    <p class="book-title--packt">There are a couple <a id="calibre_link-1340" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of things to keep in mind when using virtual tables in DAX. The overall goal is always to <a id="calibre_link-852" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>provide results as fast as possible, so performance should always be a consideration.</p>
    <p class="book-title--packt">First, it is important to realize that virtual tables need to be constructed in memory by the DAX engine. This means that the larger the virtual table, the more memory is needed and the higher the risk of lower <a id="calibre_link-745" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>performance. You may even run into <strong class="screentext">Not enough memory to perform this calculation</strong> errors. For this reason, you should ask yourself whether the table you use could be made smaller: specifically, do you need all the columns included in the table?</p>
    <p class="book-title--packt">In the <code class="code-in-text--packt">AvgUnitAmount2</code> measure above, this is clearly not the case. The virtual table created by <code class="code-in-text--packt">GENERATE</code> contains all columns from both the <code class="code-in-text--packt">Cities</code> and the <code class="code-in-text--packt">Products</code> table. But for the result of the calculation, <a id="calibre_link-359" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>only the unique keys in the tables are really needed: they determine which rows in <code class="code-in-text--packt">fSales</code> are selected, and thus determine the value of the <code class="code-in-text--packt">Sales</code> measure. An<a id="calibre_link-1615" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> optimized version would be:</p>
    <pre class="programlisting"><code class="hljs-code">AvgUnitAmount3 =
AVERAGEX(
    GENERATE(
        VALUES(Cities[CityID]),
        FILTER(
            VALUES(Products[ProductID]),
            [Sales] &gt; 10000
        )
    ),
    CALCULATE(AVERAGE(fSales[UnitAmount]))
)
</code></pre>
    <p class="book-title--packt">The second thing to consider is the number of rows in the virtual table. While this is obviously also a factor in the total size of the table, it determines the number of iterations in a table aggregation as well. </p>
    <p class="book-title--packt">For instance, if the purchasing price of a product is <a id="calibre_link-1458" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>stored in the <code class="code-in-text--packt">Products</code> table, you could calculate the total purchasing amount based on the <code class="code-in-text--packt">fSales</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">TotalPurchased1 =
SUMX(
    fSales,
    fSales[UnitAmount] * RELATED(Products[PurchasePrice])
)
</code></pre>
    <p class="book-title--packt">Instead, you could optimize the number of iterations by letting <code class="code-in-text--packt">SUMX</code> iterate over the <code class="code-in-text--packt">Products</code> table instead of the <code class="code-in-text--packt">fSales</code> table. Or even better, iterate over the unique <code class="code-in-text--packt">PurchasePrice</code> values:</p>
    <pre class="programlisting"><code class="hljs-code">TotalPurchased2 =
SUMX(
    VALUES(Products[PurchasePrice]),
    Products[PurchasePrice] * CALCULATE(SUM(fSales[UnitAmount]))
)
</code></pre>
    <p class="book-title--packt">In this variant, all transactions corresponding to a <code class="code-in-text--packt">PurchasePrice</code> value are aggregated at once. Mind the <code class="code-in-text--packt">CALCULATE</code> here to go from row context to filter context and filter the correct sales transactions.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Memory usage and the number of iterations is a reason why the <code class="code-in-text--packt">CROSSJOIN</code> function<a id="calibre_link-1341" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is often not an attractive function to use in DAX measures. The number of rows returned by <code class="code-in-text--packt">CROSSJOIN</code> can be huge, which can easily lead to <a id="calibre_link-526" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>memory problems. When you include <code class="code-in-text--packt">CROSSJOIN</code> in a table aggregation, like the following (<code class="code-in-text--packt">A</code> and <code class="code-in-text--packt">B</code> being two arbitrary table expressions):</p>
      <pre class="programlisting"><code class="hljs-code">SUMX(
    CROSSJOIN(A, B),
    [Sales]
)
</code></pre>
      <p class="book-title--packt">It is often more efficient to not use <code class="code-in-text--packt">CROSSJOIN</code> at all:</p>
      <pre class="programlisting"><code class="hljs-code">SUMX(
    A,
    SUMX(
        B,
        [Sales]
    )
)
</code></pre>
    </div>
    <p class="book-title--packt">A yet more efficient approach is not to iterate at all, but to use virtual tables for filtering instead. This is <a id="calibre_link-1342" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the topic of the next section.</p>
    <h1 id="calibre_link-84" class="title">Filtering with table functions</h1>
    <p class="book-title--packt">One of the<a id="calibre_link-1334" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> most <a id="calibre_link-788" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>profound insights when working with DAX is the deep connection between tables and filtering. In this section, you will learn what this connection is, and how to leverage it.</p>
    <h2 id="calibre_link-85" class="calibre8">Using CALCULATETABLE</h2>
    <p class="book-title--packt">As we<a id="calibre_link-789" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> discussed earlier in this chapter, table<a id="calibre_link-425" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> expressions used in table aggregation functions like <code class="code-in-text--packt">SUMX</code> are evaluated in the same context as the table aggregation function itself. This is not always what you want: sometimes, you need a different context. DAX provides a function <a id="calibre_link-1459" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for precisely this purpose: <code class="code-in-text--packt">CALCULATETABLE</code>.</p>
    <p class="book-title--packt">Like its cousin <code class="code-in-text--packt">CALCULATE</code>, <code class="code-in-text--packt">CALCULATETABLE</code> changes context before evaluating an expression. In <code class="code-in-text--packt">CALCULATE</code>, this expression must return a scalar value; in <code class="code-in-text--packt">CALCULATETABLE</code>, it must be a table expression. Apart <a id="calibre_link-365" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from that, the function works with the same four-step process:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">Set up a filter context.</li>
      <li class="calibre12">Remove existing filters from columns or tables referred to in the filter arguments.</li>
      <li class="calibre12">Add new filters as specified in the filter arguments.</li>
      <li class="calibre12">Evaluate the table expression in the first argument.</li>
    </ol>
    <p class="book-title--packt">Often, <code class="code-in-text--packt">CALCULATE</code> and <code class="code-in-text--packt">CALCULATETABLE</code> can be used interchangeably. Take, for instance, the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">AveragePerCity_Canada1 =
AVERAGEX(
    CALCULATETABLE(
        VALUES(Cities[CityID]),
        Cities[Country] = "Canada"
    ),
    [Sales]
)
</code></pre>
    <p class="book-title--packt">You can rewrite <a id="calibre_link-790" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this measure as a<a id="calibre_link-426" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> straightforward <code class="code-in-text--packt">CALCULATE</code> formula:</p>
    <pre class="programlisting"><code class="hljs-code">AveragePerCity_Canada2 =
CALCULATE(
    AVERAGEX(
        VALUES(Cities[CityID]),
        [Sales]
    ),
    Cities[Country] = "Canada"
)
</code></pre>
    <p class="book-title--packt">Both calculations return the average sales per city for <code class="code-in-text--packt">Cities</code> in Canada (depending on the query context, of course). But be warned: there are technical differences between the two. In the first formula, the <code class="code-in-text--packt">Cities[Country] = "Canada"</code> filter is applied to the evaluation of the <code class="code-in-text--packt">Cities</code> table, while in the second formula, the filter is applied to both the <code class="code-in-text--packt">Cities</code> table and the <code class="code-in-text--packt">Sales</code> measure evaluations. While this difference does not impact the <a id="calibre_link-366" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>results of <a id="calibre_link-1460" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the measure in this case, you may use more advanced measures instead of <code class="code-in-text--packt">Sales</code> that are impacted by this difference.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Like <code class="code-in-text--packt">CALCULATE</code>, <code class="code-in-text--packt">CALCULATETABLE</code> creates a filter context. When used in a calculated column, in each row new filters are added to select that row. When evaluating a related table in the new context, the relationship now has filters to propagate and the related table will be filtered to only the rows that are linked to the current row. This is why the <code class="code-in-text--packt">RELATEDTABLE</code> function, which is used to retrieve the related part of another table, is nothing more than the <code class="code-in-text--packt">CALCULATETABLE</code> function without filter arguments.</p>
    </div>
    <p class="book-title--packt">Using <code class="code-in-text--packt">CALCULATETABLE</code>, it is <a id="calibre_link-1616" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>possible to add<a id="calibre_link-1617" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filters to table evaluations. Interestingly, you can use tables to add filters as well.</p>
    <h2 id="calibre_link-86" class="calibre8">Filters and tables</h2>
    <p class="book-title--packt">Now that we <a id="calibre_link-791" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have covered table functions, it is time to go back and take a new look at filters. Earlier, we introduced filters in query and filter context as "rules" on columns in the Power BI model, like "<code class="code-in-text--packt">Cities[Country]</code><em class="italic"> must equal France or Germany</em>." You can view this rule as providing the values that the <code class="code-in-text--packt">Country</code> column should contain; or, taking yet another perspective, view it as a single-column table with two rows, containing <code class="code-in-text--packt">"France"</code> and <code class="code-in-text--packt">"Germany"</code>. </p>
    <p class="book-title--packt">In fact, this is exactly how filters work, and how the <code class="code-in-text--packt">CALCULATE</code> function works: by adding tables that define which values in columns are selected, possibly replacing existing tables that implement a filter. The foundational principle is this:</p>
    <blockquote class="packt_quote pcalibre7">Every filter is a table, and every table can be used as a filter.</blockquote>
    <p class="book-title--packt">This principle means that any simple filter argument in <code class="code-in-text--packt">CALCULATE</code> can be rewritten as a table. Consider, for instance, the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">SalesFranceGermany =
CALCULATE(
    [Sales],
    Cities[Country] IN {"France", "Germany"}
)
</code></pre>
    <p class="book-title--packt">The filter argument here is the equivalent of the table expression below:</p>
    <pre class="programlisting"><code class="hljs-code">FILTER(
    ALL(Cities[Country]),
    Cities[Country] IN {"France", "Germany"}
)
</code></pre>
    <p class="book-title--packt">So, the meaning of this filter is <a id="calibre_link-746" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>literally: of all the <code class="code-in-text--packt">Country</code> values, select only <code class="code-in-text--packt">"France"</code> and <code class="code-in-text--packt">"Germany"</code>. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">This explains why a formula like the one below works:</p>
      <pre class="programlisting"><code class="hljs-code">CALCULATE(
    [Sales],
    Cities[Country] = "France"
    || Cities[Country] = "Germany"
)
</code></pre>
      <p class="book-title--packt">Although<a id="calibre_link-792" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> this is not the simplest filter argument, it is just the equivalent of:</p>
      <pre class="programlisting"><code class="hljs-code">FILTER(
    ALL(Cities[Country]),
    Cities[Country] = "France"
    || Cities[Country] = "Germany"
)
</code></pre>
    </div>
    <p class="book-title--packt">Most of the DAX functions we introduced as filter functions are really table functions, as you can already see from the <code class="code-in-text--packt">FILTER</code> expression above, which uses <code class="code-in-text--packt">ALL</code> as a table function. Indeed the <code class="code-in-text--packt">ALL</code> functions are table functions: <code class="code-in-text--packt">ALL(Cities[Country])</code> is a one-column table containing all unique countries, and <code class="code-in-text--packt">ALL(Cities[Country], Cities[State])</code> is a two-column table containing all unique combinations of country <a id="calibre_link-942" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and state that are found in the <code class="code-in-text--packt">Cities</code> table.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Not all functions used in filter arguments are table functions: <code class="code-in-text--packt">USERELATIONSHIP</code> and <code class="code-in-text--packt">CROSSFILTER</code> change relationship behavior and do not create tables. <code class="code-in-text--packt">KEEPFILTERS</code> changes the behavior of <code class="code-in-text--packt">CALCULATE</code>, but cannot be used to create a table. <code class="code-in-text--packt">REMOVEFILTERS</code>, which functions like <code class="code-in-text--packt">ALL</code> in a filter argument, cannot be used to create a table.</p>
    </div>
    <p class="book-title--packt">Even the time intelligence functions are table <a id="calibre_link-595" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>functions when we exclude the shortcut versions like <code class="code-in-text--packt">TOTALYTD</code>. Each creates a one-column table containing the dates in the specified period. This means that you could use <a id="calibre_link-747" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>these <a id="calibre_link-1415" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>functions in table aggregation functions, for example, to <a id="calibre_link-367" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculate the year-to-date average sales per day:</p>
    <pre class="programlisting"><code class="hljs-code">AverageSalesPerDay_YTD =
AVERAGEX(
    DATESYTD('Date'[Date]),
    [Sales]
)
</code></pre>
    <p class="book-title--packt">The more exciting <a id="calibre_link-793" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use of the <em class="italic">filter is table</em> principle is that you can use any (virtual) table as a filter within a <code class="code-in-text--packt">CALCULATE</code> function. <a id="calibre_link-297" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>As an easy example, suppose you want to have a measure that returns the total sales in the country or countries your selected <code class="code-in-text--packt">Cities</code> are in. If you are sure that in the query context for this calculation, the <code class="code-in-text--packt">Country</code> column is filtered, then the formula is not difficult:</p>
    <pre class="programlisting"><code class="hljs-code">SalesWholeCountry1 =
CALCULATE(
    [Sales],
    ALLEXCEPT(Cities, Cities[Country])
)
</code></pre>
    <p class="book-title--packt">This calculation removes all the filters from the <code class="code-in-text--packt">Cities</code> table, except for from the <code class="code-in-text--packt">Country</code> column. So, if the query context contains the filters "<em class="italic">City is Atlanta</em>" and "<em class="italic">Country is United States</em>," the resulting filter context has only the filter "<em class="italic">Country is United States</em>" left. </p>
    <p class="book-title--packt">However, if the query context has only the filter "<em class="italic">City is Atlanta</em>" to begin with, we are in trouble: removing this filter gives us the whole world! To solve this, we need to "reinject" a "<em class="italic">Country is United States</em>" filter into the <a id="calibre_link-1461" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>context, and it should be derived from the <code class="code-in-text--packt">City</code> filter. This <a id="calibre_link-1383" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can be done with a table filter:</p>
    <pre class="programlisting"><code class="hljs-code">SalesWholeCountry2 =
CALCULATE(
    [Sales],
    ALL(Cities),
    VALUES(Cities[Country])
)
</code></pre>
    <p class="book-title--packt">To see what is happening here, it is important to realize that <em class="italic">filter arguments are evaluated in the same context as the </em><code class="code-in-text--packt">CALCULATE</code><em class="italic"> table itself</em>. In a query context where only one city is selected, the <code class="code-in-text--packt">VALUES(Cities[Country])</code> expression returns a single-column table with the country that city is in. This is exactly the filter that we need to implement the required calculation.</p>
    <p class="book-title--packt">As another example, the formula below calculates the sales amount of the 10,000 largest customers:</p>
    <pre class="programlisting"><code class="hljs-code">SalesLargestCustomers1 =
CALCULATE(
    [Sales],
    TOPN(10000, ALL(Customers), [Sales], DESC)
)
</code></pre>
    <p class="book-title--packt">Note that we <a id="calibre_link-794" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use <code class="code-in-text--packt">ALL(Customers)</code> here to be sure that we don't have filters in the query context limiting the customers we are considering. The <code class="code-in-text--packt">TOPN</code> function returns the 10,000 largest customers (as a subset of the <code class="code-in-text--packt">Customers</code> table, including all columns &ndash; you may want to eliminate unneeded columns here!). This table is then used as a filter.</p>
    <p class="book-title--packt">This formula makes it clear why using table filters should be preferred over using table aggregations. Consider the table aggregation alternative for this measure:</p>
    <pre class="programlisting"><code class="hljs-code">SalesLargestCustomers2 =
SUMX(
    TOPN(10000, ALL(Customers), [Sales], DESC),
    [Sales]
)
</code></pre>
    <p class="book-title--packt">Now ask yourself: how many times is the <code class="code-in-text--packt">Sales</code> measure called in the evaluation of this calculation? It depends, of course, on the number of customers we have in our <code class="code-in-text--packt">Customers</code> table. Let's assume that we have 60,000 customers. The <code class="code-in-text--packt">TOPN</code> function must call <code class="code-in-text--packt">Sales</code> for each customer to determine <a id="calibre_link-1462" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>who the largest customers are. After that is done, the <code class="code-in-text--packt">SalesLargestCustomers1</code> measure only needs one additional call to <code class="code-in-text--packt">Sales</code>: the <code class="code-in-text--packt">TOPN</code> table is applied as a filter, creating <a id="calibre_link-748" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the context for the largest customers. The <code class="code-in-text--packt">SalesLargestCustomers2</code> measure, <a id="calibre_link-360" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>however, traverses the <code class="code-in-text--packt">TOPN</code> table and calls <code class="code-in-text--packt">Sales</code> for each row. In other <a id="calibre_link-1384" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>words, this measure calls <code class="code-in-text--packt">Sales</code> 70,000 times in total, whereas the <code class="code-in-text--packt">SalesLargestCustomers1</code> measure<a id="calibre_link-1390" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> only calls it 60,001 times! The DAX engine may optimize things here, but the difference will be significant.</p>
    <p class="book-title--packt">Using tables as filters becomes <a id="calibre_link-853" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>even more powerful when you realize that, unlike filters in a query context, table filters can have multiple columns. This means that we now have a solution for<a id="calibre_link-795" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> our problematic <code class="code-in-text--packt">AvgUnitAmount3</code> measure from earlier in this chapter:</p>
    <pre class="programlisting"><code class="hljs-code">AvgUnitAmount4 =
CALCULATE(
    AVERAGE(fSales[UnitAmount]),
    GENERATE(
        VALUES(Cities[CityID]),
        FILTER(
            VALUES(Products[ProductID]),
            [Sales] &gt; 10000
        )
    )
) 
</code></pre>
    <p class="book-title--packt">Instead of the average of averages that came with the table aggregation over the <code class="code-in-text--packt">GENERATE</code> expression, this time, we use <code class="code-in-text--packt">GENERATE</code> to provide a filter that selects combinations of cities and products that have sales over 10,000. We then calculate the average unit amount for all sales transactions that correspond to the selected city/product combinations. Not only do we now have the correct average calculation, but we have also eliminated iterating over the <code class="code-in-text--packt">GENERATE</code> table as well, which will help in further improving the performance of this measure.</p>
    <h2 id="calibre_link-87" class="calibre8">Using TREATAS</h2>
    <p class="book-title--packt">There is one<a id="calibre_link-796" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> important constraint when using table filters: the tables must effectively filter the tables over which the calculation is done. Just adding a table as a filter that has nothing to do whatsoever with the rest of the model will not do anything. </p>
    <p class="book-title--packt">For instance, the formula below does not return sales for the United Kingdom:</p>
    <pre class="programlisting"><code class="hljs-code">UKSales_wrong =
CALCULATE(
    [Sales],
    ROW("Country", "United Kingdom")
)
</code></pre>
    <p class="book-title--packt">Why does this not work? The Power BI model has no way to determine that with the arbitrary table created with the <code class="code-in-text--packt">ROW</code> function, which <a id="calibre_link-749" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>has a column named <code class="code-in-text--packt">Country</code>, it should filter the <code class="code-in-text--packt">Cities</code> table, which contains a <code class="code-in-text--packt">Country</code> column as well. You could say, "<em class="italic">well,</em> <em class="italic">the name is the same so the DAX engine could assume that this is what the formula is meant to do</em>"; but that would lead to <a id="calibre_link-854" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>very unpredictable results in models that may have the same column names in many different tables.</p>
    <p class="book-title--packt">To be able to be used as a filter, the DAX engine should be able to identify that the virtual table is connected to a table, or some <a id="calibre_link-1463" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>columns, from the model. This connection is <a id="calibre_link-966" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>called <strong class="screentext">lineage</strong>, and in short, it means that when creating a virtual table, DAX keeps track of what the original columns were where the columns in the virtual table originated from. Let's look at the <code class="code-in-text--packt">GENERATE</code> expression once again:</p>
    <pre class="programlisting"><code class="hljs-code">    GENERATE(
        VALUES(Cities[CityID]),
        FILTER(
            VALUES(Products[ProductID]),
            [Sales] &gt; 10000
        )
</code></pre>
    <p class="book-title--packt">It is clear that <code class="code-in-text--packt">Cities[CityID]</code> is a column in the model, and as <code class="code-in-text--packt">VALUES</code> takes the unique values from that column, <code class="code-in-text--packt">VALUES(Cities[CityID])</code> has lineage to it. In the same way, <code class="code-in-text--packt">VALUES(Products[ProductID])</code> has lineage to the <code class="code-in-text--packt">ProductID</code> column in the <code class="code-in-text--packt">Products</code> table. <code class="code-in-text--packt">GENERATE</code> creates <a id="calibre_link-1391" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a table containing combinations of values from the two <code class="code-in-text--packt">VALUES</code> expressions, so each column in the resulting table has lineage to the respective model column. </p>
    <p class="book-title--packt">Most table functions retain the lineage of the columns they provide. Some functions, however, allow for forming tables in a strange way, which can be problematic when it comes to lineage. For instance, the <code class="code-in-text--packt">UNION</code> function allows for combining tables by taking rows from two source tables that may have conflicting lineage. If so, columns in the result table do not have lineage to any existing column in the model.</p>
    <p class="book-title--packt">In some cases, you want the lineage of the virtual table to be different than it is by default. DAX offers a solution through the <code class="code-in-text--packt">TREATAS</code> function, which forces the model to consider the columns in a table to have a specific lineage. </p>
    <p class="book-title--packt"><code class="code-in-text--packt">TREATAS</code> is another example of a function that is exclusively used in <code class="code-in-text--packt">CALCULATE</code>, or <code class="code-in-text--packt">CALCULATETABLE</code>, filter arguments. The formula below<a id="calibre_link-797" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> correctly calculates UK sales (although there are easier ways to accomplish this):</p>
    <pre class="programlisting"><code class="hljs-code">UKSales_correct =
CALCULATE(
    [Sales],
    TREATAS(
          ROW("Country", "United Kingdom"),
          Cities[Country]
    )
)
</code></pre>
    <p class="book-title--packt">Note that <code class="code-in-text--packt">TREATAS</code> does not require the name of the column to be the same. We could have named the column in <a id="calibre_link-1392" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <code class="code-in-text--packt">ROW</code> expression anything we wanted. <code class="code-in-text--packt">TREATAS</code> works with multi-column tables as well; in this case, you should specify a model column for each column in the table. You can find a comprehensive example of the use of <code class="code-in-text--packt">TREATAS</code> in <em class="italic">Chapter 2.5</em>, <em class="italic">Intercompany Business</em>.</p>
    <h1 id="calibre_link-88" class="title">DAX variables</h1>
    <p class="book-title--packt">DAX table<a id="calibre_link-688" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> functions and filtering greatly enhance the complexity of calculations that can be done with DAX. The flip <a id="calibre_link-427" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>side is that formulas can become quite long. More importantly, with all the different contexts in play, it can be problematic to obtain correct results.</p>
    <p class="book-title--packt">DAX variables make life much easier when designing advanced DAX code. The name is somewhat odd, as the purpose of DAX variables is that you can evaluate something once, and use it later in other circumstances (other contexts, typically) without worrying about the evaluation of the variable. In other words, a DAX variable is used as a constant!</p>
    <p class="book-title--packt">A variable is declared using the <code class="code-in-text--packt">VAR</code> keyword. Multiple variables can be declared, and the declaration of a variable can use the value of another variable declared earlier. Declarations of variables are closed off by the <code class="code-in-text--packt">RETURN</code> keyword:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisValue = 5
RETURN
...
</code></pre>
    <p class="book-title--packt">It is good to know that DAX variables can be used in any expression in a DAX formula. A variable can contain a scalar value, but it can also be a table. The (rather ridiculous) formula below is correct DAX code:</p>
    <pre class="programlisting"><code class="hljs-code">VariableTest =
VAR Variable1 = 3
VAR Variable2 = Variable1 + 5
RETURN
CALCULATE(
    VAR Variable3 = MAX(fSales[UnitAmount])
    RETURN
    SUM(fSales[Tax]) + Variable2 + Variable3,
    VAR Variable4 = 4
    VAR TableVariable = 
          FILTER(
                 ALL(fSales[UnitAmount]),
                 fSales[UnitAmount] = Variable4
          )
    RETURN
    TableVariable
)
</code></pre>
    <p class="book-title--packt">The location of the variable declaration in the formula determines the context in which the variable is evaluated. For instance, the <code class="code-in-text--packt">Variable3</code> variable above is evaluated in the filter context formed by applying the <code class="code-in-text--packt">TableVariable</code> table filter to&nbsp;the original query context for this <a id="calibre_link-750" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>measure. If <code class="code-in-text--packt">Variable3</code> had been declared right after <code class="code-in-text--packt">Variable2</code>, it would have been evaluated in the query context. Note that&nbsp;<code class="code-in-text--packt">Variable4</code> and <code class="code-in-text--packt">TableVariable</code> are used in a filter<a id="calibre_link-689" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> argument of the <code class="code-in-text--packt">CALCULATE</code> function; both are evaluated in the original query context.</p>
    <p class="book-title--packt">Each variable has its own scope, which means that it cannot be used outside of the expression that it is declared in. In the formula above, <code class="code-in-text--packt">Variable3</code> cannot be used to define <code class="code-in-text--packt">TableVariable</code>; <code class="code-in-text--packt">Variable3</code> is the first argument of <code class="code-in-text--packt">CALCULATE</code> and outside of that, it is unknown. Conversely, <code class="code-in-text--packt">Variable4</code> and <code class="code-in-text--packt">TableVariable</code> cannot be used in the first argument of <code class="code-in-text--packt">CALCULATE</code>. <code class="code-in-text--packt">Variable1</code> and <code class="code-in-text--packt">Variable2</code> are part of the expression of the whole formula and can be used anywhere.</p>
    <p class="book-title--packt">DAX variables can help to simplify the flow of a calculation, but they can also make your formulas more readable, simply <a id="calibre_link-855" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>through the <a id="calibre_link-1464" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use of clear variable names. Let us revisit the <code class="code-in-text--packt">AvgUnitAmount4</code> measure once again:</p>
    <pre class="programlisting"><code class="hljs-code">AvgUnitAmount4 =
CALCULATE(
    AVERAGE(fSales[UnitAmount]),
    GENERATE(
        VALUES(Cities[CityID]),
        FILTER(
            VALUES(Products[ProductID]),
            [Sales] &gt; 10000
        )
    )
)
</code></pre>
    <p class="book-title--packt">Using variables, this formula <a id="calibre_link-361" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a><a id="calibre_link-751" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can be simplified:</p>
    <pre class="programlisting"><code class="hljs-code">AvgUnitAmount5 =
VAR LargeCityProductCombinations =
    GENERATE(
        VALUES(Cities[CityID]),
        FILTER(
            VALUES(Products[ProductID]),
            [Sales] &gt; 10000
        )
    )
RETURN
CALCULATE(
    AVERAGE(fSales[UnitAmount]),
    LargeCityProductCombinations
)
</code></pre>
    <p class="book-title--packt">Always remember <a id="calibre_link-690" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>that DAX variables are<a id="calibre_link-752" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> constants! The variant below is not correct:</p>
    <pre class="programlisting"><code class="hljs-code">AvgUnitAmount_wrong =
VAR LargeProducts = 
    FILTER(
            VALUES(Products[ProductID]), 
            [Sales] &gt; 10000
    )
VAR LargeCityProductCombinations =
    GENERATE(
        VALUES(Cities[CityID]),
        LargeProducts
    )
RETURN
CALCULATE(
    AVERAGE(fSales[UnitAmount]),
    LargeCityProductCombinations
)
</code></pre>
    <p class="book-title--packt">By putting the <code class="code-in-text--packt">FILTER</code> expression in a variable, we have turned it into a constant table. However, in<a id="calibre_link-856" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the <code class="code-in-text--packt">GENERATE</code> function, we <a id="calibre_link-1618" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>want the <a id="calibre_link-1465" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>product list to be determined anew for each city.</p>
    <h1 id="calibre_link-89" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, you have learned about row context, query context, and filter context and the role that <a id="calibre_link-362" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>contexts play in the evaluation of DAX formulas. We have discussed how contexts can be transformed using the <code class="code-in-text--packt">CALCULATE</code> function, by removing filters and adding filters to an existing context. In addition, we looked at time intelligence functions, which provide filters specifically tailored to the Gregorian calendar.</p>
    <p class="book-title--packt">We then focused on DAX table functions, which give us the ability to aggregate over tables and the use of custom-made, virtual tables within DAX formulas. Using virtual tables provides a wealth of analytics capabilities on top of what is already possible using "standard" DAX functions and filtering. We talked about the deep connection between tables and filters, which allows for using any table as a filter. And, finally, DAX variables were discussed, which make it easier to implement complex logic in DAX and add to the readability of DAX code as well.</p>
    <p class="book-title--packt">All of these are foundational concepts you need for exploring more advanced analyses with DAX. After this pivotal chapter, <em class="italic">Part 2</em> of this book is focused on applying all the concepts discussed to real-life business cases. Our aspiration is that by going through these cases, you will get to appreciate and understand the power of DAX even more, and that you are inspired to tackle your own business questions using DAX calculations.</p>
    <p class="book-title--packt"><em class="italic">Chapter 2.1</em>,<em class="italic"> </em><em class="italic">Security with DAX</em>, is dedicated to security in Power BI models. As you&nbsp;will see in this chapter, knowledge of DAX, context, and filtering already finds many applications when designing security.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-263">
<div id="calibre_link-1619" class="calibre2">
<div id="calibre_link-1620" class="calibre3"><div id="calibre_link-1621" class="calibre4">
    <div class="calibre4">
    </div>
    <div class="calibre4">
      <h1 id="calibre_link-90" class="title"><span class="outer"><span class="inner">Part II</span></span></h1>
    </div>
    <div class="calibre4">
      <h1 id="calibre_link-1622" class="title">Business cases</h1>
    </div>
  </div>
  <div id="calibre_link-1623" class="calibre4">
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-265">
<div id="calibre_link-1624" class="calibre2">
<div id="calibre_link-1625" class="calibre3"><div id="calibre_link-1626" class="calibre4">
    <h1 class="chapternumber">2.1</h1>
    <h1 id="calibre_link-91" class="title">Security with DAX</h1>
    <p class="book-title--packt">When working with data, chances are you deal with confidential data that must be secured. Even within an organization, some people should be able to see more than others. In a Power BI model, there are sophisticated ways to apply security. From this chapter, you will learn how to do this.</p>
    <p class="book-title--packt">Note that we will not cover security in the distribution or sharing of reports and dashboards in Power BI. Instead, we focus on security within Power BI models. The typical scenario here is that two users of the same report see different report content, depending on their security settings.</p>
    <p class="book-title--packt">This chapter covers the topics below:</p>
    <ul class="calibre9">
      <li class="bullet">Securing a Power BI model with row-level security</li>
      <li class="bullet">Configuring security on hierarchical data</li>
      <li class="bullet">Securing attributes, or individual columns in a table</li>
      <li class="bullet">Securing aggregation levels for calculated measures <div class="note pcalibre5 pcalibre4">
          <p class="book-title--packt">We will be using several models in this chapter that you can find in the GitHub repo for this book. Download the model files from <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.1" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.1</span></a> to help you follow along with the chapter, or to explore in your own time. </p>
        </div>
      </li>
    </ul>
    <h1 id="calibre_link-92" class="title">Introduction to row-level security (RLS)</h1>
    <p class="book-title--packt">With <strong class="screentext">row-level security</strong> (<strong class="screentext">RLS</strong>), you<a id="calibre_link-1220" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> can restrict users from seeing all data that is in a Power BI model. RLS is the main form of security in a Power BI model. It is called <em class="italic">row</em>-level because you define which rows in each table in the model are visible to the user. Note that because RLS is set on the model level, any report that visualizes results from that model will satisfy the security policy defined on it.</p>
    <p class="book-title--packt">Before diving in, let's make something clear: when you need a secure solution, you <em class="italic">have</em> to use RLS (or a related concept called object-level security, which we will discuss later in this chapter). There's just no way around it. Do not try to implement security through sharing reports (or not sharing, rather). You cannot oversee what will happen to the use of your model in the future: people may get self-service access to the Power BI model, get added to security groups by accident, or other things may happen. For the same reason, do not try to secure results through DAX measures that only return results when some condition is met: people who can build reports on top of the model can easily circumvent these. The rule of thumb should be: each user&nbsp;<em class="italic">could</em> have access to the model and <a id="calibre_link-1627" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>should not see things that are prohibited.</p>
    <h2 id="calibre_link-93" class="calibre8">Security roles</h2>
    <p class="book-title--packt">RLS is based <a id="calibre_link-1234" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on <a id="calibre_link-1267" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>security roles. Think of a security role as a separate implemented security policy. You could have a security role for individual salespeople, for instance, in addition to a security role for C-level executives and one for human resource managers.</p>
    <p class="book-title--packt">Security roles are part of the design of a Power BI model. Role membership, in contrast, is not; only after publishing a model can you add users to a role. You can have as many security roles as you wish, but there are some very important considerations to make, which we will cover in this section.</p>
    <p class="book-title--packt">Security roles are defined and maintained through the <strong class="screentext">Manage roles</strong> window:</p>
    <figure class="mediaobject"><img src="images/000150.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.1: The Manage roles window</p>
    <p class="book-title--packt">Once you publish <a id="calibre_link-1235" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a model <a id="calibre_link-1268" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in which a security role is defined, no one can access the data until they have been added to one of the security roles &ndash; unless you are an admin, member, or contributor in the workspace where the model has been published. </p>
    <p class="book-title--packt">In the Power BI service, you can see whether security roles have been defined by the appearance of a <strong class="screentext">Security</strong> option in the context menu on the dataset:</p>
    <figure class="mediaobject"><img src="images/000171.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.2: Finding the Security option</p>
    <p class="book-title--packt">People can be <a id="calibre_link-1236" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>added<a id="calibre_link-1269" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to security roles individually, through their email address, or as a (security) group.</p>
    <p class="book-title--packt">Note that adding someone to a security role does not give her access to the dataset as a whole, so you have to give access on two levels:</p>
    <ul class="calibre9">
      <li class="bullet">Access to the dataset (through a shared report, workspace membership, and/or build permission on the dataset itself)</li>
      <li class="bullet">Inclusion<a id="calibre_link-1628" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in<a id="calibre_link-1629" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> a security role</li>
    </ul>
    <h3 id="calibre_link-94" class="calibre8">DAX security filters</h3>
    <p class="book-title--packt">Once you <a id="calibre_link-1270" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>create a <a id="calibre_link-686" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>security role, it's time to define the actual security policy the role will implement. You do this by declaring DAX <strong class="screentext">security filters</strong> on one or more tables in the model. Note that DAX security filters are declared by role and by table; you can have different security filters on the same table, as long as they are in different security roles.</p>
    <p class="book-title--packt">A DAX security filter determines which rows a user in this security role will see in the table. You can compare a DAX security filter to a calculated column that is added to the table and that has values <em class="italic">true</em> or <em class="italic">false</em>. For example:</p>
    <pre class="programlisting"><code class="hljs-code">Product[Category] = "Components"
</code></pre>
    <p class="book-title--packt">When defined on the <code class="code-in-text--packt">Product</code> table, this filter will return <code class="code-in-text--packt">TRUE</code> for each product row that has <code class="code-in-text--packt">"Components"</code> as its <code class="code-in-text--packt">Category</code> value, and <code class="code-in-text--packt">FALSE</code> for all other products. The filter will be added to each and every measure evaluation, effectively only returning results for products in the <code class="code-in-text--packt">Components</code> category.</p>
    <p class="book-title--packt">You don't need to set security filters on each table because the relationships in your model propagate filters from one table to another. This is true for the evaluation context for a measure, but also for security filters. This means that you can effectively secure your model with just a few security filters &ndash; but be aware that changes in the model may break the security policies!</p>
    <p class="book-title--packt">In <em class="italic">Figure 2.1.3</em>, you see a simple example with a relationship (1) and two tables (2). With a security role <code class="code-in-text--packt">SelectCanada</code>, which filters the <code class="code-in-text--packt">Country</code> column on <code class="code-in-text--packt">Canada</code> (3), the <code class="code-in-text--packt">fSales</code> table is filtered through the relationship:</p>
    <figure class="mediaobject"><img src="images/000193.png" alt="Graphical user interface  Description automatically generated with medium confidence" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.3: Security filters propagate through a relationship</p>
    <p class="book-title--packt">When working with relationships that have a bidirectional cross filter setting, or <strong class="screentext">Both</strong> as Power BI calls it, special attention is needed when defining RLS. The default behavior for these relationships is that they propagate security filters in only one direction: the direction <a id="calibre_link-687" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <a id="calibre_link-1271" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationship would have if it had the cross filter property set to single, or from the one-side to the many-side. </p>
    <p class="book-title--packt">You can enable security filter propagation in both directions through the <strong class="screentext">Edit relationship</strong> window:</p>
    <figure class="mediaobject"><img src="images/000214.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt"> Figure 2.1.4: The Edit relationship window</p>
    <h2 id="calibre_link-95" class="calibre8">Dynamic row-level security</h2>
    <p class="book-title--packt">A static security<a id="calibre_link-721" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filter like <code class="code-in-text--packt">Product[Category] = "Furniture"</code> is not that useful in real life. RLS becomes a lot more useful when it's dynamic, meaning that the security filters are derived from who the user is. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The examples in this section can be found in the <code class="code-in-text--packt">2.1 Row-level security.pbix</code> file.</p>
    </div>
    <p class="book-title--packt">Who the user is can be retrieved using a couple of functions, of which the most consistent is <code class="code-in-text--packt">USERPRINCIPALNAME</code>. This DAX function returns the email address of the user, which should then be used to derive the right security logic.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">An older DAX function, <code class="code-in-text--packt">USERNAME</code>, returns the user's email address when in the Power BI service, but in Power BI Desktop, or in an Analysis Services instance, it returns the username. As looking up the user's identity is quite hard this way, <code class="code-in-text--packt">USERPRINCIPALNAME</code> was introduced to make this a little easier.</p>
      <p class="book-title--packt">When you use Power BI Embedded, you can configure security on the level of the application that the Power BI report is embedded in (this is called <strong class="screentext">app owns data</strong>). In this case, there<a id="calibre_link-309" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is no user as such but, instead, the app can provide an<a id="calibre_link-1262" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> identifier (the <strong class="screentext">secret</strong>) to Power BI when calling the report. The secret can be a user-level identifier, but it can also be an identifier on another level, like organization or department. In this case, <code class="code-in-text--packt">USERPRINCIPALNAME</code> retrieves the secret with which you can derive the security filters.</p>
    </div>
    <p class="book-title--packt">You do not normally use the email address as the user ID throughout the model, but a number, either an employee number from an HR system or a generated key. Either way, you will need a separate table with a mapping between the email address and user ID. In simple models, you can have a relationship between this table, let's call it <code class="code-in-text--packt">UserSecurity</code>, and the table containing user data; or you can even filter the <code class="code-in-text--packt">Employee</code> table directly using the email address.</p>
    <figure class="mediaobject"><img src="images/000012.png" alt="Diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.5: The UserSecurity and Employee tables</p>
    <p class="book-title--packt">In larger and more complex models, only securing an <code class="code-in-text--packt">Employee</code> table is probably not enough. In this case, it makes sense to have a separate <code class="code-in-text--packt">UserSecurity</code> table that is not related to any other table in the model. </p>
    <p class="book-title--packt">This is because you will run into having multiple relationship paths from the <code class="code-in-text--packt">UserSecurity</code> table to several tables and will therefore need to have inactive relationships.</p>
    <p class="book-title--packt">When working <a id="calibre_link-722" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with a standalone <code class="code-in-text--packt">UserSecurity</code> table, you need to retrieve the user ID from the table as part of a DAX security filter. For instance, to secure the <code class="code-in-text--packt">Employee</code> table, the DAX security filter would be:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisUser = 
    LOOKUPVALUE(
        UserSecurity[EmpNr], 
        UserSecurity[Email], 
        USERPRINCIPALNAME()
    )
RETURN
[EmpNr] = ThisUser
</code></pre>
    <p class="book-title--packt">Notice that you can use DAX variables in a DAX security filter. The variable <code class="code-in-text--packt">ThisUser</code> retrieves the <code class="code-in-text--packt">EmpNr</code> value from the <code class="code-in-text--packt">UserSecurity</code> table, using <code class="code-in-text--packt">USERPRINCIPALNAME()</code> as the value to look for. After <code class="code-in-text--packt">RETURN</code>, the filter checks whether the <code class="code-in-text--packt">EmpNr</code> value in the current row of the <code class="code-in-text--packt">Employee</code> table is equal to the <code class="code-in-text--packt">ThisUser</code> variable, effectively filtering to only the row for the current user.</p>
    <p class="book-title--packt">Remember that the <code class="code-in-text--packt">UserSecurity</code> table contains sensitive data, and consider whether this table needs to be secured itself! You could set a specific security filter on the <code class="code-in-text--packt">UserSecurity</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">FALSE()
</code></pre>
    <p class="book-title--packt">This filter would make none of the rows in the table visible to the user. This works only when the <code class="code-in-text--packt">UserSecurity</code> table is not related to other tables, as this filter should not be propagated to<a id="calibre_link-1630" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the rest of the model.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Remember that security filters are applied simultaneously and therefore do not depend on each other, just like filter arguments in the <code class="code-in-text--packt">CALCULATE</code> function. This means that when you use the filter above to hide all rows in the <code class="code-in-text--packt">UserSecurity</code> table, it is still possible to do a lookup in the table to retrieve the current user in another security filter. And inversely, you cannot use the security filter on a table to derive logic for a security filter on another table.</p>
    </div>
    <h2 id="calibre_link-96" class="calibre8">Modeling considerations for RLS</h2>
    <p class="book-title--packt">The use of RLS <a id="calibre_link-1227" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>brings with it some constraints on what you can do from a modeling perspective. Specifically, you will find that some uses of inactive relationships become impossible.</p>
    <p class="book-title--packt">Consider, for example, the model below. This model contains a fact table, <code class="code-in-text--packt">fHours</code>, containing hours worked by employees. Employees work on projects, in which case we speak of <em class="italic">direct hours</em>; but they also spend their time on other things: meetings, leave, sickness, and so on, which are called <em class="italic">indirect hours</em>. Each project has a project manager, who is also an employee.</p>
    <figure class="mediaobject"><img src="images/000032.png" alt="Diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.6: fHours, Project, and Employee tables</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can find this example in <code class="code-in-text--packt">InactiveRelationship.pbix</code>.</p>
    </div>
    <p class="book-title--packt">In this model, direct <a id="calibre_link-1228" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>hours can be reported by project and through projects, by project manager; indirect hours can be reported by employees directly. So, there are two ways the <code class="code-in-text--packt">Employee</code> table is related to the <code class="code-in-text--packt">fHours</code> table and, therefore, we need an inactive relationship somewhere. In this case, the relationship between <code class="code-in-text--packt">fHours</code> and <code class="code-in-text--packt">Employee</code> is chosen to be inactive.</p>
    <p class="book-title--packt">What measures can you create to retrieve the number of direct hours from this model? The basic formula is simple:</p>
    <pre class="programlisting"><code class="hljs-code">Direct Hours = SUM(fHours[Hours])
</code></pre>
    <p class="book-title--packt">Since the indirect hours in the <code class="code-in-text--packt">fHours</code> table are not linked to a project, a blank row will be added to the <code class="code-in-text--packt">Project</code> table. This blank <a id="calibre_link-1416" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>row will show up in reports as a blank project whenever a measure yields a result for that blank project, which the formula above does. You can make the formula a bit more sophisticated by testing for this situation and filtering out results that are really about indirect hours:</p>
    <pre class="programlisting"><code class="hljs-code">Direct Hours =
CALCULATE(
    SUM(fHours[Hours]),
    NOT(ISBLANK(fHours[ProjectNr]))
)
</code></pre>
    <p class="book-title--packt">Calculating<a id="calibre_link-1631" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> indirect hours works the same way, but now we're interested in rows without a <code class="code-in-text--packt">ProjectNr</code> value. The relationship between <code class="code-in-text--packt">fHours</code> and <code class="code-in-text--packt">Employee</code> also needs to be activated:</p>
    <pre class="programlisting"><code class="hljs-code">Indirect Hours =
CALCULATE(
    SUM(fHours[Hours]),
    ISBLANK(fHours[ProjectNr]),
    USERELATIONSHIP(fHours[EmpNr], Employee[EmpNr])
)
</code></pre>
    <p class="book-title--packt">With these measures, you can report direct and indirect hours by employee (note that <code class="code-in-text--packt">Direct Hours</code> are the hours on projects the employee is the project manager of):</p>
    <figure class="mediaobject"><img src="images/000053.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.7: Direct and indirect hours by employee</p>
    <p class="book-title--packt">Suppose, now, that<a id="calibre_link-1229" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> you want to secure this model. Let's create a simple security role that only returns results for Doug Adams. For this, there needs to be a DAX security filter on the <code class="code-in-text--packt">Employee</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">[FullName] = "Adams, Doug"
</code></pre>
    <p class="book-title--packt">When this security role is active, you will see that <a id="calibre_link-1417" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the visual is not populated but returns an error instead:</p>
    <figure class="mediaobject"><img src="images/000073.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.8: Couldn't load the data for this visual error message</p>
    <p class="book-title--packt">This seems to <a id="calibre_link-874" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>be a strange error message. The <code class="code-in-text--packt">fHours</code> table has two join paths to the <code class="code-in-text--packt">Employee</code> table &ndash; but the idea behind <code class="code-in-text--packt">USERELATIONSHIP</code> is that the active path is not used, right? Well, this is true when it comes to context in measure evaluation, but not for security filters.</p>
    <p class="book-title--packt">In fact, you should be happy that this error occurs, because what we're trying to do here is to remove or change security on the <code class="code-in-text--packt">fHours</code> table. The normal situation is that we only see rows in <code class="code-in-text--packt">fHours</code> linked to projects that Doug is the project manager of. With <code class="code-in-text--packt">USERELATIONSHIP</code>, we tell the model to ignore those settings and give us access to other rows. The model doesn't allow that and keeps the data secure. After all, being able to do this would mean that users who have self-service capabilities, which include writing custom measures, could override security filters and compromise the security of the model.</p>
    <p class="book-title--packt">This behavior is fundamental, and it means that you can easily run into trouble when security is an afterthought in the design of your model. The message here is not that inactive relationships should always be avoided, but that it is important to recognize potential issues in the future when security may be needed.</p>
    <p class="book-title--packt">There is no single way of solving this problem; it all depends on what your analytical needs are. You may, for instance, split the fact table in two, with one fact table for direct hours and <a id="calibre_link-1230" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>one for indirect hours:</p>
    <figure class="mediaobject"><img src="images/000095.png" alt="Diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.9: Splitting the fact table into fHoursDirect and fHoursIndirect</p>
    <p class="book-title--packt">This solution, however, doesn't allow for reporting direct hours by employee (as someone who works on the project, not as the project manager). </p>
    <p class="book-title--packt">Another option would be to duplicate <a id="calibre_link-1231" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <code class="code-in-text--packt">Employee</code> table and add a <code class="code-in-text--packt">Project Manager</code> table this way:</p>
    <figure class="mediaobject"><img src="images/000117.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt"> Figure 2.1.10: Adding a Project Manager table</p>
    <p class="book-title--packt">This solution would require DAX security filters on both the <code class="code-in-text--packt">Project Manager</code> and the <code class="code-in-text--packt">Employee</code> table.</p>
    <h2 id="calibre_link-97" class="calibre8">Testing security roles</h2>
    <p class="book-title--packt">When you<a id="calibre_link-1237" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> design and implement security<a id="calibre_link-1272" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> policies, you will want to test these as well. Conveniently, both Power BI Desktop and the Power BI service have a <strong class="screentext">View as roles</strong> feature that allows you to view the data as visible in a specific role. </p>
    <p class="book-title--packt">With the <strong class="screentext">View as roles</strong> option, it is also possible to impersonate a specific user and test what this user sees. In Power BI Desktop, this is straightforward: in the <strong class="screentext">View as roles</strong> window, select both the role you want to test and the option <strong class="screentext">Other user</strong>. </p>
    <p class="book-title--packt">Here, you can enter the email address of the user you want to test:</p>
    <figure class="mediaobject"><img src="images/000137.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.11: The View as roles window in Power BI Desktop</p>
    <p class="book-title--packt">In the Power BI service, it works in basically the same way, although the "Other user" option is somewhat hidden. When you select <strong class="screentext">Security</strong> on a dataset, click the three dots at the<a id="calibre_link-1273" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> right<a id="calibre_link-1238" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of a security role and select <strong class="screentext">Test as role</strong>:</p>
    <figure class="mediaobject"><img src="images/000157.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.12: The Test as role option in the Power BI service</p>
    <p class="book-title--packt">When viewing the report in a role, click once again on the role, now in the blue <strong class="screentext">Now viewing as:</strong> bar. There, you have the option to enter the email address of the user you want to impersonate:</p>
    <figure class="mediaobject"><img src="images/000178.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.13: Selecting someone to impersonate</p>
    <p class="book-title--packt">There is one constraint in testing RLS: you cannot easily test reports with a live connection to a published Power BI model, meaning that they are not in the same file as the model. This is a problem, as "live connection" is a common way of deploying reports. In the<a id="calibre_link-1239" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> next section, we describe an<a id="calibre_link-1274" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> approach to testing RLS with live connection reports, enabling the tester to impersonate any user. </p>
    <h2 id="calibre_link-98" class="calibre8">Testing live connection reports</h2>
    <p class="book-title--packt">In <a id="calibre_link-975" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>many<a id="calibre_link-1225" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> organizations that deploy Power BI reports, help desks get questions from users saying things like "<em class="italic">I don't see any data in my report</em>," or "<em class="italic">I should see X and Y, but only see X; oh, and also Z</em>." Or, even worse, "<em class="italic">John should see only X, but sees everything</em>." Often, these problems are due to the user being in the wrong role (or inadvertently having edit rights on the Power BI model), but these questions can also lead to new insights into required changes to the security policies. In any case, it is useful to be able to impersonate a user to test what they actually see in reports.</p>
    <p class="book-title--packt">Keeping in mind that you want to be able to do this on production reports (the versions actually in use throughout the organization), it is imperative that the impersonation itself is secure. In other words, it should be restricted to specific users (support personnel, for instance) and not be accessible to the common user. Additionally, it should be easy to switch impersonations in a production environment; meaning it should work with the reports and underlying Power BI models that are in use.</p>
    <p class="book-title--packt">The solution to this contains a number of specific elements:</p>
    <ul class="calibre9">
      <li class="bullet">A query parameter used to set the impersonation: <code class="code-in-text--packt">pImpersonation</code></li>
      <li class="bullet">A specific test account: <code class="code-in-text--packt">PBITestUser</code> (this should be an account with an email address in your organization, and a Power BI licence)</li>
      <li class="bullet">A Power<a id="calibre_link-1226" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> BI<a id="calibre_link-976" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> workspace for testing: <code class="code-in-text--packt">PBITest</code></li>
    </ul>
    <p class="book-title--packt">Let's walk through it.</p>
    <h3 id="calibre_link-99" class="calibre8">Impersonation model</h3>
    <p class="book-title--packt">We start <a id="calibre_link-888" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with<a id="calibre_link-971" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> a very simple model. The only element of this is a query parameter, <code class="code-in-text--packt">pImpersonation</code>.</p>
    <ol class="calibre9">
      <li class="calibre12">In Power BI Desktop, start a new model.</li>
      <li class="calibre12">Click <strong class="screentext">Transform Data</strong> to start the Power Query Editor.</li>
      <li class="calibre12">Click <strong class="screentext">Manage Parameters / New Parameter</strong> to enter a query parameter.</li>
      <li class="calibre12">Call the parameter <code class="code-in-text--packt">pImpersonation</code> and make sure to uncheck the <strong class="screentext">Required</strong> box. Set the <strong class="screentext">Type</strong> as <strong class="screentext">Text</strong>, add a <strong class="screentext">Description</strong>, and leave <strong class="screentext">Current Value</strong> empty for now:<figure class="mediaobject"><img src="images/000200.png" alt="" class="calibre14" /></figure>
        <p class="bullet1">Figure 2.1.14: Entering a query parameter in the Manage Parameters window</p>
      </li>
      <li class="calibre12">Click <strong class="screentext">OK</strong> to <a id="calibre_link-972" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>exit<a id="calibre_link-889" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the <strong class="screentext">Manage Parameters</strong> window. A parameter query is now created. In the <strong class="screentext">Queries</strong> pane, it is shown in italics as parameters are not loaded into the Power BI model. But in this case, we do want to load it! Right-click on the query, and set <strong class="screentext">Enable Load</strong>. The query is now shown in upright text.</li>
      <li class="calibre12">Select <strong class="screentext">Close &amp; Apply</strong>. Power BI loads the parameter into the model, resulting in a one-column table with an empty row:<figure class="mediaobject"><img src="images/000001.png" alt="" class="calibre14" /></figure>
        <p class="bullet1">Figure 2.1.15: The pImpersonation table</p>
      </li>
      <li class="calibre12">Save the model, giving<a id="calibre_link-973" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> it the name <code class="code-in-text--packt">Impersonation</code>, and <a id="calibre_link-890" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>publish it to the <strong class="screentext">PBITest</strong> workspace.</li>
    </ol>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">For your convenience, you can download this model from GitHub; its name is <code class="code-in-text--packt">2.1 Impersonation.pbix</code>.</p>
    </div>
    <h3 id="calibre_link-100" class="calibre8">Adding the pImpersonation table to the model</h3>
    <p class="book-title--packt">In the <a id="calibre_link-974" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>original Power<a id="calibre_link-1068" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> BI<a id="calibre_link-1106" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> model that needs to be tested, you can now add a DirectQuery connection to the <code class="code-in-text--packt">pImpersonation</code> table with the following steps. The model will become a composite model.</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">Open the model in Power BI Desktop, and click <strong class="screentext">Power BI Datasets</strong> in the ribbon.</li>
      <li class="calibre12">You can now select the Power BI model to connect to. Select the <strong class="screentext">Impersonation</strong> dataset from the <strong class="screentext">PBITest</strong> workspace.</li>
      <li class="calibre12">The <code class="code-in-text--packt">pImpersonation</code> table is now added to the model. You cannot view the data in the table, but you can create a visual with the <code class="code-in-text--packt">pImpersonation</code> column to see what is<a id="calibre_link-1632" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in<a id="calibre_link-1633" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> it (it's blank, for now).<figure class="mediaobject"><img src="images/000019.png" alt="" class="calibre14" /></figure>
      </li>
    </ol>
    <p class="book-title--packt">Figure 2.1.16: pImpersonation table added to the model</p>
    <h3 id="calibre_link-101" class="calibre8">Adding a test security role</h3>
    <p class="book-title--packt">Next, you <a id="calibre_link-977" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>create a new security role, <code class="code-in-text--packt">UserTest</code>, that <a id="calibre_link-1356" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will consider the value of <code class="code-in-text--packt">pImpersonation</code>. If it contains a valid email address, the security filters will take that email address to impersonate a user. If the value is blank, no security filters are applied.</p>
    <p class="book-title--packt">As an example, below is the adapted security filter for the <code class="code-in-text--packt">Employee</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">VAR Impersonation = SELECTEDVALUE(pImpersonation[pImpersonation])
VAR User = 
    LOOKUPVALUE(
        UserSecurity[EmpNr], 
        UserSecurity[Email], 
        Impersonation
    )
RETURN
ISBLANK(User) || [EmpNr] = User
</code></pre>
    <p class="book-title--packt">The first variable, <code class="code-in-text--packt">Impersonation</code>, uses <code class="code-in-text--packt">SELECTEDVALUE</code> to retrieve the value of the <code class="code-in-text--packt">pImpersonation</code> parameter (which is a column in this model). <code class="code-in-text--packt">SELECTEDVALUE</code> is normally used to retrieve a value from a column if and only if there is just one (unique) value in that column; in our case, there is always only one value as we have just one row in the <code class="code-in-text--packt">pImpersonation</code> table. </p>
    <p class="book-title--packt">The second variable, <code class="code-in-text--packt">User</code>, tries to retrieve an <code class="code-in-text--packt">EmpNr</code> value from the <code class="code-in-text--packt">UserSecurity</code> table using <code class="code-in-text--packt">LOOKUPVALUE</code>. Note that <code class="code-in-text--packt">UserSecurity</code> is used to translate user email addresses to user IDs; if an <code class="code-in-text--packt">EmpNr</code> value is found, the rest of the security filter works with that value.</p>
    <p class="book-title--packt">Note that when <code class="code-in-text--packt">pImpersonation</code> is a blank value or an invalid email address, <code class="code-in-text--packt">LOOKUPVALUE</code> will return <code class="code-in-text--packt">BLANK</code>. This is the case where we want no filtering to be done. The last line of the code, <code class="code-in-text--packt">ISBLANK(User) || [EmpNr] = User</code>, implements just that: when the variable <code class="code-in-text--packt">User</code> is blank, <code class="code-in-text--packt">ISBLANK(User)</code> is true for each row in the table. If it is not, the <a id="calibre_link-978" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>formula only returns true for the row <a id="calibre_link-1357" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>where the column <code class="code-in-text--packt">EmpNr</code> contains the <code class="code-in-text--packt">User</code> value retrieved.</p>
    <h3 id="calibre_link-102" class="calibre8">Making it all work</h3>
    <p class="book-title--packt">With the new security role in place, the model can now be published. For the impersonation to work, you'll still have to take care of a couple of things:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">Add the PBITestUser account to the UserTest security role.</li>
      <li class="calibre12">Add PBITestUser to the PBITest workspace where the Impersonation dataset is published.</li>
      <li class="calibre12">Share the (live connection) report to be tested with PBITestUser.</li>
      <li class="calibre12">Do not give full access to the underlying model to PBITestUser!</li>
    </ol>
    <p class="book-title--packt">To impersonate a user and test the report, PBITestUser should log in to Power BI, navigate to the Impersonation dataset, and change the <code class="code-in-text--packt">pImpersonation</code> parameter value under the dataset's Settings to the email address to be impersonated. <strong class="screentext">Do not forget that the Impersonation dataset needs to be refreshed after changing the parameter value!</strong> As the parameter is the only thing in the model, refreshing will take only a second. Next, navigate to the report that is shared with PBITestUser.</p>
    <p class="book-title--packt">Because the report's model has a DirectQuery connection to Impersonation, the changed parameter value will be directly available. The security role will pick up the email address and filter the report accordingly. Note that security filters are normally applied when a user connects to a model for the first time during a session; when you change the parameter while viewing the report, it will not pick up the new value. Instead, navigate away from the report and wait a while (about 10 minutes is enough in our tests).</p>
    <p class="book-title--packt">This method is secure as long as PBITestUser is the only account in the UserTest role. As no other role uses the <code class="code-in-text--packt">pImpersonation</code> value, the Impersonation dataset doesn't even need to be secured &ndash; it's only an email address, after all. </p>
    <p class="book-title--packt">To test different security roles this way, you could create a specific test role for each security role that has been defined on the model. This way, you can even test what happens when a user is a member of multiple roles by adding PBITestUser to the respective test roles.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">We used a separate test workspace to host the Impersonation dataset, but you may want to solve this in another way. The important thing is that the test user must have read access to this dataset, and must not have full access to the model to be tested (like by being an admin on the workspace where the model is located). This is because as a workspace admin, member, or contributor, security roles are not applied. </p>
    </div>
    <p class="book-title--packt">So far, we have discussed the possibilities and pitfalls in securing data based on a user's identity. This assumes that the data are directly relatable to the user in some way. In many situations, this is not enough, as the user is part of a larger organization with a specific structure. The section below deals with these situations.</p>
    <h1 id="calibre_link-103" class="title">Securing hierarchies using PATH functions</h1>
    <p class="book-title--packt">In most <a id="calibre_link-887" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>organizations, data is not directly <a id="calibre_link-1057" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>related to a single user who has access to it. Instead, there is a group of people that each have access to different sets of data. Managers have access to the data of employees reporting to them, for instance. DAX contains a set of functions to deal with parent-child hierarchies like these: the <code class="code-in-text--packt">PATH</code> functions.</p>
    <h2 id="calibre_link-104" class="calibre8">Hierarchical tables</h2>
    <p class="book-title--packt">First, let's take a <a id="calibre_link-885" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>look at a typical organization structure, in this case, that of QuantoBikes, our example company. QuantoBikes is organized into several divisions aligned with continents, and each division consists of multiple teams. </p>
    <p class="book-title--packt">The&nbsp;organization map is pictured below:</p>
    <figure class="mediaobject"><img src="images/000039.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.17: QuantoBikes organization map</p>
    <p class="book-title--packt">In the <code class="code-in-text--packt">Employee</code> table, this organizational hierarchy is registered by having a column called <code class="code-in-text--packt">MngrNr</code>, or Manager Number. This column contains the employee number for each employee's direct manager; only the CEO does not have a manager:</p>
    <figure class="mediaobject"><img src="images/000061.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.18: The Employee table for QuantoBikes</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Power BI <a id="calibre_link-886" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>assumes that an employee does not have more than one direct manager, which is a fair assumption. You may have to deal with hierarchies with multiple parents (a family tree, for instance); these are cases too complex to solve with <code class="code-in-text--packt">PATH</code> functions alone. We will not cover these in this book.</p>
      <p class="book-title--packt">The hierarchy could consist of multiple trees when multiple rows in the table contain a blank value in the parent column.</p>
    </div>
    <h2 id="calibre_link-105" class="calibre8">Introducing PATH functions</h2>
    <p class="book-title--packt">With two<a id="calibre_link-1056" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> columns in a table encoding a parent-child hierarchy, you could traverse the table going from, in our example, employee to manager, to the manager's manager, and all the way to the top of the hierarchy. DAX contains a small set of functions that do this for you and provide useful information about the hierarchy.</p>
    <h3 id="calibre_link-106" class="calibre8">PATH</h3>
    <p class="book-title--packt"><code class="code-in-text--packt">PATH(Employee[EmpNr], Employee[MngrNr])</code> must <a id="calibre_link-667" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>be evaluated <a id="calibre_link-1634" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in row context on the <code class="code-in-text--packt">Employee</code> table. It takes the two columns describing the hierarchy as arguments and returns the path from the top of the hierarchy to the current <code class="code-in-text--packt">EmpNr</code>. The result is a text string with a concatenation of all <code class="code-in-text--packt">EmpNr</code> values separated by the pipe character. For example, the path for Leo Johnson (employee 10106) is:</p>
    <pre class="programlisting"><code class="hljs-code">10001|10010|10101|10106
</code></pre>
    <p class="book-title--packt">Note that the path is always text, even when the hierarchy columns are numeric.</p>
    <h3 id="calibre_link-107" class="calibre8">PATHCONTAINS</h3>
    <p class="book-title--packt">The<a id="calibre_link-666" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function <code class="code-in-text--packt">PATHCONTAINS</code> takes a path and a value <a id="calibre_link-1055" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>as arguments and returns <code class="code-in-text--packt">TRUE</code> when the value is included in the path. So, taking Leo Johnson as an example again,</p>
    <pre class="programlisting"><code class="hljs-code">PATHCONTAINS(
    &lt;Leo's path&gt;,
    10010
)
</code></pre>
    <p class="book-title--packt">would return <code class="code-in-text--packt">TRUE</code>.</p>
    <h3 id="calibre_link-108" class="calibre8">PATHLENGTH</h3>
    <p class="book-title--packt">The<a id="calibre_link-670" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function <code class="code-in-text--packt">PATHLENGTH</code> returns<a id="calibre_link-1062" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the number of items in a path. In other words, it returns the level in the hierarchy at which the current item appears. </p>
    <pre class="programlisting"><code class="hljs-code">PATHLENGTH(&lt;Leo's path&gt;) 
</code></pre>
    <p class="book-title--packt">The above would return <code class="code-in-text--packt">4</code>.</p>
    <h3 id="calibre_link-109" class="calibre8">PATHITEM</h3>
    <p class="book-title--packt">The<a id="calibre_link-668" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function <code class="code-in-text--packt">PATHITEM</code> takes <a id="calibre_link-1060" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a path and a number <em class="italic">N</em> as arguments, and returns the <em class="italic">N</em>th item from the hierarchy, counting from the start (or the top of the hierarchy).</p>
    <pre class="programlisting"><code class="hljs-code">PATHITEM(&lt;Leo's path&gt;, 3)
</code></pre>
    <p class="book-title--packt">The above returns <code class="code-in-text--packt">10101</code>.</p>
    <h3 id="calibre_link-110" class="calibre8">PATHITEMREVERSE</h3>
    <p class="book-title--packt">The<a id="calibre_link-669" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> function <code class="code-in-text--packt">PATHITEMREVERSE</code> does the same<a id="calibre_link-1061" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> thing as <code class="code-in-text--packt">PATHITEM</code>, but counts from the end of the path, or the bottom of the hierarchy.</p>
    <pre class="programlisting"><code class="hljs-code">PATHITEMREVERSE(&lt;Leo's path&gt;, 3)
</code></pre>
    <p class="book-title--packt">The above returns <code class="code-in-text--packt">10010</code>, which is the number of Leo's skip-level manager.</p>
    <p class="book-title--packt">Note that <code class="code-in-text--packt">PATHITEM</code> and <code class="code-in-text--packt">PATHITEMREVERSE</code> return text values, even when the path was originally created from numeric values.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The normal use of the <code class="code-in-text--packt">PATH</code> functions is to create a path with <code class="code-in-text--packt">PATH</code> and use that as input for the other functions. You can, however, create a path string in whatever way you like. The <code class="code-in-text--packt">PATH</code> functions don't have any hidden knowledge about the way the paths were created; they just work on a text string and search for pipe characters.</p>
    </div>
    <h2 id="calibre_link-111" class="calibre8">Using PATH functions in RLS</h2>
    <p class="book-title--packt">You can use <a id="calibre_link-1058" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <code class="code-in-text--packt">PATH</code> functions <a id="calibre_link-1232" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to implement more sophisticated security logic when your data has a hierarchical structure. Suppose you want to implement the security policy that a manager has access to the data of all employees reporting to her, directly or indirectly. To do this, start by creating a column in the <code class="code-in-text--packt">Employee</code> table containing the hierarchical path for each employee:</p>
    <pre class="programlisting"><code class="hljs-code">Path = PATH([EmpNr], [MngrNr])
</code></pre>
    <p class="book-title--packt">The DAX security filter on the <code class="code-in-text--packt">Employee</code> table would <a id="calibre_link-1051" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>again start by retrieving the employee number of the logged-in user:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisUser = 
    LOOKUPVALUE(
        UserSecurity[EmpNr], 
        UserSecurity[Email], 
        USERPRINCIPALNAME()
   )
</code></pre>
    <p class="book-title--packt">The next step would be simply to check if the current user is in the path of an employee:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
PATHCONTAINS([Path], ThisUser)
</code></pre>
    <p class="book-title--packt">The function <code class="code-in-text--packt">PATHCONTAINS</code> returns <code class="code-in-text--packt">TRUE</code> when the logged-in user is in the path of the employee, and <code class="code-in-text--packt">FALSE</code> otherwise. The result of the security filter is, therefore, that all employees<a id="calibre_link-1233" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in <a id="calibre_link-1059" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the hierarchy under the user (and no one else) are visible.</p>
    <h2 id="calibre_link-112" class="calibre8">Advanced hierarchy navigation in RLS</h2>
    <p class="book-title--packt">By using <code class="code-in-text--packt">PATH</code> functions<a id="calibre_link-1221" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in a clever way, you<a id="calibre_link-273" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> can implement all kinds of advanced security rules. For example, let's implement the policy that a manager may view data for all employees reporting to him, and all employees reporting to his peers. In other words:</p>
    <ul class="calibre9">
      <li class="bullet">If John is a manager, he can view data for himself and all of his (direct or indirect) reports.</li>
      <li class="bullet">If John is a manager, he can view data for employees reporting to his peers (who are the employees directly reporting to his manager).</li>
      <li class="bullet">John cannot view data for his manager or his peers.</li>
      <li class="bullet">If John is not a manager, he can only view his own data (even if one of his peers has people reporting to her).</li>
    </ul>
    <p class="book-title--packt">We will need quite some code to implement this policy, and will use DAX variables to keep track of what we are doing. The code covers the steps below:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">Determine if John is a manager.</li>
      <li class="calibre12">Make a first selection by determining which employees report to John's manager.</li>
      <li class="calibre12">Remove John's peers from the selection.</li>
      <li class="calibre12">Make the resulting group of employees visible to John.</li>
    </ol>
    <p class="book-title--packt">First, let's see how to find out that John is not a manager. This is not straightforward, as the path only works upwards, so we don't have the organizational tree under an employee readily available. But we can <a id="calibre_link-507" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>traverse the <code class="code-in-text--packt">Employee</code> table and count how many times John appears in a <a id="calibre_link-753" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>path. Someone <a id="calibre_link-1052" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>who is not a manager would only appear in their own path, not in that of others. To use the <code class="code-in-text--packt">PATH</code> functions, we first need to retrieve John's<a id="calibre_link-1222" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> employee number from<a id="calibre_link-274" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the <code class="code-in-text--packt">UserSecurity</code> table. Here is the DAX code:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisUser = 
    LOOKUPVALUE(
        UserSecurity[EmpNr], 
        UserSecurity[Email], 
        USERPRINCIPALNAME()
    )
VAR IsManager =
    IF(
        COUNTROWS(
            FILTER(Employee, 
                PATHCONTAINS(Employee[Path], ThisUser)
            )
        ) &gt; 1,
        TRUE(),
        FALSE()
   )
</code></pre>
    <p class="book-title--packt">The variable <code class="code-in-text--packt">IsManager</code> is <code class="code-in-text--packt">TRUE</code> whenever the user is a manager. We could proceed to find people reporting to John, but according to our policy, all employees that John may view are reporting, directly or indirectly, to John's manager. It therefore makes sense to start by testing whether John's manager is in the path of the employee. We use <code class="code-in-text--packt">LOOKUPVALUE</code> to retrieve the <code class="code-in-text--packt">MngrNr</code> value for the logged-in user (the variable <code class="code-in-text--packt">ThisUser</code>) and then use <code class="code-in-text--packt">PATHCONTAINS</code> to check if John's manager appears in the employee's path:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisUserMngr = 
    LOOKUPVALUE(
        Employee[MngrNr],
        Employee[EmpNr],
        ThisUser
    )
VAR ReportsToManager = PATHCONTAINS([Path], ThisUserMngr)
</code></pre>
    <p class="book-title--packt">If we were to use the variable <code class="code-in-text--packt">ReportsToManager</code>, we would select too many employees to view. We should skip John's manager and John's peers. To do this, it is helpful to work with the organizational levels that John and his manager work at; only employees at least two levels<a id="calibre_link-275" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> lower than John's manager may be viewed by John. You can use the <code class="code-in-text--packt">PATHLENGTH</code> function <a id="calibre_link-1223" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to do this: </p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisUserPath = 
    LOOKUPVALUE(
        Employee[Path],
        Employee[EmpNr],
        ThisUser
    )
VAR MngrLevel = PATHLENGTH(ThisUserPath) - 1
</code></pre>
    <p class="book-title--packt">Note that the security filter is evaluated for each row in the <code class="code-in-text--packt">Employee</code> table, but each time, we want to find the level of John's manager. With <a id="calibre_link-1063" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this information, we can derive which employees should be visible:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ShouldBeVisible = 
ReportsToManager 
   &amp;&amp; PATHLENGTH([Path]) &gt;= MngrLevel + 2
</code></pre>
    <p class="book-title--packt">But wait: there is one employee where <code class="code-in-text--packt">ShouldBeVisible</code> results in <code class="code-in-text--packt">FALSE</code>, while the employee should indeed be visible: John himself. So, we need a slightly altered variable:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ShouldBeVisible = 
    (ReportsToManager 
    &amp;&amp; PATHLENGTH([Path]) &gt;= MngrLevel + 2)
    || [EmpNr] = ThisUser
</code></pre>
    <p class="book-title--packt">We can now complete the security filter, bringing everything together:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
IF(
    IsManager,
    ShouldBeVisible,
    [EmpNr] = ThisUser
)
</code></pre>
    <p class="book-title--packt">There is only one case where things go wrong, and probably not the least important one: the CEO, who has no manager, would only get to see herself. This is because the <code class="code-in-text--packt">ThisUserMngr</code> variable is <code class="code-in-text--packt">BLANK</code>, and<a id="calibre_link-276" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> therefore no employee is identified as reporting to her: after all, no<a id="calibre_link-1224" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> path contains a blank value, so the variable <code class="code-in-text--packt">ReportsToManager</code> is <code class="code-in-text--packt">FALSE</code> for any employee. Conveniently, we have another variable to detect this case: <code class="code-in-text--packt">MngrLevel</code> is zero when the user has no manager. The final filter should therefore be implemented with:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SWITCH(TRUE(),
    MngrLevel = 0, TRUE(),
    IsManager, ShouldBeVisible,
    [EmpNr] = ThisUser
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">SWITCH</code> statement here first checks if the user is the CEO and if so, renders all employees visible; then, it checks if the user is a manager, and applies the manager security rules. If the user is neither CEO nor manager, it lets the user only see himself.</p>
    <p class="book-title--packt">Now that you have seen row-level security in <a id="calibre_link-1318" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>action, we will discuss how to use RLS to implement<a id="calibre_link-1635" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> even more sophisticated <a id="calibre_link-1636" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>security policies: securing attributes and, later in this chapter, securing aggregation levels. </p>
    <h1 id="calibre_link-113" class="title">Securing attributes</h1>
    <p class="book-title--packt">In this section, we <a id="calibre_link-325" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will take a wholly different look at security in Power BI models. In the previous sections, we focused on ways to restrict the visibility of <em class="italic">rows</em> in tables of the model. This is the most common security need but, sometimes, other forms of security are needed. If you think of row-level security as "horizontal" security, looking at your data, then it makes sense to consider the possibility of "vertical" security. In other words, can we secure columns, or attributes?</p>
    <h2 id="calibre_link-114" class="calibre8">The case for secured attributes</h2>
    <p class="book-title--packt">Securing a Power<a id="calibre_link-326" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> BI model with RLS is only really needed when the model is used by a broader audience. If you have a model used only by C-level executives, you probably won't need to have RLS at all, as each user is allowed to see all the data. Only when the audience grows larger does the need arise to segment the data based on geography, customer segment, or organizational structure, as discussed in the previous sections.</p>
    <p class="book-title--packt">In the same way, if you have models that only apply to a specific business process, like sales and opportunity management, you probably do not need to secure specific attributes. The model might contain, for instance, the names of salespeople and their responsibilities, but maybe not their pay level, date of birth, or social security number. When data concerning different business processes are combined in one model, like sales and human resource management, you need to include additional attributes that may not be<a id="calibre_link-327" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> shared with every user.</p>
    <h2 id="calibre_link-115" class="calibre8">Object-level security and its restrictions</h2>
    <p class="book-title--packt">One way <a id="calibre_link-1038" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of<a id="calibre_link-1263" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> securing<a id="calibre_link-1265" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> attributes is <strong class="screentext">object-level security</strong>. This <a id="calibre_link-1037" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>comes in two forms:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Table-level security</strong> makes an entire table disappear from view in a security role.</li>
      <li class="bullet"><strong class="screentext">Column-level security</strong> makes one or more columns in a table disappear.</li>
    </ul>
    <p class="book-title--packt">We consciously use the word <em class="italic">disappear</em> here; when, for instance, the <code class="code-in-text--packt">Product</code> table is secured using table-level security, the model acts as if there is no <code class="code-in-text--packt">Product</code> table at all. The same happens when a column is secured using column-level security.</p>
    <p class="book-title--packt">We're not covering every aspect of object-level security here, in part because it is implemented without using DAX, what this book is about, and more importantly, because we cover a more exciting way of securing attributes in the next sections. There is certainly a case for using object-level security. The official documentation states that it restricts access to "sensitive" table names and column names, and you may have data that is so private that even knowing that it exists should be restricted to only those who need to know (a filter table <code class="code-in-text--packt">UFO Type</code> comes to mind here, but more serious examples are certainly available).</p>
    <p class="book-title--packt">However, the disappearance of tables and columns poses a problem for Power BI models and reports. When a secured table has relationships to other tables, you may have to create other relationship paths for users that don't have access to the secured table. More importantly, a Power BI report that references secured columns, or columns from secured tables, will break and raise errors to users without access to those columns or tables. </p>
    <p class="book-title--packt">In other words, using object-level security forces you to partition your reports into versions for users with access to secured objects and versions for users without that access. </p>
    <p class="book-title--packt">And with that, you could wonder if you're not better off with a separate model for<a id="calibre_link-1266" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the <a id="calibre_link-1264" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>secured <a id="calibre_link-1039" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>data &ndash; after all, it will only be used by a custom report anyway.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Although OLS is supported in Power BI models, it cannot be configured with Power BI Desktop currently.</p>
    </div>
    <h2 id="calibre_link-116" class="calibre8">Dynamically securing attributes: introducing value-level security</h2>
    <p class="book-title--packt">We now<a id="calibre_link-328" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> introduce a slightly different form of securing attributes, which allows for serving both users with and without access to secure attributes with the same report. We coined the term <strong class="screentext">value-level security</strong> as it is a blend of row-level and column-level security. With value-level<a id="calibre_link-1437" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> security (OK, <strong class="screentext">VLS</strong> for short) you can give a user access to the values of a column in some rows, but not in others.</p>
    <p class="book-title--packt">With VLS, you could implement security policies like "<em class="italic">Managers can see the pay levels of employees who report to them, but not the pay levels of employees who report to their peers, even while they can still see those employees and their sales numbers</em>." In a completely different subject, another example could be "<em class="italic">Teachers can see their students' names, numbers, and grades, but only tutors can see their students' addresses. Teachers who are a tutor for some students may see their address, but not that of other students</em>."</p>
    <p class="book-title--packt">You may want to implement this using DAX measures. While this may be a start, it is not a secure solution in the long run. Users who receive the build permission on the Power BI model in order to create their own reports (a strong use case for Power BI) can also create their own DAX measures. In doing so, they have access to everything that is in the model and that is not secured. This means that any security implemented through a measure can be circumvented by creating another measure.</p>
    <p class="book-title--packt">More importantly, a serious model can contain tens or hundreds of measures. When each measure needs to be equipped with the logic to implement security on attributes, you lay the foundation for errors and high maintenance costs. Instead, we want to have a solution that will work with any measure that works on the model.</p>
    <p class="book-title--packt">Implementing VLS demands a sophisticated combination of modeling and DAX security filters. In <a id="calibre_link-329" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the<a id="calibre_link-1438" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> sections below, we will go through these. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The example model for this section is <code class="code-in-text--packt">2.1 Value-level security.pbix</code>.</p>
    </div>
    <h3 id="calibre_link-117" class="calibre8">Value-level security: modeling</h3>
    <p class="book-title--packt">The first thing to <a id="calibre_link-1446" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>do when designing a VLS solution is to wonder what a secured report will look like. An error message is not what we want, so the visual in the figure below is the best option. In this example, SSNs are shown for some employees, and values are left blank for others:</p>
    <figure class="mediaobject"><img src="images/000082.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.19: A VLS-secured report</p>
    <p class="book-title--packt">The important thing to notice here is that secured values are not visible in the report; but in this example, as the column <code class="code-in-text--packt">SSN</code> is a label and not the result of a measure, there must be a value in the model to be shown in the visual. This could be empty text, or the value <code class="code-in-text--packt">BLANK</code>, or something else, and that value must be in a row in a table.</p>
    <p class="book-title--packt">Now, if you realize that for some users, the values should be visible and for others, not, the logical step is to split the table to be secured, in this case <code class="code-in-text--packt">Employee</code>, into two parts: one for publicly accessible columns (subject to RLS restrictions, of course), and another one containing <a id="calibre_link-1447" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the private columns:</p>
    <figure class="mediaobject"><img src="images/000103.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.20: Splitting the Employee table into public and private parts</p>
    <p class="book-title--packt">We still need to be able to link corresponding rows to each other. You can indeed do that, as we have the <code class="code-in-text--packt">EmpNr</code> column in both tables. You could create a relationship between the two tables, and this relationship would even be one-to-one. But that doesn't help us, and it certainly won't give us blank values for the private columns; rather, it brings us back to the situation with just one table.</p>
    <p class="book-title--packt">The solution is to add rows to the private table. In the case of the <code class="code-in-text--packt">Employee</code> table, the <code class="code-in-text--packt">Employee (private)</code> table must contain twice the number of rows as the <code class="code-in-text--packt">Employee</code> table, divided into two sets. One set of rows contains all values for <code class="code-in-text--packt">EmpNr</code>, as well as all the private data; we'll call these <a id="calibre_link-1070" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <strong class="screentext">positive</strong> rows. </p>
    <p class="book-title--packt">The other set of rows also contains all values for <code class="code-in-text--packt">EmpNr</code>, but <em class="italic">blank</em> values (or whatever other option you choose) in the private columns; we'll call these <a id="calibre_link-1025" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <strong class="screentext">negative</strong> rows. An additional column, <code class="code-in-text--packt">Private</code>, helps to distinguish <a id="calibre_link-1448" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>between positive and negative rows. The picture below&nbsp;shows this schematically:</p>
    <figure class="mediaobject"><img src="images/000125.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.21: Adding rows to the Employee (private) table</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">Employee (private)</code> table is linked to the <code class="code-in-text--packt">Employee</code> table by a many-to-one relationship, with <code class="code-in-text--packt">Employee (private)</code> being at the "many" side of the relationship. The relationship needs to have bidirectional cross filtering enabled. When selecting an employee by <code class="code-in-text--packt">FullName</code>, for instance, you want to have the private data of that employee be selected. And vice versa: when selecting a <code class="code-in-text--packt">Pay</code> level, you want all employees with that pay level to be selected. So, filters need to be propagated from <code class="code-in-text--packt">Employee</code> to <code class="code-in-text--packt">Employee (private)</code> and vice versa.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The intermediate table can easily be created using an M script (this script assumes you have an <code class="code-in-text--packt">sEmployee</code> query that provides the basic data for the <code class="code-in-text--packt">Employee</code> table and that itself is not loaded into the model):</p>
      <pre class="programlisting"><code class="hljs-code">let
    Source = sEmployee,
    PositiveRows = Table.SelectColumns(Source,{"EmpNr", "SSN", "DateOfBirth", "PayLevel"}),
    AddPrivate = Table.AddColumn(PositiveRows, "Private", each 1, Int64.Type),
    NegativeRows = Table.SelectColumns(Source, {"EmpNr"}),
    AddPrivate2 = Table.AddColumn(NegativeRows, "Private", each 0, Int64.Type),
    Combine = Table.Combine({AddPrivate, AddPrivate2})
in
    Combine
</code></pre>
      <p class="book-title--packt">This script <a id="calibre_link-1449" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>creates two copies of the <code class="code-in-text--packt">sEmployee</code> table, one with the private columns and one with the <code class="code-in-text--packt">EmpNr</code> column only. A <code class="code-in-text--packt">Private</code> column is added to both copies with the value 1 or 0, respectively; finally, the two copies are appended.</p>
      <p class="book-title--packt">It may be useful to add additional columns. For instance, if you want to use the organizational hierarchy in the security policy for private attributes, it makes sense to include the <code class="code-in-text--packt">MngrNr</code> column in both copies as well. </p>
    </div>
    <p class="book-title--packt">Make sure <em class="italic">not</em> to enable the <strong class="screentext">Apply security filter in both directions</strong> setting on the relationship. As you will see in the next section, we are going to secure the private attributes with a security filter on <code class="code-in-text--packt">Employee (private)</code>. This is in addition to a security filter on <code class="code-in-text--packt">Employee</code>. The model does not allow a security filter to be propagated against the default direction in this case.</p>
    <h3 id="calibre_link-118" class="calibre8">Value-level security: security filters</h3>
    <p class="book-title--packt">When you<a id="calibre_link-1450" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> create some output with columns from the <code class="code-in-text--packt">Employee</code> and <code class="code-in-text--packt">Employee (private)</code> tables, you will notice that you get two copies of output for each employee: one with the actual private attributes (the positive copy) and another one&nbsp;with blank private attributes (the negative copy). This is because of how we designed the <code class="code-in-text--packt">Employee (private)</code> table.</p>
    <figure class="mediaobject"><img src="images/000145.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.22: Seeing two output rows for each employee</p>
    <p class="book-title--packt">But this means that you can now use row-level security to select which copy you want to show. For each employee whose private attributes should be visible, make sure the corresponding positive row in <code class="code-in-text--packt">Employee (private)</code> is visible, but hide the negative row. For each employee whose private attributes should not be shown, hide the positive row in <code class="code-in-text--packt">Employee (private)</code>, with non-blank private attributes, and make the negative row visible.</p>
    <p class="book-title--packt">The DAX formula for the security filter on <code class="code-in-text--packt">Employee (private)</code> would look like this:</p>
    <pre class="programlisting"><code class="hljs-code">(
    &lt;when to show&gt; 
   &amp;&amp; [Private] = 1
)
|| (
    NOT(&lt;when to show&gt;)
    &amp;&amp; [Private] = 0
)
</code></pre>
    <p class="book-title--packt">We'll call the first <code class="code-in-text--packt">&lt;when to show&gt;</code> clause<a id="calibre_link-1069" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the <strong class="screentext">positive</strong> clause and the other one the <strong class="screentext">negative</strong> clause. For<a id="calibre_link-1024" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> example, to show private attributes only for employee 10203, the&nbsp;filter would be:</p>
    <pre class="programlisting"><code class="hljs-code">(
    [EmpNr] = 10203
    &amp;&amp; [Private] = 1
)
|| (
    [EmpNr] &lt;&gt; 10203
    &amp;&amp; [Private] = 0
)
</code></pre>
    <p class="book-title--packt">This expression<a id="calibre_link-1451" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is true for the single row with <code class="code-in-text--packt">EmpNr = 10203</code> and private data, and also for the rows with other values for <code class="code-in-text--packt">EmpNr</code> and blank values. For all other rows in <code class="code-in-text--packt">Employee (private)</code>, the expression is false and the rows are hidden.</p>
    <p class="book-title--packt">As you can see, for each employee exactly one row in <code class="code-in-text--packt">Employee (private)</code> is visible. Employees who should not be visible at all can be hidden by setting a security filter on the <code class="code-in-text--packt">Employee</code> table as usual. If you were to set a security filter <code class="code-in-text--packt">[MngrNr] = 10201</code> on <code class="code-in-text--packt">Employee</code>, you would get the result in the picture below (Faustina Bailey is employee 10203):</p>
    <figure class="mediaobject"><img src="images/000165.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.23: Viewing an employee's SSN</p>
    <h3 id="calibre_link-119" class="calibre8">Value-level security: advanced scenarios</h3>
    <p class="book-title--packt">In the security<a id="calibre_link-1439" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filters on the private table, you can apply everything possible in DAX, as usual. As an example, to implement the security policy "<em class="italic">a manager can see private attributes of her direct reports, but not of indirect reports</em>," you would start by having the <code class="code-in-text--packt">MngrNr</code> and <code class="code-in-text--packt">Path</code> in the <code class="code-in-text--packt">Employee (private)</code> table. The <a id="calibre_link-1053" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>first step in the table's security filter is to retrieve the user:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisUser = 
    LOOKUPVALUE(
        UserSecurity[EmpNr], 
        UserSecurity[Email], 
        USERPRINCIPALNAME()
   )
</code></pre>
    <p class="book-title--packt">Next, the path of the user and the organizational level is determined:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ThisUserPath = 
    LOOKUPVALUE(
        'Employee (private)'[Path],
        'Employee (private)'[EmpNr],
        ThisUser
    )
VAR ThisUserLevel = PATHLENGTH(ThisUserPath)
</code></pre>
    <p class="book-title--packt">The restriction "<em class="italic">only direct reports</em>" comes down to employees <a id="calibre_link-1064" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>who are reporting to this user (the user appears in their path) and who are direct reports (their level is one below the level of the user). In DAX:</p>
    <pre class="programlisting"><code class="hljs-code">PATHCONTAINS([Path], ThisUser) 
&amp;&amp; PATHLENGTH([Path]) &lt;= ThisUserLevel + 1
</code></pre>
    <p class="book-title--packt">Note that <code class="code-in-text--packt">&lt;=</code> is <a id="calibre_link-1637" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>used here (as opposed to just <code class="code-in-text--packt">=</code>) to include <code class="code-in-text--packt">ThisUser</code>, who is the only employee in her own path with the same level as her (by definition, <code class="code-in-text--packt">ThisUser</code> is not in the path of any employee with a level smaller than, or hierarchically above, <code class="code-in-text--packt">ThisUserLevel</code>, so no higher managers are included). The filter on <code class="code-in-text--packt">Employee (private)</code> will therefore be:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
(
    PATHCONTAINS([Path], ThisUser)
    &amp;&amp; PATHLENGTH([Path]) &lt;= ThisUserLevel + 1
    &amp;&amp; [Private] = 1
)
|| 
(
    NOT(
        PATHCONTAINS([Path], ThisUser)
           &amp;&amp; PATHLENGTH([Path]) &lt;= ThisUserLevel + 1
)
    &amp;&amp; [Private] = 0
)
</code></pre>
    <p class="book-title--packt">Do not forget to apply <code class="code-in-text--packt">NOT</code> to both the <code class="code-in-text--packt">PATHCONTAINS</code> clause and the <code class="code-in-text--packt">PATHLENGTH</code> clause: mind the parentheses!</p>
    <p class="book-title--packt">So far, we have assumed that there is one set of employee attributes that is private, and that a user who may see a private attribute of some employees can see all their private attributes. You can go one step further and define multiple sets of private attributes, for instance, to separate public attributes <a id="calibre_link-1054" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from contact details for use by peers, and from HR attributes that can only be viewed by managers. Be careful, however: it quickly complicates your model beyond what can be managed and, of course, these things take their toll on the<a id="calibre_link-1065" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> performance of your model too. </p>
    <p class="book-title--packt">But if needed, you <a id="calibre_link-1440" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can duplicate the structure to accommodate multiple sets of private attributes. You would have to create a model as pictured below:</p>
    <figure class="mediaobject"><img src="images/000187.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.24: Setup for multiple sets of private attributes</p>
    <p class="book-title--packt">Both private tables are linked directly to the public table. Having set this up, you can secure both sets of private attributes individually by applying RLS filters to the respective<a id="calibre_link-1441" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> tables. Again, RLS on the public table determines which rows are visible at all.</p>
    <h3 id="calibre_link-120" class="calibre8">How to develop in models with value-level security</h3>
    <p class="book-title--packt">One big issue <a id="calibre_link-1452" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with VLS is that developing reports against a VLS-enabled model becomes messy. As we saw in the previous section, when you have full access to a model, you will get duplicates of rows whenever you use a private attribute in a report. </p>
    <p class="book-title--packt">When working in the model itself, one easy approach would be not to load the negative rows of the private tables. This way, you will see all private attributes, but at least you'll get no duplicates. The best way to do this is to use a parameter to set whether or not to load the negative rows. With this, you can switch all private tables at once by changing the parameter value.</p>
    <p class="book-title--packt">Another approach is to create a <code class="code-in-text--packt">Development</code> table with a <code class="code-in-text--packt">Private</code> column containing values 0 and 1. You can then create relationships from all the private tables to the <code class="code-in-text--packt">Development</code> table on the <code class="code-in-text--packt">Private</code> columns. This allows you to set a filter in a report (<code class="code-in-text--packt">Development[Private] = 1</code>) to switch off all negative rows. This way, you can easily switch from within a report without having to expose the private tables themselves:</p>
    <figure class="mediaobject"><img src="images/000209.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.25: Creating a Development table with a relationship to private tables</p>
    <p class="book-title--packt">With these approaches, you will be able to build reports while seeing data just like a user would. You still need to make sure that users do not see all data because they have edit rights on the Power BI model.</p>
    <p class="book-title--packt">Another application of row-level security is to secure aggregation levels, which the next section is<a id="calibre_link-1453" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> about. You can use a similar approach to securing attributes, although there are some caveats.</p>
    <h1 id="calibre_link-121" class="title">Securing aggregation levels</h1>
    <p class="book-title--packt">Yet another<a id="calibre_link-283" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> element in securing a Power BI model is related to aggregation levels. There could be a policy like "<em class="italic">salary costs may be viewed by team, but individual employees' salaries can only be viewed by their direct manager</em>." In this section, we explore options to secure viewing results on different aggregation levels.</p>
    <h2 id="calibre_link-122" class="calibre8">Measures cannot be secured, fact tables can </h2>
    <p class="book-title--packt">We've mentioned it already earlier in this chapter: implementing security through DAX in measures is not secure. You should always design your model with a possible self-service user in mind, who will be able to write her own measures against the model. Through these, any security feature of your hard-wrought measures can be circumvented.</p>
    <p class="book-title--packt">Instead, security must rely on the model structure and RLS only. This means that not every security policy that you can think of can be implemented. For instance, your users could ask for sales by individuals, but sales margin by team only. As both measures work on data from the same fact table, it is not possible to do this. In other cases, data is taken from different fact tables (for instance, one with sales by individual, one with salary costs by team). </p>
    <h2 id="calibre_link-123" class="calibre8">Restricting fact table granularity</h2>
    <p class="book-title--packt">The most <a id="calibre_link-282" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>secure way of making sure that, say, salary costs can only be viewed by team and not by employee, is not to load these data at the employee level. You could create a salary costs fact table with rows per team. The obvious question here is how to give authorized users access to salary costs at the employee level anyway. You may do this with another dataset.</p>
    <p class="book-title--packt">One of the lesser-used features of <a id="calibre_link-533" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Power BI is <strong class="screentext">cross-report drillthrough</strong>. It is a feature that is not so easy to implement, as it heavily depends on how your models and reports are published in the Power BI service. We will not cover cross-report drillthrough in detail here, but the concept is that when you enable it and reports are in the same workspace, you can enable drillthrough actions in a report that jump not to another page in the same report, but to a page in another report.</p>
    <p class="book-title--packt">To get cross-report drillthrough to work, all that is needed is that fields in both reports used for the drillthrough action have the same name, so that Power BI can recognize them as being equal. The interesting thing here is that these reports don't have to use the same underlying model. This means that you can have a report with salary costs by team, and perform a drillthrough to a detailed report that shows salary costs by employee in a specific team. The model underlying the detailed report can implement its own security policies, so unauthorized users can be blocked from seeing the detailed data.</p>
    <h2 id="calibre_link-124" class="calibre8">Securing aggregation levels with composite models</h2>
    <p class="book-title--packt">Composite<a id="calibre_link-284" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> models <a id="calibre_link-697" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are Power BI models with a mix of DirectQuery fact tables and imported fact tables. The imported tables can be aggregated versions of the DirectQuery ones. This feature is designed to be able to report and analyze many billions of rows of data, and is based on the (plausible) assumption that users rarely need a look at lower detail levels in their data. Depending on the question asked, the model will choose to retrieve results from the aggregated table or, when needed, from the DirectQuery one. The selection is made automatically based on the aggregation level that is requested. To secure aggregation levels, this is not what we want; instead, we want to base this selection on security rules.</p>
    <p class="book-title--packt">Fortunately, this can be done. You could have one fact table with salary costs at the team level, say <code class="code-in-text--packt">fSalaryTeam</code>, and another one with salary costs at the employee level, <code class="code-in-text--packt">fSalaryEmployee</code>. With RLS, you can shield <code class="code-in-text--packt">fSalaryEmployee</code> from unauthorized users, or even give users access to <code class="code-in-text--packt">fSalaryEmployee</code> for only some part of the data, like that relevant to their own team. </p>
    <p class="book-title--packt">In the remainder of this section, we'll use a security role with access to the Europe division in the <code class="code-in-text--packt">Teams</code> table and to the <code class="code-in-text--packt">Europe 2</code> team (with <code class="code-in-text--packt">TeamNr = 9</code>) in the <code class="code-in-text--packt">fSalaryEmployee</code> table as a simple example: </p>
    <figure class="mediaobject"><img src="images/000007.png" alt="Diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.26: fSalaryTeam, fSalaryEmployee, Team, and Employee tables</p>
    <p class="book-title--packt">The <a id="calibre_link-285" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>security <a id="calibre_link-698" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>filters are:</p>
    <pre class="programlisting"><code class="hljs-code">[Division] = "Europe"    // in table Teams
RELATED(Employee[TeamNr]) = 9    // in table fSalaryEmployee
</code></pre>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The model file for this section is <code class="code-in-text--packt">2.1 Aggregation security 1.pbix</code>.</p>
    </div>
    <p class="book-title--packt">The challenge here is that you need to change the DAX code for measures; not to implement the security itself, but to seamlessly switch from one fact table to the other. Ideally, you would want one measure that takes salary costs from <code class="code-in-text--packt">fSalaryTeam</code> when evaluated on the team level or <a id="calibre_link-929" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>higher, but calculates over <code class="code-in-text--packt">fSalaryEmployee</code> when evaluated on the detailed level.</p>
    <p class="book-title--packt">This challenge comes down to determining what the evaluation context for the measure looks like. In <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>, you have seen several DAX functions that can help with <a id="calibre_link-931" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>that (<code class="code-in-text--packt">ISFILTERED</code>, <code class="code-in-text--packt">ISCROSSFILTERED</code>, and so on). Using these functions, you can build a measure that switches from one fact table to another. It is hard, though, to <a id="calibre_link-699" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>get<a id="calibre_link-286" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> it right, and some unexpected situations occur. Your first try might be the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">Salary Costs =
IF(
    HASONEVALUE(Employee[EmpNr]),
    SUM(fSalaryEmployee[Salary]),
    SUM(fSalaryTeam[Salary])
)
</code></pre>
    <p class="book-title--packt">This looks OK: whenever exactly one <a id="calibre_link-1466" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>employee number is selected, in whatever way, calculate the salary from the <code class="code-in-text--packt">fSalaryEmployee</code> table, or else, calculate it from the <code class="code-in-text--packt">fSalaryTeam</code> table. The function <code class="code-in-text--packt">HASONEVALUE</code> is often used by inexperienced DAX developers, mainly in constructions like the following:</p>
    <pre class="programlisting"><code class="hljs-code">IF(HASONEVALUE(Table[Number]),
    VALUES(Table[Number]) * 5
)
</code></pre>
    <p class="book-title--packt">Aside from the fact that there are better ways to extract a single value from a column, the <code class="code-in-text--packt">HASONEVALUE</code> (and, similarly, <code class="code-in-text--packt">HASONEFILTER</code>) functions have one property that is often overlooked: they return true when <em class="italic">exactly one</em> value is selected in the column. They return false when that number is <a id="calibre_link-1638" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>larger <a id="calibre_link-875" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>than one, but also when it is zero! </p>
    <p class="book-title--packt">The picture below shows the output from the <code class="code-in-text--packt">Salary Costs</code> measure <a id="calibre_link-876" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in our example security role:</p>
    <figure class="mediaobject"><img src="images/000025.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.27: Salary Costs output</p>
    <p class="book-title--packt">Notice how<a id="calibre_link-700" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> many <a id="calibre_link-287" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>employees seem to have the same salary costs, and that they are actually equal to the salary costs of the team. Notice also that an employee like Kai Bell seems to be in two teams! In fact, we see all employees <em class="italic">not</em> belonging to a team appearing with the result <a id="calibre_link-932" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for the team as a whole. The reason for that is that <code class="code-in-text--packt">HASONEVALUE</code> returns zero in those cases, causing the measure to choose <code class="code-in-text--packt">fSalaryTeam</code> to calculate over. For an in-depth discussion about why these employees are evaluated, see <em class="italic">Chapter 2.4</em>, <em class="italic">Working with AutoExist</em>.</p>
    <p class="book-title--packt">Now, you may try to use <code class="code-in-text--packt">ISFILTERED</code> instead of <code class="code-in-text--packt">HASONEVALUE</code> in the DAX formula. But it does not help to report salary costs by, for instance, pay level. It would be better to determine if the selection is a subset of a team, and switch to employee-level data in that case. </p>
    <p class="book-title--packt">One <a id="calibre_link-288" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>way to do this is to simply<a id="calibre_link-701" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> count the employees <a id="calibre_link-1467" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and compare the number with the total number of employees in the team:</p>
    <pre class="programlisting"><code class="hljs-code">Salary Costs =
IF(
    COUNTROWS(Employee) =
    CALCULATE(
        COUNTROWS(Employee),
        ALL(Employee),
        VALUES(Team[TeamNr])
    ),
    SUM(fSalaryTeam[Salary]),
    SUM(fSalaryEmployee[Salary])
)
</code></pre>
    <p class="book-title--packt">The picture below shows sample output <a id="calibre_link-508" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for this measure, both on employee name and on gender (both of which are columns in the <code class="code-in-text--packt">Employee</code> table):</p>
    <figure class="mediaobject"><img src="images/000046.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.28: Salary Costs for Europe 2 by employee name and gender</p>
    <p class="book-title--packt">The security <a id="calibre_link-702" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>role <a id="calibre_link-289" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>only shows the <code class="code-in-text--packt">Europe</code> division and <code class="code-in-text--packt">Salary Costs</code> at the employee level for team <code class="code-in-text--packt">Europe 2</code>. As you can see from the output, <code class="code-in-text--packt">Salary Costs</code> by team are returned for all teams within Europe; this clearly shows that these results are taken from the <code class="code-in-text--packt">fSalaryTeam</code> table. <code class="code-in-text--packt">Salary Costs</code> by individual employee are only returned for team <code class="code-in-text--packt">Europe 2</code>; for other teams, the measure correctly retrieves data from the <code class="code-in-text--packt">fSalaryEmployee</code> table but receives nothing because the security filter does not allow that. When reporting <code class="code-in-text--packt">Salary Costs</code> by gender, we are not looking at individual employees. Still, the measure recognizes that an aggregation level below the team level is requested and takes results from the <code class="code-in-text--packt">fSalaryEmployee</code> table. </p>
    <h2 id="calibre_link-125" class="calibre8">Combining aggregation security with value-level security</h2>
    <p class="book-title--packt">It is possible<a id="calibre_link-290" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to combine<a id="calibre_link-1442" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> securing the aggregation level with securing private data with RLS, but there are some additional things to take care of when you do this. The extended model would look like this:</p>
    <figure class="mediaobject"><img src="images/000067.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.29: Extending with an Employee (private) table</p>
    <p class="book-title--packt">If you were to change the output to <code class="code-in-text--packt">Salary Costs</code> by team and pay level, you would notice that you get the <code class="code-in-text--packt">Salary Costs</code> per team for each pay level. The reason, of course, is that our approach to <a id="calibre_link-509" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>determining whether <a id="calibre_link-1468" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a complete team is in context is falling flat now that we are using another table. An additional <code class="code-in-text--packt">ALL</code> clause should be added to the formula:</p>
    <pre class="programlisting"><code class="hljs-code">Salary Costs =
IF(
    COUNTROWS(Employee) =
    CALCULATE(
        COUNTROWS(Employee),
        ALL(Employee),
        ALL('Employee (private)'),
        VALUES(Team[TeamNr])
    ),
    SUM(fSalaryTeam[Salary]),
    SUM(fSalaryEmployee[Salary])
)
</code></pre>
    <p class="book-title--packt">With <a id="calibre_link-1443" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this, the<a id="calibre_link-291" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> measure returns correct results: </p>
    <figure class="mediaobject"><img src="images/000089.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.30: Salary Costs by team and pay level</p>
    <p class="book-title--packt">Always remember that half of the rows in the private table must be hidden to avoid duplicate output (for the figure above, the security filter <code class="code-in-text--packt">[Private] = 1</code> was applied).</p>
    <p class="book-title--packt">You can, of course, implement more sophisticated rules now. If you want to secure higher pay levels, for instance, you may use this security filter on <code class="code-in-text--packt">Employee (private)</code>:</p>
    <pre class="programlisting"><code class="hljs-code">([Paylevel] &lt;= 33 &amp;&amp; [Private] = 1)
||
([Paylevel] &gt; 33 &amp;&amp; [Private] = 0)
</code></pre>
    <p class="book-title--packt">The result of this, combined<a id="calibre_link-292" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> with<a id="calibre_link-1444" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the division and team filters discussed above, is the following:</p>
    <figure class="mediaobject"><img src="images/000110.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.31: Salary Costs by team and pay level, with higher pay levels secured</p>
    <p class="book-title--packt">Note that we don't see any results for pay levels above 33, but also that the numbers don't add up. Shouldn't we get a blank line here with the results for levels 34 and up? When you take a close look at the security filter, you'll notice that the negative clause doesn't do anything. There are no rows in <code class="code-in-text--packt">Employee (private)</code> with <code class="code-in-text--packt">Paylevel</code> 34 or higher and <code class="code-in-text--packt">Private = 0</code>: after all, the whole point of the rows indicated with <code class="code-in-text--packt">Private = 0</code> is that the other columns are blank! This means that we're not hiding one-half of the rows, but many more.</p>
    <p class="book-title--packt">If you like the output as it is, that's fine, of course. If not, you would have to determine which employees have those higher pay levels, and filter based on their employee numbers. When doing this (we used a lazy enumeration of some employee numbers), the blanks show up:</p>
    <figure class="mediaobject"> <img src="images/000131.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.32: Salary Costs by team and pay level, with higher pay levels secured and blanks shown</p>
    <p class="book-title--packt">As you can<a id="calibre_link-1445" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> see, it's <a id="calibre_link-293" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>not easy to get everything to work exactly how you would expect it; we now see blanks not only in team <code class="code-in-text--packt">Europe 2</code>, but in the other teams as well. After all, we do have access to these teams; all employees in those teams are grouped under the blank pay level, so the <code class="code-in-text--packt">Salary Costs</code> measure's logic determines that we're looking at all employees of the team and returns the team's salary costs. </p>
    <p class="book-title--packt">By fine-tuning the security filter on <code class="code-in-text--packt">Employees (private)</code>, you could even further control this and let the blank output only appear for team <code class="code-in-text--packt">Europe 2</code>. We'll leave that for you to detail out.</p>
    <h2 id="calibre_link-126" class="calibre8">Securing an aggregation level as an attribute</h2>
    <p class="book-title--packt">Above, we've <a id="calibre_link-277" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>discussed <a id="calibre_link-320" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>securing an aggregation level on a per-fact table basis. Another way to approach aggregation-level security is to consider the aggregation level as an attribute. This way, all connected fact tables and, as a consequence, all measures, are subject to the security policy. This is less flexible than our previous approach, but the upside is that you don't have to write specific DAX measures, and it's easier to set up.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The model file for this section is <code class="code-in-text--packt">2.1 Aggregation security 2.pbix</code>.</p>
    </div>
    <p class="book-title--packt">The basic idea here is that when we want to secure output on the individual employee level, we could just treat every employee attribute as private. In other words, the public <code class="code-in-text--packt">Employee</code> table would only contain the keys (<code class="code-in-text--packt">EmpNr</code> and <code class="code-in-text--packt">TeamNr</code>, in our example) and all other columns would move to the <code class="code-in-text--packt">Employee (private)</code> table. With the value-level security approach introduced in this chapter, the employee data&nbsp;can then be secured.</p>
    <figure class="mediaobject"><img src="images/000151.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.33: Leaving only the keys in the Employee table</p>
    <p class="book-title--packt">Suppose you want to implement the security policy "<em class="italic">only data for the Europe division can be viewed; and only for team Europe 2 can it be viewed on the employee level</em>." This can be done <a id="calibre_link-321" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with <a id="calibre_link-278" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>two security filters on the <code class="code-in-text--packt">Team</code> and <code class="code-in-text--packt">Employee (private)</code> tables. On the <code class="code-in-text--packt">Team</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">[Division] = "Europe"
</code></pre>
    <p class="book-title--packt">On the <code class="code-in-text--packt">Employee (private)</code> table (using the fact that team <code class="code-in-text--packt">Europe 2</code> has <code class="code-in-text--packt">TeamNr</code> 9, which can be found in the <code class="code-in-text--packt">Employee</code> table):</p>
    <pre class="programlisting"><code class="hljs-code">(RELATED(Employee[TeamNr]) = 9 &amp;&amp; [Private] = 1)
||
(RELATED(Employee[TeamNr]) &lt;&gt; 9 &amp;&amp; [Private] = 0)
</code></pre>
    <p class="book-title--packt">With a straightforward <code class="code-in-text--packt">Sales</code> measure, you get the result in the picture below:</p>
    <figure class="mediaobject"><img src="images/000172.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.34: Results of the security policy using VLS</p>
    <p class="book-title--packt">You can extend <a id="calibre_link-322" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this<a id="calibre_link-279" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to, again, securing certain attributes of employees by splitting the <code class="code-in-text--packt">Employee (private)</code> table and creating an <code class="code-in-text--packt">Employee (very private)</code> table (although we would recommend a different naming scheme by this point). This is the exact same principle as the solution to having different sets of private attributes discussed before. </p>
    <p class="book-title--packt">Both tables are related to the original <code class="code-in-text--packt">Employee</code> table:</p>
    <figure class="mediaobject"><img src="images/000194.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.35: Adding an Employee (very private) table</p>
    <p class="book-title--packt">You can now<a id="calibre_link-323" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> apply a<a id="calibre_link-280" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> different security filter to the <code class="code-in-text--packt">Employee (very private)</code> table, for example, to only allow access to very private data of employee 10220, using the positive/negative filter structure:</p>
    <pre class="programlisting"><code class="hljs-code">([EmpNr] = 10220 &amp;&amp; [Private] = 1)
||
([EmpNr] &lt;&gt; 10220 &amp;&amp; [Private] = 0)
</code></pre>
    <p class="book-title--packt">The result in a table visual is in the picture below:</p>
    <figure class="mediaobject"><img src="images/000216.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.1.36: Accessing the very private data of an employee</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">This <a id="calibre_link-324" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>approach to<a id="calibre_link-281" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> securing an aggregation level is not 100% secure, because the fact table still uses the granularity on the employee level. A self-service user could write measures to retrieve results for a specific employee with a formula like:</p>
      <pre class="programlisting"><code class="hljs-code">Sales 10201 = 
CALCULATE(
    [Sales],
    fSales[EmpNr] = 10201
)
</code></pre>
      <p class="book-title--packt">To be able to do this, the user would have to know that the number 10201 is used and what it stands for. If you implement this method, you should at least not use business<a id="calibre_link-1639" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> keys, such as employee<a id="calibre_link-1640" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> numbers, that are well known in your organization. </p>
    </div>
    <h1 id="calibre_link-127" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, you have seen many aspects of securing Power BI models. Row-level security is a versatile feature, mainly because you can use DAX to implement sophisticated security filters.</p>
    <p class="book-title--packt">Careful design is needed when implementing security in Power BI models, mainly due to the possibility of having multiple security roles, and because users may be a member of multiple roles. Not all security roles can effectively be combined in the same model, and security therefore even impacts decisions to split models.</p>
    <p class="book-title--packt">With DAX, you can retrieve a user's identity and use that to determine what data is visible, allowing for highly personalized security settings. You can even navigate an organization's hierarchical structure using DAX <code class="code-in-text--packt">PATH</code> functions. </p>
    <p class="book-title--packt">You have also learned that through effective combinations of modeling, DAX, and row-level security, you can achieve other forms of security, like value-level security to secure attributes, and securing aggregation levels.</p>
    <p class="book-title--packt">The overall conclusion is this: DAX has tremendous power not only as a calculation language, but also to implement security policies.</p>
    <p class="book-title--packt">In the next chapter, we will focus on a wholly different topic: visualizations, and how to make these even more dynamic than Power BI visuals already are.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-1530">
<div id="calibre_link-1641" class="calibre2">
<div id="calibre_link-1642" class="calibre3"><div id="calibre_link-1643" class="calibre4">
    <h1 class="chapternumber">2.2</h1>
    <h1 id="calibre_link-128" class="title">Dynamically Changing Visualizations</h1>
    <p class="book-title--packt">Visualizations in a Power BI report use data from the Power BI model in two ways. First, values from <em class="italic">columns</em> are used to populate visual elements like the axis in a column chart, row labels in a table visual, or selection items in a slicer. We use the term <strong class="screentext">label</strong> to generically refer<a id="calibre_link-964" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to these elements. Second, aggregated data from the model, typically in the form of <em class="italic">DAX measures</em>, provides the results that a visual represents. While it is not visually clear, the buckets or wells that are used to bind a visual to data fields distinguish between these two types of data usage. For instance, the buckets <strong class="screentext">Axis</strong> and <strong class="screentext">Legend</strong> demand label data and the <strong class="screentext">Values</strong> bucket needs aggregated data:</p>
    <figure class="mediaobject"><img src="images/000014.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.1: Field buckets for a Power BI visual</p>
    <p class="book-title--packt">While Power BI provides many ways to create compelling reports out of the box, sometimes you want to go beyond these. This chapter presents approaches to dynamically change both ways of data binding through DAX. The two ways of binding data (columns and measures) each require their own DAX approach. It is even possible to combine both to create highly dynamic visuals.</p>
    <p class="book-title--packt">In this chapter, we will cover the following topics:</p>
    <ul class="calibre9">
      <li class="bullet">Dynamic measures </li>
      <li class="bullet">Dynamic labels and axes</li>
      <li class="bullet">Creating helper tables</li>
      <li class="bullet">Combining dynamic labels with dynamic measures</li>
    </ul>
    <p class="book-title--packt">Let's get started by introducing the Power BI model we will use. </p>
    <h1 id="calibre_link-129" class="title">The business case</h1>
    <p class="book-title--packt">A bicycle company, QuantoBikes, uses <a id="calibre_link-401" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a Power BI model in order to keep track of their sales. Based on the data in the <code class="code-in-text--packt">fSales</code> table, the board<a id="calibre_link-961" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> has defined three key performance indicators (KPIs): the <strong class="screentext">sales per month</strong>, the <strong class="screentext">year-to-date sales</strong>, and the <strong class="screentext">12-month rolling sales</strong>. These KPIs can be analyzed by order date, invoice date, or delivery date, which are also available in the <code class="code-in-text--packt">fSales</code> table. Additionally, the board is interested in the sales by product, country, and retail type. The data for this information is stored in three different tables: <code class="code-in-text--packt">Products</code>, <code class="code-in-text--packt">Customers</code>, and <code class="code-in-text--packt">Cities</code>. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can download the model file for this chapter, <code class="code-in-text--packt">2.2 Dynamically changing visualizations.pbix</code>, from <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.2" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.2</span></a>.</p>
    </div>
    <p class="book-title--packt">The relationships between the different tables are depicted below:</p>
    <figure class="mediaobject"><img src="images/000033.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.2: The model diagram</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">Date</code> to <code class="code-in-text--packt">fSales</code> relationships <a id="calibre_link-402" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>consist of one <em class="italic">active</em> relationship from <code class="code-in-text--packt">Date[Date]</code><strong class="screentext"> </strong>to<strong class="screentext"> </strong><code class="code-in-text--packt">fSales[InvoiceDate]</code><strong class="screentext"> </strong>and<strong class="screentext"> </strong>two <em class="italic">inactive</em> relationships from <code class="code-in-text--packt">Date[Date]</code> to <code class="code-in-text--packt">fSales[OrderDate]</code> and from <code class="code-in-text--packt">Date[Date]</code><strong class="screentext"> </strong>to<strong class="screentext"> </strong><code class="code-in-text--packt">fSales[DeliveryDate]</code>.<strong class="screentext"> </strong>All other relationships are between the ID columns with the same name in both tables.</p>
    <p class="book-title--packt">Many different views on the sales data are requested. Putting a separate visual for each view on the same report page would result in a cramped report, which is not that insightful. Another approach would be to divide the views over different pages in the report, which makes it hard to find the views you want to see. </p>
    <p class="book-title--packt">The alternative is to make the visuals in the report dynamic, allowing the user to simply choose the view by, for instance, selecting an option in a slicer. What we want to accomplish is to create DAX measures that:</p>
    <ul class="calibre9">
      <li class="bullet">Allow the user to change the calculation applied</li>
      <li class="bullet">Allow the user<a id="calibre_link-1644" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to change both the calculation applied and the date column used in the sales table</li>
      <li class="bullet">Allow the user to change the labels</li>
      <li class="bullet">Combine all of the above into one visualization</li>
    </ul>
    <h1 id="calibre_link-130" class="title">Dynamic measures </h1>
    <p class="book-title--packt">A visual is bound to a measure by adding the measure to an appropriate bucket, like the <strong class="screentext">Value</strong> bucket in a column chart. What we want to achieve is to let the user select a KPI using a slicer and adapt<a id="calibre_link-716" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the measure to that selection. As measure binding is static (we cannot dynamically replace the measure with another measure), we need to create a DAX measure that responds to the slicer selection.</p>
    <p class="book-title--packt">For this dynamic measure to work, a couple of things are needed:</p>
    <ol class="calibre9">
      <li class="calibre12">We need to create basic measures for each KPI.</li>
      <li class="calibre12">In order to use a slicer, we need to create a helper table with the KPI description.</li>
      <li class="calibre12">We need to create a new measure that, based on the selection, selects the corresponding basic KPI measure.</li>
    </ol>
    <p class="book-title--packt">Let us start with the basics.</p>
    <h2 id="calibre_link-131" class="calibre8">The basic KPI measures</h2>
    <p class="book-title--packt">First, we create<a id="calibre_link-370" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the three basic<a id="calibre_link-717" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> DAX functions for<a id="calibre_link-962" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> our KPIs: </p>
    <ol class="calibre9">
      <li class="calibre12" value="1">The <strong class="screentext">sales per month</strong> will be calculated by the DAX table function <code class="code-in-text--packt">SUMX</code>:
        <pre class="programlisting"><code class="hljs-code">Sales = SUMX(
           fSales, 
           fSales[UnitAmount] * fSales[SalesPrice]
        )
</code></pre>
        <p class="bullet1">If you need more information about DAX table functions, see <em class="italic">Chapter 1.4</em>,<em class="italic"> </em><em class="italic">Context and Filtering</em>.</p>
      </li>
      <li class="calibre12">For the <strong class="screentext">year-to-date sales</strong> measure, we use the time intelligence DAX function <code class="code-in-text--packt">TOTALYTD</code>:
        <pre class="programlisting"><code class="hljs-code">YTD Sales = TOTALYTD([Sales],'Date'[Date])
</code></pre>
        <p class="bullet1">If you need more information on DAX time intelligence functions, see <em class="italic">Chapter 1.4</em>.</p>
      </li>
      <li class="calibre12">The last basic measure to calculate the <strong class="screentext">12-month rolling sales</strong> uses a combination of the DAX filter function <code class="code-in-text--packt">CALCULATE</code> and the time intelligence function <code class="code-in-text--packt">DATESINPERIOD</code>. If you <a id="calibre_link-577" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>need more<a id="calibre_link-1645" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> information on DAX filter<a id="calibre_link-1646" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> functions, see <em class="italic">Chapter 1.4</em>. We will adjust this basic calculation to our specific<a id="calibre_link-1647" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> needs during the process:
        <pre class="programlisting"><code class="hljs-code">12 mth Sales = 
CALCULATE(
    [Sales],
    DATESINPERIOD(
        'Date'[Date],
        MAX(fSales[OrderDate]), -12, MONTH)
)
</code></pre>
      </li>
    </ol>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">When using <code class="code-in-text--packt">DATESINPERIOD</code>, special consideration should be given to the reference date (<code class="code-in-text--packt">MAX(fSales[OrderDate])</code> in the formula above). This date is the last date in the 12-month period returned by <code class="code-in-text--packt">DATESINPERIOD</code>.</p>
      <p class="book-title--packt">In historical overviews, the reference date is the last day of the selected period, or <code class="code-in-text--packt">MAX('Date'[Date])</code>. For example, the 12-month rolling total for April 2020 is the sales for the 12 months ending with April 30, 2020. For a current view, this may not be the best option. For example, when <a id="calibre_link-991" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>today's date is January 13, 2022 and the context for the calculation selects January 2022, it would return sales for the period between February 1, 2021 and January 31, 2022. This includes almost half a month without sales, assuming no future sales are in our data. The result is a strange dip in the rolling total for the current month that only gradually improves when the month advances.</p>
      <p class="book-title--packt">When orders are placed almost every day, using <code class="code-in-text--packt">MAX(fSales[OrderDate])</code> solves this problem. When, again, today's date is January 13, 2022, the last order may be from January 12, 2022, and the running total is calculated over the period between January 13, 2021 and January 12, 2022.</p>
      <p class="book-title--packt">An alternative would be to use <code class="code-in-text--packt">MIN(MAX('Date'[Date]), TODAY())</code>, although in this case, you<a id="calibre_link-718" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> would need to solve the problem of all future months returning the current<a id="calibre_link-371" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> rolling total. After all, a context selecting<a id="calibre_link-963" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> January 2048 would still return the rolling total for today.</p>
    </div>
    <h2 id="calibre_link-132" class="calibre8">Creating a helper table</h2>
    <p class="book-title--packt">If we want the user to have a slicer in the report to select one of the KPIs, we need to have a column in the model<a id="calibre_link-719" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to populate the slicer. When <a id="calibre_link-578" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this column does not exist, we have<a id="calibre_link-879" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to create a table for<a id="calibre_link-491" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> this, called a <strong class="screentext">helper table</strong> or, alternatively, a <strong class="screentext">control table</strong>.</p>
    <p class="book-title--packt">The helper table that we need looks like this:</p>
    <figure class="mediaobject"><img src="images/000054.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.3: The helper table</p>
    <p class="book-title--packt">Our helper table contains three columns:</p>
    <ul class="calibre9">
      <li class="bullet">The first column is named <code class="code-in-text--packt">Code</code>. It is used to determine the selection. We always use whole powers of 2 to populate this column, in other words, 1, 2, 4, 8, and so on. The reasoning behind this sequence is explained below.</li>
      <li class="bullet">The second column is named <code class="code-in-text--packt">Sort</code>. It contains whole numbers, beginning with 1 in the first row and increasing by one with each row. You can use this column to sort the <code class="code-in-text--packt">Description</code> column (through the <strong class="screentext">Sort by column </strong>option) whenever you do not want the items to be sorted alphabetically.</li>
      <li class="bullet">The third column contains the <code class="code-in-text--packt">Description</code>. This is the column used in the slicer. You can, of course, use a name that aligns better with the selection made, like <code class="code-in-text--packt">Time period</code> in this case.</li>
    </ul>
    <p class="book-title--packt">The helper table can be created<a id="calibre_link-720" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> as a calculated table using a DAX formula. The table should be given<a id="calibre_link-880" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> an appropriate name: </p>
    <pre class="programlisting"><code class="hljs-code">Time period = 
DATATABLE(
    "Code", INTEGER,
    "Sort", INTEGER,
    "Description", STRING,
    {
        {1, 1, "Sales"},
        {2, 2, "YTD Sales"},
        {4, 3, "12 mths rolling"}
    }
)
</code></pre>
    <p class="book-title--packt">Before we create the dynamic DAX measure, let us discuss how to use the helper table. The helper table does not have relationships <a id="calibre_link-563" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with other tables in the model. When the <code class="code-in-text--packt">Description</code> column is used in a slicer, a selection in the slicer causes a filter on the column. As a result, the corresponding row is selected. Note that the user can select multiple rows when the slicer is not set on single select explicitly.</p>
    <p class="book-title--packt">In the model, we now have a query context on the helper table and we can use DAX to determine what selection was made. If you use the DAX <code class="code-in-text--packt">SUM</code> function on the <code class="code-in-text--packt">Code</code> column, the powers of 2 make sure that each combination of selected items corresponds to a unique sum of <code class="code-in-text--packt">Code</code> values. For example, a sum of 5 can only be the result of selecting both <strong class="screentext">Sales</strong> and <strong class="screentext">12 mths rolling</strong>. Therefore, based on the result of <code class="code-in-text--packt">SUM('Time period'[Code])</code>, we can decide which calculation to choose. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">There are other DAX functions that can be used here, like <code class="code-in-text--packt">SELECTEDVALUE</code>, which detects whether exactly one value in a column is selected. You should still use the <code class="code-in-text--packt">Code</code> column, though, to avoid having to change DAX code when someone decides that the descriptions should be changed. Our "powers of two" approach enables scenarios in which the selection<a id="calibre_link-881" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of two or more items is allowed.</p>
    </div>
    <h2 id="calibre_link-133" class="calibre8">Creating a dynamic DAX measure</h2>
    <p class="book-title--packt">Now that we know<a id="calibre_link-703" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> how to detect a slicer selection on the helper table, we can use a <code class="code-in-text--packt">SWITCH</code> function to select the <a id="calibre_link-1319" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>correct basic measure.</p>
    <p class="book-title--packt">The DAX formula for this dynamic measure is:</p>
    <pre class="programlisting"><code class="hljs-code">DynHelperSales = 
VAR SelectSales = SUM('Time period'[Code])
RETURN
SWITCH(SelectSales,
    1, [Sales],
    2, [YTD Sales],
    4, [12 mth Sales]
)
</code></pre>
    <p class="book-title--packt">Let us look more closely at the <code class="code-in-text--packt">SWITCH</code> function. This function takes a first argument, Expression, followed by an arbitrary number of Value/Result argument pairs, and closes off with an optional Else argument.</p>
    <p class="book-title--packt">The function evaluates the Expression<a id="calibre_link-1648" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> and compares it consecutively with the Values. When the Expression and a Value are equal, the corresponding Result is returned. If not, the Expression is compared to the next Value. When none of the Values are equal to Expression, the function returns Else, or a blank value if Else is omitted.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">In our example, we do not use the Else argument. So, if a selection is made that does not result in a value that is in the <code class="code-in-text--packt">SWITCH</code> list, the measure returns a blank.</p>
      <p class="book-title--packt">As not selecting anything is equivalent to selecting all items, not using a slicer on <code class="code-in-text--packt">Time period</code> at all will result in blank results. For users who build their own reports on this Power BI model, this can be confusing. For this reason, you may consider adding an Else clause as a default, like <code class="code-in-text--packt">[Sales]</code>.</p>
    </div>
    <p class="book-title--packt">The pictures below show sample output using this measure in a visual:</p>
    <figure class="mediaobject"><img src="images/000074.png" alt="Chart, histogram  Description automatically generated" class="calibre14" /> </figure>
    <p class="book-title--packt">Figure 2.2.4: Sales per month in 2021</p>
    <figure class="mediaobject"><img src="images/000096.png" alt="Chart, histogram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.5: YTD Sales in 2021</p>
    <p class="book-title--packt">Creating a dynamic visual using a helper table and dynamic DAX measure greatly enhances the experience of the user, who is now able to personalize part of the report. We can go one step further and combine this selection with a similar method to select the date used in the sales table. In doing<a id="calibre_link-704" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> so, a user can switch easily between a financial view (invoices), sales view (orders), and operations view (delivery).</p>
    <h2 id="calibre_link-134" class="calibre8">Selecting both the calculation and date columns dynamically </h2>
    <p class="book-title--packt">In the previous section, we developed a DAX measure to dynamically switch between sales by period, year-to-date<a id="calibre_link-464" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> sales, and 12-month rolling total sales. We now want to apply a similar approach in a slightly different way, to dynamically select a relationship to use. To give you an idea of what we want to achieve, we have added two visualizations:</p>
    <figure class="mediaobject"><img src="images/000118.png" alt="Chart, histogram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.6: Invoiced amounts per month in 2021</p>
    <figure class="mediaobject"><img src="images/000138.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.7: Value of delivered orders by month in 2021</p>
    <p class="book-title--packt">What do we want to do? In the <code class="code-in-text--packt">fSales</code> table, we have three date columns: <code class="code-in-text--packt">InvoiceDate</code>, <code class="code-in-text--packt">OrderDate</code>, and <code class="code-in-text--packt">DeliveryDate</code>, each of <a id="calibre_link-1649" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>which has a relationship with the <code class="code-in-text--packt">Date</code> table. By default, the active relationship on the <code class="code-in-text--packt">InvoiceDate</code> column is used. We want to use a slicer to dynamically activate one of the other relationships. </p>
    <p class="book-title--packt">There is one caveat here: we created<a id="calibre_link-465" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the 12-month rolling total based on <code class="code-in-text--packt">OrderDate</code>. Since the values in the other date columns are probably different, we need to adjust the DAX formula for the 12-month rolling total to use the proper date column.</p>
    <p class="book-title--packt">Again, we need a helper table to allow us to choose between the date columns. The DAX formula is similar to the formula for the first helper table, with a different third column:</p>
    <pre class="programlisting"><code class="hljs-code">Date selection = 
DATATABLE(
    "Code", INTEGER,
    "Sort", INTEGER,
    "Date selection", STRING,
    {
        {1, 1, "by order date"},
        {2, 2, "by invoice date"},
        {4, 3, "by delivery date"}
    }
)
</code></pre>
    <p class="book-title--packt">The DAX measure <code class="code-in-text--packt">DynHelperSales2</code> starts by determining the choices made in both helper tables:</p>
    <pre class="programlisting"><code class="hljs-code">DynHelperSales2 = 
    VAR SelectSales = SUM('Time period'[Code])
    VAR SelectDate = SUM('Date selection'[Code])
RETURN
SWITCH(SelectSales,
    1, SWITCH(SelectDate,
        1, CALCULATE([Sales],
                USERELATIONSHIP(fSales[OrderDate],'Date'[Date])
           ),
        2, [Sales],
        4, CALCULATE([Sales],
                USERELATIONSHIP(fSales[DeliveryDate],'Date'[Date])
           )
        ),
    2, SWITCH(SelectDate,
        1, CALCULATE([YTD Sales],
                USERELATIONSHIP(fSales[OrderDate],'Date'[Date])
            ),
        2, [YTD Sales],
        4, CALCULATE([YTD Sales],
                USERELATIONSHIP(fSales[DeliveryDate],'Date'[Date])
            )   
        ),
</code></pre>
    <p class="book-title--packt">To respond to both helper table<a id="calibre_link-466" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> selections, two <code class="code-in-text--packt">SWITCH</code> functions need<a id="calibre_link-1320" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to be nested. The outer <code class="code-in-text--packt">SWITCH</code>, on <code class="code-in-text--packt">SelectSales</code>, is the time <a id="calibre_link-1418" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>period selector as used in the previous section. The inner <code class="code-in-text--packt">SWITCH</code>, on <code class="code-in-text--packt">SelectDate</code>, activates the corresponding relationship. Note that <code class="code-in-text--packt">USERELATIONSHIP</code> has not been used in the option 2 inside the nested <code class="code-in-text--packt">SWITCH</code>. Since the relationship with the <code class="code-in-text--packt">InvoiceDate</code> column is the active one, the <code class="code-in-text--packt">USERELATIONSHIP</code> is not needed here.</p>
    <p class="book-title--packt">The rolling total option needs extra care, as we need to work from another reference date. Instead of calling the generic <code class="code-in-text--packt">[12 mth sales]</code> measure, the logic is different for each option. </p>
    <p class="book-title--packt">Each <code class="code-in-text--packt">CALCULATE</code> function<a id="calibre_link-467" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> now has<a id="calibre_link-1321" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> two filter arguments: one provides the rolling total period with the correct reference date, the other selects the correct relationship.</p>
    <pre class="programlisting"><code class="hljs-code">    4, SWITCH(SelectDate,
        1, CALCULATE([Sales],
                DATESINPERIOD(
                    'Date'[Date],
                    MAX(fSales[OrderDate]),
                    -12,
                    MONTH
                ),
                USERELATIONSHIP(fSales[OrderDate],'Date'[Date])
           ),
        2, CALCULATE([Sales],
                DATESINPERIOD(
                    'Date'[Date],
                    MAX(fSales[InvoiceDate]),
                    -12,
                    MONTH
                ),
                USERELATIONSHIP(fSales[InvoiceDate],'Date'[Date])
           ),
        4, CALCULATE([Sales],
                DATESINPERIOD(
                    'Date'[Date],
                    MAX(fSales[DeliveryDate]),
                    -12,
                    MONTH
                ),
                USERELATIONSHIP(fSales[DeliveryDate],'Date'[Date])
           )
    )
)
</code></pre>
    <p class="book-title--packt">When you use this measure in the <a id="calibre_link-579" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>column chart, you can select both the time period and the kind of sales (determined by the date <a id="calibre_link-1419" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationships), allowing for output like in <em class="italic">Figures 2.2.6</em> and <em class="italic">2.2.7</em>.</p>
    <p class="book-title--packt">The DAX formula can be rewritten<a id="calibre_link-1650" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in a way that avoids nested <code class="code-in-text--packt">SWITCH</code> functions. For this, we use <code class="code-in-text--packt">SWITCH</code> in a slightly different way<a id="calibre_link-1651" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> than is normally done. The common usage is to provide some value (typically, the result of some calculation) and then provide several options for static values to compare it with. </p>
    <p class="book-title--packt">But you can flip this around: provide a static first value, and calculated values to compare with. This takes advantage of the fact that <code class="code-in-text--packt">SWITCH</code> does all comparisons in order of the arguments and will stop at the first match.</p>
    <p class="book-title--packt">In the formula below, the first argument for <code class="code-in-text--packt">SWITCH</code> is the static value <code class="code-in-text--packt">TRUE()</code>. We then include tests on combinations of the <a id="calibre_link-1420" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selections, and the <a id="calibre_link-580" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>first test to return <code class="code-in-text--packt">TRUE()</code> is executed:</p>
    <pre class="programlisting"><code class="hljs-code">DynHelperSalesOption = 
VAR SelectSales = SUM('Time period'[Code])
VAR SelectDate = SUM('Date selection'[Code])
RETURN
SWITCH(TRUE(),
    SelectSales = 1 &amp;&amp; SelectDate = 1,
        CALCULATE([Sales], 
            USERELATIONSHIP(fSales[OrderDate],'Date'[Date])),
    SelectSales = 1 &amp;&amp; SelectDate = 2,
        CALCULATE([Sales],
            USERELATIONSHIP(fSales[InvoiceDate],'Date'[Date])),
    SelectSales = 1 &amp;&amp; SelectDate = 4,
        CALCULATE([Sales], 
            USERELATIONSHIP(fSales[DeliveryDate],'Date'[Date])),
    SelectSales = 2 &amp;&amp; SelectDate = 1,
        CALCULATE([YTD Sales],
            USERELATIONSHIP(fSales[OrderDate],'Date'[Date])),
    SelectSales = 2 &amp;&amp; SelectDate = 2,
        CALCULATE([YTD Sales],
            USERELATIONSHIP(fSales[InvoiceDate],'Date'[Date])),
    SelectSales = 2 &amp;&amp; SelectDate = 4,
        CALCULATE([YTD Sales],
            USERELATIONSHIP(fSales[DeliveryDate],'Date'[Date])),
    SelectSales = 4 &amp;&amp; SelectDate = 1,
        CALCULATE([Sales],
            DATESINPERIOD('Date'[Date],
            MAX(fSales[InvoiceDate]), -12, MONTH),
            USERELATIONSHIP(fSales[OrderDate], 'Date'[Date])),
    SelectSales = 4 &amp;&amp; SelectDate = 2,
        CALCULATE([Sales],
            DATESINPERIOD('Date'[Date], 
            MAX(fSales[InvoiceDate]), -12, MONTH),
            USERELATIONSHIP(fSales[InvoiceDate], 'Date'[Date])),
    SelectSales = 4 &amp;&amp; SelectDate = 4,
        CALCULATE([Sales],
            DATESINPERIOD('Date'[Date], 
            MAX(fSales[InvoiceDate]), -12, MONTH),
            USERELATIONSHIP(fSales[DeliveryDate], 'Date'[Date]))
)
</code></pre>
    <p class="book-title--packt">With this, we have a measure that includes multiple dynamic options in one formula. You can, of course, extend this with more selections in additional helper tables; enumerating all combinations in a single <code class="code-in-text--packt">SWITCH</code> expression avoids you having to nest even more levels of <code class="code-in-text--packt">SWITCH</code>.</p>
    <p class="book-title--packt">Having dynamic values in visuals<a id="calibre_link-468" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is one<a id="calibre_link-1322" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> thing. Having the dynamic selection of labels in a visual is another, providing even more flexibility to the report user. This is the topic of the section below.</p>
    <h1 id="calibre_link-135" class="title">Dynamic labels</h1>
    <p class="book-title--packt">Consider the following challenge. Your Power BI report contains a column chart with sales by city. The users of your report<a id="calibre_link-705" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> want to have the <a id="calibre_link-581" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>option to select other labels for this chart, allowing them to <a id="calibre_link-1421" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>view sales by, say, retail type or product group. Since you have already provided them with some slicers to select the measure used in the visual, you want to use a slicer to select the chart label as well.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">As this book is about DAX, we solve this problem with DAX. There are other options in Power BI: you could use bookmarks to show different charts, or allow the report user to select other fields from the model with personalized visuals. All options have pros and cons, like ease of use, the need to change DAX code, and the possibility of using a slicer or other report element to make the selection. We do not elaborate on the other options here.</p>
    </div>
    <p class="book-title--packt">In this section, a helper<a id="calibre_link-1652" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> table and custom DAX measures are used to solve this challenge. </p>
    <h2 id="calibre_link-136" class="calibre8">Solution overview</h2>
    <p class="book-title--packt">The fundamental difference between<a id="calibre_link-712" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> dynamic labels and the dynamic measures discussed earlier is that labels in a visual cannot be populated through calculated results. Instead, the label uses values from a single column in the model. </p>
    <p class="book-title--packt">But the labels we want to provide come from three different tables in the model:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">Country</code>, a column in the <code class="code-in-text--packt">Cities</code> table</li>
      <li class="bullet"><code class="code-in-text--packt">RetailType</code>, a column in the <code class="code-in-text--packt">Customers</code> table</li>
      <li class="bullet"><code class="code-in-text--packt">Group</code>, a column in the <code class="code-in-text--packt">Products</code> table</li>
    </ul>
    <p class="book-title--packt">All values in these columns need to be in a single column to use them in a visual. To accomplish that, we will create a special helper table with two columns. The first column contains an indicator of which type of label (<code class="code-in-text--packt">Country</code>, <code class="code-in-text--packt">RetailType</code>, or <code class="code-in-text--packt">Group</code>) is in a row, and the second column contains the values from the three columns. The first column can be used to select the label type. A DAX measure will then implement a dynamic relationship to one of the three original tables.</p>
    <h2 id="calibre_link-137" class="calibre8">Creating a helper table</h2>
    <p class="book-title--packt">The helper table is created<a id="calibre_link-709" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> as a calculated table based on a DAX formula. The figure<a id="calibre_link-882" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> below shows part of the table to give you an impression of what we aim to create:</p>
    <figure class="mediaobject"><img src="images/000158.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.8: The HelperAxes table</p>
    <p class="book-title--packt">In the formula to create<a id="calibre_link-710" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> this calculated table, three DAX variables are defined <a id="calibre_link-883" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>that each create one part of the helper table. This is the first variable:</p>
    <pre class="programlisting"><code class="hljs-code">HelperAxes = 
    VAR Country = 
    CROSSJOIN(
        ROW("Code", 1),
        ROW("LabelType", "Countries"),
        VALUES(Cities[Country])
    )
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">CROSSJOIN</code> function combines<a id="calibre_link-1653" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> multiple tables into one <a id="calibre_link-1469" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table that contains all columns from the input tables, and all combinations of rows in the input tables. In this case, we create a new table from three input tables:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">ROW("Code", 1)</code> is a table with one row and a <code class="code-in-text--packt">Code</code> column containing the value 1</li>
      <li class="bullet"><code class="code-in-text--packt">ROW("LabelType", "Countries")</code> is a one-row table as well, this time containing the value <code class="code-in-text--packt">"Countries"</code></li>
      <li class="bullet"><code class="code-in-text--packt">VALUES(Cities[Country])</code> is a one-column table, with possibly more than one row, containing the unique <code class="code-in-text--packt">Country</code> values</li>
    </ul>
    <p class="book-title--packt">Since both <code class="code-in-text--packt">ROW</code> functions only create a one-row table, the total number of rows in the <code class="code-in-text--packt">CROSSJOIN</code> table is the number of unique values of the <code class="code-in-text--packt">Cities[Country]</code> column.</p>
    <p class="book-title--packt">Similar variables are defined for the other label types to include. At the end, the <code class="code-in-text--packt">UNION</code> function is used to append the <a id="calibre_link-1654" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>rows of the three (table) variables and create one big helper table:</p>
    <pre class="programlisting"><code class="hljs-code">HelperAxes = 
    VAR Country = CROSSJOIN(
        ROW("Code", 1), 
        ROW("LabelType", "Countries"),
        VALUES(Cities[Country])
        )
    VAR Customer = CROSSJOIN(
        ROW("Code", 2),
        ROW("LabelType", "RetailType"),
        VALUES(Customers[RetailType])
        )
    VAR Product = CROSSJOIN(
        ROW("Code", 4), 
        ROW("LabelType", "Product Group"),
        VALUES(Products[Group]) 
        )
    RETURN
    UNION(Country, Customer, Product)
</code></pre>
    <p class="book-title--packt">The name of the second column, <code class="code-in-text--packt">Country</code>, is not suitable anymore, since it contains different kinds of information. The name is derived from the <code class="code-in-text--packt">Country</code> column in the <code class="code-in-text--packt">Cities</code> table. When<a id="calibre_link-711" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the table has been made, double-click on the<a id="calibre_link-884" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> header name and change the name <code class="code-in-text--packt">Country</code> to <code class="code-in-text--packt">AxisValues</code>. </p>
    <h2 id="calibre_link-138" class="calibre8">Creating a DAX measure using dynamic labels</h2>
    <p class="book-title--packt">Now that we have a helper<a id="calibre_link-713" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> table to support dynamic labels, we <a id="calibre_link-1470" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>need a DAX measure<a id="calibre_link-673" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> that selects the type of label to be used in a visual based on user input. Note that we don't really change labels; we just make sure that the measure only returns results for the label values corresponding to the selected label type. The visual will not show labels without any value. To give you an idea of what we want, below<a id="calibre_link-1655" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> are the results of the <code class="code-in-text--packt">DynAxis</code> measure we<a id="calibre_link-1656" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> are going to create.</p>
    <figure class="mediaobject"><img src="images/000179.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.9: The DynAxis measure showing sales by country</p>
    <figure class="mediaobject"><img src="images/000201.png" alt="Chart, histogram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.10: The DynAxis measure showing sales by product group</p>
    <p class="book-title--packt">Like in the measure for dynamic<a id="calibre_link-714" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> calculations, we <a id="calibre_link-1393" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use <code class="code-in-text--packt">SWITCH</code> to determine<a id="calibre_link-674" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the selection made:</p>
    <pre class="programlisting"><code class="hljs-code">DynAxis = 
SWITCH(
    SELECTEDVALUE(HelperAxes[Code]),
    1,
    CALCULATE([Sales],
        TREATAS(VALUES(HelperAxes[AxisValues]), Cities[Country])
    ),
    2,
    CALCULATE([Sales],
        TREATAS(VALUES(HelperAxes[AxisValues]), Customers[RetailType])
    ),
    4,
    CALCULATE([Sales],
        TREATAS(VALUES(HelperAxes[AxisValues]), Products[Group])
    )
)
</code></pre>
    <p class="book-title--packt">Note that there are now multiple rows <a id="calibre_link-1323" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with the same value in the <code class="code-in-text--packt">Code</code> column. To correctly determine the selection, we <a id="calibre_link-1471" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have to use <code class="code-in-text--packt">SELECTEDVALUE</code> to retrieve the unique code values selected, and then determine the actual values.</p>
    <p class="book-title--packt">The DAX function <code class="code-in-text--packt">TREATAS</code> performs the real magic here. <code class="code-in-text--packt">TREATAS</code> takes a list of values and applies these as a filter to another column. The two columns do not need to be related in any way. You can interpret this as <code class="code-in-text--packt">TREATAS</code> creating a virtual relationship. Because of the way the DAX formula is structured, for each choice in label type, a virtual relationship to another table is created (<code class="code-in-text--packt">Cities</code>, <code class="code-in-text--packt">Customers</code>, or <code class="code-in-text--packt">Products</code>). "Real" relationships on these tables propagate the filter onto other tables in the model.</p>
    <p class="book-title--packt">Look again at the figures at the <a id="calibre_link-1324" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>start of the section for the result of the DAX measure in a visual. The slicer filters on the <code class="code-in-text--packt">LabelType</code> column from the helper table, while the <code class="code-in-text--packt">AxisValues</code> column is used on the <em class="italic">y</em>-axis of the chart.</p>
    <p class="book-title--packt">The helper table and DAX measure<a id="calibre_link-715" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> successfully implement a dynamic <em class="italic">y</em>-axis. The obvious<a id="calibre_link-675" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> question now is: <em class="italic">can we also add the slicers for time period and sales type that were implemented in the dynamic calculation section</em>? This is, in fact, not hard to do, although it comes with some work.</p>
    <h1 id="calibre_link-139" class="title">Combining dynamic labels and dynamic calculations</h1>
    <p class="book-title--packt">If you want <a id="calibre_link-706" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to combine the dynamic labels and the dynamic calculations in one visual, you need to use a logical <a id="calibre_link-1394" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>combination of the DAX logic we have seen so far. We can still use <code class="code-in-text--packt">SWITCH</code> to determine selections made by the user, but keep in mind that the number of options grows fast. In our case, we have three helper tables, each with three options, meaning 3 x 3 x 3 = 27 options inside the <code class="code-in-text--packt">SWITCH</code> function. That is a lot of DAX code to write! Here are examples of the results:</p>
    <figure class="mediaobject"><img src="images/000002.png" alt="Timeline  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.11: Sales by countries and order date</p>
    <figure class="mediaobject"><img src="images/000020.png" alt="Chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.2.12: 12-month rolling sales by retail type and delivery date</p>
    <p class="book-title--packt">It would be too <a id="calibre_link-707" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>much to include all this code on these pages. Instead, you can find the code in the model for this chapter. For now, let us take a look at some parts of the calculation. Below is the start of the DAX <a id="calibre_link-1472" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>formula <a id="calibre_link-1395" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with three <a id="calibre_link-1325" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>variable declarations to capture the choices of the user:</p>
    <pre class="programlisting"><code class="hljs-code">DynHelperSales3 = 
    VAR SelectSales = SUM('Time period'[Code])
    VAR SelectDate = SUM('Date selection'[Code])
    VAR SelectAxis = SELECTEDVALUE(HelperAxes[Code])
RETURN
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">SWITCH</code> function again uses the <code class="code-in-text--packt">SWITCH(TRUE()</code> approach we saw earlier. The first option looks like this:</p>
    <pre class="programlisting"><code class="hljs-code">SWITCH(TRUE(),
    SelectSales = 1 &amp;&amp; SelectDate = 1 &amp;&amp; SelectAxis = 1,
        CALCULATE(
            [Sales], 
            USERELATIONSHIP(fSales[OrderDate], 'Date'[Date]),
            TREATAS(VALUES(HelperAxes[AxisValues]), Cities[Country])
    ),
</code></pre>
    <p class="book-title--packt">Again, all options need to evaluate to <code class="code-in-text--packt">TRUE()</code> or <code class="code-in-text--packt">FALSE()</code>; <code class="code-in-text--packt">SWITCH</code> only executes the first option that is true. The option shown here is:</p>
    <ul class="calibre9">
      <li class="bullet">The <code class="code-in-text--packt">[Sales]</code> measure, because <code class="code-in-text--packt">SelectSales</code> equals 1</li>
      <li class="bullet">The relationship on <code class="code-in-text--packt">OrderDate</code>, as <code class="code-in-text--packt">SelectDate</code> is 1</li>
      <li class="bullet">A virtual relationship using <code class="code-in-text--packt">TREATAS</code> on <code class="code-in-text--packt">Cities[Country]</code> as a result of <code class="code-in-text--packt">SelectAxis = 1</code></li>
    </ul>
    <p class="book-title--packt">In <a id="calibre_link-1396" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>comparison, the <a id="calibre_link-708" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>option <a id="calibre_link-1326" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for 12-month <a id="calibre_link-582" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>rolling total <a id="calibre_link-1422" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales on delivery date by retail type uses this DAX code:</p>
    <pre class="programlisting"><code class="hljs-code">SelectSales = 4 &amp;&amp; SelectDate = 2 &amp;&amp; SelectAxis = 2,
        CALCULATE(
            [Sales], 
            DATESINPERIOD(
                'Date'[Date],
                MAX(fSales[InvoiceDate]),
                -12, 
                MONTH
            ),
            USERELATIONSHIP(fSales[InvoiceDate],'Date'[Date]),
            TREATAS(
                VALUES(HelperAxes[AxisValues]), 
                Customers[RetailType]
            )
         ),
</code></pre>
    <p class="book-title--packt">Although the complete formula is very long, all options have a similar structure. Note again that <code class="code-in-text--packt">SWITCH</code> evaluates options in order until one is true; the order in which you include the options <a id="calibre_link-1473" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in the <code class="code-in-text--packt">SWITCH</code> expression is completely up to you. It helps to keep a logical order, but you may gain performance slightly by positioning<a id="calibre_link-1657" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the most common option as the first one.</p>
    <h1 id="calibre_link-140" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, you have learned how to use helper tables to capture user input. Depending on your intended use, a helper table can be as simple as a few rows with options, or a larger list based on other data in the Power BI model. In most cases, helper tables have no relationships with other tables in the model. User input in the form of a selection in a slicer can be captured in DAX measures. The <code class="code-in-text--packt">SWITCH</code> function is used to select the appropriate calculation based on the user input.</p>
    <p class="book-title--packt">Keep in mind that when using multiple helper tables for dynamic selections, it is better to use an extended <code class="code-in-text--packt">SWITCH</code> statement than to work with nested <code class="code-in-text--packt">SWITCH</code> functions. Be aware that nesting can also occur through calling another measure that does its own <code class="code-in-text--packt">SWITCH</code>. Piling up dynamic selectors like this can eventually lead to performance issues.</p>
    <p class="book-title--packt">In the next chapter, we dive deeper into calendar-based analysis. While we have used several time-intelligence DAX functions in this chapter, many organizations cannot use them because they work with a type of calendar that is not natively supported by DAX.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-0">
<div id="calibre_link-1658" class="calibre2">
<div id="calibre_link-1659" class="calibre3"><div id="calibre_link-1660" class="calibre4">
    <h1 class="chapternumber">2.3</h1>
    <h1 id="calibre_link-141" class="title">Alternative Calendars</h1>
    <p class="book-title--packt">Few Power BI models are not concerned with dates. The proper way to handle time-based analysis in a Power BI model is to have a date or calendar table. It allows you to evaluate results not only by the periods of time you select, but also to compare results with the same result in the previous year, calculate year-to-date totals, or do other comparisons over time. In <em class="italic">Chapter 1.3</em>, <em class="italic">Using DAX</em>, the date table in a Power BI model was discussed. In <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>, we covered DAX time intelligence functions that provide a wealth of time-based filter options.</p>
    <p class="book-title--packt">The built-in DAX time intelligence functions assume that you use the common Gregorian calendar. As you know, this calendar organizes days into months with a variable number of days, quarters consisting of three months, and years containing four quarters. Many businesses do not work with the Gregorian calendar, but use a calendar that is primarily week-based instead. In such a calendar, days roll up in weeks, weeks are combined into periods containing a variable number of weeks, quarters contain three periods, and years contain four quarters as usual.</p>
    <p class="book-title--packt">This type of calendar is very common in companies with a continuous production process. Using a week-based calendar has several advantages in this case, like being able to compare some period with the same period in the previous year, while knowing that both periods contain exactly the same number of days.</p>
    <p class="book-title--packt">This chapter deals with calendar-based analysis for week-based calendars. You will explore the following topics:</p>
    <ul class="calibre9">
      <li class="bullet">Conceptual differences between week-based calendars and the Gregorian calendar</li>
      <li class="bullet">Creating a week-based calendar table</li>
      <li class="bullet">Time intelligence analysis on week-based calendars</li>
      <li class="bullet">Keeping your report current</li>
    </ul>
    <h1 id="calibre_link-142" class="title">Week-based and Gregorian calendars</h1>
    <p class="book-title--packt">Let us first <a id="calibre_link-1087" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>zoom in<a id="calibre_link-867" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to what makes a week-based calendar fundamentally different from the Gregorian calendar, and what varieties exist in week-based calendars. We will choose one variety to work with in the remainder of this chapter.</p>
    <h2 id="calibre_link-143" class="calibre8">What is a week-based calendar?</h2>
    <p class="book-title--packt">While in both <a id="calibre_link-1661" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>week-based and Gregorian calendars, the day is the smallest unit, there is a huge difference in how days are grouped into larger units. While the Gregorian calendar knows about weeks, a week is not a proper hierarchical level in the calendar: most months are about 4Â½ weeks long, except for February (and not even in leap years). Even February usually starts somewhere in the middle of a week.</p>
    <p class="book-title--packt">A week-based calendar uses the week as a proper hierarchical level from which all higher levels are defined. A week-based calendar does not have a month; instead, weeks are grouped into periods.</p>
    <p class="book-title--packt">The advantage of a week-based calendar is that the end date of a period is always the same (last) day of a week. Since each period has a predictable length of a fixed number of weeks, this calendar type is very useful for manufacturing planning. The disadvantage of a week-based calendar is that it misses one day in the (Gregorian) year (7 days x 52 weeks = 364 days). To account for that, every five years a 53rd week is added. This can make comparisons in the last period of the year difficult.</p>
    <p class="book-title--packt">The table below lists the differences between the Gregorian and week-based calendars:</p>
    <table id="calibre_link-1662" class="no-table-style">
      <colgroup class="calibre17">
        <col class="calibre18"></col>
        <col class="calibre18"></col>
      </colgroup>
      <tbody class="calibre19">
        <tr class="no-table-style1">
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Gregorian calendar</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Week-based calendar</p>
          </td>
        </tr>
        <tr class="no-table-style3">
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Month-based</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Week-based with periods consisting of whole weeks</p>
          </td>
        </tr>
        <tr class="no-table-style1">
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Month starts on a random weekday</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Week (and periods) always start on the same weekday </p>
          </td>
        </tr>
        <tr class="no-table-style3">
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Months have different numbers of days, which makes comparisons difficult</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Periods follow a simple, repeating structure with mostly the same number of days</p>
          </td>
        </tr>
        <tr class="no-table-style1">
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Year and month can be read and extracted from the date, as we commonly refer to dates in their Gregorian representation, like January 4, 2023</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Calculations are needed to derive week number, period, and even year from the date</p>
          </td>
        </tr>
        <tr class="no-table-style3">
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Sometimes a year lasts one day longer</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Sometimes a year lasts one week longer</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="book-title--packt">Table 2.3.1: Gregorian versus week-based calendars</p>
    <h2 id="calibre_link-144" class="calibre8">Week numbers</h2>
    <p class="book-title--packt">In a <a id="calibre_link-870" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>week-based <a id="calibre_link-1501" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calendar, weeks are the second hierarchical level, after days. The basis of a week is a set of seven days, although, depending on the definition used, some weeks have fewer days. The number of weeks in a year is 52 normally, but as a Gregorian year is 52.143 weeks long, in some years week 53 is added to compensate. </p>
    <p class="book-title--packt">There are different definitions of week numbers, based on regional practices. The ISO 8601 definition, widely used in Europe, has the following characteristics:</p>
    <ul class="calibre9">
      <li class="bullet">Each new ISO week starts on a Monday.</li>
      <li class="bullet">An ISO week can start in one (Gregorian) year and end in the next year. For instance, ISO week 52 in 2021 starts on Monday, December 27, 2021, and ends on Sunday, January 2, 2022.</li>
      <li class="bullet">By definition, January 4 always belongs to ISO week 1. Alternatively, the first Thursday of the year always belongs to ISO week 1.</li>
    </ul>
    <p class="book-title--packt">The week number definitions used in the USA are different; they are characterized by the following:</p>
    <ul class="calibre9">
      <li class="bullet">Each week starts on a Sunday.</li>
      <li class="bullet">January 1 always belongs to week 1.</li>
      <li class="bullet">As a consequence, the first and the last week of a given year have, in general, less than 7 days. In <em class="italic">Figure 2.3.1</em>, you see that week number 1 in 2022 consists of one day, and week 53 ends on Friday, December 31 2021:<figure class="mediaobject"><img src="images/000040.png" alt="Table  Description automatically generated with medium confidence" class="calibre14" /></figure>
      </li>
    </ul>
    <p class="book-title--packt">Figure 2.3.1: The differences between ISO and USA week numbers</p>
    <p class="book-title--packt">Power BI provides a DAX function called <code class="code-in-text--packt">WEEKNUM</code> that returns the week number of a given <a id="calibre_link-871" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>date. The<a id="calibre_link-1502" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> second argument of this function allows you to switch between different week number definitions. We will only focus on options 1 and 21 here:</p>
    <ul class="calibre9">
      <li class="bullet">Use <code class="code-in-text--packt">1</code> and the start of the week will be on Sunday (USA definition).</li>
      <li class="bullet">Use <code class="code-in-text--packt">21</code> and the ISO week number will be returned.</li>
    </ul>
    <p class="book-title--packt">The <code class="code-in-text--packt">WEEKNUM</code> function will automatically deal with years that contain 53 weeks.</p>
    <h2 id="calibre_link-145" class="calibre8">Periods</h2>
    <p class="book-title--packt">In the <a id="calibre_link-868" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Gregorian<a id="calibre_link-1499" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> calendar, months have varying numbers of days but a year always has 12 months. This makes months a popular reporting level. Using 52 or 53 weeks per year for reporting is less convenient; that is why an additional hierarchical level is defined in a week-based calendar: the <strong class="screentext">period</strong>. A <a id="calibre_link-1066" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>period contains a whole number of weeks (the calendar is week-based, after all), and a year contains a fixed number of periods.</p>
    <p class="book-title--packt">These prerequisites lead to various options, like:</p>
    <ul class="calibre9">
      <li class="bullet">Periods of 4 weeks each, with 13 periods in a year</li>
      <li class="bullet">Periods of 4 or 5 weeks each, with 12 periods in a year</li>
    </ul>
    <p class="book-title--packt">The first option has the advantage of fixed period lengths, but the periods are less aligned with the Gregorian months, which makes this calendar less intuitive for many people. On top of that, as 13 is a prime number, the year cannot be divided into larger parts than periods, like quarters.</p>
    <p class="book-title--packt">The more common option is to divide the year into 12 periods. Each period has 4 or 5 ISO weeks, although the last period may have week 53 added as well. You can group the periods into different patterns. A 4-5-4 calendar uses a pattern of one 4-week period, one 5-week period, and another 4-week period. Some companies use a 5-4-4 calendar, but the most common choice is to use a 4-4-5 calendar.</p>
    <p class="book-title--packt">In the <a id="calibre_link-1663" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>remainder of this chapter, we will use a 4-4-5 calendar. All calculations are easily adapted to other week-based calendars.</p>
    <h2 id="calibre_link-146" class="calibre8">Quarters</h2>
    <p class="book-title--packt">A quarter<a id="calibre_link-869" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in<a id="calibre_link-1500" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the Gregorian calendar spans 3 months. In a 4-4-5 calendar, we work with periods, and a quarter now spans 3 periods, or 13 ISO weeks. This is exactly 91 days per quarter. Only the last quarter can contain 7 days more because of week 53. With this exception, comparisons between quarters are based on exactly the same number of days. </p>
    <h2 id="calibre_link-147" class="calibre8">Years</h2>
    <p class="book-title--packt">The <a id="calibre_link-872" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>common<a id="calibre_link-1503" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> Gregorian year contains 365 days. The actual time needed for the Earth to orbit the sun is around 365.25 days, so every four years there is a leap year that is one day longer. A year is the period normally used to evaluate business. If you use a 4-4-5 calendar, the start and the end of each year are defined by the first and last week in the year. In the week numbering system used in the USA, the fixed week length is sacrificed to match the start and end of the Gregorian year. In the ISO 8601 week numbering system, things are reversed: here, the alignment with the Gregorian year is sacrificed to keep the fixed week length.</p>
    <p class="book-title--packt">It is a common mistake to use ISO week numbers in a Power BI model in combination with the Gregorian year. When working with the ISO standard, you should not only use the correct week numbering and have periods in your calendar table, but you should also have an <strong class="screentext">ISO year</strong> that<a id="calibre_link-939" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> aligns with the week numbers.</p>
    <p class="book-title--packt">The difference is mainly in the first and last days of the year, of course; this is where the ISO 8601 standard puts days in December in week 1 of the new year, or days in January in week 52 (or 53) of the previous year. By definition, the first Thursday in the year is in week 1; this<a id="calibre_link-1664" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> means that on every Thursday in the year, the Gregorian<a id="calibre_link-1665" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> year matches the ISO year.</p>
    <h1 id="calibre_link-148" class="title">Creating a week-based calendar table</h1>
    <p class="book-title--packt">When you <a id="calibre_link-1513" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>want to use a week-based calendar, you need to have an appropriate date table. In this section, we will construct a date table as a calculated table with DAX. We will give it the name <code class="code-in-text--packt">ISO Date</code>, and use the ISO 8601 standard.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can download the model file for this chapter, <code class="code-in-text--packt">2.3 Alternative calendars.pbix</code>, from <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.3" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.3</span></a>.</p>
    </div>
    <h2 id="calibre_link-149" class="calibre8">Setting up dates</h2>
    <p class="book-title--packt">Since the Gregorian<a id="calibre_link-933" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> calendar is the basis of all date calculations in DAX, we start the calendar formula as a date table based on the Gregorian calendar. The next step is adding columns to translate the Gregorian into a 4-4-5 calendar, followed by some necessary changes. We start with some variables to define the first and last year in the table: </p>
    <pre class="programlisting"><code class="hljs-code">ISO Date 1 = 
VAR StartYear = 2019
VAR EndYear = YEAR(TODAY())
RETURN
ADDCOLUMNS(
   CALENDAR(DATE(StartYear, 1, 1), DATE(EndYear, 12, 31)),
    "ISOWeek", WEEKNUM([Date], 21)
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">StartYear</code> variable defines the year at which the date table needs to start; we have chosen 2019 here. The <code class="code-in-text--packt">EndYear</code> variable retrieves the year of today's date using a combination of the DAX <a id="calibre_link-473" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>functions <code class="code-in-text--packt">YEAR</code> and <code class="code-in-text--packt">TODAY</code>. </p>
    <p class="book-title--packt">The <code class="code-in-text--packt">CALENDAR</code> function returns a single-column table, in which the column is named <code class="code-in-text--packt">Date</code>, containing a contiguous set of dates between the dates provided in the two arguments. Using the <code class="code-in-text--packt">DATE</code> function, we <a id="calibre_link-268" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have constructed January 1 of the start year, and December 31 of the end year.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Note that you can define <code class="code-in-text--packt">StartYear</code> and <code class="code-in-text--packt">EndYear</code> in any way you like. Both can be static values, in which case you may be in trouble when more recent data from after <code class="code-in-text--packt">EndYear</code> is loaded. You can decide to have the table end at next year <a id="calibre_link-1666" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>instead of the current year by simply using <code class="code-in-text--packt">YEAR(TODAY()) + 1</code>. You could also choose to base <code class="code-in-text--packt">StartYear</code> on data that is in the fact tables in your model.</p>
    </div>
    <p class="book-title--packt">The <code class="code-in-text--packt">ADDCOLUMNS</code> function is used to &ndash; you guessed it &ndash; add columns to a table. Next to an input table, this function needs both a name for the columns to be added, and an expression to define what values are in the different rows. This expression, evaluated in row context on the input table, can use values from the columns in the input table. The column added here contains the ISO week numbers.</p>
    <p class="book-title--packt">If you look at the results of this formula, in the <code class="code-in-text--packt">ISOWeek</code> column, you'll notice that the first week only has 6 days:</p>
    <figure class="mediaobject"><img src="images/000026.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.2: Week 1 in 2019 is missing a day</p>
    <p class="book-title--packt">As mentioned earlier, the first ISO week can start in the current (Gregorian) year, but also in the previous year. The same can happen in the last ISO week of the year: the week might end in the next Gregorian year, and we will miss days in the last week. Let's first correct <a id="calibre_link-930" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the beginning and the end of the table.</p>
    <h2 id="calibre_link-150" class="calibre8">Finding the correct start date</h2>
    <p class="book-title--packt">After providing<a id="calibre_link-1512" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the start and end year for which to create a week-based table, we need to find the correct dates to create a table with full ISO weeks. Unfortunately, this is way more complex than we'd like; we will approach it step by step and find the correct start date first.</p>
    <p class="book-title--packt">The formula needs to calculate the correct start of the first ISO week, regardless of the year. One thing we know is that, by definition, January 4 is always in ISO week 1. We can therefore use January 4 as an approximate start date and derive the exact start date from it:</p>
    <pre class="programlisting"><code class="hljs-code">ISO Date 2 = 
VAR StartYear = 2019
VAR EndYear = YEAR(TODAY())
VAR ApproxStartDate = DATE(StartYear, 1, 4)
VAR ExactStartDate = ApproxStartDate - WEEKDAY(ApproxStartDate, 3)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">ExactStartDate</code> variable uses the <code class="code-in-text--packt">WEEKDAY</code> function. This function returns the number of the day within a week. The first argument is a date, the <code class="code-in-text--packt">ApproxStartDate</code> in our case. The second argument specifies how the days are counted throughout the week. The argument accepts the values 1 to 3:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">1:</strong> The first day of the week is a Sunday with number 1 and the last day is a Saturday with number 7.</li>
      <li class="bullet"><strong class="screentext">2:</strong> The first day of the week is a Monday with number 1 and the last day is a Sunday with number 7.</li>
      <li class="bullet"><strong class="screentext">3:</strong> The first day of the week is a Monday with number 0 and the last day is a Sunday with number 6.</li>
    </ul>
    <p class="book-title--packt">We take option 3, as this allows us to subtract the weekday number from the date to always arrive at a Monday, or the start of the week in which the date falls:</p>
    <figure class="mediaobject"><img src="images/000062.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.3: Weekday option 3 can help to retrieve the first day of the week</p>
    <p class="book-title--packt">In the figure, you can see that January 4, 2019, was a Friday, with weekday number 4 using option 3. Subtracting 4 from the date, we arrive at Monday, December 31, 2018. So, the first <a id="calibre_link-270" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>day of ISO year 2019 is the last day of Gregorian year 2018. If we use <code class="code-in-text--packt">ExactStartDate</code> as the first day in the calendar table, we are sure that the first week is complete.</p>
    <p class="book-title--packt">Now that we have the correct start date for our table, let's focus on the correct ending of the last year.</p>
    <h2 id="calibre_link-151" class="calibre8">Finding the correct end date</h2>
    <p class="book-title--packt">The correct end<a id="calibre_link-1509" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> date for our table is harder to find. Again, we start with a Gregorian candidate: December 31. The following figure shows the dates around year-end 2021 and early 2022: </p>
    <figure class="mediaobject"><img src="images/000126.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.4: The last ISO week of 2021</p>
    <p class="book-title--packt">As can be seen here, the first two days of 2022 are still in ISO week 52 of ISO year 2021. The question is: how can we use what we know about December 31 to derive what the last day of the<a id="calibre_link-1667" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> year is?</p>
    <p class="book-title--packt">Let us list the possible scenarios. December 31 may be in three ISO weeks: week 52, week 53, or week 1 in the next year.</p>
    <ul class="calibre9">
      <li class="bullet">If the ISO week number is <strong class="screentext">52</strong> or <strong class="screentext">53</strong>, we know that this is the last week of the year, and we simply have to find the last day of the week. (In case you were wondering, if the week number is 52, there can be no week 53: that week would start on January 1 or later, and that means that January 4 would be in that week as well. But, by definition, January 4 is in week 1.)</li>
      <li class="bullet">If the ISO week number is <strong class="screentext">1</strong>, the next year has already started. In this case, the last day of the year can be found by moving back a full week and then finding the last day of that week.</li>
    </ul>
    <p class="book-title--packt">As every ISO week starts on a Monday, the end of the last ISO week in the table needs to be a Sunday. With <code class="code-in-text--packt">WEEKDAY</code>, you can calculate the number of days you need to add: this is 6 minus the weekday number (with option 3).</p>
    <p class="book-title--packt">Let's put this into DAX code now:</p>
    <pre class="programlisting"><code class="hljs-code">VAR ApproxEndDate = DATE(EndYear, 12, 31)
VAR ExactISOWeekDate = ApproxEndDate -
        7 * (WEEKNUM(ApproxEndDate, 21) = 1)
VAR ExactEndDate = ExactISOWeekDate &ndash;
        (6 &ndash; WEEKDAY(ExactISOWeekDate, 3))
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">(WEEKNUM(ApproxEndDate, 21) = 1)</code> expression returns a Boolean, true or false, but in arithmetic, this is translated to 1 or 0, respectively. If the ISO week number of <code class="code-in-text--packt">ApproxEndDate</code> equals 1, it subtracts 7 x 1 days, <a id="calibre_link-474" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>otherwise it subtracts 0 days. So, only when the ISO week number is 1, we move <code class="code-in-text--packt">ExactISOWeekDate</code> to one week before <code class="code-in-text--packt">ApproxEndDate</code>. As we now have a date that is <a id="calibre_link-269" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>guaranteed to be in the last week of the ISO year, we move to the end of that week in the <code class="code-in-text--packt">ExactEndDate</code> variable.</p>
    <p class="book-title--packt">Now that we <a id="calibre_link-1510" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have both the correct start date and end date, we can use all these variables to create our calendar table:</p>
    <pre class="programlisting"><code class="hljs-code">ISO Date 2 = 
VAR StartYear = 2019
VAR EndYear = YEAR(TODAY())
VAR ApproxStartDate = DATE(StartYear, 1, 4)
VAR ExactStartDate = ApproxStartDate - WEEKDAY(ApproxStartDate, 3)
VAR ApproxEndDate = DATE(EndYear, 12, 31)
VAR ExactISOWeekDate = ApproxEndDate -
        7 * (WEEKNUM(ApproxEndDate, 21) = 1)
VAR ExactEndDate = ExactISOWeekDate +
        (6 &ndash; WEEKDAY(ExactISOWeekDate, 3))
RETURN
ADDCOLUMNS(
    CALENDAR(ExactStartDate, ExactEndDate),
    "ISOWeek", WEEKNUM([Date], 21)
)
</code></pre>
    <p class="book-title--packt">The start and end of the resulting table are as follows:</p>
    <figure class="mediaobject"><img src="images/000104.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.5: The start and the end of the ISO Date 2 table</p>
    <p class="book-title--packt">With this, we have a date table with ISO week numbers that contains complete ISO years. This <a id="calibre_link-1511" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table can now be extended with other columns, like the period number. This is the topic of the next section.</p>
    <h2 id="calibre_link-152" class="calibre8">Creating additional columns</h2>
    <p class="book-title--packt">An important<a id="calibre_link-1505" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> column to include is the <strong class="screentext">period</strong>. The structure of a 4-4-5 period calendar means that ISO weeks 1 to 4 belong to period 1, weeks 5 to 8 are in period 2, and the five weeks 9 to 13 are in period 3; and so on until the end of the year. You may want to find some arithmetic trick to compute the period number from the week number, but we will keep it <a id="calibre_link-271" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>simple and just list all week numbers with their period numbers. The following code is to be used as a calculated column in the table created above.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can add these columns in the table formula created earlier. We do not do that here to keep things readable, but you can find the complete formula in the model file. As some of the new columns, such as the <code class="code-in-text--packt">Period</code> column described here, use columns that are themselves added as calculated columns or in <code class="code-in-text--packt">ADDCOLUMNS</code>, you need nested <code class="code-in-text--packt">ADDCOLUMNS</code> functions to accomplish this.</p>
    </div>
    <pre class="programlisting"><code class="hljs-code">Period =
          ( [ISOWeek] IN {1, 2, 3, 4})             *  1 +
          ( [ISOWeek] IN {5, 6, 7, 8})             *  2 +
          ( [ISOWeek] IN {9, 10, 11, 12, 13})      *  3 +
          ( [ISOWeek] IN {14, 15, 16, 17})         *  4 +
          ( [ISOWeek] IN {18, 19, 20, 21})         *  5 +
          ( [ISOWeek] IN {22, 23, 24, 25, 26})     *  6 +
          ( [ISOWeek] IN {27, 28, 29, 30})         *  7 +
          ( [ISOWeek] IN {31, 32, 33, 34})         *  8 +
          ( [ISOWeek] IN {35, 36, 37, 38, 39})     *  9 +
          ( [ISOWeek] IN {40, 41, 42, 43})         * 10 +
          ( [ISOWeek] IN {44, 45, 46, 47})         * 11 +
          ( [ISOWeek] IN {48, 49, 50, 51, 52, 53}) * 12
</code></pre>
    <p class="book-title--packt">In the code, each <code class="code-in-text--packt">([ISOWeek] IN {...})</code> expression is either true or false, which is translated into 1 or 0, respectively. In the list of expressions, exactly one is true in any row. For instance, if the ISO <a id="calibre_link-992" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>week number is 18, the expression <code class="code-in-text--packt">[ISOWeek] IN {18, 19, 20, 21}</code> is true, while<a id="calibre_link-1506" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> all the others are false. The calculation will return 1 x 5, or period 5.</p>
    <p class="book-title--packt">A simple column to add <a id="calibre_link-1515" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is the <strong class="screentext">weekday</strong>:</p>
    <pre class="programlisting"><code class="hljs-code">Weekday = WEEKDAY([Date])
</code></pre>
    <p class="book-title--packt">Another column we want to<a id="calibre_link-940" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> have is the <strong class="screentext">ISO year</strong>. This is the code:</p>
    <pre class="programlisting"><code class="hljs-code">ISO Year = YEAR([Date] - WEEKDAY([Date], 3) + 3)
</code></pre>
    <p class="book-title--packt">For this column, we simply apply the logic that we used earlier to find the first day of the week for any date. When we subtract the weekday number with option 3, we get the Monday in the same week. And by definition, this Monday is in the same ISO year as the date itself. However, this Monday could be in a previous Gregorian year; so, to make sure we can use the <code class="code-in-text--packt">YEAR</code> function, we add 3 again to move to the Thursday. (Remember that the Gregorian year and the ISO year are the same for each Thursday.)</p>
    <p class="book-title--packt">For the time intelligence calculations later in this chapter, we will find that having a <strong class="screentext">week counter</strong> in the<a id="calibre_link-1514" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> date table is very helpful. This counter is a value that starts at zero for the first week in the date table and is increased by 1 with every week:</p>
    <pre class="programlisting"><code class="hljs-code">WeekCtr = ROUNDDOWN(([Date] &ndash; MIN([Date]) / 7, 0)
</code></pre>
    <p class="book-title--packt">This formula computes the difference between a date and the first date, divides it by 7 to get an approximate <a id="calibre_link-993" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>number of weeks between them, and rounds down to a whole number. The result of this is a counter that starts at zero in the first week in the table.</p>
    <p class="book-title--packt">Another useful column is a <strong class="screentext">period counter</strong>. This cannot be calculated from the dates, like <code class="code-in-text--packt">WeekCtr</code> above; instead, we <a id="calibre_link-1067" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use the ISO years and the period number to calculate a unique number:</p>
    <pre class="programlisting"><code class="hljs-code">PeriodCtr = ([ISO Year] &ndash; MIN([ISO Year])) * 12 + [Period]
</code></pre>
    <p class="book-title--packt">This calculation is based on the fact that every ISO year has 12 periods. For a day in the first period in 2019, for instance, January 9, 2019, the result of the formula is:</p>
    <pre class="programlisting"><code class="hljs-code">     (2019 &ndash; 2019) * 12 + 1 = 1
</code></pre>
    <p class="book-title--packt">If you use a date from the first period in the second accounting year, for instance, January 9, 2020, the result is:</p>
    <pre class="programlisting"><code class="hljs-code">    (2020 &ndash; 2019) *12 + 1 = 13
</code></pre>
    <p class="book-title--packt">This way, we have a continuously increasing sequence.</p>
    <p class="book-title--packt">Finally, we create three columns that are based on one or two of the basic columns. First, the <code class="code-in-text--packt">Year-week</code> column<a id="calibre_link-1507" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> combines the ISO year with the ISO week number. The second column, <code class="code-in-text--packt">Year-period</code>, combines the ISO year with the period number. The <code class="code-in-text--packt">Previous Year</code> column is just the ISO year minus 1 and will prove useful in the time intelligence calculations coming up:</p>
    <pre class="programlisting"><code class="hljs-code">Year-week = ([ISO Year] * 100) + [ISOWeek],
Year-period = ([ISO Year] * 100) + [Period]
Previous Year = [ISO Year] - 1
</code></pre>
    <p class="book-title--packt">The calendar is now ready for use in the remainder of this chapter. Below is some sample data:</p>
    <figure class="mediaobject"><img src="images/000146.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.6: The start of the ISO Date table</p>
    <p class="book-title--packt">Note that because of the different approach, the <code class="code-in-text--packt">WeekCtr</code> and <code class="code-in-text--packt">PeriodCtr</code> columns start at different values. This is not a problem, as these columns are only needed to freely move across <a id="calibre_link-1508" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the date table; their actual values do not matter.</p>
    <h1 id="calibre_link-153" class="title">Time Intelligence calculations for week-based calendars</h1>
    <p class="book-title--packt">Now that <a id="calibre_link-1361" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>we have created <a id="calibre_link-1504" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a 4-4-5 calendar table, we can start using this table to do time intelligence analysis. Instead of the common time intelligence calculations like year-to-date or month-to-date, we now need ISO-year-to-date, or period-to-date calculations. Since the standard DAX time intelligence functions are based on the Gregorian calendar, we will need to build our own calculations. To demonstrate the formulas, we will analyze the sales of the company QuantoBikes.</p>
    <h2 id="calibre_link-154" class="calibre8">The Power BI model</h2>
    <p class="book-title--packt">QuantoBikes <a id="calibre_link-1366" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>wants <a id="calibre_link-1088" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to monitor its sales. Since it uses a 4-4-5 calendar, all results need to be reported accordingly. These are the insights needed:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Year-to-date sales</strong>: The cumulative sales within an (ISO) year.</li>
      <li class="bullet"><strong class="screentext">Year-on-year growth</strong>: Comparing sales of a day, week, period, quarter, or year to the results in the same time period of the previous year. As QuantoBikes works with a 4-4-5 calendar, the number of days in each time period is exactly the same.</li>
      <li class="bullet"><strong class="screentext">Rolling average sales</strong>: Average sales per ISO week within a rolling window of weeks.</li>
    </ul>
    <p class="book-title--packt">The Power BI model used is very simple: all it contains is a fact table, <code class="code-in-text--packt">fSales</code>, and the <code class="code-in-text--packt">ISO Date</code> table. The <a id="calibre_link-1367" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationship<a id="calibre_link-1089" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> between them is defined on the <code class="code-in-text--packt">InvoiceDate</code> column in <code class="code-in-text--packt">fSales</code>.</p>
    <figure class="mediaobject"><img src="images/000166.png" alt="Graphical user interface  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.7: The Power BI model</p>
    <p class="book-title--packt">Some straightforward results can be computed with basic aggregations:</p>
    <pre class="programlisting"><code class="hljs-code">Sales = SUM(fSales[Amount])
Quantity = SUM(fSales[Units])
</code></pre>
    <p class="book-title--packt">These DAX measures allow us to view, for instance, sales by week:</p>
    <figure class="mediaobject"><img src="images/000188.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.8: Sales by ISO week</p>
    <p class="book-title--packt">In the next few <a id="calibre_link-1368" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sections, we will <a id="calibre_link-1668" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>develop the required time intelligence calculations.</p>
    <h2 id="calibre_link-155" class="calibre8">Calculating year-to-date results</h2>
    <p class="book-title--packt">The year-to-date<a id="calibre_link-1375" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> calculation <a id="calibre_link-1527" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>returns the <a id="calibre_link-596" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>cumulative values in a selected year. The equivalent Gregorian time intelligence function is <code class="code-in-text--packt">TOTALYTD</code>, or <code class="code-in-text--packt">DATESYTD</code> as a filter for use in <code class="code-in-text--packt">CALCULATE</code>. Technically, these functions start with the last day in the query context, and create a filter context with all days in the same year up to and including that last day. We must create the same logic in the week-based calendar.</p>
    <p class="book-title--packt">This is the code:</p>
    <pre class="programlisting"><code class="hljs-code">SalesYTD = 
VAR MaxDate = MAX('ISO Date'[Date])
VAR ThisISOYear = MAX('ISO Date'[ISO Year])
RETURN
CALCULATE(
    [Sales],
    'ISO Date'[Date] &lt;= MaxDate,
    'ISO Date'[ISO Year] = ThisISOYear,
    ALL('ISO Date')
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">MaxDate</code> variable stores the last selected day in the context. The <code class="code-in-text--packt">ThisISOYear</code> variable stores the last ISO year, which is the year corresponding to <code class="code-in-text--packt">MaxDate</code>. </p>
    <p class="book-title--packt">In the <code class="code-in-text--packt">CALCULATE</code>, the <code class="code-in-text--packt">[Sales]</code> measure is evaluated in a filter context created by three filter arguments. The <code class="code-in-text--packt">'ISO Date'[Date] &lt;= MaxDate</code> argument causes no dates to be selected after <code class="code-in-text--packt">MaxDate</code>. The second filter, <code class="code-in-text--packt">'ISO Date'[ISO Year] = ThisISOYear</code>, makes sure that the selected dates are all in the selected ISO year. The last filter argument, <code class="code-in-text--packt">ALL('ISO Dates')</code>, removes other filters from the ISO date table. </p>
    <p class="book-title--packt">The following <a id="calibre_link-1376" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>chart <a id="calibre_link-1528" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>shows <code class="code-in-text--packt">SalesYTD</code> for the year 2020 in a column chart with periods&nbsp;on the axis:</p>
    <figure class="mediaobject"><img src="images/000210.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.9: The year-to-date sales in 2020</p>
    <p class="book-title--packt">In a similar way, a period-to-date calculation can be made. This time, we do not select dates in the same ISO year, but in the same period. The <code class="code-in-text--packt">PeriodCtr</code> column is ideal for this:</p>
    <pre class="programlisting"><code class="hljs-code">SalesPTD =
VAR MaxDate = MAX('ISO Date'[Date])
VAR ThisPeriod = MAX('ISO Date'[PeriodCtr])
RETURN
CALCULATE(
    [Sales],
    'ISO Date'[Date] &lt;= MaxDate,
    'ISO Date'[Period] = ThisPeriod,
    ALL('ISO Date')
)
</code></pre>
    <p class="book-title--packt">Here is the result of this measure in a chart:</p>
    <figure class="mediaobject"><img src="images/000008.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.10: Period-to-date sales</p>
    <p class="book-title--packt">This chart <a id="calibre_link-1377" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>shows<a id="calibre_link-1529" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> period-to-date sales by week for periods 3 and 4 in 2020. As expected, the values accumulate in later weeks in the same period, but start over in a&nbsp;new period.</p>
    <h2 id="calibre_link-156" class="calibre8">Calculating sales growth</h2>
    <p class="book-title--packt">To calculate <a id="calibre_link-1369" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>year-on-year<a id="calibre_link-1253" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> growth, we need to compare sales in the "current" year (whatever year we want to view) with sales in the previous year. As the <code class="code-in-text--packt">Sales</code> measure already calculates sales in the current year, all we need to do is to create a calculation that returns results for the selected period, but in the previous year. This is the 4-4-5 equivalent of the <code class="code-in-text--packt">SAMEPERIODLASTYEAR</code> function.</p>
    <p class="book-title--packt">Since a date selection can span different hierarchical levels of the 4-4-5 calendar, like days, ISO weeks, periods, or ISO years, the formula we build must detect which level is selected. For example, when period 5 of 2021 is selected, we need the formula to calculate results for period 5 in 2020; when week 43 in 2020 is selected, results for week 43 in 2019 must be returned, and so on.</p>
    <p class="book-title--packt">The situation where a single day, or a small set of days, is selected deserves special consideration. There are several approaches to what the corresponding day or days in the previous year are. You could argue that we can just take the same date, so May 3, 2021 would result in May 3, 2020. However, the same date in another year does not necessarily fall in the same week number. Taking the same date would cause inconsistent results.</p>
    <p class="book-title--packt">We will take <a id="calibre_link-1370" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the following <a id="calibre_link-1254" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>definition: the "last year" equivalent of a day is the day in the previous ISO year that has the same week number and weekday number. This means that May 3, 2021, which is in week 18 and is a Monday, corresponds to April 27, 2020, which is the Monday that is in week 18 in that year.</p>
    <p class="book-title--packt">This definition complicates things even more, as a multi-day selection may be in more than one week. What we need to do is <a id="calibre_link-934" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>take the week/weekday combinations that correspond to the dates, and move them one year back.</p>
    <p class="book-title--packt">The DAX formula starts with the <code class="code-in-text--packt">SWITCH</code> function, followed by the day-level calculation:</p>
    <pre class="programlisting"><code class="hljs-code">Sales Last Year =
SWITCH(
    TRUE(), 
    ISFILTERED('ISO Date'[Date]),
        VAR PYDates = 
            SELECTCOLUMNS(
                'ISO Date',
                "ISOWeek", 'ISO Date'[ISOWeek],
                "Weekday", 'ISO Date'[Weekday],
                "Previous Year", 'ISO Date'[Previous Year]
            )
        RETURN
        CALCULATE(
            [Sales],
            TREATAS(
                PYDates,
                'ISO Date'[ISOWeek],
                'ISO Date'[Weekday],
                'ISO Date'[ISO Year]
            ),
            ALL('ISO Date')
        ),
</code></pre>
    <p class="book-title--packt">The first argument is <code class="code-in-text--packt">TRUE()</code>. This means <a id="calibre_link-1327" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>that the cases in the <code class="code-in-text--packt">SWITCH</code> expression are evaluated to determine whether or not they are true. The <a id="calibre_link-1397" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>first option to be evaluated, <code class="code-in-text--packt">ISFILTERED('ISO Date'[Date])</code> in the second argument of <code class="code-in-text--packt">SWITCH</code>, examines whether a filter is placed on the day column. If so, the third argument is evaluated and returned. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt"><code class="code-in-text--packt">ISFILTERED</code> requires a direct filter on the <code class="code-in-text--packt">'ISO Date'[Date]</code> column. You should not use <code class="code-in-text--packt">ISCROSSFILTERED</code>, since this function would also be triggered when a higher-level column, like <code class="code-in-text--packt">Period</code> or <code class="code-in-text--packt">ISO Year</code>, is filtered.</p>
    </div>
    <p class="book-title--packt">The <code class="code-in-text--packt">PYDates</code> variable<a id="calibre_link-1255" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> retrieves the selected dates, but not with the ISO year, but the previous<a id="calibre_link-1371" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> year. The <code class="code-in-text--packt">SELECTCOLUMNS</code> function simply picks a set of columns from an existing table. In this <a id="calibre_link-1295" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>case, we choose the week number, the weekday number, and the previous year. <code class="code-in-text--packt">SELECTCOLUMNS</code> requires us to provide (new) column names for the selected columns. The names we <a id="calibre_link-1669" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>choose do not matter really, because of how we use the table. In the <code class="code-in-text--packt">CALCULATE</code> function, <code class="code-in-text--packt">TREATAS</code> is used to apply the <code class="code-in-text--packt">PYDates</code> table as a filter to the <code class="code-in-text--packt">ISO Date</code> table again, but now using the <code class="code-in-text--packt">Previous Year</code> values as ISO year values. This gives exactly the same selection of days, but now in the previous year.</p>
    <p class="book-title--packt">If the <code class="code-in-text--packt">ISFILTERED('ISO Date'[Date])</code> clause is false, the next argument is tested: </p>
    <pre class="programlisting"><code class="hljs-code">     ISFILTERED('ISO Dates'[ISOWeek]),
        VAR PYWeeks =
            SUMMARIZE(
                'ISO Date',
                'ISO Date'[ISOWeek],
                'ISO Date'[Previous Year]
            )
        RETURN
        CALCULATE(
            [Sales],
            TREATAS(
                PYWeeks,
                'ISO Date'[ISOWeek],
                'ISO Date'[ISO Year]
            ),
            ALL('ISO Date')
        ),        
</code></pre>
    <p class="book-title--packt">If there is a filter on the column <code class="code-in-text--packt">'ISO Dates'[ISOWeek]</code>, we want to return results for the corresponding weeks in the <a id="calibre_link-1398" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>previous year. The approach is similar to what we did for a selection of days, but this time, we need a table with weeks. The <code class="code-in-text--packt">SUMMARIZE</code> function does the trick here, providing a table with the unique combinations of week numbers and previous year values. Again, <code class="code-in-text--packt">CALCULATE</code> applies the previous year values as a filter to select ISO year values.</p>
    <p class="book-title--packt">The formula <a id="calibre_link-1372" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>continues <a id="calibre_link-1256" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in a similar manner for a selection on the <code class="code-in-text--packt">Period</code> level:</p>
    <pre class="programlisting"><code class="hljs-code">    ISFILTERED('ISO Dates'[Period]),
        VAR PYPeriods =
            SUMMARIZE(
                'ISO Date',
                'ISO Date'[Period],
                'ISO Date'[Previous Year]
            )
        RETURN
        CALCULATE(
            [Sales],
            TREATAS(
                PYPeriods,
                'ISO Date'[Period],
                'ISO Date'[ISO Year]
            ),
            ALL('ISO Date')
        ),
</code></pre>
    <p class="book-title--packt">Here, the set of selected <code class="code-in-text--packt">Period</code> values with the <a id="calibre_link-935" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>corresponding previous year is selected and applied as a filter argument in <code class="code-in-text--packt">CALCULATE</code> in the <a id="calibre_link-1474" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>same way as before. Note that, as the calendar has a consistent structure at the <code class="code-in-text--packt">Period</code> level, a different approach could be taken as well: you could start <a id="calibre_link-1399" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with the <code class="code-in-text--packt">PeriodCtr</code> values selected and subtract 12 from each value to end up in the same period in the previous year. But we will stick with the approach used at lower <a id="calibre_link-1328" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>levels for the sake of consistency within the formula.</p>
    <p class="book-title--packt">Finally, when none of the columns mentioned above are filtered, we are in a situation in which either the ISO year column is filtered, or <a id="calibre_link-1296" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>nothing is filtered at all. In both cases, we return the results of the previous year or years. This means that the last clause is the "else" argument in <code class="code-in-text--packt">SWITCH</code>:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR PYYears =
        VALUES('ISO Date'[Previous Year])
    RETURN
    CALCULATE(
        [Sales],
        TREATAS(
            PYYears,
            'ISO Date'[ISO Year]
        ),
         ALL('ISO Date')
    )
)
</code></pre>
    <p class="book-title--packt">As we only<a id="calibre_link-1373" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> use one<a id="calibre_link-1257" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> column now, we can work with <code class="code-in-text--packt">VALUES</code> instead of <code class="code-in-text--packt">SUMMARIZE</code> to retrieve the <code class="code-in-text--packt">Previous Year</code> values in the selection. These values are then used to filter the <code class="code-in-text--packt">ISO Year</code> column in <code class="code-in-text--packt">CALCULATE</code>. Note that when nothing is selected, the result depends on which years are in the <code class="code-in-text--packt">ISO Date</code> table: for instance, when the table contains the ISO years 2019, 2020, and 2021, the previous years are 2018, 2019, and 2020. As 2018 is not in the table, the result will be the sales for 2019 and 2020 combined. This is consistent with the behavior of the <code class="code-in-text--packt">SAMEPERIODLASTYEAR</code> function.</p>
    <p class="book-title--packt">With this, our last year calculation is finished. To <a id="calibre_link-1475" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculate year-on-year growth, we simply compare it with the current sales:</p>
    <pre class="programlisting"><code class="hljs-code">Sales Growth % =
VAR ThisYear = [Sales]
VAR LastYear = [Sales Last Year]
RETURN
DIVIDE(ThisYear &ndash; LastYear, LastYear)
</code></pre>
    <p class="book-title--packt">The following charts show some of the results of the <code class="code-in-text--packt">Sales Last Year</code> measure. The first chart shows results for the first 15 <a id="calibre_link-1261" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>weeks of 2019 and 2020:</p>
    <figure class="mediaobject"><img src="images/000027.png" alt="Chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.11: Sales and Sales Last Year by ISO week number</p>
    <p class="book-title--packt">In <a id="calibre_link-1258" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <a id="calibre_link-1374" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>dark-colored <code class="code-in-text--packt">Sales Last Year</code> columns, it is easy to recognize the pattern of <code class="code-in-text--packt">Sales</code> in the year before. The same can be seen in a chart by <code class="code-in-text--packt">Period</code>:</p>
    <figure class="mediaobject"><img src="images/000047.png" alt="Chart, bar chart, histogram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.12: Sales and Sales Last Year by Period</p>
    <p class="book-title--packt">Here<a id="calibre_link-1670" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> again, the <code class="code-in-text--packt">Sales Last Year</code> for the<a id="calibre_link-1671" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> periods in 2020 shows exactly the same results as <code class="code-in-text--packt">Sales</code> in the year 2019.</p>
    <h2 id="calibre_link-157" class="calibre8">Moving average by week within an accounting year</h2>
    <p class="book-title--packt">If you run<a id="calibre_link-1362" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> a business with a strong seasonality in sales, you may<a id="calibre_link-1022" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> want to report a moving average in order to mitigate the seasonal influences. A <strong class="screentext">moving average</strong>, also <em class="italic">rolling average</em> or <em class="italic">running average</em>, calculates results for a fixed window of time, like 12 months, and divides the result by 12. This way, the result always includes the periods of the year that are traditionally high in sales, or low.</p>
    <p class="book-title--packt">A rolling average can also be used to focus on trends instead of short-term fluctuations in the data. To give a recent example: instead of looking at daily COVID cases, a more realistic view comes from a rolling 7-day average. This period always includes one weekend in which fewer cases are detected than on other days of the week.</p>
    <p class="book-title--packt">Note that the challenge here is in calculating the total result for a rolling time window; the average then comes from dividing by the number of time units. In this section, we will calculate a rolling average of one ISO year on a weekly basis. This means that we determine the last week number in the query context, and calculate results for the time period starting with <a id="calibre_link-583" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the week <em class="italic">after</em> that week number in the previous year, up to and including the last week selected. As the ISO year may contain either 52 or 53 weeks, we then need to determine this number to compute the average by week. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">In the Gregorian calendar calculations, the time intelligence DAX function <code class="code-in-text--packt">DATESINPERIOD</code> is used for this type of calculation.</p>
    </div>
    <p class="book-title--packt">The DAX <a id="calibre_link-1363" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>formula starts by defining a variable that stores the latest <code class="code-in-text--packt">Year-week</code> value. Next, the variable <code class="code-in-text--packt">RollingWeeks</code> is defined:</p>
    <pre class="programlisting"><code class="hljs-code">Moving Average Sales by Week =
VAR MaxWeek = MAX('ISO Date'[Year-week])
VAR RollingWeeks = 
CALCULATETABLE(
    FILTER(
           ALL('ISO Date'[Year-week]),
           'ISO Date'[Year-week] &gt; MaxWeek - 100 + 1
           &amp;&amp; 'ISO Date'[Year-week] &lt;= MaxWeek
    )
)
</code></pre>
    <p class="book-title--packt">As the name of the variable describes, you are looking for the set of weeks that are in the correct rolling time period &ndash; in our case, a full year. With <code class="code-in-text--packt">FILTER</code>, we create a subset of <code class="code-in-text--packt">ALL('ISO Date'[Year-week])</code>. We use <code class="code-in-text--packt">ALL</code> to exclude any filter placed on the <code class="code-in-text--packt">Year-week</code> column. </p>
    <p class="book-title--packt">Now take a closer look at the <a id="calibre_link-754" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>filter code. To create<a id="calibre_link-428" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> a rolling list of weeks, we need to find the <code class="code-in-text--packt">MaxWeek</code> number in the previous year. For instance, if our selection ends at ISO week 10 in 2020, we want the rolling period to start at week 11 in 2019. Since we do not know whether we have to move 52 or 53 weeks back for a whole year, we use the <code class="code-in-text--packt">Year-week</code> column.</p>
    <p class="book-title--packt">You may remember the definition of the <code class="code-in-text--packt">Year-week</code> column:</p>
    <pre class="programlisting"><code class="hljs-code">    ([ISO Year] * 100) + [ISOWeek]
</code></pre>
    <p class="book-title--packt">By this definition, you get the same <a id="calibre_link-755" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>week number in the previous year when you subtract 100 from the <code class="code-in-text--packt">Year-week</code> value. In the example above, week 10 in 2020 has a <code class="code-in-text--packt">Year-week</code> value of 202010; subtracting 100 <a id="calibre_link-429" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>results in 201910, or week 10 of 2019. As we want the rolling period to start one week later, we simply add 1.</p>
    <p class="book-title--packt">The next step is to calculate the sales in the time period we just created:</p>
    <pre class="programlisting"><code class="hljs-code">VAR SalesInPeriod = 
CALCULATE(
    [Sales],
    RollingWeeks,
    ALL('ISO Date')
)
</code></pre>
    <p class="book-title--packt">We us the <code class="code-in-text--packt">RollingWeeks</code> variable as a table filter here, and remove all other filters on the <code class="code-in-text--packt">ISO Date</code> table. The <a id="calibre_link-1364" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>result is all sales during the rolling time period. All that is left to do now is to divide this <a id="calibre_link-510" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>result by the number of weeks, which can be derived from the <code class="code-in-text--packt">RollingWeeks</code> variable by counting the rows of that table:</p>
    <pre class="programlisting"><code class="hljs-code">VAR NumberOfWeeks = COUNTROWS(RollingWeeks)
RETURN
DIVIDE(SalesInPeriod, NumberOfWeeks)
</code></pre>
    <p class="book-title--packt">This is the complete formula:</p>
    <pre class="programlisting"><code class="hljs-code">Moving Average Sales by Week =
VAR MaxWeek = MAX('ISO Date'[Year-week])
VAR RollingWeeks = 
CALCULATETABLE(
    FILTER(
            ALL('ISO Date'[Year-week]),
            'ISO Date'[Year-week] &gt; MaxWeek - 100 + 1
            &amp;&amp; 'ISO Date'[Year-week] &lt;= MaxWeek
    )
)
VAR SalesInPeriod = 
CALCULATE(
    [Sales],
    RollingWeeks,
    ALL('ISO Date')
)
VAR NumberOfWeeks = COUNTROWS(RollingWeeks)
RETURN
DIVIDE(SalesInPeriod, NumberOfWeeks)
</code></pre>
    <p class="book-title--packt">The following chart shows the moving average results by week in the year 2019:</p>
    <figure class="mediaobject"><img src="images/000068.png" alt="Chart, bar chart, histogram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.13: The moving average of sales by week</p>
    <p class="book-title--packt">Note that the<a id="calibre_link-1365" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> first six weeks show a <a id="calibre_link-511" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>low rolling average. This is just the effect of slow sales in those weeks. Because of the way we constructed the calculation, a proper average is calculated even in the first weeks of our date table. For instance, the second column from the left is the result of two weeks' sales, divided by 2.</p>
    <p class="book-title--packt">In these few sections, we have shown you some examples of time intelligence calculations with the week-based date table. You can be creative and define other calculations using the same approach and leveraging columns in the date table. In the last part of this chapter, we change gears a bit and discuss how to make a report always show a proper selection of results.</p>
    <h1 id="calibre_link-158" class="title">Keeping your report current</h1>
    <p class="book-title--packt">In most reports, you <a id="calibre_link-1138" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>want to view the latest results. In a sales report, for instance, you may want to see results for the current and previous months. In a Power BI report, you can place a filter on the year and month to show results for that specific month. However, when a new month starts, each report user will have to change that filter manually to avoid looking at old data.</p>
    <p class="book-title--packt">Power BI reports offer a feature to avoid having to do this: relative date filters. With a relative date filter, set in the reports <strong class="screentext">Filter</strong> pane, you can set up a rule that is dynamic relative to the current date:</p>
    <figure class="mediaobject"><img src="images/000090.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.14: Relative date filters</p>
    <p class="book-title--packt">While convenient, relative date filters have their limitations. For instance, you cannot set a relative date filter like "<em class="italic">show the last two full months before today</em>." Additionally, the relative date filters are based on the Gregorian calendar. When using a week-based calendar, you need to create an alternative to the standard relative date filters. This is the topic of the next section.</p>
    <h2 id="calibre_link-159" class="calibre8">The Date Selection table</h2>
    <p class="book-title--packt">We want <a id="calibre_link-1139" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to enable<a id="calibre_link-572" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> different selections on the date table, comparable to the relative date filter discussed above, only more flexible. The approach for this is to introduce another table &ndash; let's call it <code class="code-in-text--packt">Date Selection</code> &ndash; that contains a column with the selection options as well as a <code class="code-in-text--packt">Date</code> column. This table will have a relationship with the date table:</p>
    <figure class="mediaobject"><img src="images/000111.png" alt="Graphical user interface, application, Teams  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.15: The Date Selection table</p>
    <p class="book-title--packt">Note that the default filter propagation of the relationship is from <code class="code-in-text--packt">ISO Date</code> <code class="code-in-text--packt">to Date Selection</code>, but we want filters to propagate in the other direction. So, the cross filter property of the relationship must be set to <strong class="screentext">Both</strong>.</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">Date Selection</code> table contains sets of dates for each selection option. As an example, here is the selection option <strong class="screentext">Last two full weeks</strong> (this table was created on November 15, 2021):</p>
    <figure class="mediaobject"><img src="images/000132.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.16: Rows in the Date Selection table</p>
    <p class="book-title--packt">By adding a <a id="calibre_link-1140" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>filter <a id="calibre_link-573" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on the <code class="code-in-text--packt">Selection</code> column to a report and setting it to <strong class="screentext">Last two full weeks</strong>, only the dates in this range will be selected in the <code class="code-in-text--packt">ISO Date</code> table.</p>
    <p class="book-title--packt">To create the <code class="code-in-text--packt">Date Selection</code> table, we must start by creating a copy of the <code class="code-in-text--packt">ISO Date</code> table. Let's call this <code class="code-in-text--packt">SelectDate</code>. For this table, we use exactly the same formula used for the <code class="code-in-text--packt">ISO Date</code> table.</p>
    <p class="book-title--packt">The reason why we need to create a separate date table is that the rows in the <code class="code-in-text--packt">Date Selection</code> table will be derived from the date table. Technically, the relationship causes the <code class="code-in-text--packt">Date Selection</code> table to be a fact table, with <code class="code-in-text--packt">ISO Date</code> (from which it is created) as a filter table. </p>
    <p class="book-title--packt">This causes a circular dependency error:</p>
    <figure class="mediaobject"><img src="images/000152.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.16: A circular dependency error</p>
    <p class="book-title--packt">There is another issue that will appear when we start using the <code class="code-in-text--packt">Date Selection</code> table: in the <code class="code-in-text--packt">Sales Last Year</code> measure discussed earlier in this chapter, we switch between different ways <a id="calibre_link-1141" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of calculating last year's results based on filters <a id="calibre_link-574" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on columns in the <code class="code-in-text--packt">ISO Date</code> table. However, a selection option in <code class="code-in-text--packt">Date Selection</code> could cause a selection in <code class="code-in-text--packt">ISO Date</code> without a direct filter; for instance, the <strong class="screentext">Last two full weeks</strong> option will cause two weeks to be selected, without a filter on the <code class="code-in-text--packt">ISOWeek</code> column. The last year calculation will select an incorrect calculation method.</p>
    <p class="book-title--packt">To address this issue, we add another column in the <code class="code-in-text--packt">Date Selection</code> table that indicates which level in the date hierarchy is being selected. The last year calculation will have to test not only the filters on <code class="code-in-text--packt">ISO Date</code>, but also the level of selection in <code class="code-in-text--packt">Date Selection</code>. Additionally, we need to consider the situation in which the <code class="code-in-text--packt">Date Selection</code> is not used at all. We call the additional column <code class="code-in-text--packt">Level</code>, with these values:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Day</strong>: Level = 1</li>
      <li class="bullet"><strong class="screentext">Week</strong>: Level = 2</li>
      <li class="bullet"><strong class="screentext">Period</strong>: Level = 3</li>
      <li class="bullet"><strong class="screentext">Year</strong>: Level = 4</li>
      <li class="bullet"><strong class="screentext">All</strong>: Level = 5</li>
    </ul>
    <p class="book-title--packt">The last level must be in the <code class="code-in-text--packt">Date Selection</code> table at all times, and functions as an indicator that nothing is selected. As an example, here is a part of the table with the <strong class="screentext">Last two full weeks</strong> option, plus the <strong class="screentext">"All"</strong> level:</p>
    <figure class="mediaobject"><img src="images/000173.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.17: Date Selection table including Level column</p>
    <p class="book-title--packt">With the model structure in place, let's see how to create the <code class="code-in-text--packt">Date Selection</code> table, including <a id="calibre_link-575" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>its<a id="calibre_link-1142" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> different selection options, with DAX.</p>
    <h2 id="calibre_link-160" class="calibre8">Creating selection options</h2>
    <p class="book-title--packt">The <code class="code-in-text--packt">Date Selection</code> table <a id="calibre_link-1146" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is a calculated<a id="calibre_link-565" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> table in which the current date is used to define the different selection options. The basic idea is to create a list of dates belonging to a selection option, together with a name for the option and its level. </p>
    <p class="book-title--packt">The current date is retrieved with the <code class="code-in-text--packt">TODAY</code> function, and we can use the <code class="code-in-text--packt">SelectDate</code> table to retrieve other current values we need, like <a id="calibre_link-430" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the current <code class="code-in-text--packt">WeekCtr</code> value. The formula starts with this:</p>
    <pre class="programlisting"><code class="hljs-code">Date Selection =
VAR CurrentWeekCtr =
    CALCULATE(
        MAX(SelectDate[WeekCtr]),
        SelectDate[Date] = TODAY()
    )
</code></pre>
    <p class="book-title--packt">For our example <strong class="screentext">Last two full weeks</strong> option, the formula continues with:</p>
    <pre class="programlisting"><code class="hljs-code">VAR LastTwoFullWeeks =
ADDCOLUMNS(
    CALCULATETABLE(
        VALUES(SelectDate[Date]),
        SelectDate[WeekCtr] IN 
                {CurrentWeekCtr &ndash; 1, CurrentWeekCtr &ndash; 2}
    ),
    "Selection", "Last two full weeks",
    "Level", 2
)
</code></pre>
    <p class="book-title--packt">In this code, we select dates for which the <code class="code-in-text--packt">WeekCtr</code> value is contained in a list of values corresponding<a id="calibre_link-1147" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to one <a id="calibre_link-1476" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and two weeks<a id="calibre_link-272" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> before the current<a id="calibre_link-566" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> week. With <code class="code-in-text--packt">ADDCOLUMNS</code>, the <code class="code-in-text--packt">Selection</code> and <code class="code-in-text--packt">Level</code> columns are added.</p>
    <p class="book-title--packt">Let's add the <code class="code-in-text--packt">"All"</code> option now:</p>
    <pre class="programlisting"><code class="hljs-code">VAR LevelAll =
ADDCOLUMNS(
    VALUES(SelectDate[Date]),
    "Selection", "All",
    "Level", 5
)
</code></pre>
    <p class="book-title--packt">Of course, for the <code class="code-in-text--packt">"All"</code> option, we select all the dates from the <code class="code-in-text--packt">SelectDate</code> table. Again, the <code class="code-in-text--packt">Selection</code> and <code class="code-in-text--packt">Level</code> columns are added with <code class="code-in-text--packt">ADDCOLUMNS</code>. We now have two variables containing a part of what must become the <code class="code-in-text--packt">Date Selection</code> table. </p>
    <p class="book-title--packt">To combine these parts, we can use the <code class="code-in-text--packt">UNION</code> function:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
UNION(
    LastTwoFullWeeks, LevelAll
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">UNION</code> function accepts an arbitrary number of arguments, all of which must be tables with the same number of columns. The rows in all these tables form one big table, which is our <code class="code-in-text--packt">Date Selection</code> table.</p>
    <p class="book-title--packt">You can add all the selection <a id="calibre_link-1672" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>options you can imagine, as long as you can derive the definition of the <a id="calibre_link-431" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selection from the current date. For example, a selection option to select the whole of the previous year is <a id="calibre_link-1477" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>created with the following code:</p>
    <pre class="programlisting"><code class="hljs-code">VAR CurrentYear =
    CALCULATE(
        MAX(SelectDate[ISO Year]),
        SelectDate[Date] = TODAY()
    )
VAR PreviousISOYear =
ADDCOLUMNS(
    CALCULATETABLE(
        VALUES(SelectDate[Date]),
        SelectDate[ISO Year] = CurrentYear &ndash; 1
    ),
    "Selection", "Previous year",
    "Level", 4
)
</code></pre>
    <p class="book-title--packt">After including <a id="calibre_link-1148" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this code, the <code class="code-in-text--packt">PreviousISOYear</code> variable <a id="calibre_link-567" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>should be added to the <code class="code-in-text--packt">UNION</code> function for the rows to appear in the end result. As another example, for selecting the last 5 periods including the current, but only up to today, the code below will do:</p>
    <pre class="programlisting"><code class="hljs-code">VAR CurrentPeriod =
    CALCULATE(
        MAX(SelectDate[PeriodCtr]),
        SelectDate[Date] = TODAY()
    )
VAR LastFivePeriods =
ADDCOLUMNS(
    CALCULATETABLE(
        VALUES(SelectDate[Date]),
        SelectDate[PeriodCtr] &gt;= CurrentPeriod &ndash; 4,
        SelectDate[Date] &lt;= TODAY()
    ),
    "Selection", "Last five periods",
    "Level", 3
)
</code></pre>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The full <code class="code-in-text--packt">Date Selection</code> formula including these options can be found in this chapter's model file.</p>
    </div>
    <p class="book-title--packt">In the next <a id="calibre_link-1149" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>section, we look at changing the <code class="code-in-text--packt">Sales Last Year</code> measure<a id="calibre_link-568" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to deal with date selections.</p>
    <h2 id="calibre_link-161" class="calibre8">Using Date selection in measures</h2>
    <p class="book-title--packt">Going back <a id="calibre_link-1143" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to the <code class="code-in-text--packt">Sales Last Year</code> measure, we <a id="calibre_link-569" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>used <a id="calibre_link-936" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <code class="code-in-text--packt">ISFILTERED</code> function to detect what type of selection is made on the <code class="code-in-text--packt">ISO Date</code> table in <a id="calibre_link-1478" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>order to apply the correct calculation:</p>
    <pre class="programlisting"><code class="hljs-code">SWITCH(
    TRUE(),
    ISFILTERED('ISO Date'[Date]),
        &lt;day-level calculation&gt;
    ISFILTERED('ISO Date'[ISOWeek]),
        &lt;week-level calculation&gt;
...
</code></pre>
    <p class="book-title--packt">If you were to use this measure in a report and select the <strong class="screentext">Last two full weeks</strong> option, you would see results for the last two full <a id="calibre_link-1329" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>weeks, but the <code class="code-in-text--packt">ISFILTERED('ISO Date'[ISOWeek])</code> clause is not triggered. Indeed, there is no filter on the <code class="code-in-text--packt">ISOWeek</code> column in this situation. This leads to the wrong calculation being applied.</p>
    <p class="book-title--packt">To correct this, we use the <code class="code-in-text--packt">Date Selection</code> table's <code class="code-in-text--packt">Level</code> column as well. With the selection of <strong class="screentext">Last two full weeks</strong>, the <code class="code-in-text--packt">Level</code> column contains only the value 2. This can be used to implement the following logic to test whether to use the week-level calculation:</p>
    <ul class="calibre9">
      <li class="bullet">The largest selected level is 2; or</li>
      <li class="bullet">The <code class="code-in-text--packt">ISOWeek</code> column is filtered.</li>
    </ul>
    <p class="book-title--packt">In code, this translates to:</p>
    <pre class="programlisting"><code class="hljs-code">Sales Last Year (with date selection) =
VAR MaxLevel = MAX('Date Selection'[Level])
RETURN
SWITCH(
    TRUE(),
    MaxLevel = 2 || ISFILTERED('ISO Date'[Date]),
        ...
    MaxLevel = 3 || ISFILTERED('ISO Date'[ISOWeek]),
        ...
</code></pre>
    <p class="book-title--packt">We are not done yet: in each <a id="calibre_link-1330" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation in the original measure, the new selection on the date table is applied, and old filters on the date table are <a id="calibre_link-1297" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>removed. For the week-based <a id="calibre_link-1144" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation <a id="calibre_link-570" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>it looks like this:</p>
    <pre class="programlisting"><code class="hljs-code">        VAR PYWeeks =
            SUMMARIZE(
                'ISO Date',
                'ISO Date'[ISOWeek],
                'ISO Date'[Previous Year]
            )
        RETURN
        CALCULATE(
            [Sales],
            TREATAS(
                PYWeeks,
                'ISO Date'[ISOWeek],
                'ISO Date'[ISO Year]
            ),
            ALL('ISO Date')
        ), 
</code></pre>
    <p class="book-title--packt">We can now, however, have a situation <a id="calibre_link-937" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>where there are no filters on the date table directly, but a filter on <code class="code-in-text--packt">Date Selection</code> filtering the table instead. That filter is not removed, resulting in an empty selection on the date table. What we need to do is change the calculation in such a way that <code class="code-in-text--packt">Date Selection</code> filters are removed as well:</p>
    <pre class="programlisting"><code class="hljs-code">     ISFILTERED('ISO Dates'[ISOWeek]),
        VAR PYWeeks =
            SUMMARIZE(
                'ISO Date',
                'ISO Date'[ISOWeek],
                'ISO Date'[Previous Year]
            )
        RETURN
        CALCULATE(
            [Sales],
            TREATAS(
                PYWeeks,
                'ISO Date'[ISOWeek],
                'ISO Date'[ISO Year]
            ),
            ALL('ISO Date'),
            ALL('Date Selection')
        ),
</code></pre>
    <p class="book-title--packt">We will not repeat the complete, lengthy formula here; you can find it in the model file. The chart below shows the results for <code class="code-in-text--packt">Sales</code> and <code class="code-in-text--packt">Sales Last Year</code> in the adapted measure, for the <a id="calibre_link-1145" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selection <strong class="screentext">Last five periods</strong>; again, the <a id="calibre_link-571" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>current date <a id="calibre_link-1400" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>here is November 15, 2021.</p>
    <figure class="mediaobject"><img src="images/000195.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.3.18: Results with date selection</p>
    <p class="book-title--packt">As can be seen <a id="calibre_link-1673" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from <a id="calibre_link-1674" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this chart, although <a id="calibre_link-1675" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>we have made a date selection on periods (the last five periods), the chart returns results at the week level. So, in this case, it is clear that the formula is triggered by <code class="code-in-text--packt">ISFILTERED('ISO Date'[ISOWeek])</code>, not by <code class="code-in-text--packt">'Date Selection'[Level]</code>.</p>
    <h1 id="calibre_link-162" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, you have learned how to implement time intelligence when your calendar looks different to the standard Gregorian calendar that a Power BI model assumes.</p>
    <p class="book-title--packt">For time intelligence analysis, you need a specific date table containing columns corresponding to the hierarchical levels in your calendar. In this chapter, we have implemented this as a calculated table.</p>
    <p class="book-title--packt">To do actual time intelligence calculations, meticulous filtering over the date table and the various columns in it is needed. In particular, calculating results for "the previous year" requires a lot of different calculations, depending on what selections are made in the query context. All this evokes a renewed appreciation for what the built-in DAX time intelligence functions accomplish!</p>
    <p class="book-title--packt">We closed this chapter off with an alternative to relative date filters in Power BI reports that is more flexible and can handle selections in non-standard calendars as well.</p>
    <p class="book-title--packt">The next chapter focuses on AutoExist, a lesser-known concept in Power BI that, when misunderstood, can lead to bad performance in reports and confusion over the results a Power BI model generates.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-251">
<div id="calibre_link-1676" class="calibre2">
<div id="calibre_link-1677" class="calibre3"><div id="calibre_link-1678" class="calibre4">
    <h1 class="chapternumber">2.4</h1>
    <h1 id="calibre_link-163" class="title">Working with AutoExist</h1>
    <p class="book-title--packt">When working with DAX, you should not forget that the whole point of what you are doing is to create useful output from your model. It is therefore useful to have some understanding of how Power BI visualizes results from a model. Without going into everything possible in Power BI visual reports, there are some fundamentals of how visualizations and a Power BI model work together that need to be discussed here. One of these is a lesser-known concept <a id="calibre_link-330" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>called <strong class="screentext">AutoExist</strong>, which is the subject of this chapter.</p>
    <p class="book-title--packt">AutoExist is a Power BI feature that aims to speed up reports by only evaluating DAX measures for relevant data points. The challenge here is that Power BI determines which data points are relevant by guessing, and while these guesses are good in many cases, sometimes they are not. Through a practical example, you will learn how AutoExist works, how to leverage it to solve specific problems and optimize the performance of your reports, and how to solve the problems AutoExist sometimes causes.</p>
    <p class="book-title--packt">We are going to cover the following topics:</p>
    <ul class="calibre9">
      <li class="bullet">How Power BI visualizes the output of a model</li>
      <li class="bullet">What AutoExist is and what it does</li>
      <li class="bullet">Example: the case of the missing workdays</li>
      <li class="bullet">How to solve the missing workdays problem</li>
      <li class="bullet">Optimizing report performance with AutoExist</li>
    </ul>
    <h1 id="calibre_link-164" class="title">The Power BI model</h1>
    <p class="book-title--packt">Most of<a id="calibre_link-1090" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> this chapter is based on a small sample model:</p>
    <figure class="mediaobject"><img src="images/000217.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.1: Diagram of the Power BI model</p>
    <p class="book-title--packt">We have a fact table, <code class="code-in-text--packt">fSales</code>, with sales transactions for customers in the <code class="code-in-text--packt">Customer</code> table. A <code class="code-in-text--packt">Customer</code> has a responsible, who is an employee; the model therefore relates the <code class="code-in-text--packt">Responsible</code> column in <code class="code-in-text--packt">Customer</code> to the <code class="code-in-text--packt">EmpNr</code> column in <code class="code-in-text--packt">Employee</code>. So, with this model, we can report <a id="calibre_link-943" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales by customer, but also by employee, or any of either's attributes.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">This model file, <code class="code-in-text--packt">2.4 AutoExist.pbix</code>, can be found at <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.4" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.4</span></a>.</p>
    </div>
    <p class="book-title--packt">We will mainly work with the results of a single DAX measure for sales:</p>
    <pre class="programlisting"><code class="hljs-code">Sales = SUM(fSales[SalesPrice])
</code></pre>
    <p class="book-title--packt">In addition, we <a id="calibre_link-1091" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use a measure that only returns sales for some product categories:</p>
    <pre class="programlisting"><code class="hljs-code">Sales (core products) =
CALCULATE(
    [Sales],
    KEEPFILTERS(
        Product[Category] 
        IN {"Bikes", "Clothing", "Accessories"}
    )
)
</code></pre>
    <p class="book-title--packt">See <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>, for a discussion on <code class="code-in-text--packt">CALCULATE</code> and the use of <code class="code-in-text--packt">KEEPFILTERS</code>.</p>
    <h1 id="calibre_link-165" class="title">How Power BI visualizes the output of a model</h1>
    <p class="book-title--packt">As you will know, a<a id="calibre_link-1077" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> Power BI report's main components are visualization objects. These objects take some fields from a model (either included in the same file, or a remote model) and render a visualization of the information provided by the model.</p>
    <p class="book-title--packt">As with many elements in Power BI, these visualizations work like a beginner user would expect in many situations. When things become more complex, however, you may easily run into unexpected results. In these cases, it is useful to understand a bit more about the technicalities of visualizations. Why do they show what they show, and how do they do it?</p>
    <h2 id="calibre_link-166" class="calibre8">Visual filters and context</h2>
    <p class="book-title--packt">A core concept in<a id="calibre_link-1080" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> Power <a id="calibre_link-1078" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>BI is that<a id="calibre_link-798" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of <strong class="screentext">filters</strong>. This is specifically true for DAX, but filters do play an important role in visualizations as well. Let's take this simple report as an example:</p>
    <figure class="mediaobject"><img src="images/000015.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /> </figure>
    <p class="book-title--packt">Figure 2.4.2: A simple Power BI report</p>
    <p class="book-title--packt">You can see what the chart represents: sales numbers by month in the year 2019. We have used three fields from the Power BI model to create this simple report:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">Year</code>: Values in this column populate the slicer</li>
      <li class="bullet"><code class="code-in-text--packt">Month</code>: Used as labels on the <em class="italic">x</em>-axis of the column chart</li>
      <li class="bullet"><code class="code-in-text--packt">Sales</code>: Used as values in the chart</li>
    </ul>
    <p class="book-title--packt">There is a fundamental difference between the <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code> fields, and <code class="code-in-text--packt">Sales</code>: <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code> are columns of data in the model, while <code class="code-in-text--packt">Sales</code> is a measure. The results of the calculations that are implemented in the <code class="code-in-text--packt">Sales</code> measure are determined by the selected values of <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code>. In other words: the <em class="italic">query context</em> for the <code class="code-in-text--packt">Sales</code> calculation is formed by <a id="calibre_link-1679" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>filters<a id="calibre_link-1680" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> on the <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code> columns. See <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>, for an in-depth discussion of context.</p>
    <p class="book-title--packt">This is how Power BI reports are generally built up: columns in the Power BI model are used as labels in the report's visuals. Each label forms a filter that is applied for the calculation of measures in the report's visuals. Some filters apply to the visual as a whole, like the <code class="code-in-text--packt">Year</code> filter, and come from "outside" of the visual. </p>
    <p class="book-title--packt">Others come from "inside," because columns are used to populate a chart axis, row labels, or other visual elements.</p>
    <p class="book-title--packt">Filters coming from outside of the visual are easily detected using the funnel icon in the visual header, which shows a filter tooltip.</p>
    <figure class="mediaobject"><img src="images/000105.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.3: The filter tooltip</p>
    <p class="book-title--packt">In this case, we can see that there is, in fact, another filter on this visual, on the <code class="code-in-text--packt">Country</code> column. Whenever you see strange or seemingly incorrect results in a visual, a good starting point is<a id="calibre_link-1079" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to <a id="calibre_link-1081" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>check which filters apply to the visual!</p>
    <p class="book-title--packt">Filters caused by columns used in the visual itself are harder to detect. You will just have to examine the visual closely to see what labels are visible, and try to deduce which columns may have been used to create the visual. If you are the report author, you can of course just check the fields in the <strong class="screentext">Visualization</strong> pane.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Note that a filter is not just a selection of values in a column. You can have multiple filters on the same column at the same time; for instance, you may have both a page level filter on the <code class="code-in-text--packt">Year</code> column (in the report's <strong class="screentext">Filters</strong> pane) and a slicer on the same <code class="code-in-text--packt">Year</code> column. You will then see both filters in the filter tooltip. </p>
      <p class="book-title--packt">Having multiple filters, some of which are hidden, is often a cause for confusion. Again, check the filter tooltip.</p>
    </div>
    <h2 id="calibre_link-167" class="calibre8">How using measures changes the behavior of visuals</h2>
    <p class="book-title--packt">Visual filters<a id="calibre_link-1075" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> determine what data is shown by a visual. This is true not only for the calculated results presented in the visual, but also for the data points themselves. To understand this, you can start using a simple table visual on a column like <code class="code-in-text--packt">Category</code> (from the <code class="code-in-text--packt">Product</code> table) in the following picture. Note that only the <code class="code-in-text--packt">Category</code> column, and no other field from the model, is used for this visual:</p>
    <figure class="mediaobject"><img src="images/000097.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.4: A table of product categories</p>
    <p class="book-title--packt">In this table, all unique values in the <code class="code-in-text--packt">Category</code> column are shown. This set of values can be described with a DAX table expression:</p>
    <pre class="programlisting"><code class="hljs-code">DISTINCT('Product'[Category])
</code></pre>
    <p class="book-title--packt">When you apply a filter to this visual, via a slicer, for instance, the filter determines which values are presented in the visual. That is, only if that filter is relevant for the column where the values are taken from. For example, consider:</p>
    <figure class="mediaobject"><img src="images/000083.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.4: Product categories filtered through a slicer</p>
    <p class="book-title--packt">Here, you have a slicer on <code class="code-in-text--packt">ProductState</code>, which is a column from the same <code class="code-in-text--packt">Product</code> table as <code class="code-in-text--packt">Category</code>. In the table visual, you now only have categories corresponding to the product state <code class="code-in-text--packt">Finished Goods</code>. Apparently, the product category <code class="code-in-text--packt">Unknown</code> does not contain any <code class="code-in-text--packt">Finished Goods</code> products! When you use a column from another table in your slicer, it all<a id="calibre_link-1681" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> depends on the structure of your model whether or not the values in the table visual will be filtered.</p>
    <p class="book-title--packt">When filters are applied to the visual, the resulting set of values can be described in DAX. For the filter above, this would be:</p>
    <pre class="programlisting"><code class="hljs-code">CALCULATETABLE(
   DISTINCT('Product'[Category]), 
   'Product'[ProductState] = "Finished Goods"
)
</code></pre>
    <p class="book-title--packt">When you add a <em class="italic">measure</em> to a visual, this behavior changes: now, only values for which the measure returns a non-blank result are presented. This is a fundamental difference that is often overlooked. Also, this is why <code class="code-in-text--packt">BLANK</code> is such an important value in DAX: if it is the result of a measure, the <a id="calibre_link-432" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>label corresponding to it will not be shown. Note that <code class="code-in-text--packt">BLANK</code> is different from 0 (zero). A zero value <em class="italic">will</em> be presented in the visual.</p>
    <p class="book-title--packt">In the following image, we added the <code class="code-in-text--packt">Sales (core products)</code> measure, which returns sales for only the <code class="code-in-text--packt">Bikes</code>, <code class="code-in-text--packt">Clothing</code>, and <code class="code-in-text--packt">Accessories</code> categories:</p>
    <figure class="mediaobject"><img src="images/000055.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.5: Adding a measure to the visual</p>
    <p class="book-title--packt">As you would guess, the <code class="code-in-text--packt">Components</code> category does not appear in the visual anymore. You may ask how Power BI knows that <code class="code-in-text--packt">Components</code> must not be in the visual. The answer is: the measure is evaluated for <em class="italic">all</em> category values, and only the categories that yield a non-blank result are shown in the table. You may then ask: is the measure evaluated for the <code class="code-in-text--packt">Unknown</code> category, which only contains products with the <code class="code-in-text--packt">Manufacturing Items</code> product state? In this case, it is not; but the general answer is more<a id="calibre_link-1076" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> complicated. This is where AutoExist comes into play. To understand what AutoExist is, let us first dive into the way a Power BI visual is populated at a more technical level.</p>
    <h2 id="calibre_link-168" class="calibre8">Understanding a visual's DAX query</h2>
    <p class="book-title--packt">Each visual in<a id="calibre_link-730" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> a <a id="calibre_link-680" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>Power BI report is populated through a single DAX query to the underlying data model. Think of a DAX query as a DAX formula that returns a table of data from the Power BI model. Most of the time, you don't need to worry about what this query is exactly. </p>
    <p class="book-title--packt">But it is possible to inspect it, and it is insightful to take a look at some queries &ndash; especially if you want to know what calculations are being done, or why a visual takes a long time to render.</p>
    <p class="book-title--packt">Inspection of the DAX query is somewhat hidden in Power BI Desktop. You can find it through the <strong class="screentext">Performance analyzer</strong>, which you can open from the <strong class="screentext">View</strong> ribbon.</p>
    <figure class="mediaobject"><img src="images/000075.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.6: The Performance analyzer pane</p>
    <p class="book-title--packt">From<a id="calibre_link-1082" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the <strong class="screentext">Performance analyzer</strong> pane, you can <a id="calibre_link-681" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>monitor the performance of the visuals in your report. To do this, follow these steps:</p>
    <ol class="calibre9">
      <li class="calibre12">Click <strong class="screentext">Start recording</strong>.</li>
      <li class="calibre12">Click <strong class="screentext">Refresh visuals</strong>, or change or interact with the visuals.</li>
    </ol>
    <p class="book-title--packt">Whenever a visual retrieves new results from the data model, it is recorded and reported in the Performance analyzer on a visual-by-visual basis. You can expand the basic numbers for a visual to get a deeper insight into what happens:</p>
    <figure class="mediaobject"><img src="images/000056.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.7: Performance analyzer results</p>
    <p class="book-title--packt">When you <a id="calibre_link-682" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>expand<a id="calibre_link-1083" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the information, you <a id="calibre_link-1401" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will see a <strong class="screentext">Copy query</strong> link. Clicking this copies the visual's DAX query to the clipboard.</p>
    <p class="book-title--packt">As an example, the DAX query of our filtered table of product categories, without a measure, starts by declaring two variables:</p>
    <pre class="programlisting"><code class="hljs-code">// DAX Query
DEFINE
  VAR __DS0FilterTable = 
    TREATAS({"Finished Goods"}, 'Product'[ProductState])
  VAR __DS0FilterTable2 = 
    TREATAS({"Germany"}, 'Customer'[Country])
</code></pre>
    <p class="book-title--packt">These variables implement the two filters that act upon the table visual in a rather generic way. The function <code class="code-in-text--packt">TREATAS</code> can be used to treat any list of values as the selected items in a column, resulting in a subset of the column <a id="calibre_link-433" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>values. The variable <code class="code-in-text--packt">__DS0FilterTable</code> implements the filter in the <code class="code-in-text--packt">ProductState</code> slicer, while the variable <code class="code-in-text--packt">__DS0FilterTable2</code> implements the hidden <a id="calibre_link-1682" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>filter we saw earlier in the filter tooltip.</p>
    <p class="book-title--packt">The next variable is our list of <a id="calibre_link-944" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>category values, filtered by the two filters implemented by the first two variables:</p>
    <pre class="programlisting"><code class="hljs-code">  VAR __DS0Core = 
    CALCULATETABLE(
      DISTINCT('Product'[Category]),
      KEEPFILTERS(__DS0FilterTable),
      KEEPFILTERS(__DS0FilterTable2)
    )
</code></pre>
    <p class="book-title--packt">The remainder<a id="calibre_link-1084" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of the DAX query retrieves<a id="calibre_link-683" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the data: </p>
    <pre class="programlisting"><code class="hljs-code">  VAR __DS0PrimaryWindowed = 
    TOPN(501, __DS0Core, 'Product'[Category], 1)
EVALUATE
  __DS0PrimaryWindowed
ORDER BY
  'Product'[Category]
</code></pre>
    <p class="book-title--packt">The variable <code class="code-in-text--packt">__DS0PrimaryWindowed</code> implements the behavior that not all data is retrieved right away, by <a id="calibre_link-1402" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selecting the first 501 rows. This has no impact on our small table, of course, but for long tables you can use the Performance analyzer to see that new DAX queries are sent to the data model when you scroll <a id="calibre_link-1385" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>down the table. In our case, however, the first "window" already contains all the rows. It is retrieved from the data model at once, ordered by the category name.</p>
    <p class="book-title--packt">When you add a measure (the core products sales measure, in our case) and inspect the DAX query, you will notice that the <a id="calibre_link-434" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>previous <code class="code-in-text--packt">CALCULATETABLE</code> function <a id="calibre_link-1292" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is now replaced by <code class="code-in-text--packt">SUMMARIZECOLUMNS</code>:</p>
    <pre class="programlisting"><code class="hljs-code">  VAR __DS0Core = 
    SUMMARIZECOLUMNS(
      'Product'[Category],
      __DS0FilterTable,
      __DS0FilterTable2,
      "Sales__core_products_", 'Results'[Sales (core products)]
    )
</code></pre>
    <p class="book-title--packt">This adds a column with the measure results, of course, but more importantly, one of the specifics of <code class="code-in-text--packt">SUMMARIZECOLUMNS</code> is that no rows are <a id="calibre_link-1683" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>returned for which the expression (in our case, the <code class="code-in-text--packt">[Sales (core products)]</code> measure) returns <code class="code-in-text--packt">BLANK</code>.</p>
    <p class="book-title--packt">So, by looking <a id="calibre_link-684" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>at <a id="calibre_link-1085" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the DAX queries, you can see that adding measures to a visual makes a fundamental difference in the underlying DAX query.</p>
    <h1 id="calibre_link-169" class="title">What AutoExist is, and what it does</h1>
    <p class="book-title--packt">In the previous<a id="calibre_link-331" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> section, we<a id="calibre_link-337" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> discussed how visuals are populated with data and calculated results. Typically, when using measures in a visual, more calculations are performed than what you get to see in the visual. Calculations are also needed to determine which data points should be presented.</p>
    <p class="book-title--packt">This raises the question: how many calculations are being done? And is it possible to control that number? AutoExist is a Power BI feature that optimizes the number of calculations needed to populate a visual. In this section, you will learn how this is done. </p>
    <h2 id="calibre_link-170" class="calibre8">Using multiple filters in a visual</h2>
    <p class="book-title--packt">To explain <a id="calibre_link-335" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>AutoExist, we create a table visual using two columns from the <code class="code-in-text--packt">Customer</code> table:</p>
    <figure class="mediaobject"><img src="images/000041.png" alt="" class="calibre14" /> </figure>
    <p class="book-title--packt">Figure 2.4.8: Table with Country and RetailType</p>
    <p class="book-title--packt">As you can see <a id="calibre_link-1684" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from the table, there are some customers in Canada with the <code class="code-in-text--packt">Limited</code> retail type. In Australia, however, there are none. We know that when we add a measure to this table, we will not necessarily see all combinations of <code class="code-in-text--packt">Country</code> and <code class="code-in-text--packt">RetailType</code> but only those combinations for which the measure returns a non-blank value. </p>
    <p class="book-title--packt">Suppose now that we have a trivial measure that always returns the value 1:</p>
    <pre class="programlisting"><code class="hljs-code">One = 1
</code></pre>
    <p class="book-title--packt">Using this measure in the visual means that we will see all combinations of labels for which the measure is evaluated. An interesting question is: will we see the combination <code class="code-in-text--packt">Australia</code> and <code class="code-in-text--packt">Limited</code>? After all, the measure will return a non-blank value for this combination, even though there are no customers in Australia with the retail type <code class="code-in-text--packt">Limited</code>.</p>
    <p class="book-title--packt">Here is the result:</p>
    <figure class="mediaobject"><img src="images/000119.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.9: The table with a measure added</p>
    <p class="book-title--packt">You can see the changed behavior of the visual as a result of using a measure from the appearance of<a id="calibre_link-336" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> an (apparent) blank row in the customer table. But the combination <code class="code-in-text--packt">Australia</code> and <code class="code-in-text--packt">Limited</code> does not appear. This is AutoExist in action.</p>
    <h2 id="calibre_link-171" class="calibre8">How AutoExist optimizes DAX evaluation</h2>
    <p class="book-title--packt">The goal of <a id="calibre_link-339" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>AutoExist is to not evaluate <a id="calibre_link-638" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>DAX measures for combinations of labels that are not relevant for the report. Power BI guesses which combinations are relevant and, fortunately, these guesses follow simple rules. Specifically, AutoExist means that Power BI will not bother to evaluate combinations of values from columns in the same table that do not exist in the table. In our example, the Country <code class="code-in-text--packt">Australia</code> and the RetailType <code class="code-in-text--packt">Limited</code> do not appear in the same row in the <code class="code-in-text--packt">Customer</code> table, and Power BI will therefore not evaluate this combination.</p>
    <p class="book-title--packt">In most cases, this is a sound thing to do. If you were to create a table visual with customer name and customer number, for instance, it typically wouldn't make sense to evaluate <em class="italic">all</em> combinations of customer numbers and customer names. In a customer table with, say, 50,000 customers, AutoExist prevents Power BI from doing (50,000)<sup class="superscript--packt">2</sup> or 2.5 billion calculations, and limits the work to only 50,000 calculations.</p>
    <p class="book-title--packt">Whenever you<a id="calibre_link-639" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> use<a id="calibre_link-340" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> combinations of columns from <em class="italic">different</em> tables, every combination of values is evaluated. Consider, for instance, the following table visual containing <code class="code-in-text--packt">Customer[Country]</code> and <code class="code-in-text--packt">Employee[Division]</code>:</p>
    <figure class="mediaobject"><img src="images/000159.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.10: A table visual with columns from two separate tables</p>
    <p class="book-title--packt">In this visual, only combinations of values are presented for which customers exist in that country, and whose responsible employee is in that division. This is the behavior when no DAX measures are used in the visual. When you add a measure to the visual, <em class="italic">all</em> combinations of division and country are evaluated, even though there are no customers with those <a id="calibre_link-1685" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>combinations of<a id="calibre_link-1686" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> properties:</p>
    <figure class="mediaobject"><img src="images/000112.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.11: A table visual with columns from two tables and a measure</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">If you were to inspect the DAX queries for the preceding table visuals, you would find that even in the visual without a measure, all combinations are evaluated. Power BI makes up a measure to determine which rows should be shown in the visual, in this case <code class="code-in-text--packt">COUNTROWS(Customer)</code>, or: whenever a customer exists for a combination, the combination is shown.</p>
      <p class="book-title--packt">Power BI is quite smart when it comes to choosing a measure to use when there are columns from <a id="calibre_link-512" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>different tables in one visual. Suppose, for instance, that you combine a column from the <code class="code-in-text--packt">Product</code> table with a column from the <code class="code-in-text--packt">Customer</code> table. There is no relationship between these tables, but they are somewhat connected as there is a relationship from the <code class="code-in-text--packt">fSales</code> fact table to both tables. In this case, Power BI chooses <code class="code-in-text--packt">COUNTROWS(fSales)</code> as the measure to use to populate the visual.</p>
      <p class="book-title--packt">This works even when you have more than one fact table between both tables. In this situation, Power BI simply creates a measure for each table and shows all combinations for which at least one of the measures returns a non-blank value.</p>
      <p class="book-title--packt">Only if Power BI cannot find a relationship or intermediate table and therefore is not able to come up with an appropriate measure does it fail and throw an error:</p>
      <figure class="mediaobject"><img src="images/000180.png" alt="" class="pcalibre6 calibre16" /></figure>
      <p class="book-title--packt">Figure 2.4.12: Error message on a failed relationship</p>
      <p class="book-title--packt">When you add a measure to the visual yourself, Power BI will use that measure to determine how to populate the visual and the error will disappear.</p>
    </div>
    <p class="book-title--packt">In short, Power <a id="calibre_link-640" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>BI<a id="calibre_link-341" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> applying AutoExist means that:</p>
    <ul class="calibre9">
      <li class="bullet">From columns in the same table, only combinations of values that exist in rows of the table are evaluated (in other words, the columns are auto-existed).</li>
      <li class="bullet">From columns in different tables, all combinations of values are evaluated.</li>
    </ul>
    <p class="book-title--packt">And so, there are two aspects of Power BI populating a visual with results:</p>
    <ul class="calibre9">
      <li class="bullet"><strong class="screentext">Which calculations are done</strong>: Power<a id="calibre_link-1137" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> BI uses AutoExist to determine which combinations of label values are evaluated.</li>
      <li class="bullet"><strong class="screentext">What results the calculations provide</strong>: The label values provide filters that form a query context, which determines the result of the calculations.</li>
    </ul>
    <p class="book-title--packt">There is one issue, though. Your Power BI model will apply these rules, but it doesn't know what your DAX measures are supposed to calculate. In other words, you may have very good reasons to have a measure that returns a non-blank result for a combination of label values<a id="calibre_link-1687" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> that<a id="calibre_link-1688" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> isn't found in the data. In the next few sections, we describe a scenario where this happens.</p>
    <h1 id="calibre_link-172" class="title">Example: The case of the missing workdays</h1>
    <p class="book-title--packt">Having something like <a id="calibre_link-342" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>AutoExist sounds like a wonderful idea. Indeed, minimizing the number of calculations to be done is always helpful for performance. But there are situations where AutoExist gets in the way of what you want your Power BI model to achieve. In this section and the next, we will discuss a scenario where you have to circumvent AutoExist for things to work correctly. As with most of the cases in this part of the book, this one is based on a real customer's analytical challenges.</p>
    <h2 id="calibre_link-173" class="calibre8">The business case</h2>
    <p class="book-title--packt">Let's assume that the<a id="calibre_link-343" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> company QuantoBikes, which sells bikes, parts, and accessories, has a business-to-business (B2B) sales channel where sales representatives actively pursue prospects, close deals, and book orders. As a B2B business, sales take place mostly on workdays. Here is a chart of typical sales in July 2020:</p>
    <figure class="mediaobject"><img src="images/000202.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.13: Daily sales chart for QuantoBikes </p>
    <p class="book-title--packt">As a month <a id="calibre_link-1689" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>progresses, we are interested in whether or not the sales will meet targets, but we want to compare results to business in previous months as well. In this case, we will focus on the latter.</p>
    <h2 id="calibre_link-174" class="calibre8">Model structure</h2>
    <p class="book-title--packt">For this <a id="calibre_link-349" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>scenario, all we need to work with is a simple Power BI model:</p>
    <figure class="mediaobject"><img src="images/000021.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.14: Power BI model structure</p>
    <p class="book-title--packt">We have a <a id="calibre_link-1690" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>fact table, <code class="code-in-text--packt">fSales</code>, containing sales orders. This table is related to a <code class="code-in-text--packt">Calendar</code> table on the field <code class="code-in-text--packt">OrderDate</code>. This means we can analyze numbers based on&nbsp;the days when orders are received. The <code class="code-in-text--packt">fSales</code> table contains other data, like keys&nbsp;for customer and product, but we won't need these here. The <code class="code-in-text--packt">Calendar</code> table contains the usual columns, like <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code>, but we will take a closer look at this&nbsp;table later on.</p>
    <p class="book-title--packt">The important column in <code class="code-in-text--packt">fSales</code> is <code class="code-in-text--packt">SalesPrice</code>. This column contains the sales amount for each order. We can therefore calculate the order intake with a simple measure:</p>
    <pre class="programlisting"><code class="hljs-code">Order intake = SUM(fSales[SalesPrice])
</code></pre>
    <p class="book-title--packt">This measure <a id="calibre_link-350" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is the basis for all other measures in this scenario.</p>
    <h2 id="calibre_link-175" class="calibre8">Order intake analysis</h2>
    <p class="book-title--packt">Let's start<a id="calibre_link-351" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> with a measure to calculate the <a id="calibre_link-1691" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>cumulative order intake during a month. You can use the <code class="code-in-text--packt">TOTALMTD</code> function for this <a id="calibre_link-1389" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>or, alternatively, use <code class="code-in-text--packt">DATESMTD</code>:</p>
    <pre class="programlisting"><code class="hljs-code">Order intake MTD = 
CALCULATE(
   [Order intake], 
   DATESMTD('Calendar'[Date])
)
</code></pre>
    <p class="book-title--packt">When put in a line and column combo chart, you get the following results. Note that we don't yet have any order intake in the last two workdays.</p>
    <figure class="mediaobject"><img src="images/000003.png" alt="Chart, bar chart, histogram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.15: Daily and month-to-date order intake</p>
    <p class="book-title--packt">You will probably<a id="calibre_link-352" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> notice something problematic: the month-to-date line staggers as a result of (almost) no orders coming in during the weekend. In addition to that, it doesn't really make sense to report the weekends in the chart, as nothing really happens then. </p>
    <p class="book-title--packt">The easiest way to make this chart better is to only include workdays on the <em class="italic">x</em>-axis. You can do this by having a <code class="code-in-text--packt">Workday</code> column in the <code class="code-in-text--packt">Calendar</code> table, with the value 1 for workdays and 0 for weekend days. (You could also exclude bank holidays this way.) Note that you also have to change the <em class="italic">x</em>-axis type for this to work. When you add a date column on the <em class="italic">x</em>-axis, the axis type is set to <strong class="screentext">Continuous</strong>, which means that the dates are spaced according to their value, even if you have filtered out some. When you change it to <strong class="screentext">Categorical</strong>, you will see that the weekend days disappear from the axis:</p>
    <figure class="mediaobject"><img src="images/000063.png" alt="Chart, bar chart, histogram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.16: Order intake for workdays only</p>
    <p class="book-title--packt">Next, we would <a id="calibre_link-1692" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>like to compare this month's order intake to the previous month. You could first try this with a standard time<a id="calibre_link-564" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> intelligence function, <code class="code-in-text--packt">DATEADD</code>:</p>
    <pre class="programlisting"><code class="hljs-code">Order intake LM = 
CALCULATE(
   [Order intake MTD], 
   DATEADD('Calendar'[Date], -1, MONTH)
)
</code></pre>
    <p class="book-title--packt">In this formula (<code class="code-in-text--packt">LM</code> for <em class="italic">last month</em>), <code class="code-in-text--packt">DATEADD</code> takes the current context on the <code class="code-in-text--packt">Calendar</code> table, shifts it back in time one month, and calculates the cumulative order intake in the new context. </p>
    <p class="book-title--packt">When you add this measure to the chart (and remove the daily order intake columns for readability), you get this:</p>
    <figure class="mediaobject"><img src="images/000084.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.17: Month-to-date order intake for current and previous months</p>
    <p class="book-title--packt">Notice the bumps<a id="calibre_link-353" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in the dotted LM line. These are, again, caused by the structure of our data. Consider, for example, July 21, 2020; a Tuesday. If we shift this back one month, we get the results for June 21, 2020. But this was a Sunday, which is not a workday. The LM result is therefore the same as for the 20<sup class="superscript--packt">th</sup>, which was a Saturday in June, and for the 19<sup class="superscript--packt">th</sup>, which was a Friday in that month. That is why the dotted line becomes level on these days. However, note that July 19, 2020 was a Sunday and therefore not included on the axis, and as a consequence, the LM result for June 19, 2020 is not visible either.</p>
    <p class="book-title--packt">Similarly, the dotted line increases strongly from, for example, July 17 to the next data point, which is July 20. The 18<sup class="superscript--packt">th</sup> and 19<sup class="superscript--packt">th</sup> are a Saturday and Sunday, respectively, and are therefore not included on the axis. However, the 18<sup class="superscript--packt">th</sup> and 19<sup class="superscript--packt">th</sup> of June are a Thursday and a Friday. This means that the LM result for July 20 contains three additional days of order intake instead of one.</p>
    <h2 id="calibre_link-176" class="calibre8">Extending the Calendar table</h2>
    <p class="book-title--packt">It is clear that <a id="calibre_link-344" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>we can do a better job of comparing month-over-month numbers. A more sensible analysis would be to compare on a workday-to-workday basis. When you do that, the native time-intelligence functions no longer help. You will have to build your own calculation, and some extra columns in the <code class="code-in-text--packt">Calendar</code> table will help. </p>
    <p class="book-title--packt">There are many ways to add columns, of course, depending on where you get your <code class="code-in-text--packt">Calendar</code> table from; you could do this in Power Query, in your data source (if you have one), or as part of the DAX code used to generate the <code class="code-in-text--packt">Calendar</code> table. To clearly show the additional columns, below we <a id="calibre_link-513" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>provide DAX formulas for calculated columns, although we do not recommend calculated columns in general.</p>
    <p class="book-title--packt">First, make sure you have a <code class="code-in-text--packt">YearMonthNr</code> column containing the year and month as one number. The DAX formula for such a column is:</p>
    <pre class="programlisting"><code class="hljs-code">YearMonthNr = 100 * YEAR([Date]) + MONTH([Date])
</code></pre>
    <p class="book-title--packt">This way, July 2020 would be 202007, October 2021 would be 202110, and so on.</p>
    <p class="book-title--packt">Another useful column is <code class="code-in-text--packt">MonthCounter</code>, <a id="calibre_link-756" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>containing a continuous sequence of numbers from the start of your <code class="code-in-text--packt">Calendar</code>, that increases every month. With this, it is easy to move back and forth through the months without having to worry about ending up in the previous or next year. If you wanted to create this column as a calculated column with DAX, you would use this formula:</p>
    <pre class="programlisting"><code class="hljs-code">MonthCounter =
VAR ThisYearMonthNr = 'Calendar'[YearMonthNr])
RETURN 
COUNTROWS(
   FILTER(
      DISTINCT('Calendar'[YearMonthNr]), 
      'Calendar'[YearMonthNr] &lt;= ThisYearMonthNr
   )
)
</code></pre>
    <p class="book-title--packt">For each date in the <code class="code-in-text--packt">Calendar</code> table, <code class="code-in-text--packt">MonthCounter</code> looks at the <code class="code-in-text--packt">YearMonthNr</code> value and counts all <code class="code-in-text--packt">YearMonthNr</code> values smaller than or equal to the current value.</p>
    <p class="book-title--packt">The third column you need is a column that tells you which workday in the month a date corresponds to. For a sound comparison, we want to compare the first workday in the current month with the first workday in the previous month (or earlier months, of course), compare the second workday with the second workday in the previous month, and so on. What we need, therefore, is a counter for workdays in a month. If you create this column <a id="calibre_link-345" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>as a calculated column, this is the DAX formula:</p>
    <pre class="programlisting"><code class="hljs-code">Workday in Month =
VAR ThisYearMontNr = [YearMonthNr]
VAR ThisDate = [Date] 
VAR WorkdayNum = 
COUNTROWS(
   FILTER(
      'Calendar', 
      'Calendar'[YearMonthNr] = ThisYearMonthNr
      &amp;&amp; 'Calendar'[Date] &lt;= ThisDate 
      &amp;&amp; 'Calendar'[Workday] = 1
   )
)
RETURN
COALESCE(WorkdayNum, 1)
</code></pre>
    <p class="book-title--packt">In each row of the <code class="code-in-text--packt">Calendar</code> table, we note the <code class="code-in-text--packt">YearMonthNr</code> and the <code class="code-in-text--packt">Date</code> in that row in the variables <code class="code-in-text--packt">ThisYearMonthNr</code> and <code class="code-in-text--packt">ThisDate</code>, respectively. We then filter the <code class="code-in-text--packt">Calendar</code> table to only rows that have the same <code class="code-in-text--packt">YearMonthNr</code> and a <code class="code-in-text--packt">Date</code> before or on <code class="code-in-text--packt">ThisDate</code>, and that correspond to workdays. Counting the number of rows provides the workday number for that date.</p>
    <p class="book-title--packt">Note that for days in the weekend, this <a id="calibre_link-757" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation returns the same number as the preceding Friday; after all, the same number of workdays precede a Saturday or Sunday as that of the Friday before it. This is fine in this case, as we can simply count orders that come in during the weekend as order intake on Friday. You may have a different <a id="calibre_link-1693" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>requirement, of course; and you may change the formula in such a way that the weekend days have the same workday number as the Monday after them. Whatever the logic, it is advisable not to leave the workday number blank for weekends as you may want to report order intake by day, and you would miss the orders that have, by exception, come in during the weekend.</p>
    <p class="book-title--packt">The last part of the formula, <code class="code-in-text--packt">COALESCE(WorkdayNum, 1)</code>, is used to deal with the situation where the first day or first two days of the month are not workdays. In that case, the <a id="calibre_link-477" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation returns <code class="code-in-text--packt">BLANK</code>, as there are no preceding workdays in that month. To avoid having blank values, we set the workday number to 1 in this case. The <code class="code-in-text--packt">COALESCE</code> function returns the first non-blank value among its arguments. Note that orders taken in <a id="calibre_link-346" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>during the first weekend are counted with the following Monday now! Again, you may want to do this in a different way by changing the logic of the DAX formula.</p>
    <h2 id="calibre_link-177" class="calibre8">Workday analysis</h2>
    <p class="book-title--packt">Our "naÃ¯ve" last <a id="calibre_link-354" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>month order intake measure used <code class="code-in-text--packt">DATEADD</code> to change the <code class="code-in-text--packt">Calendar</code> context to the previous month. With the new <code class="code-in-text--packt">Calendar</code> columns, we can build our own logic to move to the previous month, while still looking at the same set of workdays.</p>
    <p class="book-title--packt">Remember that we are creating a "previous month, month to date" measure. To understand what we need to do, it is helpful to take a close look at what the <code class="code-in-text--packt">DATESMTD</code> function exactly<a id="calibre_link-591" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> does. <code class="code-in-text--packt">DATESMTD</code> determines the latest date in the current context, and returns a range of dates ending with that date, and starting on the first day of the month of that date. This means that it doesn't really matter if your context consists of one day, or a range of days: all that matters is what the last date is. Knowing this, we can mimic this logic in a new measure:</p>
    <pre class="programlisting"><code class="hljs-code">Order intake LM (workdays) = 
VAR LatestDate = MAX('Calendar'[Date])
</code></pre>
    <p class="book-title--packt">We are, however, not interested so much in the last date as in the month and workday number of that date. You can use <code class="code-in-text--packt">CALCULATE</code> to determine the month counter and workday number values of the latest date:</p>
    <pre class="programlisting"><code class="hljs-code">VAR LatestMonth = 
CALCULATE(
    MAX('Calendar'[MonthCounter]),
    'Calendar'[Date] = LatestDate
)
VAR LatestWorkday =
CALCULATE(
    MAX('Calendar'[Workday in Month],
    'Calendar'[Date] = LatestDate
)
</code></pre>
    <p class="book-title--packt">With <code class="code-in-text--packt">LatestMonth</code> and <code class="code-in-text--packt">LatestWorkday</code>, you can now change the context to what is needed to get the<a id="calibre_link-355" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> same workday in the previous month:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
CALCULATE(
    [Order intake MTD], 
    'Calendar'[MonthCounter] = LatestMonth - 1, 
    'Calendar'[Workday in Month] = LatestWorkday,
    ALL('Calendar')
)
</code></pre>
    <p class="book-title--packt">All you have to do is subtract 1 from the month counter (which was specifically designed to enable that without worrying about ending up in another year) and set the workday number to the latest workday number you determined. As this may lead you outside of the current context, you should remove all other filters using <code class="code-in-text--packt">ALL('Calendar')</code>.</p>
    <p class="book-title--packt">The result of this new calculation is the following:</p>
    <figure class="mediaobject"><img src="images/000106.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.18: Last-month workday sales &ndash; without bumps</p>
    <p class="book-title--packt">You can now make <a id="calibre_link-356" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a clear comparison between the cumulative order intake by day and last month's order intake. For clarity, it would be better to put the workday number on the <em class="italic">x</em>-axis of the chart instead of the date; after all, we now compare the result on a specific day (say, July 28) not with the same day in the previous month (the June 28), but with the same workday in the previous month. When doing that, you wouldn't need to include the workday indicator as a filter anymore, and the <em class="italic">x</em>-axis type can be set back to <strong class="screentext">Continuous</strong>.</p>
    <p class="book-title--packt">Note that another, more subtle difference was introduced by our new measure: it seems from the graph that there is no equivalent to the last workday in July (July 31) in June. Indeed, July 31 is the 23<sup class="superscript--packt">rd</sup> workday in July, while June had only 22 workdays. As we change the context to be the same workday number but in the previous month, the resulting context is empty, and the calculation returns a blank value.</p>
    <h2 id="calibre_link-178" class="calibre8">Where's my workday gone?</h2>
    <p class="book-title--packt">There is a <a id="calibre_link-347" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>problem in this workday-to-workday analysis that is not directly obvious or easy to notice. Let's take a look at the numbers for May 2020:</p>
    <figure class="mediaobject"><img src="images/000127.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.19: Workday analysis for May 2020</p>
    <p class="book-title--packt">Here, you can see that in this month, we've had 21 workdays. For each workday, we have a result both for the current month (May) and for the previous month (April). Now, look at the same chart for April 2020:</p>
    <figure class="mediaobject"><img src="images/000167.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.20: Workday analysis for April 2020</p>
    <p class="book-title--packt">Again, we have results for the current month (now April) and the previous month (March), each for 22 workdays. But wait: we now learn that April 2020 had 22 workdays, whereas in the <a id="calibre_link-348" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>May 2020 chart, only 21 workdays are presented. What happened to April's workday number 22?</p>
    <h1 id="calibre_link-179" class="title">How to solve the missing workdays problem</h1>
    <p class="book-title--packt">The case of the <a id="calibre_link-1009" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>missing workdays is a not-so-exotic situation that appears to bring up rather deep issues. It can happen in any situation where you change the context to calculate something other than what's available in the original context. In other words, whenever you use <code class="code-in-text--packt">CALCULATE</code> to change context, you may run into this problem without even noticing it. As filtering and context transformation is core to working with DAX, it is a fundamental issue. And as you may have guessed, it has everything to do with AutoExist.</p>
    <h2 id="calibre_link-180" class="calibre8">The root of the problem</h2>
    <p class="book-title--packt">Let's take a very<a id="calibre_link-1017" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> close look at the context in the last datapoint in May 2020's order intake chart. We haven't included all report elements in the image, but you can guess that there are a number of filters in this context:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">'Calendar'[Year]</code>: 2020</li>
      <li class="bullet"><code class="code-in-text--packt">'Calendar'[Month]</code>: May</li>
      <li class="bullet"><code class="code-in-text--packt">'Calendar'[Workday in Month]</code>: 21</li>
    </ul>
    <p class="book-title--packt">What we would like Power BI to do is to also show a result for workday 22. There, the <code class="code-in-text--packt">Order intake MTD</code> measure would return no result, but the <code class="code-in-text--packt">Order intake LM (workdays)</code> measure would return the cumulative order intake for workday 22 in April.</p>
    <p class="book-title--packt">The filters on <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code> come from outside of the visual, and the core of the visual's DAX query is:</p>
    <pre class="programlisting"><code class="hljs-code">  VAR __DS0Core = 
    SUMMARIZECOLUMNS(
      'Calendar'[Workday in Month],
      __DS0FilterTable,
      __DS0FilterTable2,
      "Order_intake_MTD", 'Results'[Order intake MTD],
      "Order_intake_LM__workdays_", 
      'Results'[Order intake LM (workdays)]
    )
</code></pre>
    <p class="book-title--packt">Here, <code class="code-in-text--packt">__DS0FilterTable</code> and <code class="code-in-text--packt">__DS0FilterTable2</code> implement the filters on <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code>. </p>
    <p class="book-title--packt">The <code class="code-in-text--packt">SUMMARIZECOLUMNS</code> function applies these<a id="calibre_link-1293" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filters on the <code class="code-in-text--packt">'Calendar'[Workday in Month]</code> column, meaning that we get all the values in the column from rows that correspond to <code class="code-in-text--packt">Year</code> 2020 and <code class="code-in-text--packt">Month</code> May. As May 2020 has 21 workdays, workday 22 is never even considered for evaluation!</p>
    <p class="book-title--packt">Remember the rule of thumb for AutoExist: for columns from the same table, only combinations of values that occur together in rows in the table are evaluated. Our workday analysis <a id="calibre_link-1018" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is the victim of AutoExist's optimization.</p>
    <h2 id="calibre_link-181" class="calibre8">Changing model structure to get around AutoExist</h2>
    <p class="book-title--packt">Now that we<a id="calibre_link-1014" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> know that <a id="calibre_link-332" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>AutoExist is the cause of the missing workdays, the solution is clear: the only way you can get around AutoExist is to remove the <code class="code-in-text--packt">Workday in Month</code> column from the <code class="code-in-text--packt">Calendar</code> table and move it to another table.</p>
    <p class="book-title--packt">As you do not need anything other than the workday number in the new table, it is going to be a single-column table. Let's call it <code class="code-in-text--packt">Workday</code>. You can implement it as a calculated table based on a DAX formula:</p>
    <pre class="programlisting"><code class="hljs-code">Workday = DISTINCT('Calendar'[Workday in Month]
</code></pre>
    <p class="book-title--packt">You still need the workday number to filter the dates, so a relationship is needed between the <code class="code-in-text--packt">Calendar</code> table and the new table:</p>
    <figure class="mediaobject"><img src="images/000147.png" alt="Graphical user interface, text, application, chat or text message  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.21: A new Workday table</p>
    <p class="book-title--packt">With the new<a id="calibre_link-1015" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> table in <a id="calibre_link-333" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>place, you can change the report by using the [<code class="code-in-text--packt">Workday in Month]</code> column from the <code class="code-in-text--packt">Workday</code> table instead of the <code class="code-in-text--packt">Calendar</code> table. By doing this, you will effectively cancel out AutoExist and cause each workday number to be evaluated.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You may wonder if the cross filter property of the new relationship should be set to <strong class="screentext">Single</strong> or to <strong class="screentext">Both</strong>. This makes no difference for AutoExist. AutoExist looks at which tables the columns come from, but does not consider filtering relationships between the tables. The setting does, however, impact the calculation<a id="calibre_link-1016" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of <a id="calibre_link-334" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>measures.</p>
    </div>
    <h2 id="calibre_link-182" class="calibre8">Always consider the context!</h2>
    <p class="book-title--packt">If you follow <a id="calibre_link-1010" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>along with this example and update your report, you will notice that the solution doesn't seem to work. We're still not getting other workdays than those available in the selected month. This is, however, a different problem from what we solved dealing with AutoExist. To see this, let's add the <code class="code-in-text--packt">One</code> measure we used earlier in this chapter and look at the output in table format. In the following images, the original output with workday numbers from the <code class="code-in-text--packt">Calendar</code> table is shown in <em class="italic">Figure 2.4.22</em>, while the new version using the Workday table is shown in <em class="italic">Figure 2.4.23</em> (both showing data for May 2020).</p>
    <figure class="mediaobject"><img src="images/000211.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.22: Table output without the Workday table</p>
    <figure class="mediaobject"><img src="images/000009.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.23: Table output with the Workday table</p>
    <p class="book-title--packt">As is clear from these<a id="calibre_link-1011" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> tables, when using the workday number from the new <code class="code-in-text--packt">Workday</code> table, all workday numbers are evaluated, even workdays 22 and 23, which do not exist in May 2020. The problem is, the <code class="code-in-text--packt">Order intake LM</code> measure should return a result for workday 22, as April 2020 has 22 workdays, while it clearly does not.</p>
    <p class="book-title--packt">This problem is not so much related to AutoExist, but comes from the context of the calculation. Remember the two elements of presenting output that we discussed earlier:</p>
    <ul class="calibre9">
      <li class="bullet">AutoExist defines <em class="italic">which</em> combinations of label values are evaluated.</li>
      <li class="bullet">The query context created through the label filters determines <em class="italic">what</em> the result of the calculation is.</li>
    </ul>
    <p class="book-title--packt">This means that combinations of filters may be evaluated that constitute an empty selection in a fact table that the calculation is performed on. This is what happens here. Let's take a close look.</p>
    <p class="book-title--packt">In our problematic context, we have basically three filters:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">Calendar[Year] = 2020</code></li>
      <li class="bullet"><code class="code-in-text--packt">Calendar[Month] = May</code></li>
      <li class="bullet"><code class="code-in-text--packt">Workday[Workday in Month] = 22</code></li>
    </ul>
    <p class="book-title--packt">Let us revisit<a id="calibre_link-1012" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the <code class="code-in-text--packt">Order intake LM (workdays)</code> measure in this context. The measure starts with the variable <code class="code-in-text--packt">LatestDate</code>:</p>
    <pre class="programlisting"><code class="hljs-code">Order intake LM (workdays) = 
VAR LatestDate = MAX('Calendar'[Date]) 
</code></pre>
    <p class="book-title--packt">What is <code class="code-in-text--packt">MAX('Calendar'[Date])</code> in this context? The filters on <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code> cause the selection of all rows in the <code class="code-in-text--packt">Calendar</code> table in May 2020. The filter on <code class="code-in-text--packt">Workday in Month</code> selects number 22 from the <code class="code-in-text--packt">Workday</code> table. The relationship between the <code class="code-in-text--packt">Workday</code> and <code class="code-in-text--packt">Calendar</code> tables propagates this selection to the <code class="code-in-text--packt">Calendar</code> table; in other words, only rows in <code class="code-in-text--packt">Calendar</code> are selected that satisfy all three filters. This means that in this context, only rows in <code class="code-in-text--packt">Calendar</code> are selected that are both in May 2020, and have workday number 22. And as we already know, there is no workday 22 in May 2020, so the selection is empty! As a consequence, the result of <code class="code-in-text--packt">MAX('Calendar'[Date])</code> is <code class="code-in-text--packt">BLANK</code>.</p>
    <p class="book-title--packt">The variable <code class="code-in-text--packt">LatestDate</code> is used to calculate two other variables:</p>
    <pre class="programlisting"><code class="hljs-code">VAR LatestMonth = 
CALCULATE(
    MAX('Calendar'[MonthCounter]),
    'Calendar'[Date] = LatestDate
)
VAR LatestWorkday = 
CALCULATE(
    MAX('Calendar'[Workday in Month]),
    'Calendar'[Date] = LatestDate
)
</code></pre>
    <p class="book-title--packt">In both declarations, we use a filter argument <code class="code-in-text--packt">'Calendar'[Date] = LatestDate</code>, or <code class="code-in-text--packt">'Calendar'[Date]</code> equals <code class="code-in-text--packt">BLANK</code>. Since no date in the <code class="code-in-text--packt">Calendar</code> table is blank, both <code class="code-in-text--packt">LatestMonth</code> and <code class="code-in-text--packt">LatestWorkday</code> are blank as well.</p>
    <p class="book-title--packt">The remainder of the <a id="calibre_link-1013" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation, in turn, uses the variables to compute the final result:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
CALCULATE(
    [Order intake MTD], 
    'Calendar'[MonthCounter] = LatestMonth - 1, 
    'Calendar'[Workday in Month] = LatestWorkday,
    ALL('Calendar')
)
</code></pre>
    <p class="book-title--packt">With the values of <code class="code-in-text--packt">LatestMonth</code> and <code class="code-in-text--packt">LatestWorkday</code> known, and knowing that DAX will translate <code class="code-in-text--packt">BLANK</code> into zero when doing subtraction, you can derive that this calculation comes down to:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
CALCULATE(
    [Order intake MTD], 
    'Calendar'[MonthCounter] = -1, 
    'Calendar'[Workday in Month] = 0,
    ALL('Calendar')
)
</code></pre>
    <p class="book-title--packt">It is not hard to see that, with these filter arguments, the selection on <code class="code-in-text--packt">Calendar</code> is empty (there's no month with <code class="code-in-text--packt">MonthCounter -1</code>, let alone a day in that month that has workday number <code class="code-in-text--packt">0</code>), and the result of the final calculation is blank. And, as a visual does not show blank <a id="calibre_link-1694" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>values by default, we'll miss out workday 22 from the chart altogether.</p>
    <h2 id="calibre_link-183" class="calibre8">Fixing the workday calculation</h2>
    <p class="book-title--packt">In the previous<a id="calibre_link-1019" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> section, we have seen that our DAX formula for <code class="code-in-text--packt">Workday</code> analysis does not work well with some query contexts provided. The good news is that this problem is not that difficult to solve, as long as you keep thinking carefully about the steps in the calculation.</p>
    <p class="book-title--packt">We know that we cannot just calculate the latest date using <code class="code-in-text--packt">MAX('Calendar'[Date])</code>. But we do not really need the latest date; we only used it to determine the latest month (month counter, to be precise) and the latest workday number. Are there other ways to calculate these? In fact, there are. </p>
    <p class="book-title--packt">Let's start with the latest month:</p>
    <pre class="programlisting"><code class="hljs-code">Order intake LM (workdays 2) = 
VAR LatestMonth = 
    CALCULATE(
        MAX('Calendar'[MonthCounter]), 
        ALL(Workday)
   )
</code></pre>
    <p class="book-title--packt">The workday number is not needed to calculate the latest month. We can therefore circumvent problematic contexts by removing the filter on <code class="code-in-text--packt">Workday</code> with <code class="code-in-text--packt">ALL(Workday)</code>.</p>
    <p class="book-title--packt">Similarly, we do not need the latest date to compute the workday number. It's really the opposite: the workday number determines the latest date. So, instead of calculating the latest workday number from the <code class="code-in-text--packt">Calendar</code> table, we can simply retrieve it from the <code class="code-in-text--packt">Workday</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">VAR LatestWorkday = MAX(Workday[Workday in Month])
</code></pre>
    <p class="book-title--packt">In our problematic context of workday 22 and May 2020, <code class="code-in-text--packt">LatestMonth</code> is the <code class="code-in-text--packt">MonthCounter</code> value corresponding to May 2020, and <code class="code-in-text--packt">LatestWorkday</code> is 22. And with this, the remainder of the calculation can remain the same:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
CALCULATE(
    [Order intake MTD], 
    ALL('Calendar'), 
    'Calendar'[MonthCounter] = LatestMonth - 1, 
    Workday[Workday in Month] = LatestWorkday
)
</code></pre>
    <p class="book-title--packt">The result of this is indeed the month-to-date order intake for workday 22 of April 2020. When put in a <a id="calibre_link-1020" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>visual, we now get the correct results:</p>
    <figure class="mediaobject"><img src="images/000028.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.24: Correct workday analysis chart</p>
    <p class="book-title--packt">As you can see, we were able to solve the missing workdays problem by considering both the AutoExist <a id="calibre_link-1695" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>behavior of Power BI and the (sometimes weird) query contexts that are evaluated.</p>
    <h1 id="calibre_link-184" class="title">Optimizing report performance with AutoExist</h1>
    <p class="book-title--packt">When you<a id="calibre_link-1204" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> know how AutoExist works, you can<a id="calibre_link-338" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> use this knowledge to solve common performance issues in Power BI reports. In this section, we discuss a number of things for you to consider.</p>
    <h2 id="calibre_link-185" class="calibre8">Granularity in fact tables</h2>
    <p class="book-title--packt">As we discussed<a id="calibre_link-1205" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>, the typical structure of a Power BI model consists of fact tables and filter (or dimension) tables. In most real-life cases, multiple fact tables exist in a model. By connecting these to the same filter tables, you can compute aggregate results over these fact tables simultaneously.</p>
    <p class="book-title--packt">Things get a bit more complicated when your fact tables have different granularity. With this, we mean when some facts are gathered on a more detailed level than other facts. Take, for instance, a sales model for a company that sells blocks. Blocks come in different colors and shapes, as well as different sizes, types, and so on.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">This model can be found as <code class="code-in-text--packt">2.4 AutoExist - Product Hierarchy.pbix</code> at <a href="https://github.com/PacktPublishing/Extreme-Dax/tree/main/Chapter2.4" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-Dax/tree/main/Chapter2.4</span></a>.</p>
    </div>
    <p class="book-title--packt">The items that are actually sold to customers, or, you may say, appear on sales invoices, are the stock keeping units, or SKUs. There are 15,000 different SKUs. Sales reps need to provide sales forecasts; these are not provided by SKU, but by product. Products group multiple SKUs (you may think of a product as a physical block, and an SKU being a localized description of that block, like in cm or inches). The total number of products is 3,000. The company also works with targets; targets are not set on the level of SKUs or products, but on the product category level. In total, there are 100 product categories.</p>
    <p class="book-title--packt">A straightforward way to model this would be to have three fact tables: <code class="code-in-text--packt">fSales</code>, <code class="code-in-text--packt">fForecast</code>, and <code class="code-in-text--packt">fTarget</code>. Each row in <code class="code-in-text--packt">fSales</code> relates to one SKU, but a row in <code class="code-in-text--packt">fForecast</code> relates to one<a id="calibre_link-1696" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> product, and a row in <code class="code-in-text--packt">fTarget</code> relates to one category.</p>
    <figure class="mediaobject"><img src="images/000048.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.25: Fact tables with varying granularity</p>
    <h2 id="calibre_link-186" class="calibre8">Filtering on multiple fact tables</h2>
    <p class="book-title--packt">The preferred <a id="calibre_link-1209" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relationship type to join a fact table to a filter table is many-to-one. In the block sales model, this suggests having separate <code class="code-in-text--packt">SKU</code>, <code class="code-in-text--packt">Product</code>, and <code class="code-in-text--packt">Category</code> tables, like in the following diagram:</p>
    <figure class="mediaobject"><img src="images/000069.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.26: The block sales model</p>
    <p class="book-title--packt">As you can see, not <a id="calibre_link-1697" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>only do we have many-to-one relationships between each fact table and its filter tables, but we have relationships between the three product hierarchy tables as well. By doing this, you can not only report sales by <code class="code-in-text--packt">SKU</code>, but also by <code class="code-in-text--packt">Product</code> and <code class="code-in-text--packt">Category</code>.</p>
    <p class="book-title--packt">You cannot report things like forecast by SKU through this model. This makes sense, as forecast is not registered on the SKU level, but the <code class="code-in-text--packt">Product</code> level. If you were to create a visual with forecast by SKU, the visual would, for each SKU, show the total forecast for all products together. </p>
    <p class="book-title--packt">You could also set the <code class="code-in-text--packt">Product</code>-<code class="code-in-text--packt">SKU</code> relationship's cross filter property to <strong class="screentext">Both</strong>, in which case the visual would, for each SKU, present the forecast for the product that SKU belongs to.</p>
    <p class="book-title--packt">It is really a business decision how you want this to work. For instance, you can create a measure to <a id="calibre_link-1210" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculate the percentage sales versus forecast:</p>
    <pre class="programlisting"><code class="hljs-code">Sales vs Forecast =
DIVIDE(
    SUM(fSales[Amount]),
    SUM(fForecast[ForecastAmount])
)
</code></pre>
    <p class="book-title--packt">When using this measure in a visual by SKU, you will typically get small percentages, as the forecast is set on the product level and there are five SKUs per product on average. This may be fine, however. But you could also decide to detect whether the measure is called in a context for a single SKU, and not return any result in that case.</p>
    <p class="book-title--packt">There is another potential issue in this model structure that is related to AutoExist. Suppose you want to create a list of categories and their products and SKUs as a table visual:</p>
    <figure class="mediaobject"><img src="images/000091.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.27: Categories, products, and SKUs in a table visual</p>
    <p class="book-title--packt">As we saw earlier in this chapter, Power BI nicely retrieves the right combinations of <code class="code-in-text--packt">Category</code>, <code class="code-in-text--packt">Product</code>, and <code class="code-in-text--packt">SKU</code> from the model. You will get a table of 15,000 combinations, which <a id="calibre_link-1698" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are pulled from the model in batches while you scroll down in the table.</p>
    <p class="book-title--packt">Now add a simple measure to the table, like <code class="code-in-text--packt">SUM(fSales[Amount])</code>. You may again get 15,000 rows as output, but it could be fewer, as not every SKU is necessarily sold: </p>
    <figure class="mediaobject"><img src="images/000113.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.28: Categories, products, SKUs, and their sales</p>
    <p class="book-title--packt">But what about the number of evaluations needed to populate this visual? This is much <em class="italic">larger</em> than the 15,000 in the table without a measure. As each of the <code class="code-in-text--packt">Category</code>, <code class="code-in-text--packt">Product</code>, and <code class="code-in-text--packt">SKU</code> fields is in its own table, the model evaluates each combination. The total number of evaluations is therefore 100 (categories) x 3,000 (products) x 15,000 (SKUs), or 4.5 billion!</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The behavior described here is the main reason we generally advise against using tables in Power BI reports. People who come from Excel reports, or paginated reports in a database-focused reporting tool, are used to reports in the form of tables with many columns. When moving to Power BI, you may be inclined to stay close to the old style of reports, but having tables with many attribute columns from different tables in the model usually leads to an explosion of combinations that need to be evaluated.</p>
      <p class="book-title--packt">Instead, aim for "non-tabular" visuals with drill-through interactions. Only when drilling into a small subset of data may you show broad tables with many details. Otherwise, restrict yourself to only one or two attribute columns.</p>
    </div>
    <p class="book-title--packt">To be clear, the <a id="calibre_link-1211" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>DAX engine is so powerful that even a huge number of evaluations like this isn't slow by definition. (For instance, the initial DAX query for the table above only took 62 milliseconds on our machine.) It may, however, become a problem when your DAX calculations become more complex, and are written in a less efficient way. Or, even worse, when one of your measures isn't compatible with the labels, causing all or most of the combinations to yield a result. The engine will definitely have an issue calculating billions of results, only to be able to retrieve the first batch to show! (As a test, we added the <code class="code-in-text--packt">One</code> measure discussed earlier to the table visual. It returned a memory error after running for almost 10 minutes.)</p>
    <h2 id="calibre_link-187" class="calibre8">Optimizing model structure</h2>
    <p class="book-title--packt">The solution to <a id="calibre_link-1206" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>avoid the potential problems discussed in the previous section comes down to limiting the number of different tables that you draw the labels in your visuals from. You can do this in two ways:</p>
    <ul class="calibre9">
      <li class="bullet">Use fewer labels in visuals, or only labels from the same table.</li>
      <li class="bullet">Combine tables in the model.</li>
    </ul>
    <p class="book-title--packt">The first one is clear, we assume, so let's dive into the second approach. As discussed in <em class="italic">Chapter 1.2</em>, <em class="italic">Model Design</em>, a star schema is often considered the go-to model structure. Now, having a star schema will not prevent the problems discussed here, as you may use columns from different "points of the star" and still have the same issues. However, it is wise not to split up the entities of your model into too many small pieces, but to look for "broader" tables wherever it makes sense.</p>
    <p class="book-title--packt">Considering the example block sales model, however, saying "<em class="italic">use a star schema</em>" will not help you much either. It's obvious that <code class="code-in-text--packt">Category</code>, <code class="code-in-text--packt">Product</code>, and <code class="code-in-text--packt">SKU</code> are closely related entities, or even different aspects of a single entity. But forcibly combining them into one table causes problems in itself, due to the different granularities of the fact tables in this model. Having a single <code class="code-in-text--packt">Product Hierarchy</code> filter table would force you to have many-to-many relationships on the <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">fForecast</code> fact tables.</p>
    <p class="book-title--packt">There is, however, a different approach you can take. After all, what matters is that we take attributes from a single table where possible; it doesn't matter so much what the model structure looks like. </p>
    <p class="book-title--packt">You can, therefore, move the describing columns from the <code class="code-in-text--packt">Category</code> and <code class="code-in-text--packt">Product</code> tables to the <code class="code-in-text--packt">SKU</code> table, while keeping all IDs in place:</p>
    <figure class="mediaobject"><img src="images/000133.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.29: Adapted block sales model</p>
    <p class="book-title--packt">Note that we set <a id="calibre_link-1207" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the cross filter direction to <strong class="screentext">Both</strong> on the relationships between <code class="code-in-text--packt">Category (narrow)</code>, <code class="code-in-text--packt">Product (narrow)</code> and <code class="code-in-text--packt">SKU (broad)</code> now, as selecting a category from the <code class="code-in-text--packt">SKU (broad)</code> table should filter the <code class="code-in-text--packt">fTarget</code> and <code class="code-in-text--packt">fForecast</code> tables.</p>
    <p class="book-title--packt">As the <code class="code-in-text--packt">Category (narrow)</code> and <code class="code-in-text--packt">Product (narrow)</code> tables only contain ID columns for relationships, they can be hidden, and you could give the SKU table a name to better reflect the product hierarchy.</p>
    <p class="book-title--packt">With this model structure, the engine doesn't have any problem whatsoever with visuals combining category, product, and SKU, even using our <code class="code-in-text--packt">One</code> measure. As you can see in the following figure, only<a id="calibre_link-1208" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> applicable <a id="calibre_link-1699" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>combinations of the three labels are now evaluated:</p>
    <figure class="mediaobject"><img src="images/000153.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.4.30: Output from the adapted block sales model</p>
    <h2 id="calibre_link-188" class="calibre8">Optimizing the visual</h2>
    <p class="book-title--packt">In the previous<a id="calibre_link-1212" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> section, we changed the structure of the Power BI model to avoid getting caught by AutoExist in table visuals. There is another solution you can apply that does not involve adapting the model structure.</p>
    <p class="book-title--packt">In the block sales example, it should be clear that for each SKU, there is exactly one product and one category. Instead of adding these to the visual as labels, you can decide to create a DAX measure that returns the product name for an SKU, and another measure that returns the category name. By doing this, the <code class="code-in-text--packt">Category</code> and <code class="code-in-text--packt">Product</code> columns are populated with the results of the measures, which are calculated for each of the 15,000 SKUs.</p>
    <p class="book-title--packt">It is a lesser-known fact that DAX measures can have text as a result. But there is a group of DAX functions that return text, like <code class="code-in-text--packt">CONCATENATE</code>, which, you've guessed it, concatenates values in a column, or <code class="code-in-text--packt">FORMAT</code>, which transforms a value into a text string with a specific format.</p>
    <p class="book-title--packt">The product measure you would need here returns the value of the <code class="code-in-text--packt">Product</code> column in the product table that corresponds to a selected SKU. You need to consider possible contexts again; specifically, what should the measure return when multiple SKUs are selected? </p>
    <p class="book-title--packt">We'll keep it simple here and say that only one <code class="code-in-text--packt">Product</code> is returned:</p>
    <pre class="programlisting"><code class="hljs-code">SKU_Product =
CALCULATE(
    FIRSTNONBLANK('Product'[Product], 1),
    CROSSFILTER('Product'[ProductID], SKU[ProductID], Both)
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">FIRSTNONBLANK</code> function<a id="calibre_link-1213" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> takes a column<a id="calibre_link-806" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> reference as its first argument. For each value in the column, the expression in the second argument is evaluated until the result is non-blank. The corresponding column value is returned. As we use the simple expression <code class="code-in-text--packt">1</code> here, <code class="code-in-text--packt">FIRSTNONBLANK</code> simply returns the first product. As the relationship between the <code class="code-in-text--packt">Product</code> and <code class="code-in-text--packt">SKU</code> tables does not propagate a filter from <code class="code-in-text--packt">SKU</code> to <code class="code-in-text--packt">Product</code>, we use <code class="code-in-text--packt">CROSSFILTER</code> to change the filter propagation direction to <code class="code-in-text--packt">BOTH</code>.</p>
    <p class="book-title--packt">A measure for <code class="code-in-text--packt">Category</code> works in a similar way but, this time, we have to change the filter propagation direction for two relationships:</p>
    <pre class="programlisting"><code class="hljs-code">SKU_Category =
CALCULATE(
    FIRSTNONBLANK(Category[Category], 1),
    CROSSFILTER('Product'[ProductID], SKU[ProductID], Both),
    CROSSFILTER(Category[CategoryID], 'Product'[CategoryID], Both)
)
</code></pre>
    <p class="book-title--packt">While this solution avoids the need to change the model structure, additional DAX measures are needed for specific visuals. What the best option is depends on your specific Power BI<a id="calibre_link-1700" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> model and reporting needs.</p>
    <h1 id="calibre_link-189" class="title">Summary</h1>
    <p class="book-title--packt">While most of the DAX challenges you will face, and most of this book's chapters, are fundamentally about context, or <em class="italic">what</em> is being calculated, this chapter focused on <em class="italic">which</em> calculations are done to populate a visual from a Power BI model.</p>
    <p class="book-title--packt">Power BI applies AutoExist to guess the combinations of label values to evaluate. The simple rule is:</p>
    <ul class="calibre9">
      <li class="bullet">When columns from the same table are used in a visual, only combinations of column values that are found in rows of the table are evaluated.</li>
      <li class="bullet">When columns from different tables are used, all combinations of values are evaluated.</li>
    </ul>
    <p class="book-title--packt">Understanding how AutoExist works will help you to find out why you sometimes do not see results in a visual when, logically, you would expect them. It also helps to avoid performance problems in reports that are the result of using too many columns from too many tables in one visual. An important lesson is this: be careful with table visuals!</p>
    <p class="book-title--packt">The next chapter returns mainly to DAX context challenges when we look at the complexities you face when analyzing across boundaries, like business between subsidiaries within a company, and business across longer periods of time.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-253">
<div id="calibre_link-1701" class="calibre2">
<div id="calibre_link-1702" class="calibre3"><div id="calibre_link-1703" class="calibre4">
    <h1 class="chapternumber">2.5</h1>
    <h1 id="calibre_link-190" class="title">Intercompany Business</h1>
    <p class="book-title--packt">Larger organizations are normally organized into multiple legal entities. These entities may be separated along product lines, countries, or other business attributes. Whenever this happens, you will have to deal with data crossing the boundaries between entities: the subsidiary in, say, Japan, may do business with Japanese customers, but may also provide products or services to the subsidiary in India. Invoices sent to India may be counted in sales numbers for Japan, but should be consolidated when reporting the worldwide sales numbers. That is, assuming that the India subsidiary booked the purchases from Japan correctly.</p>
    <p class="book-title--packt">A similar challenge arises when business crosses other boundaries. For instance, a company that executes multi-year projects for customers, or sells multi-year support contracts, has to answer questions about what part of the total sales on each project or contract is counted as sales in a specific year. With this, you can provide more detailed insights into sales, even when the sales invoice hasn't been sent yet.</p>
    <p class="book-title--packt">In this chapter, we discuss some of these cross-boundary problems. In each situation, you will learn that understanding the concept of <strong class="screentext">context</strong> is crucial in understanding how to solve these problems. The subject of this chapter is, again, the multinational company QuantoBikes with its many subsidiaries.</p>
    <p class="book-title--packt">The problems discussed in this chapter are:</p>
    <ul class="calibre9">
      <li class="bullet">Business between subsidiaries</li>
      <li class="bullet">Future sales</li>
    </ul>
    <h1 id="calibre_link-191" class="title">Modeling the QuantoBikes sales process</h1>
    <p class="book-title--packt">Many business <a id="calibre_link-1160" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>systems record different stages in a business process. A typical <strong class="screentext">enterprise resource planning </strong>(<strong class="screentext">ERP</strong>) system <a id="calibre_link-727" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>allows us to define the stages, for an invoice to be sent, for example. It is important to note that recording these stages assumes that a business process works in that specific way. The reality is almost always different.</p>
    <p class="book-title--packt">In fact, analyzing the difference between a designed process and the actual process is a field of its own, named <em class="italic">process mining</em>. When you consider a large number of invoices, you will commonly find many deviations from the process as it is designed. Optimizing the business process starts with knowing which variants of the process occur. Some odd variants may have a large impact on throughput or even profitability; eliminating these variants by specific corrective actions can significantly improve business process performance. Analysts who apply process mining can also apply machine learning to predict which process variant a specific case will follow, making it possible to intervene for that case to follow a more optimal process variant.</p>
    <p class="book-title--packt">This book is not about process mining. When thinking about the sales process of QuantoBikes, however, we should be aware that not every sale will follow the designed process. In a Power <a id="calibre_link-1704" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>BI model, you need to be very careful and aware of the assumptions you make to avoid making errors in your analysis. These errors may be very hard to detect!</p>
    <h2 id="calibre_link-192" class="calibre8">The sales process</h2>
    <p class="book-title--packt">For the QuantoBikes<a id="calibre_link-1157" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> example, we use a fairly straightforward sales process. For a sale to come into effect, two steps are taken:</p>
    <ol class="calibre9">
      <li class="calibre12">A <em class="italic">sales order</em> is set up.</li>
      <li class="calibre12">A <em class="italic">sales invoice</em> is sent to the customer, for the amount of the sales order.</li>
    </ol>
    <p class="book-title--packt">QuantoBikes works both with <strong class="screentext">one-off</strong> sales orders and with sales orders that cover a certain period of time, for instance for a support or service contract; let's call these <strong class="screentext">long-term</strong> sales orders. A one-off sales order is issued on a certain date, and provides the date the corresponding sales invoice will be sent. A long-term sales order can have a duration of 1 to 5 years. During this time, a sales invoice will be sent each month, evenly distributing the total sales order amount over the months covered by the sales order. </p>
    <p class="book-title--packt"><em class="italic">Figure 2.5.1</em> depicts the decrease of open sales order amounts (or, the amount that has not been invoiced yet) over time, for sales orders with different durations.</p>
    <figure class="mediaobject"><img src="images/000174.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.1: Open sales order amounts over time</p>
    <p class="book-title--packt">For QuantoBikes' business, purchases <a id="calibre_link-1158" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>need to be made as well. These follow the same basic process:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">A <em class="italic">purchase order</em> is set up.</li>
      <li class="calibre12">A <em class="italic">purchase invoice</em> is received from the supplier.</li>
    </ol>
    <p class="book-title--packt">Like sales orders, purchase orders may cover some period of time in which a purchase invoice is received each month.</p>
    <p class="book-title--packt">QuantoBikes works with <em class="italic">projects</em>, grouping both sales and purchases for a single customer. A customer can have multiple projects.</p>
    <p class="book-title--packt">Internal sales and purchases, or transactions between QuantoBikes subsidiaries, are ordinary sales and purchase orders and invoices in this model. Internal transactions can be detected through the customer or the supplier: in each subsidiary's customer and supplier list, other subsidiaries may show up as internal customers and suppliers.</p>
    <p class="book-title--packt">This is only the sales process as it is designed. In reality, anything may happen and will happen: invoices will be sent without a sales order, sales amounts will differ from order to invoice, and invoices on sales orders covering multiple months will not be evenly distributed. </p>
    <p class="book-title--packt">And with internal transactions, the sales amount of one subsidiary may differ from<a id="calibre_link-1159" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the purchase amount of the other subsidiary, or may not exist at all.</p>
    <h2 id="calibre_link-193" class="calibre8">Model structure</h2>
    <p class="book-title--packt">The basic <a id="calibre_link-1155" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>structure of the data model is in the figure below:</p>
    <figure class="mediaobject"><img src="images/000196.png" alt="Graphical user interface  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.2: The QuantoBikes Power BI model</p>
    <p class="book-title--packt">The model <a id="calibre_link-1705" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>contains two fact tables: <code class="code-in-text--packt">fSales</code>, for sales orders and invoices, and <code class="code-in-text--packt">fPurchases</code>, for purchase orders and invoices. The fact table thus contains both orders and invoices, which are distinguished by a column <code class="code-in-text--packt">Type</code>. </p>
    <p class="book-title--packt">Both fact tables are linked to filter tables: <code class="code-in-text--packt">Product</code>, <code class="code-in-text--packt">Calendar</code>, <code class="code-in-text--packt">Project</code>, and <code class="code-in-text--packt">Ledger</code>. The <code class="code-in-text--packt">Ledger</code> table contains the duration of long-term sales orders and purchase orders. The <code class="code-in-text--packt">fPurchases</code> table is linked to a <code class="code-in-text--packt">Supplier</code> filter table as well.</p>
    <p class="book-title--packt">As you can see from the diagram, the <code class="code-in-text--packt">Project</code> table is linked to a <code class="code-in-text--packt">Customer</code> table, which in turn is linked to a <code class="code-in-text--packt">Company</code> table containing the QuantoBikes subsidiaries. This means that a project is always connected to a single customer, and each customer has a unique company. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The <code class="code-in-text--packt">Project</code>, <code class="code-in-text--packt">Customer</code>, and <code class="code-in-text--packt">Company</code> tables may be combined into one in this model. In a larger model, however, there could be additional fact tables that must be linked to the <code class="code-in-text--packt">Customer</code> table (like a customer-based forecast) or the <code class="code-in-text--packt">Company</code> table as well, in which case having separate tables would be better.</p>
    </div>
    <p class="book-title--packt">Notice that the <code class="code-in-text--packt">Supplier</code> table is not linked to the <code class="code-in-text--packt">Company</code> table; each supplier can be used by each <a id="calibre_link-1156" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>subsidiary.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can find the Power BI file for this chapter, <code class="code-in-text--packt">2.5 Intercompany business.pbix</code>, at <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.5" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.5</span></a>.</p>
    </div>
    <h1 id="calibre_link-194" class="title">Business between subsidiaries</h1>
    <p class="book-title--packt">For the purpose<a id="calibre_link-1186" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of internal transactions, QuantoBikes subsidiaries are listed in the global supplier list and therefore appear in the <code class="code-in-text--packt">Supplier</code> table. A <code class="code-in-text--packt">QMB Subsidiary</code> column denotes these special suppliers with the value <code class="code-in-text--packt">1</code>, whereas all normal suppliers have a value of <code class="code-in-text--packt">0</code> in this column:</p>
    <figure class="mediaobject"><img src="images/000218.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.3: QuantoBikes subsidiaries</p>
    <p class="book-title--packt">Similarly, each subsidiary that sells to another subsidiary needs to add the subsidiary to its customer list. In the <code class="code-in-text--packt">Customer</code> table, an <code class="code-in-text--packt">Internal</code> column is used to distinguish between internal and external customers:</p>
    <figure class="mediaobject"><img src="images/000016.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.4: Internal customers have an Internal value of 1</p>
    <p class="book-title--packt">We can now create DAX measures that do or do not include internal customers using the <code class="code-in-text--packt">Internal</code> <a id="calibre_link-1187" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>column. In other words, we can either calculate a <strong class="screentext">subsidiary view</strong> (including internal customers) or a <strong class="screentext">consolidated view</strong> (excluding internal customers).</p>
    <h2 id="calibre_link-195" class="calibre8">Subsidiary view versus consolidated view</h2>
    <p class="book-title--packt">When <a id="calibre_link-1288" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>analyzing <a id="calibre_link-485" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales, it <a id="calibre_link-398" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is important to consider the level at which you do this analysis. For instance, for a view for the QMB Japan subsidiary only, sales numbers should include sales to other subsidiaries. But global QuantoBikes sales should use a consolidated view, excluding all sales between subsidiaries. The same is true for purchases. In this section, we look at DAX measures to do these calculations as well as to pick the correct calculation.</p>
    <p class="book-title--packt">The basic measure needed to report sales is straightforward:</p>
    <pre class="programlisting"><code class="hljs-code">BaseSales = 
CALCULATE
    SUM(fSales[Amount]),
    fSales[Type] = "Sales Invoice"
)
</code></pre>
    <p class="book-title--packt">For a consolidated view, all transactions to internal customers should be excluded. You can do this with a simple <code class="code-in-text--packt">CALCULATE</code> formula:</p>
    <pre class="programlisting"><code class="hljs-code">SalesConsolidated =
CALCULATE(
    [BaseSales],
    KEEPFILTERS(Customer[Internal] = 0)
)
</code></pre>
    <p class="book-title--packt">We apply <code class="code-in-text--packt">KEEPFILTERS</code> here as a report could be filtered on <code class="code-in-text--packt">Internal</code> customers only; it would be confusing to see consolidated sales to these customers! See <em class="italic">Chapter 1.4</em>, <em class="italic">Context and Filtering</em>, for a more detailed discussion on <code class="code-in-text--packt">KEEPFILTERS</code>.</p>
    <p class="book-title--packt">The challenge here is, of <a id="calibre_link-945" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>course, that from the perspective of DAX we don't know which version of <a id="calibre_link-1289" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales should be calculated, the<a id="calibre_link-399" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> consolidated<a id="calibre_link-486" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> one or the basic calculation. We need to create a measure that detects whether the user is looking at the whole company or a single subsidiary. The DAX function to use here is <code class="code-in-text--packt">HASONEVALUE</code>:</p>
    <pre class="programlisting"><code class="hljs-code">Sales =
IF(HASONEVALUE(Company[CompanyNr]),
    [BaseSales],
    [SalesConsolidated]
)
</code></pre>
    <p class="book-title--packt">We use <code class="code-in-text--packt">HASONEVALUE</code> on the unique <code class="code-in-text--packt">CompanyNr</code> column to avoid triggering the <code class="code-in-text--packt">BaseSales</code> measure when two <a id="calibre_link-877" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>companies with the same name are selected. This may seem highly unlikely, as it would be very confusing to have different subsidiaries with the same name. However, it is still important to think about which column to use. In the real world, the <code class="code-in-text--packt">Company</code> table may contain different "versions" of subsidiaries identified by <code class="code-in-text--packt">CompanyNr</code>; in this case, the versions would be grouped together based on name, and <code class="code-in-text--packt">HASONEVALUE(Company[Company])</code> would be the better option.</p>
    <p class="book-title--packt">On the other side of the equation, you will need the same kinds of measures for purchases:</p>
    <pre class="programlisting"><code class="hljs-code">BasePurchases = 
CALCULATE(
    SUM(fPurchases[Amount]),
    fPurchases[Type] = "Invoice"
)
PurchasesConsolidated =
CALCULATE(
    [BasePurchases],
    KEEPFILTERS(Supplier[QMB Subsidiary] = 0)
)
</code></pre>
    <p class="book-title--packt">Again, the overall measure <a id="calibre_link-946" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>determines which purchase calculation is selected:</p>
    <pre class="programlisting"><code class="hljs-code">Purchases =
IF(HASONEVALUE(Company[CompanyNr]),
    [BasePurchases],
    [PurchasesConsolidated]
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">Sales</code> and <code class="code-in-text--packt">Purchases</code> measures<a id="calibre_link-1290" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> now enable <a id="calibre_link-400" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>both global<a id="calibre_link-487" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> and subsidiary reporting on income and costs.</p>
    <h2 id="calibre_link-196" class="calibre8">Matching internal sales and purchases</h2>
    <p class="book-title--packt">Having a <a id="calibre_link-386" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>consolidated <a id="calibre_link-392" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>view of sales and purchases is important. Just as insightful is focusing specifically on <a id="calibre_link-1706" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>internal sales and purchases. For this, you can use a straightforward variation on the consolidated measures:</p>
    <pre class="programlisting"><code class="hljs-code">SalesInternal1 =
CALCULATE(
    [BaseSales],
    KEEPFILTERS(Customer[Internal] = 1)
)
</code></pre>
    <p class="book-title--packt">And:</p>
    <pre class="programlisting"><code class="hljs-code">PurchasesInternal1 =
CALCULATE(
    [BasePurchases],
    KEEPFILTERS(Supplier[QMB Subsidiary] = 1)
)
</code></pre>
    <p class="book-title--packt">With these measures, you can answer questions like: how much did QMB Japan sell to other subsidiaries? And how much did QMB Japan purchase from other subsidiaries? But there are two more questions to ask: how much did other subsidiaries purchase from QMB Japan? And how much did other subsidiaries sell to&nbsp;QMB Japan?</p>
    <p class="book-title--packt">Theoretically, these things should match: internal sales by QMB Japan should equal internal purchases from QMB Japan by all other subsidiaries. In the real world, we can only hope that this is the case, and it is better to monitor it. It would be good to have a measure to calculate the difference between the sales from one subsidiary and the corresponding purchases in other subsidiaries.</p>
    <p class="book-title--packt">The main challenge here is that you will have to deal with some complicated context transformations. This is best illustrated with some sample output. A Power BI report could contain <a id="calibre_link-387" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a <a id="calibre_link-393" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>matrix visual with sales from QMB Japan to QMB India, purchases by QMB India from QMB Japan, and the difference between the sales and purchases amounts:</p>
    <table id="calibre_link-1707" class="no-table-style">
      <colgroup class="calibre17">
        <col class="calibre18"></col>
        <col class="calibre18"></col>
        <col class="calibre18"></col>
        <col class="calibre18"></col>
      </colgroup>
      <tbody class="calibre19">
        <tr class="no-table-style1">
          <td class="no-table-style2"></td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">QMB India</p>
          </td>
          <td class="no-table-style2"></td>
          <td class="no-table-style2"></td>
        </tr>
        <tr class="no-table-style3">
          <td class="no-table-style2"></td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Sales</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Purchases</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">Difference</p>
          </td>
        </tr>
        <tr class="no-table-style1">
          <td class="no-table-style2">
            <p class="table-column-heading--packt">QMB Japan</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">1,000</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">900</p>
          </td>
          <td class="no-table-style2">
            <p class="table-column-heading--packt">100</p>
          </td>
        </tr>
      </tbody>
    </table>
    <p class="book-title--packt"> Figure 2.5.5: QMB India and QMB Japan matrix</p>
    <p class="book-title--packt">In this visual, you can see that one subsidiary is selected as a row label (QMB Japan) and another as a column label (QMB India). In other words, in the context for these calculations, we have two filters:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">Company[Company] = "QMB Japan"</code></li>
      <li class="bullet"><code class="code-in-text--packt">Customer[Customer] = "QMB India"</code></li>
    </ul>
    <p class="book-title--packt">The <code class="code-in-text--packt">SalesInternal1</code> measure will correctly calculate the sales from QMB Japan to QMB India. If you were to use <code class="code-in-text--packt">PurchasesInternal1</code> in this context, however, you would find that the result is not what you want. In fact, what the measure returns is purchases done by QMB Japan from an unspecified supplier, where QMB India acts as the customer. What we are looking for, however, is purchases done by QMB India for which QMB Japan is the supplier. To solve this, we will have to transform the context and reverse the roles of QMB Japan and QMB India:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">Company[Company] = "QMB India"</code></li>
      <li class="bullet"><code class="code-in-text--packt">Supplier[Supplier] = "QMB Japan"</code></li>
    </ul>
    <p class="book-title--packt">In other words, we need to use the selected customer as the company, and the selected company as the supplier. Or stated in yet another way, we need to transition the selection in the <code class="code-in-text--packt">Customer</code> table to the <code class="code-in-text--packt">Company</code> table, and transition the selection in the <code class="code-in-text--packt">Company</code> table to the <code class="code-in-text--packt">Supplier</code> table. </p>
    <p class="book-title--packt">To do this kind of context transformation, you must use the <code class="code-in-text--packt">TREATAS</code> function:</p>
    <pre class="programlisting"><code class="hljs-code">PurchasesFromCompany1 =
CALCULATE(
    [PurchasesInternal1],
    TREATAS(DISTINCT(Customer[Customer]), Company[Company]),
    TREATAS(DISTINCT(Company[Company]), Supplier[Supplier]),
    ALL(Company),
    ALL(Customer),
    ALL(Supplier)
)
</code></pre>
    <p class="book-title--packt">In this formula, <code class="code-in-text--packt">DISTINCT</code> is <a id="calibre_link-394" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>used<a id="calibre_link-388" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to retrieve the unique values from the respective columns. <code class="code-in-text--packt">TREATAS</code> feeds these values as filters on the column provided in the second argument. Do not forget that the existing filters on the <code class="code-in-text--packt">Company</code> and <code class="code-in-text--packt">Customer</code> tables must be removed; and while we're at it, we'll remove filters from the <code class="code-in-text--packt">Supplier</code> table as well, to get rid of possible filters that stand in our way there. (Because of the relationship between <code class="code-in-text--packt">Customer</code> and <code class="code-in-text--packt">Company</code>, <code class="code-in-text--packt">ALL(Customer)</code> will also remove filters from the <code class="code-in-text--packt">Company</code> table, so <code class="code-in-text--packt">ALL(Company)</code> is not really needed here.)</p>
    <p class="book-title--packt">There is one major problem with this approach: it depends on the names of the subsidiaries. Note that the name of a subsidiary appears at three places in the model: in the <code class="code-in-text--packt">Company</code> table, the <code class="code-in-text--packt">Customer</code> table, and the <code class="code-in-text--packt">Supplier</code> table. The name of a subsidiary must be exactly <a id="calibre_link-1403" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the same in each of the three tables. This is a dangerous assumption to make and, as a matter of fact, in our example data, the names are not identical.</p>
    <p class="book-title--packt">The better approach would be to use a unique subsidiary identifier. We cannot use the <code class="code-in-text--packt">Customer</code> or <code class="code-in-text--packt">Supplier</code> numbers, as they are not identical either; the best candidate is the <code class="code-in-text--packt">Company</code> number. So, we should add information to the <code class="code-in-text--packt">Customer</code> and <code class="code-in-text--packt">Supplier</code> tables to identify the subsidiaries with their <code class="code-in-text--packt">Company</code> number. You could add a specific column containing the company number, but in fact, the perfect columns to do this are already there! The <code class="code-in-text--packt">Customer[Internal]</code> and <code class="code-in-text--packt">Supplier[QMB Subsidiary]</code> columns contain the value 1 to denote internal customers and suppliers, but the only thing that really matters is that this value is different from 0, to distinguish them from external customers and suppliers. So, instead of using the value 1, you can work with the corresponding <code class="code-in-text--packt">Company</code> number.</p>
    <p class="book-title--packt">Our internal sales and purchases measures need to be slightly adapted:</p>
    <pre class="programlisting"><code class="hljs-code">SalesInternal2 =
CALCULATE(
    [BaseSales],
    KEEPFILTERS(Customer[Internal] &gt; 0)
)
</code></pre>
    <p class="book-title--packt">And:</p>
    <pre class="programlisting"><code class="hljs-code">PurchasesInternal2 =
CALCULATE(
    [BasePurchases],
    KEEPFILTERS(Supplier[QMB Subsidiary] &gt; 0)
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">PurchasesFromCompany2</code> measure<a id="calibre_link-389" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> can <a id="calibre_link-395" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>now work with the <code class="code-in-text--packt">Company</code> number columns. For readability, let's use some variables:</p>
    <pre class="programlisting"><code class="hljs-code">PurchasesFromCompany2 =
VAR SubsidiariesAsCustomers = DISTINCT(Customer[Internal])
VAR SubsidiariesAsCompanies = DISTINCT(Company[CompanyNr])
RETURN
CALCULATE(
    [PurchasesInternal2],
    TREATAS(SubsidiariesAsCustomers, Company[CompanyNr]),
    TREATAS(SubsidiariesAsCompanies, Supplier[QMB Subsidiary]),
    ALL(Company),
    ALL(Customer),
    ALL(Supplier)
)
</code></pre>
    <p class="book-title--packt">Note that <code class="code-in-text--packt">DISTINCT(Customer[Internal])</code> may also contain the value 0 when external customers are selected (for instance, because <a id="calibre_link-1404" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>no filtering has been done at all). This is not a problem, however: <code class="code-in-text--packt">TREATAS</code> applies these values to the <code class="code-in-text--packt">Company[CompanyNr]</code> column, but there <a id="calibre_link-947" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is no value 0 in that column so only the non-zero values will lead to a subsidiary being selected.</p>
    <p class="book-title--packt">There is yet another thing to improve here. We can now correctly calculate both internal sales and internal purchases in the same context for a <code class="code-in-text--packt">Company</code>. However, the name of the other subsidiaries is taken from the <code class="code-in-text--packt">Customer</code> table; and as each subsidiary has its own customer list, the same subsidiary can appear in the <code class="code-in-text--packt">Customer</code> table multiple times, and with different names. This will be confusing and that is not what we want.</p>
    <p class="book-title--packt">What we want to do is make sure that, when reporting on intercompany business, the proper names from the <code class="code-in-text--packt">Company</code> table are used. This means that the <code class="code-in-text--packt">Company[Company]</code> column could be needed twice in a single visual, for instance, providing both row labels and column labels, while having a different context in each. This is impossible. The only way to solve that is to duplicate the <code class="code-in-text--packt">Company</code> table altogether. Let's call this new table <code class="code-in-text--packt">Company (to)</code>.</p>
    <p class="book-title--packt">The new table does not need to have relationships with other tables, as we will use the <code class="code-in-text--packt">TREATAS</code> function to transition filter context from the <a id="calibre_link-1479" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table to other appropriate tables. The <code class="code-in-text--packt">SalesInternal3</code> measure <a id="calibre_link-390" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>becomes <a id="calibre_link-396" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a bit more complex as, this time, we need to take into account that selecting customers is now done on the <code class="code-in-text--packt">Company (to)</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">SalesInternal3 =
VAR InternalCustomers = DISTINCT('Company (to)'[Companynr])
RETURN
CALCULATE(
    [BaseSales],
    TREATAS(InternalCustomers, Customer[Internal]),
    ALL(Customer), 
    -- Customer[Internal] &gt; 0
    VALUES(Company[CompanyNr])
)
</code></pre>
    <p class="book-title--packt">When you think about it, you will conclude that the <code class="code-in-text--packt">Customer[Internal] &gt; 0</code> filter, commented out in the formula, is obsolete now; company numbers, each of which is larger than zero, are fed into this <a id="calibre_link-1405" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>column and thus no external customers are selected. As <code class="code-in-text--packt">ALL(Customer)</code> removes filters from the <code class="code-in-text--packt">Company</code> table as well, we need to feed the selected companies back into the calculation using <code class="code-in-text--packt">VALUES</code>.</p>
    <p class="book-title--packt">The internal purchases measure now takes the <code class="code-in-text--packt">Company</code> numbers from the new <code class="code-in-text--packt">Company (to)</code> table instead of the <code class="code-in-text--packt">Customers</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">PurchasesFromCompany3 =
VAR InternalCustomers = DISTINCT('Company (to)'[Companynr])
VAR SubsidiariesAsCompanies = DISTINCT(Company[CompanyNr])
RETURN
CALCULATE(
    [BasePurchases],
    TREATAS(InternalCustomers, Company[CompanyNr]),
    TREATAS(SubsidiariesAsCompanies, Supplier[QMB Subsidiary]),
    ALL(Company),
    ALL(Customer),
    ALL(Supplier)
)
</code></pre>
    <p class="book-title--packt">A more subtle change in the formula is that we no longer call the <code class="code-in-text--packt">[PurchasesInternal]</code> measure, but the <code class="code-in-text--packt">[BasePurchases]</code> measure instead. The difference between the two is the application of the <code class="code-in-text--packt">Supplier[QMB Subsidiary] &gt; 0</code> filter; and like in the sales measure, this<a id="calibre_link-391" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filter is implicitly <a id="calibre_link-397" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>applied by <code class="code-in-text--packt">TREATAS</code> from the <code class="code-in-text--packt">Company[CompanyNr]</code> column.</p>
    <h2 id="calibre_link-197" class="calibre8">Visualizing intercompany business</h2>
    <p class="book-title--packt">Now that we <a id="calibre_link-380" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have <a id="calibre_link-892" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>proper measures for internal sales and internal purchases working with the <code class="code-in-text--packt">Company</code> and <code class="code-in-text--packt">Company (to)</code> tables, we can calculate the <em class="italic">internal balance</em> with a simple measure:</p>
    <pre class="programlisting"><code class="hljs-code">Internal Balance = [SalesInternal3] &ndash; [PurchasesFromCompany3]
</code></pre>
    <p class="book-title--packt">But wait &ndash; with this measure, you can check whether there is a balance between, say, QMB Japan's sales invoices to QMB India, and QMB India's purchase invoices with QMB Japan as the supplier. The QuantoBikes executive team may want these to be in balance; however, there is another way business between QMB Japan and QMB India can be in balance: when QMB India sells something to QMB Japan, they may opt to send a lower sales invoice instead of <a id="calibre_link-1406" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>booking a purchase invoice. Business between subsidiaries may be largely informal, and it is likely that no actual invoices are sent to and fro.</p>
    <p class="book-title--packt">Note that this is a business issue, not a technical issue. There is no single right way to tackle this from a technical perspective; instead, business owners need to decide what calculation they want to be done.</p>
    <p class="book-title--packt">But for now, let's assume that we are not so interested in the formal balance, but rather in the informal balance; that means that we need to calculate the balance between four financial streams:</p>
    <ul class="calibre9">
      <li class="bullet">Sales invoices from A to B</li>
      <li class="bullet">Purchase invoices from B to A</li>
      <li class="bullet">Sales invoices from B to A</li>
      <li class="bullet">Purchase invoices from A to B</li>
    </ul>
    <p class="book-title--packt">The <code class="code-in-text--packt">Internal Balance</code> measure calculates the balance in two of the four streams. For the other two, we need to calculate a similar balance but in a reversed direction: instead of the balance between <code class="code-in-text--packt">Company</code> and <code class="code-in-text--packt">Company (to)</code>, we need the balance between <code class="code-in-text--packt">Company (to)</code> and <code class="code-in-text--packt">Company</code>. But to be able to add the two measures and complete our balance calculation, the <a id="calibre_link-1407" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>second measure must be calculated in the same context as the first. In other words, we must, once again, flip the context on the two tables. We may as well do this<a id="calibre_link-381" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> directly<a id="calibre_link-893" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> on the internal sales and purchases measures that make up the internal balance measure:</p>
    <pre class="programlisting"><code class="hljs-code">SalesInternal (reversed) =
VAR CompaniesFrom = DISTINCT(Company[CompanyNr])
VAR CompaniesTo = DISTINCT('Company (to)'[CompanyNr])
RETURN
CALCULATE(
    [SalesInternal3],
    TREATAS(CompaniesTo, Company[CompanyNr]),
    TREATAS(CompaniesFrom, 'Company (to)'[CompanyNr]),
    ALL(Company),
    ALL('Company (to)')
)
PurchasesFromCompany (reversed) =
VAR CompaniesFrom = DISTINCT(Company[CompanyNr])
VAR CompaniesTo = DISTINCT('Company (to)'[CompanyNr])
RETURN
CALCULATE(
    [PurchasesFromCompany3],
    TREATAS(CompaniesTo, Company[CompanyNr]),
    TREATAS(CompaniesFrom, 'Company (to)'[CompanyNr]),
    ALL(Company),
    ALL('Company (to)')
)
</code></pre>
    <p class="book-title--packt">Again, we use the <code class="code-in-text--packt">TREATAS</code> function to insert the selection in one table as a filter on the other table, applying <code class="code-in-text--packt">ALL</code> to get rid of the original filters. Note that we still allow multiple companies to be selected on either side; this way, we can calculate the total balance for the whole QuantoBikes company (which ideally should be zero).</p>
    <p class="book-title--packt">The measure to calculate the overall balance must combine the four internal sales and purchases measures:</p>
    <pre class="programlisting"><code class="hljs-code">Internal Balance (total) =
[SalesInternal3] 
&ndash; [PurchasesFromCompany3]
- [SalesInternal (reversed)] 
+ [PurchasesFromCompany (reversed)]
</code></pre>
    <p class="book-title--packt">The picture below <a id="calibre_link-382" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>shows <a id="calibre_link-894" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the output of this measure for the year 2020 in a matrix visual.</p>
    <figure class="mediaobject"><img src="images/000034.png" alt="Graphical user interface  Description automatically generated with low confidence" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.6: View on internal balance for QuantoBikes</p>
    <p class="book-title--packt">You may notice a couple of things here. First, the grand total (the result in the <strong class="screentext">Total</strong> row and <strong class="screentext">Total </strong>column) is zero. Does this <a id="calibre_link-527" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>mean that there is a perfect balance between sales and purchases? The answer is no; rather, because we are comparing all subsidiaries <a id="calibre_link-758" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>here, the results of the <code class="code-in-text--packt">[SalesInternal3]</code> and <code class="code-in-text--packt">[SalesInternal (reversed)]</code> measures are exactly the same, as are the results of the <code class="code-in-text--packt">[PurchasesFromCompany3]</code> and <code class="code-in-text--packt">[PurchasesFromCompany (reversed)]</code> measures. It does not mean that <code class="code-in-text--packt">[SalesInternal3]</code> and <code class="code-in-text--packt">[PurchasesFromCompany3]</code> are in balance.</p>
    <p class="book-title--packt">Another thing you may notice is that all results appear twice in the visual, albeit negated and mirrored across the diagonal. As this adds nothing to the insights provided by this analysis, it would be better to hide half of the numbers. You can do this by adding an additional filter to the internal balance calculation:</p>
    <pre class="programlisting"><code class="hljs-code">Internal Balance (final) =
VAR Companies =
    FILTER(
        CROSSJOIN(
            DISTINCT(Company[CompanyNr]),
            DISTINCT('Company (to)'[CompanyNr])
        ),
        Company[CompanyNr] &gt;= 'Company (to)'[CompanyNr]
    )
RETURN
CALCULATE(
    [Internal Balance (total)],
    Companies
)
</code></pre>
    <p class="book-title--packt">In this<a id="calibre_link-383" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> formula, the <code class="code-in-text--packt">CROSSJOIN</code> function <a id="calibre_link-895" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>creates a table containing all combinations of values of <code class="code-in-text--packt">[CompanyNr]</code> from both <code class="code-in-text--packt">Company</code> tables (that is, only those values that are selected in the query context for this <a id="calibre_link-528" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>measure). With the <code class="code-in-text--packt">FILTER</code> function, the combinations for which <code class="code-in-text--packt">[CompanyNr]</code> in the <code class="code-in-text--packt">Company (to)</code> table is smaller than that in the <code class="code-in-text--packt">Company</code> table are removed. The filtered table is <a id="calibre_link-759" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>used as a filter in <code class="code-in-text--packt">CALCULATE</code>, effectively reducing the selection in both the <code class="code-in-text--packt">Company</code> and <code class="code-in-text--packt">Company (to)</code> table. </p>
    <p class="book-title--packt">For the result to look nice, you will also have to set the sort order on the <code class="code-in-text--packt">[Company]</code> columns in both tables to follow the <code class="code-in-text--packt">[CompanyNr]</code> column. This will cause all results to be shown below the diagonal in the matrix. The result now looks like this (we set the <strong class="screentext">Show items with no data</strong> option on both the row and the column fields):</p>
    <figure class="mediaobject"><img src="images/000057.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.7: Cleaned-up internal balance view</p>
    <p class="book-title--packt">As you can see, the duplicates are gone and, as a result, the totals also show a different value. The overall result is still zero.</p>
    <p class="book-title--packt">As with any<a id="calibre_link-1708" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> insight, new <a id="calibre_link-1709" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>questions will arise from what you see here. We can now see there is an imbalance between many subsidiaries (frankly, it's quite a mess at QuantoBikes!) and you may wonder what is actually happening. And where does that zero at QMB Japan come from? It would be a good addition to this visual to add a tooltip, for instance, with the breakdown of the internal balance. After all, we have already created measures for sales and purchases in all directions.</p>
    <p class="book-title--packt">To make this tooltip easily readable, we will add some dynamic titles to avoid forcing the user to guess what goes where. After all, it is easy to lose track of which subsidiary is playing which role at what time. </p>
    <p class="book-title--packt">We give you the formulas to do this without further ado:</p>
    <pre class="programlisting"><code class="hljs-code">From Company = SELECTEDVALUE(Company[Company], "(Multiple)")
To Company = SELECTEDVALUE('Company (to)'[Company], "(Multiple)")
Title_Sales_AtoB = 
    "Sales from " &amp; [From Company] &amp; " to " &amp; [To Company]
Title_Purchases_BfromA = 
    "Purchases by " &amp; [To Company] &amp; " from " &amp; [From Company]
Title_Sales_BtoA = 
    "Sales from " &amp; [To Company] &amp; " to " &amp; [From Company]
Title_Purchases_AfromB = 
   "Purchases by " &amp; [From Company] &amp; " from " &amp; [To Company]
</code></pre>
    <p class="book-title--packt">It is a good idea to give measures that are solely aimed at creating dynamic titles a name starting with <code class="code-in-text--packt">Title</code>. When these titles are specific to a report and you build your reports as "live connection" (meaning in a different file to the model), it is advisable to create these measures in the report file and not in the model. In doing this, you avoid having a large number of report-specific measures that will cause more maintenance on the model.</p>
    <p class="book-title--packt">A tooltip created <a id="calibre_link-384" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with<a id="calibre_link-896" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> these dynamic titles adds additional clarity to the output:</p>
    <figure class="mediaobject"><img src="images/000076.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.8: Adding details to the internal balance view</p>
    <p class="book-title--packt">In this example, we can see that although the total internal balance between QMB UK and QMB Germany is less than 6,000, it comes from an imbalance in sales from the UK to Germany that is partly offset by an imbalance in sales from Germany to the UK.</p>
    <p class="book-title--packt">With this tooltip, we can also discover where the zero at QMB Japan comes from: it turns out that Japan issued a purchase from themselves! This is a somewhat unexpected insight coming from our calculations, but the world is indeed messy, and&nbsp;often, the first outcome of a Power BI analysis is discovering all these weird things that are happening, or are wrongly reflected in the data.</p>
    <p class="book-title--packt"><img src="images/000098.png" alt="Table  Description automatically generated" class="calibre20" /></p>
    <p class="book-title--packt">Figure 2.5.9: Insight into weird results at QMB Japan</p>
    <p class="book-title--packt">You can, of course, extend this report with further drillthrough options. After all, in our measures we did nothing with dates, products, or projects, so the calculations will still work when<a id="calibre_link-385" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> additional<a id="calibre_link-897" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> filters from the <code class="code-in-text--packt">Calendar</code>, <code class="code-in-text--packt">Product</code>, or <code class="code-in-text--packt">Project</code> table are added. This makes it possible to zoom in further and see exactly where things are not in balance.</p>
    <h1 id="calibre_link-198" class="title">Future sales</h1>
    <p class="book-title--packt">For our next <a id="calibre_link-1161" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>analysis, let's turn back to the QuantoBikes sales process, focusing on two simple steps: booking a sales order, and sending an invoice based on the sales order.</p>
    <p class="book-title--packt">You can calculate the actual sales (and purchases, for that matter) from the invoices in our model. A common question to ask is: how will sales develop through the rest of the year? One part of the answer to this question deals with sales forecasting and the sales pipeline. These are very useful things to analyze, although they come with inherent uncertainty.</p>
    <p class="book-title--packt">A much more specific part of the answer comes from looking at sales orders that have not been (fully) invoiced yet. After all, a sales order is typically booked when the customer agrees to the sale, but the corresponding invoice is sometimes sent on a later date. So, what could be easier than determining what sales orders have not been invoiced yet, or at least, not completely?</p>
    <p class="book-title--packt">Well, a lot of things are easier than that, but we'll cover how to do it here. In addition, we'll talk about a more sophisticated analysis that takes long-term sales orders and calculates the <a id="calibre_link-1710" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>invoice amount that can be sent on those sales orders.</p>
    <h2 id="calibre_link-199" class="calibre8">Sales on one-off sales orders</h2>
    <p class="book-title--packt">When<a id="calibre_link-1183" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> you look at the <code class="code-in-text--packt">fSales</code> table, you <a id="calibre_link-1046" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will find both sales orders and sales invoices among its rows. How can you determine which invoice goes with which order? This is done with two columns: <code class="code-in-text--packt">DocumentNr</code> and <code class="code-in-text--packt">OrderNr</code>:</p>
    <figure class="mediaobject"><img src="images/000120.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.10: How orders and invoices are linked</p>
    <p class="book-title--packt">As you can see from the picture, multiple <code class="code-in-text--packt">fSales</code> rows can have the same <code class="code-in-text--packt">DocumentNr</code> value. These could be different <a id="calibre_link-435" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>lines on the same invoice. Sales orders have a <code class="code-in-text--packt">DocumentNr</code> as well. Invoices that are bound to a sales order have the <code class="code-in-text--packt">DocumentNr</code> value of that sales order stored in the <code class="code-in-text--packt">OrderNr</code> column.</p>
    <p class="book-title--packt">As it happens, sometimes invoices are sent without a sales order. Obviously, you may want to report on these, but they do not play a role in invoices that are yet to be sent. A more interesting analysis is to determine <a id="calibre_link-1423" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>which sales orders have not been invoiced yet; this is somewhat complicated by the fact that the normal process allows for sales orders that will only be invoiced at a later delivery date.</p>
    <p class="book-title--packt">So, what we need to do is to find sales orders that could have been invoiced in a period of time, but have not been. We only deal with one-off sales orders for now; these can be detected by the fact they have a duration of zero (while long-term sales orders have a non-zero duration). From a DAX perspective, we need a few steps:</p>
    <ul class="calibre9">
      <li class="bullet">Determine which sales orders have a delivery date in the selected period of time</li>
      <li class="bullet">Determine the invoice amount that has not yet been invoiced</li>
    </ul>
    <p class="book-title--packt">You may conclude from this that we will have to go through the set of sales orders one by one and <a id="calibre_link-1184" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>find the corresponding<a id="calibre_link-1047" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> invoices. But we can do this in a simpler way by calculating the total number of invoices <a id="calibre_link-948" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>related to the set of sales orders found. It doesn't really matter which invoice belongs to which sales order. The <em class="italic">assumption</em> that supports this approach is that the total amount invoiced does not exceed the sales order amount. In a real business setting, this assumption should, of course, be validated!</p>
    <p class="book-title--packt">Keep in mind that the relationship between <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">Calendar</code> is on the date of the order or invoice, not on the delivery date.</p>
    <p class="book-title--packt">First, we find our sales orders:</p>
    <pre class="programlisting"><code class="hljs-code">To Invoice (project) =
VAR SalesOrders =
    CALCULATETABLE(
        DISTINCT(fSales[DocumentNr]),
        fSales[Type] = "Sales Order",
        KEEPFILTERS(Ledger[Duration] = 0),
        USERELATIONSHIP(fSales[DeliveryDate], 'Calendar'[Date])
    )
</code></pre>
    <p class="book-title--packt">Using <code class="code-in-text--packt">USERELATIONSHIP</code>, we tell DAX to filter the <code class="code-in-text--packt">fSales</code> table on the <code class="code-in-text--packt">DeliveryDate</code> column, through which we get exactly the sales orders with a delivery date in the selected period of time. Next, we calculate <a id="calibre_link-1408" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the invoice amount for these sales orders:</p>
    <pre class="programlisting"><code class="hljs-code">VAR InvoicedAmount =
    CALCULATE(
        SUM(fSales[Amount]),
        fSales[Type] = "Sales Invoice",
        ALL('Calendar'),
        TREATAS(SalesOrders, fSales[OrderNr])
    )
</code></pre>
    <p class="book-title--packt">The main filter here is the one using <code class="code-in-text--packt">TREATAS</code>. This filter applies our list of sales orders to the <code class="code-in-text--packt">OrderNr</code> column, effectively selecting invoices linked to those orders. The normal <a id="calibre_link-1424" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>situation would be that these invoices have a date within the selected period of time, but we are not sure everything is normal, so we look for other dates as well by removing filters from the <code class="code-in-text--packt">Calendar</code> table.</p>
    <p class="book-title--packt">We can now compute the <a id="calibre_link-949" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>total sales order amount of these sales orders, and compare that to the amount invoiced; the difference is what's left to invoice:</p>
    <pre class="programlisting"><code class="hljs-code">VAR OrderedAmount =
    CALCULATE(
        SUM(fSales[Amount]),
        fSales[Type] = "Sales Order",
        KEEPFILTERS(Ledger[Duration] = 0),
        USERELATIONSHIP(fSales[DeliveryDate], 'Calendar'[Date])
    )
RETURN
OrderedAmount &ndash; InvoicedAmount
</code></pre>
    <p class="book-title--packt">By applying the exact same filters as for the <code class="code-in-text--packt">SalesOrders</code> variable, we are sure that we get the corresponding order amount.</p>
    <p class="book-title--packt">There is another assumption made implicitly in this calculation: it returns the <em class="italic">current</em> amount still <a id="calibre_link-1185" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to be invoiced. You may<a id="calibre_link-1048" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> want to do historical calculations as well; this analysis can provide insights into how the organization's discipline in sales order depletion is improving or worsening over time. We will not cover historical analysis in this chapter.</p>
    <h2 id="calibre_link-200" class="calibre8">Sales on long-term sales orders</h2>
    <p class="book-title--packt">Let us now<a id="calibre_link-983" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> turn<a id="calibre_link-1181" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to long-term sales orders. These sales orders have a duration that typically spans multiple years, which means that you cannot simply compare the sales order amount and the total amount invoiced so far. Instead, a period of time needs to be selected, and then we can calculate the amount that can be invoiced during this period; this is only equal to the full open amount when the duration of the sales order ends within the selected time period. The period of time to select could be, for instance, the rest of the current year, to calculate the planned sales from support contracts that will contribute to this year's results.</p>
    <p class="book-title--packt">The figure below shows, once again, the typical decrease in open sales order amount for a sample of long-term sales orders. The dark-colored sales orders have a duration of 2 years, or 24 months, to invoice, whereas the light-colored sales order has a duration of 1 year, or 12 months.</p>
    <figure class="mediaobject"><img src="images/000139.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.11: Expected invoice amounts during a selected time period</p>
    <p class="book-title--packt">In the figure, the<a id="calibre_link-1711" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> rectangle <a id="calibre_link-1712" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>depicts the period of time selected. We can see different situations regarding the three sales orders in the picture, based on where the dotted lines end:</p>
    <ul class="calibre9">
      <li class="bullet">One sales order has been fully invoiced (dotted line ends before the selection; an <strong class="screentext">old sales order</strong>)</li>
      <li class="bullet">One sales order still has an open amount, but will be invoiced in full during the selected time period (dotted line ends within the selection; a <strong class="screentext">current sales order</strong>)</li>
      <li class="bullet">One sales order will still have an open amount after the selected time period (dotted line ends after the selection; also a <strong class="screentext">current sales order</strong>)</li>
    </ul>
    <p class="book-title--packt">This is only the expected, ideal flow of events; the reality is probably different. And that is what we want to detect with this analysis.</p>
    <p class="book-title--packt">Before we dive into the calculations, let's take a look at how the durations are modeled. The <code class="code-in-text--packt">fSales</code> fact table has a relationship with a <code class="code-in-text--packt">Ledger</code> table containing a <code class="code-in-text--packt">Duration</code> column.</p>
    <figure class="mediaobject"><img src="images/000160.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.12: fSales and Ledger</p>
    <p class="book-title--packt">Looking <a id="calibre_link-306" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>at a<a id="calibre_link-1182" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> sample of data in the <code class="code-in-text--packt">Ledger</code> table, you will learn that durations are stored as a number of months:</p>
    <figure class="mediaobject"><img src="images/000181.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.13: Durations in the Ledger table</p>
    <p class="book-title--packt">The status of a sales order &ndash; whether it should be invoiced in full, will be invoiced in full during our <a id="calibre_link-1713" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selected period, or will still <a id="calibre_link-1714" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have an open amount &ndash; can be derived from the duration in combination with the delivery date of the sales order.</p>
    <h3 id="calibre_link-201" class="calibre8">Dealing with old sales orders</h3>
    <p class="book-title--packt">The model <a id="calibre_link-1040" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will<a id="calibre_link-1172" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> contain a lot of historical records, including long-term sales orders that have been invoiced in full a long time ago. We want to deal with these sales orders as efficiently as possible. The problem is, there may be old sales orders that are <em class="italic">not</em> fully invoiced yet.</p>
    <p class="book-title--packt">We can treat these sales orders in the same way as one-off sales orders: all open amounts can &ndash; and should &ndash; be invoiced right away. The challenge comes down to selecting these sales orders.</p>
    <p class="book-title--packt">To start, we determine the date from which to determine the old sales orders. This is, of course, the first day in the selected period: any sales order without scheduled invoicing after that date is old. But there is a caveat: we want to make sure that we only look to the future. </p>
    <p class="book-title--packt">After all, we cannot expect invoices to be sent during months that have already passed:</p>
    <pre class="programlisting"><code class="hljs-code">Old sales orders =
VAR MinDate = MIN('Calendar'[Date])
VAR FirstDayOfSelection = EOMONTH(MAX(MinDate, TODAY()), 0)
RETURN
</code></pre>
    <p class="book-title--packt">By taking the largest of either <code class="code-in-text--packt">MinDate</code> or <code class="code-in-text--packt">TODAY()</code>, we know for certain that we are working with a date that is not in the past. We <a id="calibre_link-728" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>push this to the end of the month using <code class="code-in-text--packt">EOMONTH</code> to make our life a little easier.</p>
    <p class="book-title--packt">What are the "old" sales orders? These <a id="calibre_link-436" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are the sales orders with a delivery date that is at least the number of months before <code class="code-in-text--packt">FirstDayOfSelection</code> that is equal to the duration of the <a id="calibre_link-1173" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales order. To better<a id="calibre_link-1041" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> understand <a id="calibre_link-760" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the logic, it helps to do the calculation by duration:</p>
    <pre class="programlisting"><code class="hljs-code">SUMX(
    FILTER(
        DISTINCT(Ledger[Duration]),
        Ledger[Duration] &gt; 0
    ),
    VAR ThisDuration = Ledger[Duration]
    VAR CutOffDate = 
        EOMONTH(FirstDayOfSelection, -1 * ThisDuration)
    VAR SalesOrders =
        CALCULATETABLE(
            DISTINCT(fSales[DocumentNr]),
            fSales[Type] = "Sales Order",
            fSales[DeliveryDate] &lt;= CutOffDate,
            ALL('Calendar')
        )
</code></pre>
    <p class="book-title--packt">We first determine the set of distinct durations. One-off sales orders have a ledger with duration zero, so we need to filter out the zeroes. <code class="code-in-text--packt">SUMX</code> iterates over this set, and we like to store the current value in a variable, <code class="code-in-text--packt">ThisDuration</code> in this case, mainly for readability.</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">CutOffDate</code> variable subtracts<a id="calibre_link-994" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the correct number of months from <code class="code-in-text--packt">FirstDayInSelection</code>. It is easiest to take a simple example to understand this: when the first date in the <code class="code-in-text--packt">Calendar</code>'s selection is, say, September 1, <code class="code-in-text--packt">FirstDayInSelection</code> is September 30 and, with a duration of 6 months, the cut-off date is March 31. </p>
    <p class="book-title--packt">That means that for a sales order with a delivery date before that, there are 6 months (starting from April) in which invoices could have been sent, including September. Even when the last invoice is scheduled for September but is not yet sent, we can still&nbsp;compare the full sales order amount with the total invoice amount to get the correct open order amount.</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">SalesOrders</code> variable can now collect the <code class="code-in-text--packt">DocumentNr</code> values for the sales orders from before the cut-off date. With the list of <a id="calibre_link-1409" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales orders, the total sales order amount and actual invoice amount can now be calculated using <code class="code-in-text--packt">TREATAS</code> in the way we discussed earlier in this <a id="calibre_link-1174" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>chapter, using the <code class="code-in-text--packt">[DocumentNr]</code> column<a id="calibre_link-1042" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> for sales orders and <code class="code-in-text--packt">[OrderNr]</code> for invoices:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR InvoicedAmount =
        CALCULATE(
            SUM(fSales[Amount]),
            fSales[Type] = "Sales Invoice",
            ALL('Calendar'),
            TREATAS(SalesOrders, fSales[OrderNr])
        )
    VAR OrderedAmount =
        CALCULATE(
            SUM(fSales[Amount]),
            fSales[Type] = "Sales Order",
                ALL('Calendar'),
            TREATAS(SalesOrders, fSales[DocumentNr])
        )
    RETURN
    OrderedAmount &ndash; InvoicedAmount
)
</code></pre>
    <p class="book-title--packt">The key step in this calculation is to determine the correct list of sales orders. Is it possible to do this without iterating over the durations?</p>
    <p class="book-title--packt">As a matter of fact, it is. We will use the <code class="code-in-text--packt">[YearMthCtr]</code> column in the <code class="code-in-text--packt">Calendar</code> table for this, as it is a convenient counter we can add to and subtract from to move through the months. In the code snippet below, first the <code class="code-in-text--packt">FirstYearMthCtr</code> variable is evaluated as the <code class="code-in-text--packt">YearMthCtr</code> value corresponding to the <code class="code-in-text--packt">FirstDayOfSelection</code> date.</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">MonthsDurations</code> variable creates a list of <code class="code-in-text--packt">Duration</code>/<code class="code-in-text--packt">YearMthCtr</code> pairs that correspond to delivery dates before the cut-off date for the duration. This list is then used as a sophisticated <em class="italic">two-column </em>filter in the calculation of the <code class="code-in-text--packt">SalesOrders</code> variable:</p>
    <pre class="programlisting"><code class="hljs-code">VAR FirstYearMthCtr = 
    CALCULATE(
        MIN('Calendar'[YearMthCtr]),
        ALL('Calendar'),
        'Calendar'[Date] = FirstDayOfSelection
    )
VAR MonthsDurations =
    GENERATE(
        FILTER(
            DISTINCT(Ledger[Duration]),
            Ledger[Duration] &gt; 0
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        CALCULATETABLE(
        DISTINCT('Calendar'[YearMthCtr],
            'Calendar[YearMthCtr] &lt;= 
            FirstYearMthCtr &ndash; ThisDuration,
            ALL('Calendar')
            ) 
    )
VAR SalesOrders =
    CALCULATETABLE(
        DISTINCT(fSales[DocumentNr]),
        fSales[Type] = "Sales Order",
        MonthsDurations,
        ALL('Calendar'),
        USERELATIONSHIP(fSales[DeliveryDate], 'Calendar'[Date])
    )
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">MonthsDurations</code> variable <a id="calibre_link-1175" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>shows a<a id="calibre_link-1043" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> rare use of the <code class="code-in-text--packt">GENERATE</code> DAX function. <code class="code-in-text--packt">GENERATE</code> takes two arguments, both tables. The second argument is typically a table expression, which <a id="calibre_link-857" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is evaluated in row <a id="calibre_link-761" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>context for each row in the table in the first <a id="calibre_link-1425" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>argument. We store the <a id="calibre_link-437" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>duration in the <code class="code-in-text--packt">ThisDuration</code> variable and use <code class="code-in-text--packt">CALCULATETABLE</code> with a straightforward filter that implements the cut-off date.</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">SalesOrders</code> variable determines the list of <code class="code-in-text--packt">DocumentNr</code> values for sales orders that have an "old" delivery date <a id="calibre_link-995" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>relative to their duration. Note that we need to use <code class="code-in-text--packt">USERELATIONSHIP</code> here to filter on the delivery date, as the <code class="code-in-text--packt">MonthsDurations</code> filter is a filter on the <code class="code-in-text--packt">Calendar</code> table and the <code class="code-in-text--packt">Ledger</code> table. In our previous approach, we filtered on the <code class="code-in-text--packt">fSales</code> table directly (on the <code class="code-in-text--packt">DeliveryDate</code> column), so we didn't have to worry about the <code class="code-in-text--packt">Calendar</code> relationship.</p>
    <p class="book-title--packt">We show you this approach mainly to demonstrate that iterators or table aggregations can often be circumvented. In this particular case, the distinct number of durations is very small and you won't win much, if at all, by implementing the calculation <a id="calibre_link-1426" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>without the <code class="code-in-text--packt">SUMX</code>; with <a id="calibre_link-438" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>larger sets, <a id="calibre_link-762" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>however, it <a id="calibre_link-858" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can <a id="calibre_link-996" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>make a huge difference in performance, as we will see later in this chapter. </p>
    <p class="book-title--packt">To recapitulate, here <a id="calibre_link-1176" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is the complete DAX<a id="calibre_link-1044" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> formula for old sales orders: </p>
    <pre class="programlisting"><code class="hljs-code">Old sales orders =
VAR MinDate = MIN('Calendar'[Date])
VAR FirstDayOfSelection = MAX(MinDate, TODAY())
VAR FirstYearMthCtr = 
    CALCULATE(
        MIN('Calendar'[YearMthCtr]),
        ALL('Calendar'),
        'Calendar'[Date] = FirstDayOfSelection
    )
VAR MonthsDurations =
    GENERATE(
        FILTER(
            DISTINCT(Ledger[Duration]),
            Ledger[Duration] &gt; 0
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        CALCULATETABLE(
            DISTINCT('Calendar'[YearMthCtr],
            'Calendar[YearMthCtr] &lt;= 
                FirstYearMthCtr &ndash; ThisDuration,
            ALL('Calendar')
            ) 
)
VAR SalesOrders =
    CALCULATETABLE(
        DISTINCT(fSales[DocumentNr]),
        fSales[Type] = "Sales Order",
        MonthsDurations,
        ALL('Calendar'),
        USERELATIONSHIP(fSales[DeliveryDate], 'Calendar'[Date])
    )
VAR InvoicedAmount =
    CALCULATE(
        SUM(fSales[Amount]),
        fSales[Type] = "Sales Invoice",
        ALL('Calendar'),
        TREATAS(SalesOrders, fSales[OrderNr])
    )
VAR OrderedAmount =
    CALCULATE(
        SUM(fSales[Amount]),
        fSales[Type] = "Sales Order",
            ALL('Calendar'),
        TREATAS(SalesOrders, fSales[DocumentNr])
    )
RETURN
OrderedAmount &ndash; InvoicedAmount
</code></pre>
    <p class="book-title--packt">Note that this calculation is not particularly suited to be used in a monthly chart or a similar visual. For example, if you were to evaluate this measure for every month of the year 2045, you <a id="calibre_link-1177" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>would get the <a id="calibre_link-1410" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>amounts to <a id="calibre_link-1045" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>be invoiced for all old sales orders as of today, <em class="italic">in every month</em>. You could create a version of this calculation that only returns a result for the first day in context, but we will not cover that here. Instead, let's look at current sales orders.</p>
    <h3 id="calibre_link-202" class="calibre8">Dealing with current sales orders</h3>
    <p class="book-title--packt">We can now<a id="calibre_link-1165" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> focus on calculating <a id="calibre_link-548" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the amounts still to be invoiced on current sales orders. The logic for the expected flow of events is rather straightforward: take the total amount for a sales order, divide it by the duration in months, and you will get the monthly invoice amount. Count the number of months in the selected time period and you will have the amount that can be invoiced.</p>
    <p class="book-title--packt">We will go one step further and take the realities into account. A number of things can happen:</p>
    <ul class="calibre9">
      <li class="bullet">Not enough was invoiced before the selected time period</li>
      <li class="bullet">Invoices are sent exactly on schedule (or, just enough was invoiced)</li>
      <li class="bullet">Too much was invoiced before the selected time period</li>
    </ul>
    <p class="book-title--packt">The question is how to deal with these situations. This is definitely a business decision. Suppose we have a five-year support contract, and in the first year we invoiced twice the amount expected. Are we not going to send invoices in year two? Or do we continue invoicing until the fourth year, after which no further invoices will be sent? These are obviously not technical questions, but for now we'll just pick one option and say that when too much has been invoiced, we compensate for that in calculating expected future sales. In other words, the amount that was invoiced too much is subtracted from the scheduled invoice amount.</p>
    <p class="book-title--packt">A similar question arises in the <a id="calibre_link-439" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>case of sales orders that are behind their invoice schedule. In that situation, let's say we assume normal invoicing will continue without catching up the backlog. Only at the end of the duration of a sales order is the remaining amount invoiced. In doing this, we take the cautious stance in both cases and we avoid being too optimistic as much as possible.</p>
    <p class="book-title--packt">When <a id="calibre_link-549" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>designing<a id="calibre_link-1166" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the DAX formula for this calculation, we have to consider the query context and determine the logical steps to take. The most relevant part of the query context is, of course, the selected time period. This can be anything, but as with the old sales orders calculation, we need to consider only the future. Again, we will work on the basis of months to <a id="calibre_link-950" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>align with the monthly invoicing cadence. This means that we need to construct a list of months to work with. The next steps are:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">Determine the list of relevant sales orders.</li>
      <li class="calibre12">For each sales order, check whether too much has already been invoiced.</li>
      <li class="calibre12">If so, subtract the amount that has been invoiced too much from the scheduled amount to be invoiced.</li>
      <li class="calibre12">If not, calculate the amount that can be invoiced (either the monthly invoice amount multiplied by the number of months in our list, or the remaining open order amount; depending on whether the duration of the sales order ends during the time period).</li>
    </ol>

<p class="book-title--packt">To create the month list, we use a straightforward <code class="code-in-text--packt">CALCULATETABLE</code> calculation:</p>
        <pre class="programlisting"><code class="hljs-code">Current Sales Orders =
VAR MonthList =
    CALCULATETABLE(
        DISTINCT('Calendar'[MonthYearCtr]),
        KEEPFILTERS('Calendar'[Date] &gt;= TODAY())
    )
</code></pre>
        <p class="book-title--packt">To determine what the relevant sales orders are, the easiest thing to do is to reuse the logic we already developed: current sales orders are all those that are not old. Note that we have an easier way to find <code class="code-in-text--packt">FirstYearMthCtr</code> now that we already have <code class="code-in-text--packt">MonthList</code>.</p>
        <p class="book-title--packt">There is one important thing to consider, however, and that<a id="calibre_link-859" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is the possibility that our selected time period is <a id="calibre_link-763" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>completely in the past. In this case, <code class="code-in-text--packt">MonthList</code> will be empty and <code class="code-in-text--packt">FirstYearMthCtr</code>, as <a id="calibre_link-440" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>derived below, will be blank. We want the <code class="code-in-text--packt">MonthsDurations</code> table to be empty as well and we will do this by adding a test for the <code class="code-in-text--packt">FirstYearMontNr</code> value in the<a id="calibre_link-1167" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> definition<a id="calibre_link-550" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of <code class="code-in-text--packt">MonthsDurations</code>:</p>
        <pre class="programlisting"><code class="hljs-code">VAR FirstYearMthCtr = 
    MINX(
        MonthList,
        'Calendar'[MonthYearCtr]
    )
VAR LastYearMthCtr =
    MAXX(
        MonthList,
        'Calendar'[MonthYearCtr]
    )
VAR MonthsDurations =
    GENERATE(
        FILTER(
                DISTINCT(Ledger[Duration]),
                Ledger[Duration] &gt; 0
                &amp;&amp; NOT(ISBLANK(FirstYearMthCtr))
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        CALCULATETABLE(
            DISTINCT('Calendar'[YearMthCtr]),
            'Calendar'[YearMthCtr] &gt; FirstYearMthCtr - ThisDuration
            &amp;&amp; 'Calendar'[YearMthCtr] &lt;= LastYearMthCtr,
            ALL('Calendar')
            )
)
VAR SalesOrders =
    CALCULATETABLE(
        DISTINCT(fSales[DocumentNr]),
        fSales[Type] = "Sales Order",
        MonthsDurations,
        ALL('Calendar'),
        USERELATIONSHIP(fSales[DeliveryDate], 'Calendar'[Date])
    )
</code></pre>
        <p class="book-title--packt">With the set of current sales orders in the <code class="code-in-text--packt">SalesOrders</code> variable, we have established <em class="italic">step 1</em> in the <a id="calibre_link-1168" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation's flow. We<a id="calibre_link-551" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> can now continue with the other steps of the calculation:</p>
        <pre class="programlisting"><code class="hljs-code">SUMX(
    SalesOrders,
    VAR ThisSalesOrderNr = fSales[DocumentNr]
    VAR InvoicedAmount =
        CALCULATE(
            SUM(fSales[Amount]),
            fSales[Type] = "Sales Invoice",
            ALL('Calendar'),
            fSales[OrderNr] = ThisSalesOrderNr,
            ALL(fSales[DocumentNr])
        )
    VAR SalesOrderAmount =
        CALCULATE(
            SUM(fSales[Amount]),
            ALL('Calendar')
        )
</code></pre>
        <p class="book-title--packt">The <code class="code-in-text--packt">InvoicedAmount</code> variable is quite <a id="calibre_link-1427" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>straightforward: calculate the total invoice amount for the current <a id="calibre_link-441" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales order. The only caveat here is that we're in a row context on a list of <code class="code-in-text--packt">DocumentNr</code> values, and <code class="code-in-text--packt">CALCULATE</code> causes a filter on this column. We want the <code class="code-in-text--packt">OrderNr</code> to be the current value, but setting this does not automatically erase the filter on <code class="code-in-text--packt">DocumentNr</code>, hence the <code class="code-in-text--packt">ALL(fSales[DocumentNr])</code>. The formula for the sales order amount is easier because we are already looking at the correct <code class="code-in-text--packt">DocumentNr</code> and know that it is a sales order.</p>
        <p class="book-title--packt">We must now calculate the amount that should have been invoiced until today. This is equal to the total sales order amount, divided by the duration in months, multiplied by the <a id="calibre_link-997" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>number of months between the initial delivery date of the sales order and today. Let's start off by defining variables for the duration and the monthly invoice amount:</p>
        <pre class="programlisting"><code class="hljs-code">    VAR ThisDuration = 
        CALCULATE(
            MIN(Ledger[Duration]),
            CROSSFILTER(
                fSales[Ledger], Ledger[LedgerCode], Both
            ),
            ALL('Calendar')
        )
    VAR InvoicePerMonth = DIVIDE(SalesOrderAmount, ThisDuration)
</code></pre>
        <p class="book-title--packt">The <code class="code-in-text--packt">ThisDuration</code> calculation looks overly complicated: all we want is the related <code class="code-in-text--packt">Duration</code> value for this sales order. However, remember that we are not looking at a single row in <code class="code-in-text--packt">fSales</code>, but at a single row in the list of <code class="code-in-text--packt">DocumentNr</code> values; and one value may <a id="calibre_link-552" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>correspond <a id="calibre_link-1169" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to multiple lines in <code class="code-in-text--packt">fSales</code>. So, although we are in a row context here, we cannot use the <code class="code-in-text--packt">RELATED</code> function as you may expect. Instead, we let the <code class="code-in-text--packt">fSales</code>-<code class="code-in-text--packt">Ledger</code> relationship filter from <code class="code-in-text--packt">fSales</code> to <code class="code-in-text--packt">Ledger</code> using the <code class="code-in-text--packt">CROSSFILTER</code> function. We must use an aggregation here, although we will only find one <code class="code-in-text--packt">Duration</code> value, so it doesn't really matter which <a id="calibre_link-363" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>aggregation we choose: <code class="code-in-text--packt">MIN</code>, <code class="code-in-text--packt">MAX</code>, or even <code class="code-in-text--packt">AVERAGE</code> or <code class="code-in-text--packt">SUM</code> would work &ndash; <code class="code-in-text--packt">AVERAGE</code> and <code class="code-in-text--packt">SUM</code> would be very confusing though! Note also that existing filters on <code class="code-in-text--packt">Calendar</code> are still there, while we are looking at a sales order from the past. So again, we need to remove these filters with <code class="code-in-text--packt">ALL</code> (and you will see the same thing over and over again below).</p>
        <p class="book-title--packt">To calculate the number of months from the delivery date until today, we have to first find the delivery date and then count the number of months. With these, we can calculate the scheduled invoice amount:</p>
        <pre class="programlisting"><code class="hljs-code">    VAR ThisDeliveryDate =
        CALCULATE(
            MIN(fSales[DeliveryDate]),
            ALL('Calendar')
        )
    VAR ThisDeliveryDateCtr =
        CALCULATE(
            MIN('Calendar'[YearMthCtr]),
            'Calendar'[Date] = ThisDeliveryDate,
            ALL('Calendar')
        )
    VAR NumberOfMonths =
        CALCULATE(
            DISTINCTCOUNT('Calendar'[YearMthCtr]),
            'Calendar'[Date] &gt;= ThisDeliveryDate,
            'Calendar'[Date] &lt; TODAY(),
            ALL('Calendar')
        )
VAR ScheduledInvoiceAmount = InvoicePerMonth * NumberOfMonths
</code></pre>
        <p class="book-title--packt">In calculating <code class="code-in-text--packt">ThisDeliveryDate</code>, again we must use an aggregation while knowing that we will find only one value. <code class="code-in-text--packt">CALCULATE</code> turns the row context into a filter context, causing <code class="code-in-text--packt">fSales</code> to be filtered down to only rows with the current <code class="code-in-text--packt">DocumentNr</code> value.</p>
        <p class="book-title--packt">As the calculation is month-based, we also calculate the <code class="code-in-text--packt">YearMthCtr</code> value of the delivery date and use that for <a id="calibre_link-1715" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculating the number of months passed since then until the first month of the <code class="code-in-text--packt">Calendar</code> context. Note that this defines the logic we assume on the <a id="calibre_link-553" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>invoice <a id="calibre_link-696" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>schedule: the first invoice is assumed to be sent in the month of the delivery date and, after that, one invoice is sent each month. <code class="code-in-text--packt">ScheduledInvoiceAmount</code> thus is the invoice amount we expect to have been invoiced <em class="italic">before</em> our selected time period.</p>
        <p class="book-title--packt">We now have done all preparations to compute the amount that can be invoiced in the selected time period. First, let's determine the invoice surplus, or the amount that is invoiced on top of what should have been invoiced. This is <em class="italic">step 2</em> in the calculation flow.</p>
        <pre class="programlisting"><code class="hljs-code">    VAR InvoiceSurplus = 
       MAX(InvoicedAmount &ndash; ScheduledInvoiceAmount, 0)
</code></pre>
        <p class="book-title--packt">If the actual amount invoiced is <em class="italic">less</em> than scheduled, we set the surplus to zero. The next thing to do is to compute the scheduled invoice amount during our selected time period. This is <a id="calibre_link-998" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>either the monthly invoice continued, or the remainder of the sales order amount (when the duration ends during our time period). In the former case, we need to subtract the invoice surplus from this (<em class="italic">step 3</em> in the calculation flow) and may find that there is nothing to invoice anymore. In the latter case, we do not have to deal with the invoice surplus, as we have assumed that no more is invoiced than the sales order amount.</p>
        <p class="book-title--packt">Note that <em class="italic">step 4</em> of our flow is implemented through this as well: when the amount invoiced is not too much, the invoice surplus is zero; and when the duration of the sales order ends, we invoice the remaining amount and catch up with any late invoicing. </p>
        <p class="book-title--packt">How do we determine whether the duration ends during the time period? Well, our <code class="code-in-text--packt">YearMthCtr</code> counter comes in handy here. We can compute the last month of scheduled invoicing by starting with the <a id="calibre_link-488" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>delivery date counter (that we already have), adding the duration in months, and <a id="calibre_link-514" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>subtracting 1. If this last month is in our selection, the invoice schedule of the sales order ends here. The <code class="code-in-text--packt">CONTAINS</code> function is perfect to check this:</p>
        <pre class="programlisting"><code class="hljs-code">    CONTAINS(
        MonthList,
        'Calendar'[YearMthCtr],
        ThisDeliveryDateCtr + ThisDuration &ndash; 1
    )
</code></pre>
        <p class="book-title--packt">When this is false, we need to determine the number of months for which the monthly invoice schedule will<a id="calibre_link-554" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> continue. Typically, this is the number of rows in <code class="code-in-text--packt">MonthList</code>; however, we <a id="calibre_link-1170" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>may be looking at a <a id="calibre_link-764" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales order with a delivery date in our selected time period, and we don't want to count months before that date. So, we need to filter <code class="code-in-text--packt">MonthList</code>. The total formula for the expected invoice amount then becomes:</p>
        <pre class="programlisting"><code class="hljs-code">    VAR Toinvoice =
        IF(
            CONTAINS(
                MonthList,
                'Calendar'[YearMthCtr],
                ThisDeliveryDateCtr + ThisDuration &ndash; 1
            ),
            SalesOrderAmount &ndash; InvoicedAmount,
            MAX(
                COUNTROWS(
                    FILTER(
                        MonthList,
                            'Calendar'[YearMthCtr] &gt;=
                            ThisDeliveryDateCtr
                    )
                ) * InvoicePerMonth
                - InvoiceSurplus,
                0
            )
        )
    RETURN
    ToInvoice
)
</code></pre>
        <p class="book-title--packt">And that's it: for every current sales order, we now calculate the expected invoice amount in <a id="calibre_link-1171" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the selected time<a id="calibre_link-555" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> period.</p>
        <h3 id="calibre_link-203" class="calibre8">Optimizing the current sales order calculation</h3>
        <p class="book-title--packt">There is one <a id="calibre_link-1162" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>issue with the <a id="calibre_link-545" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>current sales order calculation: after determining which sales orders are current, we iterate over these sales orders individually. The number of sales orders can be quite high (we are iterating over a high-cardinality column in a fact table) and we do a lot of work for each sales order. This constitutes a potential performance problem.</p>
        <p class="book-title--packt">Now that we've thoroughly worked through the logic required for the calculation by sales order, it would be good to explore whether we can achieve the same results with a lower number of iterations (or ideally, no iterations at all). To get a good overview of our logic, let's write the calculation in pseudocode:</p>
        <pre class="programlisting"><code class="hljs-code">Current Sales Orders =
VAR SalesOrders = &lt;determine current sales orders&gt;
SUMX(SalesOrders,
    Calculate:
        actual invoiced amount
        sales order amount
        scheduled invoice amount
        invoice surplus ( = actual &ndash; scheduled invoice)
        invoice amount in selected time period:
            either relevant number of months 
                * monthly invoice, 
                and if surplus &gt; 0, subtract it
                but keep it at &gt;= 0
            or remaining amount on sales order
)
</code></pre>
        <p class="book-title--packt">Now, ask yourself: which steps in this calculation need to be calculated by individual sales order?</p>
        <ul class="calibre9">
          <li class="bullet"><code class="code-in-text--packt">Actual invoiced amount</code> and <code class="code-in-text--packt">sales order amount</code> can easily be computed for all sales orders together.</li>
          <li class="bullet"><code class="code-in-text--packt">Scheduled invoice amount</code> depends on the number of months passed for the sales order, which is derived from the delivery date and the duration. It could therefore be calculated by a delivery month/duration combination.</li>
          <li class="bullet"><code class="code-in-text--packt">Invoice surplus</code> is derived from actual and scheduled, and can therefore also be calculated by a delivery month/duration combination.</li>
          <li class="bullet"><code class="code-in-text--packt">Invoice amount in selected time period</code>: We have two situations here: <ul class="calibre11">
              <li class="bullet">The first one, <code class="code-in-text--packt">relevant</code> <code class="code-in-text--packt">number of months * monthly invoice</code>, can be calculated by duration: the monthly invoice amount is the sales order amount divided by the duration. Which sales orders this should be computed for can be derived from the delivery date and duration: this situation applies to all sales orders for which the invoice schedule does not end within the selected time period. We can conclude that this can be calculated at once for all sales orders that satisfy the delivery date/duration criteria.</li>
              <li class="bullet">The second <a id="calibre_link-546" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>situation, <code class="code-in-text--packt">remaining amount on sales order</code>, again depends <a id="calibre_link-1163" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on delivery date and duration: it can be derived from the number of months in the sales order's invoice schedule that fall within the selected time period. Once again, the delivery month/duration combination appears to be the appropriate granularity.</li>
            </ul>
          </li>
        </ul>
      
    <p class="book-title--packt">The observations above strongly suggest that we can iterate over delivery month/duration combinations. The happy coincidence is that we already have these combinations: remember that we created a <code class="code-in-text--packt">MonthsDurations</code> variable to determine the set of current sales orders! Remember what this variable contains: it is a list of each duration, in combination with the possible months in which sales orders can be (first) delivered and still be current within the period selected in the query context.</p>
    <p class="book-title--packt">The pseudocode version of the DAX formula now becomes:</p>
    <pre class="programlisting"><code class="hljs-code">Current Sales Orders =
VAR MonthDurations = 
    &lt;all relevant delivery month/duration combinations&gt;
SUMX(MonthDurations,
    Calculate for the sales orders for this month/duration:
        total actual invoiced amount
        total sales order amount
        total scheduled invoice amount
        total invoice surplus ( = actual &ndash; scheduled invoice)
        invoice amount in selected time period:
            either relevant number of months 
                * monthly invoice, 
                and if surplus &gt; 0, subtract it
                but keep it at &gt;= 0
            or total remaining sales order amount
)
</code></pre>
    <p class="book-title--packt">The devil is in the detail, though, and we have some final steps to go. We need to specifically focus on the <code class="code-in-text--packt">Invoice amount in selected time period</code> part, which contains<a id="calibre_link-1164" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> two <a id="calibre_link-547" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>clauses: <code class="code-in-text--packt">relevant number of months * monthly invoice</code>, and <code class="code-in-text--packt">remaining amount on sales order</code>. The former needs to deal with invoice surplus, which we will deal with in the next section.</p>
    <h4 class="title1">Dealing with invoice surplus</h4>
    <p class="book-title--packt">In the calculation <a id="calibre_link-537" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>by individual sales order, we subtract the invoice surplus, when it is larger than zero, from the full scheduled amount (the number of months multiplied by the monthly invoice); but do not let the end result fall below zero. Now, we calculate by individual month/duration combination; this means we work with the total scheduled amount for all sales orders for this combination, and with the total invoice surplus for the same sales orders.</p>
    <p class="book-title--packt">This is all fine when the individual surplus for each sales order is larger than zero. But it may also occur that the surplus for one sales order is negative, say -500, but the surplus for another sales order is positive and larger, say 700. In this case, the total surplus is 200 and we would subtract this from the scheduled amount; in reality, however, we should subtract 700! We are in serious trouble here, as to do a correct calculation, we would need to go over each sales order individually, which is the very thing we are trying to get away from.</p>
    <p class="book-title--packt">The best we can do is to select the sales orders with a positive invoice surplus as efficiently as possible. This is a good case for having a calculated column, as we can directly filter on values in that column. The only restriction here is that the calculation for creating the column should not be dependent on the query context for&nbsp;the DAX measure; after all, a calculated column contains static data.</p>
    <p class="book-title--packt">As the <code class="code-in-text--packt">Current Sales Orders</code> measure is only calculated for future periods of time, we can compute the current invoice surplus for each sales order: the surplus as of today. </p>
    <p class="book-title--packt">However, as our query context may select a future time period, we need to be able to relate today's surplus to the remaining surplus at the start of the selected time period. We can solve this by expressing the invoice surplus in<em class="italic"> number of monthly invoices</em>. We will discuss the formula to create this column below, but let us first look at the logic to implement in the<a id="calibre_link-538" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> measure (with a numeric example):</p>
    <ol class="calibre9">
      <li class="calibre12">Determine today's date (say, January 15, 2022).</li>
      <li class="calibre12">Determine the number of months in context (say, 5).</li>
      <li class="calibre12">Determine the first month in context, and how many months this is away from a) (say, July 2022, and 6). This is how many monthly invoicing occurrences could have been used to compensate for a surplus.</li>
      <li class="calibre12">Select sales orders with a surplus (in monthly invoices) larger than c) (for example, order 1: 12 months, order 2: 10.5 months).</li>
      <li class="calibre12">Subtract c) from d) (order 1: 6, order 2: 4.5). This is the surplus still to compensate for at the start of the selection (July 2022).</li>
      <li class="calibre12">Take the minimum of b) and e) (order 1: 5, order 2: 4.5). This is what can be corrected during the selection.</li>
      <li class="calibre12">To calculate the correction, multiply f) by each sales order's monthly invoice amount.</li>
    </ol>
    <p class="book-title--packt">The figure below shows this logic:</p>
    <figure class="mediaobject"><img src="images/000203.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.14: Determining the invoice surplus</p>
    <p class="book-title--packt">The formula <a id="calibre_link-539" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for the calculated column is this:</p>
    <pre class="programlisting"><code class="hljs-code">Current invoice surplus = 
VAR ThisOrder = [DocumentNr]
VAR ThisDuration = RELATED(Ledger[Duration])
VAR ThisProduct = [ProductNr]
VAR ThisDeliveryDate = [DeliveryDate]
VAR Invoiced =
    CALCULATE(
        SUM(fSales[Amount]),
        fSales[Type] = "Sales Invoice",
        fSales[OrderNr] = ThisOrder,
        fSales[ProductNr] = ThisProduct,
        ALL(fSales)
    )
VAR DeliveryYearMthCtr = 
    CALCULATE(
        MIN('Calendar'[YearMthCtr]),
        'Calendar'[Date] = ThisDeliveryDate
    )
VAR TodayYearMthCtr = 
    CALCULATE(
        MIN('Calendar'[YearMthCtr]),
        'Calendar'[Date] = TODAY()
    )
VAR MonthlyInvoice = DIVIDE([Amount], ThisDuration)
VAR InvoicedSchedule = 
     (TodayYearMthCtr &ndash; DeliveryYearMthCtr) * MonthlyInvoice
RETURN
DIVIDE(
    Invoiced &ndash; InvoicedSchedule,
    MonthlyInvoice
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">Invoiced</code> variable <a id="calibre_link-1716" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculates the total amount invoiced for the current (sales order) document. Other relevant <a id="calibre_link-999" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>filters, in this case <code class="code-in-text--packt">ProductNr</code>, should be taken into account for a correct result. The <code class="code-in-text--packt">InvoicedSchedule</code> variable calculates the scheduled invoice amount, based on the starting month (from delivery date), current month (from today), and the monthly invoice amount (from total sales order amount and duration). Finally, the difference between the <code class="code-in-text--packt">Invoiced</code> and <code class="code-in-text--packt">InvoicedSchedule</code> amounts is divided by the <code class="code-in-text--packt">MonthlyInvoice</code> amount to express it in months.</p>
    <p class="book-title--packt">Note that this formula is evaluated for every row in the <code class="code-in-text--packt">fSales</code> table, including invoice lines and one-off sales orders. As we will only use results for long-term sales orders, the results for other rows don't really matter.</p>
    <p class="book-title--packt">When you look at steps a) to g) above, you can see that the duration and delivery month of the sales orders <a id="calibre_link-1000" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>involved do not play any role, except for computing the monthly invoice amount in the <a id="calibre_link-442" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>last step. This <a id="calibre_link-515" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>means that we can take the invoice surplus logic out of the <a id="calibre_link-951" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>main <code class="code-in-text--packt">MonthDurations</code> iteration, and even put it in a separate measure.</p>
    <p class="book-title--packt">The DAX measure for surplus correction is:</p>
    <pre class="programlisting"><code class="hljs-code">Surplus Correction =
VAR MonthList =
    CALCULATETABLE(
        DISTINCT('Calendar'[YearMthCtr]),
        KEEPFILTERS('Calendar'[Date] &gt;= TODAY())
    )
VAR MonthsInContext = COUNTROWS(MonthList)
VAR FirstYearMthCtr = 
    MINX(
        MonthList,
        'Calendar'[YearMthCtr]
    )
VAR TodayYearMthCtr =
    CALCULATE(
        MIN('Calendar'[YearMthCtr]),
        ALL('Calendar'),
        'Calendar'[Date] = TODAY()
    )
VAR MonthsGap = FirstYearMthCtr - TodayYearMthCtr
VAR SalesOrders =
    CALCULATETABLE(
        fSales,
        fSales[Type] = "Sales Order",
        fSales[Current Invoice Surplus] &gt; MonthsGap,
        Ledger[Duration] &gt; 0 &amp;&amp; MonthsInContext &gt; 0,
        ALL('Calendar')
    )
</code></pre>
    <p class="book-title--packt">We start by setting<a id="calibre_link-540" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> up our basic variables for steps a), b), and c). The <code class="code-in-text--packt">SalesOrders</code> variable implements step d), using the calculated <code class="code-in-text--packt">Current invoice surplus</code> column. Note that filters from the <code class="code-in-text--packt">Calendar</code> table need to be removed here as the <code class="code-in-text--packt">fSales</code> table is related to the <code class="code-in-text--packt">Calendar</code> table on the <code class="code-in-text--packt">Date</code> column.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The filter argument <code class="code-in-text--packt">Ledger[Duration] &gt; 0 &amp;&amp; MonthsInContext &gt; 0</code> needs some clarification. For query contexts in the past, the <code class="code-in-text--packt">MonthList</code> variable is an empty table, and <code class="code-in-text--packt">FirstYearMthCtr</code> is blank. That means the <code class="code-in-text--packt">MonthsGap</code> variable equals the value of <code class="code-in-text--packt">TodayYearMthCtr</code>. Although exceptional, this could mean that in <code class="code-in-text--packt">SalesOrders</code>, sales orders <a id="calibre_link-443" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are selected that have a large current <a id="calibre_link-1001" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>invoice surplus, when what we really want is not to select any sales order at all. </p>
      <p class="book-title--packt">In other words, we want to do something like <code class="code-in-text--packt">IF(MonthsInContext &gt; 0, CALCULATETABLE(...</code> . However, when <code class="code-in-text--packt">MonthsInContext</code> equals zero, this will return a blank value when we really need an empty table for the <code class="code-in-text--packt">SUMX</code> iterator to function later on. The <code class="code-in-text--packt">MonthsInContext &gt; 0</code> clause cannot be used as a separate filter argument in <code class="code-in-text--packt">CALCULATETABLE</code> as it does not refer to any column; instead, we add the clause to another filter argument. This filter argument checks, for each <code class="code-in-text--packt">Duration</code> value, whether the value is larger than zero <em class="italic">and</em> whether <code class="code-in-text--packt">MonthsInContext</code> is larger than zero.</p>
    </div>
    <p class="book-title--packt">The remaining steps are done for each sales order in this list:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SUMX(
    SalesOrders,
    VAR MonthsToCompensate = 
        fSales[Current invoice surplus] &ndash; MonthsGap
    VAR CompensationMonths = 
        MIN(MonthsToCompensate, MonthsInContext)
    RETURN
    CompensationMonths         * DIVIDE(fSales[Amount], RELATED(Ledger[Duration]))
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">MonthsToCompensate</code> variable computes how many months of monthly invoices must still be compensated at the start of the selected period (step e)). The <code class="code-in-text--packt">CompensationMonths</code> variable calculates how many months can be compensated during this time (step f)). The final result multiplies this number by the monthly invoice amount.</p>
    <p class="book-title--packt">With the <code class="code-in-text--packt">Surplus Correction</code> measure, we have a calculation for the amount that needs to be subtracted from the "normal" monthly invoicing. In the next section, we will look at how to calculate the normal invoice amount. After that, we will deal with another scenario: sales orders that are behind invoicing schedule and need a correction at the end of <a id="calibre_link-541" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>their duration. As these are easy to detect with the calculated column we created (these sales orders have a negative <code class="code-in-text--packt">Current invoice surplus</code> value), they can be taken out of the main calculation flow to eliminate any conditional logic.</p>
    <h4 class="title1">Dealing with sales orders on schedule</h4>
    <p class="book-title--packt">In the pseudocode <a id="calibre_link-542" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for the <code class="code-in-text--packt">Current Sales Orders</code> measure, we no longer need to worry about surplus now that we have a separate <a id="calibre_link-444" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>measure for the surplus compensation. That <a id="calibre_link-952" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>means that we need a <a id="calibre_link-765" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>measure that<a id="calibre_link-860" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> just returns the scheduled invoice amounts for the selected period of time in the query context. Let's start again by setting up some variables:</p>
    <pre class="programlisting"><code class="hljs-code">Sales Orders on schedule =
VAR MonthList =
    CALCULATETABLE(
        DISTINCT('Calendar'[YearMthCtr]),
        KEEPFILTERS('Calendar'[Date] &gt;= TODAY())
    )
VAR FirstYearMthCtr =
    MINX(
        MonthList,
        'Calendar'[YearMthCtr]
    )
VAR LastYearMthCtr =
    MAXX(
        MonthList,
        'Calendar'[YearMthCtr]
    )
VAR MonthsDurations =
    GENERATE(
        FILTER(
            DISTINCT(Ledger[Duration]),
            Ledger[Duration] &gt; 0
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        FILTER(
            ALL('Calendar'[YearMthCtr]),
            'Calendar'[YearMthCtr] + Duration - 1 
                &gt;= FirstYearMthCtr
            &amp;&amp; 'Calendar'[YearMthCtr] &lt;= LastYearMthCtr
        )
    )
</code></pre>
    <p class="book-title--packt">We first <a id="calibre_link-543" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>determine the list of <code class="code-in-text--packt">YearMthCtr</code> values, as well as the first and last value. After that, the <code class="code-in-text--packt">MonthsDurations</code> variable sets up a list of durations with the possible delivery months that a sales order can have, while still having a part of its duration within the selected time period. This means that the last month of the schedule must be the first <code class="code-in-text--packt">YearMthCtr</code> value or later (note that the invoice schedule of a sales order starts in the delivery month, therefore the <a id="calibre_link-516" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>last month of the schedule is the delivery month plus the duration minus 1), and the delivery month must not be after the selected time period to avoid including future sales orders.</p>
    <p class="book-title--packt">Each month/duration combination <a id="calibre_link-298" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>now corresponds to a <a id="calibre_link-766" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>number of months in the invoice schedule that fall within our <a id="calibre_link-1428" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selected time period. This makes it fairly easy to compute the amount to invoice. The DAX formula continues:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SUMX(
    MonthsDurations,
    VAR ThisDuration = Ledger[Duration]
    VAR ThisDeliveryMonth = 'Calendar'[YearMthCtr]
    VAR NumberOfMonths =
        COUNTROWS(
            FILTER(
                MonthList,
                'Calendar'[YearMthCtr] &gt;= ThisDeliveryMonth
                &amp;&amp; 'Calendar'[YearMthCtr] &lt;= 
                    ThisDeliveryMonth + ThisDuration &ndash; 1
                )
        )
    VAR SalesOrderAmount =
        CALCULATE(
            SUM(fSales[Amount],
            fSales[Type] = "Sales Order",
            ALLEXCEPT('Calendar', 'Calendar'[YearMthCtr]),
            USERELATIONSHIP(
                fSales[DeliveryDate], 
                'Calendar'[Date]
            )
        )
    VAR MonthlyInvoiceAmount = 
        DIVIDE(SalesOrderAmount, ThisDuration)
    RETURN
    MonthlyInvoiceAmount * NumberOfMonths
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">NumberOfMonths</code> variable determines the correct number of months by filtering the <code class="code-in-text--packt">MonthList</code>: we only want to include months that are the delivery month or later, and which are the last month of the invoice schedule at the latest. The <code class="code-in-text--packt">SalesOrderAmount</code> variable calculates the total amount of all sales orders that correspond to the current <a id="calibre_link-861" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>duration and delivery <a id="calibre_link-544" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>month. Likewise, <code class="code-in-text--packt">MonthlyInvoiceAmount</code> is the total monthly invoice amount for all these sales orders. Note that we use <code class="code-in-text--packt">ALLEXCEPT</code> to remove all <a id="calibre_link-299" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>existing filters on the <code class="code-in-text--packt">Calendar</code> table, except for the filter on the <code class="code-in-text--packt">YearMthCtr</code> column that comes <a id="calibre_link-767" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from the current row in <code class="code-in-text--packt">MonthsDurations</code>.</p>
    <h4 class="title1">Corrections for sales orders behind schedule</h4>
    <p class="book-title--packt">The only <a id="calibre_link-534" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>thing remaining is that we need to add an amount at the end of the duration for every sales order that is behind schedule. Two things will help to create an efficient calculation:</p>
    <ul class="calibre9">
      <li class="bullet">These sales <a id="calibre_link-953" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>orders are easy to detect, as they have a negative value in the <code class="code-in-text--packt">Current invoice surplus</code> column.</li>
      <li class="bullet">The correction is applied in the last <a id="calibre_link-445" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>month of the sales order's schedule, which means that we can work with a very specific (and small) set of month/duration combinations.</li>
    </ul>
    <p class="book-title--packt">Let us start by <a id="calibre_link-1717" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>setting up the relevant list of month/duration combinations:</p>
    <pre class="programlisting"><code class="hljs-code">End Correction =
VAR MonthList =
    CALCULATETABLE(
        DISTINCT('Calendar'[YearMthCtr]),
        KEEPFILTERS('Calendar'[Date] &gt;= TODAY())
    )
VAR MonthsDurationsEnd =
    GENERATE(
        FILTER(
            Ledger[Duration] &gt; 0
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        FILTER(
            ALL('Calendar'[YearMthCtr]),
            'Calendar'[YearMthCtr] + ThisDuration - 1 
                IN MonthList
        )
    )
</code></pre>
    <p class="book-title--packt">Again, we take that part of the query context that is in the future. The <code class="code-in-text--packt">GENERATE</code> function creates, for every duration <a id="calibre_link-768" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>larger than zero, the list of <code class="code-in-text--packt">YearMthCtr</code> values that a sales order can have as its delivery date, <a id="calibre_link-300" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>while ending in the selected period in the <code class="code-in-text--packt">MonthList</code> variable. In <a id="calibre_link-862" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>other words, the <a id="calibre_link-1429" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>last month of the invoice schedule must be one of the months in the selected period. We can use a simple <code class="code-in-text--packt">IN</code> operator here, as <code class="code-in-text--packt">MonthList</code> is a table with only one column.</p>
    <p class="book-title--packt">The calculation continues with an iteration over the <code class="code-in-text--packt">MonthsDurationsEnd</code> rows:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SUMX(
    MonthsDurationsEnd,
    VAR ThisDuration = Ledger[Duration]
    VAR SalesOrderAmount =
        CALCULATE(
            SUMX(
                fSales, 
                fSales[Amount] * fSales[Current invoice surplus]
            ),
            fSales[Type] = "Sales Order",
            ALLEXCEPT('Calendar', 'Calendar'[YearMthCtr]),
            USERELATIONSHIP(
                  fSales[DeliveryDate], 'Calendar'[Date]
            ),
            fSales[Current invoice surplus] &lt; 0
        )
    RETURN
    -1 * DIVIDE(SalesOrderAmount, ThisDuration)
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">SalesOrderAmount</code> variable<a id="calibre_link-535" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> selects each sales order that corresponds to the current duration and delivery month and that has a negative <code class="code-in-text--packt">Current invoice surplus</code> value. For these sales orders, we calculate the sales order amount multiplied by the current invoice surplus. This may seem strange, but remember that we need to calculate the end-of-schedule correction; <code class="code-in-text--packt">Current invoice surplus</code> is the surplus in the number of monthly invoice amounts. To compute the correction required, we must multiply this number by the monthly invoice amount, which is the sales order amount divided by the duration. </p>
    <p class="book-title--packt">As the duration is the same for all sales orders selected here (we are in an iteration over <code class="code-in-text--packt">MonthsDurationsEnd</code>, after all), we can decide to multiply by the sales order amount first and divide the total by the duration later. And this is what happens after the <code class="code-in-text--packt">RETURN</code>.</p>
    <p class="book-title--packt">With the <code class="code-in-text--packt">Surplus Correction</code>, <code class="code-in-text--packt">Sales Orders on Schedule</code>, and <code class="code-in-text--packt">End Correction </code>measures, we now have everything in place to calculate the correct amounts to be invoiced. The picture below shows example output for a small set of sales orders. In this example, <code class="code-in-text--packt">TODAY()</code> is a date in October, 2021. Note that by definition, for a single sales order the <code class="code-in-text--packt">Surplus Correction</code> and <code class="code-in-text--packt">End Correction</code> measures cannot both return a result; after all, we use mutually exclusive filters on the <code class="code-in-text--packt">Current invoice surplus</code> column for these calculations.</p>
    <figure class="mediaobject"><img src="images/000077.png" alt="Chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.15: Output for some sample sales orders</p>
    <p class="book-title--packt">Different cases <a id="calibre_link-536" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>are visible in the chart:</p>
    <ul class="calibre9">
      <li class="bullet">Sales order 99500 has a current invoice surplus of 8 months, which means that the monthly invoice is corrected for 8 months, after which the normal invoicing can continue until the end of the schedule in July, 2022.</li>
      <li class="bullet">Sales order 99501 is on schedule, and invoicing will continue until May, 2022.</li>
      <li class="bullet">Sales order 99502 has a 3-month invoice surplus.</li>
      <li class="bullet">Sales order 99503 is behind schedule, and this can be corrected in December, 2021, which is the last month of this sales order's schedule.</li>
      <li class="bullet">Sales order 99504 has a surplus of <a id="calibre_link-1298" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>about 1.5 months.</li>
    </ul>
    <p class="book-title--packt">The all-up future invoice measure is a simple combination of the three measures:</p>
    <pre class="programlisting"><code class="hljs-code">Invoice Outlook =
    [Sales Orders on Schedule]
    - [Surplus Correction]
    + [End Correction]
</code></pre>
    <p class="book-title--packt">All we need to do now is calculate the regularly scheduled invoice amount and correct for positive invoice<a id="calibre_link-1718" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> surplus (which is done by subtracting from the monthly schedule for as long as needed) and for negative invoice surplus (which is done in the last month of the invoice schedule).</p>
    <h3 id="calibre_link-204" class="calibre8">Further optimization</h3>
    <p class="book-title--packt">By moving from<a id="calibre_link-1178" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> iterating over individual sales orders to combinations of delivery months and duration, we potentially save many thousands of iterations. But is that true in all cases? Unfortunately, no. When a report zooms in to, say, one customer, or even one sales order, the "unoptimized" version of our calculation will probably need fewer iterations than our optimized one. This is because we look at all delivery month/duration combinations, without considering whether there are any sales orders for that combination.</p>
    <p class="book-title--packt">It is not difficult to further restrict the number of iterations by specifically taking into account the data we already have on sales orders. You can use the <code class="code-in-text--packt">SUMMARIZE</code> function to do just that. <code class="code-in-text--packt">SUMMARIZE</code> can be used to retrieve unique combinations of values from multiple columns in a table (just like <code class="code-in-text--packt">DISTINCT</code> does the same for a single column). But <code class="code-in-text--packt">SUMMARIZE</code> supports retrieving values from columns in related tables as well, like this:</p>
    <pre class="programlisting"><code class="hljs-code">SUMMARIZE(fSales, 'Calendar'[YearMthCtr], Ledger[Duration])
</code></pre>
    <p class="book-title--packt">As we have relationships between the <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">Calendar</code> tables, and between the <code class="code-in-text--packt">fSales</code> and <code class="code-in-text--packt">Ledger</code> tables, this <code class="code-in-text--packt">SUMMARIZE</code> statement returns the unique combinations of <code class="code-in-text--packt">YearMthCtr</code> values and <code class="code-in-text--packt">Duration</code> values that have <a id="calibre_link-446" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>corresponding rows in the <code class="code-in-text--packt">fSales</code> table.</p>
    <p class="book-title--packt">We need a bit more than this, as the active relationship is on date, not delivery date, and we still need to filter on current <a id="calibre_link-769" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales orders. This can be done by activating the relationship on <a id="calibre_link-863" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>delivery date <a id="calibre_link-1299" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>with <code class="code-in-text--packt">USERELATIONSHIP</code> as a filter argument in a <code class="code-in-text--packt">CALCULATETABLE</code> statement:</p>
    <pre class="programlisting"><code class="hljs-code">CALCULATETABLE(
    SUMMARIZE(fSales, 'Calendar'[YearMthCtr], Ledger[Duration]),
    USERELATIONSHIP(fSales[DeliveryDate], 'Calendar'[Date])
)
</code></pre>
    <p class="book-title--packt">The different <code class="code-in-text--packt">MonthsDurations</code> variables used in the measures in the previous sections can now be defined using the<a id="calibre_link-1430" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> code above, resulting in tables with only rows for which sales orders are found. For instance, the <code class="code-in-text--packt">MonthsDurationsEnd</code> code used in the <code class="code-in-text--packt">End Correction</code> measure<a id="calibre_link-1179" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> was:</p>
    <pre class="programlisting"><code class="hljs-code">VAR MonthsDurationsEnd =
    GENERATE(
        FILTER(
            DISTINCT(Ledger[Duration]),
            Ledger[Duration] &gt; 0
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        FILTER(
            ALL('Calendar'[YearMthCtr]),
            'Calendar'[YearMthCtr] + ThisDuration - 1 
                IN MonthList
        )
    )
</code></pre>
    <p class="book-title--packt">This definition can be rewritten as:</p>
    <pre class="programlisting"><code class="hljs-code">VAR MonthsDurationsEnd =
    FILTER(
        CALCULATETABLE(
            SUMMARIZE(fSales, 	
                Ledger[Duration], 'Calendar'[YearMthCtr]
            ),
            USERELATIONSHIP(
                fSales[DeliveryDate], 
                'Calendar'[Date]
            ),
            ALL('Calendar')
            ),
            VAR ThisDuration = Ledger[Duration]
            RETURN
            'Calendar'[YearMthCtr] + ThisDuration &ndash; 1 IN MonthList
    )
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">CALCULATE(SUMMARIZE(...</code> statement retrieves the combinations of duration and delivery months that correspond to <a id="calibre_link-447" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales orders in our data. With the <code class="code-in-text--packt">FILTER</code> function, this table is filtered <a id="calibre_link-517" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>down to only those <a id="calibre_link-770" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>combinations for which the invoice schedule ends within <code class="code-in-text--packt">MonthList</code>.</p>
    <p class="book-title--packt">Where the first version returns <em class="italic">all</em> durations and <a id="calibre_link-1300" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>all delivery months per duration for which the invoice<a id="calibre_link-1180" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> schedule ends within <code class="code-in-text--packt">MonthList</code>, the second version only returns those durations and delivery months for which actual sales orders exist.</p>
    <h2 id="calibre_link-205" class="calibre8">Testing complex calculations</h2>
    <p class="book-title--packt">You may aspire <a id="calibre_link-481" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to master DAX in such a way that you can write calculations like the&nbsp;ones in this chapter <a id="calibre_link-954" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>correctly at once. In reality, errors are easily made, of course, so it is important to test your calculations. With a complex set of calculations that iterate over a set of items, this is no easy task.</p>
    <p class="book-title--packt">What can help is to create a number of copies of the formula, each of which returns the value of one of the variables used <a id="calibre_link-1431" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>along the way. For instance, if you wanted to test the <code class="code-in-text--packt">Sales Orders on Schedule</code> measure, the first test measure could be:</p>
    <pre class="programlisting"><code class="hljs-code">1 &ndash; MonthList =
VAR MonthList =
    CALCULATETABLE(
        DISTINCT('Calendar'[YearMthCtr]),
        KEEPFILTERS('Calendar'[Date]) &gt;= TODAY())
    )
RETURN
COUNTROWS(MonthList)
</code></pre>
    <p class="book-title--packt">As a DAX measure must always return a scalar value, you will need to adapt the code in such a way that it does; in the formula above, this means using <code class="code-in-text--packt">COUNTROWS</code> to count the number of rows of <code class="code-in-text--packt">MonthList</code>. Using this test measure in different contexts provides clarity on how the code behaves.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">If you want to see the actual contents of a table variable like <code class="code-in-text--packt">MonthList</code>, you can create a calculated table with the same code (this time without <code class="code-in-text--packt">COUNTROWS</code>). It is a bit harder to evaluate the code in a specific context; however, query contexts can be simulated using <code class="code-in-text--packt">CALCULATETABLE</code>. The example below returns the <code class="code-in-text--packt">MonthList</code> contents in a context for the year 2021:</p>
      <pre class="programlisting"><code class="hljs-code">MonthList table =
CALCULATETABLE(
    VAR MonthList =
    CALCULATETABLE(
        DISTINCT('Calendar'[YearMthCtr]),
        KEEPFILTERS('Calendar'[Date] &gt;= TODAY())
    )
    RETURN
    MonthList,
    'Calendar'[Year] = 2021
)
</code></pre>
    </div>
    <p class="book-title--packt">You will have to consider that <code class="code-in-text--packt">SUMX</code> returns the sum of multiple values, which can make it difficult to see what <a id="calibre_link-955" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>happens. The <a id="calibre_link-448" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>best way is to first view output for single cases, like an individual sales order.</p>
    <p class="book-title--packt">The figure below<a id="calibre_link-482" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> shows our test output for <a id="calibre_link-518" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales order 99503 that we saw earlier in <em class="italic">Figure 2.5.15</em>. This sales order has a delivery date of January 22, 2020, and a duration of 24 months. We set "today" to be a date in October 2021, and restricted output to <code class="code-in-text--packt">YearMthCtr</code> values 69 to 73.</p>
    <figure class="mediaobject"><img src="images/000140.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.5.16: Test output for sales order 99503</p>
    <p class="book-title--packt">Note that we retrieve output in five different contexts here. For <code class="code-in-text--packt">YearMthCtr</code> values 70, 71, and 72, the end result is exactly what we expect. We do see, however, that the number of iterations over the <code class="code-in-text--packt">MonthDurations</code> table is 180, even though we selected only a single sales order. Clearly, the optimization in the previous section was not applied here!</p>
    <p class="book-title--packt">Another thing that stands out is that in month 69, which is in the past, we still have five rows in <code class="code-in-text--packt">MonthDurations</code>. You will not notice this when looking at the end result, which is blank as<a id="calibre_link-864" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> expected. However, it means that the DAX engine has to do calculations that lead to nothing. After further<a id="calibre_link-771" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> analysis, it turns out that these five rows come from a blank row in the <code class="code-in-text--packt">Calendar</code> table. This <a id="calibre_link-483" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>is the code for the <code class="code-in-text--packt">MonthDurations</code> variable in the <code class="code-in-text--packt">Sales Orders on Schedule</code> measure:</p>
    <pre class="programlisting"><code class="hljs-code">VAR MonthsDurations =
    GENERATE(
        FILTER(
            DISTINCT(Ledger[Duration]),
            Ledger[Duration] &gt; 0
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        FILTER(
            ALL('Calendar'[YearMthCtr]),
            'Calendar'[YearMthCtr] + Duration -1 &gt;= 
                FirstYearMthCtr
            &amp;&amp; 'Calendar'[YearMthCtr] &lt;= LastYearMthCtr
        )
    )
</code></pre>
    <p class="book-title--packt">Indeed, when our selection is fully in the past, <code class="code-in-text--packt">MonthList</code> is empty and both <code class="code-in-text--packt">FirstYearMthCtr</code> and <code class="code-in-text--packt">LastYearMthCtr</code> are blank. A blank value for <code class="code-in-text--packt">YearMthCtr</code> (in the blank row in <code class="code-in-text--packt">Calendar</code>) satisfies the filter criteria in the <code class="code-in-text--packt">FILTER</code> function above.</p>
    <p class="book-title--packt">We can solve this inefficiency by making sure that a possible blank row in the <code class="code-in-text--packt">Calendar</code> table is not included. This can be achieved by using <code class="code-in-text--packt">ALLNOBLANKROW</code> instead of <code class="code-in-text--packt">ALL</code> in the code. Like the<a id="calibre_link-865" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> name <a id="calibre_link-1719" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>says, <code class="code-in-text--packt">ALLNOBLANKROW</code> returns all <a id="calibre_link-772" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>values, except the one from the blank row:</p>
    <pre class="programlisting"><code class="hljs-code">VAR MonthsDurations =
    GENERATE(
        FILTER(
            DISTINCT(Ledger[Duration]),
            Ledger[Duration] &gt; 0
        ),
        VAR ThisDuration = Ledger[Duration]
        RETURN
        FILTER(
            ALLNOBLANKROW('Calendar'[YearMthCtr]),
            'Calendar'[YearMthCtr] + Duration -1 &gt;= 
                FirstYearMthCtr
            &amp;&amp; 'Calendar'[YearMthCtr] &lt;= LastYearMthCtr
        )
    )
</code></pre>
    <p class="book-title--packt">As you can see from this example, not only will testing steps of a calculation help you to get correct<a id="calibre_link-484" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> results, it can also add to further optimization of your DAX code.</p>
    <h1 id="calibre_link-206" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, we discussed two main business challenges: intercompany business and consolidated views, and invoices to be sent on open sales orders.</p>
    <p class="book-title--packt">In analyzing intercompany business, you have seen that thoroughly keeping track of context is the key to sophisticated results. In analyzing the balance between sales and purchases between two subsidiary companies, we needed to switch roles; the selling companies for one revenue stream were the purchasing companies for another revenue stream, and vice versa. DAX provides rich capabilities to perform the context transformations needed for these kinds of calculations.</p>
    <p class="book-title--packt">In the intercompany business example, you have also seen that in some cases, DAX measures must be specifically tailored to the visualizations used to produce understandable results.</p>
    <p class="book-title--packt">The second business challenge, specifically invoicing on long-term sales orders, provides a good example of how to approach this kind of advanced analysis: first, make sure that the calculation is correct from a business perspective; and second, look for ways to improve the efficiency of the DAX code to achieve the best performance possible. Minimizing the number of iterations when using DAX table functions, as well as replacing conditional logic by filters (as we did in the <code class="code-in-text--packt">End Correction</code> measure), are both good strategies to apply to achieve well-performing DAX measures.</p>
    <p class="book-title--packt">The invoicing analysis again showed the importance of understanding DAX context. This will be a recurring theme in the next chapter as well, where we look at forecasting and extrapolation.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-257">
<div id="calibre_link-1720" class="calibre2">
<div id="calibre_link-1721" class="calibre3"><div id="calibre_link-1722" class="calibre4">
    <h1 class="chapternumber">2.6</h1>
    <h1 id="calibre_link-207" class="title">Exploring the Future: Forecasting and Future Values</h1>
    <p class="book-title--packt">Forecasting is a commonly used method to estimate the future value of investments. Power BI is a great tool for visualizing forecasts in an effective way based on DAX calculations. Financial functions in DAX allow for analyzing multiple scenarios to investigate the result of investments.</p>
    <p class="book-title--packt">The business case in this chapter focuses on insights into the value of an investment over time. As a specific example, think of acquiring a property to rent out: after an initial investment, incoming and outgoing cash flows are to be expected in the future. The value of a single dollar in the future is different from a dollar in the present; this is due to inflation, but is also related to the option to invest the dollar from the present to earn a return over time. Future cash flows therefore need to be adjusted to make them comparable to today's investment and ultimately to answer the question: <em class="italic">is this a good investment to make?</em></p>
    <p class="book-title--packt">As these are quite specific concepts, this chapter starts with an overview of financial terms and definitions to work with. The topics covered in this chapter are:</p>
    <ul class="calibre9">
      <li class="bullet">Financial calculations</li>
      <li class="bullet">Financial DAX functions</li>
      <li class="bullet">The business case and model</li>
      <li class="bullet">Calculating Future Value (FV)</li>
      <li class="bullet">Calculating Net Present Value (NPV)</li>
      <li class="bullet">Calculating the Internal Rate of Return (IRR)</li>
      <li class="bullet">Calculating cost-covering rent</li>
    </ul>
    <p class="book-title--packt">We will use a real-estate scenario as an example throughout this chapter, a portfolio of properties with costs and income over time. However, these calculations are applicable to any investment scenario where future cash flows are in play.</p>
    <h1 id="calibre_link-208" class="title">Financial calculations</h1>
    <p class="book-title--packt">If you want to buy a house, most of the time you will need to take out a loan. You then have to pay interest <a id="calibre_link-800" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>over the course of the loan, in combination with regular payback. But when doing the math on this, inflation is a factor to take into account as well: if you had a loan of, say, $100,000, and you only paid interest, in 20 years your debt would still be $100,000 nominally, but the <em class="italic">worth</em> of it would be much less.</p>
    <p class="book-title--packt">The same is true when making an investment. If you have $100,000 and you plan to invest it by acquiring a property, multiple financial elements will be part of the equation:</p>
    <ul class="calibre9">
      <li class="bullet">The initial investment (of acquiring the property)</li>
      <li class="bullet">Future incoming cash flows (tenants paying rent)</li>
      <li class="bullet">Future outgoing cash flows (maintenance, taxes, and other expenses)</li>
      <li class="bullet">The residual value (the worth of the property at the end of your period of investigation)</li>
    </ul>
    <p class="book-title--packt">The question is, given these four elements and expectations about future devaluation of cash and assets, <em class="italic">am I making a good investment</em>? This is what we want to analyze.</p>
    <p class="book-title--packt">For simplicity, let's assume that we do the analysis on a year-by-year basis. This means that all cash flows are calculated by year, as is the devaluation of cash and assets. Conceptually, you can do these kinds of analyses at any granularity you want, although you do need data at the appropriate granularity. For example, doing the analysis at the week level only makes sense if your tenants pay weekly rent and you have weekly devaluation rates available!</p>
    <p class="book-title--packt">The <strong class="screentext">initial investment</strong> is the amount needed to start the project. Keep in mind that you may own the <a id="calibre_link-891" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>property long before the start date of your analysis; it is not necessarily a payment made, but an assessment of the current value of the property. The initial investment is the total financial picture for year 0 (no other cash flows are taken into account in this year) and it is valued at the current price level.</p>
    <p class="book-title--packt">The future <strong class="screentext">cash flows</strong> can be highly predictable (rent payments) or not (emergency maintenance). In any <a id="calibre_link-476" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>case, for a valuable analysis, there needs to be data about the expected cash flows. Additionally, to be able to compare the value of future cash flows, the nominal amounts must be adjusted by a <em class="italic">discount rate</em> during the expected life cycle of the property or the amount of time analyzed. The problem, of course, is that we do not know what the future brings; inflation may rise or fall, having a significant impact on the adjusted amounts. You will have to make assumptions here.</p>
    <p class="book-title--packt">The <strong class="screentext">residual value</strong> is the expected worth of the property in the last year of its life cycle (or the end of our analysis), for instance, the <a id="calibre_link-1214" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>expected proceeds from selling the property. What is true for <a id="calibre_link-801" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>future cash flows is even more true for the residual value: the discount rate that should be applied to this value to compare it with amounts in the present is highly uncertain. But you have to have something to work with.</p>
    <p class="book-title--packt">In short, while you may have some idea of the nominal or <em class="italic">future value</em> of cash, this cannot be used directly as the basis of a decision in the present. This is where <em class="italic">present value</em> comes into play.</p>
    <h2 id="calibre_link-209" class="calibre8">Present Value and Net Present Value</h2>
    <p class="book-title--packt">The discounted future value of a cash flow is known as the <strong class="screentext">Present Value</strong> (<strong class="screentext">PV</strong>). The PV expresses the <a id="calibre_link-1152" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>nominal value of the cash flow in today's worth. The PV of a cash flow with future value <em class="italic">FV</em> in year <em class="italic">n</em> can be described with the formula below:</p>
    <figure class="mediaobject"><img src="images/000189.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">In this formula, <em class="italic">r</em> is the (yearly) discount rate. For example, with a discount rate of 5%, a value of $100 in 2 years has a PV of 100 divided by 1.05<sup class="superscript--packt">2</sup>, or $90.70.</p>
    <p class="book-title--packt">The total of (undiscounted) initial investment, discounted future cash flows, and discounted residual value is known as the <strong class="screentext">Net Present Value</strong> (<strong class="screentext">NPV</strong>). The NPV is a single value that indicates <a id="calibre_link-1026" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the current value of the property, taking all (discounted) income and expenses over time into account. If this single value is positive, you expect to make a profit, otherwise you have a loss. The NPV can also be used to compare this particular investment to other investment options, like bringing your money to the bank.</p>
    <p class="book-title--packt">To calculate the NPV of an investment project, you need the duration of the project, the expected cash flows that will occur during the project execution, and the discount rates. The NPV returns one value: the total return of all positive and negative cash flows, calculated to a single value based on the current position in time. </p>
    <p class="book-title--packt">This is the formula:</p>
    <figure class="mediaobject"><img src="images/000035.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">This formula sums the PVs of cash flows for each year of the project. Here, <em class="italic">N</em> is the duration of the <a id="calibre_link-1153" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>project in years and <em class="italic">FV</em><sub class="calibre21">n</sub> is the future value of cash flows in each year <em class="italic">n</em>. The initial investment is <em class="italic">FV</em><sub class="calibre21">0</sub> (which is a negative cash flow) and the residual <a id="calibre_link-1027" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>value is <em class="italic">FV</em><sub class="calibre21">N</sub>. For example, when you invest $95 now and receive $100 back in two years (see the PV example above), the NPV of this investment is -$95 + $90.70, or -$4.30. This is clearly not a good deal!</p>
    <h2 id="calibre_link-210" class="calibre8">Internal Rate of Return</h2>
    <p class="book-title--packt">In the calculation of NPV, the initial investment is an important factor. After all, this is often the largest investment in the project and, in addition, it is not discounted at all. Because of this, the NPV, though a good measure for determining the attractiveness of a single investment project, is not very suitable for comparing different investment options.</p>
    <p class="book-title--packt">For this, you can use the <strong class="screentext">Internal Rate of Return</strong> (<strong class="screentext">IRR</strong>). The technical definition of IRR is that it is the <a id="calibre_link-898" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>discount rate at which the NPV is zero:</p>
    <figure class="mediaobject"><img src="images/000204.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">IRR is not an easily comprehensible metric. What it roughly indicates is the (annual) return rate of investments made at the beginning and during the project. More importantly, however, the IRR makes it possible to compare different projects. </p>
    <p class="book-title--packt">There is no exact mathematical formula to calculate the IRR. Instead, approximative methods must be used that approach the IRR<a id="calibre_link-928" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> iteratively. In Excel, the function <code class="code-in-text--packt">IRR</code> does this; we will later see that you can do this with DAX as well. Our simple example returns an IRR of 2.59%, meaning that you have a compound return of 2.59% per year on your $95.</p>
    <p class="book-title--packt">While you may be able to do these calculations on a single investment, it becomes highly complex when multiple properties to invest in, and different types of cash flows, are involved. Different properties may have different "life expectancies," discount rates for one property may <a id="calibre_link-899" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>differ <a id="calibre_link-903" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from those for another property, and so on. The ideal case for a Power BI model!</p>
    <h1 id="calibre_link-211" class="title">Financial DAX functions</h1>
    <p class="book-title--packt">DAX has borrowed many financial functions straight from Excel. Of these, two are applicable to this <a id="calibre_link-802" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>chapter's case study in particular: <code class="code-in-text--packt">XNPV</code> and <code class="code-in-text--packt">XIRR</code>. The <code class="code-in-text--packt">X</code> in the name of these functions suggests that they are table aggregations, and indeed, the first argument of each is a table.</p>
    <p class="book-title--packt"><code class="code-in-text--packt">XNPV</code> can be used to calculate the NPV of a table of cash flows:</p>
    <pre class="programlisting"><code class="hljs-code">XNPV(CashFlowTable, &lt;value&gt;, &lt;date&gt;, Rate)
</code></pre>
    <p class="book-title--packt">Note that the cash flows do not need to be in the table: you provide the values of the cash flows as an expression that is evaluated in row context on the <code class="code-in-text--packt">CashFlowTable</code>. Similarly, an expression returning a date is evaluated for each row. This means that discounting is done on a daily basis, and the (annual) <em class="italic">n</em> value from the formulas in the previous section is calculated (for the <em class="italic">m</em><sup class="superscript--packt">th</sup> row in the table) as:</p>
    <figure class="mediaobject"><img src="images/000141.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">The <code class="code-in-text--packt">XIRR</code> value tries to approximate the IRR for a table of cash flows:</p>
    <pre class="programlisting"><code class="hljs-code">XIRR(CashFlowTable, &lt;value&gt;, &lt;date&gt;)
</code></pre>
    <p class="book-title--packt">Like with <a id="calibre_link-1524" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <code class="code-in-text--packt">XNPV</code> function, a value expression and date expression are evaluated for each row in <code class="code-in-text--packt">CashFlowTable</code>. As an optional fourth <a id="calibre_link-1033" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>argument, a guess can be provided to suggest <a id="calibre_link-1520" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to the <code class="code-in-text--packt">XIRR</code> function where to start looking for a feasible rate. An optional fifth argument can be included with a value that is returned when <code class="code-in-text--packt">XIRR</code> cannot find a solution.</p>
    <p class="book-title--packt">Both <code class="code-in-text--packt">XNPV</code> and <code class="code-in-text--packt">XIRR</code> must receive at least one negative cash flow value and one positive value to function. To illustrate both functions, let's consider the following table:</p>
    <figure class="mediaobject"><img src="images/000004.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.1: Sample data for investment calculations</p>
    <p class="book-title--packt">We have created a very simple model with just one table, called <code class="code-in-text--packt">Investment</code>. It contains a <code class="code-in-text--packt">Date</code> column <a id="calibre_link-803" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and two<a id="calibre_link-1034" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> columns with distinct sets of cash flows. The first column is a good investment, while the second is not. You will see why. In both cases:</p>
    <ul class="calibre9">
      <li class="bullet">The initial investment is $1,000,000</li>
      <li class="bullet">We use a discount rate of 3%</li>
      <li class="bullet">After the initial investment, all years generate a positive cash flow</li>
      <li class="bullet">We expect the property to last for 10 years with a residual value of $900,000<div class="note pcalibre5 pcalibre4">
          <p class="book-title--packt">You can download this small model, <code class="code-in-text--packt">2.6 NPV XIRR example.pbix</code>, from <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.6" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.6</span></a>.</p>
        </div>
      </li>
    </ul>
    <p class="book-title--packt">The future value of the cash flows is simply a DAX measure calculating the sum of the individual cash flows. For scenario 1:</p>
    <pre class="programlisting"><code class="hljs-code">FV = SUM(Investment[CashFlows1])
</code></pre>
    <p class="book-title--packt">The NPV for scenario 1 is calculated <a id="calibre_link-1525" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>using the <code class="code-in-text--packt">XNPV</code> function:</p>
    <pre class="programlisting"><code class="hljs-code">NPV1 = 
XNPV(
    Investment, 
    Investment[CashFlows1], 
    Investment[Date], 
    0.03
)
</code></pre>
    <p class="book-title--packt">Note that the <a id="calibre_link-804" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>cash flow values and dates are evaluated in row context on the <code class="code-in-text--packt">Investment</code> table; we can therefore directly use the values in the appropriate columns.</p>
    <p class="book-title--packt">For calculating the IRR, we use the <code class="code-in-text--packt">XIRR</code> function:</p>
    <pre class="programlisting"><code class="hljs-code">IRR1 =
XIRR(
    Investment,
    Investment[CashFlows1],
    Investment[Date]
)
</code></pre>
    <p class="book-title--packt">For scenario 2, the DAX measures are <a id="calibre_link-1035" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the same except for the use of the <code class="code-in-text--packt">CashFlows2</code> column.</p>
    <p class="book-title--packt">The results for scenario 1 are below:</p>
    <figure class="mediaobject"><img src="images/000107.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.2: Results for scenario 1</p>
    <p class="book-title--packt">So, everything looks great. Note the difference between the FV total of the cash flows and the NPV result: although the nominal return is almost half a million, with the 3% discount rate, this return is worth only about 160,000 in today's (well, 2020's) money. But the NPV is still positive, and with an IRR of almost 5%, this investment is worth making.</p>
    <p class="book-title--packt">If we look at scenario 2, the results are different:</p>
    <figure class="mediaobject"><img src="images/000128.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.3: Results for scenario 2</p>
    <p class="book-title--packt">In this scenario, the cash flows generate a positive future value of $186,000. But the NPV is negative and the IRR is <a id="calibre_link-805" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>below 2%! This means the positive cash flow is not enough to cover the 3% rate in 10 years and you should be able to find better investments, assuming the 3% discount rate is accurate.</p>
    <h1 id="calibre_link-212" class="title">The business case and model</h1>
    <p class="book-title--packt">In the remainder <a id="calibre_link-403" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of this chapter, we look at a portfolio of real estate properties. Different <a id="calibre_link-408" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>properties may have different life cycle durations. Each property has:</p>
    <ul class="calibre9">
      <li class="bullet">An investment in year 0, cash flows, and a residual value.</li>
      <li class="bullet">Cash flows with a recurring pattern during the life span of the property, either positive (income) or negative (expenses).</li>
      <li class="bullet">Positive or negative cash flows with an irregular pattern, like maintenance.</li>
    </ul>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can download this model, <code class="code-in-text--packt">2.6 Exploring the future.pbix</code>, from <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.6" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.6</span></a>.</p>
    </div>
    <p class="book-title--packt">The model contains three fact tables: <code class="code-in-text--packt">fPosCashFlows</code> for positive recurring cash flows, <code class="code-in-text--packt">fNegCashFlows</code> for negative recurring cash flows, and <code class="code-in-text--packt">fIrregular</code> for irregular cash flows. </p>
    <p class="book-title--packt">There can be many different cash flow drivers; to be able to analyze them separately, there is a filter table with the type of cash flow for each fact table:</p>
    <figure class="mediaobject"><img src="images/000148.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.4: Model diagram</p>
    <p class="book-title--packt">You may notice that in this model, there are no relationships from the <code class="code-in-text--packt">fNegCashFlows</code> and <code class="code-in-text--packt">fPosCashFlows</code> tables to the <code class="code-in-text--packt">Year</code> table. The reason for that is that we will not just use cash flow values for <a id="calibre_link-404" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>each year; instead, the recurring cash flows are modeled as a <a id="calibre_link-409" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>single value (per cash flow type) that is <em class="italic">indexed</em> for each year. Think of this as a yearly increase in rent. As an example, with an initial positive cash flow of $1,000 and a yearly index of 2%, or 1.02, the cash flow in year 1 would be $1,020, in year 2 it would be $1,040.40, and so on. The initial values of these cash flows are always in year 0 and therefore a relationship with the <code class="code-in-text--packt">Year</code> table does not help in any way.</p>
    <p class="book-title--packt">For irregular cash flows, we do not use indexed values; instead, for each year, a cash flow value is loaded and the <code class="code-in-text--packt">fIrregular</code> table is related to the <code class="code-in-text--packt">Year</code> table.</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">Year</code> table is used to map different cash flows to the corresponding year, and to calculate the discounts on these cash flows. The table contains one row per year, with columns for the year, the year as a date value, and a year number. In our analysis, the year 2020 is year 0:</p>
    <figure class="mediaobject"><img src="images/000168.png" alt="Table, Excel  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.5: Data in the Year table</p>
    <p class="book-title--packt">With this model, we want to analyze several aspects of the investment portfolio to help decision-making. The analysis should provide answers to questions like:</p>
    <ul class="calibre9">
      <li class="bullet">Is the portfolio profitable? Which properties are most profitable, and which properties provide a loss over the expected lifetime?</li>
      <li class="bullet">What is the expected rate of return on each of the properties?</li>
      <li class="bullet">How does varying the index of cash flow growth affect the return on the portfolio?</li>
      <li class="bullet">To what extent does a changing discount rate impact the profitability of the portfolio?</li>
      <li class="bullet">What is the minimum rent (recurring positive cash flow) required to make the investment viable?</li>
    </ul>
    <p class="book-title--packt">In answering these questions, the NPV and IRR play a major role. But while we introduced these <a id="calibre_link-405" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>metrics with a fixed discount rate, we want to be able to use varying <a id="calibre_link-410" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>discount rates and cash flow indexes to gain insights in multiple scenarios. This will help us to get a thorough understanding of the investment portfolio. We therefore need to extend the basic model to enable working with different rates. In Power BI, this can be done with "what-if" parameters, which we explore below.</p>
    <h2 id="calibre_link-213" class="calibre8">Creating adjustable rates and indexes</h2>
    <p class="book-title--packt">Power BI Desktop allows the creation of <strong class="screentext">what-if</strong> parameters to enable dynamic adjustment of <a id="calibre_link-1516" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>analysis variables. To create a what-if parameter, click the <strong class="screentext">New parameter</strong> button in the ribbon:</p>
    <figure class="mediaobject"><img src="images/000190.png" alt="Graphical user interface, application, table, Excel  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.6: Creating a what-if parameter</p>
    <p class="book-title--packt">A parameter can have a fixed, limited number of values, which are set through the <strong class="screentext">What-if parameter</strong> window:</p>
    <figure class="mediaobject"><img src="images/000212.png" alt="Graphical user interface  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.7: The What-if parameter window</p>
    <p class="book-title--packt">You provide the <a id="calibre_link-1517" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>lowest, highest, and default value of the parameter, as well as the increment, which determines the values between the lowest and highest that are available. </p>
    <p class="book-title--packt">Once created, a what-if parameter enables a special slicer style for selecting a single parameter value using a slider:</p>
    <figure class="mediaobject"><img src="images/000010.png" alt="Graphical user interface, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.8: Single-value slicer for what-if parameters</p>
    <p class="book-title--packt">In addition, the what-if parameter leads to a calculated table being created in the model with the same name <a id="calibre_link-1723" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>as the parameter. The table contains a single column, again with the parameter's name, with every possible value the parameter can have. A DAX measure is generated automatically to retrieve the selected value of the parameter:</p>
    <pre class="programlisting"><code class="hljs-code">Index Value = SELECTEDVALUE('Index'[Index], 2.5)
</code></pre>
    <p class="book-title--packt">In this measure, the default value you provide for the what-if parameter is used as the value to return when no selection is made.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">To keep your model nice and tidy, move the auto-generated measure to a measure table.</p>
    </div>
    <p class="book-title--packt">In our portfolio analysis, we want to be able to choose a specific index to grow recurring cash flows in years 1, 2, and 3. As it is hard to predict possible growth rates for later years, we choose to use the index of year 3 for later years as well. We need three what-if parameters to accomplish this; let's call them <code class="code-in-text--packt">Index</code>, <code class="code-in-text--packt">IndexY1</code>, and <code class="code-in-text--packt">IndexY2</code>. The settings for these parameters are as shown in <em class="italic">Figure 2.6.7</em>: we can vary between 0% and 5% with increments of 0.1% and a default of 2.5%. In the same way, we want to consider various discount rates. </p>
    <p class="book-title--packt">For this, we create a what-if parameter called <code class="code-in-text--packt">Discount</code>, varying between 0% and 10% with a default of 6%, again with a 0.1% increment.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">It is common to not have too much freedom in choosing a discount rate, as it is mainly an external variable: it is the rate of return an investment is expected to <a id="calibre_link-1480" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>generate in the general market. Selecting a discount rate that is very different from that should result in complaints from your accountant!</p>
    </div>
    <p class="book-title--packt">As all our what-if parameters are <a id="calibre_link-1411" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>percentages, we change the default value measures to make them return a proper percentage value:</p>
    <pre class="programlisting"><code class="hljs-code">Index value = SELECTEDVALUE('Index'[Index], 2.5) / 100
</code></pre>
    <p class="book-title--packt">With these <a id="calibre_link-1518" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>what-if parameters in place, we can start calculating the various requested metrics.</p>
    <h1 id="calibre_link-214" class="title">Calculating Future Value (FV)</h1>
    <p class="book-title--packt">As the first step in the calculations, we need to calculate the nominal or future value of all cash flows. Remember <a id="calibre_link-835" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>that we have multiple parts to calculate: initial investment, recurring cash flows, irregular cash flows, and residual value. We will start with the easy part.</p>
    <h2 id="calibre_link-215" class="calibre8">Initial investment and residual value</h2>
    <p class="book-title--packt">In our model, both the initial investment and residual value are attributes of a property. We could simply <a id="calibre_link-836" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>total up the values in the <a id="calibre_link-846" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>corresponding columns in the <code class="code-in-text--packt">Property</code> table, but for our analysis, the values should be mapped onto the correct year: the initial investment in year 0, and the residual value in the last year of the property's life cycle.</p>
    <p class="book-title--packt">To help with mapping the initial investment to year 0, an additional column, <code class="code-in-text--packt">Initial period</code>, is in the <code class="code-in-text--packt">Property</code> table. This column always contains the value 0. The initial investment is calculated with the DAX measure below:</p>
    <pre class="programlisting"><code class="hljs-code">FV Initial Investment =
CALCULATE(
    SUM('Property'[Initial investment],
    TREATAS(VALUES('Year'[YearNr]), 'Property'[Initial period])
)
</code></pre>
    <p class="book-title--packt">At first sight, the filter argument in this <code class="code-in-text--packt">CALCULATE</code> expression may look equivalent to <code class="code-in-text--packt">Property[Initial period] = 0</code>. However, this filter makes sure that the initial investment is only returned when year 0 is in the query context. For example, when only the year 2023 is selected, <code class="code-in-text--packt">TREATAS</code> leads to only rows in the <code class="code-in-text--packt">Property</code> table being selected for which <code class="code-in-text--packt">Initial period</code> equals 2; but the <a id="calibre_link-1412" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>table contains only rows with the value 0 in this column.</p>
    <p class="book-title--packt">A similar formula can be used for the residual value. This time, we use an <code class="code-in-text--packt">End year</code> column in the <code class="code-in-text--packt">Property</code> table, which contains the last year of the property's life cycle (not the year number):</p>
    <pre class="programlisting"><code class="hljs-code">FV Residual Value = 
CALCULATE(
    SUM('Property'[Residual value]),
    TREATAS(VALUES('Year'[Year]),'Property'[End Year])
)
</code></pre>
    <p class="book-title--packt">This time, <code class="code-in-text--packt">TREATAS</code> makes <a id="calibre_link-837" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sure that for each year, only <a id="calibre_link-847" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the residual values are calculated for <a id="calibre_link-1481" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>properties for which the life cycle ends in that year. </p>
    <p class="book-title--packt">The chart below shows the results of both measures:</p>
    <figure class="mediaobject"><img src="images/000029.png" alt="A picture containing table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.9: FV of initial investment and residual values</p>
    <p class="book-title--packt">As expected, we have a large negative value in year 0, and smaller positive values in most years corresponding to properties at the end of their life cycle.</p>
    <h2 id="calibre_link-216" class="calibre8">Irregular cash flows</h2>
    <p class="book-title--packt">To allow for one-off and other non-recurring cash flows, the <code class="code-in-text--packt">fIrregular</code> table contains future cash <a id="calibre_link-838" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>flows by year. Like with initial investment and residual value, we want these cash flows to be calculated in the corresponding year. As we have a <code class="code-in-text--packt">Year</code> column in the <code class="code-in-text--packt">fIrregular</code> table, the easiest way to accomplish this is to simply have a relationship between <code class="code-in-text--packt">fIrregular</code> and <code class="code-in-text--packt">Year</code>.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The <code class="code-in-text--packt">fIrregular</code> table could be used to store emergency expenses, but in a multi-year analysis, it is difficult to account for these. Rather, you could schedule a multi-year plan for the physical maintenance of a property, or reserve cash for contingencies.</p>
    </div>
    <p class="book-title--packt">To allow a more detailed analysis, we create separate measures for positive and negative irregular cash flows. First:</p>
    <pre class="programlisting"><code class="hljs-code">FV Irregular positive =
CALCULATE(
    SUM(fIrregular[CashFlow]),
    fIrregular[CashFlow] &gt;= 0
)
</code></pre>
    <p class="book-title--packt">Calculating positive irregular cash flow comes down to simply filtering on the value of the <code class="code-in-text--packt">CashFlow</code> column. The negative cash flow is, of course, calculated by filtering on only negative <code class="code-in-text--packt">CashFlow</code> values:</p>
    <pre class="programlisting"><code class="hljs-code">FV Irregular negative =
CALCULATE(
    SUM(fIrregular[CashFlow]),
    fIrregular[CashFlow] &lt; 0
)
</code></pre>
    <p class="book-title--packt">The relationship between <code class="code-in-text--packt">fIrregular</code> and <code class="code-in-text--packt">Year</code> will cause the cash flow amounts to land in the corresponding years automatically.</p>
    <h2 id="calibre_link-217" class="calibre8">Recurring cash flows</h2>
    <p class="book-title--packt">The most complex aspect of calculating the future value is the recurring cash flows. Not only do we have <a id="calibre_link-843" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to work with values that must be indexed but, in addition, each property can have a different life cycle. We need to take care that we are not calculating recurring cash flows after the end of each property's life cycle.</p>
    <p class="book-title--packt">We will focus on positive cash flows only and calculate values without indexing first:</p>
    <pre class="programlisting"><code class="hljs-code">FV Recurring positive (not indexed) =
SUMX(
    FILTER('Year', 'Year'[YearNr] &gt; 0),
    VAR ThisYear = 'Year'[Year]
    RETURN
    CALCULATE(
        SUM(fPosCashFlows[Income]),
        'Property'[End Year] &gt;= ThisYear
    )
)
</code></pre>
    <p class="book-title--packt">As we can have a different set of properties that are still "active" in each year, we need to do the calculation on a by-year basis. For <a id="calibre_link-773" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>each year after year 0, we calculate the positive cash <a id="calibre_link-1724" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>flows for properties that are not yet at the end of their life cycle. Note that the filter here requires <code class="code-in-text--packt">End Year</code> to be larger than or equal to the current year, meaning that we calculate the recurring cash flow for all years, including the last year of the property's life cycle.</p>
    <p class="book-title--packt">Below is the result for a small set of properties:</p>
    <figure class="mediaobject"><img src="images/000049.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.10: FV of positive recurring cash flows</p>
    <p class="book-title--packt">From this table of results, it is clear that each property ends in a specific year; for instance, property 35 has its <code class="code-in-text--packt">End Year</code> attribute set to 2025. </p>
    <p class="book-title--packt">To calculate the indexed recurring cash flows, we need to multiply the base amount in each year by a power of 1 plus the index value:</p>
    <figure class="mediaobject"><img src="images/000182.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Here, <em class="italic">n</em> is the number of the year. As we have a different index for years 1 and 2, we do a separate calculation for these years:</p>
    <pre class="programlisting"><code class="hljs-code">FV Recurring positive =
CALCULATE(
    [FV Recurring positive (not indexed)]
        * (1 + [IndexY1 value]),
    KEEPFILTERS('Year'[YearNr] = 1
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">KEEPFILTERS</code> function <a id="calibre_link-844" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>makes <a id="calibre_link-956" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sure this <a id="calibre_link-774" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation is only done for year 1. For the amount in year 2, we need to use the square of the multiplication factor:</p>
    <pre class="programlisting"><code class="hljs-code">+
CALCULATE(
    [FV Recurring positive (not indexed)]
        * POWER(1 + [IndexY2 value], 2),
    KEEPFILTERS('Year'[YearNr] = 2
)
</code></pre>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Instead of the <code class="code-in-text--packt">POWER</code> function, you can<a id="calibre_link-267" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> use the ^ operator as well:</p>
      <pre class="programlisting"><code class="hljs-code">(1 + [IndexY2 value]) ^ 2
</code></pre>
    </div>
    <p class="book-title--packt">For later years, we use the default <code class="code-in-text--packt">Index value</code> with higher powers:</p>
    <pre class="programlisting"><code class="hljs-code">+
SUMX(
    FILTER('Year', 'Year'[YearNr] &gt;= 3),
    [FV Recurring positive (not indexed)]
        * POWER(1 + [Index value], 'Year'[YearNr])
)
</code></pre>
    <p class="book-title--packt">The indexed cash flows for properties shown in <em class="italic">Figure 2.6.10</em> is below:</p>
    <figure class="mediaobject"><img src="images/000070.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.11: Indexed values of future recurring cash flows</p>
    <p class="book-title--packt">The calculation for <a id="calibre_link-845" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>recurring negative cash flows is similar, but <a id="calibre_link-775" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>as the values of the negative cash flows are <a id="calibre_link-957" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>stored as positive amounts, we need to multiply by -1:</p>
    <pre class="programlisting"><code class="hljs-code">FV Recurring negative (not indexed) =
SUMX(
    FILTER('Year', 'Year'[YearNr] &gt; 0),
    VAR ThisYear = 'Year'[YearNr]
    RETURN
    -1 *
    CALCULATE(
        SUM(fNegCashFlows[Expenses]),
        'Property'[End Year] &gt;= ThisYear
    )
)
</code></pre>
    <p class="book-title--packt">The indexed negative cash flow is again calculated using the index values:</p>
    <pre class="programlisting"><code class="hljs-code">FV Recurring negative =
CALCULATE(
    [FV Recurring negative (not indexed)]
        * (1 + [IndexY1 value]),
    KEEPFILTERS('Year'[YearNr] = 1)
)
+
CALCULATE(
    [FV Recurring negative (not indexed)]
        * POWER(1 + [IndexY1 value], 2),
    KEEPFILTERS('Year'[YearNr] = 2)
)
+
SUMX(
    FILTER('Year', 'Year'[YearNr] &gt;= 3),
    [FV Recurring negative (not indexed)]
        * POWER(1 + [Index value], 'Year'[YearNr])
)
</code></pre>
    <h2 id="calibre_link-218" class="calibre8">Positive and negative cash flows</h2>
    <p class="book-title--packt">We now have <a id="calibre_link-841" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>all components in place to <a id="calibre_link-839" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculate the total future value. The positive cash flows consist of positive <a id="calibre_link-776" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>recurring and irregular cash flows, and the residual value:</p>
    <pre class="programlisting"><code class="hljs-code">FV positive =
[FV Recurring positive] 
+ [FV Irregular positive] 
+ [FV Residual Value]
</code></pre>
    <p class="book-title--packt">These values can be viewed in a chart for the four example properties:</p>
    <figure class="mediaobject"><img src="images/000092.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.12: Positive FV</p>
    <p class="book-title--packt">The negative future value is the negative recurring and irregular cash flows, plus the initial investment:</p>
    <pre class="programlisting"><code class="hljs-code">FV negative =
    [FV Recurring negative]
    + [FV Irregular negative]
    + [FV Initial Investment]
</code></pre>
    <p class="book-title--packt">Sample output for the negative FV:</p>
    <figure class="mediaobject"><img src="images/000114.png" alt="Chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.13: Negative FV</p>
    <p class="book-title--packt">Note that in both <a id="calibre_link-842" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>charts above, the amounts tend <a id="calibre_link-840" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to decrease over the years despite the indexing of the recurring cash flows. This is an effect of properties reaching the end of their life cycle: in later years, fewer properties add to the total FV.</p>
    <p class="book-title--packt">Finally, the overall FV is calculated by combining the two measures above:</p>
    <pre class="programlisting"><code class="hljs-code">Future Value = [FV positive] + [FV negative]
</code></pre>
    <p class="book-title--packt">With this, we have everything in place to start working on the Present Value analysis.</p>
    <h1 id="calibre_link-219" class="title">Calculating Net Present Value (NPV)</h1>
    <p class="book-title--packt">The NPV is the sum <a id="calibre_link-1028" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of the present values of all cash flows over the years. Remember the definition of PV:</p>
    <figure class="mediaobject"><img src="images/000189.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">So, to calculate the PV of a cash flow in year <em class="italic">n</em>, we need to take the discount rate and divide the FV by a power of the discount rate. As an example, if you wanted to create a calculated <a id="calibre_link-1029" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>column in the <code class="code-in-text--packt">Property</code> table with the PV of the residual value of each property (we are sure you don't want to do that by now!), you could do that with the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">PV Residual Value =
VAR EndYearNr = 
    LOOKUPVALUE('Year'[YearNr], 'Year'[Year], Property[End Year])
VAR DiscountFactor =
    (1 + [Discount value]) ^ EndYearNr
RETURN
DIVIDE(Property[Residual Value], DiscountFactor)
</code></pre>
    <p class="book-title--packt">In normal language: we take the property's end year, find the corresponding year number, calculate the discount factor with the year number as power, and divide the residual value by the discount factor. The discount factor is 1 plus the discount rate, which we take from the what-if parameter <code class="code-in-text--packt">Discount</code>.</p>
    <p class="book-title--packt">The complexity in this formula is mainly in retrieving the correct year number. When designing PV measures, we have to deal with the same complexity. However, we designed the FV measures in such a way that each FV is already connected to the correct year. We can therefore simply iterate over the years to compute the PV. For example, for the PV of the residual value, the formula below will suffice:</p>
    <pre class="programlisting"><code class="hljs-code">PV Residual Value =
SUMX(
    'Year',
    VAR DiscountFactor = (1 + [Discount value]) ^ 'Year'[YearNr]
    RETURN
    DIVIDE(
        [FV Residual Value],
        DiscountFactor
    )
</code></pre>
    <p class="book-title--packt">All other PVs can be calculated in the same way. We will not list them all here; you can find PV measures in the model accompanying this chapter. As an illustration of the effect of discounting, in the chart below are the positive recurring cash flow values for a sample property:</p>
    <figure class="mediaobject"><img src="images/000134.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.14: FV and PV</p>
    <p class="book-title--packt">While the FV of the recurring cash flow increases each year (it is indexed, after all), the PV of this cash <a id="calibre_link-1030" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>flow decreases. The reason for this is that in this case, the discount rate is higher than the index.</p>
    <p class="book-title--packt">There is one PV calculation that is particularly interesting: the PV of the overall FV calculation. By definition, this is the NPV!</p>
    <pre class="programlisting"><code class="hljs-code">Net Present Value =
SUMX(
    'Year',
    VAR DiscountFactor = (1 + [Discount value]) ^ 'Year'[YearNr]
    RETURN
    DIVIDE(
        [Future Value],
        DiscountFactor
    )
</code></pre>
    <p class="book-title--packt">With this measure, it is now possible to view the NPV for each property:</p>
    <figure class="mediaobject"><img src="images/000154.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.15: Net Present Value</p>
    <p class="book-title--packt">You can draw <a id="calibre_link-1031" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a clear <a id="calibre_link-1036" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>conclusion from this chart: most of the properties are not profitable with the current settings!</p>
    <p class="book-title--packt">But wait: didn't we have a special NPV function in DAX? We <a id="calibre_link-1526" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can use the <code class="code-in-text--packt">XNPV</code> function to calculate the NPV as well:</p>
    <pre class="programlisting"><code class="hljs-code">Net Present Value 2 =
XNPV(
    'Year',
    [Future Value],
    'Year'[Date],
    [Discount value]
)
</code></pre>
    <p class="book-title--packt">And indeed, we get mostly the same results with both NPV calculations. There are slight differences, due to the fact that the <code class="code-in-text--packt">XNVP</code> function works on the basis of days; the power for the discount factor is calculated as:</p>
    <figure class="mediaobject"><img src="images/000141.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">This is fully correct most of the <a id="calibre_link-904" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>time, but for leap years, the factor slightly deviates from what it should be. You could say we outsmarted DAX here! In most cases, these differences are not something to worry about. However, the way we calculated the NPV from low-grained<a id="calibre_link-1032" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> calculations has the added benefit that you can get much more detailed insights about why the NPV has a certain value.</p>
    <h1 id="calibre_link-220" class="title">Calculating the Internal Rate of Return (IRR)</h1>
    <p class="book-title--packt">Now that we know how to calculate the NPV in our model, calculating the IRR is easy, as it is just an <a id="calibre_link-900" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>application of the <code class="code-in-text--packt">XIRR</code> function. Before<a id="calibre_link-1521" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> we do that, it is worthwhile to look more closely at what the IRR is.</p>
    <p class="book-title--packt">In the chart below, the NPV is plotted for a single property against different possible values of the discount rate:</p>
    <figure class="mediaobject"><img src="images/000175.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.16: NPV for varying discount rates</p>
    <p class="book-title--packt">It is not easy to see in this chart, but the line has a slight curve; which is to be expected as the NPV is some complex polynomial function of the discount rate. Remember that the definition <a id="calibre_link-901" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of IRR is the discount rate at which the NPV equals zero. The chart contains a (horizontal) constant line at zero to allow for visually determining where the IRR must be. The vertical, dotted line is an approximation of the IRR. As can be seen in the chart, for some discount rates, the NPV for this property is positive, but for other discount rates, it is negative. In this case, the IRR is about 4.5.</p>
    <p class="book-title--packt">The meaning of this is (roughly) that when <a id="calibre_link-777" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>you have another investment opportunity that will give you more than 4.5% return on the investment and all returns, you'd better choose that opportunity. Or, if the bank will give you more than 4.5% interest, you would be better off leaving your money at the bank instead of investing in this property.</p>
    <p class="book-title--packt">To calculate the<a id="calibre_link-1522" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> IRR, you have to solve the complex NPV function for the zero point. The <code class="code-in-text--packt">XIRR</code> function does that for us by approximation:</p>
    <pre class="programlisting"><code class="hljs-code">Internal Rate of Return =
XIRR(
    'Year',
    [Future Value],
    'Year'[Date]
)
</code></pre>
    <p class="book-title--packt">Indeed, the IRR result for the property in <em class="italic">Figure 2.6.16</em> is close to 4.5:</p>
    <figure class="mediaobject"><img src="images/000197.png" alt="Text  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.17: IRR</p>
    <p class="book-title--packt">Looking at the chart, you may suspect that we could also find an approximate IRR by calculating the <a id="calibre_link-1725" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>NPV for many different discount rates and picking the best one:</p>
    <pre class="programlisting"><code class="hljs-code">IRR approximation =
MAXX(
    FILTER(
        Discount,
        [Net Present Value] &gt; 0
    ),
    Discount[Discount]
)
</code></pre>
    <p class="book-title--packt">The result of this measure is below:</p>
    <figure class="mediaobject"><img src="images/000219.png" alt="Text  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.18: IRR approximation</p>
    <p class="book-title--packt">While this result looks good, we have cheated to get here. First, we have used the knowledge that the NPV chart declines with increasing discount rate. Second, we have approached the zero-line from the best side possible; if we had filtered the <code class="code-in-text--packt">Discount</code> table on values with an NPV smaller than zero and taken the minimum rate, the result would have been 4.5: much further from the actual IRR. And third, we only considered discount rate values that are in the <code class="code-in-text--packt">Discount</code> table. We selected the property used in this section specifically to show you the zero line, but many properties only reach a zero NPV at discount rates outside of the <code class="code-in-text--packt">Discount</code> what-if parameter. </p>
    <p class="book-title--packt">While the assumption of a downward slope in the NPV chart seems plausible, we would have to check many <a id="calibre_link-902" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>more discount rate options than we did to arrive at acceptable results. For calculating the IRR, the <code class="code-in-text--packt">XIRR</code> function is simply<a id="calibre_link-1523" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the most convenient tool available. In the next section, however, we focus on a metric for which no standard DAX function is available, and for that, an approximative approach in DAX will show itself to be valuable.</p>
    <h1 id="calibre_link-221" class="title">Calculating cost-covering rent</h1>
    <p class="book-title--packt">The last topic <a id="calibre_link-498" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in this chapter is about <a id="calibre_link-905" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a><strong class="screentext">cost-covering rent</strong>, or <strong class="screentext">CCR</strong> for short. This is the answer to the question: <em class="italic">what is the minimum rent to charge property tenants to make the investment break even?</em></p>
    <p class="book-title--packt">Let's go back to the NPV formula once again:</p>
    <figure class="mediaobject"><img src="images/000035.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">The IRR is calculated by solving this formula for the rate <em class="italic">r</em> at zero NPV:</p>
    <figure class="mediaobject"><img src="images/000204.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">The cost-covering rent also comes from solving the NPV formula, but now for (roughly) the future values:</p>
    <figure class="mediaobject"><img src="images/000022.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">To be more precise, while our future values are composed of multiple components, we only want to <a id="calibre_link-499" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>solve for the (initial) recurring positive cash flows in this case. The question is therefore: instead of the positive recurring cash flows in the <code class="code-in-text--packt">fPosCashFlows</code> table, and specifically those with <code class="code-in-text--packt">Type</code> 2 (rent), which values can we use to get a zero NPV?</p>
    <p class="book-title--packt">Like with the IRR, there is no direct way of calculating this. And worse, there is no DAX function that will solve this equation. We therefore need to apply an approximative method instead.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Instead of <em class="italic">approximative method</em>, you may also read <em class="italic">brute force</em>: we just do a lot of calculations to pick the best results. While we try to work a bit more smartly than that, as you will see later in this section, the measures created will not be the fastest ever, especially with larger portfolios; they simply have to do a lot of work. However, the business value of these calculations is substantial and it may be worth the wait.</p>
    </div>
    <h2 id="calibre_link-222" class="calibre8">Determining cost-covering rent by approximation</h2>
    <p class="book-title--packt">As we will <a id="calibre_link-500" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculate the NPV for many <a id="calibre_link-310" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>different values of rent (positive recurring type 2), it makes sense to start with a measure that calculates the NPV part for all cash flows except the rent. This is the formula to use:</p>
    <pre class="programlisting"><code class="hljs-code">NPV no rent =
SUMX(
    'Year',
    VAR DiscountFactor = (1 + [Discount value]) ^ 'Year'[YearNr]
    RETURN
    DIVIDE(
        [FV Negative] 
        + [FV Irregular positive] 
        + [FV Residual Value]
        + CALCULATE(
            [FV Recurring positive], 
            PosType[TypeID] &lt;&gt; 2
          ),
        DiscountFactor
    )
)
</code></pre>
    <p class="book-title--packt">This formula has the same structure as the all-up NPV measure, but now we only add FV results not including the rent cash flows. The zero NPV we are looking for is equivalent to:</p>
    <figure class="mediaobject"><img src="images/000064.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">where <em class="italic">PVPR(rent)</em> is the PV of the positive recurring cash flow associated with a specific <em class="italic">rent</em> value. As we <a id="calibre_link-501" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>may plausibly assume <a id="calibre_link-311" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>that the higher the positive cash flows, the higher the NPV will be, what we are looking for is the lowest rent value for which:</p>
    <figure class="mediaobject"><img src="images/000085.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">The result we are looking for only makes sense for individual properties. A CCR measure will therefore need to iterate <a id="calibre_link-778" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>over the <code class="code-in-text--packt">Property</code> table. We also need a set of values to try; this will be created as a variable. The <code class="code-in-text--packt">NPV no rent</code> value is also stored in a variable to use later on:</p>
    <pre class="programlisting"><code class="hljs-code">Cost-covering Rent 1 =
VAR PossibleValues = GENERATESERIES(0, 10000, 1)
SUMX(
    'Property',
    VAR NPVNoRent = -1 * [NPV no rent]    
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">GENERATESERIES</code> function creates <a id="calibre_link-866" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a table with one <code class="code-in-text--packt">Value</code> column, filled with values between a lower bound (0, in this case) and an upper bound (10,000 for us) with a fixed interval between them (we take 1 for now). As we want to try each value, the formula must iterate over this table; if we use <code class="code-in-text--packt">FILTER</code> to leave only the values for which the PVPR is high enough, we can then select the smallest. In pseudocode, this is what we do:</p>
    <pre class="programlisting"><code class="hljs-code">    RETURN
    MINX(
        FILTER(
            PossibleValues,
            VAR ThisRent = [Value]
            RETURN
            &lt;PVPR&gt; &gt;= NPVNoRent
        ),
        [Value]
    ) 
</code></pre>
    <p class="book-title--packt">Note that <code class="code-in-text--packt">[Value]</code> in the code above refers to the column in the <code class="code-in-text--packt">PossibleValues</code> table; as this is a virtual table that is not derived from an existing table in the model, it does not have a name that we can include before the column name.</p>
    <p class="book-title--packt">The problem to solve now comes down to calculating the PVPR for a specific property and rent value in <code class="code-in-text--packt">PossibleValues</code>. For this, we will go back to our earlier calculation of the FV and, after that, the PV of recurring cash flows. We cannot use an external measure here, as <a id="calibre_link-502" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>we do not have a way <a id="calibre_link-312" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>to inject the rent value into another measure; so we need to replicate the<a id="calibre_link-779" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> logic right here. As both the FV and PV calculations iterate over the years, we will combine both calculations in one iteration. You may remember that we used different index values in year 1, year 2, and later years; we will work with more DAX variables to keep track of what we are doing:</p>
    <pre class="programlisting"><code class="hljs-code">VAR PVPRYear1 =
    SUMX(
        FILTER('Year', 
                'Year'[YearNr] = 1
                &amp;&amp; 'Year'[Year] &lt;= 'Property[End Year]
        ),  
        ThisRent * (1 + [IndexY1 Value])
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">FILTER</code> part in the <code class="code-in-text--packt">PVPRYear1</code> variable makes sure the rent for year 1 is only calculated when the current property has not reached the end of its life cycle, and only for year 1. In a similar way, we can compute the PV for rent in year 2 and later:</p>
    <pre class="programlisting"><code class="hljs-code">VAR PVPRYear2 =
    SUMX(
        FILTER('Year', 
                'Year'[YearNr] = 2
                &amp;&amp; 'Year'[Year] &lt;= 'Property[End Year]
        ),
        ThisRent * POWER(1 + [IndexY1 Value], 2)
)
VAR PVPRYear3Plus =
    SUMX(
        FILTER('Year', 
                'Year'[YearNr] &gt;= 3
                &amp;&amp; 'Year'[Year] &lt;= 'Property[End Year]
        ),  
        ThisRent * POWER(1 + [IndexY1 Value], 'Year'[YearNr])
)
</code></pre>
    <p class="book-title--packt">The sum <a id="calibre_link-503" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of these three <code class="code-in-text--packt">PVPR</code> variables <a id="calibre_link-313" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can now be compared with <code class="code-in-text--packt">NVPNoRent</code> to eventually select the best <a id="calibre_link-780" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>rent option. The full formula looks like this:</p>
    <pre class="programlisting"><code class="hljs-code">Cost-covering Rent 1 =
VAR PossibleValues = GENERATESERIES(0, 10000, 1)
SUMX(
    'Property',
    VAR NPVNoRent = -1 * [NPV no rent]
    RETURN
    MINX(
        FILTER(
            PossibleValues,
            VAR ThisRent = [Value]
            VAR PVPRYear1 =
                SUMX(
                    FILTER('Year',
                        'Year'[YearNr] = 1
                        &amp;&amp; 'Year'[Year] 
                            &lt;= 'Property[End Year]
                    ),  
                ThisRent * (1 + [IndexY1 Value])
            ) 
            VAR PVPRYear2 =
            SUMX(
                FILTER('Year', 
                    'Year'[YearNr] = 2
                    &amp;&amp; 'Year'[Year] 
                        &lt;= 'Property[End Year]
                ),  
                ThisRent * POWER(1 + [IndexY1 Value], 2)
            )
            VAR PVPRYear3Plus =
            SUMX(
                FILTER('Year', 
                    'Year'[YearNr] &gt;= 3
                    &amp;&amp; 'Year'[Year] 
                        &lt;= 'Property[End Year]
                ),  
                ThisRent * POWER(1 + [IndexY1Value],
                                      'Year'[YearNr])
            )
            VAR PVPR = PVPRYear1 + PVPRYear2 + PVPRYear3Plus
            RETURN
            PVPR &gt;= NPVNoRent
        ),
        [Value]
    ) 
)
</code></pre>
    <p class="book-title--packt">To visualize <a id="calibre_link-504" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the result, we created a <a id="calibre_link-314" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>chart with possible rent values and a measure that computes the NPV for each rent value for a single property:</p>
    <figure class="mediaobject"><img src="images/000017.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.19: Cost-covering rent</p>
    <p class="book-title--packt">The zero NPV line intersects with the <strong class="screentext">NPV by rent</strong> line exactly at the cost-covering rent returned by the <code class="code-in-text--packt">Cost-covering Rent 1</code> measure, $3,779 in this case.</p>
    <h2 id="calibre_link-223" class="calibre8">Optimizing the approximation</h2>
    <p class="book-title--packt">While the calculated<a id="calibre_link-492" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> optimal rent is a good approximation, the calculation has a few drawbacks: first, the <a id="calibre_link-315" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>result is restricted to whole numbers, and second, for each property we have to do 10,000 NPV calculations, and that is assuming that all cost-covering rents are between 0 and 10,000.</p>
    <p class="book-title--packt">It is possible to optimize this approach. In <em class="italic">Figure 2.6.20</em>, a smaller section of the above chart is plotted. From this, it is clear that the value 3,779 is only an approximation. This may be good enough, but whether we need more precision, more possible values, or better performance, it is good to consider if we can reach the same result with fewer calculations.</p>
    <figure class="mediaobject"><img src="images/000036.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.20: A detailed view of cost-covering rent</p>
    <p class="book-title--packt">In <em class="italic">Figure 2.6.21</em>, a similar NVP chart is shown on values with an interval of 100. Between 0 and 10,000, this yields a list of only 101 values, which therefore needs far fewer calculations to traverse. </p>
    <p class="book-title--packt">Necessarily, the approximation is much less accurate.</p>
    <figure class="mediaobject"><img src="images/000058.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.6.21: Approximation with only a few data points</p>
    <p class="book-title--packt">The two highlighted data points are the ones with an NPV closest to zero out of this range. The approach is now to create a second series of possible rent values between these two; when <a id="calibre_link-316" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>we take 1/100 of the difference between the two rent <a id="calibre_link-493" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>values as the interval, we have again 101 possible values; but now, the interval is only 1 and we reach the same precision as before. This time, however, only 202 calculations need to be done to get there.</p>
    <p class="book-title--packt">We need quite some code to do this, primarily because the <code class="code-in-text--packt">PVPR</code> calculation must be done inside the formula. We have to implement it twice now: once to find the best two values from the "coarse" list, and again to calculate the values from the "fine" list. We start with the same setup as before:</p>
    <pre class="programlisting"><code class="hljs-code">Cost-covering Rent 2 =
VAR PossibleValuesCoarse = GENERATESERIES(0, 10000, 100)
RETURN
SUMX(
    'Property',
    VAR NPVNoRent = -1 * [NPV no rent]
</code></pre>
    <p class="book-title--packt">Instead of <a id="calibre_link-1386" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>searching for the value with the smallest <code class="code-in-text--packt">PVPR</code> that is still above <code class="code-in-text--packt">NPVNoRent</code>, we are now interested in two<a id="calibre_link-494" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> values <a id="calibre_link-781" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>where <code class="code-in-text--packt">PVPR</code> is closest to <code class="code-in-text--packt">NPVNoRent</code>.</p>
    <pre class="programlisting"><code class="hljs-code">    VAR Top2Values =
    TOPN(
        2,
        PossibleValuesCoarse,
        VAR ThisRent = [Value]
        VAR PVPRYear1 =
        SUMX(
            FILTER('Year', 
                'Year'[YearNr] = 1 
                &amp;&amp; 'Year'[Year] &lt;= 'Property[End Year]
            ),  
            ThisRent * (1 + [IndexY1 Value])
        ) 
        VAR PVPRYear2 =
        SUMX(
            FILTER('Year', 
                'Year'[YearNr] = 2
                &amp;&amp; 'Year'[Year] &lt;= 'Property[End Year]
            ),  
            ThisRent * POWER(1 + [IndexY1 Value], 2)
        )
        VAR PVPRYear3Plus =
        SUMX(
            FILTER('Year', 
                'Year'[YearNr] &gt;= 3
                &amp;&amp; 'Year'[Year] &lt;= 'Property[End Year]
            ),  
            ThisRent * POWER(1 + [IndexY1Value],
                                  'Year'[YearNr])
        )
        VAR PVPR = PVPRYear1 + PVPRYear2 + PVPRYear3Plus
        RETURN
        ABS(PVPR &ndash; NPVNoRent),
        ASC
    )
</code></pre>
    <p class="book-title--packt">Above, the <code class="code-in-text--packt">TOPN</code> function is used to<a id="calibre_link-1387" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> retrieve the two best values from the <code class="code-in-text--packt">PossibleValuesCoarse</code> list. The complex part is in the third <code class="code-in-text--packt">TOPN</code> argument: the expression that is <a id="calibre_link-317" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>evaluated for each row in the list. This is where the <code class="code-in-text--packt">PVPR</code> calculation goes. To find the best two values, the values for which the NPV is closest to zero, we<a id="calibre_link-495" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> take the absolute <a id="calibre_link-782" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>value of the difference between the <code class="code-in-text--packt">PVPR</code> and the other part of the NPV: <code class="code-in-text--packt">ABS(PVPR &ndash; NPVNoRent)</code>. Note that we use <code class="code-in-text--packt">ASC</code> as the fourth argument for <code class="code-in-text--packt">TOPN</code> to find the values with the smallest result.</p>
    <p class="book-title--packt">We now have a list with the two best possible values, and we are going to use these values to create the fine list of possible values. We cannot use a basic aggregation to retrieve the values from the <code class="code-in-text--packt">Top2Values</code> list: a function like <code class="code-in-text--packt">MIN</code> needs a column reference, and the <code class="code-in-text--packt">Top2Values</code> variable<a id="calibre_link-1726" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> does not have a table name. But we can use table aggregations:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR Value1 = MINX(Top2Values, [Value])
    VAR Value2 = MAXX(Top2Values, [Value])
    VAR PossibleValuesFine = 
    GENERATESERIES(
        Value1,
        Value2,
        (Value2 &ndash; Value1) / 100
    )
</code></pre>
    <p class="book-title--packt">We take the smallest <code class="code-in-text--packt">Value</code> in <code class="code-in-text--packt">Top2Values</code> for <code class="code-in-text--packt">Value1</code> and the largest for <code class="code-in-text--packt">Value2</code>. The fine possible <a id="calibre_link-1727" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>values list is created with <code class="code-in-text--packt">GENERATESERIES</code> again, now using 1/100 of the difference between the two values to create another 101 values on a finer scale.</p>
    <p class="book-title--packt">With the finer scale, we can now continue as before:</p>
    <pre class="programlisting"><code class="hljs-code">    RETURN
    MINX(
        FILTER(
            PossibleValuesFine,
            VAR ThisRent = [Value]
            VAR PVPRYear1 =
                SUMX(
                    FILTER('Year', 
                        'Year'[YearNr] = 1
                        &amp;&amp; 'Year'[Year] 
                            &lt;= 'Property[End Year]
                    ),  
                    ThisRent * (1 + [IndexY1 Value])
            ) 
            VAR PVPRYear2 =
            SUMX(
                FILTER('Year', 
                        'Year'[YearNr] = 2
                        &amp;&amp; 'Year'[Year] 
                            &lt;= 'Property[End Year]
                ),  
                ThisRent * POWER(1 + [IndexY1 Value], 2)
            )
            VAR PVPRYear3Plus =
            SUMX(
                FILTER('Year', 
                        'Year'[YearNr] &gt;= 3
                        &amp;&amp; 'Year'[Year] 
                            &lt;= 'Property[End Year]
                ),  
                ThisRent * POWER(1 + [IndexY1Value],
                                      'Year'[YearNr])
            )
            VAR PVPR = PVPRYear1 + PVPRYear2 + PVPRYear3Plus
            RETURN
            PVPR &gt;= NPVNoRent
        ),
        [Value]
    ) 
)
</code></pre>
    <p class="book-title--packt">When you look at the code, you will see that we traverse twice a list of 101 possible rent values to calculate the result. This is much better than the 10,000 items we had to check before!</p>
    <p class="book-title--packt">If you are willing to write even more code, you could further optimize the measure by, for instance, creating <a id="calibre_link-496" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>lists of 10 possible values four times, zooming in from an interval between values <a id="calibre_link-318" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of 1,000, to 100, to 10, to 1. Or even go further and add a precision of 0.1, while still only doing <a id="calibre_link-783" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>about 50 evaluations.</p>
    <p class="book-title--packt">Note that we haven't used the upward slope of the <strong class="screentext">NPV by rent</strong> chart in this approach: even with a complex, non-linear function, you can use this approach to approximate the lowest or highest value. There is a restriction, of course: the function should have an optimum within the range you consider. </p>
    <p class="book-title--packt">With multiple (local) optima, you risk finding a suboptimal one. But by then, you are doing more advanced maths.</p>
    <p class="book-title--packt">Another note: there are only a few constants in this formula, being the lower and upper limit of the coarse possible values list, and the number of points to consider within a range. You may choose to create what-if parameters to set these limits dynamically. This would enable you to <a id="calibre_link-319" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>create a dashboard where the user can try another<a id="calibre_link-497" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> range when the cost-covering rent is on the edge of the investigated range, which suggests that the real value is outside of that range.</p>
    <h1 id="calibre_link-224" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, you have learned about financial metrics for analyzing the future of investments. We have discussed Future Value, Present Value, Net Present Value, and Internal Rate of Return, all of which are common metrics that are used by investment analysts around the world. They are so common that DAX offers some specific functions to calculate them: <code class="code-in-text--packt">XNPV</code> and <code class="code-in-text--packt">XIRR</code>.</p>
    <p class="book-title--packt">In creating a model for dynamic financial analysis, you have learned how to use what-if parameters in complex calculations. We have seen that the NPV metric can be computed without the <code class="code-in-text--packt">XNPV</code> function as well, which opens up additional possibilities to view results at a lower level of detail than the all-up NPV.</p>
    <p class="book-title--packt">The IRR is a metric that is not easily calculated, and an approximative method is needed to find a "good enough" result. This is what the <code class="code-in-text--packt">XIRR</code> function implements. We have presented an alternative approach through DAX which, although without much added value in calculating IRR, proved to be very useful in calculating another metric: the cost-covering rent. This approach is applicable to many other scenarios in which exact solutions are not possible to calculate.</p>
    <p class="book-title--packt">In the next chapter, we are going to focus on analyzing status-oriented data, with inventory management as the main example.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-260">
<div id="calibre_link-1728" class="calibre2">
<div id="calibre_link-1729" class="calibre3"><div id="calibre_link-1730" class="calibre4">
    <h1 class="chapternumber">2.7</h1>
    <h1 id="calibre_link-225" class="title">Inventory Analysis</h1>
    <p class="book-title--packt">This chapter is all about analyzing inventory levels and changes in inventory. This is a specific kind of analysis, as we are interested in the <em class="italic">status</em> of something, in this case inventory quantity or value, at a specific point in time.</p>
    <p class="book-title--packt">An inventory report could provide insights into how inventory levels vary over time, and which products risk running out of inventory. And, on the other side of the spectrum, you may have simply too much inventory for a product relative to its turnover speed &ndash; although the question "<em class="italic">how much inventory is too much?</em>" is not a simple one to answer. As an example, in this chapter, we will calculate the number of products that are likely to be still in stock twelve months from now, given a sales forecast. It may seem obvious that products that are on the shelves for a year could have been produced or purchased later, saving the company money.</p>
    <p class="book-title--packt">Although this chapter uses product inventory for our beloved QuantoBikes company as an example, the kind of calculation discussed here is not just useful for inventory. You can apply the same kind of analysis on any metric for which the status at a specific point in time is relevant, like patients in a hospital, cars in a city's network of parking lots, a financial balance, or even water levels in a river delta. A more advanced analysis could incorporate the use of AI to <em class="italic">predict</em> changes in the statuses instead of working with a forecast, but that will not be covered in this book.</p>
    <p class="book-title--packt">This chapter will cover these topics:</p>
    <ul class="calibre9">
      <li class="bullet">Data modeling for status-oriented data</li>
      <li class="bullet">Basic inventory calculations</li>
      <li class="bullet">Inventory forecasting</li>
    </ul>
    <h1 id="calibre_link-226" class="title">Data modeling for status-oriented data</h1>
    <p class="book-title--packt">First, a <a id="calibre_link-557" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>discussion is needed on different ways to <a id="calibre_link-1281" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>model data for which status is the determining factor. In the real world, how data is modeled is typically a trade-off between what is best for the Power BI model and what is achievable from a data preparation point of view. Here, we focus on what would be best for the model; if you apply this for your organization, you may find that data preparation efforts weigh in more heavily. </p>
    <p class="book-title--packt">In deciding what the facts in the model will be, you have two basic options:</p>
    <ol class="calibre9">
      <li class="calibre12">Store the <em class="italic">status</em> for each unit of time, usually each day.</li>
      <li class="calibre12">Store the <em class="italic">changes</em> in the status.</li>
    </ol>
    <p class="book-title--packt">The first option may seem the most straightforward. We just store one data point per day, per product: </p>
    <figure class="mediaobject"><img src="images/000142.png" alt="A picture containing chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.1: Storing the status of inventory</p>
    <p class="book-title--packt">There are, however, a <a id="calibre_link-1731" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>number of issues with this option that you <a id="calibre_link-1732" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>need to take care of if you choose to model this way:</p>
    <ul class="calibre9">
      <li class="bullet">Most source systems store inventory transactions rather than the inventories themselves, which means that you need to put a lot of work into preparing your data. Either you have to compute the current inventory for every point in time needed, or, if the source system does provide inventories, you must use an intermediate data store to build up a history of inventory levels. </li>
      <li class="bullet">This way of modeling the data is heavily dependent on the unit of time chosen. If, say, it is decided that inventory levels only need to be known once a month, it will be difficult to change that into once a day. And similarly, if the data is stored at once-a-day granularity, it is virtually impossible to change that into one-hour granularity.</li>
      <li class="bullet">Depending on the time interval chosen, a lot of data may be stored while nothing is really happening. For products that do not have any transactions for some time, identical copies of status data will be stored during that period.</li>
      <li class="bullet">From the perspective of a Power BI model, the fact table is typically related to a calendar table. With this modeling approach, you cannot simply select a month, for instance, and retrieve the inventory level: you need to take care to only select one point in time for which to retrieve the inventory.</li>
    </ul>
    <p class="book-title--packt">The second option, using <a id="calibre_link-558" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>changes in status, like inventory<a id="calibre_link-1282" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> transactions as facts, solves many of the issues with the first approach. In the data, we would have two types of data points: data that represents the initial status (the dot in the figure below) and data that represents any transaction that takes from or adds to inventory (the results of which are visualized by the dotted line):</p>
    <figure class="mediaobject"><img src="images/000161.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.2: Storing the status once, and changes after that</p>
    <p class="book-title--packt">This approach comes with its own issues, though:</p>
    <ul class="calibre9">
      <li class="bullet">You cannot just use transactions to find a specific inventory level: you need to have a reference level to work from. In some scenarios, this reference is readily available; a financial balance sheet, for instance, is typically computed at the end of the fiscal year and can then be used as the starting point for the new year. But for products in warehouses, things are less straightforward.</li>
      <li class="bullet">Assuming you have a reference level, you still need to do some work to calculate the inventory level at a specific point in time: you need to start with the reference and add or subtract all transactions up to the point you are interested in. Luckily, this is something DAX is particularly good at.</li>
    </ul>
    <p class="book-title--packt">Based on the<a id="calibre_link-559" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> issues above, we commonly choose to use<a id="calibre_link-1283" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> inventory <em class="italic">transactions</em> as facts in a Power BI model. But we still need to deal with the reference level somehow. Again, we have several options for how to solve this:</p>
    <ul class="calibre9">
      <li class="bullet">Store the initial inventory level for each product, or (plausibly) assume it to start at zero. This is the option depicted in <em class="italic">Figure 2.7.2</em>. There are two major problems with this: first, you would be forced to store all transactions for each product, even when a product was introduced 20 years ago; second, the reference level would be found at a different point in time for each product. The consequence of this is that you could only calculate the total inventory by iterating over the products and calculating inventory by individual product. So, this option would not only lead to a humongous model, but also to inefficient DAX code. </li>
      <li class="bullet">Store the initial inventory level at fixed points in time for each product, like at the start of each year; see <em class="italic">Figure 2.7.3</em>. This is a much better approach, as we can select the reference level for all products at once and use efficient aggregations to compute actual inventory levels. The drawback of this approach is that you will probably store multiple copies of reference levels (one for each year, for example), and your DAX code will need to determine where the relevant reference level can be found, and ignore other references and transactions before the right reference level.<figure class="mediaobject"><img src="images/000183.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
      </li>
    </ul>
    <p class="book-title--packt">Figure 2.7.3: Storing the status regularly, and changes in between</p>
    <ul class="calibre9">
      <li class="bullet">The third option, and this is the one we will use, is to store reference levels for all products at <em class="italic">the most recent</em> point in time; see <em class="italic">Figure 2.7.4</em>. From a DAX perspective, this is an attractive way to model the data, as it is easy to calculate inventory levels at any point in time. <p class="bullet1">We discuss this after the figure:</p>
        <figure class="mediaobject"><img src="images/000205.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
      </li>
    </ul>
    <p class="book-title--packt">Figure 2.7.4: Storing the latest status, and transactions leading up to it</p>
    <p class="book-title--packt">To calculate an inventory level at point-in-time <em class="italic">T</em>, you need to take the reference level and <em class="italic">subtract</em> all <a id="calibre_link-560" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>transactions from point <em class="italic">T</em> onward. For instance, if <a id="calibre_link-1284" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the reference is 200, new inventory was added yesterday, say 100 units, and 30 units were sold four days ago (this would be modeled as a transaction of -30 units), the inventory one week ago was 130 units. To make calculations even easier, you can multiply each transaction's numbers by -1; incoming transactions would then be negative (-100 in the example above) and outgoing transactions positive (30). The inventory one week ago can then be calculated by simply adding everything after that: -100, plus 30, plus 200. </p>
    <p class="book-title--packt">This way of modeling the inventory has the added benefit that reference levels of old products, which are no longer in stock, do not have to be stored: they will show up in the result automatically when you look back far enough to hit a transaction on such a product. After all, the current inventory for these products will be zero (or blank); if, for instance, the last outgoing transaction was two years ago for 25 units (stored as -25), the result of the calculation for a point in time just before two years ago would be 25 units.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">As mentioned earlier, this modeling option may not be the optimal choice when it comes to data preparation efforts: it can be quite a challenge to retrieve current inventory levels when the source systems do not readily provide these. That said, an argument can be made that an optimal model structure should be prioritized. After all, an efficient Power BI model is best for the users of the reports.</p>
      <p class="book-title--packt">Based on the calculations in this chapter, you could try another option yourself: store the most recent reference level and add transactions after that with negative amounts. This will allow for calculating inventory levels after the most recent reference level, but will add complexity to the calculations.</p>
    </div>
    <p class="book-title--packt">With the above <a id="calibre_link-561" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>considerations, the model for <a id="calibre_link-1285" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>QuantoBikes' inventory analysis looks like the figure below. Commonly, inventory is managed by <strong class="screentext">SKU</strong>, or <strong class="screentext">stock-keeping unit</strong>, the official name for what is <a id="calibre_link-1287" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>actually lying on the shelf, while "product" may be a grouping of several SKUs in your case. As grouping is a straightforward concept in DAX, we will use <em class="italic">SKU</em> and <em class="italic">product</em> interchangeably in this chapter.</p>
    <figure class="mediaobject"><img src="images/000086.png" alt="Graphical user interface, diagram, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.5: The inventory model</p>
    <p class="book-title--packt">The central fact table, <code class="code-in-text--packt">fInventory</code>, contains both the reference levels and inventory transactions. To distinguish the two, the <code class="code-in-text--packt">Type</code> column contains a 0 for reference levels and a 1 for transactions. In both cases, the <code class="code-in-text--packt">Quantity</code> column contains the number of products in stock or partaking in the transaction, respectively.</p>
    <p class="book-title--packt">The fact table is linked to relevant filter tables: <code class="code-in-text--packt">Warehouse</code>, <code class="code-in-text--packt">SKU</code>, and <code class="code-in-text--packt">Calendar</code>. You may have additional filters on this level, like transaction types that provide more detail on the transactions, vendors for purchased products, customers for inventory transactions that involve shipping products to customers, and so on.</p>
    <p class="book-title--packt">To manage<a id="calibre_link-562" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> inventory, additional fact tables can be <a id="calibre_link-1286" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>added. For instance, if we add a <code class="code-in-text--packt">fSalesForecast</code> table containing forecasted sales by product, these can be used as forecasted outward inventory transactions. We may also have inventory targets, like minimum stock levels, in <code class="code-in-text--packt">fInventoryTargets</code>.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can download the model used in this chapter, <code class="code-in-text--packt">2.7 Inventory.pbix</code>, from GitHub at <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.7" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.7</span></a>.</p>
    </div>
    <h2 id="calibre_link-227" class="calibre8">Inventory granularity</h2>
    <p class="book-title--packt">Before we dive into the analysis, we need to discuss the issue of <strong class="screentext">granularity</strong>, or detail level, of our facts. We have stored our actual inventory at a fairly low detail level: transactions on individual SKUs in individual warehouses. Additional facts may or may not be available on the same level of SKU/warehouse. </p>
    <p class="book-title--packt">The same<a id="calibre_link-910" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> is true, of course, for the time dimension: it is not likely that we have sales forecasts on a daily level, while we do have daily inventory data. It doesn't make much sense to make daily comparisons to a monthly forecast; and in our analysis, both in DAX measures and visual reports, we will have to deal with this discrepancy. In a Power BI model, facts with a lower granularity than days are usually mapped to a day in the <code class="code-in-text--packt">Calendar</code> table anyway. So, you may map the sales forecast for February to February 1. As long as your report shows results by month as the most detailed view, you will not notice this. You still need to be aware that you did this, though, as some calculations may work with data on the day level even when they are retrieved in a month-based context.</p>
    <p class="book-title--packt">For SKUs, it works in exactly the same manner. You may have sales forecasts on the SKU level, but it is more probable that forecasts are provided at a coarser granularity, like product or product category. This can be dealt with in the same way as with the <code class="code-in-text--packt">Calendar</code> table, although it is less common to map the higher-level fact to a single SKU.</p>
    <p class="book-title--packt">It is the <code class="code-in-text--packt">Warehouse</code> granularity that we need to take extra care of, from a functional perspective. Here, we have a business decision to make, as multiple warehouses may be in the same physical location or in close proximity to each other. This means that when one warehouse runs out of stock for a specific SKU, another warehouse may step in and fulfill orders for that SKU. From the perspective of our analyses, it means that choosing the level at which to calculate, for instance, forecasted stock levels, is fundamental to the outcome. </p>
    <p class="book-title--packt">And, as inventory analysis is inherently not suited for aggregating everything (we will need to do most of our calculations on a by-warehouse basis), the level chosen impacts<a id="calibre_link-911" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the fundamental structure of the DAX code. It is the difference between, say:</p>
    <pre class="programlisting"><code class="hljs-code">SUMX(
    VALUES(Warehouse[Warehouse]),
    ...
</code></pre>
    <p class="book-title--packt">And:</p>
    <pre class="programlisting"><code class="hljs-code">SUMX(
    VALUES(Warehouse[City]),
    ...
</code></pre>
    <p class="book-title--packt">In dealing with these detail levels, you may opt to let the report users choose the detail, by providing a level slicer<a id="calibre_link-1482" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> or just different pages in the report, or you may try to derive the level needed from the context; for instance, when a single warehouse is selected, you could conclude that it doesn't make sense to do the calculation on the level of <code class="code-in-text--packt">City</code>.</p>
    <h1 id="calibre_link-228" class="title">Basic inventory calculations</h1>
    <p class="book-title--packt">Let us start by answering <a id="calibre_link-906" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the most basic question: what is the actual inventory? Because of the way we have modeled our data, this one is easy to do:</p>
    <pre class="programlisting"><code class="hljs-code">Actual Inventory =
CALCULATE(
    SUM(fInventory[Quantity]),
    fInventory[Type] = 0
)
</code></pre>
    <p class="book-title--packt">All we need to do is retrieve the rows with <code class="code-in-text--packt">[Type] = 0</code>, as it is in those where the actual inventory is stored.</p>
    <p class="book-title--packt">There is one issue with this calculation, however: it assumes that we have selected the whole of the <code class="code-in-text--packt">Calendar</code> table, or at least made a selection that includes the date with the <code class="code-in-text--packt">Type</code> 0 rows. After all, when we select last year, the rows containing the current inventory will not be selected. It would be better to create a measure that returns a result for any selection on <code class="code-in-text--packt">Calendar</code>.</p>
    <p class="book-title--packt">If we assume that we have<a id="calibre_link-1733" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> some selection in <code class="code-in-text--packt">Calendar</code>, the first question to ask is: which exact date do we pick to return the status for? After all, the inventory status is strictly date-specific. </p>
    <p class="book-title--packt">The common practice is to take the latest date in the selection for this: <code class="code-in-text--packt">MAX('Calendar'[Date])</code>. But this raises a problem for selections that extend beyond the reference date with the latest inventory status (typically today's, or yesterday's, inventory). Let us put this in a diagram:</p>
    <figure class="mediaobject"><img src="images/000042.png" alt="A picture containing text, antenna  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.6: Three Calendar selections</p>
    <p class="book-title--packt">In this diagram, three different <code class="code-in-text--packt">Calendar</code> selections are depicted:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">When the complete selection is before the reference date, taking the latest date will work fine.</li>
      <li class="calibre12">When the reference date falls within the selection, we should not take the latest date but the reference date instead; after all, the inventory status will be calculated by aggregating all transactions <em class="italic">after</em> the status's date (including the reference status), so taking a date after the reference date will return nothing.</li>
      <li class="calibre12">When the complete selection falls after the reference date, we cannot effectively return inventory (it's the future, typically), so taking the latest date in the selection will do: the result will be blank.</li>
    </ol>
    <p class="book-title--packt">In addition to these options, we have to deal with another, special case, which may occur more often than you think: an <em class="italic">empty</em> <code class="code-in-text--packt">Calendar</code> selection. Taking <code class="code-in-text--packt">MAX('Calendar'[Date])</code> would return a blank value, and aggregating all transactions after it does effectively return the aggregation of the complete transaction table. This is because DAX translates blank to zero when doing comparisons. </p>
    <p class="book-title--packt">The DAX formula for inventory thus starts with setting up some variables for important dates in the calculation:</p>
    <pre class="programlisting"><code class="hljs-code">Inventory Qty = 
VAR MaxDate = MAX('Calendar'[Date])
VAR RefDate = 
CALCULATE(
    MAX(fInventory[Date]),
    ALL('Calendar'),
    fInventory[Type] = 0
)
</code></pre>
    <p class="book-title--packt">Note that we<a id="calibre_link-907" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> need to use <code class="code-in-text--packt">ALL('Calendar')</code> to remove filters from <code class="code-in-text--packt">Calendar</code>, as we need to retrieve the reference date, which may fall outside of the current selection. We also filter on <code class="code-in-text--packt">Type = 0</code>, although you may omit this when you have modeled your date in such a way that no inventory transactions are included with a date after&nbsp;the reference date, ever.</p>
    <p class="book-title--packt">In the remainder of the code, we use <a id="calibre_link-1331" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <code class="code-in-text--packt">SWITCH</code> function to detect which of the four scenarios we are dealing with. As the criteria are not uniform, we use the <code class="code-in-text--packt">SWITCH(TRUE(),...)</code> construct we have seen before, which makes <code class="code-in-text--packt">SWITCH</code> select the&nbsp;first statement that is true:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SWITCH(
    TRUE(),
    -- empty selection
    ISBLANK(MaxDate),
        BLANK(),
    -- reference date falls within selection
    CONTAINS(VALUES('Calendar'[Date]), 'Calendar'[Date], RefDate),
        CALCULATE(
            SUM(fInventory[Quantity]),
            ALL('Calendar'),
            fInventory[Type] = 0
        ),
    -- else
    CALCULATE(
        SUM(fInventory[Quantity]),
        ALL('Calendar'),
        'Calendar'[Date] &gt; MaxDate
    )
)
</code></pre>
    <p class="book-title--packt">The function <code class="code-in-text--packt">CONTAINS</code> determines<a id="calibre_link-489" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> if a value (<code class="code-in-text--packt">RefDate</code>, in our case) is found in a column (<code class="code-in-text--packt">'Calendar'[Date]</code>) of a table (<code class="code-in-text--packt">VALUES('Calendar'[Date])</code>), and is therefore particularly suitable for what we need here. Note that in this case, we don't need to take any transactions into account, but can <a id="calibre_link-1483" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>focus only on the reference status.</p>
    <p class="book-title--packt">There is a subtle distinction to be made here. You may have expected to see this calculation in the "else" clause of the <code class="code-in-text--packt">SWITCH</code>:</p>
    <pre class="programlisting"><code class="hljs-code">    CALCULATE(
        SUM(fInventory[Quantity]),
        ALL('Calendar'),
        'Calendar'[Date] = RefDate
    ),
</code></pre>
    <p class="book-title--packt">After all, we just retrieved the reference date and we know that that is where the reference status is found, right? The catch is that there may also be inventory transactions on the same day. So, filtering on the date will aggregate both the reference status and the transactions for that day, returning the inventory status <em class="italic">at the start of the day</em> (or the end of the previous day). It is important to apply the same logic as in the case that the selection is completely in the past; when we, for instance, retrieve inventory status for April 15, 2021:</p>
    <pre class="programlisting"><code class="hljs-code">    'Calendar'[Date] &gt; DATE(2021, 4, 15)
</code></pre>
    <p class="book-title--packt">What we <a id="calibre_link-908" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>actually compute is the status at the end of that day. A simple example makes it clear: if I sold 50 items today, and my current inventory is 100 (at the end of today), I must have started the day with an inventory of 150, which is by definition the inventory at the end of yesterday.</p>
    <p class="book-title--packt">Another thing to learn from this is that we must store the reference inventory status as the inventory at the end of the day. </p>
    <p class="book-title--packt">The figure below shows sample output for a set of warehouses, with reference levels stored at July 14, 2021:</p>
    <figure class="mediaobject"><img src="images/000191.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.7: Chart of inventory levels by warehouse</p>
    <p class="book-title--packt">As an exercise, try to <a id="calibre_link-1734" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>understand why the <a id="calibre_link-1332" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>formula does not return results for August 2021 and later. Hint: in which clause of the <code class="code-in-text--packt">SWITCH</code> expression does selection 3 (in <em class="italic">Figure 2.7.6</em>) land?</p>
    <h2 id="calibre_link-229" class="calibre8">Inventory targets</h2>
    <p class="book-title--packt">When your business <a id="calibre_link-912" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>depends on being able to sell products from your inventory, you do not want products to run out of stock. This means that you need to find a way to make sure you have enough inventory. At the same time, products on shelves cost money, and having too much inventory harms your business as well. You must therefore find a way to balance your inventory versus your sales.</p>
    <p class="book-title--packt">The simplest way to do this is to have an inventory target. With this, you provide a target quantity for each product in each warehouse, wherever relevant. In this section, we discuss a straightforward way to compute targets and compare the actual inventory levels with the targets. Later in this chapter, we will take a more sophisticated approach, taking into account sales forecast and/or product run rate.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Inventory management typically works with minimum stock levels and restock levels; when inventory comes below the minimum level, stock is replenished so that it returns to the restock level. As this chapter is not purely about inventory management, we will stick with the generic term <em class="italic">target</em>. The principles implemented in the calculations in this chapter can be adapted to specific scenarios without too much effort. </p>
    </div>
    <p class="book-title--packt">Let us assume we <a id="calibre_link-1735" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have a yearly inventory target for our products. In other words, for each year, and each product/warehouse combination that is relevant to us, we register the target level. As discussed earlier, the common way to model this is to map the year onto a specific date in that year, like January 1. We store the targets in a fact table, <code class="code-in-text--packt">fInvTarget</code>. Like the <code class="code-in-text--packt">fInventory</code> table, <code class="code-in-text--packt">fInvTarget</code> has relationships with the <code class="code-in-text--packt">Warehouse</code>, <code class="code-in-text--packt">SKU</code>, and <code class="code-in-text--packt">Calendar</code> table.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt"><strong class="screentext">Warning</strong>: When your analysis takes into account working days, excluding weekends and holidays, choosing January 1 may cause you to lose the targets altogether! In this case, choose a date that is certain to be a working day &ndash; which may be a bit harder to accomplish.</p>
    </div>
    <p class="book-title--packt">Here is what the extended model looks like:</p>
    <figure class="mediaobject"><img src="images/000011.png" alt="Graphical user interface  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.8: Model structure including inventory targets</p>
    <p class="book-title--packt">The target quantity can be computed with the formula below:</p>
    <pre class="programlisting"><code class="hljs-code">Target Qty =
CALCULATE(
    SUM(fInvTarget[Quantity]),
    ALL('Calendar'),
    VALUES('Calendar'[Year])
)
</code></pre>
    <p class="book-title--packt">Keep in mind that our context may include a filter on a different column in <code class="code-in-text--packt">Calendar</code> than <code class="code-in-text--packt">Year</code>, like <code class="code-in-text--packt">YearMonth</code>. If the selection through this filter comes down to, for instance, September 2021, there is no way to get to a selection of the whole year (including the date the targets are mapped to) other than to remove all filters from <code class="code-in-text--packt">Calendar</code> and to "feed" the selected <code class="code-in-text--packt">Year</code> values <a id="calibre_link-1484" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>back into the context. This is done here with the <code class="code-in-text--packt">VALUES</code> function.</p>
    <p class="book-title--packt">Moving on to <a id="calibre_link-913" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>comparing the inventory levels with the targets, your first guess might be a calculation like this:</p>
    <pre class="programlisting"><code class="hljs-code">Inventory balance = [Inventory Qty] &ndash; [Target Qty]
</code></pre>
    <p class="book-title--packt">Unfortunately, this will not yield useful results. This calculation compares the <em class="italic">total</em> inventory with the <em class="italic">total</em> target, and while we may have enough stock on a global level, that doesn't mean that individual warehouses, or entire cities or regions, have enough.</p>
    <p class="book-title--packt">What we need to do is compare actual inventory with targets on a more detailed level, and aggregate that in some way that doesn't obscure the details. When you think about it, it is not even enough to do the calculation on the individual warehouse level; instead, we need to do it on the individual SKU level. (We assume that our targets are set on the SKU level as well, although it is probable that a higher level in the product hierarchy is used. That would only call for a simple change in the formulas, though.)</p>
    <p class="book-title--packt">Another consideration is that when we <a id="calibre_link-529" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>aggregate these results, we do not want warehouses that have a surplus in inventory to compensate for warehouses that have a deficiency. The best way to deal with this is to use two separate measures: one that computes the surplus, and another that calculates the quantities below target. These measures are easy variations on a single theme.</p>
    <p class="book-title--packt">To calculate the difference between actual and target inventory by warehouse and product, you may use this formula:</p>
    <pre class="programlisting"><code class="hljs-code">Actual vs Target Qty 1 =
SUMX(
    Warehouse,
    SUMX(
        SKU,
        [Inventory Qty] &ndash; [Target Qty]
    )
)
</code></pre>
    <p class="book-title--packt">Alternatively, we can do the same thing with just one iterator by using <code class="code-in-text--packt">CROSSJOIN</code>:</p>
    <pre class="programlisting"><code class="hljs-code">Actual vs Target Qty 2 =
SUMX(
    CROSSJOIN(Warehouse, SKU),
    [Inventory Qty] &ndash; [Target Qty]
)
</code></pre>
    <p class="book-title--packt">Both formulas <a id="calibre_link-914" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>suffer from the same issue: we let DAX do a lot of calculations that may not be needed. When we compute the overall result, <code class="code-in-text--packt">SUMX</code> needs to iterate over a table of the number of warehouses times the number of SKUs. Another, more subtle issue is: what happens with inventory on SKUs that we don't have a target for? In this case, <code class="code-in-text--packt">[Target qty]</code> is <code class="code-in-text--packt">BLANK</code>, which is treated as zero in the subtraction, so the complete actual quantity is taken in the aggregation. This is probably not what we want.</p>
    <p class="book-title--packt">Both issues can be addressed by only taking warehouse/SKU combinations into account for which a target is available. You can do this with the following expression:</p>
    <pre class="programlisting"><code class="hljs-code">FILTER(
    CROSSJOIN(Warehouse, SKU),
    [Target qty] &gt; 0
)
</code></pre>
    <p class="book-title--packt">However, using <code class="code-in-text--packt">FILTER</code> here still forces DAX to <a id="calibre_link-530" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>compute the target quantity for each warehouse/SKU combination, only to determine which <a id="calibre_link-1301" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>combinations should be selected! The better option is to use <code class="code-in-text--packt">SUMMARIZE</code>:</p>
    <pre class="programlisting"><code class="hljs-code">SUMMARIZE(
    fInvTarget,
    Warehouse[WarehouseNr],
    SKU[SKUNr]
)
</code></pre>
    <p class="book-title--packt"><code class="code-in-text--packt">SUMMARIZE</code> can be used to retrieve the unique <a id="calibre_link-784" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>combinations of values from multiple columns in a table, but allows for using columns from related tables as well. In our case, <code class="code-in-text--packt">SUMMARIZE</code> returns the unique warehouse/SKU combinations that appear in the <code class="code-in-text--packt">fInvTarget</code> table: exactly what we want. It has the <a id="calibre_link-449" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>additional benefit that we now have a table of only two columns, instead of the crossjoin of two <em class="italic">entire</em> tables.</p>
    <p class="book-title--packt">But be warned! Using <code class="code-in-text--packt">SUMMARIZE</code> to retrieve the combinations will take into account all other filters affecting <code class="code-in-text--packt">fInvTarget</code>. As our yearly targets are mapped onto January 1, the result of <code class="code-in-text--packt">SUMMARIZE</code> will be empty when, for instance, only February is selected. You have already seen how to solve that:</p>
    <pre class="programlisting"><code class="hljs-code">CALCULATETABLE(
    SUMMARIZE(
        fInvTarget,
        Warehouse[WarehouseNr],
        SKU[SKUNr]
    ),
    ALL('Calendar'),
    VALUES('Calendar'[Year])
)
</code></pre>
    <p class="book-title--packt">We will store this<a id="calibre_link-915" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> table in a <a id="calibre_link-450" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>variable. The calculation for inventory surplus versus target then looks like this:</p>
    <pre class="programlisting"><code class="hljs-code">Surplus vs Target Qty =
VAR WarehouseSKUCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInvTarget,
            Warehouse[WarehouseNr],
            SKU[SKUNr]
        ),
        ALL('Calendar'),
        VALUES('Calendar'[Year])
    )
RETURN
SUMX(
    WarehouseSKUCombinations,
    MAX([Inventory Qty] &ndash; [Target Qty], 0)
)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">MAX</code> expression provides a<a id="calibre_link-1302" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> zero when <a id="calibre_link-1485" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the inventory is below target, by which the measure effectively returns only the surplus. To compute the total deficiency, you reverse the calculation by excluding the positive outcomes (returning a negative value for deficiency):</p>
    <pre class="programlisting"><code class="hljs-code">    MIN([Inventory Qty] &ndash; [Target Qty], 0)
</code></pre>
    <p class="book-title--packt">Or alternatively, to return the deficiency as a positive value:</p>
    <pre class="programlisting"><code class="hljs-code">    MAX([Target Qty] &ndash; [Inventory Qty], 0)
</code></pre>
    <p class="book-title--packt">The chart<a id="calibre_link-1736" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> below shows the inventory surplus <a id="calibre_link-1002" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and deficiency over time, as well as the target level and the actual inventory (note that these are plotted on a second <em class="italic">y</em>-axis at the right). </p>
    <p class="book-title--packt">As the target is a single value for the whole year, it is shown as a horizontal line in the chart.</p>
    <figure class="mediaobject"><img src="images/000162.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.9: Chart of inventory versus target</p>
    <p class="book-title--packt">The measures described here calculate the surplus and deficiency at the individual warehouse level. We may assume that warehouses in close proximity of each other can help compensate for stock shortages; if this is the case, it makes sense to do the calculation not on the warehouse level, but on the city level. After all, when the total inventory is above the total <a id="calibre_link-1303" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>inventory target for the city, all warehouses could jointly provide the products needed. </p>
    <p class="book-title--packt">Changing the calculation to the level of cities is a simple change in the <code class="code-in-text--packt">SUMMARIZE</code> expression:</p>
    <pre class="programlisting"><code class="hljs-code">    SUMMARIZE(
        fInvTarget,
        Warehouse[City],
        SKU[SKUNr]
    )
</code></pre>
    <p class="book-title--packt">We should, however, take<a id="calibre_link-916" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> into account that the context may be a selection of just one warehouse. In any case, the measure should return the surplus for the city as a whole. </p>
    <p class="book-title--packt">So, we must force the context to be whole<a id="calibre_link-1486" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> cities, in the same way we changed context to whole years earlier:</p>
    <pre class="programlisting"><code class="hljs-code">Surplus vs Target qty by City =
CALCULATE(
    VAR CitySKUCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInvTarget,
            Warehouse[City],
            SKU[SKUNr]
        ),
        ALL('Calendar'),
        VALUES('Calendar'[Year])
    )
    RETURN
    SUMX(
        CitySKUCombinations,
        MAX([Inventory qty] &ndash; [Target qty], 0)
    ),
    ALL(Warehouse),
    VALUES(Warehouse[City])
)
</code></pre>
    <p class="book-title--packt">Now, the measure will <a id="calibre_link-1304" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>return the city results for both individual warehouses and cities.</p>
    <h1 id="calibre_link-230" class="title">Inventory forecasting</h1>
    <p class="book-title--packt">You have now seen <a id="calibre_link-909" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>some examples of inventory calculations. In some way, the measures describe a static view of inventory: the quantities at a specific point in time, and the differences compared to a fixed inventory target level. In reality, inventory is constantly in flux: products are shipped from our <a id="calibre_link-451" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>warehouses, and new products come in from manufacturing. It is therefore more interesting to take turnover speed into account when we analyze inventory. And as the real business value comes from balancing our inventory levels as exactly as possible with our sales, we want to have some way of looking into the future of our inventory. In other words, what we want is an inventory forecast.</p>
    <h2 id="calibre_link-231" class="calibre8">Two types of forecast</h2>
    <p class="book-title--packt">There are, of course, many <a id="calibre_link-816" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>ways to get a prediction of the future state of inventory. We will cover two options here: first, using a sales forecast that is provided by salespeople, and second, extrapolating changes in the inventory that have occurred in the past. You may also use AI modeling to make predictions, and in addition to a sales forecast, you may work with a manufacturing forecast as well. </p>
    <p class="book-title--packt">In a real situation, chances are that you can even use a hybrid approach: use a sales forecast for shipments to larger customers or strategic products, and make extrapolations for bulk customers or less strategic products.</p>
    <h3 id="calibre_link-232" class="calibre8">Using a sales forecast to predict inventory changes</h3>
    <p class="book-title--packt">To work with a <a id="calibre_link-1248" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sales forecast, we need to have, of <a id="calibre_link-923" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>course, a table in our model containing the sales forecast: <code class="code-in-text--packt">fForecast</code>. There are many choices to make; let us assume that we have a monthly forecast by city, by product (being an aggregation of one or more SKUs). For simplicity, we will also assume that we only store forecasts for months after the reference date for the inventory (remember, that is the date for which we have stored the actual inventory status). Additionally, we map a month's forecast to the 1<sup class="superscript--packt">st</sup> of that month. See the table below for an example of forecast data:</p>
    <figure class="mediaobject"><img src="images/000030.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.10: Sales forecast data</p>
    <p class="book-title--packt">Because <a id="calibre_link-1249" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>of the different granularity<a id="calibre_link-924" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> of this fact table compared to the inventory and target tables, we add the <code class="code-in-text--packt">City</code> and <code class="code-in-text--packt">Product</code> tables to the model. These are related to <code class="code-in-text--packt">Warehouse</code> and <code class="code-in-text--packt">SKU</code>, respectively, with relationships that have a cross filter direction of <strong class="screentext">Both</strong>. This way, we can hide the new tables altogether and keep filtering, for instance, cities through the <code class="code-in-text--packt">City</code> column in the <code class="code-in-text--packt">Warehouse</code> table:</p>
    <figure class="mediaobject"><img src="images/000213.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.11: Model diagram including sales forecast</p>
    <p class="book-title--packt">To <a id="calibre_link-1737" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>compute the predicted inventory<a id="calibre_link-1738" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> level in the future, we need to take the reference level and subtract all sales forecast data until the last day of the <code class="code-in-text--packt">Calendar</code> selection. As an example, if our reference inventory is on September 21, and we want to know the predicted inventory for November, we subtract the sales forecast for October and November from the reference level. This gives us the predicted inventory at the end of November:</p>
    <pre class="programlisting"><code class="hljs-code">Inventory Forecast Qty 0 =
VAR RefLevel =
    CALCULATE(
        SUM(fInventory[Quantity]),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
VAR MaxDate = MAX('Calendar'[Date])
VAR SalesForecast =
    CALCULATE(
        SUM(fForecast[Quantity]),
        ALL('Calendar'),
        'Calendar'[Date] &lt;= MaxDate
    )
RETURN
RefLevel &ndash; SalesForecast
</code></pre>
    <p class="book-title--packt">If<a id="calibre_link-1250" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> only it were so easy! In reality, we <a id="calibre_link-925" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can run into situations where the forecasted sales cannot be fulfilled because the inventory level is too low for a specific SKU. The all-up <code class="code-in-text--packt">RefLevel &ndash; SalesForecast</code> calculation above would obscure these problems, as they could be offset by other SKUs that have more than enough inventory. Once again, the calculation must be done on the warehouse/SKU level, or on a higher level if we allow warehouses to borrow <a id="calibre_link-452" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>products from each other to fulfill sales. Let&nbsp;us work on the level of cities for now. </p>
    <p class="book-title--packt">Moreover, we need to deal with a sales <a id="calibre_link-1305" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>forecast that is set on the higher product level. We can only assume that a forecasted sale for a product could be fulfilled with any of the SKUs grouped into that product. In the formula, we use <code class="code-in-text--packt">SUMMARIZE</code> again, this time to create a summary over the <code class="code-in-text--packt">fInventory</code> table. After all, we do want to have a forecasted inventory level, even when there is no sales forecast available for the city/product combination:</p>
    <pre class="programlisting"><code class="hljs-code">SUMMARIZE(
    fInventory,
    Warehouse[City],
    SKU[Product]
)
</code></pre>
    <p class="book-title--packt">One thing to keep in mind here is that we are calculating a forecasted inventory. Almost by definition, the context for this calculation will involve a <em class="italic">future</em> selection in the <code class="code-in-text--packt">Calendar</code> table. But this means that the selection in the <code class="code-in-text--packt">fInventory</code> table is empty! What we need to do is to summarize the reference levels in <code class="code-in-text--packt">fInventory</code> instead:</p>
    <pre class="programlisting"><code class="hljs-code">CALCULATETABLE(
    SUMMARIZE(
        fInventory,
        Warehouse[City],
        SKU[Product]
    ),
    ALL('Calendar'),
    fInventory[Type] = 0
)
</code></pre>
    <p class="book-title--packt">With<a id="calibre_link-1251" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> this, we can do the proper <a id="calibre_link-926" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation:</p>
    <pre class="programlisting"><code class="hljs-code">Inventory Forecast Qty =
VAR MaxDate = MAX('Calendar'[Date])
VAR CityProductCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInventory,
            Warehouse[City],
            SKU[Product]
        ),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
RETURN
SUMX(
    CityProductCombinations,
    VAR RefLevel =
        CALCULATE(
            SUM(fInventory[Quantity]),
            ALL('Calendar'),
            fInventory[Type] = 0
    )
    VAR SalesForecast =
        CALCULATE(
            SUM(fForecast[Quantity]),
            ALL('Calendar'),
            'Calendar'[Date] &lt;= MaxDate
        )
    RETURN
    MAX(RefLevel &ndash; SalesForecast, 0)
)
</code></pre>
    <p class="book-title--packt">Note that we use DAX <a id="calibre_link-1306" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>variables in two <a id="calibre_link-453" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>places in the formula: the variables <code class="code-in-text--packt">MaxDate</code> and <code class="code-in-text--packt">CityProductCombinations</code> are computed once, while the variables <code class="code-in-text--packt">RefLevel</code> and <code class="code-in-text--packt">SalesForecast</code> are computed for every row in the <code class="code-in-text--packt">CityProductCombinations</code> table. </p>
    <p class="book-title--packt">And of course, the <a id="calibre_link-927" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>difference between <code class="code-in-text--packt">RefLevel</code> and <code class="code-in-text--packt">SalesForecast</code> is capped at zero, which was the <a id="calibre_link-1252" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>whole point of this endeavor.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">One issue in this calculation is that it returns the reference level for each context that selects months in the past. You could address this by only returning the reference level for future months. To do this, you can compute a <code class="code-in-text--packt">RefDate</code> variable containing the date of the reference levels, test whether <code class="code-in-text--packt">MaxDate &gt;= RefDate</code>, and only return results when that is true:</p>
      <pre class="programlisting"><code class="hljs-code">VAR RefDate =
CALCULATE(
    MAX(fInventory[Date]),
    ALL('Calendar'),
    fInventory[Type] = 0
)
...
RETURN
IF(MaxDate &gt;= RefDate,
    SUMX(...
</code></pre>
    </div>
    <p class="book-title--packt">The figure below shows sample output for this calculation:</p>
    <figure class="mediaobject"><img src="images/000043.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.12: Actual and forecasted inventory</p>
    <h3 id="calibre_link-233" class="calibre8">Using extrapolation to predict inventory changes</h3>
    <p class="book-title--packt">The second<a id="calibre_link-732" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> approach we discuss here is to <a id="calibre_link-917" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>use extrapolation as a means to predict future inventory. This means that instead of working with a sales forecast, which may not be available, we could look back and see what the typical shipping rate of products has been. This rate can then be used to extrapolate to the future.</p>
    <p class="book-title--packt">Before we dive into the DAX code needed, we have to first set the stage and think about the business assumptions we can make in this analysis. To name a few:</p>
    <ul class="calibre9">
      <li class="bullet">Again, we need to think about the granularity that can be applied. As in the previous section, let us assume that warehouses in the same city can use each other's inventory for shipments.</li>
      <li class="bullet">Technically, we can do the extrapolation on the individual SKU level, but you should realize that the lower the detail level, the higher the chance that one-off shipments and outliers affect the extrapolation. Let us work at the product level instead.</li>
      <li class="bullet">Another decision to make is how much to look back. There is no single right decision here, as it really depends on the characteristics of the business, which may even vary between products. When there is a strong seasonality in sales (which is plausible for a company selling motorbikes like QuantoBikes), it makes sense to work with a full year to base the extrapolation on.</li>
      <li class="bullet">Finally, we have to make an assumption about <em class="italic">how</em> to extrapolate future shipments from the past. We will keep it simple here and just take the average shipment, assuming that shipments have been stable overall during the period considered. You<a id="calibre_link-1739" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> may want to go one<a id="calibre_link-1740" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> step further and consider whether shipments are generally increasing or decreasing. This can be done via linear regression on monthly shipments, which can be performed in DAX (at the end of this chapter, we briefly discuss how). Go two steps further and you will find yourself in machine learning territory, which is beyond what DAX can do.</li>
    </ul>
    <p class="book-title--packt">Important to note is that, for now, we will only look at shipments from warehouses, and not at replenishments. You can, of course, apply the same principles to forecast products coming into the warehouses, or use a manufacturing forecast; we leave it to you to do this.</p>
    <p class="book-title--packt">In short, we want to calculate average shipments per month in the year before the reference date. This time, we are not interested in the reference inventory level, but in the outgoing transactions. These have <code class="code-in-text--packt">Type = 1</code> and <code class="code-in-text--packt">Quantity &gt; 0</code>.</p>
    <p class="book-title--packt">The total shipments can be calculated using the reference date:</p>
    <pre class="programlisting"><code class="hljs-code">VAR RefDate =
    CALCULATE(
        MAX(fInventory[Date]),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
VAR TotalShipments =
    CALCULATE(
        SUM(fInventory[Quantity]),
        fInventory[Type] = 1,
        fInventory[Quantity] &gt; 0,
        DATESINPERIOD('Calendar'[Date], RefDate, -12, MONTH)
    )
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">DATESINPERIOD</code> function provides<a id="calibre_link-584" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the one-year (or twelve-month) period that we want to consider. Because time<a id="calibre_link-733" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> intelligence <a id="calibre_link-1307" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>functions like <code class="code-in-text--packt">DATESINPERIOD</code> perform an implicit <code class="code-in-text--packt">ALL('Calendar')</code>, we don't need to include<a id="calibre_link-918" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> it explicitly here.</p>
    <p class="book-title--packt">How do we get from the total shipments to the average per month? The obvious answer is to divide by 12. In some cases, <a id="calibre_link-454" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>however, this may not be correct, like in the case of newly introduced products or even new <a id="calibre_link-519" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>warehouses. It is not a simple task to correctly compute the correct number of months to divide by in every case. One thing you can do is retrieve the months from the <code class="code-in-text--packt">fInventory</code> table itself:</p>
    <pre class="programlisting"><code class="hljs-code">VAR NumberOfMonths =
    COUNTROWS(
        CALCULATETABLE(
            SUMMARIZE(
                fInventory,
                'Calendar'[YearMonthNr]
            ),
            DATESINPERIOD(
                'Calendar'[Date], 
                RefDate, 
                -12, MONTH
            )
        )
    )
</code></pre>
    <p class="book-title--packt">When computing this, you will find that, in general, you overstate the number of months by one, as the reference date is almost always at some point in the middle of a month and you will count 13 different <code class="code-in-text--packt">YearMonthNr</code> values when you go one year back. A perhaps more serious problem is that you may have products that only ship every now and then, leaving gaps in the list of months. This can be addressed by not simply counting the months, but <a id="calibre_link-585" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>computing both the first and the last month (which is the month of the<a id="calibre_link-734" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> reference date) and taking the <a id="calibre_link-919" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>difference between the two. For this to work, you need a counter column, say <code class="code-in-text--packt">YearMonthCtr</code>, that is a continuous sequence. The number of months can then be calculated with:</p>
    <pre class="programlisting"><code class="hljs-code">VAR RefMonthCtr =
    CALCULATE(
        MAX('Calendar'[YearMonthCtr]),
        ALL('Calendar'),
        'Calendar'[Date] = RefDate
    )
VAR FirstInventoryDate =
    CALCULATE(
        MIN(fInventory[Date]),
        fInventory[Type] = 1,
        fInventory[Quantity] &gt; 0,
        DATESINPERIOD('Calendar'[Date], RefDate, -12, MONTH)
    )
VAR FirstMonthCtr =
    CALCULATE(
        MIN('Calendar'[YearMonthCtr]),
        ALL('Calendar'),
        'Calendar'[Date] = FirstDate
    )
VAR NumberOfMonths = RefMonthCtr &ndash; FirstMonthCtr 
</code></pre>
    <p class="book-title--packt">The average shipments per month is a simple division now:</p>
    <pre class="programlisting"><code class="hljs-code">VAR AvgShipmentsMth =
    DIVIDE(TotalShipments, NumberOfMonths)
</code></pre>
    <p class="book-title--packt">Note that most of these variables need to be evaluated for city/product combinations, although some, like <code class="code-in-text--packt">FirstInventoryDate</code>, are generic. </p>
    <p class="book-title--packt">To compute <a id="calibre_link-1741" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a proper inventory prediction, we <a id="calibre_link-1742" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>should start with the reference level, and subtract the monthly run rate for every month <a id="calibre_link-1003" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>between the reference date and the last day of the <code class="code-in-text--packt">Calendar</code> selection. </p>
    <p class="book-title--packt">In other words, we need to not only count the number of months in the past, to calculate the run rate, but also in the future. This time, we are merely counting across the <code class="code-in-text--packt">Calendar</code> table, so we do not need to jump through hoops to translate a date to a <code class="code-in-text--packt">YearMonthCtr</code> value, but we can retrieve it directly:</p>
    <pre class="programlisting"><code class="hljs-code">VAR MaxMonthCtr = MAX('Calendar'[YearMonthCtr])
VAR NumberOfMonthsFuture = MaxMonthCtr &ndash; RefMonthCtr
VAR PredictedShipments = NumberOfMonthsFuture * AvgShipmentsMth
</code></pre>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Note that as the reference date is at some point in the middle of a month, no shipments are predicted for the rest of that month. It is up to you to decide if that is OK or not. You can compensate for it by also computing <a id="calibre_link-455" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the fraction of the month that is missed, and add a prediction for that fraction. </p>
      <p class="book-title--packt">Another approach would be to work from the last day of the month preceding the reference date. You will then effectively calculate the average shipments from the last twelve full months, and predict shipments for the current month as a whole. You should subtract the actual shipments in the current month to get a good result.</p>
    </div>
    <p class="book-title--packt">Let us now use all the variables above to build a proper DAX measure:</p>
    <pre class="programlisting"><code class="hljs-code">Inventory Prediction Qty =
VAR RefDate =
    CALCULATE(
        MAX(fInventory[Date]),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
VAR RefMonthCtr =
    CALCULATE(
        MAX('Calendar'[YearMonthCtr]),
        ALL('Calendar'),
        'Calendar'[Date] = RefDate
    )
VAR MaxMonthCtr = MAX('Calendar'[YearMonthCtr])
VAR NumberOfMonthsFuture = MaxMonthCtr &ndash; RefMonthCtr
VAR CityProductCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInventory,
            Warehouse[City],
            SKU[ProductNr]
        ),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
RETURN
</code></pre>
    <p class="book-title--packt">These are all<a id="calibre_link-735" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> variables that can be evaluated<a id="calibre_link-920" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> once for the calculation. The <code class="code-in-text--packt">CityProductCombinations</code> variable is the list of cities <a id="calibre_link-586" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>and products for which a reference level is available. The <a id="calibre_link-1308" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>rest of the <a id="calibre_link-1004" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>calculation is done on a per-city/product combination basis:</p>
    <pre class="programlisting"><code class="hljs-code">SUMX(
    CityProductCombinations,
    VAR TotalShipments =
        CALCULATE(
            SUM(fInventory[Quantity]),
            fInventory[Type] = 1,
            fInventory[Quantity] &gt; 0,
            DATESINPERIOD('Calendar'[Date], RefDate, -12, MONTH)
        )
    VAR FirstInventoryDate =
        CALCULATE(
            MIN(fInventory[Date]),
            fInventory[Type] = 1,
            fInventory[Quantity] &gt; 0,
            DATESINPERIOD('Calendar'[Date], RefDate, -12, MONTH)
        )
    VAR FirstMonthCtr =
        CALCULATE(
            MIN('Calendar'[YearMonthCtr]),
            ALL('Calendar'),
            'Calendar'[Date] = FirstInventoryDate
        )
    VAR NumberOfMonths = RefMonthCtr &ndash; FirstMonthCtr 
    VAR AvgShipmentsMth = DIVIDE(TotalShipments, NumberOfMonths)
    VAR PredictedShipments = NumberOfMonthsFuture * AvgShipmentsMth
    VAR RefLevel =
        CALCULATE(
            SUM(fInventory[Quantity]),
            ALL('Calendar'),
            fInventory[Type] = 0
        )
    RETURN
</code></pre>
    <p class="book-title--packt">For each <a id="calibre_link-736" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>city/product combination, the <code class="code-in-text--packt">TotalShipments</code> variable is the total of the outgoing units in the last 12 months. The <code class="code-in-text--packt">FirstInventoryDate</code> and <code class="code-in-text--packt">FirstMonthCtr</code> variables, discussed before, are used to <a id="calibre_link-921" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>compute the correct <code class="code-in-text--packt">NumberOfMonths</code> value. With these, we can compute the average shipments per month in the <code class="code-in-text--packt">AvgShipmentsMth</code> variable. And, of course, we need the reference level for the city/product combination as well.</p>
    <p class="book-title--packt">The remainder of the formula is really simple: all we need to do is subtract the prediction from the reference level, keeping it at zero when it ends up below:</p>
    <pre class="programlisting"><code class="hljs-code">    MAX(RefLevel &ndash; PredictedShipments, 0)
) 
</code></pre>
    <p class="book-title--packt">The figure below shows sample output for this calculation. Note that we deal with the same issue as the forecast calculation earlier: the measure returns results for past months as well. </p>
    <figure class="mediaobject"><img src="images/000169.png" alt="Chart, line chart  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.13: Prediction of inventory by extrapolation</p>
    <p class="book-title--packt">This concludes <a id="calibre_link-737" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>our approach to predicting inventory <a id="calibre_link-922" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>through either a sales forecast or extrapolation. You could use a hybrid approach, with a sales forecast for some strategic products and extrapolation for others. The most straightforward way to do this is through the <code class="code-in-text--packt">CityProductCombinations</code> variable used in the DAX formulas discussed earlier. For instance, limiting <a id="calibre_link-1309" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>this list to products with the status <code class="code-in-text--packt">"Strategic"</code> would not be hard to implement when there is a <code class="code-in-text--packt">Status</code> column in the <code class="code-in-text--packt">SKU</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">VAR CityProductCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInventory,
            Warehouse[City],
            SKU[Product]
        ),
ALL('Calendar'),
        fInventory[Type] = 0,
        SKU[Status] = "Strategic"
    )
</code></pre>
    <p class="book-title--packt">Using this variable declaration instead of the one we defined earlier in <code class="code-in-text--packt">Inventory Forecast Qty</code> would lead to a <a id="calibre_link-456" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>result for only the strategic products. In the same way, the list used in the <code class="code-in-text--packt">Inventory Prediction Qty</code> measure could be limited to non-strategic <a id="calibre_link-1743" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>products to use extrapolation <a id="calibre_link-1744" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>for those products only. You can then add both measures to obtain a hybrid inventory outlook.</p>
    <p class="book-title--packt">With a similar approach to what we used to forecast or predict shipments, you can build DAX measures for either forecasted or extrapolated replenishments of inventory.</p>
    <h2 id="calibre_link-234" class="calibre8">Calculating long-lasting inventory</h2>
    <p class="book-title--packt">We now have the<a id="calibre_link-979" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> means to calculate the expected inventory at any time in the future. This gives an overall impression of whether our inventory level is too high or too low. We can also take another view by computing the quantity of stock we have now that will probably still be in stock after some time, say, a year. By doing this calculation not in quantity but in value, by taking the costs of our products into account, we will learn how much money is stuck in long-lasting inventory. Businesswise, you would want to find a balance between minimizing inventory value and keeping customer service at appropriate levels.</p>
    <p class="book-title--packt">You can probably guess that this calculation is just another one within the same framework as the previous measures we discussed in this chapter. The approach is:</p>
    <ol class="calibre9">
      <li class="calibre12" value="1">Compute the current (reference) level of inventory.</li>
      <li class="calibre12">Predict the shipments between now and a year.</li>
      <li class="calibre12">Calculate what remains of the current inventory after that year.</li>
    </ol>
    <p class="book-title--packt">Again, we need to decide on which level to do the calculation. We will keep things simple and stay with the same city/product combination <a id="calibre_link-457" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>level as we used in the previous section. Let's begin by creating a calculation of long-lasting inventory <em class="italic">quantity</em>, which starts again with the <a id="calibre_link-1310" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>declaration of some variables: </p>
    <pre class="programlisting"><code class="hljs-code">Long-lasting Inventory Qty =
VAR RefDate =
    CALCULATE(
        MAX(fInventory[Date]),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
VAR CityProductCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInventory,
            Warehouse[City],
            SKU[ProductNr]
        ),
        ALL('Calendar'),
        fInventory[Type] = 0 
    )
</code></pre>
    <p class="book-title--packt">Again, the formula starts with setting up the general things we need and that you have seen before: the reference date and the table of city/product combinations. We proceed by iterating over this table, and for each combination, we will need to calculate the reference level and either the <code class="code-in-text--packt">SalesForecast</code> or <code class="code-in-text--packt">PredictedShipments</code> variable, whichever<a id="calibre_link-980" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> approach you choose. Let's stick with using a sales forecast:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SUMX(
    CityProductCombinations,
    VAR RefLevel =
        CALCULATE(
            SUM(fInventory[Quantity]),
            ALL('Calendar'),
            fInventory[Type] = 0
        )
    VAR SalesForecast =
        CALCULATE(
            SUM(fForecast[Quantity]),
            DATESINPERIOD(
                'Calendar'[Date], 
                RefDate, 
                12, MONTH
            )
        )
</code></pre>
    <p class="book-title--packt">Note that <code class="code-in-text--packt">DATESINPERIOD</code> returns a <a id="calibre_link-587" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>period of 12 months, starting on the reference date. You should take special care here: when the sales forecast is mapped to, say, the first day of the month, and the reference date happens to be the second of the month, the sales forecast for that month will not be included in the result. It is a business question whether this is OK or whether you would prefer to include the whole month's sales forecast; in the latter case, you could shift the start date for <code class="code-in-text--packt">DATESINPERIOD</code> with:</p>
    <pre class="programlisting"><code class="hljs-code">EOMONTH(RefDate, -1) + 1
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">EOMONTH</code> function returns<a id="calibre_link-1745" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> the last day of the month <em class="italic">before</em> <code class="code-in-text--packt">RefDate</code> (because of the -1); we add one day to arrive at the first day of <code class="code-in-text--packt">RefDate</code>'s month.</p>
    <p class="book-title--packt">The remainder of the formula is straightforward. We subtract the forecast from the reference level but avoid going below zero. What remains is the inventory that is not expected to be shipped in the coming 12 months:</p>
    <pre class="programlisting"><code class="hljs-code">    RETURN
    MAX(RefLevel &ndash; SalesForecast, 0)
)
</code></pre>
    <p class="book-title--packt">We now have a <a id="calibre_link-981" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>DAX measure to compute the quantity of long-lasting inventory. The next step is to assign a value to this inventory. We haven't discussed how to model value in the Power BI model, which is highly dependent on what the costs of a product (or SKU) are. The company may have a standardized, fixed cost for a SKU that can be used for all warehouses, but costs may also differ between warehouses, and may even change over time. </p>
    <p class="book-title--packt">One way to model product costs would be to have a <code class="code-in-text--packt">Cost</code> column in each fact table. If this is the case, you could simply replace each occurrence of <code class="code-in-text--packt">Quantity</code> with <code class="code-in-text--packt">Cost</code> in the <code class="code-in-text--packt">Long-lasting Inventory Qty</code> measure to create a <code class="code-in-text--packt">Long-lasting Inventory Value</code> measure. This can only be done, of course, when it is possible to provide these columns in a way that makes sense, business-wise.</p>
    <p class="book-title--packt">Here, we will cover the option to have a <code class="code-in-text--packt">Cost</code> column in the <code class="code-in-text--packt">SKU</code> table; this means that our company has a fixed SKU cost globally. As we do our calculations on the level of city/product combinations, this means that when we <a id="calibre_link-458" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>compute the total value of inventory, we must aggregate multiple SKUs for each city/product combination. After all, a product is a grouping of multiple SKUs. </p>
    <p class="book-title--packt">The challenge (whichever way you model things) is that the inventory quantity for a product in 12 months, which we calculated in the <code class="code-in-text--packt">Long-lasting Inventory Qty</code> measure, is based on the actual (reference) level and the sales forecast. The sales forecast, however, is only <a id="calibre_link-1311" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>available at the product level, which means that we have no way of knowing how many of each specific SKU will be in stock in 12 months. How then can we compute the value when different SKUs have different costs?</p>
    <p class="book-title--packt">We must decide upon a way to estimate the average SKU cost as accurately as possible. For this calculation, we will take the weighted average SKU cost, taken against the reference inventory. This is the total cost of all SKUs in the reference inventory, divided by the total quantity of that inventory.</p>
    <p class="book-title--packt">The measure again starts by declaring variables:</p>
    <pre class="programlisting"><code class="hljs-code">Long-lasting Inventory Value =
VAR RefDate =
    CALCULATE(
        MAX(fInventory[Date]),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
VAR CityProductCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInventory,
            Warehouse[City],
            SKU[ProductNr]
        ),
        ALL('Calendar'),
        fInventory[Type] = 0 
    )
</code></pre>
    <p class="book-title--packt">Like before, the<a id="calibre_link-982" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> calculation is done by <a id="calibre_link-1487" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>iterating over the <code class="code-in-text--packt">CityProductCombinations</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SUMX(
    CityProductCombinations,
    VAR RefLevel =
        CALCULATE(
            SUM(fInventory[Quantity]),
            ALL('Calendar'),
            fInventory[Type] = 0
        )
    VAR SalesForecast =
        CALCULATE(
            SUM(fForecast[Quantity]),
            DATESINPERIOD(
                'Calendar'[Date], 
                RefDate, 
                12, MONTH
            )
        )
</code></pre>
    <p class="book-title--packt">Next to the <code class="code-in-text--packt">RefLevel</code> and <code class="code-in-text--packt">SalesForecast</code> variables <a id="calibre_link-588" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>used before, which we need to compute the quantity in 12 months, we now compute the weighted average costs:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR RefTotalCosts =
        CALCULATE(
            SUMX(
                VALUES(SKU[Cost]),
                SKU[Cost] *
                CALCULATE(
                    SUM(fInventory[Quantity]),
                    ALL('Calendar'),
                    fInventory[Type] = 0
                )
            )
        )
    VAR AvgSKUCost = DIVIDE(RefTotalCosts, RefLevel)
</code></pre>
    <p class="book-title--packt">The <code class="code-in-text--packt">RefTotalCosts</code> variable <a id="calibre_link-1746" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>deserves some extra attention here. Note that this variable is evaluated in a row context on the <code class="code-in-text--packt">CityProductCombinations</code> table, which means that the SKUs are not automatically filtered down to those belonging to the current <code class="code-in-text--packt">Product</code>. We therefore need to add <code class="code-in-text--packt">CALCULATE</code> to make sure we only see the correct SKUs.</p>
    <p class="book-title--packt">You can also notice that a <code class="code-in-text--packt">SUMX</code> is done over the list of <code class="code-in-text--packt">Cost</code> values, not over the list of SKUs. The reason is twofold: if we were to use <code class="code-in-text--packt">VALUES(SKU[SKUNr])</code>, the <code class="code-in-text--packt">Cost</code> column would not be available for the calculation; and additionally, when multiple SKUs for the current product have the same cost, we <a id="calibre_link-1488" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>have fewer iterations to do by using <code class="code-in-text--packt">VALUES(SKU[Cost])</code>. The second <code class="code-in-text--packt">CALCULATE</code> in this variable's declaration turns the row context on the table of costs into a filter context, making sure that for each <code class="code-in-text--packt">Cost</code> value, the calculation is only done over transactions on a SKU with that cost.</p>
    <p class="book-title--packt">The last part of the formula is straightforward:</p>
    <pre class="programlisting"><code class="hljs-code">    RETURN
    MAX(RefLevel &ndash; SalesForecast) * AvgSKUCost
)
</code></pre>
    <p class="book-title--packt">We multiply the quantity of long-lasting inventory by the weighted average cost per SKU in the current (reference) inventory, which should be a fairly accurate value assessment.</p>
    <h2 id="calibre_link-235" class="calibre8">Working with forecast-based inventory targets</h2>
    <p class="book-title--packt">Earlier in this chapter, we <a id="calibre_link-817" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>worked with simple inventory targets, stating that inventory for some product in some warehouse should always be at a certain level. In the real world, inventory targets can have a more sophisticated logic. For example:</p>
    <ul class="calibre9">
      <li class="bullet">For each product, enough items must be in stock to cover 90 days of business run rate.</li>
      <li class="bullet">For each product, enough items must be in stock to cover the expected business during a product-specific "target horizon."</li>
      <li class="bullet">For each product, the current level minus the expected shipments in 90 days must be above a certain, product-specific target.</li>
      <li class="bullet">For each product, the current level minus the expected shipments in a product-specific "target horizon" must be above a certain target.</li>
    </ul>
    <p class="book-title--packt">Now that we know how to calculate expected shipments for any period we choose, it is not difficult to implement these targets. You can either compute the total quantity of products that are below target, the value of missing inventory (and, therefore, the business risk coming from out-of-stock items), or the number of products that are below target. You could also attach a color code: green for products with enough inventory, yellow for products that have enough inventory when warehouses in the same city may help to fulfill demand, and red for products without enough inventory.</p>
    <p class="book-title--packt">As an example, we give the formula for the first target type, for products that are below this target. The formula contains some variables that can be altered to implement other target types. We <a id="calibre_link-459" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>begin with a definition of the variables <code class="code-in-text--packt">RefDate</code> and <code class="code-in-text--packt">WarehouseProductCombinations</code> (using a <a id="calibre_link-1312" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>lower detail level now, as the targets may be warehouse-specific):</p>
    <pre class="programlisting"><code class="hljs-code">Inventory vs Target (90 days) low =
VAR RefDate =
    CALCULATE(
        MAX(fInventory[Date]),
        ALL('Calendar'),
        fInventory[Type] = 0
    )
VAR WarehouseSKUCombinations =
    CALCULATETABLE(
        SUMMARIZE(
            fInventory,
            Warehouse[WarehouseNr],
            SKU[ProductNr]
        ),
        ALL('Calendar'),
        fInventory[Type] = 0 
    )
</code></pre>
    <p class="book-title--packt">Within <a id="calibre_link-818" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the <code class="code-in-text--packt">SUMX</code> iterator, we define the variables <code class="code-in-text--packt">RefLevel</code>, and either <code class="code-in-text--packt">SalesForecast</code> (which we choose here) or <code class="code-in-text--packt">AvgShipmentsMth</code> (similar to the extrapolation discussed earlier in this chapter):</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SUMX(
    WarehouseProductCombinations,
    VAR RefLevel =
        CALCULATE(
            SUM(fInventory[Quantity]),
            ALL('Calendar'),
            fInventory[Type] = 0
        )
    VAR TargetHorizon = 90
    VAR SalesForecast =
        CALCULATE(
            SUM(fForecast[Quantity]),
            DATESINPERIOD(
                'Calendar'[Date], 
                RefDate, 
                TargetHorizon, DAY
            )
        )
</code></pre>
    <p class="book-title--packt">We put the 90-day horizon in a variable, and<a id="calibre_link-589" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> use that variable in the <code class="code-in-text--packt">DATESINPERIOD</code> function (with <code class="code-in-text--packt">DAY</code> as the unit now). If you needed to implement a product-specific target horizon, you would include a calculation here to retrieve the target horizon for&nbsp;the product at hand. The formula concludes with:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR Threshold = 0
    RETURN
    MIN(RefLevel &ndash; SalesForecast, Threshold)
</code></pre>
    <p class="book-title--packt">Here, a <code class="code-in-text--packt">Threshold</code> variable is added to easily be <a id="calibre_link-1005" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>able to change from a fixed target ("<em class="italic">expected inventory at target horizon must be larger than zero</em>") to a product-specific target ("<em class="italic">expected inventory at target horizon must be larger than this product's threshold</em>"). </p>
    <h2 id="calibre_link-236" class="calibre8">Using linear regression for extrapolating inventory</h2>
    <p class="book-title--packt">When using <a id="calibre_link-967" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>extrapolation to predict future shipments, we have assumed that a constant, average number of shipments per month can be used. The reality could be more complex than that: hopefully, business is growing, but it may be slowing down as well. Rather than working with a constant shipment rate, it would be beneficial to take growth or shrinkage into account.</p>
    <p class="book-title--packt">To do this, you can use linear regression, as shown in the figure below. In Excel, linear regression is a common feature, and a regression line can sometimes be added in Power BI charts too, through the <strong class="screentext">Analytics </strong>pane for a visual. </p>
    <p class="book-title--packt">There is, however, no built-in way to do linear regression and use the values of the regression line in a DAX calculation.</p>
    <figure class="mediaobject"><img src="images/000184.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.7.14: A regression line in an Excel chart</p>
    <p class="book-title--packt">Fortunately, for the case of <em class="italic">simple linear regression</em>, which is linear regression using only one variable, exact mathematical formulas exist to calculate the regression line. In mathematical terms, given a collection of (<em class="italic">x</em>, <em class="italic">y</em>) pairs, the challenge is to find a function</p>
    <figure class="mediaobject"><img src="images/000078.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">such that the line defined by this function is "closest" to the collection of (<em class="italic">x</em>, <em class="italic">y</em>) pairs. Without going into the mathematical details, assumptions, and constraints, the values for <em class="italic">a</em> and <em class="italic">b</em> can be exactly computed from the (<em class="italic">x</em>, <em class="italic">y</em>) pairs:</p>
    <figure class="mediaobject"><img src="images/000099.png" alt="" class="calibre14" /></figure>
    <figure class="mediaobject"><img src="images/000121.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">These formulas apply the <strong class="screentext">least squares</strong> method<a id="calibre_link-965" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> to optimize the regression line, where <em class="italic">n</em> is the number of (<em class="italic">x</em>, <em class="italic">y</em>) pairs used for the regression.</p>
    <p class="book-title--packt">What are the (<em class="italic">x</em>, <em class="italic">y</em>) pairs in our case? We want to do an extrapolation of shipments based on the<a id="calibre_link-968" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> shipments per month in the last twelve months. We happen to have a <code class="code-in-text--packt">YearMonthCtr</code> column in the <code class="code-in-text--packt">Calendar</code> table, which <a id="calibre_link-460" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>can provide the <em class="italic">x</em> values (it is important that we can do arithmetic on these values). The corresponding <em class="italic">y</em> values are the shipments in each month.</p>
    <p class="book-title--packt">We will use the same approach as in our simple extrapolation discussed earlier, starting with some <a id="calibre_link-1313" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>variables to retrieve the <code class="code-in-text--packt">YearMonthCtr</code> value for the reference inventory, and the list of city/product combinations:</p>
    <pre class="programlisting"><code class="hljs-code">Shipments Regression =
VAR RefDate =
CALCULATE(
    MAX(fInventory[Date]),
    ALL('Calendar'),
    fInventory[Type] = 0
)
VAR RefMonthCtr =
CALCULATE(
    MAX('Calendar'[YearMonthCtr]),
    ALL('Calendar'),
    'Calendar'[Date] = RefDate
)
VAR CityProductCombinations =
CALCULATETABLE(
    SUMMARIZE(
        fInventory,
        Warehouse[City],
        SKU[ProductNr]
    ),
    ALL('Calendar'),
    fInventory[Type] = 0
)
</code></pre>
    <p class="book-title--packt">Note that we strictly do not need to only select city/product combinations that have a reference inventory, as we do here; but we will leave this as it is, as the regression results will be used to predict future inventory in the end, which does not make sense for combinations that do not have a reference inventory. </p>
    <p class="book-title--packt">As usual, we iterate over <code class="code-in-text--packt">CityProductCombinations</code> to continue our calculation for one combination at a time. The <code class="code-in-text--packt">RefMonthCtr</code> variable and the <code class="code-in-text--packt">FirstMonthCtr</code> variable declared in the code below allow us to construct the list of <code class="code-in-text--packt">YearMonthCtr</code> values that we want to use for the<a id="calibre_link-969" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> linear regression; it is simply the list of all <code class="code-in-text--packt">YearMonthCtr</code> values between <code class="code-in-text--packt">FirstMonthCtr</code> and <code class="code-in-text--packt">RefMonthCtr</code>:</p>
    <pre class="programlisting"><code class="hljs-code">RETURN
SUMX(
    CityProductCombinations,
    VAR FirstInventoryDate =
    CALCULATE(
        MIN(fInventory[Date]),
        fInventory[Type] = 1,
        fInventory[Quantity] &gt; 0,
        DATESINPERIOD('Calendar'[Date], RefDate, -12, MONTH)
    )
    VAR FirstMonthCtr =
    CALCULATE(
        MIN('Calendar'[YearMonthCtr]),
        ALL('Calendar'),
        'Calendar'[Date] = FirstInventoryDate
    )
    VAR Months =
    FILTER(
        ALL('Calendar'[YearMonthCtr]),
        'Calendar'[YearMonthCtr] &gt;= FirstMonthCtr
        &amp;&amp; 'Calendar'[YearMonthCtr] &lt;= RefMonthCtr
    )
</code></pre>
    <p class="book-title--packt">Note that using <code class="code-in-text--packt">DATESINPERIOD</code> with -12 <a id="calibre_link-1006" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>months, the list will normally contain 13 values (as <code class="code-in-text--packt">RefDate</code> is somewhere in the middle of a month).</p>
    <p class="book-title--packt">To <a id="calibre_link-1747" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>create our (<em class="italic">x</em>, <em class="italic">y</em>) pairs, we can add a <a id="calibre_link-785" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>column to the <code class="code-in-text--packt">Month</code> table variable. <code class="code-in-text--packt">ALLEXCEPT</code> is needed here, as we need to remove existing filters on <code class="code-in-text--packt">Calendar</code> that are still in place but do not want to lose the filter on <code class="code-in-text--packt">YearMonthCtr</code> that has just been introduced in the filter context <a id="calibre_link-590" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>created by <code class="code-in-text--packt">CALCULATE</code>. Another thing to deal with is the possibility that there are no shipments in a certain month. If we leave this month in the list, the <code class="code-in-text--packt">Shipments</code> value will be treated as zero, which would not be correct. </p>
    <p class="book-title--packt">We therefore use <code class="code-in-text--packt">FILTER</code> to clean up the (<em class="italic">x</em>, <em class="italic">y</em>) pairs list: </p>
    <pre class="programlisting"><code class="hljs-code">VAR XYPairs =
FILTER(
    ADDCOLUMNS(
        Months,
        "Shipments", 
        CALCULATE(
            SUM(fInventory[Quantity]),
            fInventory[Type] = 1,
            fInventory[Quantity] &gt; 0,
            ALLEXCEPT('Calendar', 'Calendar'[YearMonthCtr])
        )
    ),
    NOT(ISBLANK([Shipments]))
)
</code></pre>
    <p class="book-title--packt">We now have our list of (<em class="italic">x</em>, <em class="italic">y</em>) pairs as a table with columns <code class="code-in-text--packt">YearMonthCtr</code> and <code class="code-in-text--packt">Shipments</code>. When you look at the formulas for the coefficients <em class="italic">a</em> and <em class="italic">b</em>, it is clear that we need to compute several values <a id="calibre_link-786" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from the set of (<em class="italic">x</em>, <em class="italic">y</em>) pairs: the sum of <em class="italic">x</em>, the sum of <em class="italic">y</em>, the sum of <em class="italic">x</em> times <em class="italic">y</em>, the sum of <em class="italic">x</em> squared, and the <a id="calibre_link-520" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>number of pairs. Let us calculate those first:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR Sum_X = SUMX(XYPairs, [YearMonthCtr])
    VAR Sum_Y = SUMX(XYPairs, [Shipments])
    VAR Sum_XY = SUMX(XYPairs, [YearMonthCtr] * [Shipments])
    VAR Sum_XX = SUMX(XYPairs, [YearMonthCtr] * [YearMonthCtr])
    VAR n = COUNTROWS(XYPairs)
</code></pre>
    <p class="book-title--packt">Now that we have these variables, the regression line coefficients can be computed:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR b = 
    DIVIDE(
        Sum_XY &ndash; DIVIDE( Sum_X * Sum_Y, n ),
        Sum_XX &ndash; DIVIDE( Sum_X * Sum_X, n )
    )
    VAR a =
    DIVIDE(
        Sum_Y &ndash; b * Sum_X,
        n
    )
</code></pre>
    <p class="book-title--packt">With <em class="italic">a</em> and <em class="italic">b</em> in place, we can compute the extrapolated shipments in any future selection of <a id="calibre_link-970" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>months by applying the <em class="italic">ax</em>+<em class="italic">b</em> function to values of <code class="code-in-text--packt">YearMonthCtr</code>. When multiple <code class="code-in-text--packt">YearMonthCtr</code> values are in the <a id="calibre_link-1489" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>selection, the results for these values should be summed:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR ExtrapolatedShipments =
    SUMX(
        VALUES('Calendar'[YearMonthCtr]),
        a + 'Calendar'[YearMonthCtr] * b
    )
    RETURN
    ExtrapolatedShipments
)
</code></pre>
    <p class="book-title--packt">In the figure below, we have plotted the calculated regression line in comparison with actual shipments for a sample warehouse and product. In this example, the reference date is in July 2021; the regression is therefore done on the shipments between July 2020 and July 2021. From the chart, you can see that there are 8 months with shipments during this period:</p>
    <figure class="mediaobject"><img src="images/000206.png" alt="Chart, bar chart  Description automatically generated" class="calibre14" /> </figure>
    <p class="book-title--packt">Figure 2.7.15: A regression line calculated in DAX</p>
    <p class="book-title--packt">Remember<a id="calibre_link-1748" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> that in a complete report, the linear regression would be done on a <code class="code-in-text--packt">Warehouse</code>/<code class="code-in-text--packt">SKU</code> level or higher, depending on your business assumptions. This means that this single measure would perform a lot of linear regression calculations, which may take a while. </p>
    <h1 id="calibre_link-237" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, we have dealt with analyzing inventory data, although the kind of analysis in this chapter can be applied to all sorts of status-oriented data.</p>
    <p class="book-title--packt">We have discussed different ways to model this kind of data, how to calculate inventory status at some point in time, and how to compare actuals with targets.</p>
    <p class="book-title--packt">You have also seen different ways to look into the future. As inventory is typically needed to fulfill sales orders, being able to estimate future stock levels is a valuable capability. We have covered creating a future inventory outlook through sales forecasts and through extrapolation based on average shipment volumes. We have also shown you how to do linear regression in DAX, providing a slightly more sophisticated method to predict future shipments and extrapolate current inventory levels to the future.</p>
    <p class="book-title--packt">More advanced ways to extrapolate or predict future inventory than the ones covered in this chapter are possible as well; you could create extrapolations based not only on simply average shipments, but with seasonality taken into account. Or, you could build AI models to incorporate many more variables in predicting future shipments.</p>
    <p class="book-title--packt">In the next and final chapter of this book, we focus on planning personnel based on future workloads with DAX.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-262">
<div id="calibre_link-1749" class="calibre2">
<div id="calibre_link-1750" class="calibre3"><div id="calibre_link-1751" class="calibre4">
    <h1 class="chapternumber">2.8</h1>
    <h1 id="calibre_link-238" class="title">Personnel Planning</h1>
    <p class="book-title--packt">For a company selling large projects involving a great number of project members with different roles, it is important to be able to plan how many people are needed at which time. This is, of course, not<a id="calibre_link-829" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> about the number of individuals; we do the analysis in <strong class="screentext">FTEs</strong> (<strong class="screentext">full-time equivalents</strong>) instead. (Besides, needing 2.5 FTEs sounds a lot better than needing 2.5 people, right?) </p>
    <p class="book-title--packt">This chapter discusses an example of personnel planning for a project-based business. As you will see, only a few DAX measures are needed to compute the global need for personnel. The main complexity is in the large number of context transformations occurring during the calculation.</p>
    <p class="book-title--packt">This chapter covers the following topics:</p>
    <ul class="calibre9">
      <li class="bullet">The Power BI model for personnel planning</li>
      <li class="bullet">Calculating sales, both order intake and projected sales over time</li>
      <li class="bullet">Calculating FTEs needed for projects sold</li>
      <li class="bullet">Optimizing the Power BI model</li>
      <li class="bullet">Considering aggregation levels</li>
    </ul>
    <h1 id="calibre_link-239" class="title">The Power BI model</h1>
    <p class="book-title--packt">The <a id="calibre_link-1092" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>analysis in this chapter is based on the model below.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can download the Power BI model for this chapter, <code class="code-in-text--packt">2.8 Personnel Planning.pbix</code>, from this link: <a href="https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.8" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">https://github.com/PacktPublishing/Extreme-DAX/tree/main/Chapter2.8</span></a>.</p>
    </div>
    <figure class="mediaobject"><img src="images/000050.png" alt="Graphical user interface, diagram  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.1: Power BI model diagram for personnel planning</p>
    <p class="book-title--packt">The model<a id="calibre_link-1752" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> contains two main fact tables:</p>
    <ul class="calibre9">
      <li class="bullet"><code class="code-in-text--packt">fProjectSales</code> contains projects sold. The primary information in the table is the project type, which is the main characteristic of a project. The table also contains a <code class="code-in-text--packt">Number</code> column, which denotes the size of the project in terms of the project type. For example, a project can have type A and number 3, meaning that the project is comparable to three typical type A projects. The table contains the project budget as well.</li>
      <li class="bullet"><code class="code-in-text--packt">fFTE</code> is a fact table with information about project types. It is an atypical fact table, as it does not contain any data that is strictly time-related. Instead, for each project type it contains a list of roles and the number of FTEs needed in that role for each month during the project (where we start counting at month 0). The figure below shows a sample of the data in <code class="code-in-text--packt">fFTE</code>; note that, implicitly, a project type<a id="calibre_link-1093" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> determines the duration of a project of that type in months.<figure class="mediaobject"><img src="images/000071.png" alt="" class="calibre14" /></figure>
      </li>
    </ul>
    <p class="book-title--packt">Figure 2.8.2: Sample data from fFTE</p>
    <p class="book-title--packt">The combination of the two fact tables allows the determination of how many FTEs a project needs in a specific month. For example, if a project with project type A1 and Number 2 starts in February 2022, two full-time analysts are needed for the project from March 2022 onward until July 2022.</p>
    <p class="book-title--packt">The <code class="code-in-text--packt">fFTE</code> fact table is related to filter tables <code class="code-in-text--packt">Role</code> and <code class="code-in-text--packt">ProjectType</code>. The <code class="code-in-text--packt">fProjectSales</code> fact table is related to <code class="code-in-text--packt">ProjectType</code> as well, but can have other relationships like, in our example, <code class="code-in-text--packt">Project</code> and <code class="code-in-text--packt">Location</code>. The model could be extended with all kinds of filter tables related to <code class="code-in-text--packt">fProjectSales</code>, such as <code class="code-in-text--packt">Sales Unit</code>, <code class="code-in-text--packt">Customer</code>, and others. When we calculate the total number of FTEs needed, we should be able to filter the result on role and on month but also on location, project, project type, and any other filter that selects specific projects.</p>
    <p class="book-title--packt">Note that we made the relationship between <code class="code-in-text--packt">fProjectSales</code> and <code class="code-in-text--packt">Calendar</code> <em class="italic">inactive</em>. This is done because most calculations will probably not group projects by their start date, but spread results over a period of time <em class="italic">beginning</em> with the start date of a&nbsp;project. The inactive relationship will save us a lot of <code class="code-in-text--packt">ALL('Calendar')</code> clauses in our DAX code.</p>
    <p class="book-title--packt">The model allows for complex project configurations; for example, a project may be equivalent to three type A1 projects in Amsterdam, plus two B1 projects in London. The DAX calculations<a id="calibre_link-1094" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in this chapter <a id="calibre_link-1432" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>will have to be designed to support project configurations like these; but as you will see, we will need nothing specific to&nbsp;achieve&nbsp;this.</p>
    <h1 id="calibre_link-240" class="title">Calculating sales</h1>
    <p class="book-title--packt">To start with a <a id="calibre_link-1240" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>straightforward measure, let us calculate the total sales amount:</p>
    <pre class="programlisting"><code class="hljs-code">Total Sales = 
CALCULATE(
    SUM(fProjectSales[Budget]),
    USERELATIONSHIP(fProjectSales[StartDate], 'Calendar'[Date])
)
</code></pre>
    <p class="book-title--packt">As <code class="code-in-text--packt">USERELATIONSHIP</code> activates the relationship between the <code class="code-in-text--packt">fProjectSales</code> table and the <code class="code-in-text--packt">Calendar</code> table on the <code class="code-in-text--packt">StartDate</code> column, this measure returns the amount sold in each month. While this is valuable information in terms of order intake, when working with projects that may span multiple years, another valuable insight would be to have the project budget spread out over the duration of the project.</p>
    <p class="book-title--packt">There are several ways to do this. The easiest would be to divide the project budget by the duration of the project, and take that amount for each month that the project will run. This assumes that the income from the project will be evenly spread over the months. </p>
    <p class="book-title--packt">While the duration of a project could be derived from the <code class="code-in-text--packt">fFTE</code> table, a more convenient approach would be to have a duration column in the <code class="code-in-text--packt">ProjectType</code> table; after all, the duration is a fixed attribute of a project type. As the <code class="code-in-text--packt">fFTE</code> table starts counting months from zero, let us just take the highest month number, which is then one less than the actual duration of the project type. To avoid confusion, we will name this column <code class="code-in-text--packt">MaxMonth</code>:</p>
    <pre class="programlisting"><code class="hljs-code">MaxMonth = CALCULATE(MAX(fFTE[Month]))
</code></pre>
    <p class="book-title--packt">Note that we have to use <code class="code-in-text--packt">CALCULATE</code> here to make sure we get the largest <code class="code-in-text--packt">Month</code> value for the corresponding project types, not for all project types.</p>
    <p class="book-title--packt">Let us assume<a id="calibre_link-1241" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> that all calculations can be done on a month-by-month basis. The first month of the project, which is the month in which the start date of the project falls, is month zero; the last month is month zero plus <code class="code-in-text--packt">MaxMonth</code>. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">For the calculations in this chapter, it is important to understand the consequences of this assumption. As an example, consider a project with February 15, 2022, as the start date, and a <code class="code-in-text--packt">MaxMonth</code> value of 3. This <code class="code-in-text--packt">MaxMonth</code> value means that we have four months of <code class="code-in-text--packt">fFTE</code> data, for February, March, April, and May, 2022. The project budget will be spread over these four months. You could be tempted to think that the <em class="italic">duration</em> of this project is four months, meaning that the project would run until June 15; however, the month of June does not count for our calculations.</p>
    </div>
    <p class="book-title--packt">This means that, given a selection on the <code class="code-in-text--packt">Calendar</code>, a project is active during (part of) that time period when:</p>
    <ul class="calibre9">
      <li class="bullet">The first month of the project starts before the last date in the <code class="code-in-text--packt">Calendar</code> selection;</li>
      <li class="bullet"><em class="italic">And</em> the project's last month ends after the first date in the selection.</li>
    </ul>
    <p class="book-title--packt">The figure below illustrates this schematically for a few projects with <code class="code-in-text--packt">MaxMonth = 2</code>. </p>
    <figure class="mediaobject"><img src="images/000093.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.3: Active projects</p>
    <p class="book-title--packt">Our first challenge is to<a id="calibre_link-1242" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> determine the projects that are active during the selection on the <code class="code-in-text--packt">Calendar</code> table. The DAX formula below starts by filtering the <code class="code-in-text--packt">fProjectSales</code> table, implementing the logic outlined above:</p>
    <pre class="programlisting"><code class="hljs-code">Sales (over time) =
VAR MaxDate = MAX('Calendar'[Date])
VAR MinDate = MIN('Calendar'[Date])
RETURN
SUMX(
    FILTER(
        fProjectSales,
        EOMONTH(fProjectSales[StartDate], -1) + 1
        &lt;= MaxDate
        &amp;&amp; EOMONTH(
            fProjectSales[StartDate], RELATED(ProjectType[MaxMonth]
        ) &gt;= MinDate
    ),
</code></pre>
    <p class="book-title--packt">Let us pause here for a <a id="calibre_link-729" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>while and see what is happening. After storing the first and last days of the <code class="code-in-text--packt">Calendar</code> selection in <a id="calibre_link-461" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>variables, we traverse the <code class="code-in-text--packt">fProjectSales</code> table and apply the logic to retrieve the projects active within the selected period. The <code class="code-in-text--packt">EOMONTH</code> function adds a number of months to a date value, in this case <code class="code-in-text--packt">fProjectSales[StartDate]</code>, then moves that <a id="calibre_link-1007" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>date to the end of the month. The first <code class="code-in-text--packt">EOMONTH</code> expression returns <a id="calibre_link-958" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the last day of the <a id="calibre_link-787" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>month preceding the start date, and adding 1 day gives us the first day of month zero. Adding <code class="code-in-text--packt">MaxMonth</code> in the second <code class="code-in-text--packt">EOMONTH</code> expression brings us to the last day of the last month of the project.</p>
    <p class="book-title--packt">Now that we have<a id="calibre_link-1753" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> selected the right projects, we can continue calculating the desired results:</p>
    <pre class="programlisting"><code class="hljs-code">    VAR ProjectBudget = fProjectSales[Budget]
    VAR ProjectStartDate = fProjectSales[StartDate]
    VAR ProjectMaxMonth = RELATED(ProjectType[MaxMonth])
    VAR MonthlyBudget = 
        DIVIDE(
            ProjectBudget, 
            ProjectMaxMonth + 1
        )
    VAR ActiveMonths =
    CALCULATETABLE(
        DISTINCT('Calendar'[YearMonthCtr]),
        KEEPFILTERS(
            'Calendar'[Date] &gt;= ProjectStartDate
            &amp;&amp; 'Calendar'[Date] &lt;= 
            EOMONTH(ProjectStartDate, ProjectMaxMonth)
        )
    )
    RETURN
    COUNTROWS(ActiveMonths) * MonthlyBudget
)
</code></pre>
    <p class="book-title--packt">After declaring the variables containing the values we need for the calculation, the <code class="code-in-text--packt">ActiveMonths</code> variable is the list of months (or <code class="code-in-text--packt">YearMonthCtr</code> values &ndash; this being a continuously increasing counter at <a id="calibre_link-521" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>the month level) in the <code class="code-in-text--packt">Calendar</code> selection that are within the duration of the project: between the start date and the end date. Note the use of <code class="code-in-text--packt">KEEPFILTERS</code> here to avoid losing any <a id="calibre_link-531" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>filters on the <code class="code-in-text--packt">Calendar</code> table; in this way, we get the overlap between the <code class="code-in-text--packt">Calendar</code> selection and the project duration. </p>
    <p class="book-title--packt">The end result by project is the number of active months multiplied by the monthly project budget, which is the part of the total project budget expected to be spent during the selected period.</p>
    <p class="book-title--packt">The figure below shows the difference <a id="calibre_link-959" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>between the <code class="code-in-text--packt">Total Sales</code> and <code class="code-in-text--packt">Sales (over time)</code> measures, for <a id="calibre_link-1243" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>two sample projects:</p>
    <figure class="mediaobject"><img src="images/000115.png" alt="A picture containing graphical user interface  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.4: Total Sales and Sales (over time)</p>
    <p class="book-title--packt">In the chart, one project can be seen that starts in January 2021. The last month of this project is April 2022, and an evenly distributed amount is reported in every month between. A second project starts in February 2021, with a smaller total budget. The duration of the project is shorter, though; the budget is distributed over 5 months, indicating <a id="calibre_link-1244" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a <code class="code-in-text--packt">MaxMonth</code> value of 4.</p>
    <h2 id="calibre_link-241" class="calibre8">Optimizing the sales calculation</h2>
    <p class="book-title--packt">The flaw <a id="calibre_link-1245" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>in the <code class="code-in-text--packt">Sales (over time)</code> measure is, as you may have spotted already, that we iterate over a fact table. While you may assume that the number of multi-million projects sold is not super high, it is still worthwhile to see if we can change that.</p>
    <p class="book-title--packt">The clear indicator here is the use of <code class="code-in-text--packt">RELATED</code> to retrieve information from a filter table in the process. Whenever your table aggregation contains the <code class="code-in-text--packt">RELATED</code> function, you should <a id="calibre_link-1754" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>think about whether you can iterate over the filter table instead. In our case, the question is <a id="calibre_link-1490" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>whether we can do the same calculation while iterating over the <code class="code-in-text--packt">ProjectType</code> table, and more specifically, the (unique) values of <code class="code-in-text--packt">ProjectType[MaxMonth]</code>.</p>
    <p class="book-title--packt">If we were to iterate over <code class="code-in-text--packt">VALUES(ProjectType[MaxMonth])</code>, we could calculate the total budget for all projects with that duration at once. Unfortunately, that does not help us completely: the calculation of the overlap between selected months and project duration months is not possible with only the duration. </p>
    <p class="book-title--packt">For this alternative approach to work, we would also need to take the <code class="code-in-text--packt">Calendar</code> selection into account. Instead of doing the calculation for all months in the selection at once, we can go through the selection month by month. So, we iterate over the combinations of <code class="code-in-text--packt">MaxMonth</code> and <code class="code-in-text--packt">YearMonthCtr</code> values that are found in the query context. The table with combinations can be created using the <code class="code-in-text--packt">CROSSJOIN</code> function:</p>
    <pre class="programlisting"><code class="hljs-code">Sales (over time, optimized) =
VAR MonthDurationCombinations =
    CROSSJOIN(
        DISTINCT(ProjectType[MaxMonth]),
        DISTINCT('Calendar'[YearMonthCtr])
    )
RETURN
SUMX(
    MonthDurationCombinations,
    VAR ThisMaxMonth = ProjectType[MaxMonth]
    VAR ThisYearMonthCtr = 'Calendar'[YearMonthCtr]
    VAR MaxDate = 
    CALCULATE(
        MAX('Calendar'[Date]),
        ALL('Calendar'),
        'Calendar'[YearMonthCtr] = ThisYearMonthCtr
    )
    VAR MinDate =
    CALCULATE(
        MIN('Calendar'[Date]),
        ALL('Calendar'),
        'Calendar'[YearMonthCtr] = ThisYearMonthCtr &ndash; ThisMaxMonth
    )
    VAR TotalBudget = 
    CALCULATE(
        SUM(fProjectSales[Budget]),
        fProjectSales[StartDate] &lt;= MaxDate
        &amp;&amp; fProjectSales[StartDate] &gt;= MinDate
    )
    RETURN
    DIVIDE(TotalBudget, ThisMaxMonth + 1)
)
</code></pre>
    <p class="book-title--packt">For each combination<a id="calibre_link-1246" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> in the <code class="code-in-text--packt">MonthDurationCombinations</code> table, we first store the values in the <code class="code-in-text--packt">ThisMaxMonth</code> and <code class="code-in-text--packt">ThisYearMonthCtr</code> variables. Next, we need to select the projects active in this <a id="calibre_link-1008" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>particular month. We can do that using their start date, for which we have to derive the earliest, <code class="code-in-text--packt">MinDate</code>, and latest, <code class="code-in-text--packt">MaxDate</code>, possible start dates for a project to be active. The latest possible start date is, of course, the last day in this month; any project starting later is not yet active in this month. As for the earliest start dates, we can subtract <code class="code-in-text--packt">ThisMaxMonth</code> from the <code class="code-in-text--packt">YearMonthCtr</code> to find the earliest month possible. Any project starting earlier will have finished before this month starts. </p>
    <p class="book-title--packt">To illustrate this, the example in the figure below shows, for month 66 and <code class="code-in-text--packt">MaxMonth</code> 2, that the earliest possible start date of an active project is the first day of month 64. Any day earlier, like the upper project, and the month zero of the project is month 63 and there is no budget left for month 66. </p>
    <figure class="mediaobject"><img src="images/000135.png" alt="" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.5: Finding the earliest possible start date</p>
    <p class="book-title--packt">With this, we can<a id="calibre_link-1247" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> compute the total budget of all active projects at once and, as the calculation is done by <code class="code-in-text--packt">MaxMonth</code> value, it is easy to divide this by the current duration and retrieve the budget projected for the current month.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">The calculations involving <code class="code-in-text--packt">MaxMonth</code> are the reason why we use the month counter here, and not simply a month number: with the counter, we don't have to worry about year boundaries.</p>
    </div>
    <p class="book-title--packt">The number of iterations that <code class="code-in-text--packt">SUMX</code> has to do is equal to the number of different durations multiplied by the number of months in the query context. This will typically be only a small number and may be far better than traversing through all&nbsp;projects.</p>
    <h1 id="calibre_link-242" class="title">Calculating FTEs needed</h1>
    <p class="book-title--packt">Now that we have <a id="calibre_link-830" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>a view of the financial flows over time, let us turn toward analyzing the resources needed to staff the projects. As with the sales calculations, we will do this on a per-month basis, as the <code class="code-in-text--packt">fFTE</code> table provides this information by month.</p>
    <p class="book-title--packt">The result we are aiming for should make it possible to create output like in the figure below:</p>
    <figure class="mediaobject"><img src="images/000155.png" alt="Text  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.6: FTEs needed by location, project, role, and month</p>
    <p class="book-title--packt">For a few projects, you see the number of FTEs per role that are needed in each specific month. The calculation to achieve this is quite complicated, though the formula itself is not that long. We will go through it step by step. </p>
    <p class="book-title--packt">Let us first start with two basic aggregations:</p>
    <pre class="programlisting"><code class="hljs-code">TotalFTE = SUM(fFTE[FTE])
TotalNumber = SUM(fProjectSales[Number])
</code></pre>
    <p class="book-title--packt">Remember that the <code class="code-in-text--packt">Number</code> column denotes the size of a project relative to its type: for&nbsp;a project with <code class="code-in-text--packt">Number = 3</code>, we expect three times the FTEs associated with its project type.</p>
    <p class="book-title--packt">The query context for the visual above contains filters on <code class="code-in-text--packt">Year</code>, <code class="code-in-text--packt">Month</code>, <code class="code-in-text--packt">Location</code>, <code class="code-in-text--packt">Project</code>, and <code class="code-in-text--packt">Role</code> (except for totals and subtotals). Of these, <code class="code-in-text--packt">Year</code> and <code class="code-in-text--packt">Month</code> are fundamental: for each project active in that month, we need to determine which month it is within the<a id="calibre_link-831" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> duration of the project, and how many FTEs are needed in that month. </p>
    <p class="book-title--packt">The other filters simply select a subset of projects or FTEs. The measure therefore starts by iterating over the different months, again through the <code class="code-in-text--packt">YearMonthCtr</code> value:</p>
    <pre class="programlisting"><code class="hljs-code">FTEs needed =
SUMX(
    VALUES('Calendar'[YearMonthCtr]),
    VAR ThisYearMonthCtr = 'Calendar'[YearMonthCtr]
    RETURN
</code></pre>
    <p class="book-title--packt">We will not bother with the actual table aggregation (<code class="code-in-text--packt">SUMX</code> or something else) for now; rather, we will work in a single-month context to test the outcomes of the measure.</p>
    <p class="book-title--packt">The rest of the calculation heavily <a id="calibre_link-1491" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>depends on the project type: it determines the FTE profile over the months of the project, as well as the duration of the project. Let's iterate over the project types as well, and after we have zoomed in to one project type, we could go over all projects of that type, determine whether they are active in the current (in the iteration) month, and determine which month within the duration of the project we are looking at. With that, we can retrieve the FTE number from the <code class="code-in-text--packt">fFTE</code> table:</p>
    <pre class="programlisting"><code class="hljs-code">    SUMX(
        ProjectType,
        SUMX(
            fProjectSales,
            VAR ThisStartDate = fProjectSales[StartDate]
            VAR ThisStartCtr =
                CALCULATE(
                    MAX('Calendar'[YearMonthCtr]),
                    ALL('Calendar'), 
                    'Calendar'[Date] = ThisStartDate
                )
            VAR ProjectMonth = ThisYearMonthCtr &ndash; ThisStartCtr
</code></pre>
    <p class="book-title--packt">We iterate over <code class="code-in-text--packt">fProjectSales</code> and, for each project, store the start date in a variable. The <code class="code-in-text--packt">ThisStartCtr</code> variable is the month counter corresponding to the start date. The <code class="code-in-text--packt">ProjectMonth</code> variable computes which month in the project's duration the current month is, by simply <a id="calibre_link-832" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>subtracting <code class="code-in-text--packt">ThisStartCtr</code> from the counter of the current month. Note that <code class="code-in-text--packt">ProjectMonth</code> can be a negative value; this means that the project has not started yet. It can also be a number larger than the duration of the project. In both cases, no FTE number should be returned. Continuing with the last part of the calculation:</p>
    <pre class="programlisting"><code class="hljs-code">            VAR FTEsNeeded =
                CALCULATE(
                    [TotalFTE],
                    fFTE[Month] = ProjectMonth
                )
                RETURN
                FTEsNeeded * fProjectSales[Number]
        )
    )
)
</code></pre>
    <p class="book-title--packt">With the <code class="code-in-text--packt">FTEsNeeded</code> variable, we compute the sum of FTE values for the project month, which we then multiply by the <code class="code-in-text--packt">Number</code> value from <code class="code-in-text--packt">fProjectSales</code> for the end result.</p>
    <p class="book-title--packt">There is one critical flaw in this formula so far, which you may have spotted (if so, well done!). The problem is this: the <code class="code-in-text--packt">SUMX(fProjectSales,...</code> part is evaluated <em class="italic">in row context</em> of the <code class="code-in-text--packt">ProjectType</code> table. And in this row context, the relationships do not have any filters to propagate. In other words, the <code class="code-in-text--packt">fProjectSales</code> table here is the complete table, rather than only the rows that are associated with the current project type!</p>
    <p class="book-title--packt">The effect of this is that for each project type, projects are evaluated that are not linked to that project type. When you follow the code, you will see that the <code class="code-in-text--packt">ThisStartDate</code>, <code class="code-in-text--packt">ThisStartCtr</code>, and <code class="code-in-text--packt">ProjectMonth</code> variables are all evaluated correctly for these projects. However, the definition of the <code class="code-in-text--packt">FTEsNeeded</code> variable involves <code class="code-in-text--packt">CALCULATE</code>, which turns the row context into a filter context. The result is the FTEs needed for this project, even though it may not have the current project type. In other&nbsp;words: the results for a project are returned for all project types.</p>
    <p class="book-title--packt">Below is some <a id="calibre_link-833" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>sample output using this flawed measure. The results are four times as high as they should be, corresponding to the four project types in our model:</p>
    <figure class="mediaobject"><img src="images/000176.png" alt="Graphical user interface, text, application  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.7: Incorrect FTE results</p>
    <p class="book-title--packt">The solution for this problem is straightforward: all we have to do is to move from a row context to a filter context while iterating over the <code class="code-in-text--packt">ProjectType</code> table. This can be done by simply <a id="calibre_link-1755" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>adding <code class="code-in-text--packt">CALCULATE</code> <a id="calibre_link-1492" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>around the expression evaluated:</p>
    <pre class="programlisting"><code class="hljs-code">FTEs Needed 2 = 
SUMX(
    VALUES('Calendar'[YearMonthCtr]),
    VAR ThisYearMonthCtr = 'Calendar'[YearMonthCtr]
    RETURN
    SUMX(
        ProjectType,
        <span><strong class="hljs-slc">CALCULATE(</strong></span>
            SUMX(
                fProjectSales,
                VAR ThisStartDate = fProjectSales[StartDate]
                VAR ThisStartCtr =
                    CALCULATE(
                        MAX('Calendar'[YearMonthCtr]),
                        ALL('Calendar'),
                        'Calendar'[Date] = ThisStartDate
                    )
                VAR ProjectMonth = ThisYearMonthCtr - ThisStartCtr
                VAR FTEsNeeded =
                    CALCULATE(
                        [SumFTE],
                        fFTE[Month] = ProjectMonth
                    )
                RETURN
                FTEsNeeded * fProjectSales[Number]
            )
        <span><strong class="hljs-slc">)</strong></span>
    )
)
</code></pre>
    <p class="book-title--packt">With this formula, the FTE results are now calculated correctly. In fact, we created <em class="italic">Figure 2.8.6</em> using this measure.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">Generally, adding <code class="code-in-text--packt">CALCULATE</code> comes with its own issues. Wherever you have directly referenced a column value from the table to iterate over, which is a common thing to do, you will get an error after adding <code class="code-in-text--packt">CALCULATE</code>. This is because while you can directly retrieve the value of a column in a row context, in a filter context this is not possible, even if there is only one value there. You will have to<a id="calibre_link-834" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> aggregate the column using a basic aggregation. </p>
    </div>
    <h2 id="calibre_link-243" class="calibre8">Considering totals</h2>
    <p class="book-title--packt">We now have a<a id="calibre_link-827" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> working FTE calculation that returns valid results by month. What about the totals this measure returns?</p>
    <p class="book-title--packt">As you can see in the output in the figure below, the total by month is nicely computed to be the sum of the FTEs per location, project, or role. The total of the results by month, however, does not make much sense, being the sum of the monthly FTEs. </p>
    <p class="book-title--packt">This comes from the first <code class="code-in-text--packt">SUMX</code> in the <a id="calibre_link-1493" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>formula, which calculates by month and adds up all results for the total.</p>
    <figure class="mediaobject"><img src="images/000198.png" alt="A picture containing text  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.8: FTE result including column totals</p>
    <p class="book-title--packt">To return better total results, we must change this. <em class="italic">How</em> to change it is more a business decision than a technical problem. You could be interested in the peak capacity, in which case you<a id="calibre_link-828" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> should replace <code class="code-in-text--packt">SUMX(VALUES('Calendar'[YearMonthCtr])</code> with <code class="code-in-text--packt">MAXX(VALUES('Calendar'[YearMonthCtr])</code>. If you wanted to get insight into the general need for personnel, using <code class="code-in-text--packt">AVERAGEX(VALUES('Calendar'[YearMonthCtr])</code> would be a good option as well.</p>
    <h2 id="calibre_link-244" class="calibre8">Optimizing the FTE calculation</h2>
    <p class="book-title--packt">Like the sales <a id="calibre_link-822" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>measure earlier in this chapter, the FTE calculation as we have it now suffers from another problem: it iterates over our main fact table. It is worthwhile to ask ourselves if this can be improved.</p>
    <p class="book-title--packt">One easy improvement would be not to iterate over the <code class="code-in-text--packt">fProjectSales</code> table as a whole, but to compress the table by only looking at the unique combinations of fields needed. If you analyze the formula, you will find that we use only two fields from the <code class="code-in-text--packt">fProjectSales</code> table: <code class="code-in-text--packt">fProjectSales[StartDate]</code> and <code class="code-in-text--packt">fProjectSales[Number]</code>. </p>
    <p class="book-title--packt">The <code class="code-in-text--packt">SUMMARIZE</code> function can be used to retrieve only these columns:</p>
    <pre class="programlisting"><code class="hljs-code">SUMMARIZE(
    fProjectSales, 
    fProjectSales[StartDate]),
    fProjectSales[Number]
)
</code></pre>
    <p class="book-title--packt">In the measure formula, we can replace the <code class="code-in-text--packt">SUMX(fProjectSales, ...</code> with a <code class="code-in-text--packt">SUMX</code> over this <code class="code-in-text--packt">SUMMARIZE</code> expression. </p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">You can find the measure using <code class="code-in-text--packt">SUMMARIZE</code> in the model file for this chapter as <code class="code-in-text--packt">FTEs needed 2 (with SUMMARIZE)</code>.</p>
    </div>
    <p class="book-title--packt">In a context <a id="calibre_link-823" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>without any filters, the total number of iterations the measure processes now equals the number of months, multiplied by the number of project types, multiplied by the number of unique start dates per project type, multiplied by the number of unique <code class="code-in-text--packt">Number</code> values per project type.</p>
    <p class="book-title--packt">You may even go one <a id="calibre_link-1314" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>step further; as the <code class="code-in-text--packt">Number</code> column is only used as a multiplier for the FTE value from the <code class="code-in-text--packt">fFTE</code> table, we may instead use the total of the <code class="code-in-text--packt">Number</code> values for appropriate projects:</p>
    <pre class="programlisting"><code class="hljs-code">SUMMARIZE(
    fProjectSales,
    fProjectSales[StartDate],
    "TotalNumber", SUM(fProjectSales[Number])
)
</code></pre>
    <p class="book-title--packt">Here, we use the option in <code class="code-in-text--packt">SUMMARIZE</code> to add a calculated expression to the resulting table. Using this table, we iterate over all unique start dates for projects of the specific project type. The last step in the formula cannot, of course, directly reference the <code class="code-in-text--packt">Number</code> column now; indeed, the table does not contain a <code class="code-in-text--packt">Number</code> column anymore. Instead, refer to the <code class="code-in-text--packt">TotalNumber</code> column, in other words:</p>
    <pre class="programlisting"><code class="hljs-code">FTEsNeeded * [TotalNumber]
</code></pre>
    <p class="book-title--packt">Instead of:</p>
    <pre class="programlisting"><code class="hljs-code">FTEsNeeded * fProjectSales[Number]
</code></pre>
    <p class="book-title--packt">With this change, the maximum number of iterations for the measure is the number of months, multiplied by the number of <a id="calibre_link-1494" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>project types, multiplied by the number of unique start dates per <a id="calibre_link-824" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>project type.</p>
    <div class="note pcalibre5 pcalibre4">
      <p class="book-title--packt">In this model file, these changes can be found in the <code class="code-in-text--packt">FTEs needed 2 (with TotalNumber)</code> measure.</p>
    </div>
    <p class="book-title--packt">This is already a huge improvement. But can we optimize any further? In fact, we can. We can leave the <code class="code-in-text--packt">fProjectSales</code> table untouched and focus on the <code class="code-in-text--packt">fFTE</code> table instead. Stated differently: instead of going over the <code class="code-in-text--packt">fProjectSales</code> table, or a summarization of it, and<a id="calibre_link-462" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> retrieving the corresponding FTE amount (in the <code class="code-in-text--packt">FTEsNeeded</code> variable), we can go over the <code class="code-in-text--packt">fFTE</code> table and retrieve the corresponding <code class="code-in-text--packt">Number</code> amount from <code class="code-in-text--packt">fProjectSales</code>. The structure of the formula becomes a bit different:</p>
    <pre class="programlisting"><code class="hljs-code">FTEs Needed (through fFTE) = 
SUMX(
    VALUES('Calendar'[YearMonthCtr]),
    VAR ThisYearMonthCtr = 'Calendar'[YearMonthCtr]
    RETURN
    SUMX(
        ProjectType,
        VAR FTEMonths = CALCULATETABLE(VALUES(fFTE[Month]))
        RETURN
</code></pre>
    <p class="book-title--packt">For each project type, we retrieve the list of <code class="code-in-text--packt">Month</code> values from <code class="code-in-text--packt">fFTE</code>. Note that we need to use <code class="code-in-text--packt">CALCULATETABLE</code> here, as we are in row context and <code class="code-in-text--packt">fFTE</code> will not be filtered otherwise:</p>
    <pre class="programlisting"><code class="hljs-code">        SUMX(
            FTEMonths,
            VAR ThisFTEMonth = fFTE[Month]
            VAR MaxDate = 
                CALCULATE(
                    MAX('Calendar'[Date]),
                    ALL('Calendar'),
                    'Calendar'[YearMonthCtr] = 
                               ThisYearMonthCtr - ThisFTEMonth
                )
            VAR MinDate =
                CALCULATE(
                    MIN('Calendar'[Date]),
                    ALL('Calendar'),
                    'Calendar'[YearMonthCtr] = 
                               ThisYearMonthCtr - ThisFTEMonth
                )
            VAR TotalNumber = 
                CALCULATE(
                    SUM(fProjectSales[Number]),
                    fProjectSales[StartDate] &gt;= MinDate 
                    &amp;&amp; fProjectSales[StartDate] &lt;= MaxDate
                )
            VAR TotalFTE = 
                CALCULATE(
                    SUM(fFTE[FTE])
                )
            RETURN
            TotalNumber * TotalFTE
        )
    )
)
</code></pre>
    <p class="book-title--packt">For each <code class="code-in-text--packt">Month</code> value <a id="calibre_link-825" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>from <code class="code-in-text--packt">fFTE</code>, we now need to compute the total of the <code class="code-in-text--packt">Number</code> column for the corresponding projects. So, what are the corresponding projects? As an example, for <code class="code-in-text--packt">ThisFTEMonth = 3</code>, we need to find the projects for which <code class="code-in-text--packt">ThisYearMonthCtr</code> is their <a id="calibre_link-1756" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>third month. This is equivalent to finding projects with a start date in the month with counter value <code class="code-in-text--packt">ThisYearMonthCtr &ndash; ThisFTEMonth</code>. To easily determine which start dates are in that month, we rework that specific counter value into dates; this is what the <code class="code-in-text--packt">MaxDate</code> and <code class="code-in-text--packt">MinDate</code> variables are used for.</p>
    <p class="book-title--packt">The simple aggregation of FTE values in the <code class="code-in-text--packt">TotalFTE</code> variable takes the current project type and month into account automatically, as <code class="code-in-text--packt">CALCULATE</code> creates a filter context including filters for the outer <code class="code-in-text--packt">SUMX</code> iterations. Additionally, a filter on the <code class="code-in-text--packt">Role</code> table impacts the <code class="code-in-text--packt">TotalFTE</code> result as well, while filters that act on the <code class="code-in-text--packt">fProjectSales</code> table, like <code class="code-in-text--packt">Location</code>, impact the <code class="code-in-text--packt">TotalNumber</code> result. This means that we still have a calculation returning results that can be filtered by any attribute available.</p>
    <p class="book-title--packt">The number of iterations the measure has to go through is now the number of months, multiplied by the number of project types, multiplied by the number of months per project type. The best option out of the different optimizations discussed here depends on what the date in the model looks like. </p>
    <p class="book-title--packt">For instance, if there are many project types for very long durations, but only a few projects, the first measure may be the best; this one simply iterates <a id="calibre_link-826" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>on the projects and will be ready in a few iterations. However, in another scenario, you may expect the number of projects to be significantly higher than the number of project types and other supporting data, and therefore, the optimized measures presented here will make a difference.</p>
    <h1 id="calibre_link-245" class="title">Optimizing the Power BI model</h1>
    <p class="book-title--packt">While working your<a id="calibre_link-1102" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> way through the measures discussed in this chapter, you may have noticed that we do a lot with the <code class="code-in-text--packt">YearMonthCtr</code> column in the <code class="code-in-text--packt">Calendar</code> table. Additionally, we do a lot of translations from a project's start date to the corresponding month counter.</p>
    <p class="book-title--packt">Because of this, we have an opportunity to further optimize our solution, while making it easier to <a id="calibre_link-1757" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>understand and maintain, by doing this translation beforehand. This is a case where a calculated column could indeed be appropriate &ndash; although it would still be good to consider creating this column using Power Query.</p>
    <p class="book-title--packt">For now, let's create a calculated column in <code class="code-in-text--packt">fProjectSales</code> that contains the <code class="code-in-text--packt">YearMonthCtr</code> value corresponding to the project's start date:</p>
    <pre class="programlisting"><code class="hljs-code">StartCtr =
VAR ThisStartDate = [StartDate]
RETURN
CALCULATE(
    MAX('Calendar'[YearMonthCtr]),
    'Calendar'[Date] = ThisStartDate
)
</code></pre>
    <p class="book-title--packt">With the new <code class="code-in-text--packt">StartCtr</code> column, many of the formulas become a lot easier. The optimized <code class="code-in-text--packt">Sales</code> measure<a id="calibre_link-1758" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> would now look like this:</p>
    <pre class="programlisting"><code class="hljs-code">Sales (over time, further optimized) =
VAR MonthDurationCombinations =
    CROSSJOIN(
        DISTINCT(ProjectType[MaxMonth]),
        DISTINCT('Calendar'[YearMonthCtr])
    )
RETURN
SUMX(
    MonthDurationCombinations,
    VAR ThisMaxMonth = ProjectType[MaxMonth]
    VAR ThisYearMonthCtr = 'Calendar'[YearMonthCtr]
    VAR TotalBudget = 
    CALCULATE(
        SUM(fProjectSales[Budget]),
        fProjectSales[<span><strong class="hljs-slc">StartCtr</strong></span>] &lt;= ThisYearMonthCtr
        &amp;&amp; fProjectSales[<span><strong class="hljs-slc">StartCtr</strong></span>] &gt;= 
            ThisYearMonthCtr - ThisMaxMonth
    )
    RETURN
    DIVIDE(TotalBudget, ThisMaxMonth + 1)
)
</code></pre>
    <p class="book-title--packt">Instead of comparing the <code class="code-in-text--packt">StartDate</code> column with the first and last date in the current month, we can now simply <a id="calibre_link-1495" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>compare the <code class="code-in-text--packt">StartCtr</code> column with the first and last <code class="code-in-text--packt">YearMonthCtr</code> values. We no <a id="calibre_link-1315" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>longer have to define the <code class="code-in-text--packt">StartDate</code> or <code class="code-in-text--packt">EndDate</code> variables.</p>
    <p class="book-title--packt">The FTE calculation becomes easier as well. Instead of (in the <code class="code-in-text--packt">FTEs needed 2 (with SUMMARIZE)</code> measure) summarizing the <code class="code-in-text--packt">fProjectSales</code> table on <code class="code-in-text--packt">StartDate</code> and <code class="code-in-text--packt">Number</code> and computing the counter value for each <code class="code-in-text--packt">StartDate</code>, we now summarize on <code class="code-in-text--packt">StartCtr</code> and <code class="code-in-text--packt">Number</code>; we can find the correct set of projects for each <code class="code-in-text--packt">YearMontCtr</code> value without having to <a id="calibre_link-1103" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>translate a <code class="code-in-text--packt">StartDate</code> to a counter:</p>
    <pre class="programlisting"><code class="hljs-code">FTEs Needed 2 (with SUMMARIZE, further optimized) = 
SUMX(
    VALUES('Calendar'[YearMonthCtr]),
    VAR ThisYearMonthCtr = 'Calendar'[YearMonthCtr]
    RETURN
    SUMX(
        ProjectType,
        CALCULATE(
            SUMX(
                SUMMARIZE(
                        fProjectSales, 
                        fProjectSales[<code class="codehighlighted">StartCtr</code>], 
                        "TotalNumber", SUM(fProjectSales[Number])
                 ),
                <span><strong class="hljs-slc">VAR ThisStartCtr = fProjectSales[StartCtr]</strong></span>
                VAR ProjectMonth = ThisYearMonthCtr - ThisStartCtr
                VAR FTEsNeeded =
                    CALCULATE(
                        [SumFTE],
                        fFTE[Month] = ProjectMonth
                    )
                RETURN
                FTEsNeeded * [TotalNumber]
            )
        )
    )
)
</code></pre>
    <p class="book-title--packt">Likewise, the <code class="code-in-text--packt">FTE needed (through fFTE)</code> measure, which iterates over the <code class="code-in-text--packt">fFTE[Month]</code> values, becomes more <a id="calibre_link-1496" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>readable. Again, we don't have to define <code class="code-in-text--packt">MinDate</code> and <code class="code-in-text--packt">MaxDate</code> variables to <a id="calibre_link-463" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>compare a project's <code class="code-in-text--packt">StartDate</code> with; instead, the comparison is performed<a id="calibre_link-1104" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> directly on the counter:</p>
    <pre class="programlisting"><code class="hljs-code">FTEs Needed (through fFTE, further optimized) = 
SUMX(
    VALUES('Calendar'[YearMonthCtr]),
    VAR ThisYearMonthCtr = 'Calendar'[YearMonthCtr]
    RETURN
    SUMX(
           ProjectType,
           VAR FTEMonths = CALCULATETABLE(VALUES(fFTE[Month]))
           RETURN
           SUMX(
            FTEMonths,
                VAR ThisFTEMonth = fFTE[Month]
                <span><strong class="hljs-slc">VAR ThisStartCtr = ThisYearMonthCtr - ThisFTEMonth</strong></span> 
                VAR TotalNumber = 
                    CALCULATE(
                         SUM(fProjectSales[Number]),
                         <span><strong class="hljs-slc">fProjectSales[StartCtr] = ThisStartCtr</strong></span>
                    )
                VAR TotalFTE = 
                    CALCULATE(
                            SUM(fFTE[FTE])
                    )
                RETURN
                TotalNumber * TotalFTE
            )
    )
)
</code></pre>
    <p class="book-title--packt">Not only is the code shorter, but you can also expect better performance, as the date to counter<a id="calibre_link-1105" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> translation is not needed anymore.</p>
    <h1 id="calibre_link-246" class="title">Considering aggregation levels</h1>
    <p class="book-title--packt">The FTE calculation, as <a id="calibre_link-820" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a>we have designed it, computes the FTEs needed at the level of project type. This means that we simply add the FTE numbers for all projects with the same type. It is a business consideration as to whether this is what the organization really wants.</p>
    <p class="book-title--packt">For example, if an A1 project in Paris and an A1 project in London will run at the same time and each needs a 0.5 FTE project manager, we need 1 full-time project manager in total. While this is mathematically correct, you may argue that a single project manager will not be able to manage both projects. We may need boots on the ground, which practically excludes having someone travel between Paris and London all the time. The result would be that we need, in fact, two project managers.</p>
    <p class="book-title--packt">The simple solution to this would be to do the calculation on a by-location basis, adding another iteration to the measure. However, even if we compute 0.5 FTE twice, the end result is still 1 FTE. You can change this by rounding the result per location up to a whole number. We reuse the latest, optimized measure:</p>
    <pre class="programlisting"><code class="hljs-code">FTEs Needed (by location) =
SUMX(
    Location,
    ROUNDUP([FTEs needed (through fFTE, further optimized)], 0)
)
</code></pre>
    <p class="book-title--packt">The table below shows the results of the two measures side by side.</p>
    <figure class="mediaobject"><img src="images/000220.png" alt="Table  Description automatically generated" class="calibre14" /></figure>
    <p class="book-title--packt">Figure 2.8.9: FTEs needed by Location</p>
    <p class="book-title--packt">This is truly a business<a id="calibre_link-821" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"></a> question, as you could do the same thing on any level. For example, would it be possible for someone to act both as a project manager and as an analyst on the same project, or on different projects? If not, you may want to change the calculation to a by-role aggregation and round the results appropriately. The drawback of this, however, is that it becomes more difficult for the report user to understand what the meaning of the result is. </p>
    <p class="book-title--packt">The learning from this is that you should find a balance between calculating sophisticated results and providing insights that the user will understand. A well-designed report will help with that by not only providing the end result, but also allowing the user to dive into the details and see why the result is what it is.</p>
    <h1 id="calibre_link-247" class="title">Summary</h1>
    <p class="book-title--packt">In this chapter, we have discussed ways to analyze the need for professionals to carry out projects. From a technical perspective, you have learned ways to work with multiple fact tables that must be considered in combination to provide useful results. </p>
    <p class="book-title--packt">The challenge is not only to come up with correct results, but to find the optimal way to compute those results as well. Starting with a calculation per project, with an iteration over the <code class="code-in-text--packt">fProjectSales</code> fact table in our model, the next step is to consider possible ways to minimize the work done by not iterating over a fact table, but over either filter tables or a summarization of a fact table.</p>
    <p class="normal">* * *</p>
    <p class="book-title--packt">With this chapter, the book comes to an end. You have come a long way and seen many different business scenarios, as well as a diversity of DAX techniques. If we were to summarize the message of this book as a whole, and <em class="italic">Part 2</em> in particular, a number of conclusions come to mind:</p>
    <ul class="calibre9">
      <li class="bullet">The possibilities in what can be done with DAX are endless.</li>
      <li class="bullet">Using a Power BI model, a well-structured model is foundational, but the power of DAX goes way beyond that. Do not solve in data what you can do in DAX measures!</li>
      <li class="bullet">Context is everything. Every advanced solution starts with considering the context in which results are needed, the context that will deliver those results, and how to transform one into the other. Virtually any problem with DAX results is solved by studying the context first.</li>
      <li class="bullet">Most of the scenarios in <em class="italic">Part 2</em> of this book involve DAX table functions, which is not a coincidence. Though they are among the most complex features of DAX, table functions provide capabilities enabling analyses that are impossible to establish without them.</li>
      <li class="bullet">Performance is always important when designing and building DAX calculations. When using DAX table functions, the key is to minimize the number of iterations in table aggregations; in other words, only iterate over tables with as few rows as possible. It is even better not to iterate at all, but to use virtual tables as filters instead.</li>
    </ul>
    <p class="book-title--packt">Our hope is to have inspired you to further work on your DAX skills and to go ahead and tackle your business problems using DAX-based analyses. Good luck!</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-264">
<div id="calibre_link-1759" class="calibre2">
<div id="calibre_link-1760" class="calibre3"><div id="calibre_link-1761" class="calibre4">
    <p class="eop"><img src="images/000037.png" alt="" class="calibre22" /></p>
    <p class="book-title--packt"><a href="http://packt.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">packt.com</span></a></p>
    <p class="book-title--packt">Subscribe to our online digital library for full access to over 7,000 books and videos, as well as industry leading tools to help you plan your personal development and advance your career. For more information, please visit our website.</p>
    <h1 id="calibre_link-1762" class="title">Why subscribe?</h1>
    <ul class="calibre9">
      <li class="bullet">Spend less time learning and more time coding with practical eBooks and Videos from over 4,000 industry professionals</li>
      <li class="bullet">Learn better with Skill Plans built especially for you</li>
      <li class="bullet">Get a free eBook or video every month</li>
      <li class="bullet">Fully searchable for easy access to vital information</li>
      <li class="bullet">Copy and paste, print, and bookmark content</li>
    </ul>
    <p class="book-title--packt">Did you know that Packt offers eBook versions of every book published, with PDF and ePub files available? You can upgrade to the eBook version at <a href="http://www.Packt.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">www.Packt.com</span></a> and as a print book customer, you are entitled to a discount on the eBook copy. Get in touch with us at <a href="mailto:customercare@packtpub.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">customercare@packtpub.com</span></a> for more details.</p>
    <p class="book-title--packt">At <a href="http://www.Packt.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">www.Packt.com</span></a>, you can also read a collection of free technical articles, sign up for a range of free newsletters, and receive exclusive discounts and offers on Packt books and eBooks.</p>
<p class="eop"></p>
    <h1 id="calibre_link-248" class="introduction-title--packt">Other Books You May Enjoy</h1>
    <p class="book-title--packt">If you enjoyed this book, you may be interested in these other books by Packt:</p>
    <p class="book-title--packt"><a href="https://www.packtpub.com/product/microsoft-power-bi-cookbook-second-edition/9781801813044" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><img src="images/000101.png" alt="" class="calibre23" /></a></p>
    <p class="book-title--packt"><strong class="screentext">Microsoft Power BI Cookbook &ndash; Second Edition</strong></p>
    <p class="book-title--packt">Greg Deckler</p>
    <p class="book-title--packt">Brett Powell</p>
    <p class="book-title--packt">ISBN: 978-1-80181-304-4</p>
    <ul class="calibre9">
      <li class="bullet">Cleanse, stage, and integrate your data sources with Power Query (M)</li>
      <li class="bullet">Remove data complexities and provide users with intuitive, self-service BI capabilities</li>
      <li class="bullet">Build business logic and analysis into your solutions via the DAX programming language and dashboard-ready calculations</li>
      <li class="bullet">Implement aggregation tables to accelerate query performance over large data sources</li>
      <li class="bullet">Create and integrate paginated reports</li>
      <li class="bullet">Understand the differences and implications of DirectQuery, live connections, Import, and Composite model datasets</li>
      <li class="bullet">Integrate other Microsoft data tools into your Power BI solution</li>
    </ul>
<p class="eop"></p>
    <p class="book-title--packt"><a href="https://www.packtpub.com/product/microsoft-power-bi-quick-start-guide-second-edition/9781800561571" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><img src="images/000080.png" alt="" class="calibre24" /></a></p>
    <p class="book-title--packt"><strong class="screentext">Microsoft Power BI Quick Start Guide &ndash; Second Edition</strong></p>
    <p class="book-title--packt">Devin Knight</p>
    <p class="book-title--packt">Mitchell Pearson</p>
    <p class="book-title--packt">Bradley Schacht</p>
    <p class="book-title--packt">Erin Ostrowsky</p>
    <p class="book-title--packt">ISBN: 978-1-80056-157-1</p>
    <ul class="calibre9">
      <li class="bullet">Connect to data sources using import and DirectQuery options</li>
      <li class="bullet">Use Query Editor for data transformation and data cleansing processes, including writing M and R scripts and dataflows to do the same in the cloud</li>
      <li class="bullet">Design optimized data models by designing relationships and DAX calculations</li>
      <li class="bullet">Design effective reports with built-in and custom visuals</li>
      <li class="bullet">Adopt Power BI Desktop and Service to implement row-level security</li>
      <li class="bullet">Administer a Power BI cloud tenant for your organization</li>
      <li class="bullet">Use built-in AI capabilities to enhance Power BI data transformation techniques</li>
      <li class="bullet">Deploy your Power BI desktop files into the Power BI Report Server</li>
    </ul>
<p class="eop"></p>
    <h1 id="calibre_link-1763" class="title">Packt is searching for authors like you</h1>
    <p class="book-title--packt">If you're interested in becoming an author for Packt, please visit <a href="http://authors.packtpub.com" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2"><span class="url">authors.packtpub.com</span></a> and apply today. We have worked with thousands of developers and tech professionals, just like you, to help them share their insight with the global tech community. You can make a general application, apply for a specific hot topic that we are recruiting an author for, or submit your own idea.</p>
  </div>
  <div id="calibre_link-1764" class="calibre4">
    <h1 id="calibre_link-1765" class="title">Share Your Thoughts</h1>
    <p class="book-title--packt">Now you've finished <em class="italic">Extreme DAX</em>, we'd love to hear your thoughts! If you purchased the book from Amazon, please <a href="https://packt.link/r/1801078513" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">click here to go straight to the Amazon review page</a> for this book and share your feedback or leave a review on the site that you purchased it from.</p>
    <p class="book-title--packt">Your review is important to us and the tech community and will help us make sure we're delivering excellent quality content.</p>
  </div>
</div>
</div>
</div>


<div class="calibre1" id="calibre_link-266">
<div id="calibre_link-1766" class="calibre2">
<div id="calibre_link-1767" class="calibre3"><div id="calibre_link-250" type="index" class="calibre4">
    <h1 id="calibre_link-249" class="title">Index</h1>
    <p class="book-title--packt">Symbols</p>
    <p class="book-title--packt">^ operator function <a href="#calibre_link-267" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">347</a></p>
    <p class="book-title--packt">A</p>
    <p class="book-title--packt">ADDCOLUMNS function , <a href="#calibre_link-268" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">201</a>, <a href="#calibre_link-269" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">205</a>, <a href="#calibre_link-270" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">60</a>, <a href="#calibre_link-271" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">206</a>, <a href="#calibre_link-272" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">227</a></p>
    <p class="book-title--packt">advanced hierarchy navigation</p>
    <p class="book-title--packt">in RLS <a href="#calibre_link-273" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">141</a>, <a href="#calibre_link-274" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">142</a>, <a href="#calibre_link-275" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">143</a>, <a href="#calibre_link-276" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">144</a></p>
    <p class="book-title--packt">aggregation level</p>
    <p class="book-title--packt">securing, as attribute <a href="#calibre_link-277" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">165</a>, <a href="#calibre_link-278" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">166</a>, <a href="#calibre_link-279" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">167</a>, <a href="#calibre_link-280" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">168</a>, <a href="#calibre_link-281" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">169</a></p>
    <p class="book-title--packt">aggregation levels</p>
    <p class="book-title--packt">fact table granularity, restricting <a href="#calibre_link-282" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">156</a></p>
    <p class="book-title--packt">securing <a href="#calibre_link-283" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">156</a></p>
    <p class="book-title--packt">securing, with DIY composite models <a href="#calibre_link-284" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">157</a>, <a href="#calibre_link-285" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">158</a>, <a href="#calibre_link-286" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">159</a>, <a href="#calibre_link-287" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">160</a>, <a href="#calibre_link-288" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">161</a>, <a href="#calibre_link-289" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">162</a></p>
    <p class="book-title--packt">aggregation security</p>
    <p class="book-title--packt">combining, with value-level security (VLS) <a href="#calibre_link-290" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">162</a>, <a href="#calibre_link-291" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">163</a>, <a href="#calibre_link-292" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">164</a>, <a href="#calibre_link-293" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">165</a></p>
    <p class="book-title--packt">ALLCROSSFILTERED function <a href="#calibre_link-294" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a>, <a href="#calibre_link-295" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">84</a></p>
    <p class="book-title--packt">ALLEXCEPT function <a href="#calibre_link-296" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a>, <a href="#calibre_link-297" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">103</a>, <a href="#calibre_link-298" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">320</a>, <a href="#calibre_link-299" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">321</a>, <a href="#calibre_link-300" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">322</a></p>
    <p class="book-title--packt">ALL function <a href="#calibre_link-301" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">82</a></p>
    <p class="book-title--packt">filters, removing with <a href="#calibre_link-302" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">82</a>, <a href="#calibre_link-303" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a>, <a href="#calibre_link-304" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">84</a>, <a href="#calibre_link-305" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">85</a></p>
    <p class="book-title--packt">ALLNOBLANKROW function , <a href="#calibre_link-306" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a></p>
    <p class="book-title--packt">ALLSELECTED function <a href="#calibre_link-307" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a></p>
    <p class="book-title--packt">Analysis Services (SSAS) <a href="#calibre_link-308" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">app owns data <a href="#calibre_link-309" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">122</a></p>
    <p class="book-title--packt">approximation</p>
    <p class="book-title--packt">cost-covering rent, determining by <a href="#calibre_link-310" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">357</a>, <a href="#calibre_link-311" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">358</a>, <a href="#calibre_link-312" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">359</a>, <a href="#calibre_link-313" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">360</a>, <a href="#calibre_link-314" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">361</a></p>
    <p class="book-title--packt">optimizing <a href="#calibre_link-315" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">362</a>, <a href="#calibre_link-316" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">363</a>, <a href="#calibre_link-317" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">365</a>, <a href="#calibre_link-318" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">366</a>, <a href="#calibre_link-319" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">367</a></p>
    <p class="book-title--packt">attributes</p>
    <p class="book-title--packt">aggregation level, securing as <a href="#calibre_link-320" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">165</a>, <a href="#calibre_link-321" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">166</a>, <a href="#calibre_link-322" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">167</a>, <a href="#calibre_link-323" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">168</a>, <a href="#calibre_link-324" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">169</a></p>
    <p class="book-title--packt">securing <a href="#calibre_link-325" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">144</a></p>
    <p class="book-title--packt">securing, case <a href="#calibre_link-326" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">144</a>, <a href="#calibre_link-327" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">145</a></p>
    <p class="book-title--packt">securing, dynamically <a href="#calibre_link-328" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">146</a>, <a href="#calibre_link-329" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">147</a></p>
    <p class="book-title--packt">AutoExist <a href="#calibre_link-330" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">233</a>, <a href="#calibre_link-331" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">243</a></p>
    <p class="book-title--packt">model structure, modifying to get around <a href="#calibre_link-332" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">260</a>, <a href="#calibre_link-333" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">261</a>, <a href="#calibre_link-334" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">262</a></p>
    <p class="book-title--packt">multiple filters, using in visual <a href="#calibre_link-335" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">244</a>, <a href="#calibre_link-336" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">245</a></p>
    <p class="book-title--packt">need for <a href="#calibre_link-337" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">243</a></p>
    <p class="book-title--packt">report performance, optimizing with <a href="#calibre_link-338" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">267</a></p>
    <p class="book-title--packt">used, for optimizing DAX evaluation <a href="#calibre_link-339" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">245</a>, <a href="#calibre_link-340" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">246</a>, <a href="#calibre_link-341" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">248</a></p>
    <p class="book-title--packt">AutoExist, missing workdays <a href="#calibre_link-342" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">248</a></p>
    <p class="book-title--packt">business case <a href="#calibre_link-343" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">249</a></p>
    <p class="book-title--packt">Calendar table, extending <a href="#calibre_link-344" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">253</a>, <a href="#calibre_link-345" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">254</a>, <a href="#calibre_link-346" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">255</a></p>
    <p class="book-title--packt">issue <a href="#calibre_link-347" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">258</a>, <a href="#calibre_link-348" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">259</a></p>
    <p class="book-title--packt">model structure <a href="#calibre_link-349" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">250</a>, <a href="#calibre_link-350" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">251</a></p>
    <p class="book-title--packt">order intake analysis <a href="#calibre_link-351" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">251</a>, <a href="#calibre_link-352" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">252</a>, <a href="#calibre_link-353" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">253</a></p>
    <p class="book-title--packt">workday analysis <a href="#calibre_link-354" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">255</a>, <a href="#calibre_link-355" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">256</a>, <a href="#calibre_link-356" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">257</a></p>
    <p class="book-title--packt">AVERAGE function <a href="#calibre_link-357" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">95</a>, <a href="#calibre_link-358" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">97</a>, <a href="#calibre_link-359" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">98</a>, <a href="#calibre_link-360" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a>, <a href="#calibre_link-361" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">109</a>, <a href="#calibre_link-362" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">110</a>, <a href="#calibre_link-363" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">309</a></p>
    <p class="book-title--packt">AVERAGEX function <a href="#calibre_link-364" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">92</a>, <a href="#calibre_link-365" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">100</a>, <a href="#calibre_link-366" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">101</a>, <a href="#calibre_link-367" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">103</a></p>
    <p class="book-title--packt">Azure Analysis Services (AAS) <a href="#calibre_link-368" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a>, <a href="#calibre_link-369" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">10</a></p>
    <p class="book-title--packt">B</p>
    <p class="book-title--packt">basic DAX functions</p>
    <p class="book-title--packt">creating, for KPIs <a href="#calibre_link-370" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">175</a>, <a href="#calibre_link-371" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a></p>
    <p class="book-title--packt">Binary data type <a href="#calibre_link-372" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">25</a></p>
    <p class="book-title--packt">BI solution development</p>
    <p class="book-title--packt">Power BI models, using to accelerate <a href="#calibre_link-373" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">14</a>, <a href="#calibre_link-374" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">15</a></p>
    <p class="book-title--packt">traditional approach <a href="#calibre_link-375" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">13</a>, <a href="#calibre_link-376" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">14</a></p>
    <p class="book-title--packt">traditional approach, principles <a href="#calibre_link-377" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">15</a>, <a href="#calibre_link-378" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">16</a>, <a href="#calibre_link-379" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">17</a></p>
    <p class="book-title--packt">business, between QuantoBikes subsidiaries</p>
    <p class="book-title--packt">intercompany business, visualizing <a href="#calibre_link-380" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">289</a>, <a href="#calibre_link-381" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">290</a>, <a href="#calibre_link-382" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">291</a>, <a href="#calibre_link-383" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">292</a>, <a href="#calibre_link-384" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">293</a>, <a href="#calibre_link-385" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">294</a></p>
    <p class="book-title--packt">internal sales, matching <a href="#calibre_link-386" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">284</a>, <a href="#calibre_link-387" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">285</a>, <a href="#calibre_link-388" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">286</a>, <a href="#calibre_link-389" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">287</a>, <a href="#calibre_link-390" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">288</a>, <a href="#calibre_link-391" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">289</a></p>
    <p class="book-title--packt">purchases, matching <a href="#calibre_link-392" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">284</a>, <a href="#calibre_link-393" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">285</a>, <a href="#calibre_link-394" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">286</a>, <a href="#calibre_link-395" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">287</a>, <a href="#calibre_link-396" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">288</a>, <a href="#calibre_link-397" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">289</a></p>
    <p class="book-title--packt">subsidiary view, versus consolidated view <a href="#calibre_link-398" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">282</a>, <a href="#calibre_link-399" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">283</a>, <a href="#calibre_link-400" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">284</a></p>
    <p class="book-title--packt">business case <a href="#calibre_link-401" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">172</a>, <a href="#calibre_link-402" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">174</a>, <a href="#calibre_link-403" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">338</a>, <a href="#calibre_link-404" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">339</a>, <a href="#calibre_link-405" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">340</a></p>
    <p class="book-title--packt">business intelligence</p>
    <p class="book-title--packt">Five-Layer model <a href="#calibre_link-406" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">4</a>, <a href="#calibre_link-407" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">business model <a href="#calibre_link-408" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">338</a>, <a href="#calibre_link-409" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">339</a>, <a href="#calibre_link-410" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">340</a></p>
    <p class="book-title--packt">C</p>
    <p class="book-title--packt">calculated columns <a href="#calibre_link-411" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">50</a>, <a href="#calibre_link-412" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">51</a></p>
    <p class="book-title--packt">calculated fields <a href="#calibre_link-413" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">54</a></p>
    <p class="book-title--packt">calculated tables <a href="#calibre_link-414" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">52</a>, <a href="#calibre_link-415" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">53</a></p>
    <p class="book-title--packt">CALCULATE function</p>
    <p class="book-title--packt">used, for filtering <a href="#calibre_link-416" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">76</a>, <a href="#calibre_link-417" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">77</a>, <a href="#calibre_link-418" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">78</a>, <a href="#calibre_link-419" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">79</a>, <a href="#calibre_link-420" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">80</a>, <a href="#calibre_link-421" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">81</a>, <a href="#calibre_link-422" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">82</a></p>
    <p class="book-title--packt">used, for filtering DAX <a href="#calibre_link-423" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">75</a>, <a href="#calibre_link-424" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">76</a></p>
    <p class="book-title--packt">CALCULATETABLE</p>
    <p class="book-title--packt">using <a href="#calibre_link-425" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">100</a>, <a href="#calibre_link-426" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">101</a></p>
    <p class="book-title--packt">CALCULATETABLE function <a href="#calibre_link-427" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">107</a>, <a href="#calibre_link-428" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">219</a>, <a href="#calibre_link-429" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">220</a>, <a href="#calibre_link-430" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">227</a>, <a href="#calibre_link-431" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">228</a>, <a href="#calibre_link-432" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">239</a>, <a href="#calibre_link-433" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">242</a>, <a href="#calibre_link-434" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">243</a>, <a href="#calibre_link-435" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">296</a>, <a href="#calibre_link-436" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">301</a>, <a href="#calibre_link-437" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">303</a>, <a href="#calibre_link-438" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">304</a>, <a href="#calibre_link-439" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">306</a>, <a href="#calibre_link-440" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">307</a>, <a href="#calibre_link-441" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">308</a>, <a href="#calibre_link-442" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">317</a>, <a href="#calibre_link-443" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">318</a>, <a href="#calibre_link-444" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">319</a>, <a href="#calibre_link-445" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">321</a>, <a href="#calibre_link-446" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">325</a>, <a href="#calibre_link-447" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a>, <a href="#calibre_link-448" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">327</a>, <a href="#calibre_link-449" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">383</a>, <a href="#calibre_link-450" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">384</a>, <a href="#calibre_link-451" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">386</a>, <a href="#calibre_link-452" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">389</a>, <a href="#calibre_link-453" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">390</a>, <a href="#calibre_link-454" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">393</a>, <a href="#calibre_link-455" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">395</a>, <a href="#calibre_link-456" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">398</a>, <a href="#calibre_link-457" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">399</a>, <a href="#calibre_link-458" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">401</a>, <a href="#calibre_link-459" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">404</a>, <a href="#calibre_link-460" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">407</a>, <a href="#calibre_link-461" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">418</a>, <a href="#calibre_link-462" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">430</a>, <a href="#calibre_link-463" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">434</a></p>
    <p class="book-title--packt">calculation and date columns</p>
    <p class="book-title--packt">selecting, dynamically <a href="#calibre_link-464" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">180</a>, <a href="#calibre_link-465" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">181</a>, <a href="#calibre_link-466" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">182</a>, <a href="#calibre_link-467" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">183</a>, <a href="#calibre_link-468" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">185</a></p>
    <p class="book-title--packt">CALENDARAUTO function , <a href="#calibre_link-469" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">60</a></p>
    <p class="book-title--packt">CALENDAR function <a href="#calibre_link-470" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">59</a>, <a href="#calibre_link-471" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">60</a>, <a href="#calibre_link-472" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">61</a>, <a href="#calibre_link-473" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">201</a>, <a href="#calibre_link-474" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">205</a></p>
    <p class="book-title--packt">cardinality <a href="#calibre_link-475" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">37</a></p>
    <p class="book-title--packt">cash flows <a href="#calibre_link-476" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">333</a></p>
    <p class="book-title--packt">COALESCE function <a href="#calibre_link-477" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">255</a></p>
    <p class="book-title--packt">collective analytics <a href="#calibre_link-478" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">7</a></p>
    <p class="book-title--packt">columnar database <a href="#calibre_link-479" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">23</a>, <a href="#calibre_link-480" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a></p>
    <p class="book-title--packt">complex calculations</p>
    <p class="book-title--packt">testing <a href="#calibre_link-481" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a>, <a href="#calibre_link-482" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">327</a>, <a href="#calibre_link-483" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">328</a>, <a href="#calibre_link-484" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">329</a></p>
    <p class="book-title--packt">consolidated view</p>
    <p class="book-title--packt">versus subsidiary view <a href="#calibre_link-485" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">282</a>, <a href="#calibre_link-486" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">283</a>, <a href="#calibre_link-487" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">284</a></p>
    <p class="book-title--packt">CONTAINS function <a href="#calibre_link-488" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">311</a>, <a href="#calibre_link-489" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">378</a></p>
    <p class="book-title--packt">context transformation <a href="#calibre_link-490" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">75</a></p>
    <p class="book-title--packt">control table <a href="#calibre_link-491" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a></p>
    <p class="book-title--packt">cost-covering rent (CCR)</p>
    <p class="book-title--packt"> approximation, optimizing <a href="#calibre_link-492" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">362</a>, <a href="#calibre_link-493" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">363</a>, <a href="#calibre_link-494" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">364</a>, <a href="#calibre_link-495" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">365</a>, <a href="#calibre_link-496" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">366</a>, <a href="#calibre_link-497" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">367</a></p>
    <p class="book-title--packt">calculating <a href="#calibre_link-498" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">356</a>, <a href="#calibre_link-499" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">357</a></p>
    <p class="book-title--packt">determining, by approximation <a href="#calibre_link-500" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">357</a>, <a href="#calibre_link-501" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">358</a>, <a href="#calibre_link-502" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">359</a>, <a href="#calibre_link-503" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">360</a>, <a href="#calibre_link-504" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">361</a></p>
    <p class="book-title--packt">COUNTROWS function <a href="#calibre_link-505" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">70</a>, <a href="#calibre_link-506" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">92</a>, <a href="#calibre_link-507" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">142</a>, <a href="#calibre_link-508" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">161</a>, <a href="#calibre_link-509" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">163</a>, <a href="#calibre_link-510" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">220</a>, <a href="#calibre_link-511" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">221</a>, <a href="#calibre_link-512" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">247</a>, <a href="#calibre_link-513" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">254</a>, <a href="#calibre_link-514" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">311</a>, <a href="#calibre_link-515" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">317</a>, <a href="#calibre_link-516" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">320</a>, <a href="#calibre_link-517" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a>, <a href="#calibre_link-518" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">327</a>, <a href="#calibre_link-519" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">393</a>, <a href="#calibre_link-520" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">409</a>, <a href="#calibre_link-521" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">419</a></p>
    <p class="book-title--packt">cross filter direction <a href="#calibre_link-522" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">33</a>, <a href="#calibre_link-523" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">34</a>, <a href="#calibre_link-524" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">35</a>, <a href="#calibre_link-525" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">36</a></p>
    <p class="book-title--packt">CROSSJOIN function <a href="#calibre_link-526" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">99</a>, <a href="#calibre_link-527" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">291</a>, <a href="#calibre_link-528" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">292</a>, <a href="#calibre_link-529" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">382</a>, <a href="#calibre_link-530" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">383</a>, <a href="#calibre_link-531" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">187</a></p>
    <p class="book-title--packt">CROSSJOIN functions <a href="#calibre_link-532" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">cross-report drillthrough <a href="#calibre_link-533" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">157</a></p>
    <p class="book-title--packt">current sales order calculation</p>
    <p class="book-title--packt">corrections, for sales orders behind schedule <a href="#calibre_link-534" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">321</a>, <a href="#calibre_link-535" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">322</a>, <a href="#calibre_link-536" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">324</a></p>
    <p class="book-title--packt">dealing, with invoice surplus <a href="#calibre_link-537" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">314</a>, <a href="#calibre_link-538" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">315</a>, <a href="#calibre_link-539" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">316</a>, <a href="#calibre_link-540" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">318</a>, <a href="#calibre_link-541" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">319</a></p>
    <p class="book-title--packt">dealing with, on schedule <a href="#calibre_link-542" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">319</a>, <a href="#calibre_link-543" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">320</a>, <a href="#calibre_link-544" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">321</a></p>
    <p class="book-title--packt">optimizing <a href="#calibre_link-545" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">312</a>, <a href="#calibre_link-546" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">313</a>, <a href="#calibre_link-547" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">314</a></p>
    <p class="book-title--packt">current sales orders</p>
    <p class="book-title--packt">dealing with <a href="#calibre_link-548" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">305</a>, <a href="#calibre_link-549" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">306</a>, <a href="#calibre_link-550" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">307</a>, <a href="#calibre_link-551" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">308</a>, <a href="#calibre_link-552" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">309</a>, <a href="#calibre_link-553" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">310</a>, <a href="#calibre_link-554" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">311</a>, <a href="#calibre_link-555" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">312</a></p>
    <p class="book-title--packt">D</p>
    <p class="book-title--packt">Data Model <a href="#calibre_link-556" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">8</a></p>
    <p class="book-title--packt">data modeling</p>
    <p class="book-title--packt">for status-oriented data <a href="#calibre_link-557" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">370</a>, <a href="#calibre_link-558" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">371</a>, <a href="#calibre_link-559" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">372</a>, <a href="#calibre_link-560" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">373</a>, <a href="#calibre_link-561" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">374</a>, <a href="#calibre_link-562" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">375</a></p>
    <p class="book-title--packt">DATATABLE function , <a href="#calibre_link-402" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">53</a>, <a href="#calibre_link-563" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">177</a></p>
    <p class="book-title--packt">DATEADD function , <a href="#calibre_link-564" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">252</a></p>
    <p class="book-title--packt">Date selection table</p>
    <p class="book-title--packt">options, creating <a href="#calibre_link-565" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">226</a>, <a href="#calibre_link-566" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">227</a>, <a href="#calibre_link-567" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">228</a>, <a href="#calibre_link-568" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">229</a></p>
    <p class="book-title--packt">using, in measures <a href="#calibre_link-569" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">229</a>, <a href="#calibre_link-570" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">230</a>, <a href="#calibre_link-571" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">231</a></p>
    <p class="book-title--packt">Date Selection table <a href="#calibre_link-572" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">223</a>, <a href="#calibre_link-573" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">224</a>, <a href="#calibre_link-574" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">225</a>, <a href="#calibre_link-575" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">226</a></p>
    <p class="book-title--packt">DATESINPERIOD function <a href="#calibre_link-576" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">88</a>, <a href="#calibre_link-577" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">175</a>, <a href="#calibre_link-578" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a>, <a href="#calibre_link-579" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">183</a>, <a href="#calibre_link-580" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">184</a>, <a href="#calibre_link-581" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">185</a>, <a href="#calibre_link-582" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">192</a>, <a href="#calibre_link-583" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">219</a>, <a href="#calibre_link-584" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">393</a>, <a href="#calibre_link-585" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">394</a>, <a href="#calibre_link-586" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">396</a>, <a href="#calibre_link-587" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">400</a>, <a href="#calibre_link-588" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">402</a>, <a href="#calibre_link-589" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">405</a>, <a href="#calibre_link-590" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">408</a></p>
    <p class="book-title--packt">DATESMTD function , <a href="#calibre_link-591" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">256</a></p>
    <p class="book-title--packt">DATESYTD function <a href="#calibre_link-592" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">86</a>, <a href="#calibre_link-593" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">87</a>, <a href="#calibre_link-594" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">88</a>, <a href="#calibre_link-595" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">103</a>, <a href="#calibre_link-596" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">211</a></p>
    <p class="book-title--packt">date tables <a href="#calibre_link-597" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">58</a>, <a href="#calibre_link-598" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">59</a></p>
    <p class="book-title--packt">creating <a href="#calibre_link-599" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">59</a>, <a href="#calibre_link-600" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">60</a>, <a href="#calibre_link-601" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">61</a></p>
    <p class="book-title--packt">Date/Time, Date, Time <a href="#calibre_link-602" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a>, <a href="#calibre_link-603" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">25</a></p>
    <p class="book-title--packt">DAX</p>
    <p class="book-title--packt">Azure Analysis Services (AAS) <a href="#calibre_link-604" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a>, <a href="#calibre_link-605" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">10</a></p>
    <p class="book-title--packt">best practices <a href="#calibre_link-606" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">61</a></p>
    <p class="book-title--packt">developing, tools <a href="#calibre_link-607" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">10</a></p>
    <p class="book-title--packt">filtering, with CALCULATE function <a href="#calibre_link-608" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">75</a>, <a href="#calibre_link-609" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">76</a></p>
    <p class="book-title--packt">Microsoft Excel <a href="#calibre_link-610" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">8</a></p>
    <p class="book-title--packt">need for <a href="#calibre_link-611" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">8</a></p>
    <p class="book-title--packt">Power BI <a href="#calibre_link-612" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">searching <a href="#calibre_link-613" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">8</a></p>
    <p class="book-title--packt">SQL Server Analysis Services <a href="#calibre_link-614" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">table functions <a href="#calibre_link-615" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">91</a></p>
    <p class="book-title--packt">DAX-based models</p>
    <p class="book-title--packt">interactive report <a href="#calibre_link-616" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">11</a>, <a href="#calibre_link-617" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">12</a>, <a href="#calibre_link-618" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">13</a></p>
    <p class="book-title--packt">visual reporting <a href="#calibre_link-619" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">11</a>, <a href="#calibre_link-620" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">12</a>, <a href="#calibre_link-621" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">13</a></p>
    <p class="book-title--packt">DAX, best practices</p>
    <p class="book-title--packt">base measures, using as building blocks <a href="#calibre_link-622" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">62</a></p>
    <p class="book-title--packt">explicit measures, building <a href="#calibre_link-623" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">62</a></p>
    <p class="book-title--packt">measure tables, using <a href="#calibre_link-624" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">63</a>, <a href="#calibre_link-625" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">64</a>, <a href="#calibre_link-626" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">65</a></p>
    <p class="book-title--packt">model elements, hiding <a href="#calibre_link-627" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">63</a></p>
    <p class="book-title--packt">table types <a href="#calibre_link-628" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">65</a></p>
    <p class="book-title--packt">table, types <a href="#calibre_link-629" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">66</a></p>
    <p class="book-title--packt">DAX context <a href="#calibre_link-630" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">69</a></p>
    <p class="book-title--packt">filter context <a href="#calibre_link-631" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">73</a></p>
    <p class="book-title--packt">filters, detecting <a href="#calibre_link-632" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">query context <a href="#calibre_link-633" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">71</a>, <a href="#calibre_link-634" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">73</a></p>
    <p class="book-title--packt">row context <a href="#calibre_link-635" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">69</a>, <a href="#calibre_link-636" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">70</a>, <a href="#calibre_link-637" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">71</a></p>
    <p class="book-title--packt">DAX evaluation</p>
    <p class="book-title--packt">optimizing, with AutoExist <a href="#calibre_link-638" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">245</a>, <a href="#calibre_link-639" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">246</a>, <a href="#calibre_link-640" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">248</a></p>
    <p class="book-title--packt">DAX, filtering with CALCULATE function</p>
    <p class="book-title--packt">existing filters, removing <a href="#calibre_link-641" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">78</a>, <a href="#calibre_link-642" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">79</a></p>
    <p class="book-title--packt">expression to calculate, evaluating <a href="#calibre_link-643" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">80</a>, <a href="#calibre_link-644" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">82</a></p>
    <p class="book-title--packt">filter context, setting up <a href="#calibre_link-645" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">77</a>, <a href="#calibre_link-646" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">78</a></p>
    <p class="book-title--packt">filters, removing with ALL functions <a href="#calibre_link-647" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">82</a>, <a href="#calibre_link-648" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a>, <a href="#calibre_link-649" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">84</a>, <a href="#calibre_link-650" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">85</a></p>
    <p class="book-title--packt">new filters, applying <a href="#calibre_link-651" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">79</a>, <a href="#calibre_link-652" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">80</a></p>
    <p class="book-title--packt">DAX functions</p>
    <p class="book-title--packt">ALLCROSSFILTERED function <a href="#calibre_link-653" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">84</a></p>
    <p class="book-title--packt">ALLEXCEPT function <a href="#calibre_link-654" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a></p>
    <p class="book-title--packt">ALL function <a href="#calibre_link-655" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">82</a></p>
    <p class="book-title--packt">ALLNOBLANKROW function <a href="#calibre_link-656" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a></p>
    <p class="book-title--packt">ALLSELECTED function <a href="#calibre_link-657" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">83</a></p>
    <p class="book-title--packt">CROSSJOIN functions <a href="#calibre_link-658" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">FILTER functions <a href="#calibre_link-659" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">GENERATE functions <a href="#calibre_link-660" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">95</a></p>
    <p class="book-title--packt">HASONEFILTER <a href="#calibre_link-661" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">HASONEVALUE <a href="#calibre_link-662" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">ISCROSSFILTERED <a href="#calibre_link-663" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">ISFILTERED <a href="#calibre_link-664" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">ISINSCOPE <a href="#calibre_link-665" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">PATHCONTAINS function <a href="#calibre_link-666" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">139</a></p>
    <p class="book-title--packt">PATH functions <a href="#calibre_link-667" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">139</a></p>
    <p class="book-title--packt">PATHITEM function <a href="#calibre_link-668" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">140</a></p>
    <p class="book-title--packt">PATHITEMREVERSE function <a href="#calibre_link-669" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">140</a></p>
    <p class="book-title--packt">PATHLENGTH function <a href="#calibre_link-670" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">139</a></p>
    <p class="book-title--packt">SUMMARIZE functions <a href="#calibre_link-671" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">TOPN functions <a href="#calibre_link-672" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">DAX measure</p>
    <p class="book-title--packt">creating, with dynamic labels <a href="#calibre_link-673" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">188</a>, <a href="#calibre_link-674" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">189</a>, <a href="#calibre_link-675" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">190</a></p>
    <p class="book-title--packt">DAX measures <a href="#calibre_link-676" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">55</a></p>
    <p class="book-title--packt">implicit measure <a href="#calibre_link-677" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">55</a></p>
    <p class="book-title--packt">DAX queries <a href="#calibre_link-678" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">56</a>, <a href="#calibre_link-679" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">58</a></p>
    <p class="book-title--packt">DAX query</p>
    <p class="book-title--packt">visual, populating through <a href="#calibre_link-680" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">239</a>, <a href="#calibre_link-681" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">240</a>, <a href="#calibre_link-682" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">241</a>, <a href="#calibre_link-683" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">242</a>, <a href="#calibre_link-684" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">243</a></p>
    <p class="book-title--packt">DAX security filters <a href="#calibre_link-685" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">55</a>, <a href="#calibre_link-686" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">119</a>, <a href="#calibre_link-687" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">120</a></p>
    <p class="book-title--packt">DAX variables <a href="#calibre_link-688" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">107</a>, <a href="#calibre_link-689" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">108</a>, <a href="#calibre_link-690" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">110</a></p>
    <p class="book-title--packt">Decimal Number data type <a href="#calibre_link-691" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a></p>
    <p class="book-title--packt">digital transformation cycle <a href="#calibre_link-692" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">17</a>, <a href="#calibre_link-693" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">18</a>, <a href="#calibre_link-694" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">19</a></p>
    <p class="book-title--packt">dimensions <a href="#calibre_link-695" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">38</a></p>
    <p class="book-title--packt">DISTINCTCOUNT function , <a href="#calibre_link-696" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">91</a></p>
    <p class="book-title--packt">DIY composite models</p>
    <p class="book-title--packt">aggregation levels, securing with <a href="#calibre_link-697" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">157</a>, <a href="#calibre_link-698" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">158</a>, <a href="#calibre_link-699" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">159</a>, <a href="#calibre_link-700" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">160</a>, <a href="#calibre_link-701" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">161</a>, <a href="#calibre_link-702" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">162</a></p>
    <p class="book-title--packt">dynamic DAX measure</p>
    <p class="book-title--packt">creating <a href="#calibre_link-703" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">178</a>, <a href="#calibre_link-704" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">180</a></p>
    <p class="book-title--packt">dynamic labels <a href="#calibre_link-705" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">185</a></p>
    <p class="book-title--packt">combining, with dynamic calculations <a href="#calibre_link-706" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">190</a>, <a href="#calibre_link-707" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">191</a>, <a href="#calibre_link-708" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">192</a></p>
    <p class="book-title--packt">helper table, creating <a href="#calibre_link-709" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">186</a>, <a href="#calibre_link-710" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">187</a>, <a href="#calibre_link-711" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">188</a></p>
    <p class="book-title--packt">solution overview <a href="#calibre_link-712" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">185</a></p>
    <p class="book-title--packt">used, for creating DAX measure <a href="#calibre_link-713" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">188</a>, <a href="#calibre_link-714" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">189</a>, <a href="#calibre_link-715" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">190</a></p>
    <p class="book-title--packt">dynamic measure <a href="#calibre_link-716" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">174</a></p>
    <p class="book-title--packt">basic DAX functions, creating for KPIs <a href="#calibre_link-717" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">175</a>, <a href="#calibre_link-718" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a></p>
    <p class="book-title--packt">helper table, creating <a href="#calibre_link-719" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a>, <a href="#calibre_link-720" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">177</a></p>
    <p class="book-title--packt">dynamic row-level security <a href="#calibre_link-721" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">121</a>, <a href="#calibre_link-722" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">123</a></p>
    <p class="book-title--packt">E</p>
    <p class="book-title--packt">end-user BI <a href="#calibre_link-723" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">6</a>, <a href="#calibre_link-724" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">7</a></p>
    <p class="book-title--packt">enterprise BI <a href="#calibre_link-725" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">6</a>, <a href="#calibre_link-726" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">7</a></p>
    <p class="book-title--packt">enterprise resource planning (ERP) <a href="#calibre_link-727" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">278</a></p>
    <p class="book-title--packt">EOMONTH function <a href="#calibre_link-728" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">301</a>, <a href="#calibre_link-729" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">418</a>, <a href="#calibre_link-266" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">400</a></p>
    <p class="book-title--packt">EVALUATE function , <a href="#calibre_link-730" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">58</a></p>
    <p class="book-title--packt">explicit measures <a href="#calibre_link-731" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">54</a></p>
    <p class="book-title--packt">extrapolation</p>
    <p class="book-title--packt">using, to predict inventory changes <a href="#calibre_link-732" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">392</a>, <a href="#calibre_link-733" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">393</a>, <a href="#calibre_link-734" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">394</a>, <a href="#calibre_link-735" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">396</a>, <a href="#calibre_link-736" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">397</a>, <a href="#calibre_link-737" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">398</a></p>
    <p class="book-title--packt">F</p>
    <p class="book-title--packt">fact tables <a href="#calibre_link-738" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">65</a></p>
    <p class="book-title--packt">filter context <a href="#calibre_link-739" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">73</a></p>
    <p class="book-title--packt">versus row context <a href="#calibre_link-740" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">FILTER function <a href="#calibre_link-741" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a>, <a href="#calibre_link-742" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">95</a>, <a href="#calibre_link-743" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">96</a>, <a href="#calibre_link-744" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">97</a>, <a href="#calibre_link-745" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">98</a>, <a href="#calibre_link-746" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">102</a>, <a href="#calibre_link-747" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">103</a>, <a href="#calibre_link-748" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a>, <a href="#calibre_link-749" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">106</a>, <a href="#calibre_link-750" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">108</a>, <a href="#calibre_link-751" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">109</a>, <a href="#calibre_link-752" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">110</a>, <a href="#calibre_link-753" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">142</a>, <a href="#calibre_link-754" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">219</a>, <a href="#calibre_link-755" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">220</a>, <a href="#calibre_link-756" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">254</a>, <a href="#calibre_link-757" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">255</a>, <a href="#calibre_link-758" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">291</a>, <a href="#calibre_link-759" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">292</a>, <a href="#calibre_link-760" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">301</a>, <a href="#calibre_link-761" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">303</a>, <a href="#calibre_link-762" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">304</a>, <a href="#calibre_link-763" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">307</a>, <a href="#calibre_link-764" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">311</a>, <a href="#calibre_link-765" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">319</a>, <a href="#calibre_link-766" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">320</a>, <a href="#calibre_link-767" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">321</a>, <a href="#calibre_link-768" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">322</a>, <a href="#calibre_link-769" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">325</a>, <a href="#calibre_link-770" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a>, <a href="#calibre_link-771" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">328</a>, <a href="#calibre_link-772" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">329</a>, <a href="#calibre_link-773" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">346</a>, <a href="#calibre_link-774" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">347</a>, <a href="#calibre_link-775" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">348</a>, <a href="#calibre_link-776" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">349</a>, <a href="#calibre_link-777" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">355</a>, <a href="#calibre_link-778" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">358</a>, <a href="#calibre_link-779" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">359</a>, <a href="#calibre_link-780" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">360</a>, <a href="#calibre_link-781" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">364</a>, <a href="#calibre_link-782" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">365</a>, <a href="#calibre_link-783" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">366</a>, <a href="#calibre_link-784" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">383</a>, <a href="#calibre_link-785" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">408</a>, <a href="#calibre_link-786" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">409</a>, <a href="#calibre_link-787" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">418</a></p>
    <p class="book-title--packt">filtering</p>
    <p class="book-title--packt">with table functions <a href="#calibre_link-788" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">100</a></p>
    <p class="book-title--packt">filtering, with table functions</p>
    <p class="book-title--packt">CALCULATETABLE, using <a href="#calibre_link-789" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">100</a>, <a href="#calibre_link-790" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">101</a></p>
    <p class="book-title--packt">filters and tables <a href="#calibre_link-791" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">101</a>, <a href="#calibre_link-792" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">102</a>, <a href="#calibre_link-793" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">103</a>, <a href="#calibre_link-794" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">104</a>, <a href="#calibre_link-795" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a></p>
    <p class="book-title--packt">TREATAS, using <a href="#calibre_link-796" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a>, <a href="#calibre_link-797" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">107</a></p>
    <p class="book-title--packt">filters <a href="#calibre_link-798" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">236</a></p>
    <p class="book-title--packt">filter tables <a href="#calibre_link-799" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">65</a></p>
    <p class="book-title--packt">financial calculations <a href="#calibre_link-800" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">332</a>, <a href="#calibre_link-801" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">333</a></p>
    <p class="book-title--packt">financial DAX functions <a href="#calibre_link-802" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">335</a>, <a href="#calibre_link-803" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">336</a>, <a href="#calibre_link-804" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">337</a>, <a href="#calibre_link-805" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">338</a></p>
    <p class="book-title--packt">FIRSTNONBLANK function <a href="#calibre_link-806" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">275</a></p>
    <p class="book-title--packt">Five-Layer model</p>
    <p class="book-title--packt">for business intelligence <a href="#calibre_link-807" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">4</a>, <a href="#calibre_link-808" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">Five-Layer model, for business intelligence</p>
    <p class="book-title--packt">Analyze layer <a href="#calibre_link-809" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">Connect layer <a href="#calibre_link-810" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">Prepare <a href="#calibre_link-811" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">Prepare layer <a href="#calibre_link-812" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">Share layer <a href="#calibre_link-813" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">Visualize layer <a href="#calibre_link-814" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">5</a></p>
    <p class="book-title--packt">Fixed decimal Number type <a href="#calibre_link-815" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a></p>
    <p class="book-title--packt">forecast</p>
    <p class="book-title--packt">types <a href="#calibre_link-816" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">387</a></p>
    <p class="book-title--packt">forecast-based inventory targets</p>
    <p class="book-title--packt">working with <a href="#calibre_link-817" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">403</a>, <a href="#calibre_link-818" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">404</a></p>
    <p class="book-title--packt">foreign key column <a href="#calibre_link-819" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">29</a></p>
    <p class="book-title--packt">FORMAT function , <a href="#calibre_link-684" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">60</a></p>
    <p class="book-title--packt">FTE calculation</p>
    <p class="book-title--packt">aggregation levels, considering <a href="#calibre_link-820" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">435</a>, <a href="#calibre_link-821" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">436</a></p>
    <p class="book-title--packt">optimizing <a href="#calibre_link-822" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">428</a>, <a href="#calibre_link-823" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">429</a>, <a href="#calibre_link-824" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">430</a>, <a href="#calibre_link-825" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">431</a>, <a href="#calibre_link-826" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">432</a></p>
    <p class="book-title--packt">totals. considering <a href="#calibre_link-827" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">427</a>, <a href="#calibre_link-828" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">428</a></p>
    <p class="book-title--packt">full-time equivalents (FTEs) <a href="#calibre_link-829" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">413</a></p>
    <p class="book-title--packt">resources needed, calculating <a href="#calibre_link-830" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">422</a>, <a href="#calibre_link-831" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">423</a>, <a href="#calibre_link-832" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">425</a>, <a href="#calibre_link-833" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">426</a>, <a href="#calibre_link-834" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">427</a></p>
    <p class="book-title--packt">Future Value (FV)</p>
    <p class="book-title--packt">calculating <a href="#calibre_link-835" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">343</a></p>
    <p class="book-title--packt">Future Value (FV), calculation</p>
    <p class="book-title--packt">initial investment <a href="#calibre_link-836" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">343</a>, <a href="#calibre_link-837" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">344</a></p>
    <p class="book-title--packt">irregular cash flows <a href="#calibre_link-838" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">345</a></p>
    <p class="book-title--packt">negative cash flows <a href="#calibre_link-839" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">349</a>, <a href="#calibre_link-840" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">350</a></p>
    <p class="book-title--packt">positive cash flows <a href="#calibre_link-841" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">349</a>, <a href="#calibre_link-842" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">350</a></p>
    <p class="book-title--packt">recurring cash flows <a href="#calibre_link-843" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">346</a>, <a href="#calibre_link-844" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">347</a>, <a href="#calibre_link-845" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">348</a></p>
    <p class="book-title--packt">residual value <a href="#calibre_link-846" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">343</a>, <a href="#calibre_link-847" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">344</a></p>
    <p class="book-title--packt">G</p>
    <p class="book-title--packt">GENERATEALL function <a href="#calibre_link-848" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">95</a></p>
    <p class="book-title--packt">GENERATE function <a href="#calibre_link-849" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">95</a>, <a href="#calibre_link-850" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">96</a>, <a href="#calibre_link-851" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">97</a>, <a href="#calibre_link-852" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">98</a>, <a href="#calibre_link-853" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a>, <a href="#calibre_link-854" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">106</a>, <a href="#calibre_link-855" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">109</a>, <a href="#calibre_link-856" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">110</a>, <a href="#calibre_link-857" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">303</a>, <a href="#calibre_link-858" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">304</a>, <a href="#calibre_link-859" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">307</a>, <a href="#calibre_link-860" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">319</a>, <a href="#calibre_link-861" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">321</a>, <a href="#calibre_link-862" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">322</a>, <a href="#calibre_link-863" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">325</a>, <a href="#calibre_link-864" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">328</a>, <a href="#calibre_link-865" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">329</a></p>
    <p class="book-title--packt">GENERATESERIES function <a href="#calibre_link-866" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">358</a></p>
    <p class="book-title--packt">Gregorian calendar <a href="#calibre_link-867" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">196</a></p>
    <p class="book-title--packt">Gregorian calendars</p>
    <p class="book-title--packt">period <a href="#calibre_link-868" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">199</a></p>
    <p class="book-title--packt">quarters <a href="#calibre_link-869" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">200</a></p>
    <p class="book-title--packt">week numbers <a href="#calibre_link-870" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">197</a>, <a href="#calibre_link-871" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">199</a></p>
    <p class="book-title--packt">years <a href="#calibre_link-872" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">200</a></p>
    <p class="book-title--packt">H</p>
    <p class="book-title--packt">hash encoding <a href="#calibre_link-873" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">26</a></p>
    <p class="book-title--packt">HASONEFILTER , <a href="#calibre_link-874" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">HASONEVALUE , <a href="#calibre_link-875" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">159</a>, <a href="#calibre_link-876" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">160</a>, <a href="#calibre_link-877" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">283</a>, <a href="#calibre_link-388" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">helper table <a href="#calibre_link-878" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">66</a></p>
    <p class="book-title--packt">creating <a href="#calibre_link-879" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a>, <a href="#calibre_link-880" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">177</a>, <a href="#calibre_link-881" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">178</a>, <a href="#calibre_link-882" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">186</a>, <a href="#calibre_link-883" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">187</a>, <a href="#calibre_link-884" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">188</a></p>
    <p class="book-title--packt">hierarchical tables <a href="#calibre_link-885" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">137</a>, <a href="#calibre_link-886" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">138</a></p>
    <p class="book-title--packt">hierarchies</p>
    <p class="book-title--packt">securing, with PATH functions <a href="#calibre_link-887" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">137</a></p>
    <p class="book-title--packt">I</p>
    <p class="book-title--packt">impersonation model <a href="#calibre_link-888" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">132</a>, <a href="#calibre_link-889" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">133</a>, <a href="#calibre_link-890" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">134</a></p>
    <p class="book-title--packt">initial investment <a href="#calibre_link-891" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">332</a></p>
    <p class="book-title--packt">intercompany business</p>
    <p class="book-title--packt">visualizing <a href="#calibre_link-892" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">289</a>, <a href="#calibre_link-893" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">290</a>, <a href="#calibre_link-894" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">291</a>, <a href="#calibre_link-895" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">292</a>, <a href="#calibre_link-896" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">293</a>, <a href="#calibre_link-897" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">294</a></p>
    <p class="book-title--packt">Internal Rate of Return (IRR) <a href="#calibre_link-898" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">334</a>, <a href="#calibre_link-899" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">335</a></p>
    <p class="book-title--packt">calculating <a href="#calibre_link-900" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">354</a>, <a href="#calibre_link-901" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">355</a>, <a href="#calibre_link-902" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">356</a></p>
    <p class="book-title--packt">XIRR function <a href="#calibre_link-903" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">335</a>, <a href="#calibre_link-904" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">354</a>, <a href="#calibre_link-905" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">356</a></p>
    <p class="book-title--packt">inventory</p>
    <p class="book-title--packt">calculations <a href="#calibre_link-906" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">376</a>, <a href="#calibre_link-907" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">378</a>, <a href="#calibre_link-908" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">379</a></p>
    <p class="book-title--packt">forecasting <a href="#calibre_link-909" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">386</a></p>
    <p class="book-title--packt">granularity <a href="#calibre_link-910" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">375</a>, <a href="#calibre_link-911" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">376</a></p>
    <p class="book-title--packt">targets <a href="#calibre_link-912" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">380</a>, <a href="#calibre_link-913" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">382</a>, <a href="#calibre_link-914" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">383</a>, <a href="#calibre_link-915" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">384</a>, <a href="#calibre_link-916" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">385</a></p>
    <p class="book-title--packt">inventory changes</p>
    <p class="book-title--packt">predicting, with extrapolation <a href="#calibre_link-917" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">392</a>, <a href="#calibre_link-918" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">393</a>, <a href="#calibre_link-919" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">394</a>, <a href="#calibre_link-920" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">396</a>, <a href="#calibre_link-921" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">397</a>, <a href="#calibre_link-922" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">398</a></p>
    <p class="book-title--packt">predicting, with sales forecast <a href="#calibre_link-923" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">387</a>, <a href="#calibre_link-924" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">388</a>, <a href="#calibre_link-925" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">389</a>, <a href="#calibre_link-926" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">390</a>, <a href="#calibre_link-927" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">391</a></p>
    <p class="book-title--packt">IRR function <a href="#calibre_link-928" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">334</a></p>
    <p class="book-title--packt">ISCROSSFILTERED , <a href="#calibre_link-929" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">159</a>, <a href="#calibre_link-930" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">ISFILTERED , <a href="#calibre_link-931" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">159</a>, <a href="#calibre_link-932" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">160</a>, <a href="#calibre_link-933" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a>, <a href="#calibre_link-934" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">214</a>, <a href="#calibre_link-935" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">216</a>, <a href="#calibre_link-936" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">229</a>, <a href="#calibre_link-937" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">230</a></p>
    <p class="book-title--packt">ISINSCOPE <a href="#calibre_link-938" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">ISO year <a href="#calibre_link-939" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">200</a></p>
    <p class="book-title--packt">ISO Year <a href="#calibre_link-940" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">207</a></p>
    <p class="book-title--packt">K</p>
    <p class="book-title--packt">KEEPFILTERS function <a href="#calibre_link-941" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">79</a>, <a href="#calibre_link-942" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">103</a>, <a href="#calibre_link-943" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">235</a>, <a href="#calibre_link-944" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">242</a>, <a href="#calibre_link-945" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">283</a>, <a href="#calibre_link-946" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">284</a>, <a href="#calibre_link-947" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">287</a>, <a href="#calibre_link-948" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">296</a>, <a href="#calibre_link-949" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">297</a>, <a href="#calibre_link-950" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">306</a>, <a href="#calibre_link-951" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">317</a>, <a href="#calibre_link-952" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">319</a>, <a href="#calibre_link-953" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">321</a>, <a href="#calibre_link-954" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a>, <a href="#calibre_link-955" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">327</a>, <a href="#calibre_link-956" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">347</a>, <a href="#calibre_link-957" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">348</a>, <a href="#calibre_link-958" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">418</a>, <a href="#calibre_link-959" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">419</a></p>
    <p class="book-title--packt">key performance indicators (KPIs) <a href="#calibre_link-960" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">6</a>, <a href="#calibre_link-961" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">172</a></p>
    <p class="book-title--packt">basic DAX functions, creating <a href="#calibre_link-962" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">175</a>, <a href="#calibre_link-963" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a></p>
    <p class="book-title--packt">L</p>
    <p class="book-title--packt">label <a href="#calibre_link-964" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">171</a></p>
    <p class="book-title--packt">least squares method <a href="#calibre_link-965" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">406</a></p>
    <p class="book-title--packt">lineage <a href="#calibre_link-966" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">106</a></p>
    <p class="book-title--packt">linear regression</p>
    <p class="book-title--packt">using, for extrapolating inventory <a href="#calibre_link-967" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">405</a>, <a href="#calibre_link-968" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">407</a>, <a href="#calibre_link-969" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">408</a>, <a href="#calibre_link-970" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">410</a></p>
    <p class="book-title--packt">live connection reports</p>
    <p class="book-title--packt">impersonation model <a href="#calibre_link-971" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">132</a>, <a href="#calibre_link-972" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">133</a>, <a href="#calibre_link-973" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">134</a></p>
    <p class="book-title--packt">pImpersonation table, adding to model <a href="#calibre_link-974" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">134</a></p>
    <p class="book-title--packt">testing <a href="#calibre_link-975" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">131</a>, <a href="#calibre_link-976" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">132</a></p>
    <p class="book-title--packt">test security role, adding <a href="#calibre_link-977" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">135</a>, <a href="#calibre_link-978" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">136</a></p>
    <p class="book-title--packt">long-lasting inventory</p>
    <p class="book-title--packt">calculating <a href="#calibre_link-979" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">398</a>, <a href="#calibre_link-980" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">399</a>, <a href="#calibre_link-981" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">400</a>, <a href="#calibre_link-982" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">402</a></p>
    <p class="book-title--packt">long-term sales orders</p>
    <p class="book-title--packt">sales on <a href="#calibre_link-983" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">298</a>, <a href="#calibre_link-306" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">300</a></p>
    <p class="book-title--packt">M</p>
    <p class="book-title--packt">many-to-many <a href="#calibre_link-984" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">37</a></p>
    <p class="book-title--packt">many-to-many relationships</p>
    <p class="book-title--packt">using <a href="#calibre_link-985" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">44</a>, <a href="#calibre_link-986" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">45</a></p>
    <p class="book-title--packt">many-to-one relationships <a href="#calibre_link-987" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">37</a></p>
    <p class="book-title--packt">measures <a href="#calibre_link-988" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">54</a></p>
    <p class="book-title--packt">measure tables <a href="#calibre_link-989" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">64</a>, <a href="#calibre_link-990" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">66</a></p>
    <p class="book-title--packt">MIN function <a href="#calibre_link-991" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">176</a>, <a href="#calibre_link-992" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">207</a>, <a href="#calibre_link-993" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">208</a>, <a href="#calibre_link-994" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">301</a>, <a href="#calibre_link-995" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">303</a>, <a href="#calibre_link-996" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">304</a>, <a href="#calibre_link-997" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">309</a>, <a href="#calibre_link-998" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">310</a>, <a href="#calibre_link-999" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">316</a>, <a href="#calibre_link-1000" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">317</a>, <a href="#calibre_link-1001" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">318</a>, <a href="#calibre_link-1002" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">384</a>, <a href="#calibre_link-1003" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">394</a>, <a href="#calibre_link-1004" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">396</a>, <a href="#calibre_link-1005" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">405</a>, <a href="#calibre_link-1006" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">408</a>, <a href="#calibre_link-1007" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">418</a>, <a href="#calibre_link-1008" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">421</a>, <a href="#calibre_link-266" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">365</a></p>
    <p class="book-title--packt">missing workdays</p>
    <p class="book-title--packt">issues, solving <a href="#calibre_link-1009" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">259</a></p>
    <p class="book-title--packt">missing workdays, issues</p>
    <p class="book-title--packt">context, considering <a href="#calibre_link-1010" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">262</a>, <a href="#calibre_link-1011" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">263</a>, <a href="#calibre_link-1012" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">264</a>, <a href="#calibre_link-1013" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">265</a></p>
    <p class="book-title--packt">model structure, modifying to get around AutoExist <a href="#calibre_link-1014" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">260</a>, <a href="#calibre_link-1015" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">261</a>, <a href="#calibre_link-1016" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">262</a></p>
    <p class="book-title--packt">root of the problem <a href="#calibre_link-1017" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">259</a>, <a href="#calibre_link-1018" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">260</a></p>
    <p class="book-title--packt">workday calculation, fixing <a href="#calibre_link-1019" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">265</a>, <a href="#calibre_link-1020" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">267</a></p>
    <p class="book-title--packt">models</p>
    <p class="book-title--packt">developing, tools <a href="#calibre_link-1021" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">10</a></p>
    <p class="book-title--packt">moving average <a href="#calibre_link-1022" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">218</a></p>
    <p class="book-title--packt">Multidimensional <a href="#calibre_link-1023" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">N</p>
    <p class="book-title--packt">negative clause <a href="#calibre_link-1024" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">152</a></p>
    <p class="book-title--packt">negative rows <a href="#calibre_link-1025" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">149</a></p>
    <p class="book-title--packt">Net Present Value (NPV) <a href="#calibre_link-1026" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">333</a>, <a href="#calibre_link-1027" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">334</a></p>
    <p class="book-title--packt">calculating <a href="#calibre_link-1028" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">350</a>, <a href="#calibre_link-1029" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">351</a>, <a href="#calibre_link-1030" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">352</a>, <a href="#calibre_link-1031" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">353</a>, <a href="#calibre_link-1032" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">354</a></p>
    <p class="book-title--packt">XNPV function <a href="#calibre_link-1033" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">335</a>, <a href="#calibre_link-1034" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">336</a>, <a href="#calibre_link-1035" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">337</a>, <a href="#calibre_link-1036" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">353</a></p>
    <p class="book-title--packt">O</p>
    <p class="book-title--packt">object-level security</p>
    <p class="book-title--packt">forms <a href="#calibre_link-1037" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">145</a></p>
    <p class="book-title--packt">restrictions <a href="#calibre_link-1038" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">145</a>, <a href="#calibre_link-1039" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">146</a></p>
    <p class="book-title--packt">old sales orders</p>
    <p class="book-title--packt">dealing with <a href="#calibre_link-1040" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">300</a>, <a href="#calibre_link-1041" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">301</a>, <a href="#calibre_link-1042" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">302</a>, <a href="#calibre_link-1043" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">303</a>, <a href="#calibre_link-1044" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">304</a>, <a href="#calibre_link-1045" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">305</a></p>
    <p class="book-title--packt">one-off sales orders</p>
    <p class="book-title--packt">sales on <a href="#calibre_link-1046" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">295</a>, <a href="#calibre_link-1047" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">296</a>, <a href="#calibre_link-1048" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">297</a></p>
    <p class="book-title--packt">one-to-many relationships <a href="#calibre_link-1049" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">29</a></p>
    <p class="book-title--packt">one-to-one cardinality <a href="#calibre_link-1050" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">37</a></p>
    <p class="book-title--packt">P</p>
    <p class="book-title--packt">PATHCONTAINS function <a href="#calibre_link-1051" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">141</a>, <a href="#calibre_link-1052" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">142</a>, <a href="#calibre_link-1053" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">153</a>, <a href="#calibre_link-1054" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">154</a></p>
    <p class="book-title--packt">PATHCONTAINS functions <a href="#calibre_link-1055" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">139</a></p>
    <p class="book-title--packt">PATH functions <a href="#calibre_link-1056" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">139</a></p>
    <p class="book-title--packt">used, for securing hierarchies <a href="#calibre_link-1057" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">137</a></p>
    <p class="book-title--packt">using, in RLS <a href="#calibre_link-1058" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">140</a>, <a href="#calibre_link-1059" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">141</a></p>
    <p class="book-title--packt">PATHITEM functions <a href="#calibre_link-1060" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">140</a></p>
    <p class="book-title--packt">PATHITEMREVERSE functions <a href="#calibre_link-1061" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">140</a></p>
    <p class="book-title--packt">PATHLENGTH functions <a href="#calibre_link-1062" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">139</a>, <a href="#calibre_link-1063" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">143</a>, <a href="#calibre_link-1064" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">153</a>, <a href="#calibre_link-1065" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">154</a></p>
    <p class="book-title--packt">period <a href="#calibre_link-1066" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">199</a></p>
    <p class="book-title--packt">period counter <a href="#calibre_link-1067" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">208</a></p>
    <p class="book-title--packt">pImpersonation table</p>
    <p class="book-title--packt">adding, to model <a href="#calibre_link-1068" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">134</a></p>
    <p class="book-title--packt">positive clause <a href="#calibre_link-1069" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">152</a></p>
    <p class="book-title--packt">positive rows <a href="#calibre_link-1070" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">148</a></p>
    <p class="book-title--packt">Power Apps <a href="#calibre_link-1071" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">18</a></p>
    <p class="book-title--packt">Power Automate <a href="#calibre_link-1072" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">18</a></p>
    <p class="book-title--packt">Power BI <a href="#calibre_link-1073" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">6</a>, <a href="#calibre_link-1074" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">measures, using to change behavior of visuals <a href="#calibre_link-1075" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">238</a>, <a href="#calibre_link-1076" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">239</a></p>
    <p class="book-title--packt">used, for visualizing output of model <a href="#calibre_link-1077" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">235</a></p>
    <p class="book-title--packt">visual context <a href="#calibre_link-1078" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">236</a>, <a href="#calibre_link-1079" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">237</a></p>
    <p class="book-title--packt">visual filters <a href="#calibre_link-1080" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">236</a>, <a href="#calibre_link-1081" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">237</a></p>
    <p class="book-title--packt">visual, populating through DAX query <a href="#calibre_link-730" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">239</a>, <a href="#calibre_link-1082" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">240</a>, <a href="#calibre_link-1083" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">241</a>, <a href="#calibre_link-1084" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">242</a>, <a href="#calibre_link-1085" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">243</a></p>
    <p class="book-title--packt">Power BI dataset <a href="#calibre_link-1086" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">Power BI model , <a href="#calibre_link-1087" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">68</a>, <a href="#calibre_link-1088" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">209</a>, <a href="#calibre_link-1089" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">210</a>, <a href="#calibre_link-1090" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">234</a>, <a href="#calibre_link-1091" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">235</a>, <a href="#calibre_link-1092" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">414</a>, <a href="#calibre_link-1093" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">415</a>, <a href="#calibre_link-1094" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">416</a></p>
    <p class="book-title--packt">columnar data storage <a href="#calibre_link-1095" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">22</a></p>
    <p class="book-title--packt">data types <a href="#calibre_link-1096" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a>, <a href="#calibre_link-1097" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">25</a>, <a href="#calibre_link-1098" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">26</a></p>
    <p class="book-title--packt">encoding <a href="#calibre_link-1099" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a>, <a href="#calibre_link-1100" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">25</a>, <a href="#calibre_link-1101" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">26</a></p>
    <p class="book-title--packt">optimizing <a href="#calibre_link-1102" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">432</a>, <a href="#calibre_link-1103" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">433</a>, <a href="#calibre_link-1104" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">434</a>, <a href="#calibre_link-1105" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">435</a></p>
    <p class="book-title--packt">pImpersonation table, adding to <a href="#calibre_link-1106" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">134</a></p>
    <p class="book-title--packt">Power BI model, columnar data storage</p>
    <p class="book-title--packt">columnar database <a href="#calibre_link-1107" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">23</a>, <a href="#calibre_link-1108" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a></p>
    <p class="book-title--packt">relational database <a href="#calibre_link-1109" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">22</a></p>
    <p class="book-title--packt">Power BI model, design</p>
    <p class="book-title--packt">memory, considerations <a href="#calibre_link-1110" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">45</a>, <a href="#calibre_link-1111" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">47</a></p>
    <p class="book-title--packt">performance, considerations <a href="#calibre_link-1112" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">45</a>, <a href="#calibre_link-1113" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">47</a></p>
    <p class="book-title--packt">Power BI models <a href="#calibre_link-1114" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">58</a></p>
    <p class="book-title--packt">design <a href="#calibre_link-1115" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">37</a></p>
    <p class="book-title--packt">relationships <a href="#calibre_link-1116" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">26</a></p>
    <p class="book-title--packt">relationships properties <a href="#calibre_link-1117" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">31</a></p>
    <p class="book-title--packt">used, for accelerating BI solution development <a href="#calibre_link-1118" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">14</a>, <a href="#calibre_link-1119" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">15</a></p>
    <p class="book-title--packt">Power BI models, design</p>
    <p class="book-title--packt">snowflakes <a href="#calibre_link-1120" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">38</a></p>
    <p class="book-title--packt">star schema <a href="#calibre_link-1121" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">38</a></p>
    <p class="book-title--packt">Power BI models, relationships concept</p>
    <p class="book-title--packt">data in Excel <a href="#calibre_link-1122" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">26</a>, <a href="#calibre_link-1123" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">27</a></p>
    <p class="book-title--packt">data, in relational databases <a href="#calibre_link-1124" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">28</a></p>
    <p class="book-title--packt">relational model <a href="#calibre_link-1125" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">28</a>, <a href="#calibre_link-1126" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">29</a>, <a href="#calibre_link-1127" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">30</a></p>
    <p class="book-title--packt">Power BI models, relationships properties</p>
    <p class="book-title--packt">active relationships <a href="#calibre_link-1128" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">31</a>, <a href="#calibre_link-1129" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">33</a></p>
    <p class="book-title--packt">cardinality <a href="#calibre_link-1130" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">37</a></p>
    <p class="book-title--packt">cross filter direction <a href="#calibre_link-1131" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">33</a>, <a href="#calibre_link-1132" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">34</a>, <a href="#calibre_link-1133" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">35</a>, <a href="#calibre_link-1134" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">36</a></p>
    <p class="book-title--packt">inactive relationships <a href="#calibre_link-1135" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">31</a>, <a href="#calibre_link-1136" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">33</a></p>
    <p class="book-title--packt">Power BI, populating visual with results</p>
    <p class="book-title--packt">aspects <a href="#calibre_link-1137" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">248</a></p>
    <p class="book-title--packt">Power BI reports <a href="#calibre_link-1138" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">222</a></p>
    <p class="book-title--packt">Date Selection table <a href="#calibre_link-1139" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">223</a>, <a href="#calibre_link-1140" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">224</a>, <a href="#calibre_link-1141" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">225</a>, <a href="#calibre_link-1142" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">226</a></p>
    <p class="book-title--packt">Date selection table, using in measures <a href="#calibre_link-1143" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">229</a>, <a href="#calibre_link-1144" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">230</a>, <a href="#calibre_link-1145" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">231</a></p>
    <p class="book-title--packt">selection options, creating <a href="#calibre_link-1146" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">226</a>, <a href="#calibre_link-1147" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">227</a>, <a href="#calibre_link-1148" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">228</a>, <a href="#calibre_link-1149" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">229</a></p>
    <p class="book-title--packt">Power Platform</p>
    <p class="book-title--packt">components <a href="#calibre_link-1150" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">18</a></p>
    <p class="book-title--packt">Power Virtual Agents <a href="#calibre_link-1151" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">18</a></p>
    <p class="book-title--packt">Present Value (PV) <a href="#calibre_link-1152" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">333</a>, <a href="#calibre_link-1153" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">334</a></p>
    <p class="book-title--packt">primary key column <a href="#calibre_link-1154" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">29</a></p>
    <p class="book-title--packt">Q</p>
    <p class="book-title--packt">QuantoBikes</p>
    <p class="book-title--packt">model structure <a href="#calibre_link-1155" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">280</a>, <a href="#calibre_link-1156" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">281</a></p>
    <p class="book-title--packt">sales process <a href="#calibre_link-1157" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">278</a>, <a href="#calibre_link-1158" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">279</a>, <a href="#calibre_link-1159" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">280</a></p>
    <p class="book-title--packt">sales process, modeling <a href="#calibre_link-1160" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">278</a></p>
    <p class="book-title--packt">QuantoBikes sales process <a href="#calibre_link-1161" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">295</a></p>
    <p class="book-title--packt">current sales order calculation, optimizing <a href="#calibre_link-1162" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">312</a>, <a href="#calibre_link-1163" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">313</a>, <a href="#calibre_link-1164" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">314</a></p>
    <p class="book-title--packt">dealing, with current sales orders <a href="#calibre_link-1165" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">305</a>, <a href="#calibre_link-1166" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">306</a>, <a href="#calibre_link-1167" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">307</a>, <a href="#calibre_link-1168" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">308</a>, <a href="#calibre_link-1169" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">309</a>, <a href="#calibre_link-696" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">310</a>, <a href="#calibre_link-1170" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">311</a>, <a href="#calibre_link-1171" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">312</a></p>
    <p class="book-title--packt">dealing, with old sales orders <a href="#calibre_link-1172" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">300</a>, <a href="#calibre_link-1173" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">301</a>, <a href="#calibre_link-1174" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">302</a>, <a href="#calibre_link-1175" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">303</a>, <a href="#calibre_link-1176" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">304</a>, <a href="#calibre_link-1177" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">305</a></p>
    <p class="book-title--packt">optimization <a href="#calibre_link-1178" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">324</a>, <a href="#calibre_link-1179" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">325</a>, <a href="#calibre_link-1180" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a></p>
    <p class="book-title--packt">sales, on long-term sales orders <a href="#calibre_link-1181" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">298</a>, <a href="#calibre_link-1182" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">300</a></p>
    <p class="book-title--packt">sales, on one-off sales orders <a href="#calibre_link-1183" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">295</a>, <a href="#calibre_link-1184" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">296</a>, <a href="#calibre_link-1185" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">297</a></p>
    <p class="book-title--packt">QuantoBikes subsidiaries</p>
    <p class="book-title--packt">business between <a href="#calibre_link-1186" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">281</a>, <a href="#calibre_link-1187" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">282</a></p>
    <p class="book-title--packt">query context <a href="#calibre_link-1188" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">71</a>, <a href="#calibre_link-1189" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">73</a></p>
    <p class="book-title--packt">elements <a href="#calibre_link-1190" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">71</a></p>
    <p class="book-title--packt">versus row context <a href="#calibre_link-1191" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">R</p>
    <p class="book-title--packt">RANK.EQ function <a href="#calibre_link-1192" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">92</a></p>
    <p class="book-title--packt">RANKX function <a href="#calibre_link-1193" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">92</a></p>
    <p class="book-title--packt">RDBMS principles, to avoid in Power BI models <a href="#calibre_link-1194" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">40</a></p>
    <p class="book-title--packt">data warehouse, as single source of truth <a href="#calibre_link-1195" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">43</a></p>
    <p class="book-title--packt">interdependent dimensions <a href="#calibre_link-1196" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">40</a>, <a href="#calibre_link-1197" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">41</a>, <a href="#calibre_link-1198" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">42</a></p>
    <p class="book-title--packt">many-to-many relationships, using <a href="#calibre_link-1199" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">44</a>, <a href="#calibre_link-1200" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">45</a></p>
    <p class="book-title--packt">one fact table <a href="#calibre_link-1201" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">42</a></p>
    <p class="book-title--packt">relational database <a href="#calibre_link-1202" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">22</a></p>
    <p class="book-title--packt">relational database management system (RDBMS) <a href="#calibre_link-1203" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">22</a></p>
    <p class="book-title--packt">report performance</p>
    <p class="book-title--packt">optimizing, with AutoExist <a href="#calibre_link-1204" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">267</a></p>
    <p class="book-title--packt">report performance, with AutoExist</p>
    <p class="book-title--packt">granularity, in fact tables <a href="#calibre_link-1205" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">268</a></p>
    <p class="book-title--packt">model structure, optimizing <a href="#calibre_link-1206" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">272</a>, <a href="#calibre_link-1207" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">273</a>, <a href="#calibre_link-1208" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">274</a></p>
    <p class="book-title--packt">multiple fact tables, filtering <a href="#calibre_link-1209" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">269</a>, <a href="#calibre_link-1210" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">270</a>, <a href="#calibre_link-1211" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">271</a></p>
    <p class="book-title--packt">visual, optimizing <a href="#calibre_link-1212" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">274</a>, <a href="#calibre_link-1213" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">275</a></p>
    <p class="book-title--packt">residual value <a href="#calibre_link-1214" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">333</a></p>
    <p class="book-title--packt">row context <a href="#calibre_link-1215" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">69</a>, <a href="#calibre_link-1216" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">70</a>, <a href="#calibre_link-1217" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">71</a></p>
    <p class="book-title--packt">versus filter context <a href="#calibre_link-1218" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">versus query context <a href="#calibre_link-1219" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">74</a></p>
    <p class="book-title--packt">row-level security (RLS) <a href="#calibre_link-1220" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">116</a></p>
    <p class="book-title--packt">advanced hierarchy navigation <a href="#calibre_link-1221" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">141</a>, <a href="#calibre_link-1222" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">142</a>, <a href="#calibre_link-1223" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">143</a>, <a href="#calibre_link-1224" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">144</a></p>
    <p class="book-title--packt">live connection reports, testing <a href="#calibre_link-1225" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">131</a>, <a href="#calibre_link-1226" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">132</a></p>
    <p class="book-title--packt">modeling considerations <a href="#calibre_link-1227" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">124</a>, <a href="#calibre_link-1228" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">125</a>, <a href="#calibre_link-1229" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">126</a>, <a href="#calibre_link-874" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">127</a>, <a href="#calibre_link-1230" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">128</a>, <a href="#calibre_link-1231" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">129</a></p>
    <p class="book-title--packt">PATH functions, using in <a href="#calibre_link-1232" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">140</a>, <a href="#calibre_link-1233" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">141</a></p>
    <p class="book-title--packt">security roles <a href="#calibre_link-1234" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">116</a>, <a href="#calibre_link-1235" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">117</a>, <a href="#calibre_link-1236" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">119</a></p>
    <p class="book-title--packt">security roles, testing <a href="#calibre_link-1237" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">129</a>, <a href="#calibre_link-1238" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">130</a>, <a href="#calibre_link-1239" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">131</a></p>
    <p class="book-title--packt">S</p>
    <p class="book-title--packt">sales</p>
    <p class="book-title--packt">calculating <a href="#calibre_link-1240" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">416</a>, <a href="#calibre_link-1241" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">417</a>, <a href="#calibre_link-1242" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">418</a>, <a href="#calibre_link-1243" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">419</a>, <a href="#calibre_link-1244" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">420</a></p>
    <p class="book-title--packt">sales calculation</p>
    <p class="book-title--packt">optimizing <a href="#calibre_link-1245" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">420</a>, <a href="#calibre_link-1246" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">421</a>, <a href="#calibre_link-1247" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">422</a></p>
    <p class="book-title--packt">sales forecast</p>
    <p class="book-title--packt">using, to predict inventory changes <a href="#calibre_link-1248" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">387</a>, <a href="#calibre_link-1249" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">388</a>, <a href="#calibre_link-1250" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">389</a>, <a href="#calibre_link-1251" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">390</a>, <a href="#calibre_link-1252" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">391</a></p>
    <p class="book-title--packt">sales growth</p>
    <p class="book-title--packt">calculating <a href="#calibre_link-1253" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">213</a>, <a href="#calibre_link-1254" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">214</a>, <a href="#calibre_link-1255" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">215</a>, <a href="#calibre_link-1256" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">216</a>, <a href="#calibre_link-1257" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">217</a>, <a href="#calibre_link-1258" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">218</a></p>
    <p class="book-title--packt">SAMEPERIODLASTYEAR function <a href="#calibre_link-1259" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">88</a>, <a href="#calibre_link-1260" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">89</a>, <a href="#calibre_link-1261" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">217</a></p>
    <p class="book-title--packt">secret <a href="#calibre_link-1262" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">122</a></p>
    <p class="book-title--packt">secured attributes</p>
    <p class="book-title--packt">object-level security <a href="#calibre_link-1263" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">145</a>, <a href="#calibre_link-1264" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">146</a></p>
    <p class="book-title--packt">object-level security, restrictions <a href="#calibre_link-1265" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">145</a>, <a href="#calibre_link-1266" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">146</a></p>
    <p class="book-title--packt">security roles <a href="#calibre_link-1267" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">116</a>, <a href="#calibre_link-1268" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">117</a>, <a href="#calibre_link-1269" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">119</a></p>
    <p class="book-title--packt">DAX security filters <a href="#calibre_link-1270" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">119</a>, <a href="#calibre_link-1271" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">120</a></p>
    <p class="book-title--packt">testing <a href="#calibre_link-1272" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">129</a>, <a href="#calibre_link-1273" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">130</a>, <a href="#calibre_link-1274" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">131</a></p>
    <p class="book-title--packt">self-service BI <a href="#calibre_link-1275" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">6</a></p>
    <p class="book-title--packt">snowflakes <a href="#calibre_link-1276" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">38</a></p>
    <p class="book-title--packt">SQL Server Analysis Services <a href="#calibre_link-1277" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">star schema <a href="#calibre_link-1278" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">38</a></p>
    <p class="book-title--packt">star schemas</p>
    <p class="book-title--packt">issues with <a href="#calibre_link-1279" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">39</a>, <a href="#calibre_link-1280" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">40</a></p>
    <p class="book-title--packt">status-oriented data</p>
    <p class="book-title--packt">data modeling <a href="#calibre_link-1281" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">370</a>, <a href="#calibre_link-1282" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">371</a>, <a href="#calibre_link-1283" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">372</a>, <a href="#calibre_link-1284" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">373</a>, <a href="#calibre_link-1285" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">374</a>, <a href="#calibre_link-1286" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">375</a></p>
    <p class="book-title--packt">stock-keeping unit (SKU) <a href="#calibre_link-1287" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">374</a></p>
    <p class="book-title--packt">subsidiary view</p>
    <p class="book-title--packt">versus consolidated view <a href="#calibre_link-1288" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">282</a>, <a href="#calibre_link-1289" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">283</a>, <a href="#calibre_link-1290" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">284</a></p>
    <p class="book-title--packt">SUM function <a href="#calibre_link-1291" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">91</a></p>
    <p class="book-title--packt">SUMMARIZECOLUMNS function <a href="#calibre_link-1292" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">243</a>, <a href="#calibre_link-1293" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">260</a></p>
    <p class="book-title--packt">SUMMARIZE function <a href="#calibre_link-1294" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a>, <a href="#calibre_link-1295" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">215</a>, <a href="#calibre_link-1296" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">216</a>, <a href="#calibre_link-1297" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">230</a>, <a href="#calibre_link-1298" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">324</a>, <a href="#calibre_link-1299" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">325</a>, <a href="#calibre_link-1300" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a>, <a href="#calibre_link-1301" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">383</a>, <a href="#calibre_link-1302" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">384</a>, <a href="#calibre_link-1303" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">385</a>, <a href="#calibre_link-1304" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">386</a>, <a href="#calibre_link-1305" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">389</a>, <a href="#calibre_link-1306" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">390</a>, <a href="#calibre_link-1307" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">393</a>, <a href="#calibre_link-1308" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">396</a>, <a href="#calibre_link-1309" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">398</a>, <a href="#calibre_link-1310" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">399</a>, <a href="#calibre_link-1311" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">401</a>, <a href="#calibre_link-1312" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">404</a>, <a href="#calibre_link-1313" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">407</a>, <a href="#calibre_link-1314" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">429</a>, <a href="#calibre_link-1315" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">433</a></p>
    <p class="book-title--packt">SUMMARIZE functions <a href="#calibre_link-1316" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">SUMX function <a href="#calibre_link-1317" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">92</a></p>
    <p class="book-title--packt">SWITCH function <a href="#calibre_link-1318" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">144</a>, <a href="#calibre_link-1319" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">178</a>, <a href="#calibre_link-1320" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">182</a>, <a href="#calibre_link-1321" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">183</a>, <a href="#calibre_link-1322" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">185</a>, <a href="#calibre_link-1323" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">189</a>, <a href="#calibre_link-1324" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">190</a>, <a href="#calibre_link-1325" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">191</a>, <a href="#calibre_link-1326" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">192</a>, <a href="#calibre_link-1327" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">214</a>, <a href="#calibre_link-1328" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">216</a>, <a href="#calibre_link-1329" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">229</a>, <a href="#calibre_link-1330" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">230</a>, <a href="#calibre_link-1331" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">378</a>, <a href="#calibre_link-1332" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">379</a></p>
    <p class="book-title--packt">T</p>
    <p class="book-title--packt">table aggregation function <a href="#calibre_link-1333" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">92</a></p>
    <p class="book-title--packt">table functions</p>
    <p class="book-title--packt">filtering with <a href="#calibre_link-1334" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">100</a></p>
    <p class="book-title--packt">in DAX <a href="#calibre_link-1335" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">91</a></p>
    <p class="book-title--packt">table functions, in DAX</p>
    <p class="book-title--packt">context <a href="#calibre_link-1336" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">95</a>, <a href="#calibre_link-1337" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">96</a>, <a href="#calibre_link-1338" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">97</a>, <a href="#calibre_link-1339" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">98</a></p>
    <p class="book-title--packt">performance considerations <a href="#calibre_link-1340" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">98</a>, <a href="#calibre_link-1341" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">99</a>, <a href="#calibre_link-1342" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">100</a></p>
    <p class="book-title--packt">table aggregations <a href="#calibre_link-1343" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">91</a>, <a href="#calibre_link-1344" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">92</a>, <a href="#calibre_link-1345" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">93</a></p>
    <p class="book-title--packt">virtual tables, using <a href="#calibre_link-1346" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">93</a>, <a href="#calibre_link-1347" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a>, <a href="#calibre_link-1348" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">95</a></p>
    <p class="book-title--packt">table types <a href="#calibre_link-1349" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">65</a>, <a href="#calibre_link-1350" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">66</a></p>
    <p class="book-title--packt">fact tables <a href="#calibre_link-1351" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">65</a></p>
    <p class="book-title--packt">filter tables <a href="#calibre_link-1352" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">65</a></p>
    <p class="book-title--packt">helper tables <a href="#calibre_link-1353" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">66</a></p>
    <p class="book-title--packt">measure tables <a href="#calibre_link-1354" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">66</a></p>
    <p class="book-title--packt">Tabular <a href="#calibre_link-1355" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">9</a></p>
    <p class="book-title--packt">test security role</p>
    <p class="book-title--packt">adding <a href="#calibre_link-1356" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">135</a>, <a href="#calibre_link-1357" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">136</a></p>
    <p class="book-title--packt">Text data type <a href="#calibre_link-1358" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a></p>
    <p class="book-title--packt">time intelligence <a href="#calibre_link-1359" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">86</a>, <a href="#calibre_link-1360" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">87</a></p>
    <p class="book-title--packt">time Intelligence calculations</p>
    <p class="book-title--packt">for week-based calendars <a href="#calibre_link-1361" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">209</a></p>
    <p class="book-title--packt">time Intelligence calculations, for week-based calendars</p>
    <p class="book-title--packt">average, moving by week withing accounting year <a href="#calibre_link-1362" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">218</a>, <a href="#calibre_link-1363" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">219</a>, <a href="#calibre_link-1364" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">220</a>, <a href="#calibre_link-1365" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">221</a></p>
    <p class="book-title--packt">Power BI model <a href="#calibre_link-1366" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">209</a>, <a href="#calibre_link-1367" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">210</a>, <a href="#calibre_link-1368" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">211</a></p>
    <p class="book-title--packt">sales growth, calculating <a href="#calibre_link-1369" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">213</a>, <a href="#calibre_link-1370" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">214</a>, <a href="#calibre_link-1371" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">215</a>, <a href="#calibre_link-1372" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">216</a>, <a href="#calibre_link-1373" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">217</a>, <a href="#calibre_link-1374" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">218</a></p>
    <p class="book-title--packt">year-to-date results, calculating <a href="#calibre_link-1375" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">211</a>, <a href="#calibre_link-1376" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">212</a>, <a href="#calibre_link-1377" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">213</a></p>
    <p class="book-title--packt">time intelligence function <a href="#calibre_link-1378" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">85</a>, <a href="#calibre_link-1379" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">87</a>, <a href="#calibre_link-1380" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">89</a></p>
    <p class="book-title--packt">TOPN function <a href="#calibre_link-1381" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a>, <a href="#calibre_link-1382" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">96</a>, <a href="#calibre_link-1383" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">104</a>, <a href="#calibre_link-1384" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a>, <a href="#calibre_link-1385" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">242</a>, <a href="#calibre_link-1386" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">364</a>, <a href="#calibre_link-1387" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">365</a></p>
    <p class="book-title--packt">TOPN functions <a href="#calibre_link-1388" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">TOTALMTD function <a href="#calibre_link-1389" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">251</a></p>
    <p class="book-title--packt">TREATAS function <a href="#calibre_link-1390" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a>, <a href="#calibre_link-1391" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">106</a>, <a href="#calibre_link-1392" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">107</a>, <a href="#calibre_link-1393" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">189</a>, <a href="#calibre_link-1394" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">190</a>, <a href="#calibre_link-1395" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">191</a>, <a href="#calibre_link-1396" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">192</a>, <a href="#calibre_link-1397" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">214</a>, <a href="#calibre_link-1398" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">215</a>, <a href="#calibre_link-1399" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">216</a>, <a href="#calibre_link-1400" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">231</a>, <a href="#calibre_link-1401" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">241</a>, <a href="#calibre_link-1402" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">242</a>, <a href="#calibre_link-1403" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">286</a>, <a href="#calibre_link-1404" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">287</a>, <a href="#calibre_link-1405" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">288</a>, <a href="#calibre_link-1406" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">289</a>, <a href="#calibre_link-1407" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">290</a>, <a href="#calibre_link-1408" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">297</a>, <a href="#calibre_link-1409" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">302</a>, <a href="#calibre_link-1410" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">305</a>, <a href="#calibre_link-1411" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">343</a>, <a href="#calibre_link-1412" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">344</a></p>
    <p class="book-title--packt">True/False data type <a href="#calibre_link-1413" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">25</a></p>
    <p class="book-title--packt">U</p>
    <p class="book-title--packt">USERELATIONSHIP function <a href="#calibre_link-1414" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">33</a>, <a href="#calibre_link-1415" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">103</a>, <a href="#calibre_link-1416" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">125</a>, <a href="#calibre_link-1417" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">127</a>, <a href="#calibre_link-1418" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">182</a>, <a href="#calibre_link-1419" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">183</a>, <a href="#calibre_link-1420" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">184</a>, <a href="#calibre_link-1421" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">185</a>, <a href="#calibre_link-1422" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">192</a>, <a href="#calibre_link-1423" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">296</a>, <a href="#calibre_link-1424" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">297</a>, <a href="#calibre_link-1425" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">303</a>, <a href="#calibre_link-1426" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">304</a>, <a href="#calibre_link-1427" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">308</a>, <a href="#calibre_link-1428" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">320</a>, <a href="#calibre_link-1429" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">322</a>, <a href="#calibre_link-1430" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">325</a>, <a href="#calibre_link-1431" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">326</a>, <a href="#calibre_link-1432" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">416</a></p>
    <p class="book-title--packt">using <a href="#calibre_link-1433" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">89</a>, <a href="#calibre_link-1434" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">90</a>, <a href="#calibre_link-1435" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">91</a></p>
    <p class="book-title--packt">V</p>
    <p class="book-title--packt">value encoding <a href="#calibre_link-1436" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">25</a></p>
    <p class="book-title--packt">value-level security (VLS) <a href="#calibre_link-1437" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">146</a>, <a href="#calibre_link-1438" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">147</a></p>
    <p class="book-title--packt">advanced scenarios <a href="#calibre_link-1439" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">153</a>, <a href="#calibre_link-1440" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">154</a>, <a href="#calibre_link-1441" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">155</a></p>
    <p class="book-title--packt">aggregation security, combining with <a href="#calibre_link-1442" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">162</a>, <a href="#calibre_link-1443" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">163</a>, <a href="#calibre_link-1444" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">164</a>, <a href="#calibre_link-1445" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">165</a></p>
    <p class="book-title--packt">modeling <a href="#calibre_link-1446" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">147</a>, <a href="#calibre_link-1447" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">148</a>, <a href="#calibre_link-1448" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">149</a>, <a href="#calibre_link-1449" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">150</a></p>
    <p class="book-title--packt">security filters <a href="#calibre_link-1450" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">150</a>, <a href="#calibre_link-1451" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">152</a></p>
    <p class="book-title--packt">used, for developing in models <a href="#calibre_link-1452" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">155</a>, <a href="#calibre_link-1453" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">156</a></p>
    <p class="book-title--packt">VALUES function <a href="#calibre_link-1454" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">93</a>, <a href="#calibre_link-1455" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a>, <a href="#calibre_link-1456" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">96</a>, <a href="#calibre_link-1457" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">98</a>, <a href="#calibre_link-1458" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">99</a>, <a href="#calibre_link-1459" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">100</a>, <a href="#calibre_link-1460" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">101</a>, <a href="#calibre_link-1461" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">104</a>, <a href="#calibre_link-1462" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">105</a>, <a href="#calibre_link-1463" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">106</a>, <a href="#calibre_link-1464" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">109</a>, <a href="#calibre_link-1465" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">110</a>, <a href="#calibre_link-1466" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">159</a>, <a href="#calibre_link-1467" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">161</a>, <a href="#calibre_link-1468" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">163</a>, <a href="#calibre_link-1469" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">187</a>, <a href="#calibre_link-1470" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">188</a>, <a href="#calibre_link-1471" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">189</a>, <a href="#calibre_link-1472" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">191</a>, <a href="#calibre_link-1473" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">192</a>, <a href="#calibre_link-1474" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">216</a>, <a href="#calibre_link-1475" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">217</a>, <a href="#calibre_link-1476" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">227</a>, <a href="#calibre_link-1477" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">228</a>, <a href="#calibre_link-1478" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">229</a>, <a href="#calibre_link-1479" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">288</a>, <a href="#calibre_link-1480" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">343</a>, <a href="#calibre_link-1481" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">344</a>, <a href="#calibre_link-1482" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">376</a>, <a href="#calibre_link-1483" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">378</a>, <a href="#calibre_link-1484" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">381</a>, <a href="#calibre_link-1485" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">384</a>, <a href="#calibre_link-1486" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">386</a>, <a href="#calibre_link-1487" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">402</a>, <a href="#calibre_link-1488" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">403</a>, <a href="#calibre_link-1489" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">410</a>, <a href="#calibre_link-1490" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">420</a>, <a href="#calibre_link-1491" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">424</a>, <a href="#calibre_link-1492" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">426</a>, <a href="#calibre_link-1493" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">428</a>, <a href="#calibre_link-1494" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">430</a>, <a href="#calibre_link-1495" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">433</a>, <a href="#calibre_link-1496" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">434</a></p>
    <p class="book-title--packt">virtual tables</p>
    <p class="book-title--packt">using <a href="#calibre_link-1497" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">93</a>, <a href="#calibre_link-1498" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">94</a></p>
    <p class="book-title--packt">W</p>
    <p class="book-title--packt">week-based calendar <a href="#calibre_link-1087" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">196</a></p>
    <p class="book-title--packt">period <a href="#calibre_link-1499" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">199</a></p>
    <p class="book-title--packt">quarters <a href="#calibre_link-1500" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">200</a></p>
    <p class="book-title--packt">week numbers <a href="#calibre_link-1501" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">197</a>, <a href="#calibre_link-1502" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">199</a></p>
    <p class="book-title--packt">year <a href="#calibre_link-1503" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">200</a></p>
    <p class="book-title--packt">week-based calendars</p>
    <p class="book-title--packt">time Intelligence calculations <a href="#calibre_link-1504" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">209</a></p>
    <p class="book-title--packt">week-based calendar table</p>
    <p class="book-title--packt">additional columns, creating <a href="#calibre_link-1505" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">206</a>, <a href="#calibre_link-1506" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">207</a>, <a href="#calibre_link-1507" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">208</a>, <a href="#calibre_link-1508" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">209</a></p>
    <p class="book-title--packt">correct end date, finding <a href="#calibre_link-1509" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">204</a>, <a href="#calibre_link-1510" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">205</a>, <a href="#calibre_link-1511" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">206</a></p>
    <p class="book-title--packt">correct start date, finding <a href="#calibre_link-1512" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">202</a>, <a href="#calibre_link-270" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">203</a></p>
    <p class="book-title--packt">creating <a href="#calibre_link-1513" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">200</a></p>
    <p class="book-title--packt">dates, setting up <a href="#calibre_link-933" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">201</a>, <a href="#calibre_link-930" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">202</a></p>
    <p class="book-title--packt">week counter <a href="#calibre_link-1514" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">207</a></p>
    <p class="book-title--packt">weekday <a href="#calibre_link-1515" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">207</a></p>
    <p class="book-title--packt">what-if parameters</p>
    <p class="book-title--packt">creating <a href="#calibre_link-1516" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">341</a>, <a href="#calibre_link-1517" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">342</a>, <a href="#calibre_link-1518" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">343</a></p>
    <p class="book-title--packt">Whole Number data type <a href="#calibre_link-1519" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">24</a></p>
    <p class="book-title--packt">X</p>
    <p class="book-title--packt">XIRR function <a href="#calibre_link-1520" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">335</a>, <a href="#calibre_link-1521" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">354</a>, <a href="#calibre_link-1522" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">355</a>, <a href="#calibre_link-1523" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">356</a></p>
    <p class="book-title--packt">XNPV function <a href="#calibre_link-1524" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">335</a>, <a href="#calibre_link-1525" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">337</a>, <a href="#calibre_link-1526" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">353</a></p>
    <p class="book-title--packt">Y</p>
    <p class="book-title--packt">year-to-date results</p>
    <p class="book-title--packt">calculating <a href="#calibre_link-1527" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">211</a>, <a href="#calibre_link-1528" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">212</a>, <a href="#calibre_link-1529" class="pcalibre calibre6 pcalibre1 pcalibre3 pcalibre2">213</a></p>
  </div>
</div>
</div>
</div>


</body></html>